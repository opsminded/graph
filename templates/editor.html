<!DOCTYPE html>
<?php
$requestUri = $_SERVER["REQUEST_URI"];
$requestUri = strtok($requestUri, "?");
$basePath = rtrim(dirname($requestUri), "/\\");
?>
<html lang="pt-BR">
    <head>
        <meta http-equiv="content-type" content="text/html; charset=UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Bradesketch</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.33.1/cytoscape.min.js" integrity="sha512-kHAY8XzRfLVMcLuowdk91552RD+Nb2/1uHamfHMdLejNqlZnbEJLl1wYnsNnqIFCEZ++WaOcOlfokC6p9JWrLw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        
        <style>
            html, body {
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
                overflow: hidden;
                font-family: Verdana, Geneva, Tahoma, sans-serif;
            }

            body {
                background-color: #FAF9F5;
            }

            #graph-header {
                position: absolute;

                border: 1px solid #CCC;
                box-shadow: rgba(9, 30, 66, 0.25) 0px 4px 8px -2px, rgba(9, 30, 66, 0.08) 0px 0px 0px 1px;
                color: #787878;

                top: 50px;
                right: 2%;
                margin: 0;
                padding: 10px;

                font-size: 32px;
                font-weight: bold;

                z-index: 300;
            }

            #graph-header h1 {
                font-size: 24px;
                font-weight: bold;
                margin: 0;
                padding: 0;
            }

            #graph-header p {
                font-size: 10px;
                font-weight: normal;
                margin: 0;
                padding: 0;
            }

            #menu {
                position: absolute;

                left: 0;
                top: 0;
                width: 270px;
                height: 100%;
                padding: 10px 0;

                text-align: center;

                background-color: #FAF9F5;

                border-right: 1px solid #CCC;
                z-index: 200;
            }

            #menu h2 {
                font-size: 24px;
                line-height: 24px;
                margin: 10px 0;
                padding: 0;
            }

            #menu.hide {
                display: none;
            }

            #menu > div:first-of-type {
                text-align: right;
                padding: 0 10px;
            }

            #user-panel {
                background-color: #FFFFFF;
                border-top: 1px solid #CCC;
                border-bottom: 1px solid #CCC;
                padding-bottom: 20px;
            }

            #add-node-form {
                display: block;
            }

            #add-node-form.hide {
                display: none;
            }

            #add-edge-form {
                display: none;
            }

            #add-edge-form.show {
                display: block;
            }

            /* Info panel on the right side */

            #info-panel {
                position: absolute;

                right: 0;
                top: 0;

                width: 40%;
                height: 100%;
                
                background-color: #fff;
                border-left: 1px solid #CCC;
                padding: 10px;
                
                display: none;
                z-index: 400;
            }

            #info-panel.show {
                display: block;
            }

            #cy {
                position: absolute;

                left: 0;
                top: 32px;
                bottom: 0;
                right: 0;

                width: 100%;
                height: 100%;
                
                z-index: 100;
            }

            #modal {
                position: absolute;

                border: 2px solid #CCC;
                background-color: #fff;

                left: 25%;
                top: 8%;
                width: 50%;
                height: 70%;

                padding: 10px;

                display: none;
                z-index: 200;
            }

            #modal.show {
                display: block;
            }

            #modal-new-doc {
                display: none;
            }

            #modal-new-doc.show {
                display: block;
            }

            #modal-open-doc {
                display: none;
            }

            #modal-open-doc.show {
                display: block;
            }
        </style>

        <script>
            const basePath = "<?php echo $basePath; ?>";
        </script>
    </head>
    <body>
        <div id="graph-header">
            <h1 id="graph-title">Graph</h1>
            <p>Autor: <span id="graph-author"></span></p>
            <p>Criado em: <span id="graph-created"></span></p>
        </div>
        <div id="menu">
            <div><button id="close-menu-btn">X</button></div>
            <img src="<?php echo $basePath; ?>images/logo.png" alt="Logo" width="32" height="32">
            <h2><span style="color: rgb(182, 43, 43);">Brades</span>ketch</h2>

            <div id="user-panel">
                <p><button id="login-btn" title="Entrar">Entrar</button></p>
                <p>
                    <button id="new-doc-btn" title="Novo Documento" style="margin: 0 10px;">Novo</button>
                    <button id="open-doc-btn" title="Abrir Documento" style="margin: 0 10px;">Abrir</button>
                </p>
            </div>

            <form id="add-node-form" method="post">
                <h3>Adicionar Item</h3>
                <p>
                    <label for="add-node-form-category">Categoria:<br>
                        <select id="add-node-form-category" name="category" required>
                            <option>Selecione</option>
                        </select>
                    </label>
                </p>

                <p>
                    <label for="add-node-form-type">Tipo:<br>
                        <select id="add-node-form-type" name="type" required>
                            <option>Selecione</option>
                        </select>
                    </label>
                </p>

                <p>
                    <label for="add-node-form-node">Item:<br>
                        <select id="add-node-form-node" name="node" required>
                            <!-- Options will be populated dynamically -->
                        </select>
                    </label>
                </p>

                <p><button id="add-node-form-submit" type="submit">Adicionar Item</button></p>
            </form>

            <form id="add-edge-form" method="post">
                <h3>Adicionar Conexão</h3>
                <p><button id="add-edge-form-submit" type="submit" disabled>Adicionar Conexão</button></p>
            </form>

            <p>
                <button id="export-btn" type="button">Exportar</button>
            </p>

            <p>
                <button id="fit-btn" type="button">Ajustar</button>
            </p>
        </div>

        <div id="info-panel">
            <h2>Propriedades do Nó</h2>
            <div id="info-panel-content">
                <p><strong>ID:</strong> <span id="info-node-id"></span></p>
                <p><strong>Rótulo:</strong> <span id="info-node-label"></span></p>
                <p><strong>Categoria:</strong> <span id="info-node-category"></span></p>
                <p><strong>Tipo:</strong> <span id="info-node-type"></span></p>
                <div id="info-node-properties">
                    <!-- Additional properties will be populated dynamically -->
                </div>
            </div>
        </div>

        <div id="modal">
            <div><button id="close-modal-btn">x</button></div>
            <div id="modal-new-doc">
                <div id="modal-new-doc-content">
                    <h2>Novo Projeto</h2>
                    <form id="new-doc-form" method="post">
                        <p><label for="new-doc-form-name">Nome:<br>
                            <input type="text" id="new-doc-form-name" name="name"></label>
                        </p>
                        <p><button type="submit">Criar</button></p>
                    </form>
                </div>
            </div>

            <div id="modal-open-doc">
                <div id="modal-open-doc-content">
                    <h2>Abrir Projeto</h2>
                    <form id="open-doc-form" method="post">
                        <p><label for="open-doc-form-id">Projeto 
                            <select id="open-doc-form-id" name="id">
                            </select>
                        </label></p>
                        <p><button type="submit">Abrir</button></p>
                    </form>
                </div>
            </div>
        </div>
        
        <div id="cy"></div>
    
    <script type="module">
        const API = {
            GET_PROJECTS:   basePath + '/getProjects',
            GET_PROJECT:    basePath + '/getProject',
            UPDATE_PROJECT: basePath + '/updateProject',
            INSERT_PROJECT: basePath + '/insertProject',
            GET_STATUS:     basePath + '/getStatus',
            GET_CATEGORIES: basePath + '/getCategories',
            GET_TYPES:      basePath + '/getTypes',
            INSERT_EDGE:    basePath + '/insertEdge',
            DELETE_EDGE:    basePath + '/deleteEdge'
        };

        const EVENTS = {
            INITIAL_LOAD: "INITIAL_LOAD",
            PROJECTS_LIST_LOADED: "PROJECTS_LIST_LOADED",
            PROJECT_SELECTED: "PROJECT_SELECTED"
        };

        const COSELAYOUT = {
            'name': 'cose',
            'animate': false,
            'fit': true,
            'padding': 30,
            'componentSpacing': 40
        };

        const STYLE = [
            {
                "selector": "node",
                "style": {
                    "background-clip": "none",
                    "background-height": "32px",
                    "background-width": "32px",
                    "border-width": 2,
                    "color": "#333",
                    "font-family": "Tahoma, Geneva, Verdana, sans-serif",
                    "font-size": 16,
                    "label": "data(label)",
                    "text-valign": "bottom",
                    "text-halign": "center",
                    "text-margin-y": 8,
                },
            },
            {
                "selector": "edge",
                "style": {
                    "color": "#333",
                    "font-family": "Tahoma, Geneva, Verdana, sans-serif",
                    "font-size": 14,
                    //"label": "data(label)",
                    "line-color": "#bebebe",
                    "target-arrow-color": "#7d7d7d",
                    "target-arrow-shape": "triangle",
                    "target-arrow-fill": "filled",
                    "target-arrow-width": 6,
                    "target-endpoint": "outside-to-node-or-label",
                    "target-distance-from-node": 5,
                    "text-valign": "bottom",
                    "text-halign": "center",
                    "text-margin-y": 10,
                    "width": 3,
                    'curve-style': 'bezier',

                    "line-style": 'dashed',
                    'line-dash-pattern': [6, 3],
                    'line-dash-offset': 0,
                    'transition-property': 'line-dash-offset',
                    'transition-duration': '1000ms',
                    'transition-timing-function': 'linear'
                },
            },
            {
                "selector": "edge:selected",
                "style": {
                    "line-color": "#00ff00",
                    "width": 5,
                },
            },
            {
                "selector" : "node.node-status-unknown",
                "style" : {
                    "border-color" : "#939393",
                    "background-color" : "#cbcbcb",
                    "color" : "#000000"
                }
            },
            {
                "selector" : "node.node-status-healthy",
                "style" : {
                    "border-color" : "#4CAF50",
                    "background-color" : "#d0edd1",
                    "color" : "#000000"
                }
            },
            {
                "selector" : "node.node-status-unhealthy",
                "style" : {
                    "border-color" : "#ff8178",
                    "background-color" : "#ffe2e2",
                    "color" : "#000000"
                }
            },
            {
                "selector" : "node.node-status-maintenance",
                "style" : {
                    "border-color" : "#43aeff",
                    "background-color" : "#cde9ff",
                    "color" : "#000000"
                }
            },
            {
                "selector" : "node.node-status-impacted",
                "style" : {
                    "border-color" : "#ae6ec0",
                    "background-color" : "#ece5ee",
                    "color" : "#000000"
                }
            }
        ];

        // Utility Functions
        function createOptionElement(value, text) {
            const option = document.createElement('option');
            option.value = value;
            option.text = text;
            return option;
        }

        // Store class to manage application state
        class Store {
            constructor(initialState = {}) {
                this.state = initialState;
                this.subscribers = {}; // mapa de eventos para listas de callbacks de inscrição
                this.handlers = {};    // mapa de eventos para handlers;
            }

            subscribe(event, callback) {
                if (!this.subscribers[event]) {
                    this.subscribers[event] = [];
                }
                this.subscribers[event].push(callback);
            }

            // Notify all subscribers of state change
            notify(event) {
                if (this.subscribers[event]) {
                    this.subscribers[event].forEach(callback => callback(this.state));
                }
            }

            // Register an event handler
            register(event, handler){
                this.handlers[event] = handler;
            }

            // Dispatch an event to update state
            dispatch(event, payload) {
                if (this.handlers[event]) {
                    this.state = this.handlers[event](this.state, payload);
                    this.notify(event);
                } else {
                    console.error(`Evento não registrado: ${event}`);
                }
            }
        }

        async function fetchProjects() {
            try {
                const response = await fetch(API.GET_PROJECTS);
                if (!response.ok) {
                    throw new Error(`Erro ao carregar projetos: ${response.status}`);
                }
                const { data } = await response.json();
                return data;
            } catch (error) {
                console.error('[fetchProjects] Fetch error:', error);
                return [];
            }
        }

        async function fetchProject(projectId) {
            try {
                const response = await fetch(`${API.GET_PROJECT}?id=${encodeURIComponent(projectId)}`);
                if (!response.ok) {
                    throw new Error(`Erro ao carregar projeto: ${response.status}`);
                }
                const { data } = await response.json();
                return data;
            } catch (error) {
                console.error('[fetchProject] Fetch error:', error);
                return null;
            }
        }
        
        class Graph
        {
            constructor(store) {
                this.store = store;
                this.registerHandlers();
                this.setupSubscription();

                this.OpenProjectModal = new OpenProjectModal(this.store);
                this.store.dispatch(EVENTS.INITIAL_LOAD, { initialLoad: true });
            }

            registerHandlers() {
                this.store.register(EVENTS.INITIAL_LOAD, (state, payload) => ({
                    ...state,
                    initialLoad: payload.initialLoad
                }));

                this.store.register(EVENTS.PROJECTS_LIST_LOADED, (state, payload) => ({
                    ...state,
                    projects: payload.projects
                }));

                this.store.register(EVENTS.PROJECT_SELECTED, (state, payload) => ({
                    ...state,
                    selectedProjectId: payload.selectedProjectId
                }));
            }

            setupSubscription()
            {
                this.store.subscribe(EVENTS.INITIAL_LOAD, async (state) => {
                    if (state.initialLoad) {
                        const projects = await fetchProjects();
                        this.store.dispatch(EVENTS.PROJECTS_LIST_LOADED, { projects });
                    }
                });

                this.store.subscribe(EVENTS.PROJECT_SELECTED, async (state) => {
                    console.log('Project Selected. vai buscar:', state.selectedProjectId);
                    const project = await fetchProject(state.selectedProjectId);
                    console.log('Project data:', project);
                    this.updateCY(project);
                });
            }

            updateCY(project)
            {
                // Logic to update Cytoscape graph with the selected project data
                console.log('Updating Cytoscape graph with new project data...');

                var elements = {
                    nodes: [],
                    edges: []
                };

                for (const node of project.graph.nodes) {
                    elements['nodes'].push({data: {...node}});
                }

                for (const edge of project.graph.edges) {
                    elements['edges'].push({data: {...edge}});
                }

                console.log('Cytoscape elements:', elements);

                this.cy = cytoscape({
                    container: document.getElementById('cy'),
                    elements: elements,
                    styles: STYLE,
                    layout: COSELAYOUT
                });
            }
        }

        class OpenProjectModal
        {
            constructor(store)
            {
                this.store = store;
                this.htmlElement = document.getElementById('modal-open-doc');
                this.htmlElementModal = document.getElementById('modal');
                this.htmlOpenProjectFormElement = document.getElementById('open-doc-form');
                this.htmlOpenProjectFormIdElement = document.getElementById('open-doc-form-id');
                this.setupEventListeners();
                this.setupSubscription();
            }

            setupEventListeners()
            {
                this.htmlOpenProjectFormElement.addEventListener('submit', (event) => {
                    event.preventDefault();
                    const selectedProjectId = this.htmlOpenProjectFormIdElement.value;
                    this.store.dispatch(EVENTS.PROJECT_SELECTED, { selectedProjectId: selectedProjectId });
                });
            }

            setupSubscription()
            {
                this.store.subscribe(EVENTS.PROJECT_SELECTED, async (state) => {
                    console.log('Project selected:', state.selectedProjectId);
                    this.hide();
                });

                this.store.subscribe(EVENTS.PROJECTS_LIST_LOADED, async (state) => {
                    this.loadProjects(state.projects);
                    this.show();
                });
            }

            loadProjects(projects) {
                // Logic to load projects into the modal
                this.htmlOpenProjectFormIdElement.innerHTML = ''; // Clear existing options
                projects.forEach((project) => {
                    this.htmlOpenProjectFormIdElement.appendChild(
                        createOptionElement(project.id, project.name)
                    );
                });
            }

            show() {
                this.htmlElement.classList.add('show');
                this.htmlElementModal.classList.add('show');
            }

            hide() {
                this.htmlElement.classList.remove('show');
                this.htmlElementModal.classList.remove('show');
            }
        }

        document.addEventListener("DOMContentLoaded", async function() {
            const store = new Store();
            const graph = new Graph(store);
        });
    </script>
    </body>
</html>