<html><head><meta charset='UTF-8'><style>
body { font-family: monospace; font-size: 12px; background: #222; color: #ddd; margin: 0; }
.covered { background: #1a4d1a; }
.not-covered { background: #4d1a1a; }
.not-executable { background: #2a2a2a; color: #666; }
.line { padding: 2px 10px; white-space: pre; border-left: 3px solid transparent; }
.covered { border-left-color: #0f0; }
.not-covered { border-left-color: #f00; }
.num { color: #666; width: 50px; display: inline-block; text-align: right; margin-right: 10px; }
h2 { background: #333; padding: 10px; margin: 20px 0 0 0; position: sticky; top: 0; }
</style></head><body><h2>/home/tarcisio/projects/graph/tests.php - 75.86% (44/58)</h2><div class='line not-executable'><span class='num'>1</span>&lt;?php
</div><div class='line not-executable'><span class='num'>2</span>
</div><div class='line not-executable'><span class='num'>3</span>declare(strict_types=1);
</div><div class='line not-executable'><span class='num'>4</span>
</div><div class='line not-executable'><span class='num'>5</span>require_once __DIR__ . &#039;/graph.php&#039;;
</div><div class='line not-executable'><span class='num'>6</span>
</div><div class='line not-executable'><span class='num'>7</span>ini_set(&#039;xdebug.mode&#039;, &#039;1&#039;);
</div><div class='line not-executable'><span class='num'>8</span>xdebug_start_code_coverage(XDEBUG_CC_UNUSED | XDEBUG_CC_DEAD_CODE);
</div><div class='line not-executable'><span class='num'>9</span>
</div><div class='line not-executable'><span class='num'>10</span>function array_diff_recursive($array1, $array2) {
</div><div class='line covered'><span class='num'>11</span>    $diff = [];
</div><div class='line not-executable'><span class='num'>12</span>    
</div><div class='line covered'><span class='num'>13</span>    foreach ($array1 as $key =&gt; $value) {
</div><div class='line covered'><span class='num'>14</span>        if (!array_key_exists($key, $array2)) {
</div><div class='line not-covered'><span class='num'>15</span>            $diff[$key] = $value;
</div><div class='line covered'><span class='num'>16</span>        } elseif (is_array($value)) {
</div><div class='line covered'><span class='num'>17</span>            if (!is_array($array2[$key])) {
</div><div class='line not-covered'><span class='num'>18</span>                $diff[$key] = $value;
</div><div class='line not-executable'><span class='num'>19</span>            } else {
</div><div class='line covered'><span class='num'>20</span>                $recursiveDiff = array_diff_recursive($value, $array2[$key]);
</div><div class='line covered'><span class='num'>21</span>                if (count($recursiveDiff)) {
</div><div class='line not-covered'><span class='num'>22</span>                    $diff[$key] = $recursiveDiff;
</div><div class='line not-executable'><span class='num'>23</span>                }
</div><div class='line not-executable'><span class='num'>24</span>            }
</div><div class='line covered'><span class='num'>25</span>        } elseif ($value !== $array2[$key]) {
</div><div class='line not-covered'><span class='num'>26</span>            $diff[$key] = $value;
</div><div class='line not-executable'><span class='num'>27</span>        }
</div><div class='line not-executable'><span class='num'>28</span>    }
</div><div class='line not-executable'><span class='num'>29</span>    
</div><div class='line covered'><span class='num'>30</span>    return $diff;
</div><div class='line not-covered'><span class='num'>31</span>}
</div><div class='line not-executable'><span class='num'>32</span>
</div><div class='line not-executable'><span class='num'>33</span>function get_test_graph_controller()
</div><div class='line not-executable'><span class='num'>34</span>{
</div><div class='line covered'><span class='num'>35</span>    GraphContext::$user = new User(&#039;test_user&#039;, &#039;127.0.0.1&#039;, new Group(&#039;contributor&#039;));
</div><div class='line covered'><span class='num'>36</span>    $pdo = GraphDatabase::createConnection(&#039;sqlite::memory:&#039;);
</div><div class='line covered'><span class='num'>37</span>    $databaseLogger = new Logger(&#039;database.log&#039;);
</div><div class='line not-executable'><span class='num'>38</span>
</div><div class='line covered'><span class='num'>39</span>    $graphDb = new GraphDatabase($pdo, $databaseLogger);
</div><div class='line not-executable'><span class='num'>40</span>
</div><div class='line covered'><span class='num'>41</span>    $serviceLogger = new Logger(&#039;service.log&#039;);
</div><div class='line covered'><span class='num'>42</span>    $graphService = new GraphService($graphDb, $serviceLogger);
</div><div class='line not-executable'><span class='num'>43</span>
</div><div class='line covered'><span class='num'>44</span>    $controllerLogger = new Logger(&#039;controller.log&#039;);
</div><div class='line covered'><span class='num'>45</span>    $graphController = new GraphController($graphService, $controllerLogger);
</div><div class='line not-executable'><span class='num'>46</span>    
</div><div class='line covered'><span class='num'>47</span>    return $graphController;
</div><div class='line not-covered'><span class='num'>48</span>}
</div><div class='line not-executable'><span class='num'>49</span>
</div><div class='line not-executable'><span class='num'>50</span>function test_node_good_path()
</div><div class='line not-executable'><span class='num'>51</span>{
</div><div class='line covered'><span class='num'>52</span>    $graphController = get_test_graph_controller();
</div><div class='line covered'><span class='num'>53</span>    $insertNodeReq = new Request();
</div><div class='line covered'><span class='num'>54</span>    $insertNodeReq-&gt;data = [&#039;id&#039; =&gt; &#039;node1&#039;, &#039;label&#039; =&gt; &#039;node1&#039;, &#039;category&#039; =&gt; &#039;business&#039;, &#039;type&#039; =&gt; &#039;server&#039;, &#039;data&#039; =&gt; [&#039;info&#039; =&gt; &#039;first node&#039;]];
</div><div class='line covered'><span class='num'>55</span>    $resp = $graphController-&gt;insertNode($insertNodeReq);
</div><div class='line not-executable'><span class='num'>56</span>    
</div><div class='line covered'><span class='num'>57</span>    $expected = [
</div><div class='line not-executable'><span class='num'>58</span>        &#039;id&#039;       =&gt; &#039;node1&#039;,
</div><div class='line not-executable'><span class='num'>59</span>        &#039;label&#039;    =&gt; &#039;node1&#039;,
</div><div class='line not-executable'><span class='num'>60</span>        &#039;category&#039; =&gt; &#039;business&#039;,
</div><div class='line not-executable'><span class='num'>61</span>        &#039;type&#039; =&gt; &#039;server&#039;,
</div><div class='line not-executable'><span class='num'>62</span>        &#039;data&#039; =&gt; [
</div><div class='line not-executable'><span class='num'>63</span>                &#039;info&#039; =&gt; &#039;first node&#039;
</div><div class='line not-executable'><span class='num'>64</span>        ]
</div><div class='line not-executable'><span class='num'>65</span>    ];
</div><div class='line not-executable'><span class='num'>66</span>
</div><div class='line covered'><span class='num'>67</span>    if($resp-&gt;code != 201) {
</div><div class='line not-covered'><span class='num'>68</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>69</span>    }
</div><div class='line not-executable'><span class='num'>70</span>
</div><div class='line covered'><span class='num'>71</span>    if($resp-&gt;status != &#039;success&#039;) {
</div><div class='line not-covered'><span class='num'>72</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>73</span>    }
</div><div class='line not-executable'><span class='num'>74</span>
</div><div class='line covered'><span class='num'>75</span>    if ($resp-&gt;message != &#039;node inserted&#039;) {
</div><div class='line not-covered'><span class='num'>76</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>77</span>    }
</div><div class='line not-executable'><span class='num'>78</span>
</div><div class='line covered'><span class='num'>79</span>    $diff = array_diff_recursive($resp-&gt;data, $expected);
</div><div class='line covered'><span class='num'>80</span>    if (! empty($diff)) {
</div><div class='line not-covered'><span class='num'>81</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>82</span>    }
</div><div class='line not-executable'><span class='num'>83</span>
</div><div class='line covered'><span class='num'>84</span>    $_GET[&#039;id&#039;] = &#039;node1&#039;;
</div><div class='line covered'><span class='num'>85</span>    $req = new Request();
</div><div class='line covered'><span class='num'>86</span>    $resp = $graphController-&gt;getNode($req);
</div><div class='line not-executable'><span class='num'>87</span>
</div><div class='line covered'><span class='num'>88</span>    if ($resp-&gt;code != 200) {
</div><div class='line not-covered'><span class='num'>89</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>90</span>    }
</div><div class='line not-executable'><span class='num'>91</span>
</div><div class='line covered'><span class='num'>92</span>    if($resp-&gt;status != &#039;success&#039;) {
</div><div class='line not-covered'><span class='num'>93</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>94</span>    }
</div><div class='line not-executable'><span class='num'>95</span>
</div><div class='line covered'><span class='num'>96</span>    if ($resp-&gt;message != &#039;node found&#039;) {
</div><div class='line not-covered'><span class='num'>97</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>98</span>    }
</div><div class='line not-executable'><span class='num'>99</span>
</div><div class='line covered'><span class='num'>100</span>    $expected = [
</div><div class='line not-executable'><span class='num'>101</span>        &#039;info&#039;     =&gt; &#039;first node&#039;,
</div><div class='line not-executable'><span class='num'>102</span>        &#039;id&#039;       =&gt; &#039;node1&#039;,
</div><div class='line not-executable'><span class='num'>103</span>        &#039;label&#039;    =&gt; &#039;node1&#039;,
</div><div class='line not-executable'><span class='num'>104</span>        &#039;category&#039; =&gt; &#039;business&#039;,
</div><div class='line not-executable'><span class='num'>105</span>        &#039;type&#039;     =&gt; &#039;server&#039;,
</div><div class='line not-executable'><span class='num'>106</span>    ];
</div><div class='line not-executable'><span class='num'>107</span>
</div><div class='line covered'><span class='num'>108</span>    $diff = array_diff_recursive($resp-&gt;data[&#039;data&#039;], $expected);
</div><div class='line covered'><span class='num'>109</span>    if (! empty($diff)) {
</div><div class='line not-covered'><span class='num'>110</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>111</span>    }
</div><div class='line covered'><span class='num'>112</span>    echo &quot;fim&quot;;
</div><div class='line covered'><span class='num'>113</span>}
</div><div class='line not-executable'><span class='num'>114</span>
</div><div class='line not-executable'><span class='num'>115</span>function tests() {
</div><div class='line covered'><span class='num'>116</span>    test_node_good_path();
</div><div class='line covered'><span class='num'>117</span>    echo &quot;fim&quot;;
</div><div class='line covered'><span class='num'>118</span>}
</div><div class='line not-executable'><span class='num'>119</span>
</div><div class='line covered'><span class='num'>120</span>tests();
</div><div class='line not-executable'><span class='num'>121</span>
</div><div class='line covered'><span class='num'>122</span>$coverage = xdebug_get_code_coverage();
</div><div class='line not-executable'><span class='num'>123</span>xdebug_stop_code_coverage();
</div><div class='line not-executable'><span class='num'>124</span>
</div><div class='line not-executable'><span class='num'>125</span>// Salvar em arquivo
</div><div class='line not-executable'><span class='num'>126</span>file_put_contents(&#039;coverage.json&#039;, json_encode($coverage, JSON_PRETTY_PRINT));
</div><div class='line not-executable'><span class='num'>127</span>
</div><div class='line not-executable'><span class='num'>128</span>echo &#039;fim&#039;;</div><h2>/home/tarcisio/projects/graph/graph.php - 23.57% (148/628)</h2><div class='line not-executable'><span class='num'>1</span>&lt;?php
</div><div class='line not-executable'><span class='num'>2</span>
</div><div class='line not-executable'><span class='num'>3</span>declare(strict_types=1);
</div><div class='line not-executable'><span class='num'>4</span>
</div><div class='line not-executable'><span class='num'>5</span>final class User
</div><div class='line not-executable'><span class='num'>6</span>{
</div><div class='line not-executable'><span class='num'>7</span>    public string $id;
</div><div class='line not-executable'><span class='num'>8</span>    public ?string $ipAddress;
</div><div class='line not-executable'><span class='num'>9</span>    public Group $group;
</div><div class='line not-executable'><span class='num'>10</span>
</div><div class='line not-executable'><span class='num'>11</span>    public function __construct(string $id, ?string $ipAddress, Group $group)
</div><div class='line not-executable'><span class='num'>12</span>    {
</div><div class='line covered'><span class='num'>13</span>        $this-&gt;id = $id;
</div><div class='line covered'><span class='num'>14</span>        $this-&gt;ipAddress = $ipAddress;
</div><div class='line covered'><span class='num'>15</span>        $this-&gt;group = $group;
</div><div class='line covered'><span class='num'>16</span>    }
</div><div class='line not-executable'><span class='num'>17</span>
</div><div class='line not-executable'><span class='num'>18</span>    public function toArray(): array
</div><div class='line not-executable'><span class='num'>19</span>    {
</div><div class='line not-executable'><span class='num'>20</span>        return [
</div><div class='line not-covered'><span class='num'>21</span>            &#039;id&#039; =&gt; $this-&gt;id,
</div><div class='line not-executable'><span class='num'>22</span>            &#039;group&#039; =&gt; [
</div><div class='line not-covered'><span class='num'>23</span>                &#039;id&#039; =&gt; $this-&gt;group-&gt;id,
</div><div class='line not-executable'><span class='num'>24</span>            ],
</div><div class='line not-executable'><span class='num'>25</span>        ];
</div><div class='line not-covered'><span class='num'>26</span>    }
</div><div class='line not-executable'><span class='num'>27</span>}
</div><div class='line not-executable'><span class='num'>28</span>
</div><div class='line not-executable'><span class='num'>29</span>final class Group
</div><div class='line not-executable'><span class='num'>30</span>{
</div><div class='line not-executable'><span class='num'>31</span>    private const ALLOWED_GROUPS = [&#039;anonymous&#039;, &#039;consumer&#039;, &#039;contributor&#039;, &#039;admin&#039;];
</div><div class='line not-executable'><span class='num'>32</span>    
</div><div class='line not-executable'><span class='num'>33</span>    public string $id;
</div><div class='line not-executable'><span class='num'>34</span>    
</div><div class='line not-executable'><span class='num'>35</span>    public function __construct(string $id)
</div><div class='line not-executable'><span class='num'>36</span>    {
</div><div class='line covered'><span class='num'>37</span>        if (!in_array($id, self::ALLOWED_GROUPS, true)) {
</div><div class='line not-covered'><span class='num'>38</span>            throw new InvalidArgumentException(&quot;Invalid user group: {$id}&quot;);
</div><div class='line not-executable'><span class='num'>39</span>        }
</div><div class='line covered'><span class='num'>40</span>        $this-&gt;id  = $id;
</div><div class='line covered'><span class='num'>41</span>    }
</div><div class='line not-executable'><span class='num'>42</span>}
</div><div class='line not-executable'><span class='num'>43</span>
</div><div class='line not-executable'><span class='num'>44</span>final class Graph
</div><div class='line not-executable'><span class='num'>45</span>{
</div><div class='line not-executable'><span class='num'>46</span>    public array $nodes = [];
</div><div class='line not-executable'><span class='num'>47</span>    public array $edges = [];
</div><div class='line not-executable'><span class='num'>48</span>    public array $data  = [];
</div><div class='line not-executable'><span class='num'>49</span>    public array $layout = [];
</div><div class='line not-executable'><span class='num'>50</span>    public array $styles = [];
</div><div class='line not-executable'><span class='num'>51</span>
</div><div class='line not-executable'><span class='num'>52</span>    public function __construct(array $nodes, array $edges)
</div><div class='line not-executable'><span class='num'>53</span>    {
</div><div class='line not-covered'><span class='num'>54</span>        $this-&gt;nodes = $nodes;
</div><div class='line not-covered'><span class='num'>55</span>        $this-&gt;edges = $edges;
</div><div class='line not-covered'><span class='num'>56</span>    }
</div><div class='line not-executable'><span class='num'>57</span>
</div><div class='line not-executable'><span class='num'>58</span>    public function toArray(): array
</div><div class='line not-executable'><span class='num'>59</span>    {
</div><div class='line not-executable'><span class='num'>60</span>        return [
</div><div class='line not-covered'><span class='num'>61</span>            &#039;nodes&#039; =&gt; $this-&gt;nodes,
</div><div class='line not-covered'><span class='num'>62</span>            &#039;edges&#039; =&gt; $this-&gt;edges,
</div><div class='line not-covered'><span class='num'>63</span>            &#039;data&#039; =&gt; $this-&gt;data,
</div><div class='line not-covered'><span class='num'>64</span>            &#039;layout&#039; =&gt; $this-&gt;layout,
</div><div class='line not-covered'><span class='num'>65</span>            &#039;styles&#039; =&gt; $this-&gt;styles,
</div><div class='line not-executable'><span class='num'>66</span>        ];
</div><div class='line not-covered'><span class='num'>67</span>    }
</div><div class='line not-executable'><span class='num'>68</span>}
</div><div class='line not-executable'><span class='num'>69</span>
</div><div class='line not-executable'><span class='num'>70</span>final class Node
</div><div class='line not-executable'><span class='num'>71</span>{
</div><div class='line not-executable'><span class='num'>72</span>    private const ALLOWED_CATEGORIES  = [&#039;business&#039;, &#039;application&#039;, &#039;infrastructure&#039;];
</div><div class='line not-executable'><span class='num'>73</span>    private const ALLOWED_TYPES       = [&#039;server&#039;, &#039;database&#039;, &#039;application&#039;, &#039;network&#039;];
</div><div class='line not-executable'><span class='num'>74</span>    private const ID_VALIDATION_REGEX = &#039;/^[a-zA-Z0-9\-_]+$/&#039;;
</div><div class='line not-executable'><span class='num'>75</span>    private const LABEL_MAX_LENGTH    = 20;
</div><div class='line not-executable'><span class='num'>76</span>    
</div><div class='line not-executable'><span class='num'>77</span>    public string $id;
</div><div class='line not-executable'><span class='num'>78</span>    public string $label;
</div><div class='line not-executable'><span class='num'>79</span>    public string $category;
</div><div class='line not-executable'><span class='num'>80</span>    public string $type;
</div><div class='line not-executable'><span class='num'>81</span>
</div><div class='line not-executable'><span class='num'>82</span>    public array $data = [];
</div><div class='line not-executable'><span class='num'>83</span>
</div><div class='line not-executable'><span class='num'>84</span>    public function __construct(string $id, string $label, string $category, string $type, array $data)
</div><div class='line not-executable'><span class='num'>85</span>    {
</div><div class='line covered'><span class='num'>86</span>        $this-&gt;validate($id, $label, $category, $type);
</div><div class='line covered'><span class='num'>87</span>        $this-&gt;id       = $id;
</div><div class='line covered'><span class='num'>88</span>        $this-&gt;label    = $label;
</div><div class='line covered'><span class='num'>89</span>        $this-&gt;category = $category;
</div><div class='line covered'><span class='num'>90</span>        $this-&gt;type     = $type;
</div><div class='line covered'><span class='num'>91</span>        $this-&gt;data     = $data;
</div><div class='line covered'><span class='num'>92</span>    }
</div><div class='line not-executable'><span class='num'>93</span>
</div><div class='line not-executable'><span class='num'>94</span>    private function validate(string $id, string $label, string $category, string $type): void
</div><div class='line not-executable'><span class='num'>95</span>    {
</div><div class='line covered'><span class='num'>96</span>        if (!preg_match(self::ID_VALIDATION_REGEX, $id)) {
</div><div class='line not-covered'><span class='num'>97</span>            throw new InvalidArgumentException(&quot;Invalid node ID: {$id}&quot;);
</div><div class='line not-executable'><span class='num'>98</span>        }
</div><div class='line not-executable'><span class='num'>99</span>
</div><div class='line covered'><span class='num'>100</span>        if (strlen($label) &gt; self::LABEL_MAX_LENGTH) {
</div><div class='line not-covered'><span class='num'>101</span>            throw new InvalidArgumentException(&quot;Node label exceeds maximum length of &quot; . self::LABEL_MAX_LENGTH);
</div><div class='line not-executable'><span class='num'>102</span>        }
</div><div class='line not-executable'><span class='num'>103</span>
</div><div class='line covered'><span class='num'>104</span>        if (!in_array($category, self::ALLOWED_CATEGORIES, true)) {
</div><div class='line not-covered'><span class='num'>105</span>            throw new InvalidArgumentException(&quot;Invalid node category: {$category}&quot;);
</div><div class='line not-executable'><span class='num'>106</span>        }
</div><div class='line not-executable'><span class='num'>107</span>
</div><div class='line covered'><span class='num'>108</span>        if (!in_array($type, self::ALLOWED_TYPES, true)) {
</div><div class='line not-covered'><span class='num'>109</span>            throw new InvalidArgumentException(&quot;Invalid node type: {$type}&quot;);
</div><div class='line not-executable'><span class='num'>110</span>        }
</div><div class='line covered'><span class='num'>111</span>    }
</div><div class='line not-executable'><span class='num'>112</span>
</div><div class='line not-executable'><span class='num'>113</span>    public function toArray(): array
</div><div class='line not-executable'><span class='num'>114</span>    {
</div><div class='line not-executable'><span class='num'>115</span>        return [
</div><div class='line covered'><span class='num'>116</span>            &#039;id&#039;       =&gt; $this-&gt;id,
</div><div class='line covered'><span class='num'>117</span>            &#039;label&#039;    =&gt; $this-&gt;label,
</div><div class='line covered'><span class='num'>118</span>            &#039;category&#039; =&gt; $this-&gt;category,
</div><div class='line covered'><span class='num'>119</span>            &#039;type&#039;     =&gt; $this-&gt;type,
</div><div class='line covered'><span class='num'>120</span>            &#039;data&#039;     =&gt; $this-&gt;data
</div><div class='line not-executable'><span class='num'>121</span>        ];
</div><div class='line not-covered'><span class='num'>122</span>    }
</div><div class='line not-executable'><span class='num'>123</span>}
</div><div class='line not-executable'><span class='num'>124</span>
</div><div class='line not-executable'><span class='num'>125</span>final class NodeStatus
</div><div class='line not-executable'><span class='num'>126</span>{
</div><div class='line not-executable'><span class='num'>127</span>    private const ALLOWED_NODE_STATUSES = [&#039;unknown&#039;, &#039;healthy&#039;, &#039;unhealthy&#039;, &#039;maintenance&#039;];
</div><div class='line not-executable'><span class='num'>128</span>
</div><div class='line not-executable'><span class='num'>129</span>    public string $nodeId;
</div><div class='line not-executable'><span class='num'>130</span>    public string $status;
</div><div class='line not-executable'><span class='num'>131</span>
</div><div class='line not-executable'><span class='num'>132</span>    public function __construct(string $nodeId, string $status)
</div><div class='line not-executable'><span class='num'>133</span>    {
</div><div class='line not-covered'><span class='num'>134</span>        if (!in_array($status, self::ALLOWED_NODE_STATUSES, true)) {
</div><div class='line not-covered'><span class='num'>135</span>            throw new InvalidArgumentException(&quot;Invalid node status: {$status}&quot;);
</div><div class='line not-executable'><span class='num'>136</span>        }
</div><div class='line not-covered'><span class='num'>137</span>        $this-&gt;nodeId = $nodeId;
</div><div class='line not-covered'><span class='num'>138</span>        $this-&gt;status = $status;
</div><div class='line not-covered'><span class='num'>139</span>    }
</div><div class='line not-executable'><span class='num'>140</span>
</div><div class='line not-executable'><span class='num'>141</span>    public function toArray(): array
</div><div class='line not-executable'><span class='num'>142</span>    {
</div><div class='line not-executable'><span class='num'>143</span>        return [
</div><div class='line not-covered'><span class='num'>144</span>            &#039;node_id&#039; =&gt; $this-&gt;nodeId,
</div><div class='line not-covered'><span class='num'>145</span>            &#039;status&#039;  =&gt; $this-&gt;status,
</div><div class='line not-executable'><span class='num'>146</span>        ];
</div><div class='line not-covered'><span class='num'>147</span>    }
</div><div class='line not-executable'><span class='num'>148</span>}
</div><div class='line not-executable'><span class='num'>149</span>
</div><div class='line not-executable'><span class='num'>150</span>final class NodeStatuses
</div><div class='line not-executable'><span class='num'>151</span>{
</div><div class='line not-executable'><span class='num'>152</span>    public array $statuses = [];
</div><div class='line not-executable'><span class='num'>153</span>
</div><div class='line not-executable'><span class='num'>154</span>    public function addStatus(NodeStatus $status): void
</div><div class='line not-executable'><span class='num'>155</span>    {
</div><div class='line not-covered'><span class='num'>156</span>        $this-&gt;statuses[] = $status;
</div><div class='line not-covered'><span class='num'>157</span>    }
</div><div class='line not-executable'><span class='num'>158</span>}
</div><div class='line not-executable'><span class='num'>159</span>
</div><div class='line not-executable'><span class='num'>160</span>final class Nodes
</div><div class='line not-executable'><span class='num'>161</span>{
</div><div class='line not-executable'><span class='num'>162</span>    public array $nodes = [];
</div><div class='line not-executable'><span class='num'>163</span>
</div><div class='line not-executable'><span class='num'>164</span>    public function addNode(Node $node): void
</div><div class='line not-executable'><span class='num'>165</span>    {
</div><div class='line not-covered'><span class='num'>166</span>        $this-&gt;nodes[] = $node;
</div><div class='line not-covered'><span class='num'>167</span>    }
</div><div class='line not-executable'><span class='num'>168</span>}
</div><div class='line not-executable'><span class='num'>169</span>
</div><div class='line not-executable'><span class='num'>170</span>final class Edge
</div><div class='line not-executable'><span class='num'>171</span>{
</div><div class='line not-executable'><span class='num'>172</span>    public ?string $id;
</div><div class='line not-executable'><span class='num'>173</span>    public string $source;
</div><div class='line not-executable'><span class='num'>174</span>    public string $target;
</div><div class='line not-executable'><span class='num'>175</span>    public array $data;
</div><div class='line not-executable'><span class='num'>176</span>
</div><div class='line not-executable'><span class='num'>177</span>    public function __construct(?string $id = null, string $source, string $target, array $data = [])
</div><div class='line not-executable'><span class='num'>178</span>    {
</div><div class='line not-covered'><span class='num'>179</span>        $this-&gt;id     = $id;
</div><div class='line not-covered'><span class='num'>180</span>        $this-&gt;source = $source;
</div><div class='line not-covered'><span class='num'>181</span>        $this-&gt;target = $target;
</div><div class='line not-covered'><span class='num'>182</span>        $this-&gt;data   = $data;
</div><div class='line not-covered'><span class='num'>183</span>    }
</div><div class='line not-executable'><span class='num'>184</span>
</div><div class='line not-executable'><span class='num'>185</span>    public function toArray(): array
</div><div class='line not-executable'><span class='num'>186</span>    {
</div><div class='line not-executable'><span class='num'>187</span>        return [
</div><div class='line not-covered'><span class='num'>188</span>            &#039;id&#039;     =&gt; $this-&gt;id,
</div><div class='line not-covered'><span class='num'>189</span>            &#039;source&#039; =&gt; $this-&gt;source,
</div><div class='line not-covered'><span class='num'>190</span>            &#039;target&#039; =&gt; $this-&gt;target,
</div><div class='line not-covered'><span class='num'>191</span>            &#039;data&#039;   =&gt; $this-&gt;data
</div><div class='line not-executable'><span class='num'>192</span>        ];
</div><div class='line not-covered'><span class='num'>193</span>    }
</div><div class='line not-executable'><span class='num'>194</span>}
</div><div class='line not-executable'><span class='num'>195</span>
</div><div class='line not-executable'><span class='num'>196</span>final class Edges
</div><div class='line not-executable'><span class='num'>197</span>{
</div><div class='line not-executable'><span class='num'>198</span>    public array $edges = [];
</div><div class='line not-executable'><span class='num'>199</span>    public function addEdge(Edge $edge): void
</div><div class='line not-executable'><span class='num'>200</span>    {
</div><div class='line not-covered'><span class='num'>201</span>        $this-&gt;edges[] = $edge;
</div><div class='line not-covered'><span class='num'>202</span>    }
</div><div class='line not-executable'><span class='num'>203</span>}
</div><div class='line not-executable'><span class='num'>204</span>
</div><div class='line not-executable'><span class='num'>205</span>final class AuditLog
</div><div class='line not-executable'><span class='num'>206</span>{
</div><div class='line not-executable'><span class='num'>207</span>    public string $entityType;
</div><div class='line not-executable'><span class='num'>208</span>    public string $entityId;
</div><div class='line not-executable'><span class='num'>209</span>    public string $action;
</div><div class='line not-executable'><span class='num'>210</span>    public ?array $oldData;
</div><div class='line not-executable'><span class='num'>211</span>    public ?array $newData;
</div><div class='line not-executable'><span class='num'>212</span>    public string $userId;
</div><div class='line not-executable'><span class='num'>213</span>    public string $ipAddress;
</div><div class='line not-executable'><span class='num'>214</span>    public string $createdAt;
</div><div class='line not-executable'><span class='num'>215</span>
</div><div class='line not-executable'><span class='num'>216</span>    public function __construct(string $entityType, string $entityId, string $action, ?array $oldData = null, ?array $newData = null)
</div><div class='line not-executable'><span class='num'>217</span>    {
</div><div class='line covered'><span class='num'>218</span>        $this-&gt;entityType = $entityType;
</div><div class='line covered'><span class='num'>219</span>        $this-&gt;entityId   = $entityId;
</div><div class='line covered'><span class='num'>220</span>        $this-&gt;action     = $action;
</div><div class='line covered'><span class='num'>221</span>        $this-&gt;oldData    = $oldData;
</div><div class='line covered'><span class='num'>222</span>        $this-&gt;newData    = $newData;
</div><div class='line covered'><span class='num'>223</span>    }
</div><div class='line not-executable'><span class='num'>224</span>}
</div><div class='line not-executable'><span class='num'>225</span>
</div><div class='line not-executable'><span class='num'>226</span>final class AuditLogs
</div><div class='line not-executable'><span class='num'>227</span>{
</div><div class='line not-executable'><span class='num'>228</span>    public array $logs = [];
</div><div class='line not-executable'><span class='num'>229</span>    public function addLog(AuditLog $log): void
</div><div class='line not-executable'><span class='num'>230</span>    {
</div><div class='line not-covered'><span class='num'>231</span>        $this-&gt;logs[] = $log;
</div><div class='line not-covered'><span class='num'>232</span>    }
</div><div class='line not-executable'><span class='num'>233</span>}
</div><div class='line not-executable'><span class='num'>234</span>
</div><div class='line not-executable'><span class='num'>235</span>final class GraphContext
</div><div class='line not-executable'><span class='num'>236</span>{
</div><div class='line not-executable'><span class='num'>237</span>    public static User $user;
</div><div class='line not-executable'><span class='num'>238</span>}
</div><div class='line not-executable'><span class='num'>239</span>
</div><div class='line not-executable'><span class='num'>240</span>interface LoggerInterface
</div><div class='line not-executable'><span class='num'>241</span>{
</div><div class='line not-executable'><span class='num'>242</span>    public function info(string $message, array $data = []): void;
</div><div class='line not-executable'><span class='num'>243</span>    public function debug(string $message, array $data = []): void;
</div><div class='line not-executable'><span class='num'>244</span>    public function error(string $message, array $data = []): void;
</div><div class='line not-executable'><span class='num'>245</span>}
</div><div class='line not-executable'><span class='num'>246</span>
</div><div class='line not-executable'><span class='num'>247</span>final class Logger implements LoggerInterface
</div><div class='line not-executable'><span class='num'>248</span>{
</div><div class='line not-executable'><span class='num'>249</span>    private string $fileName;
</div><div class='line not-executable'><span class='num'>250</span>    private $fd;
</div><div class='line not-executable'><span class='num'>251</span>
</div><div class='line not-executable'><span class='num'>252</span>    public function __construct($file_name)
</div><div class='line not-executable'><span class='num'>253</span>    {
</div><div class='line covered'><span class='num'>254</span>        $this-&gt;fileName = $file_name;
</div><div class='line covered'><span class='num'>255</span>        $this-&gt;fd = fopen($this-&gt;fileName, &#039;a&#039;);
</div><div class='line covered'><span class='num'>256</span>    }
</div><div class='line not-executable'><span class='num'>257</span>
</div><div class='line not-executable'><span class='num'>258</span>    public function info(string $message, array $data = []): void
</div><div class='line not-executable'><span class='num'>259</span>    {
</div><div class='line covered'><span class='num'>260</span>        $this-&gt;log(&#039;INFO&#039;, $message, $data);
</div><div class='line covered'><span class='num'>261</span>    }
</div><div class='line not-executable'><span class='num'>262</span>
</div><div class='line not-executable'><span class='num'>263</span>    public function debug(string $message, array $data = []): void
</div><div class='line not-executable'><span class='num'>264</span>    {
</div><div class='line covered'><span class='num'>265</span>        $this-&gt;log(&#039;DEBUG&#039;, $message, $data);
</div><div class='line covered'><span class='num'>266</span>    }
</div><div class='line not-executable'><span class='num'>267</span>
</div><div class='line not-executable'><span class='num'>268</span>    public function error(string $message, array $data = []): void
</div><div class='line not-executable'><span class='num'>269</span>    {
</div><div class='line not-covered'><span class='num'>270</span>        $this-&gt;log(&#039;ERROR&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>271</span>    }
</div><div class='line not-executable'><span class='num'>272</span>
</div><div class='line not-executable'><span class='num'>273</span>    private function log(string $type, $message, $data = [])
</div><div class='line not-executable'><span class='num'>274</span>    {
</div><div class='line covered'><span class='num'>275</span>        $trace = debug_backtrace(DEBUG_BACKTRACE_PROVIDE_OBJECT, 3);
</div><div class='line covered'><span class='num'>276</span>        $method = &quot;{$trace[2][&#039;class&#039;]}::{$trace[2][&#039;function&#039;]}&quot;;
</div><div class='line covered'><span class='num'>277</span>        $data = json_encode($data);
</div><div class='line covered'><span class='num'>278</span>        $message = &quot;[{$type}] {$method}: $message ($data)\n&quot;;
</div><div class='line covered'><span class='num'>279</span>        fwrite($this-&gt;fd, $message);
</div><div class='line covered'><span class='num'>280</span>    }
</div><div class='line not-executable'><span class='num'>281</span>}
</div><div class='line not-executable'><span class='num'>282</span>
</div><div class='line not-executable'><span class='num'>283</span>interface GraphDatabaseInterface
</div><div class='line not-executable'><span class='num'>284</span>{
</div><div class='line not-executable'><span class='num'>285</span>    public function getUser(string $id): ?array;
</div><div class='line not-executable'><span class='num'>286</span>    public function insertUser(string $id, string $group): void;
</div><div class='line not-executable'><span class='num'>287</span>    public function updateUser(string $id, string $group): void;
</div><div class='line not-executable'><span class='num'>288</span>
</div><div class='line not-executable'><span class='num'>289</span>    public function getNode(string $id): ?array;
</div><div class='line not-executable'><span class='num'>290</span>    public function getNodes(): array;
</div><div class='line not-executable'><span class='num'>291</span>    public function insertNode(string $id, string $label, string $category, string $type, array $data = []): void;
</div><div class='line not-executable'><span class='num'>292</span>    public function updateNode(string $id, string $label, string $category, string $type, array $data = []): void;
</div><div class='line not-executable'><span class='num'>293</span>    public function deleteNode(string $id): void;
</div><div class='line not-executable'><span class='num'>294</span>
</div><div class='line not-executable'><span class='num'>295</span>    public function getEdge(string $source, string $target): ?array;
</div><div class='line not-executable'><span class='num'>296</span>    public function getEdgeById(string $id): ?array;
</div><div class='line not-executable'><span class='num'>297</span>    public function getEdges(): array;
</div><div class='line not-executable'><span class='num'>298</span>    public function insertEdge(string $id, string $source, string $target, array $data = []): void;
</div><div class='line not-executable'><span class='num'>299</span>    public function updateEdge(string $id, string $source, string $target, array $data = []): void;
</div><div class='line not-executable'><span class='num'>300</span>    public function deleteEdge(string $id): void;
</div><div class='line not-executable'><span class='num'>301</span>
</div><div class='line not-executable'><span class='num'>302</span>    public function getStatuses(): array;
</div><div class='line not-executable'><span class='num'>303</span>    public function getNodeStatus(string $id): ?string;
</div><div class='line not-executable'><span class='num'>304</span>    public function setNodeStatus(string $id, string $status): void;
</div><div class='line not-executable'><span class='num'>305</span>
</div><div class='line not-executable'><span class='num'>306</span>    public function getLogs($limit): array;
</div><div class='line not-executable'><span class='num'>307</span>    public function insertAuditLog(
</div><div class='line not-executable'><span class='num'>308</span>        string $entity_type, 
</div><div class='line not-executable'><span class='num'>309</span>        string $entity_id, 
</div><div class='line not-executable'><span class='num'>310</span>        string $action, 
</div><div class='line not-executable'><span class='num'>311</span>        ?array $old_data = null, 
</div><div class='line not-executable'><span class='num'>312</span>        ?array $new_data = null,
</div><div class='line not-executable'><span class='num'>313</span>        string $user_id,
</div><div class='line not-executable'><span class='num'>314</span>        string $ip_address): bool;
</div><div class='line not-executable'><span class='num'>315</span>}
</div><div class='line not-executable'><span class='num'>316</span>
</div><div class='line not-executable'><span class='num'>317</span>final class DatabaseException extends RuntimeException
</div><div class='line not-executable'><span class='num'>318</span>{
</div><div class='line not-executable'><span class='num'>319</span>    private ?string $query;
</div><div class='line not-executable'><span class='num'>320</span>    private ?array $params;
</div><div class='line not-executable'><span class='num'>321</span>
</div><div class='line not-executable'><span class='num'>322</span>    
</div><div class='line not-executable'><span class='num'>323</span>    public function __construct(string $message = &quot;&quot;,  int $code = 0, ?Throwable $previous = null, ?string $query = null, ?array $params) {
</div><div class='line not-covered'><span class='num'>324</span>        parent::__construct($message, $code, $previous);
</div><div class='line not-covered'><span class='num'>325</span>        $this-&gt;query = $query;
</div><div class='line not-covered'><span class='num'>326</span>        $this-&gt;params = $params;
</div><div class='line not-covered'><span class='num'>327</span>    }
</div><div class='line not-executable'><span class='num'>328</span>}
</div><div class='line not-executable'><span class='num'>329</span>
</div><div class='line not-executable'><span class='num'>330</span>final class GraphDatabase implements GraphDatabaseInterface
</div><div class='line not-executable'><span class='num'>331</span>{
</div><div class='line not-executable'><span class='num'>332</span>    private PDO $pdo;
</div><div class='line not-executable'><span class='num'>333</span>    private Logger $logger;
</div><div class='line not-executable'><span class='num'>334</span>
</div><div class='line not-executable'><span class='num'>335</span>    public function __construct(PDO $pdo, Logger $logger)
</div><div class='line not-executable'><span class='num'>336</span>    {
</div><div class='line covered'><span class='num'>337</span>        $this-&gt;pdo = $pdo;
</div><div class='line covered'><span class='num'>338</span>        $this-&gt;logger = $logger;
</div><div class='line covered'><span class='num'>339</span>        $this-&gt;initSchema();
</div><div class='line covered'><span class='num'>340</span>    }
</div><div class='line not-executable'><span class='num'>341</span>
</div><div class='line not-executable'><span class='num'>342</span>    public function getUser(string $id): ?array
</div><div class='line not-executable'><span class='num'>343</span>    {
</div><div class='line not-covered'><span class='num'>344</span>        $this-&gt;logger-&gt;debug(&quot;getting user id: &#039;{$id}&#039;&quot;);
</div><div class='line not-executable'><span class='num'>345</span>        try {
</div><div class='line not-covered'><span class='num'>346</span>            $sql = &quot;SELECT * FROM users WHERE id = :id&quot;;
</div><div class='line not-covered'><span class='num'>347</span>            $params = [&#039;:id&#039; =&gt; $id];
</div><div class='line not-covered'><span class='num'>348</span>            $stmt = $this-&gt;pdo-&gt;prepare($sql);
</div><div class='line not-covered'><span class='num'>349</span>            $stmt-&gt;execute($params);
</div><div class='line not-covered'><span class='num'>350</span>            $row = $stmt-&gt;fetch();
</div><div class='line not-executable'><span class='num'>351</span>
</div><div class='line not-covered'><span class='num'>352</span>            if ($row) {
</div><div class='line not-covered'><span class='num'>353</span>                return $row;
</div><div class='line not-executable'><span class='num'>354</span>            }
</div><div class='line not-covered'><span class='num'>355</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>356</span>            $e = new DatabaseException(
</div><div class='line not-covered'><span class='num'>357</span>                &quot;GraphDatabase Exception while trying to get user data. ID: {$id}&quot;,
</div><div class='line not-covered'><span class='num'>358</span>                0,
</div><div class='line not-executable'><span class='num'>359</span>                $e,
</div><div class='line not-executable'><span class='num'>360</span>                $sql,
</div><div class='line not-executable'><span class='num'>361</span>                $params
</div><div class='line not-executable'><span class='num'>362</span>            );
</div><div class='line not-executable'><span class='num'>363</span>        }
</div><div class='line not-covered'><span class='num'>364</span>        return null;
</div><div class='line not-covered'><span class='num'>365</span>    }
</div><div class='line not-executable'><span class='num'>366</span>
</div><div class='line not-executable'><span class='num'>367</span>    public function insertUser(string $id, string $group): void
</div><div class='line not-executable'><span class='num'>368</span>    {
</div><div class='line not-executable'><span class='num'>369</span>        try {
</div><div class='line not-covered'><span class='num'>370</span>            $sql = &quot;
</div><div class='line not-executable'><span class='num'>371</span>                INSERT OR IGNORE INTO users 
</div><div class='line not-executable'><span class='num'>372</span>                (id, user_group)
</div><div class='line not-executable'><span class='num'>373</span>                VALUES (:id, :group)&quot;;
</div><div class='line not-executable'><span class='num'>374</span>            
</div><div class='line not-covered'><span class='num'>375</span>            $params = [
</div><div class='line not-covered'><span class='num'>376</span>                &#039;:id&#039;       =&gt; $id,
</div><div class='line not-covered'><span class='num'>377</span>                &#039;:group&#039;    =&gt; $group
</div><div class='line not-executable'><span class='num'>378</span>            ];
</div><div class='line not-executable'><span class='num'>379</span>
</div><div class='line not-covered'><span class='num'>380</span>            $stmt = $this-&gt;pdo-&gt;prepare($sql);
</div><div class='line not-covered'><span class='num'>381</span>            $stmt-&gt;execute($params);
</div><div class='line not-covered'><span class='num'>382</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>383</span>            $e = new DatabaseException(
</div><div class='line not-covered'><span class='num'>384</span>                &quot;GraphDatabase Exception while trying to insert new user. ID: {$id}&quot;,
</div><div class='line not-covered'><span class='num'>385</span>                0,
</div><div class='line not-executable'><span class='num'>386</span>                $e,
</div><div class='line not-executable'><span class='num'>387</span>                $sql,
</div><div class='line not-executable'><span class='num'>388</span>                $params
</div><div class='line not-executable'><span class='num'>389</span>            );
</div><div class='line not-executable'><span class='num'>390</span>        }
</div><div class='line not-covered'><span class='num'>391</span>    }
</div><div class='line not-executable'><span class='num'>392</span>
</div><div class='line not-executable'><span class='num'>393</span>    public function updateUser(string $id, string $group): void
</div><div class='line not-executable'><span class='num'>394</span>    {
</div><div class='line not-executable'><span class='num'>395</span>        try {
</div><div class='line not-covered'><span class='num'>396</span>            $sql = &quot;
</div><div class='line not-executable'><span class='num'>397</span>                UPDATE users
</div><div class='line not-executable'><span class='num'>398</span>                SET    user_group = :group
</div><div class='line not-executable'><span class='num'>399</span>                WHERE  id = :id
</div><div class='line not-executable'><span class='num'>400</span>            &quot;;
</div><div class='line not-executable'><span class='num'>401</span>
</div><div class='line not-covered'><span class='num'>402</span>            $params = [
</div><div class='line not-covered'><span class='num'>403</span>                &#039;:id&#039;       =&gt; $id,
</div><div class='line not-covered'><span class='num'>404</span>                &#039;:group&#039;    =&gt; $group
</div><div class='line not-executable'><span class='num'>405</span>            ];
</div><div class='line not-executable'><span class='num'>406</span>
</div><div class='line not-covered'><span class='num'>407</span>            $stmt = $this-&gt;pdo-&gt;prepare($sql);
</div><div class='line not-executable'><span class='num'>408</span>            
</div><div class='line not-covered'><span class='num'>409</span>            $stmt-&gt;execute($params);
</div><div class='line not-executable'><span class='num'>410</span>
</div><div class='line not-covered'><span class='num'>411</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>412</span>            $e = new DatabaseException(
</div><div class='line not-covered'><span class='num'>413</span>                &quot;GraphDatabase Exception while trying to update user. ID: {$id}&quot;,
</div><div class='line not-covered'><span class='num'>414</span>                0,
</div><div class='line not-executable'><span class='num'>415</span>                $e,
</div><div class='line not-executable'><span class='num'>416</span>                $sql,
</div><div class='line not-executable'><span class='num'>417</span>                $params
</div><div class='line not-executable'><span class='num'>418</span>            );
</div><div class='line not-executable'><span class='num'>419</span>        }
</div><div class='line not-covered'><span class='num'>420</span>    }
</div><div class='line not-executable'><span class='num'>421</span>
</div><div class='line not-executable'><span class='num'>422</span>    public function getNode(string $id): ?array
</div><div class='line not-executable'><span class='num'>423</span>    {
</div><div class='line not-executable'><span class='num'>424</span>        try {
</div><div class='line covered'><span class='num'>425</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;SELECT * FROM nodes WHERE id = :id&quot;);
</div><div class='line covered'><span class='num'>426</span>            $stmt-&gt;execute([&#039;:id&#039; =&gt; $id]);
</div><div class='line covered'><span class='num'>427</span>            $row = $stmt-&gt;fetch();
</div><div class='line not-executable'><span class='num'>428</span>
</div><div class='line covered'><span class='num'>429</span>            if ($row) {
</div><div class='line covered'><span class='num'>430</span>                return $row;
</div><div class='line not-executable'><span class='num'>431</span>            }
</div><div class='line not-covered'><span class='num'>432</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>433</span>            error_log(&quot;GraphDatabase fetch node failed: &quot; . $e-&gt;getMessage());
</div><div class='line not-executable'><span class='num'>434</span>        }
</div><div class='line not-covered'><span class='num'>435</span>        return null;
</div><div class='line not-covered'><span class='num'>436</span>    }
</div><div class='line not-executable'><span class='num'>437</span>
</div><div class='line not-executable'><span class='num'>438</span>    public function getNodes(): array
</div><div class='line not-executable'><span class='num'>439</span>    {
</div><div class='line not-executable'><span class='num'>440</span>        try {
</div><div class='line not-covered'><span class='num'>441</span>            $stmt = $this-&gt;pdo-&gt;query(&quot;SELECT * FROM nodes&quot;);
</div><div class='line not-covered'><span class='num'>442</span>            $rows = $stmt-&gt;fetchAll();
</div><div class='line not-covered'><span class='num'>443</span>            return $rows;
</div><div class='line not-covered'><span class='num'>444</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>445</span>            error_log(&quot;GraphDatabase fetch all nodes failed: &quot; . $e-&gt;getMessage());
</div><div class='line not-covered'><span class='num'>446</span>            return [];
</div><div class='line not-executable'><span class='num'>447</span>        }
</div><div class='line not-covered'><span class='num'>448</span>    }
</div><div class='line not-executable'><span class='num'>449</span>
</div><div class='line not-executable'><span class='num'>450</span>    public function insertNode(string $id, string $label, string $category, string $type, array $data = []): void
</div><div class='line not-executable'><span class='num'>451</span>    {
</div><div class='line not-executable'><span class='num'>452</span>        try {
</div><div class='line covered'><span class='num'>453</span>            $sql = &quot;
</div><div class='line not-executable'><span class='num'>454</span>                INSERT OR IGNORE INTO nodes 
</div><div class='line not-executable'><span class='num'>455</span>                (id, label, category, type, data) 
</div><div class='line not-executable'><span class='num'>456</span>                VALUES (:id, :label, :category, :type, :data)&quot;;
</div><div class='line covered'><span class='num'>457</span>            $stmt             = $this-&gt;pdo-&gt;prepare($sql);
</div><div class='line covered'><span class='num'>458</span>            $data[&#039;id&#039;]       = $id;
</div><div class='line covered'><span class='num'>459</span>            $data[&#039;label&#039;]    = $label;
</div><div class='line covered'><span class='num'>460</span>            $data[&#039;category&#039;] = $category;
</div><div class='line covered'><span class='num'>461</span>            $data[&#039;type&#039;]     = $type;
</div><div class='line covered'><span class='num'>462</span>            $stmt-&gt;execute([
</div><div class='line covered'><span class='num'>463</span>                &#039;:id&#039;       =&gt; $id,
</div><div class='line covered'><span class='num'>464</span>                &#039;:label&#039;    =&gt; $label,
</div><div class='line covered'><span class='num'>465</span>                &#039;:category&#039; =&gt; $category,
</div><div class='line covered'><span class='num'>466</span>                &#039;:type&#039;     =&gt; $type,
</div><div class='line covered'><span class='num'>467</span>                &#039;:data&#039;     =&gt; json_encode($data, JSON_UNESCAPED_UNICODE)
</div><div class='line not-executable'><span class='num'>468</span>            ]);
</div><div class='line not-covered'><span class='num'>469</span>        } catch (PDOException $e) {
</div><div class='line not-executable'><span class='num'>470</span>            // TODO
</div><div class='line not-executable'><span class='num'>471</span>        }
</div><div class='line covered'><span class='num'>472</span>    }
</div><div class='line not-executable'><span class='num'>473</span>
</div><div class='line not-executable'><span class='num'>474</span>    public function updateNode(string $id, string $label, string $category, string $type, array $data = []): void
</div><div class='line not-executable'><span class='num'>475</span>    {
</div><div class='line not-executable'><span class='num'>476</span>        try {
</div><div class='line not-covered'><span class='num'>477</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-executable'><span class='num'>478</span>                UPDATE nodes
</div><div class='line not-executable'><span class='num'>479</span>                SET    label = :label, 
</div><div class='line not-executable'><span class='num'>480</span>                       category = :category, 
</div><div class='line not-executable'><span class='num'>481</span>                       type = :type, 
</div><div class='line not-executable'><span class='num'>482</span>                       data = :data
</div><div class='line not-executable'><span class='num'>483</span>                WHERE  id = :id&quot;);
</div><div class='line not-covered'><span class='num'>484</span>            $data[&#039;id&#039;]       = $id;
</div><div class='line not-covered'><span class='num'>485</span>            $data[&#039;label&#039;]    = $label;
</div><div class='line not-covered'><span class='num'>486</span>            $data[&#039;category&#039;] = $category;
</div><div class='line not-covered'><span class='num'>487</span>            $data[&#039;type&#039;]     = $type;
</div><div class='line not-executable'><span class='num'>488</span>
</div><div class='line not-covered'><span class='num'>489</span>            $stmt-&gt;execute([
</div><div class='line not-covered'><span class='num'>490</span>                &#039;:id&#039;       =&gt; $id,
</div><div class='line not-covered'><span class='num'>491</span>                &#039;:label&#039;    =&gt; $label,
</div><div class='line not-covered'><span class='num'>492</span>                &#039;:category&#039; =&gt; $category,
</div><div class='line not-covered'><span class='num'>493</span>                &#039;:type&#039;     =&gt; $type,
</div><div class='line not-covered'><span class='num'>494</span>                &#039;:data&#039;     =&gt; json_encode($data, JSON_UNESCAPED_UNICODE)
</div><div class='line not-executable'><span class='num'>495</span>            ]);
</div><div class='line not-covered'><span class='num'>496</span>        } catch (PDOException $e) {
</div><div class='line not-executable'><span class='num'>497</span>            // TODO
</div><div class='line not-executable'><span class='num'>498</span>        }
</div><div class='line not-covered'><span class='num'>499</span>    }
</div><div class='line not-executable'><span class='num'>500</span>
</div><div class='line not-executable'><span class='num'>501</span>    public function deleteNode(string $id): void
</div><div class='line not-executable'><span class='num'>502</span>    {
</div><div class='line not-executable'><span class='num'>503</span>        try {
</div><div class='line not-covered'><span class='num'>504</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;DELETE FROM nodes WHERE id = :id&quot;);
</div><div class='line not-covered'><span class='num'>505</span>            $stmt-&gt;execute([&#039;:id&#039; =&gt; $id]);
</div><div class='line not-covered'><span class='num'>506</span>        } catch (PDOException $e) {
</div><div class='line not-executable'><span class='num'>507</span>            // TODO
</div><div class='line not-executable'><span class='num'>508</span>        }
</div><div class='line not-covered'><span class='num'>509</span>    }
</div><div class='line not-executable'><span class='num'>510</span>
</div><div class='line not-executable'><span class='num'>511</span>    public function getEdge(string $source, string $target): ?array
</div><div class='line not-executable'><span class='num'>512</span>    {
</div><div class='line not-executable'><span class='num'>513</span>        try {
</div><div class='line not-covered'><span class='num'>514</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-executable'><span class='num'>515</span>                SELECT * FROM edges
</div><div class='line not-executable'><span class='num'>516</span>                WHERE source = :source AND target = :target
</div><div class='line not-executable'><span class='num'>517</span>            &quot;);
</div><div class='line not-covered'><span class='num'>518</span>            $stmt-&gt;execute([
</div><div class='line not-covered'><span class='num'>519</span>                &#039;:source&#039; =&gt; $source,
</div><div class='line not-covered'><span class='num'>520</span>                &#039;:target&#039; =&gt; $target
</div><div class='line not-executable'><span class='num'>521</span>            ]);
</div><div class='line not-covered'><span class='num'>522</span>            $row = $stmt-&gt;fetch();
</div><div class='line not-covered'><span class='num'>523</span>            if ($row) {
</div><div class='line not-covered'><span class='num'>524</span>                return $row;
</div><div class='line not-executable'><span class='num'>525</span>            }
</div><div class='line not-covered'><span class='num'>526</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>527</span>            error_log(&quot;GraphDatabase edge exists check failed: &quot; . $e-&gt;getMessage());
</div><div class='line not-executable'><span class='num'>528</span>        }
</div><div class='line not-covered'><span class='num'>529</span>        return null;
</div><div class='line not-covered'><span class='num'>530</span>    }
</div><div class='line not-executable'><span class='num'>531</span>
</div><div class='line not-executable'><span class='num'>532</span>    public function getEdgeById(string $id): ?array
</div><div class='line not-executable'><span class='num'>533</span>    {
</div><div class='line not-executable'><span class='num'>534</span>        try {
</div><div class='line not-covered'><span class='num'>535</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-executable'><span class='num'>536</span>                SELECT * FROM edges
</div><div class='line not-executable'><span class='num'>537</span>                WHERE id = :id
</div><div class='line not-executable'><span class='num'>538</span>            &quot;);
</div><div class='line not-covered'><span class='num'>539</span>            $stmt-&gt;execute([
</div><div class='line not-covered'><span class='num'>540</span>                &#039;:id&#039; =&gt; $id,
</div><div class='line not-executable'><span class='num'>541</span>            ]);
</div><div class='line not-covered'><span class='num'>542</span>            $row = $stmt-&gt;fetch();
</div><div class='line not-covered'><span class='num'>543</span>            if ($row) {
</div><div class='line not-covered'><span class='num'>544</span>                return $row;
</div><div class='line not-executable'><span class='num'>545</span>            }
</div><div class='line not-covered'><span class='num'>546</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>547</span>            error_log(&quot;GraphDatabase edge exists check failed: &quot; . $e-&gt;getMessage());
</div><div class='line not-executable'><span class='num'>548</span>        }
</div><div class='line not-covered'><span class='num'>549</span>        return null;
</div><div class='line not-covered'><span class='num'>550</span>    }
</div><div class='line not-executable'><span class='num'>551</span>
</div><div class='line not-executable'><span class='num'>552</span>    public function getEdges(): array
</div><div class='line not-executable'><span class='num'>553</span>    {
</div><div class='line not-executable'><span class='num'>554</span>        try {
</div><div class='line not-covered'><span class='num'>555</span>            $stmt  = $this-&gt;pdo-&gt;query(&quot;SELECT * FROM edges&quot;);
</div><div class='line not-covered'><span class='num'>556</span>            $rows  = $stmt-&gt;fetchAll();
</div><div class='line not-covered'><span class='num'>557</span>            return $rows;
</div><div class='line not-covered'><span class='num'>558</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>559</span>            error_log(&quot;GraphDatabase fetch all edges failed: &quot; . $e-&gt;getMessage());
</div><div class='line not-covered'><span class='num'>560</span>            return [];
</div><div class='line not-executable'><span class='num'>561</span>        }
</div><div class='line not-covered'><span class='num'>562</span>    }
</div><div class='line not-executable'><span class='num'>563</span>
</div><div class='line not-executable'><span class='num'>564</span>    public function insertEdge(string $id, string $source, string $target, array $data = []): void
</div><div class='line not-executable'><span class='num'>565</span>    {
</div><div class='line not-executable'><span class='num'>566</span>        // verify if the inverse edge exists
</div><div class='line not-covered'><span class='num'>567</span>        $r = $this-&gt;getEdge($target, $source);
</div><div class='line not-executable'><span class='num'>568</span>        
</div><div class='line not-executable'><span class='num'>569</span>        try {
</div><div class='line not-covered'><span class='num'>570</span>            $sql = &quot;
</div><div class='line not-executable'><span class='num'>571</span>                INSERT OR IGNORE INTO edges
</div><div class='line not-executable'><span class='num'>572</span>                (id, source, target, data)
</div><div class='line not-executable'><span class='num'>573</span>                VALUES (:id, :source, :target, :data)&quot;;
</div><div class='line not-covered'><span class='num'>574</span>            $stmt           = $this-&gt;pdo-&gt;prepare($sql);
</div><div class='line not-covered'><span class='num'>575</span>            $data[&#039;id&#039;]     = $id;
</div><div class='line not-covered'><span class='num'>576</span>            $data[&#039;source&#039;] = $source;
</div><div class='line not-covered'><span class='num'>577</span>            $data[&#039;target&#039;] = $target;
</div><div class='line not-covered'><span class='num'>578</span>            $stmt-&gt;execute([
</div><div class='line not-covered'><span class='num'>579</span>                &#039;:id&#039;     =&gt; $id,
</div><div class='line not-covered'><span class='num'>580</span>                &#039;:source&#039; =&gt; $source,
</div><div class='line not-covered'><span class='num'>581</span>                &#039;:target&#039; =&gt; $target,
</div><div class='line not-covered'><span class='num'>582</span>                &#039;:data&#039;   =&gt; json_encode($data, JSON_UNESCAPED_UNICODE)
</div><div class='line not-executable'><span class='num'>583</span>            ]);
</div><div class='line not-covered'><span class='num'>584</span>        } catch (PDOException $e) {
</div><div class='line not-executable'><span class='num'>585</span>            // TODO
</div><div class='line not-executable'><span class='num'>586</span>        }
</div><div class='line not-covered'><span class='num'>587</span>    }
</div><div class='line not-executable'><span class='num'>588</span>
</div><div class='line not-executable'><span class='num'>589</span>    public function updateEdge(string $id, string $source, string $target, array $data = []): void
</div><div class='line not-executable'><span class='num'>590</span>    {
</div><div class='line not-executable'><span class='num'>591</span>        try {
</div><div class='line not-covered'><span class='num'>592</span>            $data[&#039;id&#039;]     = $id;
</div><div class='line not-covered'><span class='num'>593</span>            $data[&#039;source&#039;] = $source;
</div><div class='line not-covered'><span class='num'>594</span>            $data[&#039;target&#039;] = $target;
</div><div class='line not-executable'><span class='num'>595</span>
</div><div class='line not-covered'><span class='num'>596</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-executable'><span class='num'>597</span>                UPDATE edges
</div><div class='line not-executable'><span class='num'>598</span>                SET data = :data
</div><div class='line not-executable'><span class='num'>599</span>                WHERE id = :id&quot;);
</div><div class='line not-covered'><span class='num'>600</span>            $stmt-&gt;execute([
</div><div class='line not-covered'><span class='num'>601</span>                &#039;:id&#039;   =&gt; $id,
</div><div class='line not-covered'><span class='num'>602</span>                &#039;:data&#039; =&gt; json_encode($data, JSON_UNESCAPED_UNICODE)
</div><div class='line not-executable'><span class='num'>603</span>            ]);
</div><div class='line not-covered'><span class='num'>604</span>        } catch (PDOException $e) {
</div><div class='line not-executable'><span class='num'>605</span>            // TODO
</div><div class='line not-executable'><span class='num'>606</span>        }
</div><div class='line not-covered'><span class='num'>607</span>    }
</div><div class='line not-executable'><span class='num'>608</span>
</div><div class='line not-executable'><span class='num'>609</span>    public function deleteEdge(string $id): void
</div><div class='line not-executable'><span class='num'>610</span>    {
</div><div class='line not-executable'><span class='num'>611</span>        try {
</div><div class='line not-covered'><span class='num'>612</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;DELETE FROM edges WHERE id = :id&quot;);
</div><div class='line not-covered'><span class='num'>613</span>            $stmt-&gt;execute([&#039;:id&#039; =&gt; $id]);
</div><div class='line not-covered'><span class='num'>614</span>        } catch (PDOException $e) {
</div><div class='line not-executable'><span class='num'>615</span>            // TODO
</div><div class='line not-executable'><span class='num'>616</span>        }
</div><div class='line not-covered'><span class='num'>617</span>    }
</div><div class='line not-executable'><span class='num'>618</span>
</div><div class='line not-executable'><span class='num'>619</span>    public function getStatuses(): array
</div><div class='line not-executable'><span class='num'>620</span>    {
</div><div class='line not-covered'><span class='num'>621</span>        $stmt   = $this-&gt;pdo-&gt;query(&quot;
</div><div class='line not-executable'><span class='num'>622</span>            SELECT n.id,
</div><div class='line not-executable'><span class='num'>623</span>                   s.status
</div><div class='line not-executable'><span class='num'>624</span>            FROM   nodes n
</div><div class='line not-executable'><span class='num'>625</span>            LEFT JOIN status s ON n.id = s.node_id&quot;);
</div><div class='line not-covered'><span class='num'>626</span>        $status = $stmt-&gt;fetchAll();
</div><div class='line not-covered'><span class='num'>627</span>        return $status;
</div><div class='line not-covered'><span class='num'>628</span>    }
</div><div class='line not-executable'><span class='num'>629</span>
</div><div class='line not-executable'><span class='num'>630</span>    public function getNodeStatus(string $id): ?string
</div><div class='line not-executable'><span class='num'>631</span>    {
</div><div class='line not-covered'><span class='num'>632</span>        $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-executable'><span class='num'>633</span>            SELECT s.status
</div><div class='line not-executable'><span class='num'>634</span>            FROM nodes n
</div><div class='line not-executable'><span class='num'>635</span>            LEFT JOIN status s
</div><div class='line not-executable'><span class='num'>636</span>            ON n.id = s.node_id
</div><div class='line not-executable'><span class='num'>637</span>            WHERE n.id = ?&quot;);
</div><div class='line not-covered'><span class='num'>638</span>        $stmt-&gt;execute([$id]);
</div><div class='line not-covered'><span class='num'>639</span>        $status = $stmt-&gt;fetch();
</div><div class='line not-covered'><span class='num'>640</span>        return $status ? $status[&#039;status&#039;] : null;
</div><div class='line not-covered'><span class='num'>641</span>    }
</div><div class='line not-executable'><span class='num'>642</span>
</div><div class='line not-executable'><span class='num'>643</span>    public function setNodeStatus(string $id, string $status): void
</div><div class='line not-executable'><span class='num'>644</span>    {
</div><div class='line not-covered'><span class='num'>645</span>        $stmt = $this-&gt;pdo-&gt;prepare(&quot;REPLACE INTO status (node_id, status) VALUES (?, ?)&quot;);
</div><div class='line not-covered'><span class='num'>646</span>        $stmt-&gt;execute([$id, $status]);
</div><div class='line not-covered'><span class='num'>647</span>    }
</div><div class='line not-executable'><span class='num'>648</span>
</div><div class='line not-executable'><span class='num'>649</span>    public function getLogs($limit): array
</div><div class='line not-executable'><span class='num'>650</span>    {
</div><div class='line not-covered'><span class='num'>651</span>        $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-executable'><span class='num'>652</span>            SELECT *
</div><div class='line not-executable'><span class='num'>653</span>            FROM audit
</div><div class='line not-executable'><span class='num'>654</span>            ORDER BY created_at DESC
</div><div class='line not-executable'><span class='num'>655</span>            LIMIT :limit
</div><div class='line not-executable'><span class='num'>656</span>        &quot;);
</div><div class='line not-covered'><span class='num'>657</span>        $stmt-&gt;bindValue(&#039;:limit&#039;, (int)$limit, PDO::PARAM_INT);
</div><div class='line not-covered'><span class='num'>658</span>        $stmt-&gt;execute();
</div><div class='line not-covered'><span class='num'>659</span>        $rows = $stmt-&gt;fetchAll();
</div><div class='line not-covered'><span class='num'>660</span>        return $rows;
</div><div class='line not-covered'><span class='num'>661</span>    }
</div><div class='line not-executable'><span class='num'>662</span>
</div><div class='line not-executable'><span class='num'>663</span>    public function insertAuditLog(string $entity_type, string $entity_id, string $action, ?array $old_data = null, ?array $new_data = null, string $user_id, string $ip_address): bool
</div><div class='line not-executable'><span class='num'>664</span>    {
</div><div class='line not-executable'><span class='num'>665</span>        try {
</div><div class='line covered'><span class='num'>666</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-executable'><span class='num'>667</span>                INSERT INTO audit (entity_type, entity_id, action, old_data, new_data, user_id, ip_address)
</div><div class='line not-executable'><span class='num'>668</span>                VALUES (:entity_type, :entity_id, :action, :old_data, :new_data, :user_id, :ip_address)
</div><div class='line not-executable'><span class='num'>669</span>            &quot;);
</div><div class='line not-executable'><span class='num'>670</span>
</div><div class='line covered'><span class='num'>671</span>            $stmt-&gt;execute([
</div><div class='line covered'><span class='num'>672</span>                &#039;:entity_type&#039; =&gt; $entity_type,
</div><div class='line covered'><span class='num'>673</span>                &#039;:entity_id&#039;   =&gt; $entity_id,
</div><div class='line covered'><span class='num'>674</span>                &#039;:action&#039;      =&gt; $action,
</div><div class='line not-covered'><span class='num'>675</span>                &#039;:old_data&#039;    =&gt; $old_data !== null ? json_encode($old_data, JSON_UNESCAPED_UNICODE) : null,
</div><div class='line covered'><span class='num'>676</span>                &#039;:new_data&#039;    =&gt; $new_data !== null ? json_encode($new_data, JSON_UNESCAPED_UNICODE) : null,
</div><div class='line covered'><span class='num'>677</span>                &#039;:user_id&#039;     =&gt; $user_id,
</div><div class='line covered'><span class='num'>678</span>                &#039;:ip_address&#039;  =&gt; $ip_address
</div><div class='line not-executable'><span class='num'>679</span>            ]);
</div><div class='line covered'><span class='num'>680</span>            return true;
</div><div class='line not-covered'><span class='num'>681</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>682</span>            error_log(&quot;GraphDatabase audit log insert failed: &quot; . $e-&gt;getMessage());
</div><div class='line not-covered'><span class='num'>683</span>            return false;
</div><div class='line not-executable'><span class='num'>684</span>        }
</div><div class='line not-covered'><span class='num'>685</span>    }
</div><div class='line not-executable'><span class='num'>686</span>
</div><div class='line not-executable'><span class='num'>687</span>    private function initSchema(): void
</div><div class='line not-executable'><span class='num'>688</span>    {
</div><div class='line covered'><span class='num'>689</span>        $this-&gt;pdo-&gt;exec(&quot;
</div><div class='line not-executable'><span class='num'>690</span>            CREATE TABLE IF NOT EXISTS users (
</div><div class='line not-executable'><span class='num'>691</span>                id TEXT PRIMARY KEY,
</div><div class='line not-executable'><span class='num'>692</span>                user_group TEXT NOT NULL
</div><div class='line not-executable'><span class='num'>693</span>            )
</div><div class='line not-executable'><span class='num'>694</span>        &quot;);
</div><div class='line not-executable'><span class='num'>695</span>
</div><div class='line covered'><span class='num'>696</span>        $this-&gt;pdo-&gt;exec(&quot;INSERT INTO users VALUES(&#039;admin&#039;, &#039;admin&#039;)&quot;);
</div><div class='line not-executable'><span class='num'>697</span>
</div><div class='line covered'><span class='num'>698</span>        $this-&gt;pdo-&gt;exec(&quot;
</div><div class='line not-executable'><span class='num'>699</span>            CREATE TABLE IF NOT EXISTS nodes (
</div><div class='line not-executable'><span class='num'>700</span>                id TEXT PRIMARY KEY,
</div><div class='line not-executable'><span class='num'>701</span>                label TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>702</span>                category TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>703</span>                type TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>704</span>                data TEXT NOT NULL
</div><div class='line not-executable'><span class='num'>705</span>            )
</div><div class='line not-executable'><span class='num'>706</span>        &quot;);
</div><div class='line not-executable'><span class='num'>707</span>
</div><div class='line covered'><span class='num'>708</span>        $this-&gt;pdo-&gt;exec(&quot;
</div><div class='line not-executable'><span class='num'>709</span>            CREATE TABLE IF NOT EXISTS edges (
</div><div class='line not-executable'><span class='num'>710</span>                id TEXT PRIMARY KEY,
</div><div class='line not-executable'><span class='num'>711</span>                source TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>712</span>                target TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>713</span>                data TEXT,
</div><div class='line not-executable'><span class='num'>714</span>                FOREIGN KEY (source) REFERENCES nodes(id) ON DELETE CASCADE,
</div><div class='line not-executable'><span class='num'>715</span>                FOREIGN KEY (target) REFERENCES nodes(id) ON DELETE CASCADE
</div><div class='line not-executable'><span class='num'>716</span>            )
</div><div class='line not-executable'><span class='num'>717</span>        &quot;);
</div><div class='line not-executable'><span class='num'>718</span>
</div><div class='line covered'><span class='num'>719</span>        $this-&gt;pdo-&gt;exec(&quot;CREATE UNIQUE INDEX IF NOT EXISTS idx_edges_source_target ON edges (source, target)&quot;);
</div><div class='line not-executable'><span class='num'>720</span>
</div><div class='line covered'><span class='num'>721</span>        $this-&gt;pdo-&gt;exec(&quot;
</div><div class='line not-executable'><span class='num'>722</span>            CREATE TABLE IF NOT EXISTS status (
</div><div class='line not-executable'><span class='num'>723</span>                node_id TEXT PRIMARY KEY NOT NULL,
</div><div class='line not-executable'><span class='num'>724</span>                status TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>725</span>                created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
</div><div class='line not-executable'><span class='num'>726</span>                FOREIGN KEY (node_id) REFERENCES nodes(id) ON DELETE CASCADE
</div><div class='line not-executable'><span class='num'>727</span>            )
</div><div class='line not-executable'><span class='num'>728</span>        &quot;);
</div><div class='line not-executable'><span class='num'>729</span>
</div><div class='line covered'><span class='num'>730</span>        $this-&gt;pdo-&gt;exec(&quot;CREATE INDEX IF NOT EXISTS idx_node_status_node_id ON status (node_id)&quot;);
</div><div class='line not-executable'><span class='num'>731</span>
</div><div class='line covered'><span class='num'>732</span>        $this-&gt;pdo-&gt;exec(&quot;
</div><div class='line not-executable'><span class='num'>733</span>            CREATE TABLE IF NOT EXISTS audit (
</div><div class='line not-executable'><span class='num'>734</span>                id INTEGER PRIMARY KEY AUTOINCREMENT,
</div><div class='line not-executable'><span class='num'>735</span>                entity_type TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>736</span>                entity_id TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>737</span>                action TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>738</span>                old_data TEXT,
</div><div class='line not-executable'><span class='num'>739</span>                new_data TEXT,
</div><div class='line not-executable'><span class='num'>740</span>                user_id TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>741</span>                ip_address TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>742</span>                created_at DATETIME DEFAULT CURRENT_TIMESTAMP
</div><div class='line not-executable'><span class='num'>743</span>            )
</div><div class='line not-executable'><span class='num'>744</span>        &quot;);
</div><div class='line covered'><span class='num'>745</span>    }
</div><div class='line not-executable'><span class='num'>746</span>
</div><div class='line not-executable'><span class='num'>747</span>    public static function createConnection(string $dsn): PDO
</div><div class='line not-executable'><span class='num'>748</span>    {
</div><div class='line covered'><span class='num'>749</span>        $pdo = new PDO($dsn);
</div><div class='line covered'><span class='num'>750</span>        $pdo-&gt;setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
</div><div class='line covered'><span class='num'>751</span>        $pdo-&gt;setAttribute(PDO::ATTR_DEFAULT_FETCH_MODE, PDO::FETCH_ASSOC);
</div><div class='line covered'><span class='num'>752</span>        $pdo-&gt;exec(&#039;PRAGMA foreign_keys = ON&#039;);
</div><div class='line covered'><span class='num'>753</span>        return $pdo;
</div><div class='line not-covered'><span class='num'>754</span>    }
</div><div class='line not-executable'><span class='num'>755</span>}
</div><div class='line not-executable'><span class='num'>756</span>
</div><div class='line not-executable'><span class='num'>757</span>final class GraphServiceException extends RuntimeException
</div><div class='line not-executable'><span class='num'>758</span>{
</div><div class='line not-executable'><span class='num'>759</span>}
</div><div class='line not-executable'><span class='num'>760</span>
</div><div class='line not-executable'><span class='num'>761</span>interface GraphServiceInterface
</div><div class='line not-executable'><span class='num'>762</span>{
</div><div class='line not-executable'><span class='num'>763</span>    public function getUser(string $id): ?User;
</div><div class='line not-executable'><span class='num'>764</span>    public function insertUser(User $user): void;
</div><div class='line not-executable'><span class='num'>765</span>    public function updateUser(User $user): void;
</div><div class='line not-executable'><span class='num'>766</span>
</div><div class='line not-executable'><span class='num'>767</span>    public function getGraph(): Graph;
</div><div class='line not-executable'><span class='num'>768</span>
</div><div class='line not-executable'><span class='num'>769</span>    public function getNode(string $id): ?Node;
</div><div class='line not-executable'><span class='num'>770</span>    public function getNodes(): Nodes;
</div><div class='line not-executable'><span class='num'>771</span>    public function insertNode(Node $node): void;
</div><div class='line not-executable'><span class='num'>772</span>    public function updateNode(Node $node): void;
</div><div class='line not-executable'><span class='num'>773</span>    public function deleteNode(string $id): void;
</div><div class='line not-executable'><span class='num'>774</span>
</div><div class='line not-executable'><span class='num'>775</span>    public function getEdge(string $source, string $target): ?Edge;
</div><div class='line not-executable'><span class='num'>776</span>    public function getEdges(): Edges;
</div><div class='line not-executable'><span class='num'>777</span>    public function insertEdge(Edge $edge): void;
</div><div class='line not-executable'><span class='num'>778</span>    public function updateEdge(Edge $edge): void;
</div><div class='line not-executable'><span class='num'>779</span>    public function deleteEdge(string $id): void;
</div><div class='line not-executable'><span class='num'>780</span>
</div><div class='line not-executable'><span class='num'>781</span>    public function getStatuses(): NodeStatuses;
</div><div class='line not-executable'><span class='num'>782</span>    public function getNodeStatus(string $id): NodeStatus;
</div><div class='line not-executable'><span class='num'>783</span>    public function setNodeStatus(NodeStatus $status): void;
</div><div class='line not-executable'><span class='num'>784</span>
</div><div class='line not-executable'><span class='num'>785</span>    public function getLogs($limit): AuditLogs;
</div><div class='line not-executable'><span class='num'>786</span>}
</div><div class='line not-executable'><span class='num'>787</span>
</div><div class='line not-executable'><span class='num'>788</span>final class GraphService implements GraphServiceInterface
</div><div class='line not-executable'><span class='num'>789</span>{
</div><div class='line not-executable'><span class='num'>790</span>    private const SECURE_ACTIONS = [
</div><div class='line not-executable'><span class='num'>791</span>        &#039;GraphService::getGraph&#039;      =&gt; true,
</div><div class='line not-executable'><span class='num'>792</span>        &#039;GraphService::getNode&#039;       =&gt; true,
</div><div class='line not-executable'><span class='num'>793</span>        &#039;GraphService::getNodes&#039;      =&gt; true,
</div><div class='line not-executable'><span class='num'>794</span>        &#039;GraphService::getEdge&#039;       =&gt; true,
</div><div class='line not-executable'><span class='num'>795</span>        &#039;GraphService::getEdges&#039;      =&gt; true,
</div><div class='line not-executable'><span class='num'>796</span>        &#039;GraphService::getStatuses&#039;   =&gt; true,
</div><div class='line not-executable'><span class='num'>797</span>        &#039;GraphService::getNodeStatus&#039; =&gt; true,
</div><div class='line not-executable'><span class='num'>798</span>        &#039;GraphService::setNodeStatus&#039; =&gt; true,
</div><div class='line not-executable'><span class='num'>799</span>        &#039;GraphService::getLogs&#039;       =&gt; true,
</div><div class='line not-executable'><span class='num'>800</span>        &#039;GraphService::insertNode&#039;    =&gt; false,
</div><div class='line not-executable'><span class='num'>801</span>        &#039;GraphService::updateNode&#039;    =&gt; false,
</div><div class='line not-executable'><span class='num'>802</span>        &#039;GraphService::deleteNode&#039;    =&gt; false,
</div><div class='line not-executable'><span class='num'>803</span>        &#039;GraphService::insertEdge&#039;    =&gt; false,
</div><div class='line not-executable'><span class='num'>804</span>        &#039;GraphService::updateEdge&#039;    =&gt; false,
</div><div class='line not-executable'><span class='num'>805</span>        &#039;GraphService::deleteEdge&#039;    =&gt; false,
</div><div class='line not-executable'><span class='num'>806</span>
</div><div class='line not-executable'><span class='num'>807</span>        &#039;GraphService::insertAuditLog&#039; =&gt; false,
</div><div class='line not-executable'><span class='num'>808</span>    ];
</div><div class='line not-executable'><span class='num'>809</span>
</div><div class='line not-executable'><span class='num'>810</span>    private GraphDatabaseInterface $db;
</div><div class='line not-executable'><span class='num'>811</span>    private Logger $logger;
</div><div class='line not-executable'><span class='num'>812</span>
</div><div class='line not-executable'><span class='num'>813</span>    public function __construct(GraphDatabaseInterface $db, Logger $logger)
</div><div class='line not-executable'><span class='num'>814</span>    {
</div><div class='line covered'><span class='num'>815</span>        $this-&gt;db = $db;
</div><div class='line covered'><span class='num'>816</span>        $this-&gt;logger = $logger;
</div><div class='line covered'><span class='num'>817</span>    }
</div><div class='line not-executable'><span class='num'>818</span>
</div><div class='line not-executable'><span class='num'>819</span>    public function getUser(string $id): ?User
</div><div class='line not-executable'><span class='num'>820</span>    {
</div><div class='line not-covered'><span class='num'>821</span>        $data = $this-&gt;db-&gt;getUser($id);
</div><div class='line not-covered'><span class='num'>822</span>        if ($data) {
</div><div class='line not-covered'><span class='num'>823</span>            $user = new User($id, null, $data[&#039;user_group&#039;]);
</div><div class='line not-covered'><span class='num'>824</span>            return $user;
</div><div class='line not-executable'><span class='num'>825</span>        }
</div><div class='line not-covered'><span class='num'>826</span>        return null;
</div><div class='line not-covered'><span class='num'>827</span>    }
</div><div class='line not-executable'><span class='num'>828</span>
</div><div class='line not-executable'><span class='num'>829</span>    public function insertUser(User $user): void
</div><div class='line not-executable'><span class='num'>830</span>    {
</div><div class='line not-covered'><span class='num'>831</span>        $this-&gt;db-&gt;insertUser($user-&gt;id, $user-&gt;group-&gt;id);
</div><div class='line not-covered'><span class='num'>832</span>    }
</div><div class='line not-executable'><span class='num'>833</span>
</div><div class='line not-executable'><span class='num'>834</span>    public function updateUser(User $user): void
</div><div class='line not-executable'><span class='num'>835</span>    {
</div><div class='line not-covered'><span class='num'>836</span>        $this-&gt;db-&gt;updateUser($user-&gt;id, $user-&gt;group-&gt;id);
</div><div class='line not-covered'><span class='num'>837</span>    }
</div><div class='line not-executable'><span class='num'>838</span>
</div><div class='line not-executable'><span class='num'>839</span>    public function getGraph(): Graph
</div><div class='line not-executable'><span class='num'>840</span>    {
</div><div class='line not-covered'><span class='num'>841</span>        $nodes = $this-&gt;getNodes()-&gt;nodes;
</div><div class='line not-covered'><span class='num'>842</span>        $edges = $this-&gt;getEdges()-&gt;edges;
</div><div class='line not-covered'><span class='num'>843</span>        return new Graph($nodes, $edges);
</div><div class='line not-covered'><span class='num'>844</span>    }
</div><div class='line not-executable'><span class='num'>845</span>
</div><div class='line not-executable'><span class='num'>846</span>    public function getNode(string $id): ?Node
</div><div class='line not-executable'><span class='num'>847</span>    {
</div><div class='line covered'><span class='num'>848</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>849</span>            throw new RuntimeException(&quot;Permission denied to get node.&quot;);
</div><div class='line not-executable'><span class='num'>850</span>        }
</div><div class='line not-executable'><span class='num'>851</span>
</div><div class='line covered'><span class='num'>852</span>        $data = $this-&gt;db-&gt;getNode($id);
</div><div class='line covered'><span class='num'>853</span>        if ($data) {
</div><div class='line covered'><span class='num'>854</span>            return new Node(
</div><div class='line covered'><span class='num'>855</span>                $data[&#039;id&#039;],
</div><div class='line covered'><span class='num'>856</span>                $data[&#039;label&#039;],
</div><div class='line covered'><span class='num'>857</span>                $data[&#039;category&#039;],
</div><div class='line covered'><span class='num'>858</span>                $data[&#039;type&#039;],
</div><div class='line covered'><span class='num'>859</span>                json_decode($data[&#039;data&#039;], true)
</div><div class='line not-executable'><span class='num'>860</span>            );
</div><div class='line not-executable'><span class='num'>861</span>        }
</div><div class='line not-covered'><span class='num'>862</span>        return null;
</div><div class='line not-covered'><span class='num'>863</span>    }
</div><div class='line not-executable'><span class='num'>864</span>
</div><div class='line not-executable'><span class='num'>865</span>    public function getNodes(): Nodes
</div><div class='line not-executable'><span class='num'>866</span>    {
</div><div class='line not-covered'><span class='num'>867</span>        if(! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>868</span>            throw new RuntimeException(&quot;Permission denied to get nodes.&quot;);
</div><div class='line not-executable'><span class='num'>869</span>        }
</div><div class='line not-executable'><span class='num'>870</span>
</div><div class='line not-covered'><span class='num'>871</span>        $nodesData = $this-&gt;db-&gt;getNodes();
</div><div class='line not-covered'><span class='num'>872</span>        $nodes     = new Nodes();
</div><div class='line not-covered'><span class='num'>873</span>        foreach ($nodesData as $data) {
</div><div class='line not-covered'><span class='num'>874</span>            $node = new Node(
</div><div class='line not-covered'><span class='num'>875</span>                $data[&#039;id&#039;],
</div><div class='line not-covered'><span class='num'>876</span>                $data[&#039;label&#039;],
</div><div class='line not-covered'><span class='num'>877</span>                $data[&#039;category&#039;],
</div><div class='line not-covered'><span class='num'>878</span>                $data[&#039;type&#039;],
</div><div class='line not-covered'><span class='num'>879</span>                json_decode($data[&#039;data&#039;], true)
</div><div class='line not-executable'><span class='num'>880</span>            );
</div><div class='line not-covered'><span class='num'>881</span>            $nodes-&gt;addNode($node);
</div><div class='line not-executable'><span class='num'>882</span>        }
</div><div class='line not-covered'><span class='num'>883</span>        return $nodes;
</div><div class='line not-covered'><span class='num'>884</span>    }
</div><div class='line not-executable'><span class='num'>885</span>
</div><div class='line not-executable'><span class='num'>886</span>    public function insertNode(Node $node): void
</div><div class='line not-executable'><span class='num'>887</span>    {
</div><div class='line covered'><span class='num'>888</span>        $this-&gt;logger-&gt;debug(&#039;inserting node&#039;, $node-&gt;toArray());
</div><div class='line not-executable'><span class='num'>889</span>
</div><div class='line covered'><span class='num'>890</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>891</span>            $this-&gt;logger-&gt;info(&#039;permission denied&#039;, $node-&gt;toArray());
</div><div class='line not-covered'><span class='num'>892</span>            throw new GraphServiceException(&#039;permission denied&#039;);
</div><div class='line not-executable'><span class='num'>893</span>        }
</div><div class='line not-executable'><span class='num'>894</span>
</div><div class='line covered'><span class='num'>895</span>        $this-&gt;logger-&gt;info(&#039;permission allowed&#039;, $node-&gt;toArray());
</div><div class='line not-executable'><span class='num'>896</span>
</div><div class='line covered'><span class='num'>897</span>        $this-&gt;insertAuditLog(new AuditLog( &#039;node&#039;, $node-&gt;id, &#039;insert&#039;, null, $node-&gt;toArray()));
</div><div class='line not-executable'><span class='num'>898</span>
</div><div class='line covered'><span class='num'>899</span>        $this-&gt;db-&gt;insertNode(
</div><div class='line covered'><span class='num'>900</span>            $node-&gt;id,
</div><div class='line covered'><span class='num'>901</span>            $node-&gt;label,
</div><div class='line covered'><span class='num'>902</span>            $node-&gt;category,
</div><div class='line covered'><span class='num'>903</span>            $node-&gt;type,
</div><div class='line covered'><span class='num'>904</span>            $node-&gt;data
</div><div class='line not-executable'><span class='num'>905</span>        );
</div><div class='line covered'><span class='num'>906</span>    }
</div><div class='line not-executable'><span class='num'>907</span>
</div><div class='line not-executable'><span class='num'>908</span>    public function updateNode(Node $node): void
</div><div class='line not-executable'><span class='num'>909</span>    {
</div><div class='line not-covered'><span class='num'>910</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>911</span>            throw new RuntimeException(&quot;Permission denied to update node.&quot;);
</div><div class='line not-executable'><span class='num'>912</span>        }
</div><div class='line not-executable'><span class='num'>913</span>
</div><div class='line not-covered'><span class='num'>914</span>        $old = $this-&gt;getNode($node-&gt;id);
</div><div class='line not-covered'><span class='num'>915</span>        $this-&gt;insertAuditLog(new AuditLog( &#039;node&#039;, $node-&gt;id, &#039;update&#039;, $old-&gt;toArray(), $node-&gt;toArray()));
</div><div class='line not-executable'><span class='num'>916</span>
</div><div class='line not-covered'><span class='num'>917</span>        $this-&gt;db-&gt;updateNode(
</div><div class='line not-covered'><span class='num'>918</span>            $node-&gt;id,
</div><div class='line not-covered'><span class='num'>919</span>            $node-&gt;label,
</div><div class='line not-covered'><span class='num'>920</span>            $node-&gt;category,
</div><div class='line not-covered'><span class='num'>921</span>            $node-&gt;type,
</div><div class='line not-covered'><span class='num'>922</span>            $node-&gt;data
</div><div class='line not-executable'><span class='num'>923</span>        );
</div><div class='line not-covered'><span class='num'>924</span>    }
</div><div class='line not-executable'><span class='num'>925</span>
</div><div class='line not-executable'><span class='num'>926</span>    public function deleteNode(string $id): void
</div><div class='line not-executable'><span class='num'>927</span>    {
</div><div class='line not-covered'><span class='num'>928</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>929</span>            throw new RuntimeException(&quot;Permission denied to delete node.&quot;);
</div><div class='line not-executable'><span class='num'>930</span>        }
</div><div class='line not-executable'><span class='num'>931</span>
</div><div class='line not-covered'><span class='num'>932</span>        $old = $this-&gt;getNode($id);
</div><div class='line not-covered'><span class='num'>933</span>        $this-&gt;insertAuditLog(new AuditLog( &#039;node&#039;, $id, &#039;delete&#039;, $old-&gt;toArray(), null));
</div><div class='line not-covered'><span class='num'>934</span>        $this-&gt;db-&gt;deleteNode($id);
</div><div class='line not-covered'><span class='num'>935</span>    }
</div><div class='line not-executable'><span class='num'>936</span>
</div><div class='line not-executable'><span class='num'>937</span>    public function getEdge(string $source, string $target): ?Edge
</div><div class='line not-executable'><span class='num'>938</span>    {
</div><div class='line not-covered'><span class='num'>939</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>940</span>            throw new RuntimeException(&quot;Permission denied to get edge.&quot;);
</div><div class='line not-executable'><span class='num'>941</span>        }
</div><div class='line not-executable'><span class='num'>942</span>
</div><div class='line not-covered'><span class='num'>943</span>        $edgesData = $this-&gt;db-&gt;getEdges();
</div><div class='line not-covered'><span class='num'>944</span>        foreach ($edgesData as $data) {
</div><div class='line not-covered'><span class='num'>945</span>            if ($data[&#039;source&#039;] === $source &amp;&amp; $data[&#039;target&#039;] === $target) {
</div><div class='line not-covered'><span class='num'>946</span>                return new Edge(
</div><div class='line not-covered'><span class='num'>947</span>                    $data[&#039;id&#039;],
</div><div class='line not-covered'><span class='num'>948</span>                    $data[&#039;source&#039;],
</div><div class='line not-covered'><span class='num'>949</span>                    $data[&#039;target&#039;],
</div><div class='line not-covered'><span class='num'>950</span>                    json_decode($data[&#039;data&#039;], true)
</div><div class='line not-executable'><span class='num'>951</span>                );
</div><div class='line not-executable'><span class='num'>952</span>            }
</div><div class='line not-executable'><span class='num'>953</span>        }
</div><div class='line not-covered'><span class='num'>954</span>        return null;
</div><div class='line not-covered'><span class='num'>955</span>    }
</div><div class='line not-executable'><span class='num'>956</span>
</div><div class='line not-executable'><span class='num'>957</span>    public function getEdges(): Edges
</div><div class='line not-executable'><span class='num'>958</span>    {
</div><div class='line not-covered'><span class='num'>959</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>960</span>            throw new RuntimeException(&quot;Permission denied to get edges.&quot;);
</div><div class='line not-executable'><span class='num'>961</span>        }
</div><div class='line not-covered'><span class='num'>962</span>        $edgesData = $this-&gt;db-&gt;getEdges();
</div><div class='line not-covered'><span class='num'>963</span>        $edges     = new Edges();
</div><div class='line not-covered'><span class='num'>964</span>        foreach ($edgesData as $data) {
</div><div class='line not-covered'><span class='num'>965</span>            $edge = new Edge(
</div><div class='line not-covered'><span class='num'>966</span>                $data[&#039;id&#039;],
</div><div class='line not-covered'><span class='num'>967</span>                $data[&#039;source&#039;],
</div><div class='line not-covered'><span class='num'>968</span>                $data[&#039;target&#039;],
</div><div class='line not-covered'><span class='num'>969</span>                json_decode($data[&#039;data&#039;], true)
</div><div class='line not-executable'><span class='num'>970</span>            );
</div><div class='line not-covered'><span class='num'>971</span>            $edges-&gt;addEdge($edge);
</div><div class='line not-executable'><span class='num'>972</span>        }
</div><div class='line not-covered'><span class='num'>973</span>        return $edges;
</div><div class='line not-covered'><span class='num'>974</span>    }
</div><div class='line not-executable'><span class='num'>975</span>
</div><div class='line not-executable'><span class='num'>976</span>    public function insertEdge(Edge $edge): void
</div><div class='line not-executable'><span class='num'>977</span>    {
</div><div class='line not-covered'><span class='num'>978</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>979</span>            throw new RuntimeException(&quot;Permission denied to insert edge.&quot;);
</div><div class='line not-executable'><span class='num'>980</span>        }
</div><div class='line not-covered'><span class='num'>981</span>        $this-&gt;insertAuditLog(new AuditLog( &#039;edge&#039;, $edge-&gt;id, &#039;insert&#039;, null, $edge-&gt;toArray()));
</div><div class='line not-covered'><span class='num'>982</span>        $this-&gt;db-&gt;insertEdge(
</div><div class='line not-covered'><span class='num'>983</span>            $edge-&gt;id,
</div><div class='line not-covered'><span class='num'>984</span>            $edge-&gt;source,
</div><div class='line not-covered'><span class='num'>985</span>            $edge-&gt;target,
</div><div class='line not-covered'><span class='num'>986</span>            $edge-&gt;data
</div><div class='line not-executable'><span class='num'>987</span>        );
</div><div class='line not-covered'><span class='num'>988</span>    }
</div><div class='line not-executable'><span class='num'>989</span>
</div><div class='line not-executable'><span class='num'>990</span>    public function updateEdge(Edge $edge): void
</div><div class='line not-executable'><span class='num'>991</span>    {
</div><div class='line not-covered'><span class='num'>992</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>993</span>            throw new RuntimeException(&quot;Permission denied to update edge.&quot;);
</div><div class='line not-executable'><span class='num'>994</span>        }
</div><div class='line not-covered'><span class='num'>995</span>        $old = $this-&gt;getEdge($edge-&gt;source, $edge-&gt;target);
</div><div class='line not-covered'><span class='num'>996</span>        $this-&gt;insertAuditLog(new AuditLog( &#039;edge&#039;, $edge-&gt;id, &#039;update&#039;, $old-&gt;toArray(), $edge-&gt;toArray()));
</div><div class='line not-executable'><span class='num'>997</span>
</div><div class='line not-covered'><span class='num'>998</span>        $this-&gt;db-&gt;updateEdge(
</div><div class='line not-covered'><span class='num'>999</span>            $edge-&gt;id,
</div><div class='line not-covered'><span class='num'>1000</span>            $edge-&gt;source,
</div><div class='line not-covered'><span class='num'>1001</span>            $edge-&gt;target,
</div><div class='line not-covered'><span class='num'>1002</span>            $edge-&gt;data
</div><div class='line not-executable'><span class='num'>1003</span>        );
</div><div class='line not-covered'><span class='num'>1004</span>    }
</div><div class='line not-executable'><span class='num'>1005</span>
</div><div class='line not-executable'><span class='num'>1006</span>    public function deleteEdge(string $id): void
</div><div class='line not-executable'><span class='num'>1007</span>    {
</div><div class='line not-covered'><span class='num'>1008</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>1009</span>            throw new RuntimeException(&quot;Permission denied to delete edge.&quot;);
</div><div class='line not-executable'><span class='num'>1010</span>        }
</div><div class='line not-covered'><span class='num'>1011</span>        $this-&gt;db-&gt;deleteEdge($id);
</div><div class='line not-covered'><span class='num'>1012</span>    }
</div><div class='line not-executable'><span class='num'>1013</span>
</div><div class='line not-executable'><span class='num'>1014</span>    public function getStatuses(): NodeStatuses
</div><div class='line not-executable'><span class='num'>1015</span>    {
</div><div class='line not-covered'><span class='num'>1016</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>1017</span>            throw new RuntimeException(&quot;Permission denied to get statuses.&quot;);
</div><div class='line not-executable'><span class='num'>1018</span>        }
</div><div class='line not-executable'><span class='num'>1019</span>
</div><div class='line not-covered'><span class='num'>1020</span>        $statusesData = $this-&gt;db-&gt;getStatuses();
</div><div class='line not-covered'><span class='num'>1021</span>        $nodeStatuses = new NodeStatuses();
</div><div class='line not-covered'><span class='num'>1022</span>        foreach ($statusesData as $data) {
</div><div class='line not-covered'><span class='num'>1023</span>            $status = new NodeStatus(
</div><div class='line not-covered'><span class='num'>1024</span>                $data[&#039;id&#039;],
</div><div class='line not-covered'><span class='num'>1025</span>                $data[&#039;status&#039;] ?? &#039;unknown&#039;
</div><div class='line not-executable'><span class='num'>1026</span>            );
</div><div class='line not-covered'><span class='num'>1027</span>            $nodeStatuses-&gt;addStatus($status);
</div><div class='line not-executable'><span class='num'>1028</span>        }
</div><div class='line not-covered'><span class='num'>1029</span>        return $nodeStatuses;
</div><div class='line not-covered'><span class='num'>1030</span>    }
</div><div class='line not-executable'><span class='num'>1031</span>
</div><div class='line not-executable'><span class='num'>1032</span>    public function getNodeStatus(string $id): NodeStatus
</div><div class='line not-executable'><span class='num'>1033</span>    {
</div><div class='line not-covered'><span class='num'>1034</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>1035</span>            throw new RuntimeException(&quot;Permission denied to get node status.&quot;);
</div><div class='line not-executable'><span class='num'>1036</span>        }
</div><div class='line not-executable'><span class='num'>1037</span>
</div><div class='line not-covered'><span class='num'>1038</span>        $statusData = $this-&gt;db-&gt;getNodeStatus($id);
</div><div class='line not-covered'><span class='num'>1039</span>        return new NodeStatus(
</div><div class='line not-covered'><span class='num'>1040</span>            $id,
</div><div class='line not-covered'><span class='num'>1041</span>            $statusData ?? &#039;unknown&#039;
</div><div class='line not-executable'><span class='num'>1042</span>        );
</div><div class='line not-covered'><span class='num'>1043</span>    }
</div><div class='line not-executable'><span class='num'>1044</span>
</div><div class='line not-executable'><span class='num'>1045</span>    public function setNodeStatus(NodeStatus $status): void
</div><div class='line not-executable'><span class='num'>1046</span>    {
</div><div class='line not-covered'><span class='num'>1047</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>1048</span>            throw new RuntimeException(&quot;Permission denied to set node status.&quot;);
</div><div class='line not-executable'><span class='num'>1049</span>        }
</div><div class='line not-executable'><span class='num'>1050</span>
</div><div class='line not-covered'><span class='num'>1051</span>        $this-&gt;db-&gt;setNodeStatus($status-&gt;nodeId, $status-&gt;status);
</div><div class='line not-covered'><span class='num'>1052</span>    }
</div><div class='line not-executable'><span class='num'>1053</span>
</div><div class='line not-executable'><span class='num'>1054</span>    public function getLogs($limit): AuditLogs
</div><div class='line not-executable'><span class='num'>1055</span>    {
</div><div class='line not-covered'><span class='num'>1056</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>1057</span>            throw new RuntimeException(&quot;Permission denied to get audit logs.&quot;);
</div><div class='line not-executable'><span class='num'>1058</span>        }
</div><div class='line not-executable'><span class='num'>1059</span>
</div><div class='line not-covered'><span class='num'>1060</span>        $logs = new AuditLogs();
</div><div class='line not-covered'><span class='num'>1061</span>        $rows = $this-&gt;db-&gt;getLogs($limit);
</div><div class='line not-covered'><span class='num'>1062</span>        foreach ($rows as $row) {
</div><div class='line not-covered'><span class='num'>1063</span>            $old_data = $row[&#039;old_data&#039;] ? json_decode($row[&#039;old_data&#039;], true) : [];
</div><div class='line not-covered'><span class='num'>1064</span>            $new_data = $row[&#039;new_data&#039;] ?  json_decode($row[&#039;new_data&#039;], true) : [];
</div><div class='line not-covered'><span class='num'>1065</span>            $log = new AuditLog(
</div><div class='line not-covered'><span class='num'>1066</span>                $row[&#039;entity_type&#039;],
</div><div class='line not-covered'><span class='num'>1067</span>                $row[&#039;entity_id&#039;],
</div><div class='line not-covered'><span class='num'>1068</span>                $row[&#039;action&#039;],
</div><div class='line not-executable'><span class='num'>1069</span>                $old_data,
</div><div class='line not-executable'><span class='num'>1070</span>                $new_data,
</div><div class='line not-executable'><span class='num'>1071</span>            );
</div><div class='line not-covered'><span class='num'>1072</span>            $log-&gt;userId    = $row[&#039;user_id&#039;];
</div><div class='line not-covered'><span class='num'>1073</span>            $log-&gt;ipAddress = $row[&#039;ip_address&#039;];
</div><div class='line not-covered'><span class='num'>1074</span>            $log-&gt;createdAt = $row[&#039;created_at&#039;];
</div><div class='line not-executable'><span class='num'>1075</span>
</div><div class='line not-covered'><span class='num'>1076</span>            $logs-&gt;addLog($log);
</div><div class='line not-executable'><span class='num'>1077</span>        }
</div><div class='line not-covered'><span class='num'>1078</span>        return $logs;
</div><div class='line not-covered'><span class='num'>1079</span>    }
</div><div class='line not-executable'><span class='num'>1080</span>
</div><div class='line not-executable'><span class='num'>1081</span>    private function insertAuditLog(AuditLog $auditLog): void
</div><div class='line not-executable'><span class='num'>1082</span>    {
</div><div class='line covered'><span class='num'>1083</span>        $user_id   = GraphContext::$user-&gt;id;
</div><div class='line covered'><span class='num'>1084</span>        $ip_address = GraphContext::$user-&gt;ipAddress;
</div><div class='line not-executable'><span class='num'>1085</span>
</div><div class='line covered'><span class='num'>1086</span>        $this-&gt;db-&gt;insertAuditLog(
</div><div class='line covered'><span class='num'>1087</span>            $auditLog-&gt;entityType,
</div><div class='line covered'><span class='num'>1088</span>            $auditLog-&gt;entityId,
</div><div class='line covered'><span class='num'>1089</span>            $auditLog-&gt;action,
</div><div class='line covered'><span class='num'>1090</span>            $auditLog-&gt;oldData,
</div><div class='line covered'><span class='num'>1091</span>            $auditLog-&gt;newData,
</div><div class='line not-executable'><span class='num'>1092</span>            $user_id,
</div><div class='line not-executable'><span class='num'>1093</span>            $ip_address
</div><div class='line not-executable'><span class='num'>1094</span>        );
</div><div class='line covered'><span class='num'>1095</span>    }
</div><div class='line not-executable'><span class='num'>1096</span>
</div><div class='line not-executable'><span class='num'>1097</span>    private function isAllowed(string $action): bool
</div><div class='line not-executable'><span class='num'>1098</span>    {
</div><div class='line covered'><span class='num'>1099</span>        $group = GraphContext::$user-&gt;group;
</div><div class='line not-executable'><span class='num'>1100</span>
</div><div class='line not-executable'><span class='num'>1101</span>        // validate action
</div><div class='line not-executable'><span class='num'>1102</span>        // if action is one of the keys in the array self::SECURE_ACTIONS
</div><div class='line covered'><span class='num'>1103</span>        if (!array_key_exists($action, self::SECURE_ACTIONS)) {
</div><div class='line not-covered'><span class='num'>1104</span>            throw new RuntimeException(&quot;Action not defined in secure actions. Action: {$action}&quot;);
</div><div class='line not-executable'><span class='num'>1105</span>        }
</div><div class='line not-executable'><span class='num'>1106</span>
</div><div class='line not-executable'><span class='num'>1107</span>        // if is admin, allow all
</div><div class='line covered'><span class='num'>1108</span>        if ($group-&gt;id === &#039;admin&#039;) {
</div><div class='line not-covered'><span class='num'>1109</span>            return true;
</div><div class='line not-executable'><span class='num'>1110</span>        }
</div><div class='line not-executable'><span class='num'>1111</span>
</div><div class='line not-executable'><span class='num'>1112</span>        // if action is in the SAFE_ACTIONS, allow all
</div><div class='line covered'><span class='num'>1113</span>        if (self::SECURE_ACTIONS[$action]) {
</div><div class='line covered'><span class='num'>1114</span>            return true;
</div><div class='line not-executable'><span class='num'>1115</span>        }
</div><div class='line not-executable'><span class='num'>1116</span>        
</div><div class='line not-executable'><span class='num'>1117</span>        // if action is restricted, only allow contributor
</div><div class='line covered'><span class='num'>1118</span>        if (self::SECURE_ACTIONS[$action] == false &amp;&amp; $group-&gt;id == &#039;contributor&#039;)
</div><div class='line not-executable'><span class='num'>1119</span>        {
</div><div class='line covered'><span class='num'>1120</span>            return true;
</div><div class='line not-executable'><span class='num'>1121</span>        }
</div><div class='line not-executable'><span class='num'>1122</span>
</div><div class='line not-covered'><span class='num'>1123</span>        return false;
</div><div class='line not-covered'><span class='num'>1124</span>    }
</div><div class='line not-executable'><span class='num'>1125</span>}
</div><div class='line not-executable'><span class='num'>1126</span>
</div><div class='line not-executable'><span class='num'>1127</span>final class Request
</div><div class='line not-executable'><span class='num'>1128</span>{
</div><div class='line not-executable'><span class='num'>1129</span>    public array $data;
</div><div class='line not-executable'><span class='num'>1130</span>
</div><div class='line not-executable'><span class='num'>1131</span>    public function getParam($name): string
</div><div class='line not-executable'><span class='num'>1132</span>    {
</div><div class='line covered'><span class='num'>1133</span>        if(isset($_GET[$name])) {
</div><div class='line covered'><span class='num'>1134</span>            return $_GET[$name];
</div><div class='line not-executable'><span class='num'>1135</span>        }
</div><div class='line not-executable'><span class='num'>1136</span>
</div><div class='line not-covered'><span class='num'>1137</span>        throw new RuntimeException(&quot;param &#039;{$name}&#039; not found&quot;);
</div><div class='line not-covered'><span class='num'>1138</span>    }
</div><div class='line not-executable'><span class='num'>1139</span>
</div><div class='line not-executable'><span class='num'>1140</span>    public function getPath(): string
</div><div class='line not-executable'><span class='num'>1141</span>    {
</div><div class='line not-covered'><span class='num'>1142</span>        $scriptName = $_SERVER[&#039;SCRIPT_NAME&#039;];
</div><div class='line not-covered'><span class='num'>1143</span>        $requestUri = $_SERVER[&#039;REQUEST_URI&#039;];
</div><div class='line not-covered'><span class='num'>1144</span>        $requestUri = strtok($requestUri, &#039;?&#039;);
</div><div class='line not-covered'><span class='num'>1145</span>        $path = str_replace($scriptName, &#039;&#039;, $requestUri);
</div><div class='line not-covered'><span class='num'>1146</span>        return $path;
</div><div class='line not-covered'><span class='num'>1147</span>    }
</div><div class='line not-executable'><span class='num'>1148</span>}
</div><div class='line not-executable'><span class='num'>1149</span>
</div><div class='line not-executable'><span class='num'>1150</span>interface ResponseInterface
</div><div class='line not-executable'><span class='num'>1151</span>{
</div><div class='line not-executable'><span class='num'>1152</span>    public function send(): void;
</div><div class='line not-executable'><span class='num'>1153</span>}
</div><div class='line not-executable'><span class='num'>1154</span>
</div><div class='line not-executable'><span class='num'>1155</span>class Response implements ResponseInterface
</div><div class='line not-executable'><span class='num'>1156</span>{
</div><div class='line not-executable'><span class='num'>1157</span>    public int $code;
</div><div class='line not-executable'><span class='num'>1158</span>    public string $status;
</div><div class='line not-executable'><span class='num'>1159</span>    public string $message;
</div><div class='line not-executable'><span class='num'>1160</span>    public array $data;
</div><div class='line not-executable'><span class='num'>1161</span>
</div><div class='line not-executable'><span class='num'>1162</span>    public function __construct(int $code, string $status, string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1163</span>    {
</div><div class='line covered'><span class='num'>1164</span>        $this-&gt;code = $code;
</div><div class='line covered'><span class='num'>1165</span>        $this-&gt;status = $status;
</div><div class='line covered'><span class='num'>1166</span>        $this-&gt;message = $message;
</div><div class='line covered'><span class='num'>1167</span>        $this-&gt;data = $data;
</div><div class='line covered'><span class='num'>1168</span>    }
</div><div class='line not-executable'><span class='num'>1169</span>
</div><div class='line not-executable'><span class='num'>1170</span>    public function send(): void
</div><div class='line not-executable'><span class='num'>1171</span>    {
</div><div class='line not-covered'><span class='num'>1172</span>        header(&#039;Content-Type: application/json; charset=utf-8&#039;);
</div><div class='line not-covered'><span class='num'>1173</span>        http_response_code($this-&gt;code);
</div><div class='line not-covered'><span class='num'>1174</span>        $this-&gt;data = [&#039;code&#039; =&gt; $this-&gt;code, &#039;status&#039; =&gt; $this-&gt;status, &#039;message&#039; =&gt; $this-&gt;message, &#039;data&#039; =&gt; $this-&gt;data];
</div><div class='line not-covered'><span class='num'>1175</span>        echo json_encode($this-&gt;data, JSON_UNESCAPED_UNICODE |  JSON_UNESCAPED_SLASHES |  JSON_PRETTY_PRINT);
</div><div class='line not-covered'><span class='num'>1176</span>    }
</div><div class='line not-executable'><span class='num'>1177</span>}
</div><div class='line not-executable'><span class='num'>1178</span>
</div><div class='line not-executable'><span class='num'>1179</span>class OKResponse extends Response
</div><div class='line not-executable'><span class='num'>1180</span>{
</div><div class='line not-executable'><span class='num'>1181</span>    public function __construct(string $message, array $data)
</div><div class='line not-executable'><span class='num'>1182</span>    {
</div><div class='line covered'><span class='num'>1183</span>        return parent::__construct(200, &#039;success&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1184</span>    }
</div><div class='line not-executable'><span class='num'>1185</span>}
</div><div class='line not-executable'><span class='num'>1186</span>
</div><div class='line not-executable'><span class='num'>1187</span>class CreatedResponse extends Response
</div><div class='line not-executable'><span class='num'>1188</span>{
</div><div class='line not-executable'><span class='num'>1189</span>    public function __construct(string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1190</span>    {
</div><div class='line covered'><span class='num'>1191</span>        return parent::__construct(201, &#039;success&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1192</span>    }
</div><div class='line not-executable'><span class='num'>1193</span>}
</div><div class='line not-executable'><span class='num'>1194</span>
</div><div class='line not-executable'><span class='num'>1195</span>class BadRequestResponse extends Response
</div><div class='line not-executable'><span class='num'>1196</span>{
</div><div class='line not-executable'><span class='num'>1197</span>    public function __construct(string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1198</span>    {
</div><div class='line not-covered'><span class='num'>1199</span>        return parent::__construct(400, &#039;error&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1200</span>    }
</div><div class='line not-executable'><span class='num'>1201</span>}
</div><div class='line not-executable'><span class='num'>1202</span>
</div><div class='line not-executable'><span class='num'>1203</span>class UnauthorizedResponse extends Response
</div><div class='line not-executable'><span class='num'>1204</span>{
</div><div class='line not-executable'><span class='num'>1205</span>    public function __construct(string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1206</span>    {
</div><div class='line not-covered'><span class='num'>1207</span>        return parent::__construct(401, &#039;error&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1208</span>    }
</div><div class='line not-executable'><span class='num'>1209</span>}
</div><div class='line not-executable'><span class='num'>1210</span>
</div><div class='line not-executable'><span class='num'>1211</span>class ForbiddenResponse extends Response
</div><div class='line not-executable'><span class='num'>1212</span>{
</div><div class='line not-executable'><span class='num'>1213</span>    public function __construct(string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1214</span>    {
</div><div class='line not-covered'><span class='num'>1215</span>        return parent::__construct(403, &#039;error&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1216</span>    }
</div><div class='line not-executable'><span class='num'>1217</span>}
</div><div class='line not-executable'><span class='num'>1218</span>
</div><div class='line not-executable'><span class='num'>1219</span>class NotFoundResponse extends Response
</div><div class='line not-executable'><span class='num'>1220</span>{
</div><div class='line not-executable'><span class='num'>1221</span>    public function __construct(string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1222</span>    {
</div><div class='line not-covered'><span class='num'>1223</span>        return parent::__construct(404, &#039;error&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1224</span>    }
</div><div class='line not-executable'><span class='num'>1225</span>}
</div><div class='line not-executable'><span class='num'>1226</span>
</div><div class='line not-executable'><span class='num'>1227</span>class InternalServerErrorResponse extends Response
</div><div class='line not-executable'><span class='num'>1228</span>{
</div><div class='line not-executable'><span class='num'>1229</span>    public function __construct(string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1230</span>    {
</div><div class='line not-covered'><span class='num'>1231</span>        return parent::__construct(500, &#039;error&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1232</span>    }
</div><div class='line not-executable'><span class='num'>1233</span>}
</div><div class='line not-executable'><span class='num'>1234</span>
</div><div class='line not-executable'><span class='num'>1235</span>interface GraphControllerInterface
</div><div class='line not-executable'><span class='num'>1236</span>{
</div><div class='line not-executable'><span class='num'>1237</span>    public function getUser(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1238</span>    public function insertUser(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1239</span>    public function updateUser(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1240</span>
</div><div class='line not-executable'><span class='num'>1241</span>    public function getGraph(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1242</span>
</div><div class='line not-executable'><span class='num'>1243</span>    public function getNode(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1244</span>    public function getNodes(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1245</span>    public function insertNode(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1246</span>    public function updateNode(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1247</span>    public function deleteNode(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1248</span>
</div><div class='line not-executable'><span class='num'>1249</span>    public function getEdge(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1250</span>    public function getEdges(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1251</span>    public function insertEdge(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1252</span>    public function updateEdge(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1253</span>    public function deleteEdge(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1254</span>
</div><div class='line not-executable'><span class='num'>1255</span>    public function getStatuses(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1256</span>    public function getNodeStatus(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1257</span>    public function setNodeStatus(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1258</span>
</div><div class='line not-executable'><span class='num'>1259</span>    public function getLogs(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1260</span>}
</div><div class='line not-executable'><span class='num'>1261</span>
</div><div class='line not-executable'><span class='num'>1262</span>final class GraphControllerException extends RuntimeException
</div><div class='line not-executable'><span class='num'>1263</span>{
</div><div class='line not-executable'><span class='num'>1264</span>}
</div><div class='line not-executable'><span class='num'>1265</span>
</div><div class='line not-executable'><span class='num'>1266</span>final class GraphController implements GraphControllerInterface
</div><div class='line not-executable'><span class='num'>1267</span>{
</div><div class='line not-executable'><span class='num'>1268</span>    private GraphServiceInterface $service;
</div><div class='line not-executable'><span class='num'>1269</span>    private Logger $logger;
</div><div class='line not-executable'><span class='num'>1270</span>
</div><div class='line not-executable'><span class='num'>1271</span>    public function __construct(GraphServiceInterface $service, Logger $logger)
</div><div class='line not-executable'><span class='num'>1272</span>    {
</div><div class='line covered'><span class='num'>1273</span>        $this-&gt;service = $service;
</div><div class='line covered'><span class='num'>1274</span>        $this-&gt;logger = $logger;
</div><div class='line covered'><span class='num'>1275</span>    }
</div><div class='line not-executable'><span class='num'>1276</span>
</div><div class='line not-executable'><span class='num'>1277</span>    public function getUser(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1278</span>    {
</div><div class='line not-covered'><span class='num'>1279</span>        $data = $this-&gt;service-&gt;getUser($req-&gt;data[&#039;id&#039;]);
</div><div class='line not-covered'><span class='num'>1280</span>        $user = new User($data[&#039;id&#039;], null, new Group($data[&#039;user_group&#039;]));
</div><div class='line not-covered'><span class='num'>1281</span>        return new OKResponse(&#039;user found&#039;, $user-&gt;toArray());
</div><div class='line not-covered'><span class='num'>1282</span>    }
</div><div class='line not-executable'><span class='num'>1283</span>
</div><div class='line not-executable'><span class='num'>1284</span>    public function insertUser(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1285</span>    {
</div><div class='line not-covered'><span class='num'>1286</span>        $user = new User($req-&gt;data[&#039;id&#039;], null, $req-&gt;data[&#039;user_group&#039;]);
</div><div class='line not-covered'><span class='num'>1287</span>        $this-&gt;service-&gt;insertUser($user);
</div><div class='line not-covered'><span class='num'>1288</span>        return new OKResponse(&#039;user created&#039;, $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1289</span>    }
</div><div class='line not-executable'><span class='num'>1290</span>
</div><div class='line not-executable'><span class='num'>1291</span>    public function updateUser(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1292</span>    {
</div><div class='line not-covered'><span class='num'>1293</span>        $user = new User($req-&gt;data[&#039;id&#039;], null, $req-&gt;data[&#039;user_group&#039;]);
</div><div class='line not-covered'><span class='num'>1294</span>        $this-&gt;service-&gt;updateUser($user);
</div><div class='line not-covered'><span class='num'>1295</span>        return new CreatedResponse(&#039;user updated&#039;, $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1296</span>    }
</div><div class='line not-executable'><span class='num'>1297</span>
</div><div class='line not-executable'><span class='num'>1298</span>    public function getGraph(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1299</span>    {
</div><div class='line not-executable'><span class='num'>1300</span>        try {
</div><div class='line not-covered'><span class='num'>1301</span>            $data = $this-&gt;service-&gt;getGraph()-&gt;toArray();
</div><div class='line not-covered'><span class='num'>1302</span>            return new OKResponse(&#039;get graph&#039;, $data);
</div><div class='line not-covered'><span class='num'>1303</span>            return $resp;
</div><div class='line not-covered'><span class='num'>1304</span>        } catch (Exception $e) {
</div><div class='line not-covered'><span class='num'>1305</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1306</span>        }
</div><div class='line not-executable'><span class='num'>1307</span>
</div><div class='line not-covered'><span class='num'>1308</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1309</span>    }
</div><div class='line not-executable'><span class='num'>1310</span>
</div><div class='line not-executable'><span class='num'>1311</span>    public function getNode(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1312</span>    {
</div><div class='line not-executable'><span class='num'>1313</span>        try {
</div><div class='line covered'><span class='num'>1314</span>            $id = $req-&gt;getParam(&#039;id&#039;);
</div><div class='line covered'><span class='num'>1315</span>            $node = $this-&gt;service-&gt;getNode($id);
</div><div class='line covered'><span class='num'>1316</span>            $data = $node-&gt;toArray();
</div><div class='line covered'><span class='num'>1317</span>            return new OKResponse(&#039;node found&#039;, $data);
</div><div class='line not-covered'><span class='num'>1318</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1319</span>        {
</div><div class='line not-covered'><span class='num'>1320</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1321</span>        }
</div><div class='line not-executable'><span class='num'>1322</span>
</div><div class='line not-covered'><span class='num'>1323</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1324</span>    }
</div><div class='line not-executable'><span class='num'>1325</span>
</div><div class='line not-executable'><span class='num'>1326</span>    public function getNodes(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1327</span>    {
</div><div class='line not-executable'><span class='num'>1328</span>        try {
</div><div class='line not-covered'><span class='num'>1329</span>            $nodes = $this-&gt;service-&gt;getNodes();
</div><div class='line not-executable'><span class='num'>1330</span>            // TODO: corrigir
</div><div class='line not-covered'><span class='num'>1331</span>            return new OKResponse(&#039;nodes found&#039;, []);
</div><div class='line not-covered'><span class='num'>1332</span>            return $resp;
</div><div class='line not-covered'><span class='num'>1333</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1334</span>        {
</div><div class='line not-covered'><span class='num'>1335</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1336</span>        }
</div><div class='line not-executable'><span class='num'>1337</span>        
</div><div class='line not-covered'><span class='num'>1338</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1339</span>    }
</div><div class='line not-executable'><span class='num'>1340</span>
</div><div class='line not-executable'><span class='num'>1341</span>    public function insertNode(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1342</span>    {
</div><div class='line covered'><span class='num'>1343</span>        $this-&gt;logger-&gt;debug(&#039;inserting node&#039;, $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1344</span>        try {
</div><div class='line covered'><span class='num'>1345</span>            $node = new Node($req-&gt;data[&#039;id&#039;], $req-&gt;data[&#039;label&#039;], $req-&gt;data[&#039;category&#039;], $req-&gt;data[&#039;type&#039;], $req-&gt;data[&#039;data&#039;]);
</div><div class='line covered'><span class='num'>1346</span>            $this-&gt;service-&gt;insertNode($node);
</div><div class='line covered'><span class='num'>1347</span>            $this-&gt;logger-&gt;info(&#039;node inserted&#039;, $req-&gt;data);
</div><div class='line covered'><span class='num'>1348</span>            return new CreatedResponse(&#039;node inserted&#039;, $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1349</span>        } catch( GraphServiceException $e)
</div><div class='line not-executable'><span class='num'>1350</span>        {
</div><div class='line not-covered'><span class='num'>1351</span>            $this-&gt;logger-&gt;error(&#039;The service could not insert new node:&#039; . $e-&gt;getMessage());
</div><div class='line not-covered'><span class='num'>1352</span>            throw new GraphControllerException(&#039;The service could not insert new node:&#039; . $e-&gt;getMessage(), 0, $e);
</div><div class='line not-executable'><span class='num'>1353</span>        }
</div><div class='line not-covered'><span class='num'>1354</span>        return new InternalServerErrorResponse(&#039;unknow error inserting node&#039;, $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1355</span>    }
</div><div class='line not-executable'><span class='num'>1356</span>    
</div><div class='line not-executable'><span class='num'>1357</span>    public function updateNode(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1358</span>    {
</div><div class='line not-executable'><span class='num'>1359</span>        try {
</div><div class='line not-covered'><span class='num'>1360</span>            $edge = new Edge($req-&gt;data[&#039;id&#039;], $req-&gt;data[&#039;source&#039;], $req-&gt;data[&#039;target&#039;], $req-&gt;data[&#039;data&#039;]);
</div><div class='line not-covered'><span class='num'>1361</span>            $this-&gt;service-&gt;insertEdge($edge);
</div><div class='line not-covered'><span class='num'>1362</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1363</span>        {
</div><div class='line not-covered'><span class='num'>1364</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1365</span>        }
</div><div class='line not-executable'><span class='num'>1366</span>        
</div><div class='line not-covered'><span class='num'>1367</span>        return new InternalServerErrorResponse(&#039;unknow todo in updateNode&#039;, $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1368</span>    }
</div><div class='line not-executable'><span class='num'>1369</span>    
</div><div class='line not-executable'><span class='num'>1370</span>    public function deleteNode(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1371</span>    {
</div><div class='line not-executable'><span class='num'>1372</span>        try {
</div><div class='line not-covered'><span class='num'>1373</span>            $this-&gt;service-&gt;deleteEdge($req-&gt;data[&#039;id&#039;]);
</div><div class='line not-covered'><span class='num'>1374</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1375</span>        {
</div><div class='line not-covered'><span class='num'>1376</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1377</span>        }
</div><div class='line not-executable'><span class='num'>1378</span>        
</div><div class='line not-covered'><span class='num'>1379</span>        return new InternalServerErrorResponse(&#039;unknow todo in deleteNode&#039;, $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1380</span>    }
</div><div class='line not-executable'><span class='num'>1381</span>
</div><div class='line not-executable'><span class='num'>1382</span>    public function getEdge(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1383</span>    {
</div><div class='line not-executable'><span class='num'>1384</span>        try {
</div><div class='line not-covered'><span class='num'>1385</span>            $edge = $this-&gt;service-&gt;getEdge($req-&gt;data[&#039;source&#039;], $req-&gt;data[&#039;target&#039;]);
</div><div class='line not-covered'><span class='num'>1386</span>            $data = $edge-&gt;toArray();
</div><div class='line not-covered'><span class='num'>1387</span>            return new OKResponse(&#039;node found&#039;, $data);
</div><div class='line not-covered'><span class='num'>1388</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1389</span>        {
</div><div class='line not-covered'><span class='num'>1390</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1391</span>        }
</div><div class='line not-executable'><span class='num'>1392</span>        
</div><div class='line not-covered'><span class='num'>1393</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1394</span>    }
</div><div class='line not-executable'><span class='num'>1395</span>    
</div><div class='line not-executable'><span class='num'>1396</span>    public function getEdges(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1397</span>    {
</div><div class='line not-executable'><span class='num'>1398</span>        try {
</div><div class='line not-covered'><span class='num'>1399</span>            $edges = $this-&gt;service-&gt;getEdges();
</div><div class='line not-executable'><span class='num'>1400</span>            // TODO: corrigir
</div><div class='line not-covered'><span class='num'>1401</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1402</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1403</span>        {
</div><div class='line not-covered'><span class='num'>1404</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1405</span>        }
</div><div class='line not-executable'><span class='num'>1406</span>        
</div><div class='line not-covered'><span class='num'>1407</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1408</span>    }
</div><div class='line not-executable'><span class='num'>1409</span>    
</div><div class='line not-executable'><span class='num'>1410</span>    public function insertEdge(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1411</span>    {
</div><div class='line not-executable'><span class='num'>1412</span>        try {
</div><div class='line not-covered'><span class='num'>1413</span>            $edge = new Edge(null, $req-&gt;data[&#039;source&#039;], $req-&gt;data[&#039;target&#039;]);
</div><div class='line not-covered'><span class='num'>1414</span>            $this-&gt;service-&gt;insertEdge($edge);
</div><div class='line not-covered'><span class='num'>1415</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1416</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1417</span>        {
</div><div class='line not-covered'><span class='num'>1418</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1419</span>        }
</div><div class='line not-executable'><span class='num'>1420</span>        
</div><div class='line not-covered'><span class='num'>1421</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1422</span>    }
</div><div class='line not-executable'><span class='num'>1423</span>    
</div><div class='line not-executable'><span class='num'>1424</span>    public function updateEdge(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1425</span>    {
</div><div class='line not-executable'><span class='num'>1426</span>        try {
</div><div class='line not-covered'><span class='num'>1427</span>            $edge = new Edge($req-&gt;data[&#039;id&#039;], $req-&gt;data[&#039;source&#039;], $req-&gt;data[&#039;target&#039;], $req-&gt;data[&#039;data&#039;]);
</div><div class='line not-covered'><span class='num'>1428</span>            $this-&gt;service-&gt;updateEdge($edge);
</div><div class='line not-covered'><span class='num'>1429</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1430</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1431</span>        {
</div><div class='line not-covered'><span class='num'>1432</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1433</span>        }
</div><div class='line not-executable'><span class='num'>1434</span>        
</div><div class='line not-covered'><span class='num'>1435</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1436</span>    }
</div><div class='line not-executable'><span class='num'>1437</span>    
</div><div class='line not-executable'><span class='num'>1438</span>    public function deleteEdge(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1439</span>    {
</div><div class='line not-executable'><span class='num'>1440</span>        try {
</div><div class='line not-covered'><span class='num'>1441</span>            $id = $req-&gt;data[&#039;id&#039;];
</div><div class='line not-covered'><span class='num'>1442</span>            $this-&gt;service-&gt;deleteEdge($id);
</div><div class='line not-covered'><span class='num'>1443</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1444</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1445</span>        {
</div><div class='line not-covered'><span class='num'>1446</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1447</span>        }
</div><div class='line not-executable'><span class='num'>1448</span>        
</div><div class='line not-covered'><span class='num'>1449</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1450</span>    }
</div><div class='line not-executable'><span class='num'>1451</span>
</div><div class='line not-executable'><span class='num'>1452</span>    public function getStatuses(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1453</span>    {
</div><div class='line not-executable'><span class='num'>1454</span>        try {
</div><div class='line not-covered'><span class='num'>1455</span>            $statuses = $this-&gt;service-&gt;getStatuses();
</div><div class='line not-covered'><span class='num'>1456</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1457</span>            return $resp;
</div><div class='line not-covered'><span class='num'>1458</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1459</span>        {
</div><div class='line not-covered'><span class='num'>1460</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1461</span>        }
</div><div class='line not-executable'><span class='num'>1462</span>        
</div><div class='line not-covered'><span class='num'>1463</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1464</span>    }
</div><div class='line not-executable'><span class='num'>1465</span>    
</div><div class='line not-executable'><span class='num'>1466</span>    public function getNodeStatus(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1467</span>    {
</div><div class='line not-executable'><span class='num'>1468</span>        try {
</div><div class='line not-covered'><span class='num'>1469</span>            $status = $this-&gt;service-&gt;getNodeStatus($req-&gt;data[&#039;id&#039;]);
</div><div class='line not-covered'><span class='num'>1470</span>            $data = $status-&gt;toArray();
</div><div class='line not-covered'><span class='num'>1471</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1472</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1473</span>        {
</div><div class='line not-covered'><span class='num'>1474</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1475</span>        }
</div><div class='line not-executable'><span class='num'>1476</span>        
</div><div class='line not-covered'><span class='num'>1477</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1478</span>    }
</div><div class='line not-executable'><span class='num'>1479</span>    
</div><div class='line not-executable'><span class='num'>1480</span>    public function setNodeStatus(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1481</span>    {
</div><div class='line not-executable'><span class='num'>1482</span>        try {
</div><div class='line not-covered'><span class='num'>1483</span>            $status = new NodeStatus($req-&gt;data[&#039;node_id&#039;], $req-&gt;data[&#039;status&#039;]);
</div><div class='line not-covered'><span class='num'>1484</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1485</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1486</span>        {
</div><div class='line not-covered'><span class='num'>1487</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1488</span>        }
</div><div class='line not-executable'><span class='num'>1489</span>        
</div><div class='line not-covered'><span class='num'>1490</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1491</span>    }
</div><div class='line not-executable'><span class='num'>1492</span>
</div><div class='line not-executable'><span class='num'>1493</span>    public function getLogs(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1494</span>    {
</div><div class='line not-executable'><span class='num'>1495</span>        try {
</div><div class='line not-covered'><span class='num'>1496</span>            $logs = $this-&gt;service-&gt;getLogs($req-&gt;getParam(&#039;limit&#039;));
</div><div class='line not-covered'><span class='num'>1497</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1498</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1499</span>        {
</div><div class='line not-covered'><span class='num'>1500</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1501</span>        }
</div><div class='line not-executable'><span class='num'>1502</span>        
</div><div class='line not-covered'><span class='num'>1503</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1504</span>    }
</div><div class='line not-executable'><span class='num'>1505</span>}
</div><div class='line not-executable'><span class='num'>1506</span>
</div><div class='line not-executable'><span class='num'>1507</span>final class RequestRouter
</div><div class='line not-executable'><span class='num'>1508</span>{
</div><div class='line not-executable'><span class='num'>1509</span>    private $routes = [
</div><div class='line not-executable'><span class='num'>1510</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getGraph&#039;, &#039;class_method&#039; =&gt; &#039;getGraph&#039;],
</div><div class='line not-executable'><span class='num'>1511</span>        
</div><div class='line not-executable'><span class='num'>1512</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getNode&#039;, &#039;class_method&#039; =&gt; &#039;getNode&#039;],
</div><div class='line not-executable'><span class='num'>1513</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getNodes&#039;, &#039;class_method&#039; =&gt; &#039;getNodes&#039;],
</div><div class='line not-executable'><span class='num'>1514</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/insertNode&#039;, &#039;class_method&#039; =&gt; &#039;insertNode&#039;],
</div><div class='line not-executable'><span class='num'>1515</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/updateNode&#039;, &#039;class_method&#039; =&gt; &#039;updateNode&#039;],
</div><div class='line not-executable'><span class='num'>1516</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/deleteNode&#039;, &#039;class_method&#039; =&gt; &#039;deleteNode&#039;],
</div><div class='line not-executable'><span class='num'>1517</span>
</div><div class='line not-executable'><span class='num'>1518</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getEdge&#039;, &#039;class_method&#039; =&gt; &#039;getEdge&#039;],
</div><div class='line not-executable'><span class='num'>1519</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getEdges&#039;, &#039;class_method&#039; =&gt; &#039;getEdges&#039;],
</div><div class='line not-executable'><span class='num'>1520</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/insertEdge&#039;, &#039;class_method&#039; =&gt; &#039;insertEdge&#039;],
</div><div class='line not-executable'><span class='num'>1521</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/updateEdge&#039;, &#039;class_method&#039; =&gt; &#039;updateEdge&#039;],
</div><div class='line not-executable'><span class='num'>1522</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/deleteEdge&#039;, &#039;class_method&#039; =&gt; &#039;deleteEdge&#039;],
</div><div class='line not-executable'><span class='num'>1523</span>
</div><div class='line not-executable'><span class='num'>1524</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getStatuses&#039;, &#039;class_method&#039; =&gt; &#039;getStatuses&#039;],
</div><div class='line not-executable'><span class='num'>1525</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getNodeStatus&#039;, &#039;class_method&#039; =&gt; &#039;getNodeStatus&#039;],
</div><div class='line not-executable'><span class='num'>1526</span>
</div><div class='line not-executable'><span class='num'>1527</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getLogs&#039;, &#039;class_method&#039; =&gt; &#039;getLogs&#039;],
</div><div class='line not-executable'><span class='num'>1528</span>
</div><div class='line not-executable'><span class='num'>1529</span>        ];
</div><div class='line not-executable'><span class='num'>1530</span>
</div><div class='line not-executable'><span class='num'>1531</span>    public GraphController $controller;
</div><div class='line not-executable'><span class='num'>1532</span>    
</div><div class='line not-executable'><span class='num'>1533</span>    public function __construct(GraphController $controller)
</div><div class='line not-executable'><span class='num'>1534</span>    {
</div><div class='line not-covered'><span class='num'>1535</span>        $this-&gt;controller = $controller;
</div><div class='line not-covered'><span class='num'>1536</span>    }
</div><div class='line not-executable'><span class='num'>1537</span>
</div><div class='line not-executable'><span class='num'>1538</span>    public function handle(): void
</div><div class='line not-executable'><span class='num'>1539</span>    {
</div><div class='line not-covered'><span class='num'>1540</span>        $method = $_SERVER[&#039;REQUEST_METHOD&#039;];
</div><div class='line not-executable'><span class='num'>1541</span>
</div><div class='line not-covered'><span class='num'>1542</span>        $scriptName = $_SERVER[&#039;SCRIPT_NAME&#039;];
</div><div class='line not-covered'><span class='num'>1543</span>        $requestUri = $_SERVER[&#039;REQUEST_URI&#039;];
</div><div class='line not-covered'><span class='num'>1544</span>        $requestUri = strtok($requestUri, &#039;?&#039;);
</div><div class='line not-executable'><span class='num'>1545</span>        
</div><div class='line not-covered'><span class='num'>1546</span>        $path = str_replace($scriptName, &#039;&#039;, $requestUri);
</div><div class='line not-executable'><span class='num'>1547</span>        
</div><div class='line not-covered'><span class='num'>1548</span>        $req = new Request();
</div><div class='line not-executable'><span class='num'>1549</span>
</div><div class='line not-covered'><span class='num'>1550</span>        foreach($this-&gt;routes as $route)
</div><div class='line not-executable'><span class='num'>1551</span>        {
</div><div class='line not-covered'><span class='num'>1552</span>            if ($route[&#039;method&#039;] == $method &amp;&amp; $route[&#039;path&#039;] == $path)
</div><div class='line not-executable'><span class='num'>1553</span>            {
</div><div class='line not-covered'><span class='num'>1554</span>                $method = $route[&#039;class_method&#039;];
</div><div class='line not-covered'><span class='num'>1555</span>                $resp = $this-&gt;controller-&gt;$method($req);
</div><div class='line not-covered'><span class='num'>1556</span>                print_r($resp);
</div><div class='line not-covered'><span class='num'>1557</span>                exit();
</div><div class='line not-executable'><span class='num'>1558</span>            }
</div><div class='line not-executable'><span class='num'>1559</span>        }
</div><div class='line not-covered'><span class='num'>1560</span>    }
</div><div class='line not-executable'><span class='num'>1561</span>}
</div><div class='line not-executable'><span class='num'>1562</span>
</div><div class='line not-executable'><span class='num'>1563</span>
</div></body></html><html><head><meta charset='UTF-8'><style>
body { font-family: monospace; font-size: 12px; background: #222; color: #ddd; margin: 0; }
.covered { background: #1a4d1a; }
.not-covered { background: #4d1a1a; }
.not-executable { background: #2a2a2a; color: #666; }
.line { padding: 2px 10px; white-space: pre; border-left: 3px solid transparent; }
.covered { border-left-color: #0f0; }
.not-covered { border-left-color: #f00; }
.num { color: #666; width: 50px; display: inline-block; text-align: right; margin-right: 10px; }
h2 { background: #333; padding: 10px; margin: 20px 0 0 0; position: sticky; top: 0; }
</style></head><body><h2>/home/tarcisio/projects/graph/tests.php - 75.86% (44/58)</h2><div class='line not-executable'><span class='num'>1</span>&lt;?php
</div><div class='line not-executable'><span class='num'>2</span>
</div><div class='line not-executable'><span class='num'>3</span>declare(strict_types=1);
</div><div class='line not-executable'><span class='num'>4</span>
</div><div class='line not-executable'><span class='num'>5</span>require_once __DIR__ . &#039;/graph.php&#039;;
</div><div class='line not-executable'><span class='num'>6</span>
</div><div class='line not-executable'><span class='num'>7</span>ini_set(&#039;xdebug.mode&#039;, &#039;1&#039;);
</div><div class='line not-executable'><span class='num'>8</span>xdebug_start_code_coverage(XDEBUG_CC_UNUSED | XDEBUG_CC_DEAD_CODE);
</div><div class='line not-executable'><span class='num'>9</span>
</div><div class='line not-executable'><span class='num'>10</span>function array_diff_recursive($array1, $array2) {
</div><div class='line covered'><span class='num'>11</span>    $diff = [];
</div><div class='line not-executable'><span class='num'>12</span>    
</div><div class='line covered'><span class='num'>13</span>    foreach ($array1 as $key =&gt; $value) {
</div><div class='line covered'><span class='num'>14</span>        if (!array_key_exists($key, $array2)) {
</div><div class='line not-covered'><span class='num'>15</span>            $diff[$key] = $value;
</div><div class='line covered'><span class='num'>16</span>        } elseif (is_array($value)) {
</div><div class='line covered'><span class='num'>17</span>            if (!is_array($array2[$key])) {
</div><div class='line not-covered'><span class='num'>18</span>                $diff[$key] = $value;
</div><div class='line not-executable'><span class='num'>19</span>            } else {
</div><div class='line covered'><span class='num'>20</span>                $recursiveDiff = array_diff_recursive($value, $array2[$key]);
</div><div class='line covered'><span class='num'>21</span>                if (count($recursiveDiff)) {
</div><div class='line not-covered'><span class='num'>22</span>                    $diff[$key] = $recursiveDiff;
</div><div class='line not-executable'><span class='num'>23</span>                }
</div><div class='line not-executable'><span class='num'>24</span>            }
</div><div class='line covered'><span class='num'>25</span>        } elseif ($value !== $array2[$key]) {
</div><div class='line not-covered'><span class='num'>26</span>            $diff[$key] = $value;
</div><div class='line not-executable'><span class='num'>27</span>        }
</div><div class='line not-executable'><span class='num'>28</span>    }
</div><div class='line not-executable'><span class='num'>29</span>    
</div><div class='line covered'><span class='num'>30</span>    return $diff;
</div><div class='line not-covered'><span class='num'>31</span>}
</div><div class='line not-executable'><span class='num'>32</span>
</div><div class='line not-executable'><span class='num'>33</span>function get_test_graph_controller()
</div><div class='line not-executable'><span class='num'>34</span>{
</div><div class='line covered'><span class='num'>35</span>    GraphContext::$user = new User(&#039;test_user&#039;, &#039;127.0.0.1&#039;, new Group(&#039;contributor&#039;));
</div><div class='line covered'><span class='num'>36</span>    $pdo = GraphDatabase::createConnection(&#039;sqlite::memory:&#039;);
</div><div class='line covered'><span class='num'>37</span>    $databaseLogger = new Logger(&#039;database.log&#039;);
</div><div class='line not-executable'><span class='num'>38</span>
</div><div class='line covered'><span class='num'>39</span>    $graphDb = new GraphDatabase($pdo, $databaseLogger);
</div><div class='line not-executable'><span class='num'>40</span>
</div><div class='line covered'><span class='num'>41</span>    $serviceLogger = new Logger(&#039;service.log&#039;);
</div><div class='line covered'><span class='num'>42</span>    $graphService = new GraphService($graphDb, $serviceLogger);
</div><div class='line not-executable'><span class='num'>43</span>
</div><div class='line covered'><span class='num'>44</span>    $controllerLogger = new Logger(&#039;controller.log&#039;);
</div><div class='line covered'><span class='num'>45</span>    $graphController = new GraphController($graphService, $controllerLogger);
</div><div class='line not-executable'><span class='num'>46</span>    
</div><div class='line covered'><span class='num'>47</span>    return $graphController;
</div><div class='line not-covered'><span class='num'>48</span>}
</div><div class='line not-executable'><span class='num'>49</span>
</div><div class='line not-executable'><span class='num'>50</span>function test_node_good_path()
</div><div class='line not-executable'><span class='num'>51</span>{
</div><div class='line covered'><span class='num'>52</span>    $graphController = get_test_graph_controller();
</div><div class='line covered'><span class='num'>53</span>    $insertNodeReq = new Request();
</div><div class='line covered'><span class='num'>54</span>    $insertNodeReq-&gt;data = [&#039;id&#039; =&gt; &#039;node1&#039;, &#039;label&#039; =&gt; &#039;node1&#039;, &#039;category&#039; =&gt; &#039;business&#039;, &#039;type&#039; =&gt; &#039;server&#039;, &#039;data&#039; =&gt; [&#039;info&#039; =&gt; &#039;first node&#039;]];
</div><div class='line covered'><span class='num'>55</span>    $resp = $graphController-&gt;insertNode($insertNodeReq);
</div><div class='line not-executable'><span class='num'>56</span>    
</div><div class='line covered'><span class='num'>57</span>    $expected = [
</div><div class='line not-executable'><span class='num'>58</span>        &#039;id&#039;       =&gt; &#039;node1&#039;,
</div><div class='line not-executable'><span class='num'>59</span>        &#039;label&#039;    =&gt; &#039;node1&#039;,
</div><div class='line not-executable'><span class='num'>60</span>        &#039;category&#039; =&gt; &#039;business&#039;,
</div><div class='line not-executable'><span class='num'>61</span>        &#039;type&#039; =&gt; &#039;server&#039;,
</div><div class='line not-executable'><span class='num'>62</span>        &#039;data&#039; =&gt; [
</div><div class='line not-executable'><span class='num'>63</span>                &#039;info&#039; =&gt; &#039;first node&#039;
</div><div class='line not-executable'><span class='num'>64</span>        ]
</div><div class='line not-executable'><span class='num'>65</span>    ];
</div><div class='line not-executable'><span class='num'>66</span>
</div><div class='line covered'><span class='num'>67</span>    if($resp-&gt;code != 201) {
</div><div class='line not-covered'><span class='num'>68</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>69</span>    }
</div><div class='line not-executable'><span class='num'>70</span>
</div><div class='line covered'><span class='num'>71</span>    if($resp-&gt;status != &#039;success&#039;) {
</div><div class='line not-covered'><span class='num'>72</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>73</span>    }
</div><div class='line not-executable'><span class='num'>74</span>
</div><div class='line covered'><span class='num'>75</span>    if ($resp-&gt;message != &#039;node inserted&#039;) {
</div><div class='line not-covered'><span class='num'>76</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>77</span>    }
</div><div class='line not-executable'><span class='num'>78</span>
</div><div class='line covered'><span class='num'>79</span>    $diff = array_diff_recursive($resp-&gt;data, $expected);
</div><div class='line covered'><span class='num'>80</span>    if (! empty($diff)) {
</div><div class='line not-covered'><span class='num'>81</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>82</span>    }
</div><div class='line not-executable'><span class='num'>83</span>
</div><div class='line covered'><span class='num'>84</span>    $_GET[&#039;id&#039;] = &#039;node1&#039;;
</div><div class='line covered'><span class='num'>85</span>    $req = new Request();
</div><div class='line covered'><span class='num'>86</span>    $resp = $graphController-&gt;getNode($req);
</div><div class='line not-executable'><span class='num'>87</span>
</div><div class='line covered'><span class='num'>88</span>    if ($resp-&gt;code != 200) {
</div><div class='line not-covered'><span class='num'>89</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>90</span>    }
</div><div class='line not-executable'><span class='num'>91</span>
</div><div class='line covered'><span class='num'>92</span>    if($resp-&gt;status != &#039;success&#039;) {
</div><div class='line not-covered'><span class='num'>93</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>94</span>    }
</div><div class='line not-executable'><span class='num'>95</span>
</div><div class='line covered'><span class='num'>96</span>    if ($resp-&gt;message != &#039;node found&#039;) {
</div><div class='line not-covered'><span class='num'>97</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>98</span>    }
</div><div class='line not-executable'><span class='num'>99</span>
</div><div class='line covered'><span class='num'>100</span>    $expected = [
</div><div class='line not-executable'><span class='num'>101</span>        &#039;info&#039;     =&gt; &#039;first node&#039;,
</div><div class='line not-executable'><span class='num'>102</span>        &#039;id&#039;       =&gt; &#039;node1&#039;,
</div><div class='line not-executable'><span class='num'>103</span>        &#039;label&#039;    =&gt; &#039;node1&#039;,
</div><div class='line not-executable'><span class='num'>104</span>        &#039;category&#039; =&gt; &#039;business&#039;,
</div><div class='line not-executable'><span class='num'>105</span>        &#039;type&#039;     =&gt; &#039;server&#039;,
</div><div class='line not-executable'><span class='num'>106</span>    ];
</div><div class='line not-executable'><span class='num'>107</span>
</div><div class='line covered'><span class='num'>108</span>    $diff = array_diff_recursive($resp-&gt;data[&#039;data&#039;], $expected);
</div><div class='line covered'><span class='num'>109</span>    if (! empty($diff)) {
</div><div class='line not-covered'><span class='num'>110</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>111</span>    }
</div><div class='line covered'><span class='num'>112</span>    echo &quot;fim&quot;;
</div><div class='line covered'><span class='num'>113</span>}
</div><div class='line not-executable'><span class='num'>114</span>
</div><div class='line not-executable'><span class='num'>115</span>function tests() {
</div><div class='line covered'><span class='num'>116</span>    test_node_good_path();
</div><div class='line covered'><span class='num'>117</span>    echo &quot;fim&quot;;
</div><div class='line covered'><span class='num'>118</span>}
</div><div class='line not-executable'><span class='num'>119</span>
</div><div class='line covered'><span class='num'>120</span>tests();
</div><div class='line not-executable'><span class='num'>121</span>
</div><div class='line covered'><span class='num'>122</span>$coverage = xdebug_get_code_coverage();
</div><div class='line not-executable'><span class='num'>123</span>xdebug_stop_code_coverage();
</div><div class='line not-executable'><span class='num'>124</span>
</div><div class='line not-executable'><span class='num'>125</span>// Salvar em arquivo
</div><div class='line not-executable'><span class='num'>126</span>file_put_contents(&#039;coverage.json&#039;, json_encode($coverage, JSON_PRETTY_PRINT));
</div><div class='line not-executable'><span class='num'>127</span>
</div><div class='line not-executable'><span class='num'>128</span>echo &#039;fim&#039;;</div><h2>/home/tarcisio/projects/graph/graph.php - 23.57% (148/628)</h2><div class='line not-executable'><span class='num'>1</span>&lt;?php
</div><div class='line not-executable'><span class='num'>2</span>
</div><div class='line not-executable'><span class='num'>3</span>declare(strict_types=1);
</div><div class='line not-executable'><span class='num'>4</span>
</div><div class='line not-executable'><span class='num'>5</span>final class User
</div><div class='line not-executable'><span class='num'>6</span>{
</div><div class='line not-executable'><span class='num'>7</span>    public string $id;
</div><div class='line not-executable'><span class='num'>8</span>    public ?string $ipAddress;
</div><div class='line not-executable'><span class='num'>9</span>    public Group $group;
</div><div class='line not-executable'><span class='num'>10</span>
</div><div class='line not-executable'><span class='num'>11</span>    public function __construct(string $id, ?string $ipAddress, Group $group)
</div><div class='line not-executable'><span class='num'>12</span>    {
</div><div class='line covered'><span class='num'>13</span>        $this-&gt;id = $id;
</div><div class='line covered'><span class='num'>14</span>        $this-&gt;ipAddress = $ipAddress;
</div><div class='line covered'><span class='num'>15</span>        $this-&gt;group = $group;
</div><div class='line covered'><span class='num'>16</span>    }
</div><div class='line not-executable'><span class='num'>17</span>
</div><div class='line not-executable'><span class='num'>18</span>    public function toArray(): array
</div><div class='line not-executable'><span class='num'>19</span>    {
</div><div class='line not-executable'><span class='num'>20</span>        return [
</div><div class='line not-covered'><span class='num'>21</span>            &#039;id&#039; =&gt; $this-&gt;id,
</div><div class='line not-executable'><span class='num'>22</span>            &#039;group&#039; =&gt; [
</div><div class='line not-covered'><span class='num'>23</span>                &#039;id&#039; =&gt; $this-&gt;group-&gt;id,
</div><div class='line not-executable'><span class='num'>24</span>            ],
</div><div class='line not-executable'><span class='num'>25</span>        ];
</div><div class='line not-covered'><span class='num'>26</span>    }
</div><div class='line not-executable'><span class='num'>27</span>}
</div><div class='line not-executable'><span class='num'>28</span>
</div><div class='line not-executable'><span class='num'>29</span>final class Group
</div><div class='line not-executable'><span class='num'>30</span>{
</div><div class='line not-executable'><span class='num'>31</span>    private const ALLOWED_GROUPS = [&#039;anonymous&#039;, &#039;consumer&#039;, &#039;contributor&#039;, &#039;admin&#039;];
</div><div class='line not-executable'><span class='num'>32</span>    
</div><div class='line not-executable'><span class='num'>33</span>    public string $id;
</div><div class='line not-executable'><span class='num'>34</span>    
</div><div class='line not-executable'><span class='num'>35</span>    public function __construct(string $id)
</div><div class='line not-executable'><span class='num'>36</span>    {
</div><div class='line covered'><span class='num'>37</span>        if (!in_array($id, self::ALLOWED_GROUPS, true)) {
</div><div class='line not-covered'><span class='num'>38</span>            throw new InvalidArgumentException(&quot;Invalid user group: {$id}&quot;);
</div><div class='line not-executable'><span class='num'>39</span>        }
</div><div class='line covered'><span class='num'>40</span>        $this-&gt;id  = $id;
</div><div class='line covered'><span class='num'>41</span>    }
</div><div class='line not-executable'><span class='num'>42</span>}
</div><div class='line not-executable'><span class='num'>43</span>
</div><div class='line not-executable'><span class='num'>44</span>final class Graph
</div><div class='line not-executable'><span class='num'>45</span>{
</div><div class='line not-executable'><span class='num'>46</span>    public array $nodes = [];
</div><div class='line not-executable'><span class='num'>47</span>    public array $edges = [];
</div><div class='line not-executable'><span class='num'>48</span>    public array $data  = [];
</div><div class='line not-executable'><span class='num'>49</span>    public array $layout = [];
</div><div class='line not-executable'><span class='num'>50</span>    public array $styles = [];
</div><div class='line not-executable'><span class='num'>51</span>
</div><div class='line not-executable'><span class='num'>52</span>    public function __construct(array $nodes, array $edges)
</div><div class='line not-executable'><span class='num'>53</span>    {
</div><div class='line not-covered'><span class='num'>54</span>        $this-&gt;nodes = $nodes;
</div><div class='line not-covered'><span class='num'>55</span>        $this-&gt;edges = $edges;
</div><div class='line not-covered'><span class='num'>56</span>    }
</div><div class='line not-executable'><span class='num'>57</span>
</div><div class='line not-executable'><span class='num'>58</span>    public function toArray(): array
</div><div class='line not-executable'><span class='num'>59</span>    {
</div><div class='line not-executable'><span class='num'>60</span>        return [
</div><div class='line not-covered'><span class='num'>61</span>            &#039;nodes&#039; =&gt; $this-&gt;nodes,
</div><div class='line not-covered'><span class='num'>62</span>            &#039;edges&#039; =&gt; $this-&gt;edges,
</div><div class='line not-covered'><span class='num'>63</span>            &#039;data&#039; =&gt; $this-&gt;data,
</div><div class='line not-covered'><span class='num'>64</span>            &#039;layout&#039; =&gt; $this-&gt;layout,
</div><div class='line not-covered'><span class='num'>65</span>            &#039;styles&#039; =&gt; $this-&gt;styles,
</div><div class='line not-executable'><span class='num'>66</span>        ];
</div><div class='line not-covered'><span class='num'>67</span>    }
</div><div class='line not-executable'><span class='num'>68</span>}
</div><div class='line not-executable'><span class='num'>69</span>
</div><div class='line not-executable'><span class='num'>70</span>final class Node
</div><div class='line not-executable'><span class='num'>71</span>{
</div><div class='line not-executable'><span class='num'>72</span>    private const ALLOWED_CATEGORIES  = [&#039;business&#039;, &#039;application&#039;, &#039;infrastructure&#039;];
</div><div class='line not-executable'><span class='num'>73</span>    private const ALLOWED_TYPES       = [&#039;server&#039;, &#039;database&#039;, &#039;application&#039;, &#039;network&#039;];
</div><div class='line not-executable'><span class='num'>74</span>    private const ID_VALIDATION_REGEX = &#039;/^[a-zA-Z0-9\-_]+$/&#039;;
</div><div class='line not-executable'><span class='num'>75</span>    private const LABEL_MAX_LENGTH    = 20;
</div><div class='line not-executable'><span class='num'>76</span>    
</div><div class='line not-executable'><span class='num'>77</span>    public string $id;
</div><div class='line not-executable'><span class='num'>78</span>    public string $label;
</div><div class='line not-executable'><span class='num'>79</span>    public string $category;
</div><div class='line not-executable'><span class='num'>80</span>    public string $type;
</div><div class='line not-executable'><span class='num'>81</span>
</div><div class='line not-executable'><span class='num'>82</span>    public array $data = [];
</div><div class='line not-executable'><span class='num'>83</span>
</div><div class='line not-executable'><span class='num'>84</span>    public function __construct(string $id, string $label, string $category, string $type, array $data)
</div><div class='line not-executable'><span class='num'>85</span>    {
</div><div class='line covered'><span class='num'>86</span>        $this-&gt;validate($id, $label, $category, $type);
</div><div class='line covered'><span class='num'>87</span>        $this-&gt;id       = $id;
</div><div class='line covered'><span class='num'>88</span>        $this-&gt;label    = $label;
</div><div class='line covered'><span class='num'>89</span>        $this-&gt;category = $category;
</div><div class='line covered'><span class='num'>90</span>        $this-&gt;type     = $type;
</div><div class='line covered'><span class='num'>91</span>        $this-&gt;data     = $data;
</div><div class='line covered'><span class='num'>92</span>    }
</div><div class='line not-executable'><span class='num'>93</span>
</div><div class='line not-executable'><span class='num'>94</span>    private function validate(string $id, string $label, string $category, string $type): void
</div><div class='line not-executable'><span class='num'>95</span>    {
</div><div class='line covered'><span class='num'>96</span>        if (!preg_match(self::ID_VALIDATION_REGEX, $id)) {
</div><div class='line not-covered'><span class='num'>97</span>            throw new InvalidArgumentException(&quot;Invalid node ID: {$id}&quot;);
</div><div class='line not-executable'><span class='num'>98</span>        }
</div><div class='line not-executable'><span class='num'>99</span>
</div><div class='line covered'><span class='num'>100</span>        if (strlen($label) &gt; self::LABEL_MAX_LENGTH) {
</div><div class='line not-covered'><span class='num'>101</span>            throw new InvalidArgumentException(&quot;Node label exceeds maximum length of &quot; . self::LABEL_MAX_LENGTH);
</div><div class='line not-executable'><span class='num'>102</span>        }
</div><div class='line not-executable'><span class='num'>103</span>
</div><div class='line covered'><span class='num'>104</span>        if (!in_array($category, self::ALLOWED_CATEGORIES, true)) {
</div><div class='line not-covered'><span class='num'>105</span>            throw new InvalidArgumentException(&quot;Invalid node category: {$category}&quot;);
</div><div class='line not-executable'><span class='num'>106</span>        }
</div><div class='line not-executable'><span class='num'>107</span>
</div><div class='line covered'><span class='num'>108</span>        if (!in_array($type, self::ALLOWED_TYPES, true)) {
</div><div class='line not-covered'><span class='num'>109</span>            throw new InvalidArgumentException(&quot;Invalid node type: {$type}&quot;);
</div><div class='line not-executable'><span class='num'>110</span>        }
</div><div class='line covered'><span class='num'>111</span>    }
</div><div class='line not-executable'><span class='num'>112</span>
</div><div class='line not-executable'><span class='num'>113</span>    public function toArray(): array
</div><div class='line not-executable'><span class='num'>114</span>    {
</div><div class='line not-executable'><span class='num'>115</span>        return [
</div><div class='line covered'><span class='num'>116</span>            &#039;id&#039;       =&gt; $this-&gt;id,
</div><div class='line covered'><span class='num'>117</span>            &#039;label&#039;    =&gt; $this-&gt;label,
</div><div class='line covered'><span class='num'>118</span>            &#039;category&#039; =&gt; $this-&gt;category,
</div><div class='line covered'><span class='num'>119</span>            &#039;type&#039;     =&gt; $this-&gt;type,
</div><div class='line covered'><span class='num'>120</span>            &#039;data&#039;     =&gt; $this-&gt;data
</div><div class='line not-executable'><span class='num'>121</span>        ];
</div><div class='line not-covered'><span class='num'>122</span>    }
</div><div class='line not-executable'><span class='num'>123</span>}
</div><div class='line not-executable'><span class='num'>124</span>
</div><div class='line not-executable'><span class='num'>125</span>final class NodeStatus
</div><div class='line not-executable'><span class='num'>126</span>{
</div><div class='line not-executable'><span class='num'>127</span>    private const ALLOWED_NODE_STATUSES = [&#039;unknown&#039;, &#039;healthy&#039;, &#039;unhealthy&#039;, &#039;maintenance&#039;];
</div><div class='line not-executable'><span class='num'>128</span>
</div><div class='line not-executable'><span class='num'>129</span>    public string $nodeId;
</div><div class='line not-executable'><span class='num'>130</span>    public string $status;
</div><div class='line not-executable'><span class='num'>131</span>
</div><div class='line not-executable'><span class='num'>132</span>    public function __construct(string $nodeId, string $status)
</div><div class='line not-executable'><span class='num'>133</span>    {
</div><div class='line not-covered'><span class='num'>134</span>        if (!in_array($status, self::ALLOWED_NODE_STATUSES, true)) {
</div><div class='line not-covered'><span class='num'>135</span>            throw new InvalidArgumentException(&quot;Invalid node status: {$status}&quot;);
</div><div class='line not-executable'><span class='num'>136</span>        }
</div><div class='line not-covered'><span class='num'>137</span>        $this-&gt;nodeId = $nodeId;
</div><div class='line not-covered'><span class='num'>138</span>        $this-&gt;status = $status;
</div><div class='line not-covered'><span class='num'>139</span>    }
</div><div class='line not-executable'><span class='num'>140</span>
</div><div class='line not-executable'><span class='num'>141</span>    public function toArray(): array
</div><div class='line not-executable'><span class='num'>142</span>    {
</div><div class='line not-executable'><span class='num'>143</span>        return [
</div><div class='line not-covered'><span class='num'>144</span>            &#039;node_id&#039; =&gt; $this-&gt;nodeId,
</div><div class='line not-covered'><span class='num'>145</span>            &#039;status&#039;  =&gt; $this-&gt;status,
</div><div class='line not-executable'><span class='num'>146</span>        ];
</div><div class='line not-covered'><span class='num'>147</span>    }
</div><div class='line not-executable'><span class='num'>148</span>}
</div><div class='line not-executable'><span class='num'>149</span>
</div><div class='line not-executable'><span class='num'>150</span>final class NodeStatuses
</div><div class='line not-executable'><span class='num'>151</span>{
</div><div class='line not-executable'><span class='num'>152</span>    public array $statuses = [];
</div><div class='line not-executable'><span class='num'>153</span>
</div><div class='line not-executable'><span class='num'>154</span>    public function addStatus(NodeStatus $status): void
</div><div class='line not-executable'><span class='num'>155</span>    {
</div><div class='line not-covered'><span class='num'>156</span>        $this-&gt;statuses[] = $status;
</div><div class='line not-covered'><span class='num'>157</span>    }
</div><div class='line not-executable'><span class='num'>158</span>}
</div><div class='line not-executable'><span class='num'>159</span>
</div><div class='line not-executable'><span class='num'>160</span>final class Nodes
</div><div class='line not-executable'><span class='num'>161</span>{
</div><div class='line not-executable'><span class='num'>162</span>    public array $nodes = [];
</div><div class='line not-executable'><span class='num'>163</span>
</div><div class='line not-executable'><span class='num'>164</span>    public function addNode(Node $node): void
</div><div class='line not-executable'><span class='num'>165</span>    {
</div><div class='line not-covered'><span class='num'>166</span>        $this-&gt;nodes[] = $node;
</div><div class='line not-covered'><span class='num'>167</span>    }
</div><div class='line not-executable'><span class='num'>168</span>}
</div><div class='line not-executable'><span class='num'>169</span>
</div><div class='line not-executable'><span class='num'>170</span>final class Edge
</div><div class='line not-executable'><span class='num'>171</span>{
</div><div class='line not-executable'><span class='num'>172</span>    public ?string $id;
</div><div class='line not-executable'><span class='num'>173</span>    public string $source;
</div><div class='line not-executable'><span class='num'>174</span>    public string $target;
</div><div class='line not-executable'><span class='num'>175</span>    public array $data;
</div><div class='line not-executable'><span class='num'>176</span>
</div><div class='line not-executable'><span class='num'>177</span>    public function __construct(?string $id = null, string $source, string $target, array $data = [])
</div><div class='line not-executable'><span class='num'>178</span>    {
</div><div class='line not-covered'><span class='num'>179</span>        $this-&gt;id     = $id;
</div><div class='line not-covered'><span class='num'>180</span>        $this-&gt;source = $source;
</div><div class='line not-covered'><span class='num'>181</span>        $this-&gt;target = $target;
</div><div class='line not-covered'><span class='num'>182</span>        $this-&gt;data   = $data;
</div><div class='line not-covered'><span class='num'>183</span>    }
</div><div class='line not-executable'><span class='num'>184</span>
</div><div class='line not-executable'><span class='num'>185</span>    public function toArray(): array
</div><div class='line not-executable'><span class='num'>186</span>    {
</div><div class='line not-executable'><span class='num'>187</span>        return [
</div><div class='line not-covered'><span class='num'>188</span>            &#039;id&#039;     =&gt; $this-&gt;id,
</div><div class='line not-covered'><span class='num'>189</span>            &#039;source&#039; =&gt; $this-&gt;source,
</div><div class='line not-covered'><span class='num'>190</span>            &#039;target&#039; =&gt; $this-&gt;target,
</div><div class='line not-covered'><span class='num'>191</span>            &#039;data&#039;   =&gt; $this-&gt;data
</div><div class='line not-executable'><span class='num'>192</span>        ];
</div><div class='line not-covered'><span class='num'>193</span>    }
</div><div class='line not-executable'><span class='num'>194</span>}
</div><div class='line not-executable'><span class='num'>195</span>
</div><div class='line not-executable'><span class='num'>196</span>final class Edges
</div><div class='line not-executable'><span class='num'>197</span>{
</div><div class='line not-executable'><span class='num'>198</span>    public array $edges = [];
</div><div class='line not-executable'><span class='num'>199</span>    public function addEdge(Edge $edge): void
</div><div class='line not-executable'><span class='num'>200</span>    {
</div><div class='line not-covered'><span class='num'>201</span>        $this-&gt;edges[] = $edge;
</div><div class='line not-covered'><span class='num'>202</span>    }
</div><div class='line not-executable'><span class='num'>203</span>}
</div><div class='line not-executable'><span class='num'>204</span>
</div><div class='line not-executable'><span class='num'>205</span>final class AuditLog
</div><div class='line not-executable'><span class='num'>206</span>{
</div><div class='line not-executable'><span class='num'>207</span>    public string $entityType;
</div><div class='line not-executable'><span class='num'>208</span>    public string $entityId;
</div><div class='line not-executable'><span class='num'>209</span>    public string $action;
</div><div class='line not-executable'><span class='num'>210</span>    public ?array $oldData;
</div><div class='line not-executable'><span class='num'>211</span>    public ?array $newData;
</div><div class='line not-executable'><span class='num'>212</span>    public string $userId;
</div><div class='line not-executable'><span class='num'>213</span>    public string $ipAddress;
</div><div class='line not-executable'><span class='num'>214</span>    public string $createdAt;
</div><div class='line not-executable'><span class='num'>215</span>
</div><div class='line not-executable'><span class='num'>216</span>    public function __construct(string $entityType, string $entityId, string $action, ?array $oldData = null, ?array $newData = null)
</div><div class='line not-executable'><span class='num'>217</span>    {
</div><div class='line covered'><span class='num'>218</span>        $this-&gt;entityType = $entityType;
</div><div class='line covered'><span class='num'>219</span>        $this-&gt;entityId   = $entityId;
</div><div class='line covered'><span class='num'>220</span>        $this-&gt;action     = $action;
</div><div class='line covered'><span class='num'>221</span>        $this-&gt;oldData    = $oldData;
</div><div class='line covered'><span class='num'>222</span>        $this-&gt;newData    = $newData;
</div><div class='line covered'><span class='num'>223</span>    }
</div><div class='line not-executable'><span class='num'>224</span>}
</div><div class='line not-executable'><span class='num'>225</span>
</div><div class='line not-executable'><span class='num'>226</span>final class AuditLogs
</div><div class='line not-executable'><span class='num'>227</span>{
</div><div class='line not-executable'><span class='num'>228</span>    public array $logs = [];
</div><div class='line not-executable'><span class='num'>229</span>    public function addLog(AuditLog $log): void
</div><div class='line not-executable'><span class='num'>230</span>    {
</div><div class='line not-covered'><span class='num'>231</span>        $this-&gt;logs[] = $log;
</div><div class='line not-covered'><span class='num'>232</span>    }
</div><div class='line not-executable'><span class='num'>233</span>}
</div><div class='line not-executable'><span class='num'>234</span>
</div><div class='line not-executable'><span class='num'>235</span>final class GraphContext
</div><div class='line not-executable'><span class='num'>236</span>{
</div><div class='line not-executable'><span class='num'>237</span>    public static User $user;
</div><div class='line not-executable'><span class='num'>238</span>}
</div><div class='line not-executable'><span class='num'>239</span>
</div><div class='line not-executable'><span class='num'>240</span>interface LoggerInterface
</div><div class='line not-executable'><span class='num'>241</span>{
</div><div class='line not-executable'><span class='num'>242</span>    public function info(string $message, array $data = []): void;
</div><div class='line not-executable'><span class='num'>243</span>    public function debug(string $message, array $data = []): void;
</div><div class='line not-executable'><span class='num'>244</span>    public function error(string $message, array $data = []): void;
</div><div class='line not-executable'><span class='num'>245</span>}
</div><div class='line not-executable'><span class='num'>246</span>
</div><div class='line not-executable'><span class='num'>247</span>final class Logger implements LoggerInterface
</div><div class='line not-executable'><span class='num'>248</span>{
</div><div class='line not-executable'><span class='num'>249</span>    private string $fileName;
</div><div class='line not-executable'><span class='num'>250</span>    private $fd;
</div><div class='line not-executable'><span class='num'>251</span>
</div><div class='line not-executable'><span class='num'>252</span>    public function __construct($file_name)
</div><div class='line not-executable'><span class='num'>253</span>    {
</div><div class='line covered'><span class='num'>254</span>        $this-&gt;fileName = $file_name;
</div><div class='line covered'><span class='num'>255</span>        $this-&gt;fd = fopen($this-&gt;fileName, &#039;a&#039;);
</div><div class='line covered'><span class='num'>256</span>    }
</div><div class='line not-executable'><span class='num'>257</span>
</div><div class='line not-executable'><span class='num'>258</span>    public function info(string $message, array $data = []): void
</div><div class='line not-executable'><span class='num'>259</span>    {
</div><div class='line covered'><span class='num'>260</span>        $this-&gt;log(&#039;INFO&#039;, $message, $data);
</div><div class='line covered'><span class='num'>261</span>    }
</div><div class='line not-executable'><span class='num'>262</span>
</div><div class='line not-executable'><span class='num'>263</span>    public function debug(string $message, array $data = []): void
</div><div class='line not-executable'><span class='num'>264</span>    {
</div><div class='line covered'><span class='num'>265</span>        $this-&gt;log(&#039;DEBUG&#039;, $message, $data);
</div><div class='line covered'><span class='num'>266</span>    }
</div><div class='line not-executable'><span class='num'>267</span>
</div><div class='line not-executable'><span class='num'>268</span>    public function error(string $message, array $data = []): void
</div><div class='line not-executable'><span class='num'>269</span>    {
</div><div class='line not-covered'><span class='num'>270</span>        $this-&gt;log(&#039;ERROR&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>271</span>    }
</div><div class='line not-executable'><span class='num'>272</span>
</div><div class='line not-executable'><span class='num'>273</span>    private function log(string $type, $message, $data = [])
</div><div class='line not-executable'><span class='num'>274</span>    {
</div><div class='line covered'><span class='num'>275</span>        $trace = debug_backtrace(DEBUG_BACKTRACE_PROVIDE_OBJECT, 3);
</div><div class='line covered'><span class='num'>276</span>        $method = &quot;{$trace[2][&#039;class&#039;]}::{$trace[2][&#039;function&#039;]}&quot;;
</div><div class='line covered'><span class='num'>277</span>        $data = json_encode($data);
</div><div class='line covered'><span class='num'>278</span>        $message = &quot;[{$type}] {$method}: $message ($data)\n&quot;;
</div><div class='line covered'><span class='num'>279</span>        fwrite($this-&gt;fd, $message);
</div><div class='line covered'><span class='num'>280</span>    }
</div><div class='line not-executable'><span class='num'>281</span>}
</div><div class='line not-executable'><span class='num'>282</span>
</div><div class='line not-executable'><span class='num'>283</span>interface GraphDatabaseInterface
</div><div class='line not-executable'><span class='num'>284</span>{
</div><div class='line not-executable'><span class='num'>285</span>    public function getUser(string $id): ?array;
</div><div class='line not-executable'><span class='num'>286</span>    public function insertUser(string $id, string $group): void;
</div><div class='line not-executable'><span class='num'>287</span>    public function updateUser(string $id, string $group): void;
</div><div class='line not-executable'><span class='num'>288</span>
</div><div class='line not-executable'><span class='num'>289</span>    public function getNode(string $id): ?array;
</div><div class='line not-executable'><span class='num'>290</span>    public function getNodes(): array;
</div><div class='line not-executable'><span class='num'>291</span>    public function insertNode(string $id, string $label, string $category, string $type, array $data = []): void;
</div><div class='line not-executable'><span class='num'>292</span>    public function updateNode(string $id, string $label, string $category, string $type, array $data = []): void;
</div><div class='line not-executable'><span class='num'>293</span>    public function deleteNode(string $id): void;
</div><div class='line not-executable'><span class='num'>294</span>
</div><div class='line not-executable'><span class='num'>295</span>    public function getEdge(string $source, string $target): ?array;
</div><div class='line not-executable'><span class='num'>296</span>    public function getEdgeById(string $id): ?array;
</div><div class='line not-executable'><span class='num'>297</span>    public function getEdges(): array;
</div><div class='line not-executable'><span class='num'>298</span>    public function insertEdge(string $id, string $source, string $target, array $data = []): void;
</div><div class='line not-executable'><span class='num'>299</span>    public function updateEdge(string $id, string $source, string $target, array $data = []): void;
</div><div class='line not-executable'><span class='num'>300</span>    public function deleteEdge(string $id): void;
</div><div class='line not-executable'><span class='num'>301</span>
</div><div class='line not-executable'><span class='num'>302</span>    public function getStatuses(): array;
</div><div class='line not-executable'><span class='num'>303</span>    public function getNodeStatus(string $id): ?string;
</div><div class='line not-executable'><span class='num'>304</span>    public function setNodeStatus(string $id, string $status): void;
</div><div class='line not-executable'><span class='num'>305</span>
</div><div class='line not-executable'><span class='num'>306</span>    public function getLogs($limit): array;
</div><div class='line not-executable'><span class='num'>307</span>    public function insertAuditLog(
</div><div class='line not-executable'><span class='num'>308</span>        string $entity_type, 
</div><div class='line not-executable'><span class='num'>309</span>        string $entity_id, 
</div><div class='line not-executable'><span class='num'>310</span>        string $action, 
</div><div class='line not-executable'><span class='num'>311</span>        ?array $old_data = null, 
</div><div class='line not-executable'><span class='num'>312</span>        ?array $new_data = null,
</div><div class='line not-executable'><span class='num'>313</span>        string $user_id,
</div><div class='line not-executable'><span class='num'>314</span>        string $ip_address): bool;
</div><div class='line not-executable'><span class='num'>315</span>}
</div><div class='line not-executable'><span class='num'>316</span>
</div><div class='line not-executable'><span class='num'>317</span>final class DatabaseException extends RuntimeException
</div><div class='line not-executable'><span class='num'>318</span>{
</div><div class='line not-executable'><span class='num'>319</span>    private ?string $query;
</div><div class='line not-executable'><span class='num'>320</span>    private ?array $params;
</div><div class='line not-executable'><span class='num'>321</span>
</div><div class='line not-executable'><span class='num'>322</span>    
</div><div class='line not-executable'><span class='num'>323</span>    public function __construct(string $message = &quot;&quot;,  int $code = 0, ?Throwable $previous = null, ?string $query = null, ?array $params) {
</div><div class='line not-covered'><span class='num'>324</span>        parent::__construct($message, $code, $previous);
</div><div class='line not-covered'><span class='num'>325</span>        $this-&gt;query = $query;
</div><div class='line not-covered'><span class='num'>326</span>        $this-&gt;params = $params;
</div><div class='line not-covered'><span class='num'>327</span>    }
</div><div class='line not-executable'><span class='num'>328</span>}
</div><div class='line not-executable'><span class='num'>329</span>
</div><div class='line not-executable'><span class='num'>330</span>final class GraphDatabase implements GraphDatabaseInterface
</div><div class='line not-executable'><span class='num'>331</span>{
</div><div class='line not-executable'><span class='num'>332</span>    private PDO $pdo;
</div><div class='line not-executable'><span class='num'>333</span>    private Logger $logger;
</div><div class='line not-executable'><span class='num'>334</span>
</div><div class='line not-executable'><span class='num'>335</span>    public function __construct(PDO $pdo, Logger $logger)
</div><div class='line not-executable'><span class='num'>336</span>    {
</div><div class='line covered'><span class='num'>337</span>        $this-&gt;pdo = $pdo;
</div><div class='line covered'><span class='num'>338</span>        $this-&gt;logger = $logger;
</div><div class='line covered'><span class='num'>339</span>        $this-&gt;initSchema();
</div><div class='line covered'><span class='num'>340</span>    }
</div><div class='line not-executable'><span class='num'>341</span>
</div><div class='line not-executable'><span class='num'>342</span>    public function getUser(string $id): ?array
</div><div class='line not-executable'><span class='num'>343</span>    {
</div><div class='line not-covered'><span class='num'>344</span>        $this-&gt;logger-&gt;debug(&quot;getting user id: &#039;{$id}&#039;&quot;);
</div><div class='line not-executable'><span class='num'>345</span>        try {
</div><div class='line not-covered'><span class='num'>346</span>            $sql = &quot;SELECT * FROM users WHERE id = :id&quot;;
</div><div class='line not-covered'><span class='num'>347</span>            $params = [&#039;:id&#039; =&gt; $id];
</div><div class='line not-covered'><span class='num'>348</span>            $stmt = $this-&gt;pdo-&gt;prepare($sql);
</div><div class='line not-covered'><span class='num'>349</span>            $stmt-&gt;execute($params);
</div><div class='line not-covered'><span class='num'>350</span>            $row = $stmt-&gt;fetch();
</div><div class='line not-executable'><span class='num'>351</span>
</div><div class='line not-covered'><span class='num'>352</span>            if ($row) {
</div><div class='line not-covered'><span class='num'>353</span>                return $row;
</div><div class='line not-executable'><span class='num'>354</span>            }
</div><div class='line not-covered'><span class='num'>355</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>356</span>            $e = new DatabaseException(
</div><div class='line not-covered'><span class='num'>357</span>                &quot;GraphDatabase Exception while trying to get user data. ID: {$id}&quot;,
</div><div class='line not-covered'><span class='num'>358</span>                0,
</div><div class='line not-executable'><span class='num'>359</span>                $e,
</div><div class='line not-executable'><span class='num'>360</span>                $sql,
</div><div class='line not-executable'><span class='num'>361</span>                $params
</div><div class='line not-executable'><span class='num'>362</span>            );
</div><div class='line not-executable'><span class='num'>363</span>        }
</div><div class='line not-covered'><span class='num'>364</span>        return null;
</div><div class='line not-covered'><span class='num'>365</span>    }
</div><div class='line not-executable'><span class='num'>366</span>
</div><div class='line not-executable'><span class='num'>367</span>    public function insertUser(string $id, string $group): void
</div><div class='line not-executable'><span class='num'>368</span>    {
</div><div class='line not-executable'><span class='num'>369</span>        try {
</div><div class='line not-covered'><span class='num'>370</span>            $sql = &quot;
</div><div class='line not-executable'><span class='num'>371</span>                INSERT OR IGNORE INTO users 
</div><div class='line not-executable'><span class='num'>372</span>                (id, user_group)
</div><div class='line not-executable'><span class='num'>373</span>                VALUES (:id, :group)&quot;;
</div><div class='line not-executable'><span class='num'>374</span>            
</div><div class='line not-covered'><span class='num'>375</span>            $params = [
</div><div class='line not-covered'><span class='num'>376</span>                &#039;:id&#039;       =&gt; $id,
</div><div class='line not-covered'><span class='num'>377</span>                &#039;:group&#039;    =&gt; $group
</div><div class='line not-executable'><span class='num'>378</span>            ];
</div><div class='line not-executable'><span class='num'>379</span>
</div><div class='line not-covered'><span class='num'>380</span>            $stmt = $this-&gt;pdo-&gt;prepare($sql);
</div><div class='line not-covered'><span class='num'>381</span>            $stmt-&gt;execute($params);
</div><div class='line not-covered'><span class='num'>382</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>383</span>            $e = new DatabaseException(
</div><div class='line not-covered'><span class='num'>384</span>                &quot;GraphDatabase Exception while trying to insert new user. ID: {$id}&quot;,
</div><div class='line not-covered'><span class='num'>385</span>                0,
</div><div class='line not-executable'><span class='num'>386</span>                $e,
</div><div class='line not-executable'><span class='num'>387</span>                $sql,
</div><div class='line not-executable'><span class='num'>388</span>                $params
</div><div class='line not-executable'><span class='num'>389</span>            );
</div><div class='line not-executable'><span class='num'>390</span>        }
</div><div class='line not-covered'><span class='num'>391</span>    }
</div><div class='line not-executable'><span class='num'>392</span>
</div><div class='line not-executable'><span class='num'>393</span>    public function updateUser(string $id, string $group): void
</div><div class='line not-executable'><span class='num'>394</span>    {
</div><div class='line not-executable'><span class='num'>395</span>        try {
</div><div class='line not-covered'><span class='num'>396</span>            $sql = &quot;
</div><div class='line not-executable'><span class='num'>397</span>                UPDATE users
</div><div class='line not-executable'><span class='num'>398</span>                SET    user_group = :group
</div><div class='line not-executable'><span class='num'>399</span>                WHERE  id = :id
</div><div class='line not-executable'><span class='num'>400</span>            &quot;;
</div><div class='line not-executable'><span class='num'>401</span>
</div><div class='line not-covered'><span class='num'>402</span>            $params = [
</div><div class='line not-covered'><span class='num'>403</span>                &#039;:id&#039;       =&gt; $id,
</div><div class='line not-covered'><span class='num'>404</span>                &#039;:group&#039;    =&gt; $group
</div><div class='line not-executable'><span class='num'>405</span>            ];
</div><div class='line not-executable'><span class='num'>406</span>
</div><div class='line not-covered'><span class='num'>407</span>            $stmt = $this-&gt;pdo-&gt;prepare($sql);
</div><div class='line not-executable'><span class='num'>408</span>            
</div><div class='line not-covered'><span class='num'>409</span>            $stmt-&gt;execute($params);
</div><div class='line not-executable'><span class='num'>410</span>
</div><div class='line not-covered'><span class='num'>411</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>412</span>            $e = new DatabaseException(
</div><div class='line not-covered'><span class='num'>413</span>                &quot;GraphDatabase Exception while trying to update user. ID: {$id}&quot;,
</div><div class='line not-covered'><span class='num'>414</span>                0,
</div><div class='line not-executable'><span class='num'>415</span>                $e,
</div><div class='line not-executable'><span class='num'>416</span>                $sql,
</div><div class='line not-executable'><span class='num'>417</span>                $params
</div><div class='line not-executable'><span class='num'>418</span>            );
</div><div class='line not-executable'><span class='num'>419</span>        }
</div><div class='line not-covered'><span class='num'>420</span>    }
</div><div class='line not-executable'><span class='num'>421</span>
</div><div class='line not-executable'><span class='num'>422</span>    public function getNode(string $id): ?array
</div><div class='line not-executable'><span class='num'>423</span>    {
</div><div class='line not-executable'><span class='num'>424</span>        $this-&gt;logger-&gt;debug(&quot;fetching node &#039;{$id}&#039;&quot;);
</div><div class='line covered'><span class='num'>425</span>
</div><div class='line covered'><span class='num'>426</span>        try {
</div><div class='line covered'><span class='num'>427</span>            $sql = &quot;SELECT * FROM nodes WHERE id = :id&quot;;
</div><div class='line not-executable'><span class='num'>428</span>            $params = [&#039;:id&#039; =&gt; $id];
</div><div class='line covered'><span class='num'>429</span>            $stmt = $this-&gt;pdo-&gt;prepare($sql);
</div><div class='line covered'><span class='num'>430</span>            $stmt-&gt;execute($params);
</div><div class='line not-executable'><span class='num'>431</span>            $row = $stmt-&gt;fetch();
</div><div class='line not-covered'><span class='num'>432</span>
</div><div class='line not-covered'><span class='num'>433</span>            if ($row) {
</div><div class='line not-executable'><span class='num'>434</span>                return $row;
</div><div class='line not-covered'><span class='num'>435</span>            }
</div><div class='line not-covered'><span class='num'>436</span>        } catch (PDOException $e) {
</div><div class='line not-executable'><span class='num'>437</span>            $this-&gt;logger-&gt;error(&quot;exception with node id &#039;{$id}&#039;&quot;);
</div><div class='line not-executable'><span class='num'>438</span>            throw new DatabaseException(&quot;could not get node data with id &#039;{$id}&#039;&quot;, 0, $e, $sql, $params);
</div><div class='line not-executable'><span class='num'>439</span>        }
</div><div class='line not-executable'><span class='num'>440</span>        return null;
</div><div class='line not-covered'><span class='num'>441</span>    }
</div><div class='line not-covered'><span class='num'>442</span>
</div><div class='line not-covered'><span class='num'>443</span>    public function getNodes(): array
</div><div class='line not-covered'><span class='num'>444</span>    {
</div><div class='line not-covered'><span class='num'>445</span>        try {
</div><div class='line not-covered'><span class='num'>446</span>            $stmt = $this-&gt;pdo-&gt;query(&quot;SELECT * FROM nodes&quot;);
</div><div class='line not-executable'><span class='num'>447</span>            $rows = $stmt-&gt;fetchAll();
</div><div class='line not-covered'><span class='num'>448</span>            return $rows;
</div><div class='line not-executable'><span class='num'>449</span>        } catch (PDOException $e) {
</div><div class='line not-executable'><span class='num'>450</span>            error_log(&quot;GraphDatabase fetch all nodes failed: &quot; . $e-&gt;getMessage());
</div><div class='line not-executable'><span class='num'>451</span>            return [];
</div><div class='line not-executable'><span class='num'>452</span>        }
</div><div class='line covered'><span class='num'>453</span>    }
</div><div class='line not-executable'><span class='num'>454</span>
</div><div class='line not-executable'><span class='num'>455</span>    public function insertNode(string $id, string $label, string $category, string $type, array $data = []): void
</div><div class='line not-executable'><span class='num'>456</span>    {
</div><div class='line covered'><span class='num'>457</span>        try {
</div><div class='line covered'><span class='num'>458</span>            $sql = &quot;
</div><div class='line covered'><span class='num'>459</span>                INSERT OR IGNORE INTO nodes 
</div><div class='line covered'><span class='num'>460</span>                (id, label, category, type, data) 
</div><div class='line covered'><span class='num'>461</span>                VALUES (:id, :label, :category, :type, :data)&quot;;
</div><div class='line covered'><span class='num'>462</span>            $stmt             = $this-&gt;pdo-&gt;prepare($sql);
</div><div class='line covered'><span class='num'>463</span>            $data[&#039;id&#039;]       = $id;
</div><div class='line covered'><span class='num'>464</span>            $data[&#039;label&#039;]    = $label;
</div><div class='line covered'><span class='num'>465</span>            $data[&#039;category&#039;] = $category;
</div><div class='line covered'><span class='num'>466</span>            $data[&#039;type&#039;]     = $type;
</div><div class='line covered'><span class='num'>467</span>            $stmt-&gt;execute([
</div><div class='line not-executable'><span class='num'>468</span>                &#039;:id&#039;       =&gt; $id,
</div><div class='line not-covered'><span class='num'>469</span>                &#039;:label&#039;    =&gt; $label,
</div><div class='line not-executable'><span class='num'>470</span>                &#039;:category&#039; =&gt; $category,
</div><div class='line not-executable'><span class='num'>471</span>                &#039;:type&#039;     =&gt; $type,
</div><div class='line covered'><span class='num'>472</span>                &#039;:data&#039;     =&gt; json_encode($data, JSON_UNESCAPED_UNICODE)
</div><div class='line not-executable'><span class='num'>473</span>            ]);
</div><div class='line not-executable'><span class='num'>474</span>        } catch (PDOException $e) {
</div><div class='line not-executable'><span class='num'>475</span>            // TODO
</div><div class='line not-executable'><span class='num'>476</span>        }
</div><div class='line not-covered'><span class='num'>477</span>    }
</div><div class='line not-executable'><span class='num'>478</span>
</div><div class='line not-executable'><span class='num'>479</span>    public function updateNode(string $id, string $label, string $category, string $type, array $data = []): void
</div><div class='line not-executable'><span class='num'>480</span>    {
</div><div class='line not-executable'><span class='num'>481</span>        try {
</div><div class='line not-executable'><span class='num'>482</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-executable'><span class='num'>483</span>                UPDATE nodes
</div><div class='line not-covered'><span class='num'>484</span>                SET    label = :label, 
</div><div class='line not-covered'><span class='num'>485</span>                       category = :category, 
</div><div class='line not-covered'><span class='num'>486</span>                       type = :type, 
</div><div class='line not-covered'><span class='num'>487</span>                       data = :data
</div><div class='line not-executable'><span class='num'>488</span>                WHERE  id = :id&quot;);
</div><div class='line not-covered'><span class='num'>489</span>            $data[&#039;id&#039;]       = $id;
</div><div class='line not-covered'><span class='num'>490</span>            $data[&#039;label&#039;]    = $label;
</div><div class='line not-covered'><span class='num'>491</span>            $data[&#039;category&#039;] = $category;
</div><div class='line not-covered'><span class='num'>492</span>            $data[&#039;type&#039;]     = $type;
</div><div class='line not-covered'><span class='num'>493</span>
</div><div class='line not-covered'><span class='num'>494</span>            $stmt-&gt;execute([
</div><div class='line not-executable'><span class='num'>495</span>                &#039;:id&#039;       =&gt; $id,
</div><div class='line not-covered'><span class='num'>496</span>                &#039;:label&#039;    =&gt; $label,
</div><div class='line not-executable'><span class='num'>497</span>                &#039;:category&#039; =&gt; $category,
</div><div class='line not-executable'><span class='num'>498</span>                &#039;:type&#039;     =&gt; $type,
</div><div class='line not-covered'><span class='num'>499</span>                &#039;:data&#039;     =&gt; json_encode($data, JSON_UNESCAPED_UNICODE)
</div><div class='line not-executable'><span class='num'>500</span>            ]);
</div><div class='line not-executable'><span class='num'>501</span>        } catch (PDOException $e) {
</div><div class='line not-executable'><span class='num'>502</span>            // TODO
</div><div class='line not-executable'><span class='num'>503</span>        }
</div><div class='line not-covered'><span class='num'>504</span>    }
</div><div class='line not-covered'><span class='num'>505</span>
</div><div class='line not-covered'><span class='num'>506</span>    public function deleteNode(string $id): void
</div><div class='line not-executable'><span class='num'>507</span>    {
</div><div class='line not-executable'><span class='num'>508</span>        try {
</div><div class='line not-covered'><span class='num'>509</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;DELETE FROM nodes WHERE id = :id&quot;);
</div><div class='line not-executable'><span class='num'>510</span>            $stmt-&gt;execute([&#039;:id&#039; =&gt; $id]);
</div><div class='line not-executable'><span class='num'>511</span>        } catch (PDOException $e) {
</div><div class='line not-executable'><span class='num'>512</span>            // TODO
</div><div class='line not-executable'><span class='num'>513</span>        }
</div><div class='line not-covered'><span class='num'>514</span>    }
</div><div class='line not-executable'><span class='num'>515</span>
</div><div class='line not-executable'><span class='num'>516</span>    public function getEdge(string $source, string $target): ?array
</div><div class='line not-executable'><span class='num'>517</span>    {
</div><div class='line not-covered'><span class='num'>518</span>        try {
</div><div class='line not-covered'><span class='num'>519</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-covered'><span class='num'>520</span>                SELECT * FROM edges
</div><div class='line not-executable'><span class='num'>521</span>                WHERE source = :source AND target = :target
</div><div class='line not-covered'><span class='num'>522</span>            &quot;);
</div><div class='line not-covered'><span class='num'>523</span>            $stmt-&gt;execute([
</div><div class='line not-covered'><span class='num'>524</span>                &#039;:source&#039; =&gt; $source,
</div><div class='line not-executable'><span class='num'>525</span>                &#039;:target&#039; =&gt; $target
</div><div class='line not-covered'><span class='num'>526</span>            ]);
</div><div class='line not-covered'><span class='num'>527</span>            $row = $stmt-&gt;fetch();
</div><div class='line not-executable'><span class='num'>528</span>            if ($row) {
</div><div class='line not-covered'><span class='num'>529</span>                return $row;
</div><div class='line not-covered'><span class='num'>530</span>            }
</div><div class='line not-executable'><span class='num'>531</span>        } catch (PDOException $e) {
</div><div class='line not-executable'><span class='num'>532</span>            error_log(&quot;GraphDatabase edge exists check failed: &quot; . $e-&gt;getMessage());
</div><div class='line not-executable'><span class='num'>533</span>        }
</div><div class='line not-executable'><span class='num'>534</span>        return null;
</div><div class='line not-covered'><span class='num'>535</span>    }
</div><div class='line not-executable'><span class='num'>536</span>
</div><div class='line not-executable'><span class='num'>537</span>    public function getEdgeById(string $id): ?array
</div><div class='line not-executable'><span class='num'>538</span>    {
</div><div class='line not-covered'><span class='num'>539</span>        try {
</div><div class='line not-covered'><span class='num'>540</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-executable'><span class='num'>541</span>                SELECT * FROM edges
</div><div class='line not-covered'><span class='num'>542</span>                WHERE id = :id
</div><div class='line not-covered'><span class='num'>543</span>            &quot;);
</div><div class='line not-covered'><span class='num'>544</span>            $stmt-&gt;execute([
</div><div class='line not-executable'><span class='num'>545</span>                &#039;:id&#039; =&gt; $id,
</div><div class='line not-covered'><span class='num'>546</span>            ]);
</div><div class='line not-covered'><span class='num'>547</span>            $row = $stmt-&gt;fetch();
</div><div class='line not-executable'><span class='num'>548</span>            if ($row) {
</div><div class='line not-covered'><span class='num'>549</span>                return $row;
</div><div class='line not-covered'><span class='num'>550</span>            }
</div><div class='line not-executable'><span class='num'>551</span>        } catch (PDOException $e) {
</div><div class='line not-executable'><span class='num'>552</span>            error_log(&quot;GraphDatabase edge exists check failed: &quot; . $e-&gt;getMessage());
</div><div class='line not-executable'><span class='num'>553</span>        }
</div><div class='line not-executable'><span class='num'>554</span>        return null;
</div><div class='line not-covered'><span class='num'>555</span>    }
</div><div class='line not-covered'><span class='num'>556</span>
</div><div class='line not-covered'><span class='num'>557</span>    public function getEdges(): array
</div><div class='line not-covered'><span class='num'>558</span>    {
</div><div class='line not-covered'><span class='num'>559</span>        try {
</div><div class='line not-covered'><span class='num'>560</span>            $stmt  = $this-&gt;pdo-&gt;query(&quot;SELECT * FROM edges&quot;);
</div><div class='line not-executable'><span class='num'>561</span>            $rows  = $stmt-&gt;fetchAll();
</div><div class='line not-covered'><span class='num'>562</span>            return $rows;
</div><div class='line not-executable'><span class='num'>563</span>        } catch (PDOException $e) {
</div><div class='line not-executable'><span class='num'>564</span>            error_log(&quot;GraphDatabase fetch all edges failed: &quot; . $e-&gt;getMessage());
</div><div class='line not-executable'><span class='num'>565</span>            return [];
</div><div class='line not-executable'><span class='num'>566</span>        }
</div><div class='line not-covered'><span class='num'>567</span>    }
</div><div class='line not-executable'><span class='num'>568</span>
</div><div class='line not-executable'><span class='num'>569</span>    public function insertEdge(string $id, string $source, string $target, array $data = []): void
</div><div class='line not-covered'><span class='num'>570</span>    {
</div><div class='line not-executable'><span class='num'>571</span>        // verify if the inverse edge exists
</div><div class='line not-executable'><span class='num'>572</span>        $r = $this-&gt;getEdge($target, $source);
</div><div class='line not-executable'><span class='num'>573</span>        
</div><div class='line not-covered'><span class='num'>574</span>        try {
</div><div class='line not-covered'><span class='num'>575</span>            $sql = &quot;
</div><div class='line not-covered'><span class='num'>576</span>                INSERT OR IGNORE INTO edges
</div><div class='line not-covered'><span class='num'>577</span>                (id, source, target, data)
</div><div class='line not-covered'><span class='num'>578</span>                VALUES (:id, :source, :target, :data)&quot;;
</div><div class='line not-covered'><span class='num'>579</span>            $stmt           = $this-&gt;pdo-&gt;prepare($sql);
</div><div class='line not-covered'><span class='num'>580</span>            $data[&#039;id&#039;]     = $id;
</div><div class='line not-covered'><span class='num'>581</span>            $data[&#039;source&#039;] = $source;
</div><div class='line not-covered'><span class='num'>582</span>            $data[&#039;target&#039;] = $target;
</div><div class='line not-executable'><span class='num'>583</span>            $stmt-&gt;execute([
</div><div class='line not-covered'><span class='num'>584</span>                &#039;:id&#039;     =&gt; $id,
</div><div class='line not-executable'><span class='num'>585</span>                &#039;:source&#039; =&gt; $source,
</div><div class='line not-executable'><span class='num'>586</span>                &#039;:target&#039; =&gt; $target,
</div><div class='line not-covered'><span class='num'>587</span>                &#039;:data&#039;   =&gt; json_encode($data, JSON_UNESCAPED_UNICODE)
</div><div class='line not-executable'><span class='num'>588</span>            ]);
</div><div class='line not-executable'><span class='num'>589</span>        } catch (PDOException $e) {
</div><div class='line not-executable'><span class='num'>590</span>            // TODO
</div><div class='line not-executable'><span class='num'>591</span>        }
</div><div class='line not-covered'><span class='num'>592</span>    }
</div><div class='line not-covered'><span class='num'>593</span>
</div><div class='line not-covered'><span class='num'>594</span>    public function updateEdge(string $id, string $source, string $target, array $data = []): void
</div><div class='line not-executable'><span class='num'>595</span>    {
</div><div class='line not-covered'><span class='num'>596</span>        try {
</div><div class='line not-executable'><span class='num'>597</span>            $data[&#039;id&#039;]     = $id;
</div><div class='line not-executable'><span class='num'>598</span>            $data[&#039;source&#039;] = $source;
</div><div class='line not-executable'><span class='num'>599</span>            $data[&#039;target&#039;] = $target;
</div><div class='line not-covered'><span class='num'>600</span>
</div><div class='line not-covered'><span class='num'>601</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-covered'><span class='num'>602</span>                UPDATE edges
</div><div class='line not-executable'><span class='num'>603</span>                SET data = :data
</div><div class='line not-covered'><span class='num'>604</span>                WHERE id = :id&quot;);
</div><div class='line not-executable'><span class='num'>605</span>            $stmt-&gt;execute([
</div><div class='line not-executable'><span class='num'>606</span>                &#039;:id&#039;   =&gt; $id,
</div><div class='line not-covered'><span class='num'>607</span>                &#039;:data&#039; =&gt; json_encode($data, JSON_UNESCAPED_UNICODE)
</div><div class='line not-executable'><span class='num'>608</span>            ]);
</div><div class='line not-executable'><span class='num'>609</span>        } catch (PDOException $e) {
</div><div class='line not-executable'><span class='num'>610</span>            // TODO
</div><div class='line not-executable'><span class='num'>611</span>        }
</div><div class='line not-covered'><span class='num'>612</span>    }
</div><div class='line not-covered'><span class='num'>613</span>
</div><div class='line not-covered'><span class='num'>614</span>    public function deleteEdge(string $id): void
</div><div class='line not-executable'><span class='num'>615</span>    {
</div><div class='line not-executable'><span class='num'>616</span>        try {
</div><div class='line not-covered'><span class='num'>617</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;DELETE FROM edges WHERE id = :id&quot;);
</div><div class='line not-executable'><span class='num'>618</span>            $stmt-&gt;execute([&#039;:id&#039; =&gt; $id]);
</div><div class='line not-executable'><span class='num'>619</span>        } catch (PDOException $e) {
</div><div class='line not-executable'><span class='num'>620</span>            // TODO
</div><div class='line not-covered'><span class='num'>621</span>        }
</div><div class='line not-executable'><span class='num'>622</span>    }
</div><div class='line not-executable'><span class='num'>623</span>
</div><div class='line not-executable'><span class='num'>624</span>    public function getStatuses(): array
</div><div class='line not-executable'><span class='num'>625</span>    {
</div><div class='line not-covered'><span class='num'>626</span>        $stmt   = $this-&gt;pdo-&gt;query(&quot;
</div><div class='line not-covered'><span class='num'>627</span>            SELECT n.id,
</div><div class='line not-covered'><span class='num'>628</span>                   s.status
</div><div class='line not-executable'><span class='num'>629</span>            FROM   nodes n
</div><div class='line not-executable'><span class='num'>630</span>            LEFT JOIN status s ON n.id = s.node_id&quot;);
</div><div class='line not-executable'><span class='num'>631</span>        $status = $stmt-&gt;fetchAll();
</div><div class='line not-covered'><span class='num'>632</span>        return $status;
</div><div class='line not-executable'><span class='num'>633</span>    }
</div><div class='line not-executable'><span class='num'>634</span>
</div><div class='line not-executable'><span class='num'>635</span>    public function getNodeStatus(string $id): ?string
</div><div class='line not-executable'><span class='num'>636</span>    {
</div><div class='line not-executable'><span class='num'>637</span>        $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-covered'><span class='num'>638</span>            SELECT s.status
</div><div class='line not-covered'><span class='num'>639</span>            FROM nodes n
</div><div class='line not-covered'><span class='num'>640</span>            LEFT JOIN status s
</div><div class='line not-covered'><span class='num'>641</span>            ON n.id = s.node_id
</div><div class='line not-executable'><span class='num'>642</span>            WHERE n.id = ?&quot;);
</div><div class='line not-executable'><span class='num'>643</span>        $stmt-&gt;execute([$id]);
</div><div class='line not-executable'><span class='num'>644</span>        $status = $stmt-&gt;fetch();
</div><div class='line not-covered'><span class='num'>645</span>        return $status ? $status[&#039;status&#039;] : null;
</div><div class='line not-covered'><span class='num'>646</span>    }
</div><div class='line not-covered'><span class='num'>647</span>
</div><div class='line not-executable'><span class='num'>648</span>    public function setNodeStatus(string $id, string $status): void
</div><div class='line not-executable'><span class='num'>649</span>    {
</div><div class='line not-executable'><span class='num'>650</span>        $stmt = $this-&gt;pdo-&gt;prepare(&quot;REPLACE INTO status (node_id, status) VALUES (?, ?)&quot;);
</div><div class='line not-covered'><span class='num'>651</span>        $stmt-&gt;execute([$id, $status]);
</div><div class='line not-executable'><span class='num'>652</span>    }
</div><div class='line not-executable'><span class='num'>653</span>
</div><div class='line not-executable'><span class='num'>654</span>    public function getLogs($limit): array
</div><div class='line not-executable'><span class='num'>655</span>    {
</div><div class='line not-executable'><span class='num'>656</span>        $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-covered'><span class='num'>657</span>            SELECT *
</div><div class='line not-covered'><span class='num'>658</span>            FROM audit
</div><div class='line not-covered'><span class='num'>659</span>            ORDER BY created_at DESC
</div><div class='line not-covered'><span class='num'>660</span>            LIMIT :limit
</div><div class='line not-covered'><span class='num'>661</span>        &quot;);
</div><div class='line not-executable'><span class='num'>662</span>        $stmt-&gt;bindValue(&#039;:limit&#039;, (int)$limit, PDO::PARAM_INT);
</div><div class='line not-executable'><span class='num'>663</span>        $stmt-&gt;execute();
</div><div class='line not-executable'><span class='num'>664</span>        $rows = $stmt-&gt;fetchAll();
</div><div class='line not-executable'><span class='num'>665</span>        return $rows;
</div><div class='line covered'><span class='num'>666</span>    }
</div><div class='line not-executable'><span class='num'>667</span>
</div><div class='line not-executable'><span class='num'>668</span>    public function insertAuditLog(string $entity_type, string $entity_id, string $action, ?array $old_data = null, ?array $new_data = null, string $user_id, string $ip_address): bool
</div><div class='line not-executable'><span class='num'>669</span>    {
</div><div class='line not-executable'><span class='num'>670</span>        try {
</div><div class='line covered'><span class='num'>671</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line covered'><span class='num'>672</span>                INSERT INTO audit (entity_type, entity_id, action, old_data, new_data, user_id, ip_address)
</div><div class='line covered'><span class='num'>673</span>                VALUES (:entity_type, :entity_id, :action, :old_data, :new_data, :user_id, :ip_address)
</div><div class='line covered'><span class='num'>674</span>            &quot;);
</div><div class='line not-covered'><span class='num'>675</span>
</div><div class='line covered'><span class='num'>676</span>            $stmt-&gt;execute([
</div><div class='line covered'><span class='num'>677</span>                &#039;:entity_type&#039; =&gt; $entity_type,
</div><div class='line covered'><span class='num'>678</span>                &#039;:entity_id&#039;   =&gt; $entity_id,
</div><div class='line not-executable'><span class='num'>679</span>                &#039;:action&#039;      =&gt; $action,
</div><div class='line covered'><span class='num'>680</span>                &#039;:old_data&#039;    =&gt; $old_data !== null ? json_encode($old_data, JSON_UNESCAPED_UNICODE) : null,
</div><div class='line not-covered'><span class='num'>681</span>                &#039;:new_data&#039;    =&gt; $new_data !== null ? json_encode($new_data, JSON_UNESCAPED_UNICODE) : null,
</div><div class='line not-covered'><span class='num'>682</span>                &#039;:user_id&#039;     =&gt; $user_id,
</div><div class='line not-covered'><span class='num'>683</span>                &#039;:ip_address&#039;  =&gt; $ip_address
</div><div class='line not-executable'><span class='num'>684</span>            ]);
</div><div class='line not-covered'><span class='num'>685</span>            return true;
</div><div class='line not-executable'><span class='num'>686</span>        } catch (PDOException $e) {
</div><div class='line not-executable'><span class='num'>687</span>            error_log(&quot;GraphDatabase audit log insert failed: &quot; . $e-&gt;getMessage());
</div><div class='line not-executable'><span class='num'>688</span>            return false;
</div><div class='line covered'><span class='num'>689</span>        }
</div><div class='line not-executable'><span class='num'>690</span>    }
</div><div class='line not-executable'><span class='num'>691</span>
</div><div class='line not-executable'><span class='num'>692</span>    private function initSchema(): void
</div><div class='line not-executable'><span class='num'>693</span>    {
</div><div class='line not-executable'><span class='num'>694</span>        $this-&gt;pdo-&gt;exec(&quot;
</div><div class='line not-executable'><span class='num'>695</span>            CREATE TABLE IF NOT EXISTS users (
</div><div class='line covered'><span class='num'>696</span>                id TEXT PRIMARY KEY,
</div><div class='line not-executable'><span class='num'>697</span>                user_group TEXT NOT NULL
</div><div class='line covered'><span class='num'>698</span>            )
</div><div class='line not-executable'><span class='num'>699</span>        &quot;);
</div><div class='line not-executable'><span class='num'>700</span>
</div><div class='line not-executable'><span class='num'>701</span>        $this-&gt;pdo-&gt;exec(&quot;INSERT INTO users VALUES(&#039;admin&#039;, &#039;admin&#039;)&quot;);
</div><div class='line not-executable'><span class='num'>702</span>
</div><div class='line not-executable'><span class='num'>703</span>        $this-&gt;pdo-&gt;exec(&quot;
</div><div class='line not-executable'><span class='num'>704</span>            CREATE TABLE IF NOT EXISTS nodes (
</div><div class='line not-executable'><span class='num'>705</span>                id TEXT PRIMARY KEY,
</div><div class='line not-executable'><span class='num'>706</span>                label TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>707</span>                category TEXT NOT NULL,
</div><div class='line covered'><span class='num'>708</span>                type TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>709</span>                data TEXT NOT NULL
</div><div class='line not-executable'><span class='num'>710</span>            )
</div><div class='line not-executable'><span class='num'>711</span>        &quot;);
</div><div class='line not-executable'><span class='num'>712</span>
</div><div class='line not-executable'><span class='num'>713</span>        $this-&gt;pdo-&gt;exec(&quot;
</div><div class='line not-executable'><span class='num'>714</span>            CREATE TABLE IF NOT EXISTS edges (
</div><div class='line not-executable'><span class='num'>715</span>                id TEXT PRIMARY KEY,
</div><div class='line not-executable'><span class='num'>716</span>                source TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>717</span>                target TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>718</span>                data TEXT,
</div><div class='line covered'><span class='num'>719</span>                FOREIGN KEY (source) REFERENCES nodes(id) ON DELETE CASCADE,
</div><div class='line not-executable'><span class='num'>720</span>                FOREIGN KEY (target) REFERENCES nodes(id) ON DELETE CASCADE
</div><div class='line covered'><span class='num'>721</span>            )
</div><div class='line not-executable'><span class='num'>722</span>        &quot;);
</div><div class='line not-executable'><span class='num'>723</span>
</div><div class='line not-executable'><span class='num'>724</span>        $this-&gt;pdo-&gt;exec(&quot;CREATE UNIQUE INDEX IF NOT EXISTS idx_edges_source_target ON edges (source, target)&quot;);
</div><div class='line not-executable'><span class='num'>725</span>
</div><div class='line not-executable'><span class='num'>726</span>        $this-&gt;pdo-&gt;exec(&quot;
</div><div class='line not-executable'><span class='num'>727</span>            CREATE TABLE IF NOT EXISTS status (
</div><div class='line not-executable'><span class='num'>728</span>                node_id TEXT PRIMARY KEY NOT NULL,
</div><div class='line not-executable'><span class='num'>729</span>                status TEXT NOT NULL,
</div><div class='line covered'><span class='num'>730</span>                created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
</div><div class='line not-executable'><span class='num'>731</span>                FOREIGN KEY (node_id) REFERENCES nodes(id) ON DELETE CASCADE
</div><div class='line covered'><span class='num'>732</span>            )
</div><div class='line not-executable'><span class='num'>733</span>        &quot;);
</div><div class='line not-executable'><span class='num'>734</span>
</div><div class='line not-executable'><span class='num'>735</span>        $this-&gt;pdo-&gt;exec(&quot;CREATE INDEX IF NOT EXISTS idx_node_status_node_id ON status (node_id)&quot;);
</div><div class='line not-executable'><span class='num'>736</span>
</div><div class='line not-executable'><span class='num'>737</span>        $this-&gt;pdo-&gt;exec(&quot;
</div><div class='line not-executable'><span class='num'>738</span>            CREATE TABLE IF NOT EXISTS audit (
</div><div class='line not-executable'><span class='num'>739</span>                id INTEGER PRIMARY KEY AUTOINCREMENT,
</div><div class='line not-executable'><span class='num'>740</span>                entity_type TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>741</span>                entity_id TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>742</span>                action TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>743</span>                old_data TEXT,
</div><div class='line not-executable'><span class='num'>744</span>                new_data TEXT,
</div><div class='line covered'><span class='num'>745</span>                user_id TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>746</span>                ip_address TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>747</span>                created_at DATETIME DEFAULT CURRENT_TIMESTAMP
</div><div class='line not-executable'><span class='num'>748</span>            )
</div><div class='line covered'><span class='num'>749</span>        &quot;);
</div><div class='line covered'><span class='num'>750</span>    }
</div><div class='line covered'><span class='num'>751</span>
</div><div class='line covered'><span class='num'>752</span>    public static function createConnection(string $dsn): PDO
</div><div class='line covered'><span class='num'>753</span>    {
</div><div class='line not-covered'><span class='num'>754</span>        $pdo = new PDO($dsn);
</div><div class='line not-executable'><span class='num'>755</span>        $pdo-&gt;setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
</div><div class='line not-executable'><span class='num'>756</span>        $pdo-&gt;setAttribute(PDO::ATTR_DEFAULT_FETCH_MODE, PDO::FETCH_ASSOC);
</div><div class='line not-executable'><span class='num'>757</span>        $pdo-&gt;exec(&#039;PRAGMA foreign_keys = ON&#039;);
</div><div class='line not-executable'><span class='num'>758</span>        return $pdo;
</div><div class='line not-executable'><span class='num'>759</span>    }
</div><div class='line not-executable'><span class='num'>760</span>}
</div><div class='line not-executable'><span class='num'>761</span>
</div><div class='line not-executable'><span class='num'>762</span>final class GraphServiceException extends RuntimeException
</div><div class='line not-executable'><span class='num'>763</span>{
</div><div class='line not-executable'><span class='num'>764</span>}
</div><div class='line not-executable'><span class='num'>765</span>
</div><div class='line not-executable'><span class='num'>766</span>interface GraphServiceInterface
</div><div class='line not-executable'><span class='num'>767</span>{
</div><div class='line not-executable'><span class='num'>768</span>    public function getUser(string $id): ?User;
</div><div class='line not-executable'><span class='num'>769</span>    public function insertUser(User $user): void;
</div><div class='line not-executable'><span class='num'>770</span>    public function updateUser(User $user): void;
</div><div class='line not-executable'><span class='num'>771</span>
</div><div class='line not-executable'><span class='num'>772</span>    public function getGraph(): Graph;
</div><div class='line not-executable'><span class='num'>773</span>
</div><div class='line not-executable'><span class='num'>774</span>    public function getNode(string $id): ?Node;
</div><div class='line not-executable'><span class='num'>775</span>    public function getNodes(): Nodes;
</div><div class='line not-executable'><span class='num'>776</span>    public function insertNode(Node $node): void;
</div><div class='line not-executable'><span class='num'>777</span>    public function updateNode(Node $node): void;
</div><div class='line not-executable'><span class='num'>778</span>    public function deleteNode(string $id): void;
</div><div class='line not-executable'><span class='num'>779</span>
</div><div class='line not-executable'><span class='num'>780</span>    public function getEdge(string $source, string $target): ?Edge;
</div><div class='line not-executable'><span class='num'>781</span>    public function getEdges(): Edges;
</div><div class='line not-executable'><span class='num'>782</span>    public function insertEdge(Edge $edge): void;
</div><div class='line not-executable'><span class='num'>783</span>    public function updateEdge(Edge $edge): void;
</div><div class='line not-executable'><span class='num'>784</span>    public function deleteEdge(string $id): void;
</div><div class='line not-executable'><span class='num'>785</span>
</div><div class='line not-executable'><span class='num'>786</span>    public function getStatuses(): NodeStatuses;
</div><div class='line not-executable'><span class='num'>787</span>    public function getNodeStatus(string $id): NodeStatus;
</div><div class='line not-executable'><span class='num'>788</span>    public function setNodeStatus(NodeStatus $status): void;
</div><div class='line not-executable'><span class='num'>789</span>
</div><div class='line not-executable'><span class='num'>790</span>    public function getLogs($limit): AuditLogs;
</div><div class='line not-executable'><span class='num'>791</span>}
</div><div class='line not-executable'><span class='num'>792</span>
</div><div class='line not-executable'><span class='num'>793</span>final class GraphService implements GraphServiceInterface
</div><div class='line not-executable'><span class='num'>794</span>{
</div><div class='line not-executable'><span class='num'>795</span>    private const SECURE_ACTIONS = [
</div><div class='line not-executable'><span class='num'>796</span>        &#039;GraphService::getGraph&#039;      =&gt; true,
</div><div class='line not-executable'><span class='num'>797</span>        &#039;GraphService::getNode&#039;       =&gt; true,
</div><div class='line not-executable'><span class='num'>798</span>        &#039;GraphService::getNodes&#039;      =&gt; true,
</div><div class='line not-executable'><span class='num'>799</span>        &#039;GraphService::getEdge&#039;       =&gt; true,
</div><div class='line not-executable'><span class='num'>800</span>        &#039;GraphService::getEdges&#039;      =&gt; true,
</div><div class='line not-executable'><span class='num'>801</span>        &#039;GraphService::getStatuses&#039;   =&gt; true,
</div><div class='line not-executable'><span class='num'>802</span>        &#039;GraphService::getNodeStatus&#039; =&gt; true,
</div><div class='line not-executable'><span class='num'>803</span>        &#039;GraphService::setNodeStatus&#039; =&gt; true,
</div><div class='line not-executable'><span class='num'>804</span>        &#039;GraphService::getLogs&#039;       =&gt; true,
</div><div class='line not-executable'><span class='num'>805</span>        &#039;GraphService::insertNode&#039;    =&gt; false,
</div><div class='line not-executable'><span class='num'>806</span>        &#039;GraphService::updateNode&#039;    =&gt; false,
</div><div class='line not-executable'><span class='num'>807</span>        &#039;GraphService::deleteNode&#039;    =&gt; false,
</div><div class='line not-executable'><span class='num'>808</span>        &#039;GraphService::insertEdge&#039;    =&gt; false,
</div><div class='line not-executable'><span class='num'>809</span>        &#039;GraphService::updateEdge&#039;    =&gt; false,
</div><div class='line not-executable'><span class='num'>810</span>        &#039;GraphService::deleteEdge&#039;    =&gt; false,
</div><div class='line not-executable'><span class='num'>811</span>
</div><div class='line not-executable'><span class='num'>812</span>        &#039;GraphService::insertAuditLog&#039; =&gt; false,
</div><div class='line not-executable'><span class='num'>813</span>    ];
</div><div class='line not-executable'><span class='num'>814</span>
</div><div class='line covered'><span class='num'>815</span>    private GraphDatabaseInterface $db;
</div><div class='line covered'><span class='num'>816</span>    private Logger $logger;
</div><div class='line covered'><span class='num'>817</span>
</div><div class='line not-executable'><span class='num'>818</span>    public function __construct(GraphDatabaseInterface $db, Logger $logger)
</div><div class='line not-executable'><span class='num'>819</span>    {
</div><div class='line not-executable'><span class='num'>820</span>        $this-&gt;db = $db;
</div><div class='line not-covered'><span class='num'>821</span>        $this-&gt;logger = $logger;
</div><div class='line not-covered'><span class='num'>822</span>    }
</div><div class='line not-covered'><span class='num'>823</span>
</div><div class='line not-covered'><span class='num'>824</span>    public function getUser(string $id): ?User
</div><div class='line not-executable'><span class='num'>825</span>    {
</div><div class='line not-covered'><span class='num'>826</span>        $data = $this-&gt;db-&gt;getUser($id);
</div><div class='line not-covered'><span class='num'>827</span>        if ($data) {
</div><div class='line not-executable'><span class='num'>828</span>            $user = new User($id, null, $data[&#039;user_group&#039;]);
</div><div class='line not-executable'><span class='num'>829</span>            return $user;
</div><div class='line not-executable'><span class='num'>830</span>        }
</div><div class='line not-covered'><span class='num'>831</span>        return null;
</div><div class='line not-covered'><span class='num'>832</span>    }
</div><div class='line not-executable'><span class='num'>833</span>
</div><div class='line not-executable'><span class='num'>834</span>    public function insertUser(User $user): void
</div><div class='line not-executable'><span class='num'>835</span>    {
</div><div class='line not-covered'><span class='num'>836</span>        $this-&gt;db-&gt;insertUser($user-&gt;id, $user-&gt;group-&gt;id);
</div><div class='line not-covered'><span class='num'>837</span>    }
</div><div class='line not-executable'><span class='num'>838</span>
</div><div class='line not-executable'><span class='num'>839</span>    public function updateUser(User $user): void
</div><div class='line not-executable'><span class='num'>840</span>    {
</div><div class='line not-covered'><span class='num'>841</span>        $this-&gt;db-&gt;updateUser($user-&gt;id, $user-&gt;group-&gt;id);
</div><div class='line not-covered'><span class='num'>842</span>    }
</div><div class='line not-covered'><span class='num'>843</span>
</div><div class='line not-covered'><span class='num'>844</span>    public function getGraph(): Graph
</div><div class='line not-executable'><span class='num'>845</span>    {
</div><div class='line not-executable'><span class='num'>846</span>        $nodes = $this-&gt;getNodes()-&gt;nodes;
</div><div class='line not-executable'><span class='num'>847</span>        $edges = $this-&gt;getEdges()-&gt;edges;
</div><div class='line covered'><span class='num'>848</span>        return new Graph($nodes, $edges);
</div><div class='line not-covered'><span class='num'>849</span>    }
</div><div class='line not-executable'><span class='num'>850</span>
</div><div class='line not-executable'><span class='num'>851</span>    public function getNode(string $id): ?Node
</div><div class='line covered'><span class='num'>852</span>    {
</div><div class='line covered'><span class='num'>853</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line covered'><span class='num'>854</span>            throw new RuntimeException(&quot;Permission denied to get node.&quot;);
</div><div class='line covered'><span class='num'>855</span>        }
</div><div class='line covered'><span class='num'>856</span>
</div><div class='line covered'><span class='num'>857</span>        $data = $this-&gt;db-&gt;getNode($id);
</div><div class='line covered'><span class='num'>858</span>        if ($data) {
</div><div class='line covered'><span class='num'>859</span>            return new Node(
</div><div class='line not-executable'><span class='num'>860</span>                $data[&#039;id&#039;],
</div><div class='line not-executable'><span class='num'>861</span>                $data[&#039;label&#039;],
</div><div class='line not-covered'><span class='num'>862</span>                $data[&#039;category&#039;],
</div><div class='line not-covered'><span class='num'>863</span>                $data[&#039;type&#039;],
</div><div class='line not-executable'><span class='num'>864</span>                json_decode($data[&#039;data&#039;], true)
</div><div class='line not-executable'><span class='num'>865</span>            );
</div><div class='line not-executable'><span class='num'>866</span>        }
</div><div class='line not-covered'><span class='num'>867</span>        return null;
</div><div class='line not-covered'><span class='num'>868</span>    }
</div><div class='line not-executable'><span class='num'>869</span>
</div><div class='line not-executable'><span class='num'>870</span>    public function getNodes(): Nodes
</div><div class='line not-covered'><span class='num'>871</span>    {
</div><div class='line not-covered'><span class='num'>872</span>        if(! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>873</span>            throw new RuntimeException(&quot;Permission denied to get nodes.&quot;);
</div><div class='line not-covered'><span class='num'>874</span>        }
</div><div class='line not-covered'><span class='num'>875</span>
</div><div class='line not-covered'><span class='num'>876</span>        $nodesData = $this-&gt;db-&gt;getNodes();
</div><div class='line not-covered'><span class='num'>877</span>        $nodes     = new Nodes();
</div><div class='line not-covered'><span class='num'>878</span>        foreach ($nodesData as $data) {
</div><div class='line not-covered'><span class='num'>879</span>            $node = new Node(
</div><div class='line not-executable'><span class='num'>880</span>                $data[&#039;id&#039;],
</div><div class='line not-covered'><span class='num'>881</span>                $data[&#039;label&#039;],
</div><div class='line not-executable'><span class='num'>882</span>                $data[&#039;category&#039;],
</div><div class='line not-covered'><span class='num'>883</span>                $data[&#039;type&#039;],
</div><div class='line not-covered'><span class='num'>884</span>                json_decode($data[&#039;data&#039;], true)
</div><div class='line not-executable'><span class='num'>885</span>            );
</div><div class='line not-executable'><span class='num'>886</span>            $nodes-&gt;addNode($node);
</div><div class='line not-executable'><span class='num'>887</span>        }
</div><div class='line covered'><span class='num'>888</span>        return $nodes;
</div><div class='line not-executable'><span class='num'>889</span>    }
</div><div class='line covered'><span class='num'>890</span>
</div><div class='line not-covered'><span class='num'>891</span>    public function insertNode(Node $node): void
</div><div class='line not-covered'><span class='num'>892</span>    {
</div><div class='line not-executable'><span class='num'>893</span>        $this-&gt;logger-&gt;debug(&#039;inserting node&#039;, $node-&gt;toArray());
</div><div class='line not-executable'><span class='num'>894</span>
</div><div class='line covered'><span class='num'>895</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-executable'><span class='num'>896</span>            $this-&gt;logger-&gt;info(&#039;permission denied&#039;, $node-&gt;toArray());
</div><div class='line covered'><span class='num'>897</span>            throw new GraphServiceException(&#039;permission denied&#039;);
</div><div class='line not-executable'><span class='num'>898</span>        }
</div><div class='line covered'><span class='num'>899</span>
</div><div class='line covered'><span class='num'>900</span>        $this-&gt;logger-&gt;info(&#039;permission allowed&#039;, $node-&gt;toArray());
</div><div class='line covered'><span class='num'>901</span>
</div><div class='line covered'><span class='num'>902</span>        $this-&gt;insertAuditLog(new AuditLog( &#039;node&#039;, $node-&gt;id, &#039;insert&#039;, null, $node-&gt;toArray()));
</div><div class='line covered'><span class='num'>903</span>
</div><div class='line covered'><span class='num'>904</span>        $this-&gt;db-&gt;insertNode(
</div><div class='line not-executable'><span class='num'>905</span>            $node-&gt;id,
</div><div class='line covered'><span class='num'>906</span>            $node-&gt;label,
</div><div class='line not-executable'><span class='num'>907</span>            $node-&gt;category,
</div><div class='line not-executable'><span class='num'>908</span>            $node-&gt;type,
</div><div class='line not-executable'><span class='num'>909</span>            $node-&gt;data
</div><div class='line not-covered'><span class='num'>910</span>        );
</div><div class='line not-covered'><span class='num'>911</span>    }
</div><div class='line not-executable'><span class='num'>912</span>
</div><div class='line not-executable'><span class='num'>913</span>    public function updateNode(Node $node): void
</div><div class='line not-covered'><span class='num'>914</span>    {
</div><div class='line not-covered'><span class='num'>915</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-executable'><span class='num'>916</span>            throw new RuntimeException(&quot;Permission denied to update node.&quot;);
</div><div class='line not-covered'><span class='num'>917</span>        }
</div><div class='line not-covered'><span class='num'>918</span>
</div><div class='line not-covered'><span class='num'>919</span>        $old = $this-&gt;getNode($node-&gt;id);
</div><div class='line not-covered'><span class='num'>920</span>        $this-&gt;insertAuditLog(new AuditLog( &#039;node&#039;, $node-&gt;id, &#039;update&#039;, $old-&gt;toArray(), $node-&gt;toArray()));
</div><div class='line not-covered'><span class='num'>921</span>
</div><div class='line not-covered'><span class='num'>922</span>        $this-&gt;db-&gt;updateNode(
</div><div class='line not-executable'><span class='num'>923</span>            $node-&gt;id,
</div><div class='line not-covered'><span class='num'>924</span>            $node-&gt;label,
</div><div class='line not-executable'><span class='num'>925</span>            $node-&gt;category,
</div><div class='line not-executable'><span class='num'>926</span>            $node-&gt;type,
</div><div class='line not-executable'><span class='num'>927</span>            $node-&gt;data
</div><div class='line not-covered'><span class='num'>928</span>        );
</div><div class='line not-covered'><span class='num'>929</span>    }
</div><div class='line not-executable'><span class='num'>930</span>
</div><div class='line not-executable'><span class='num'>931</span>    public function deleteNode(string $id): void
</div><div class='line not-covered'><span class='num'>932</span>    {
</div><div class='line not-covered'><span class='num'>933</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>934</span>            throw new RuntimeException(&quot;Permission denied to delete node.&quot;);
</div><div class='line not-covered'><span class='num'>935</span>        }
</div><div class='line not-executable'><span class='num'>936</span>
</div><div class='line not-executable'><span class='num'>937</span>        $old = $this-&gt;getNode($id);
</div><div class='line not-executable'><span class='num'>938</span>        $this-&gt;insertAuditLog(new AuditLog( &#039;node&#039;, $id, &#039;delete&#039;, $old-&gt;toArray(), null));
</div><div class='line not-covered'><span class='num'>939</span>        $this-&gt;db-&gt;deleteNode($id);
</div><div class='line not-covered'><span class='num'>940</span>    }
</div><div class='line not-executable'><span class='num'>941</span>
</div><div class='line not-executable'><span class='num'>942</span>    public function getEdge(string $source, string $target): ?Edge
</div><div class='line not-covered'><span class='num'>943</span>    {
</div><div class='line not-covered'><span class='num'>944</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>945</span>            throw new RuntimeException(&quot;Permission denied to get edge.&quot;);
</div><div class='line not-covered'><span class='num'>946</span>        }
</div><div class='line not-covered'><span class='num'>947</span>
</div><div class='line not-covered'><span class='num'>948</span>        $edgesData = $this-&gt;db-&gt;getEdges();
</div><div class='line not-covered'><span class='num'>949</span>        foreach ($edgesData as $data) {
</div><div class='line not-covered'><span class='num'>950</span>            if ($data[&#039;source&#039;] === $source &amp;&amp; $data[&#039;target&#039;] === $target) {
</div><div class='line not-executable'><span class='num'>951</span>                return new Edge(
</div><div class='line not-executable'><span class='num'>952</span>                    $data[&#039;id&#039;],
</div><div class='line not-executable'><span class='num'>953</span>                    $data[&#039;source&#039;],
</div><div class='line not-covered'><span class='num'>954</span>                    $data[&#039;target&#039;],
</div><div class='line not-covered'><span class='num'>955</span>                    json_decode($data[&#039;data&#039;], true)
</div><div class='line not-executable'><span class='num'>956</span>                );
</div><div class='line not-executable'><span class='num'>957</span>            }
</div><div class='line not-executable'><span class='num'>958</span>        }
</div><div class='line not-covered'><span class='num'>959</span>        return null;
</div><div class='line not-covered'><span class='num'>960</span>    }
</div><div class='line not-executable'><span class='num'>961</span>
</div><div class='line not-covered'><span class='num'>962</span>    public function getEdges(): Edges
</div><div class='line not-covered'><span class='num'>963</span>    {
</div><div class='line not-covered'><span class='num'>964</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>965</span>            throw new RuntimeException(&quot;Permission denied to get edges.&quot;);
</div><div class='line not-covered'><span class='num'>966</span>        }
</div><div class='line not-covered'><span class='num'>967</span>        $edgesData = $this-&gt;db-&gt;getEdges();
</div><div class='line not-covered'><span class='num'>968</span>        $edges     = new Edges();
</div><div class='line not-covered'><span class='num'>969</span>        foreach ($edgesData as $data) {
</div><div class='line not-executable'><span class='num'>970</span>            $edge = new Edge(
</div><div class='line not-covered'><span class='num'>971</span>                $data[&#039;id&#039;],
</div><div class='line not-executable'><span class='num'>972</span>                $data[&#039;source&#039;],
</div><div class='line not-covered'><span class='num'>973</span>                $data[&#039;target&#039;],
</div><div class='line not-covered'><span class='num'>974</span>                json_decode($data[&#039;data&#039;], true)
</div><div class='line not-executable'><span class='num'>975</span>            );
</div><div class='line not-executable'><span class='num'>976</span>            $edges-&gt;addEdge($edge);
</div><div class='line not-executable'><span class='num'>977</span>        }
</div><div class='line not-covered'><span class='num'>978</span>        return $edges;
</div><div class='line not-covered'><span class='num'>979</span>    }
</div><div class='line not-executable'><span class='num'>980</span>
</div><div class='line not-covered'><span class='num'>981</span>    public function insertEdge(Edge $edge): void
</div><div class='line not-covered'><span class='num'>982</span>    {
</div><div class='line not-covered'><span class='num'>983</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>984</span>            throw new RuntimeException(&quot;Permission denied to insert edge.&quot;);
</div><div class='line not-covered'><span class='num'>985</span>        }
</div><div class='line not-covered'><span class='num'>986</span>        $this-&gt;insertAuditLog(new AuditLog( &#039;edge&#039;, $edge-&gt;id, &#039;insert&#039;, null, $edge-&gt;toArray()));
</div><div class='line not-executable'><span class='num'>987</span>        $this-&gt;db-&gt;insertEdge(
</div><div class='line not-covered'><span class='num'>988</span>            $edge-&gt;id,
</div><div class='line not-executable'><span class='num'>989</span>            $edge-&gt;source,
</div><div class='line not-executable'><span class='num'>990</span>            $edge-&gt;target,
</div><div class='line not-executable'><span class='num'>991</span>            $edge-&gt;data
</div><div class='line not-covered'><span class='num'>992</span>        );
</div><div class='line not-covered'><span class='num'>993</span>    }
</div><div class='line not-executable'><span class='num'>994</span>
</div><div class='line not-covered'><span class='num'>995</span>    public function updateEdge(Edge $edge): void
</div><div class='line not-covered'><span class='num'>996</span>    {
</div><div class='line not-executable'><span class='num'>997</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>998</span>            throw new RuntimeException(&quot;Permission denied to update edge.&quot;);
</div><div class='line not-covered'><span class='num'>999</span>        }
</div><div class='line not-covered'><span class='num'>1000</span>        $old = $this-&gt;getEdge($edge-&gt;source, $edge-&gt;target);
</div><div class='line not-covered'><span class='num'>1001</span>        $this-&gt;insertAuditLog(new AuditLog( &#039;edge&#039;, $edge-&gt;id, &#039;update&#039;, $old-&gt;toArray(), $edge-&gt;toArray()));
</div><div class='line not-covered'><span class='num'>1002</span>
</div><div class='line not-executable'><span class='num'>1003</span>        $this-&gt;db-&gt;updateEdge(
</div><div class='line not-covered'><span class='num'>1004</span>            $edge-&gt;id,
</div><div class='line not-executable'><span class='num'>1005</span>            $edge-&gt;source,
</div><div class='line not-executable'><span class='num'>1006</span>            $edge-&gt;target,
</div><div class='line not-executable'><span class='num'>1007</span>            $edge-&gt;data
</div><div class='line not-covered'><span class='num'>1008</span>        );
</div><div class='line not-covered'><span class='num'>1009</span>    }
</div><div class='line not-executable'><span class='num'>1010</span>
</div><div class='line not-covered'><span class='num'>1011</span>    public function deleteEdge(string $id): void
</div><div class='line not-covered'><span class='num'>1012</span>    {
</div><div class='line not-executable'><span class='num'>1013</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-executable'><span class='num'>1014</span>            throw new RuntimeException(&quot;Permission denied to delete edge.&quot;);
</div><div class='line not-executable'><span class='num'>1015</span>        }
</div><div class='line not-covered'><span class='num'>1016</span>        $this-&gt;db-&gt;deleteEdge($id);
</div><div class='line not-covered'><span class='num'>1017</span>    }
</div><div class='line not-executable'><span class='num'>1018</span>
</div><div class='line not-executable'><span class='num'>1019</span>    public function getStatuses(): NodeStatuses
</div><div class='line not-covered'><span class='num'>1020</span>    {
</div><div class='line not-covered'><span class='num'>1021</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>1022</span>            throw new RuntimeException(&quot;Permission denied to get statuses.&quot;);
</div><div class='line not-covered'><span class='num'>1023</span>        }
</div><div class='line not-covered'><span class='num'>1024</span>
</div><div class='line not-covered'><span class='num'>1025</span>        $statusesData = $this-&gt;db-&gt;getStatuses();
</div><div class='line not-executable'><span class='num'>1026</span>        $nodeStatuses = new NodeStatuses();
</div><div class='line not-covered'><span class='num'>1027</span>        foreach ($statusesData as $data) {
</div><div class='line not-executable'><span class='num'>1028</span>            $status = new NodeStatus(
</div><div class='line not-covered'><span class='num'>1029</span>                $data[&#039;id&#039;],
</div><div class='line not-covered'><span class='num'>1030</span>                $data[&#039;status&#039;] ?? &#039;unknown&#039;
</div><div class='line not-executable'><span class='num'>1031</span>            );
</div><div class='line not-executable'><span class='num'>1032</span>            $nodeStatuses-&gt;addStatus($status);
</div><div class='line not-executable'><span class='num'>1033</span>        }
</div><div class='line not-covered'><span class='num'>1034</span>        return $nodeStatuses;
</div><div class='line not-covered'><span class='num'>1035</span>    }
</div><div class='line not-executable'><span class='num'>1036</span>
</div><div class='line not-executable'><span class='num'>1037</span>    public function getNodeStatus(string $id): NodeStatus
</div><div class='line not-covered'><span class='num'>1038</span>    {
</div><div class='line not-covered'><span class='num'>1039</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>1040</span>            throw new RuntimeException(&quot;Permission denied to get node status.&quot;);
</div><div class='line not-covered'><span class='num'>1041</span>        }
</div><div class='line not-executable'><span class='num'>1042</span>
</div><div class='line not-covered'><span class='num'>1043</span>        $statusData = $this-&gt;db-&gt;getNodeStatus($id);
</div><div class='line not-executable'><span class='num'>1044</span>        return new NodeStatus(
</div><div class='line not-executable'><span class='num'>1045</span>            $id,
</div><div class='line not-executable'><span class='num'>1046</span>            $statusData ?? &#039;unknown&#039;
</div><div class='line not-covered'><span class='num'>1047</span>        );
</div><div class='line not-covered'><span class='num'>1048</span>    }
</div><div class='line not-executable'><span class='num'>1049</span>
</div><div class='line not-executable'><span class='num'>1050</span>    public function setNodeStatus(NodeStatus $status): void
</div><div class='line not-covered'><span class='num'>1051</span>    {
</div><div class='line not-covered'><span class='num'>1052</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-executable'><span class='num'>1053</span>            throw new RuntimeException(&quot;Permission denied to set node status.&quot;);
</div><div class='line not-executable'><span class='num'>1054</span>        }
</div><div class='line not-executable'><span class='num'>1055</span>
</div><div class='line not-covered'><span class='num'>1056</span>        $this-&gt;db-&gt;setNodeStatus($status-&gt;nodeId, $status-&gt;status);
</div><div class='line not-covered'><span class='num'>1057</span>    }
</div><div class='line not-executable'><span class='num'>1058</span>
</div><div class='line not-executable'><span class='num'>1059</span>    public function getLogs($limit): AuditLogs
</div><div class='line not-covered'><span class='num'>1060</span>    {
</div><div class='line not-covered'><span class='num'>1061</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>1062</span>            throw new RuntimeException(&quot;Permission denied to get audit logs.&quot;);
</div><div class='line not-covered'><span class='num'>1063</span>        }
</div><div class='line not-covered'><span class='num'>1064</span>
</div><div class='line not-covered'><span class='num'>1065</span>        $logs = new AuditLogs();
</div><div class='line not-covered'><span class='num'>1066</span>        $rows = $this-&gt;db-&gt;getLogs($limit);
</div><div class='line not-covered'><span class='num'>1067</span>        foreach ($rows as $row) {
</div><div class='line not-covered'><span class='num'>1068</span>            $old_data = $row[&#039;old_data&#039;] ? json_decode($row[&#039;old_data&#039;], true) : [];
</div><div class='line not-executable'><span class='num'>1069</span>            $new_data = $row[&#039;new_data&#039;] ?  json_decode($row[&#039;new_data&#039;], true) : [];
</div><div class='line not-executable'><span class='num'>1070</span>            $log = new AuditLog(
</div><div class='line not-executable'><span class='num'>1071</span>                $row[&#039;entity_type&#039;],
</div><div class='line not-covered'><span class='num'>1072</span>                $row[&#039;entity_id&#039;],
</div><div class='line not-covered'><span class='num'>1073</span>                $row[&#039;action&#039;],
</div><div class='line not-covered'><span class='num'>1074</span>                $old_data,
</div><div class='line not-executable'><span class='num'>1075</span>                $new_data,
</div><div class='line not-covered'><span class='num'>1076</span>            );
</div><div class='line not-executable'><span class='num'>1077</span>            $log-&gt;userId    = $row[&#039;user_id&#039;];
</div><div class='line not-covered'><span class='num'>1078</span>            $log-&gt;ipAddress = $row[&#039;ip_address&#039;];
</div><div class='line not-covered'><span class='num'>1079</span>            $log-&gt;createdAt = $row[&#039;created_at&#039;];
</div><div class='line not-executable'><span class='num'>1080</span>
</div><div class='line not-executable'><span class='num'>1081</span>            $logs-&gt;addLog($log);
</div><div class='line not-executable'><span class='num'>1082</span>        }
</div><div class='line covered'><span class='num'>1083</span>        return $logs;
</div><div class='line covered'><span class='num'>1084</span>    }
</div><div class='line not-executable'><span class='num'>1085</span>
</div><div class='line covered'><span class='num'>1086</span>    private function insertAuditLog(AuditLog $auditLog): void
</div><div class='line covered'><span class='num'>1087</span>    {
</div><div class='line covered'><span class='num'>1088</span>        $user_id   = GraphContext::$user-&gt;id;
</div><div class='line covered'><span class='num'>1089</span>        $ip_address = GraphContext::$user-&gt;ipAddress;
</div><div class='line covered'><span class='num'>1090</span>
</div><div class='line covered'><span class='num'>1091</span>        $this-&gt;db-&gt;insertAuditLog(
</div><div class='line not-executable'><span class='num'>1092</span>            $auditLog-&gt;entityType,
</div><div class='line not-executable'><span class='num'>1093</span>            $auditLog-&gt;entityId,
</div><div class='line not-executable'><span class='num'>1094</span>            $auditLog-&gt;action,
</div><div class='line covered'><span class='num'>1095</span>            $auditLog-&gt;oldData,
</div><div class='line not-executable'><span class='num'>1096</span>            $auditLog-&gt;newData,
</div><div class='line not-executable'><span class='num'>1097</span>            $user_id,
</div><div class='line not-executable'><span class='num'>1098</span>            $ip_address
</div><div class='line covered'><span class='num'>1099</span>        );
</div><div class='line not-executable'><span class='num'>1100</span>    }
</div><div class='line not-executable'><span class='num'>1101</span>
</div><div class='line not-executable'><span class='num'>1102</span>    private function isAllowed(string $action): bool
</div><div class='line covered'><span class='num'>1103</span>    {
</div><div class='line not-covered'><span class='num'>1104</span>        $group = GraphContext::$user-&gt;group;
</div><div class='line not-executable'><span class='num'>1105</span>
</div><div class='line not-executable'><span class='num'>1106</span>        // validate action
</div><div class='line not-executable'><span class='num'>1107</span>        // if action is one of the keys in the array self::SECURE_ACTIONS
</div><div class='line covered'><span class='num'>1108</span>        if (!array_key_exists($action, self::SECURE_ACTIONS)) {
</div><div class='line not-covered'><span class='num'>1109</span>            throw new RuntimeException(&quot;Action not defined in secure actions. Action: {$action}&quot;);
</div><div class='line not-executable'><span class='num'>1110</span>        }
</div><div class='line not-executable'><span class='num'>1111</span>
</div><div class='line not-executable'><span class='num'>1112</span>        // if is admin, allow all
</div><div class='line covered'><span class='num'>1113</span>        if ($group-&gt;id === &#039;admin&#039;) {
</div><div class='line covered'><span class='num'>1114</span>            return true;
</div><div class='line not-executable'><span class='num'>1115</span>        }
</div><div class='line not-executable'><span class='num'>1116</span>
</div><div class='line not-executable'><span class='num'>1117</span>        // if action is in the SAFE_ACTIONS, allow all
</div><div class='line covered'><span class='num'>1118</span>        if (self::SECURE_ACTIONS[$action]) {
</div><div class='line not-executable'><span class='num'>1119</span>            return true;
</div><div class='line covered'><span class='num'>1120</span>        }
</div><div class='line not-executable'><span class='num'>1121</span>        
</div><div class='line not-executable'><span class='num'>1122</span>        // if action is restricted, only allow contributor
</div><div class='line not-covered'><span class='num'>1123</span>        if (self::SECURE_ACTIONS[$action] == false &amp;&amp; $group-&gt;id == &#039;contributor&#039;)
</div><div class='line not-covered'><span class='num'>1124</span>        {
</div><div class='line not-executable'><span class='num'>1125</span>            return true;
</div><div class='line not-executable'><span class='num'>1126</span>        }
</div><div class='line not-executable'><span class='num'>1127</span>
</div><div class='line not-executable'><span class='num'>1128</span>        return false;
</div><div class='line not-executable'><span class='num'>1129</span>    }
</div><div class='line not-executable'><span class='num'>1130</span>}
</div><div class='line not-executable'><span class='num'>1131</span>
</div><div class='line not-executable'><span class='num'>1132</span>final class Request
</div><div class='line covered'><span class='num'>1133</span>{
</div><div class='line covered'><span class='num'>1134</span>    public array $data;
</div><div class='line not-executable'><span class='num'>1135</span>
</div><div class='line not-executable'><span class='num'>1136</span>    public function getParam($name): string
</div><div class='line not-covered'><span class='num'>1137</span>    {
</div><div class='line not-covered'><span class='num'>1138</span>        if(isset($_GET[$name])) {
</div><div class='line not-executable'><span class='num'>1139</span>            return $_GET[$name];
</div><div class='line not-executable'><span class='num'>1140</span>        }
</div><div class='line not-executable'><span class='num'>1141</span>
</div><div class='line not-covered'><span class='num'>1142</span>        throw new RuntimeException(&quot;param &#039;{$name}&#039; not found&quot;);
</div><div class='line not-covered'><span class='num'>1143</span>    }
</div><div class='line not-covered'><span class='num'>1144</span>
</div><div class='line not-covered'><span class='num'>1145</span>    public function getPath(): string
</div><div class='line not-covered'><span class='num'>1146</span>    {
</div><div class='line not-covered'><span class='num'>1147</span>        $scriptName = $_SERVER[&#039;SCRIPT_NAME&#039;];
</div><div class='line not-executable'><span class='num'>1148</span>        $requestUri = $_SERVER[&#039;REQUEST_URI&#039;];
</div><div class='line not-executable'><span class='num'>1149</span>        $requestUri = strtok($requestUri, &#039;?&#039;);
</div><div class='line not-executable'><span class='num'>1150</span>        $path = str_replace($scriptName, &#039;&#039;, $requestUri);
</div><div class='line not-executable'><span class='num'>1151</span>        return $path;
</div><div class='line not-executable'><span class='num'>1152</span>    }
</div><div class='line not-executable'><span class='num'>1153</span>}
</div><div class='line not-executable'><span class='num'>1154</span>
</div><div class='line not-executable'><span class='num'>1155</span>interface ResponseInterface
</div><div class='line not-executable'><span class='num'>1156</span>{
</div><div class='line not-executable'><span class='num'>1157</span>    public function send(): void;
</div><div class='line not-executable'><span class='num'>1158</span>}
</div><div class='line not-executable'><span class='num'>1159</span>
</div><div class='line not-executable'><span class='num'>1160</span>class Response implements ResponseInterface
</div><div class='line not-executable'><span class='num'>1161</span>{
</div><div class='line not-executable'><span class='num'>1162</span>    public int $code;
</div><div class='line not-executable'><span class='num'>1163</span>    public string $status;
</div><div class='line covered'><span class='num'>1164</span>    public string $message;
</div><div class='line covered'><span class='num'>1165</span>    public array $data;
</div><div class='line covered'><span class='num'>1166</span>
</div><div class='line covered'><span class='num'>1167</span>    public function __construct(int $code, string $status, string $message = &#039;&#039;, array $data)
</div><div class='line covered'><span class='num'>1168</span>    {
</div><div class='line not-executable'><span class='num'>1169</span>        $this-&gt;code = $code;
</div><div class='line not-executable'><span class='num'>1170</span>        $this-&gt;status = $status;
</div><div class='line not-executable'><span class='num'>1171</span>        $this-&gt;message = $message;
</div><div class='line not-covered'><span class='num'>1172</span>        $this-&gt;data = $data;
</div><div class='line not-covered'><span class='num'>1173</span>    }
</div><div class='line not-covered'><span class='num'>1174</span>
</div><div class='line not-covered'><span class='num'>1175</span>    public function send(): void
</div><div class='line not-covered'><span class='num'>1176</span>    {
</div><div class='line not-executable'><span class='num'>1177</span>        header(&#039;Content-Type: application/json; charset=utf-8&#039;);
</div><div class='line not-executable'><span class='num'>1178</span>        http_response_code($this-&gt;code);
</div><div class='line not-executable'><span class='num'>1179</span>        $this-&gt;data = [&#039;code&#039; =&gt; $this-&gt;code, &#039;status&#039; =&gt; $this-&gt;status, &#039;message&#039; =&gt; $this-&gt;message, &#039;data&#039; =&gt; $this-&gt;data];
</div><div class='line not-executable'><span class='num'>1180</span>        echo json_encode($this-&gt;data, JSON_UNESCAPED_UNICODE |  JSON_UNESCAPED_SLASHES |  JSON_PRETTY_PRINT);
</div><div class='line not-executable'><span class='num'>1181</span>    }
</div><div class='line not-executable'><span class='num'>1182</span>}
</div><div class='line covered'><span class='num'>1183</span>
</div><div class='line not-covered'><span class='num'>1184</span>class OKResponse extends Response
</div><div class='line not-executable'><span class='num'>1185</span>{
</div><div class='line not-executable'><span class='num'>1186</span>    public function __construct(string $message, array $data)
</div><div class='line not-executable'><span class='num'>1187</span>    {
</div><div class='line not-executable'><span class='num'>1188</span>        return parent::__construct(200, &#039;success&#039;, $message, $data);
</div><div class='line not-executable'><span class='num'>1189</span>    }
</div><div class='line not-executable'><span class='num'>1190</span>}
</div><div class='line covered'><span class='num'>1191</span>
</div><div class='line not-covered'><span class='num'>1192</span>class CreatedResponse extends Response
</div><div class='line not-executable'><span class='num'>1193</span>{
</div><div class='line not-executable'><span class='num'>1194</span>    public function __construct(string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1195</span>    {
</div><div class='line not-executable'><span class='num'>1196</span>        return parent::__construct(201, &#039;success&#039;, $message, $data);
</div><div class='line not-executable'><span class='num'>1197</span>    }
</div><div class='line not-executable'><span class='num'>1198</span>}
</div><div class='line not-covered'><span class='num'>1199</span>
</div><div class='line not-covered'><span class='num'>1200</span>class BadRequestResponse extends Response
</div><div class='line not-executable'><span class='num'>1201</span>{
</div><div class='line not-executable'><span class='num'>1202</span>    public function __construct(string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1203</span>    {
</div><div class='line not-executable'><span class='num'>1204</span>        return parent::__construct(400, &#039;error&#039;, $message, $data);
</div><div class='line not-executable'><span class='num'>1205</span>    }
</div><div class='line not-executable'><span class='num'>1206</span>}
</div><div class='line not-covered'><span class='num'>1207</span>
</div><div class='line not-covered'><span class='num'>1208</span>class UnauthorizedResponse extends Response
</div><div class='line not-executable'><span class='num'>1209</span>{
</div><div class='line not-executable'><span class='num'>1210</span>    public function __construct(string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1211</span>    {
</div><div class='line not-executable'><span class='num'>1212</span>        return parent::__construct(401, &#039;error&#039;, $message, $data);
</div><div class='line not-executable'><span class='num'>1213</span>    }
</div><div class='line not-executable'><span class='num'>1214</span>}
</div><div class='line not-covered'><span class='num'>1215</span>
</div><div class='line not-covered'><span class='num'>1216</span>class ForbiddenResponse extends Response
</div><div class='line not-executable'><span class='num'>1217</span>{
</div><div class='line not-executable'><span class='num'>1218</span>    public function __construct(string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1219</span>    {
</div><div class='line not-executable'><span class='num'>1220</span>        return parent::__construct(403, &#039;error&#039;, $message, $data);
</div><div class='line not-executable'><span class='num'>1221</span>    }
</div><div class='line not-executable'><span class='num'>1222</span>}
</div><div class='line not-covered'><span class='num'>1223</span>
</div><div class='line not-covered'><span class='num'>1224</span>class NotFoundResponse extends Response
</div><div class='line not-executable'><span class='num'>1225</span>{
</div><div class='line not-executable'><span class='num'>1226</span>    public function __construct(string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1227</span>    {
</div><div class='line not-executable'><span class='num'>1228</span>        return parent::__construct(404, &#039;error&#039;, $message, $data);
</div><div class='line not-executable'><span class='num'>1229</span>    }
</div><div class='line not-executable'><span class='num'>1230</span>}
</div><div class='line not-covered'><span class='num'>1231</span>
</div><div class='line not-covered'><span class='num'>1232</span>class InternalServerErrorResponse extends Response
</div><div class='line not-executable'><span class='num'>1233</span>{
</div><div class='line not-executable'><span class='num'>1234</span>    public function __construct(string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1235</span>    {
</div><div class='line not-executable'><span class='num'>1236</span>        return parent::__construct(500, &#039;error&#039;, $message, $data);
</div><div class='line not-executable'><span class='num'>1237</span>    }
</div><div class='line not-executable'><span class='num'>1238</span>}
</div><div class='line not-executable'><span class='num'>1239</span>
</div><div class='line not-executable'><span class='num'>1240</span>interface GraphControllerInterface
</div><div class='line not-executable'><span class='num'>1241</span>{
</div><div class='line not-executable'><span class='num'>1242</span>    public function getUser(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1243</span>    public function insertUser(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1244</span>    public function updateUser(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1245</span>
</div><div class='line not-executable'><span class='num'>1246</span>    public function getGraph(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1247</span>
</div><div class='line not-executable'><span class='num'>1248</span>    public function getNode(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1249</span>    public function getNodes(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1250</span>    public function insertNode(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1251</span>    public function updateNode(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1252</span>    public function deleteNode(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1253</span>
</div><div class='line not-executable'><span class='num'>1254</span>    public function getEdge(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1255</span>    public function getEdges(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1256</span>    public function insertEdge(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1257</span>    public function updateEdge(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1258</span>    public function deleteEdge(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1259</span>
</div><div class='line not-executable'><span class='num'>1260</span>    public function getStatuses(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1261</span>    public function getNodeStatus(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1262</span>    public function setNodeStatus(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1263</span>
</div><div class='line not-executable'><span class='num'>1264</span>    public function getLogs(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1265</span>}
</div><div class='line not-executable'><span class='num'>1266</span>
</div><div class='line not-executable'><span class='num'>1267</span>final class GraphControllerException extends RuntimeException
</div><div class='line not-executable'><span class='num'>1268</span>{
</div><div class='line not-executable'><span class='num'>1269</span>}
</div><div class='line not-executable'><span class='num'>1270</span>
</div><div class='line not-executable'><span class='num'>1271</span>final class GraphController implements GraphControllerInterface
</div><div class='line not-executable'><span class='num'>1272</span>{
</div><div class='line covered'><span class='num'>1273</span>    private GraphServiceInterface $service;
</div><div class='line covered'><span class='num'>1274</span>    private Logger $logger;
</div><div class='line covered'><span class='num'>1275</span>
</div><div class='line not-executable'><span class='num'>1276</span>    public function __construct(GraphServiceInterface $service, Logger $logger)
</div><div class='line not-executable'><span class='num'>1277</span>    {
</div><div class='line not-executable'><span class='num'>1278</span>        $this-&gt;service = $service;
</div><div class='line not-covered'><span class='num'>1279</span>        $this-&gt;logger = $logger;
</div><div class='line not-covered'><span class='num'>1280</span>    }
</div><div class='line not-covered'><span class='num'>1281</span>
</div><div class='line not-covered'><span class='num'>1282</span>    public function getUser(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1283</span>    {
</div><div class='line not-executable'><span class='num'>1284</span>        $data = $this-&gt;service-&gt;getUser($req-&gt;data[&#039;id&#039;]);
</div><div class='line not-executable'><span class='num'>1285</span>        $user = new User($data[&#039;id&#039;], null, new Group($data[&#039;user_group&#039;]));
</div><div class='line not-covered'><span class='num'>1286</span>        return new OKResponse(&#039;user found&#039;, $user-&gt;toArray());
</div><div class='line not-covered'><span class='num'>1287</span>    }
</div><div class='line not-covered'><span class='num'>1288</span>
</div><div class='line not-covered'><span class='num'>1289</span>    public function insertUser(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1290</span>    {
</div><div class='line not-executable'><span class='num'>1291</span>        $user = new User($req-&gt;data[&#039;id&#039;], null, $req-&gt;data[&#039;user_group&#039;]);
</div><div class='line not-executable'><span class='num'>1292</span>        $this-&gt;service-&gt;insertUser($user);
</div><div class='line not-covered'><span class='num'>1293</span>        return new OKResponse(&#039;user created&#039;, $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1294</span>    }
</div><div class='line not-covered'><span class='num'>1295</span>
</div><div class='line not-covered'><span class='num'>1296</span>    public function updateUser(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1297</span>    {
</div><div class='line not-executable'><span class='num'>1298</span>        $user = new User($req-&gt;data[&#039;id&#039;], null, $req-&gt;data[&#039;user_group&#039;]);
</div><div class='line not-executable'><span class='num'>1299</span>        $this-&gt;service-&gt;updateUser($user);
</div><div class='line not-executable'><span class='num'>1300</span>        return new CreatedResponse(&#039;user updated&#039;, $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1301</span>    }
</div><div class='line not-covered'><span class='num'>1302</span>
</div><div class='line not-covered'><span class='num'>1303</span>    public function getGraph(Request $req): ResponseInterface
</div><div class='line not-covered'><span class='num'>1304</span>    {
</div><div class='line not-covered'><span class='num'>1305</span>        try {
</div><div class='line not-executable'><span class='num'>1306</span>            $data = $this-&gt;service-&gt;getGraph()-&gt;toArray();
</div><div class='line not-executable'><span class='num'>1307</span>            return new OKResponse(&#039;get graph&#039;, $data);
</div><div class='line not-covered'><span class='num'>1308</span>            return $resp;
</div><div class='line not-covered'><span class='num'>1309</span>        } catch (Exception $e) {
</div><div class='line not-executable'><span class='num'>1310</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1311</span>        }
</div><div class='line not-executable'><span class='num'>1312</span>
</div><div class='line not-executable'><span class='num'>1313</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line covered'><span class='num'>1314</span>    }
</div><div class='line covered'><span class='num'>1315</span>
</div><div class='line covered'><span class='num'>1316</span>    public function getNode(Request $req): ResponseInterface
</div><div class='line covered'><span class='num'>1317</span>    {
</div><div class='line not-covered'><span class='num'>1318</span>        try {
</div><div class='line not-executable'><span class='num'>1319</span>            $id = $req-&gt;getParam(&#039;id&#039;);
</div><div class='line not-covered'><span class='num'>1320</span>            $node = $this-&gt;service-&gt;getNode($id);
</div><div class='line not-executable'><span class='num'>1321</span>            $data = $node-&gt;toArray();
</div><div class='line not-executable'><span class='num'>1322</span>            return new OKResponse(&#039;node found&#039;, $data);
</div><div class='line not-covered'><span class='num'>1323</span>        } catch( Exception $e)
</div><div class='line not-covered'><span class='num'>1324</span>        {
</div><div class='line not-executable'><span class='num'>1325</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1326</span>        }
</div><div class='line not-executable'><span class='num'>1327</span>
</div><div class='line not-executable'><span class='num'>1328</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1329</span>    }
</div><div class='line not-executable'><span class='num'>1330</span>
</div><div class='line not-covered'><span class='num'>1331</span>    public function getNodes(Request $req): ResponseInterface
</div><div class='line not-covered'><span class='num'>1332</span>    {
</div><div class='line not-covered'><span class='num'>1333</span>        try {
</div><div class='line not-executable'><span class='num'>1334</span>            $nodes = $this-&gt;service-&gt;getNodes();
</div><div class='line not-covered'><span class='num'>1335</span>            // TODO: corrigir
</div><div class='line not-executable'><span class='num'>1336</span>            return new OKResponse(&#039;nodes found&#039;, []);
</div><div class='line not-executable'><span class='num'>1337</span>            return $resp;
</div><div class='line not-covered'><span class='num'>1338</span>        } catch( Exception $e)
</div><div class='line not-covered'><span class='num'>1339</span>        {
</div><div class='line not-executable'><span class='num'>1340</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1341</span>        }
</div><div class='line not-executable'><span class='num'>1342</span>        
</div><div class='line covered'><span class='num'>1343</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1344</span>    }
</div><div class='line covered'><span class='num'>1345</span>
</div><div class='line covered'><span class='num'>1346</span>    public function insertNode(Request $req): ResponseInterface
</div><div class='line covered'><span class='num'>1347</span>    {
</div><div class='line covered'><span class='num'>1348</span>        $this-&gt;logger-&gt;debug(&#039;inserting node&#039;, $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1349</span>        try {
</div><div class='line not-executable'><span class='num'>1350</span>            $node = new Node($req-&gt;data[&#039;id&#039;], $req-&gt;data[&#039;label&#039;], $req-&gt;data[&#039;category&#039;], $req-&gt;data[&#039;type&#039;], $req-&gt;data[&#039;data&#039;]);
</div><div class='line not-covered'><span class='num'>1351</span>            $this-&gt;service-&gt;insertNode($node);
</div><div class='line not-covered'><span class='num'>1352</span>            $this-&gt;logger-&gt;info(&#039;node inserted&#039;, $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1353</span>            return new CreatedResponse(&#039;node inserted&#039;, $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1354</span>        } catch( GraphServiceException $e)
</div><div class='line not-covered'><span class='num'>1355</span>        {
</div><div class='line not-executable'><span class='num'>1356</span>            $this-&gt;logger-&gt;error(&#039;The service could not insert new node:&#039; . $e-&gt;getMessage());
</div><div class='line not-executable'><span class='num'>1357</span>            throw new GraphControllerException(&#039;The service could not insert new node:&#039; . $e-&gt;getMessage(), 0, $e);
</div><div class='line not-executable'><span class='num'>1358</span>        }
</div><div class='line not-executable'><span class='num'>1359</span>        return new InternalServerErrorResponse(&#039;unknow error inserting node&#039;, $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1360</span>    }
</div><div class='line not-covered'><span class='num'>1361</span>    
</div><div class='line not-covered'><span class='num'>1362</span>    public function updateNode(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1363</span>    {
</div><div class='line not-covered'><span class='num'>1364</span>        try {
</div><div class='line not-executable'><span class='num'>1365</span>            $edge = new Edge($req-&gt;data[&#039;id&#039;], $req-&gt;data[&#039;source&#039;], $req-&gt;data[&#039;target&#039;], $req-&gt;data[&#039;data&#039;]);
</div><div class='line not-executable'><span class='num'>1366</span>            $this-&gt;service-&gt;insertEdge($edge);
</div><div class='line not-covered'><span class='num'>1367</span>        } catch( Exception $e)
</div><div class='line not-covered'><span class='num'>1368</span>        {
</div><div class='line not-executable'><span class='num'>1369</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1370</span>        }
</div><div class='line not-executable'><span class='num'>1371</span>        
</div><div class='line not-executable'><span class='num'>1372</span>        return new InternalServerErrorResponse(&#039;unknow todo in updateNode&#039;, $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1373</span>    }
</div><div class='line not-covered'><span class='num'>1374</span>    
</div><div class='line not-executable'><span class='num'>1375</span>    public function deleteNode(Request $req): ResponseInterface
</div><div class='line not-covered'><span class='num'>1376</span>    {
</div><div class='line not-executable'><span class='num'>1377</span>        try {
</div><div class='line not-executable'><span class='num'>1378</span>            $this-&gt;service-&gt;deleteEdge($req-&gt;data[&#039;id&#039;]);
</div><div class='line not-covered'><span class='num'>1379</span>        } catch( Exception $e)
</div><div class='line not-covered'><span class='num'>1380</span>        {
</div><div class='line not-executable'><span class='num'>1381</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1382</span>        }
</div><div class='line not-executable'><span class='num'>1383</span>        
</div><div class='line not-executable'><span class='num'>1384</span>        return new InternalServerErrorResponse(&#039;unknow todo in deleteNode&#039;, $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1385</span>    }
</div><div class='line not-covered'><span class='num'>1386</span>
</div><div class='line not-covered'><span class='num'>1387</span>    public function getEdge(Request $req): ResponseInterface
</div><div class='line not-covered'><span class='num'>1388</span>    {
</div><div class='line not-executable'><span class='num'>1389</span>        try {
</div><div class='line not-covered'><span class='num'>1390</span>            $edge = $this-&gt;service-&gt;getEdge($req-&gt;data[&#039;source&#039;], $req-&gt;data[&#039;target&#039;]);
</div><div class='line not-executable'><span class='num'>1391</span>            $data = $edge-&gt;toArray();
</div><div class='line not-executable'><span class='num'>1392</span>            return new OKResponse(&#039;node found&#039;, $data);
</div><div class='line not-covered'><span class='num'>1393</span>        } catch( Exception $e)
</div><div class='line not-covered'><span class='num'>1394</span>        {
</div><div class='line not-executable'><span class='num'>1395</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1396</span>        }
</div><div class='line not-executable'><span class='num'>1397</span>        
</div><div class='line not-executable'><span class='num'>1398</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1399</span>    }
</div><div class='line not-executable'><span class='num'>1400</span>    
</div><div class='line not-covered'><span class='num'>1401</span>    public function getEdges(Request $req): ResponseInterface
</div><div class='line not-covered'><span class='num'>1402</span>    {
</div><div class='line not-executable'><span class='num'>1403</span>        try {
</div><div class='line not-covered'><span class='num'>1404</span>            $edges = $this-&gt;service-&gt;getEdges();
</div><div class='line not-executable'><span class='num'>1405</span>            // TODO: corrigir
</div><div class='line not-executable'><span class='num'>1406</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1407</span>        } catch( Exception $e)
</div><div class='line not-covered'><span class='num'>1408</span>        {
</div><div class='line not-executable'><span class='num'>1409</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1410</span>        }
</div><div class='line not-executable'><span class='num'>1411</span>        
</div><div class='line not-executable'><span class='num'>1412</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1413</span>    }
</div><div class='line not-covered'><span class='num'>1414</span>    
</div><div class='line not-covered'><span class='num'>1415</span>    public function insertEdge(Request $req): ResponseInterface
</div><div class='line not-covered'><span class='num'>1416</span>    {
</div><div class='line not-executable'><span class='num'>1417</span>        try {
</div><div class='line not-covered'><span class='num'>1418</span>            $edge = new Edge(null, $req-&gt;data[&#039;source&#039;], $req-&gt;data[&#039;target&#039;]);
</div><div class='line not-executable'><span class='num'>1419</span>            $this-&gt;service-&gt;insertEdge($edge);
</div><div class='line not-executable'><span class='num'>1420</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1421</span>        } catch( Exception $e)
</div><div class='line not-covered'><span class='num'>1422</span>        {
</div><div class='line not-executable'><span class='num'>1423</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1424</span>        }
</div><div class='line not-executable'><span class='num'>1425</span>        
</div><div class='line not-executable'><span class='num'>1426</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1427</span>    }
</div><div class='line not-covered'><span class='num'>1428</span>    
</div><div class='line not-covered'><span class='num'>1429</span>    public function updateEdge(Request $req): ResponseInterface
</div><div class='line not-covered'><span class='num'>1430</span>    {
</div><div class='line not-executable'><span class='num'>1431</span>        try {
</div><div class='line not-covered'><span class='num'>1432</span>            $edge = new Edge($req-&gt;data[&#039;id&#039;], $req-&gt;data[&#039;source&#039;], $req-&gt;data[&#039;target&#039;], $req-&gt;data[&#039;data&#039;]);
</div><div class='line not-executable'><span class='num'>1433</span>            $this-&gt;service-&gt;updateEdge($edge);
</div><div class='line not-executable'><span class='num'>1434</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1435</span>        } catch( Exception $e)
</div><div class='line not-covered'><span class='num'>1436</span>        {
</div><div class='line not-executable'><span class='num'>1437</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1438</span>        }
</div><div class='line not-executable'><span class='num'>1439</span>        
</div><div class='line not-executable'><span class='num'>1440</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1441</span>    }
</div><div class='line not-covered'><span class='num'>1442</span>    
</div><div class='line not-covered'><span class='num'>1443</span>    public function deleteEdge(Request $req): ResponseInterface
</div><div class='line not-covered'><span class='num'>1444</span>    {
</div><div class='line not-executable'><span class='num'>1445</span>        try {
</div><div class='line not-covered'><span class='num'>1446</span>            $id = $req-&gt;data[&#039;id&#039;];
</div><div class='line not-executable'><span class='num'>1447</span>            $this-&gt;service-&gt;deleteEdge($id);
</div><div class='line not-executable'><span class='num'>1448</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1449</span>        } catch( Exception $e)
</div><div class='line not-covered'><span class='num'>1450</span>        {
</div><div class='line not-executable'><span class='num'>1451</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1452</span>        }
</div><div class='line not-executable'><span class='num'>1453</span>        
</div><div class='line not-executable'><span class='num'>1454</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1455</span>    }
</div><div class='line not-covered'><span class='num'>1456</span>
</div><div class='line not-covered'><span class='num'>1457</span>    public function getStatuses(Request $req): ResponseInterface
</div><div class='line not-covered'><span class='num'>1458</span>    {
</div><div class='line not-executable'><span class='num'>1459</span>        try {
</div><div class='line not-covered'><span class='num'>1460</span>            $statuses = $this-&gt;service-&gt;getStatuses();
</div><div class='line not-executable'><span class='num'>1461</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-executable'><span class='num'>1462</span>            return $resp;
</div><div class='line not-covered'><span class='num'>1463</span>        } catch( Exception $e)
</div><div class='line not-covered'><span class='num'>1464</span>        {
</div><div class='line not-executable'><span class='num'>1465</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1466</span>        }
</div><div class='line not-executable'><span class='num'>1467</span>        
</div><div class='line not-executable'><span class='num'>1468</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1469</span>    }
</div><div class='line not-covered'><span class='num'>1470</span>    
</div><div class='line not-covered'><span class='num'>1471</span>    public function getNodeStatus(Request $req): ResponseInterface
</div><div class='line not-covered'><span class='num'>1472</span>    {
</div><div class='line not-executable'><span class='num'>1473</span>        try {
</div><div class='line not-covered'><span class='num'>1474</span>            $status = $this-&gt;service-&gt;getNodeStatus($req-&gt;data[&#039;id&#039;]);
</div><div class='line not-executable'><span class='num'>1475</span>            $data = $status-&gt;toArray();
</div><div class='line not-executable'><span class='num'>1476</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1477</span>        } catch( Exception $e)
</div><div class='line not-covered'><span class='num'>1478</span>        {
</div><div class='line not-executable'><span class='num'>1479</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1480</span>        }
</div><div class='line not-executable'><span class='num'>1481</span>        
</div><div class='line not-executable'><span class='num'>1482</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1483</span>    }
</div><div class='line not-covered'><span class='num'>1484</span>    
</div><div class='line not-covered'><span class='num'>1485</span>    public function setNodeStatus(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1486</span>    {
</div><div class='line not-covered'><span class='num'>1487</span>        try {
</div><div class='line not-executable'><span class='num'>1488</span>            $status = new NodeStatus($req-&gt;data[&#039;node_id&#039;], $req-&gt;data[&#039;status&#039;]);
</div><div class='line not-executable'><span class='num'>1489</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1490</span>        } catch( Exception $e)
</div><div class='line not-covered'><span class='num'>1491</span>        {
</div><div class='line not-executable'><span class='num'>1492</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1493</span>        }
</div><div class='line not-executable'><span class='num'>1494</span>        
</div><div class='line not-executable'><span class='num'>1495</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1496</span>    }
</div><div class='line not-covered'><span class='num'>1497</span>
</div><div class='line not-covered'><span class='num'>1498</span>    public function getLogs(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1499</span>    {
</div><div class='line not-covered'><span class='num'>1500</span>        try {
</div><div class='line not-executable'><span class='num'>1501</span>            $logs = $this-&gt;service-&gt;getLogs($req-&gt;getParam(&#039;limit&#039;));
</div><div class='line not-executable'><span class='num'>1502</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1503</span>        } catch( Exception $e)
</div><div class='line not-covered'><span class='num'>1504</span>        {
</div><div class='line not-executable'><span class='num'>1505</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1506</span>        }
</div><div class='line not-executable'><span class='num'>1507</span>        
</div><div class='line not-executable'><span class='num'>1508</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1509</span>    }
</div><div class='line not-executable'><span class='num'>1510</span>}
</div><div class='line not-executable'><span class='num'>1511</span>
</div><div class='line not-executable'><span class='num'>1512</span>final class RequestRouter
</div><div class='line not-executable'><span class='num'>1513</span>{
</div><div class='line not-executable'><span class='num'>1514</span>    private $routes = [
</div><div class='line not-executable'><span class='num'>1515</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getGraph&#039;, &#039;class_method&#039; =&gt; &#039;getGraph&#039;],
</div><div class='line not-executable'><span class='num'>1516</span>        
</div><div class='line not-executable'><span class='num'>1517</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getNode&#039;, &#039;class_method&#039; =&gt; &#039;getNode&#039;],
</div><div class='line not-executable'><span class='num'>1518</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getNodes&#039;, &#039;class_method&#039; =&gt; &#039;getNodes&#039;],
</div><div class='line not-executable'><span class='num'>1519</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/insertNode&#039;, &#039;class_method&#039; =&gt; &#039;insertNode&#039;],
</div><div class='line not-executable'><span class='num'>1520</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/updateNode&#039;, &#039;class_method&#039; =&gt; &#039;updateNode&#039;],
</div><div class='line not-executable'><span class='num'>1521</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/deleteNode&#039;, &#039;class_method&#039; =&gt; &#039;deleteNode&#039;],
</div><div class='line not-executable'><span class='num'>1522</span>
</div><div class='line not-executable'><span class='num'>1523</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getEdge&#039;, &#039;class_method&#039; =&gt; &#039;getEdge&#039;],
</div><div class='line not-executable'><span class='num'>1524</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getEdges&#039;, &#039;class_method&#039; =&gt; &#039;getEdges&#039;],
</div><div class='line not-executable'><span class='num'>1525</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/insertEdge&#039;, &#039;class_method&#039; =&gt; &#039;insertEdge&#039;],
</div><div class='line not-executable'><span class='num'>1526</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/updateEdge&#039;, &#039;class_method&#039; =&gt; &#039;updateEdge&#039;],
</div><div class='line not-executable'><span class='num'>1527</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/deleteEdge&#039;, &#039;class_method&#039; =&gt; &#039;deleteEdge&#039;],
</div><div class='line not-executable'><span class='num'>1528</span>
</div><div class='line not-executable'><span class='num'>1529</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getStatuses&#039;, &#039;class_method&#039; =&gt; &#039;getStatuses&#039;],
</div><div class='line not-executable'><span class='num'>1530</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getNodeStatus&#039;, &#039;class_method&#039; =&gt; &#039;getNodeStatus&#039;],
</div><div class='line not-executable'><span class='num'>1531</span>
</div><div class='line not-executable'><span class='num'>1532</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getLogs&#039;, &#039;class_method&#039; =&gt; &#039;getLogs&#039;],
</div><div class='line not-executable'><span class='num'>1533</span>
</div><div class='line not-executable'><span class='num'>1534</span>        ];
</div><div class='line not-covered'><span class='num'>1535</span>
</div><div class='line not-covered'><span class='num'>1536</span>    public GraphController $controller;
</div><div class='line not-executable'><span class='num'>1537</span>    
</div><div class='line not-executable'><span class='num'>1538</span>    public function __construct(GraphController $controller)
</div><div class='line not-executable'><span class='num'>1539</span>    {
</div><div class='line not-covered'><span class='num'>1540</span>        $this-&gt;controller = $controller;
</div><div class='line not-executable'><span class='num'>1541</span>    }
</div><div class='line not-covered'><span class='num'>1542</span>
</div><div class='line not-covered'><span class='num'>1543</span>    public function handle(): void
</div><div class='line not-covered'><span class='num'>1544</span>    {
</div><div class='line not-executable'><span class='num'>1545</span>        $method = $_SERVER[&#039;REQUEST_METHOD&#039;];
</div><div class='line not-covered'><span class='num'>1546</span>
</div><div class='line not-executable'><span class='num'>1547</span>        $scriptName = $_SERVER[&#039;SCRIPT_NAME&#039;];
</div><div class='line not-covered'><span class='num'>1548</span>        $requestUri = $_SERVER[&#039;REQUEST_URI&#039;];
</div><div class='line not-executable'><span class='num'>1549</span>        $requestUri = strtok($requestUri, &#039;?&#039;);
</div><div class='line not-covered'><span class='num'>1550</span>        
</div><div class='line not-executable'><span class='num'>1551</span>        $path = str_replace($scriptName, &#039;&#039;, $requestUri);
</div><div class='line not-covered'><span class='num'>1552</span>        
</div><div class='line not-executable'><span class='num'>1553</span>        $req = new Request();
</div><div class='line not-covered'><span class='num'>1554</span>
</div><div class='line not-covered'><span class='num'>1555</span>        foreach($this-&gt;routes as $route)
</div><div class='line not-covered'><span class='num'>1556</span>        {
</div><div class='line not-covered'><span class='num'>1557</span>            if ($route[&#039;method&#039;] == $method &amp;&amp; $route[&#039;path&#039;] == $path)
</div><div class='line not-executable'><span class='num'>1558</span>            {
</div><div class='line not-executable'><span class='num'>1559</span>                $method = $route[&#039;class_method&#039;];
</div><div class='line not-covered'><span class='num'>1560</span>                $resp = $this-&gt;controller-&gt;$method($req);
</div><div class='line not-executable'><span class='num'>1561</span>                print_r($resp);
</div><div class='line not-executable'><span class='num'>1562</span>                exit();
</div><div class='line not-executable'><span class='num'>1563</span>            }
</div><div class='line not-executable'><span class='num'>1564</span>        }
</div><div class='line not-executable'><span class='num'>1565</span>    }
</div><div class='line not-executable'><span class='num'>1566</span>}
</div><div class='line not-executable'><span class='num'>1567</span>
</div><div class='line not-executable'><span class='num'>1568</span>
</div></body></html><html><head><meta charset='UTF-8'><style>
body { font-family: monospace; font-size: 12px; background: #222; color: #ddd; margin: 0; }
.covered { background: #1a4d1a; }
.not-covered { background: #4d1a1a; }
.not-executable { background: #2a2a2a; color: #666; }
.line { padding: 2px 10px; white-space: pre; border-left: 3px solid transparent; }
.covered { border-left-color: #0f0; }
.not-covered { border-left-color: #f00; }
.num { color: #666; width: 50px; display: inline-block; text-align: right; margin-right: 10px; }
h2 { background: #333; padding: 10px; margin: 20px 0 0 0; position: sticky; top: 0; }
</style></head><body><h2>/home/tarcisio/projects/graph/tests.php - 75.86% (44/58)</h2><div class='line not-executable'><span class='num'>1</span>&lt;?php
</div><div class='line not-executable'><span class='num'>2</span>
</div><div class='line not-executable'><span class='num'>3</span>declare(strict_types=1);
</div><div class='line not-executable'><span class='num'>4</span>
</div><div class='line not-executable'><span class='num'>5</span>require_once __DIR__ . &#039;/graph.php&#039;;
</div><div class='line not-executable'><span class='num'>6</span>
</div><div class='line not-executable'><span class='num'>7</span>ini_set(&#039;xdebug.mode&#039;, &#039;1&#039;);
</div><div class='line not-executable'><span class='num'>8</span>xdebug_start_code_coverage(XDEBUG_CC_UNUSED | XDEBUG_CC_DEAD_CODE);
</div><div class='line not-executable'><span class='num'>9</span>
</div><div class='line not-executable'><span class='num'>10</span>function array_diff_recursive($array1, $array2) {
</div><div class='line covered'><span class='num'>11</span>    $diff = [];
</div><div class='line not-executable'><span class='num'>12</span>    
</div><div class='line covered'><span class='num'>13</span>    foreach ($array1 as $key =&gt; $value) {
</div><div class='line covered'><span class='num'>14</span>        if (!array_key_exists($key, $array2)) {
</div><div class='line not-covered'><span class='num'>15</span>            $diff[$key] = $value;
</div><div class='line covered'><span class='num'>16</span>        } elseif (is_array($value)) {
</div><div class='line covered'><span class='num'>17</span>            if (!is_array($array2[$key])) {
</div><div class='line not-covered'><span class='num'>18</span>                $diff[$key] = $value;
</div><div class='line not-executable'><span class='num'>19</span>            } else {
</div><div class='line covered'><span class='num'>20</span>                $recursiveDiff = array_diff_recursive($value, $array2[$key]);
</div><div class='line covered'><span class='num'>21</span>                if (count($recursiveDiff)) {
</div><div class='line not-covered'><span class='num'>22</span>                    $diff[$key] = $recursiveDiff;
</div><div class='line not-executable'><span class='num'>23</span>                }
</div><div class='line not-executable'><span class='num'>24</span>            }
</div><div class='line covered'><span class='num'>25</span>        } elseif ($value !== $array2[$key]) {
</div><div class='line not-covered'><span class='num'>26</span>            $diff[$key] = $value;
</div><div class='line not-executable'><span class='num'>27</span>        }
</div><div class='line not-executable'><span class='num'>28</span>    }
</div><div class='line not-executable'><span class='num'>29</span>    
</div><div class='line covered'><span class='num'>30</span>    return $diff;
</div><div class='line not-covered'><span class='num'>31</span>}
</div><div class='line not-executable'><span class='num'>32</span>
</div><div class='line not-executable'><span class='num'>33</span>function get_test_graph_controller()
</div><div class='line not-executable'><span class='num'>34</span>{
</div><div class='line covered'><span class='num'>35</span>    GraphContext::$user = new User(&#039;test_user&#039;, &#039;127.0.0.1&#039;, new Group(&#039;contributor&#039;));
</div><div class='line covered'><span class='num'>36</span>    $pdo = GraphDatabase::createConnection(&#039;sqlite::memory:&#039;);
</div><div class='line covered'><span class='num'>37</span>    $databaseLogger = new Logger(&#039;database.log&#039;);
</div><div class='line not-executable'><span class='num'>38</span>
</div><div class='line covered'><span class='num'>39</span>    $graphDb = new GraphDatabase($pdo, $databaseLogger);
</div><div class='line not-executable'><span class='num'>40</span>
</div><div class='line covered'><span class='num'>41</span>    $serviceLogger = new Logger(&#039;service.log&#039;);
</div><div class='line covered'><span class='num'>42</span>    $graphService = new GraphService($graphDb, $serviceLogger);
</div><div class='line not-executable'><span class='num'>43</span>
</div><div class='line covered'><span class='num'>44</span>    $controllerLogger = new Logger(&#039;controller.log&#039;);
</div><div class='line covered'><span class='num'>45</span>    $graphController = new GraphController($graphService, $controllerLogger);
</div><div class='line not-executable'><span class='num'>46</span>    
</div><div class='line covered'><span class='num'>47</span>    return $graphController;
</div><div class='line not-covered'><span class='num'>48</span>}
</div><div class='line not-executable'><span class='num'>49</span>
</div><div class='line not-executable'><span class='num'>50</span>function test_node_good_path()
</div><div class='line not-executable'><span class='num'>51</span>{
</div><div class='line covered'><span class='num'>52</span>    $graphController = get_test_graph_controller();
</div><div class='line covered'><span class='num'>53</span>    $insertNodeReq = new Request();
</div><div class='line covered'><span class='num'>54</span>    $insertNodeReq-&gt;data = [&#039;id&#039; =&gt; &#039;node1&#039;, &#039;label&#039; =&gt; &#039;node1&#039;, &#039;category&#039; =&gt; &#039;business&#039;, &#039;type&#039; =&gt; &#039;server&#039;, &#039;data&#039; =&gt; [&#039;info&#039; =&gt; &#039;first node&#039;]];
</div><div class='line covered'><span class='num'>55</span>    $resp = $graphController-&gt;insertNode($insertNodeReq);
</div><div class='line not-executable'><span class='num'>56</span>    
</div><div class='line covered'><span class='num'>57</span>    $expected = [
</div><div class='line not-executable'><span class='num'>58</span>        &#039;id&#039;       =&gt; &#039;node1&#039;,
</div><div class='line not-executable'><span class='num'>59</span>        &#039;label&#039;    =&gt; &#039;node1&#039;,
</div><div class='line not-executable'><span class='num'>60</span>        &#039;category&#039; =&gt; &#039;business&#039;,
</div><div class='line not-executable'><span class='num'>61</span>        &#039;type&#039; =&gt; &#039;server&#039;,
</div><div class='line not-executable'><span class='num'>62</span>        &#039;data&#039; =&gt; [
</div><div class='line not-executable'><span class='num'>63</span>                &#039;info&#039; =&gt; &#039;first node&#039;
</div><div class='line not-executable'><span class='num'>64</span>        ]
</div><div class='line not-executable'><span class='num'>65</span>    ];
</div><div class='line not-executable'><span class='num'>66</span>
</div><div class='line covered'><span class='num'>67</span>    if($resp-&gt;code != 201) {
</div><div class='line not-covered'><span class='num'>68</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>69</span>    }
</div><div class='line not-executable'><span class='num'>70</span>
</div><div class='line covered'><span class='num'>71</span>    if($resp-&gt;status != &#039;success&#039;) {
</div><div class='line not-covered'><span class='num'>72</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>73</span>    }
</div><div class='line not-executable'><span class='num'>74</span>
</div><div class='line covered'><span class='num'>75</span>    if ($resp-&gt;message != &#039;node inserted&#039;) {
</div><div class='line not-covered'><span class='num'>76</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>77</span>    }
</div><div class='line not-executable'><span class='num'>78</span>
</div><div class='line covered'><span class='num'>79</span>    $diff = array_diff_recursive($resp-&gt;data, $expected);
</div><div class='line covered'><span class='num'>80</span>    if (! empty($diff)) {
</div><div class='line not-covered'><span class='num'>81</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>82</span>    }
</div><div class='line not-executable'><span class='num'>83</span>
</div><div class='line covered'><span class='num'>84</span>    $_GET[&#039;id&#039;] = &#039;node1&#039;;
</div><div class='line covered'><span class='num'>85</span>    $req = new Request();
</div><div class='line covered'><span class='num'>86</span>    $resp = $graphController-&gt;getNode($req);
</div><div class='line not-executable'><span class='num'>87</span>
</div><div class='line covered'><span class='num'>88</span>    if ($resp-&gt;code != 200) {
</div><div class='line not-covered'><span class='num'>89</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>90</span>    }
</div><div class='line not-executable'><span class='num'>91</span>
</div><div class='line covered'><span class='num'>92</span>    if($resp-&gt;status != &#039;success&#039;) {
</div><div class='line not-covered'><span class='num'>93</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>94</span>    }
</div><div class='line not-executable'><span class='num'>95</span>
</div><div class='line covered'><span class='num'>96</span>    if ($resp-&gt;message != &#039;node found&#039;) {
</div><div class='line not-covered'><span class='num'>97</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>98</span>    }
</div><div class='line not-executable'><span class='num'>99</span>
</div><div class='line covered'><span class='num'>100</span>    $expected = [
</div><div class='line not-executable'><span class='num'>101</span>        &#039;info&#039;     =&gt; &#039;first node&#039;,
</div><div class='line not-executable'><span class='num'>102</span>        &#039;id&#039;       =&gt; &#039;node1&#039;,
</div><div class='line not-executable'><span class='num'>103</span>        &#039;label&#039;    =&gt; &#039;node1&#039;,
</div><div class='line not-executable'><span class='num'>104</span>        &#039;category&#039; =&gt; &#039;business&#039;,
</div><div class='line not-executable'><span class='num'>105</span>        &#039;type&#039;     =&gt; &#039;server&#039;,
</div><div class='line not-executable'><span class='num'>106</span>    ];
</div><div class='line not-executable'><span class='num'>107</span>
</div><div class='line covered'><span class='num'>108</span>    $diff = array_diff_recursive($resp-&gt;data[&#039;data&#039;], $expected);
</div><div class='line covered'><span class='num'>109</span>    if (! empty($diff)) {
</div><div class='line not-covered'><span class='num'>110</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>111</span>    }
</div><div class='line covered'><span class='num'>112</span>    echo &quot;fim&quot;;
</div><div class='line covered'><span class='num'>113</span>}
</div><div class='line not-executable'><span class='num'>114</span>
</div><div class='line not-executable'><span class='num'>115</span>function tests() {
</div><div class='line covered'><span class='num'>116</span>    test_node_good_path();
</div><div class='line covered'><span class='num'>117</span>    echo &quot;fim&quot;;
</div><div class='line covered'><span class='num'>118</span>}
</div><div class='line not-executable'><span class='num'>119</span>
</div><div class='line covered'><span class='num'>120</span>tests();
</div><div class='line not-executable'><span class='num'>121</span>
</div><div class='line covered'><span class='num'>122</span>$coverage = xdebug_get_code_coverage();
</div><div class='line not-executable'><span class='num'>123</span>xdebug_stop_code_coverage();
</div><div class='line not-executable'><span class='num'>124</span>
</div><div class='line not-executable'><span class='num'>125</span>// Salvar em arquivo
</div><div class='line not-executable'><span class='num'>126</span>file_put_contents(&#039;coverage.json&#039;, json_encode($coverage, JSON_PRETTY_PRINT));
</div><div class='line not-executable'><span class='num'>127</span>
</div><div class='line not-executable'><span class='num'>128</span>echo &#039;fim&#039;;</div><h2>/home/tarcisio/projects/graph/graph.php - 23.89% (151/632)</h2><div class='line not-executable'><span class='num'>1</span>&lt;?php
</div><div class='line not-executable'><span class='num'>2</span>
</div><div class='line not-executable'><span class='num'>3</span>declare(strict_types=1);
</div><div class='line not-executable'><span class='num'>4</span>
</div><div class='line not-executable'><span class='num'>5</span>final class User
</div><div class='line not-executable'><span class='num'>6</span>{
</div><div class='line not-executable'><span class='num'>7</span>    public string $id;
</div><div class='line not-executable'><span class='num'>8</span>    public ?string $ipAddress;
</div><div class='line not-executable'><span class='num'>9</span>    public Group $group;
</div><div class='line not-executable'><span class='num'>10</span>
</div><div class='line not-executable'><span class='num'>11</span>    public function __construct(string $id, ?string $ipAddress, Group $group)
</div><div class='line not-executable'><span class='num'>12</span>    {
</div><div class='line covered'><span class='num'>13</span>        $this-&gt;id = $id;
</div><div class='line covered'><span class='num'>14</span>        $this-&gt;ipAddress = $ipAddress;
</div><div class='line covered'><span class='num'>15</span>        $this-&gt;group = $group;
</div><div class='line covered'><span class='num'>16</span>    }
</div><div class='line not-executable'><span class='num'>17</span>
</div><div class='line not-executable'><span class='num'>18</span>    public function toArray(): array
</div><div class='line not-executable'><span class='num'>19</span>    {
</div><div class='line not-executable'><span class='num'>20</span>        return [
</div><div class='line not-covered'><span class='num'>21</span>            &#039;id&#039; =&gt; $this-&gt;id,
</div><div class='line not-executable'><span class='num'>22</span>            &#039;group&#039; =&gt; [
</div><div class='line not-covered'><span class='num'>23</span>                &#039;id&#039; =&gt; $this-&gt;group-&gt;id,
</div><div class='line not-executable'><span class='num'>24</span>            ],
</div><div class='line not-executable'><span class='num'>25</span>        ];
</div><div class='line not-covered'><span class='num'>26</span>    }
</div><div class='line not-executable'><span class='num'>27</span>}
</div><div class='line not-executable'><span class='num'>28</span>
</div><div class='line not-executable'><span class='num'>29</span>final class Group
</div><div class='line not-executable'><span class='num'>30</span>{
</div><div class='line not-executable'><span class='num'>31</span>    private const ALLOWED_GROUPS = [&#039;anonymous&#039;, &#039;consumer&#039;, &#039;contributor&#039;, &#039;admin&#039;];
</div><div class='line not-executable'><span class='num'>32</span>    
</div><div class='line not-executable'><span class='num'>33</span>    public string $id;
</div><div class='line not-executable'><span class='num'>34</span>    
</div><div class='line not-executable'><span class='num'>35</span>    public function __construct(string $id)
</div><div class='line not-executable'><span class='num'>36</span>    {
</div><div class='line covered'><span class='num'>37</span>        if (!in_array($id, self::ALLOWED_GROUPS, true)) {
</div><div class='line not-covered'><span class='num'>38</span>            throw new InvalidArgumentException(&quot;Invalid user group: {$id}&quot;);
</div><div class='line not-executable'><span class='num'>39</span>        }
</div><div class='line covered'><span class='num'>40</span>        $this-&gt;id  = $id;
</div><div class='line covered'><span class='num'>41</span>    }
</div><div class='line not-executable'><span class='num'>42</span>}
</div><div class='line not-executable'><span class='num'>43</span>
</div><div class='line not-executable'><span class='num'>44</span>final class Graph
</div><div class='line not-executable'><span class='num'>45</span>{
</div><div class='line not-executable'><span class='num'>46</span>    public array $nodes = [];
</div><div class='line not-executable'><span class='num'>47</span>    public array $edges = [];
</div><div class='line not-executable'><span class='num'>48</span>    public array $data  = [];
</div><div class='line not-executable'><span class='num'>49</span>    public array $layout = [];
</div><div class='line not-executable'><span class='num'>50</span>    public array $styles = [];
</div><div class='line not-executable'><span class='num'>51</span>
</div><div class='line not-executable'><span class='num'>52</span>    public function __construct(array $nodes, array $edges)
</div><div class='line not-executable'><span class='num'>53</span>    {
</div><div class='line not-covered'><span class='num'>54</span>        $this-&gt;nodes = $nodes;
</div><div class='line not-covered'><span class='num'>55</span>        $this-&gt;edges = $edges;
</div><div class='line not-covered'><span class='num'>56</span>    }
</div><div class='line not-executable'><span class='num'>57</span>
</div><div class='line not-executable'><span class='num'>58</span>    public function toArray(): array
</div><div class='line not-executable'><span class='num'>59</span>    {
</div><div class='line not-executable'><span class='num'>60</span>        return [
</div><div class='line not-covered'><span class='num'>61</span>            &#039;nodes&#039; =&gt; $this-&gt;nodes,
</div><div class='line not-covered'><span class='num'>62</span>            &#039;edges&#039; =&gt; $this-&gt;edges,
</div><div class='line not-covered'><span class='num'>63</span>            &#039;data&#039; =&gt; $this-&gt;data,
</div><div class='line not-covered'><span class='num'>64</span>            &#039;layout&#039; =&gt; $this-&gt;layout,
</div><div class='line not-covered'><span class='num'>65</span>            &#039;styles&#039; =&gt; $this-&gt;styles,
</div><div class='line not-executable'><span class='num'>66</span>        ];
</div><div class='line not-covered'><span class='num'>67</span>    }
</div><div class='line not-executable'><span class='num'>68</span>}
</div><div class='line not-executable'><span class='num'>69</span>
</div><div class='line not-executable'><span class='num'>70</span>final class Node
</div><div class='line not-executable'><span class='num'>71</span>{
</div><div class='line not-executable'><span class='num'>72</span>    private const ALLOWED_CATEGORIES  = [&#039;business&#039;, &#039;application&#039;, &#039;infrastructure&#039;];
</div><div class='line not-executable'><span class='num'>73</span>    private const ALLOWED_TYPES       = [&#039;server&#039;, &#039;database&#039;, &#039;application&#039;, &#039;network&#039;];
</div><div class='line not-executable'><span class='num'>74</span>    private const ID_VALIDATION_REGEX = &#039;/^[a-zA-Z0-9\-_]+$/&#039;;
</div><div class='line not-executable'><span class='num'>75</span>    private const LABEL_MAX_LENGTH    = 20;
</div><div class='line not-executable'><span class='num'>76</span>    
</div><div class='line not-executable'><span class='num'>77</span>    public string $id;
</div><div class='line not-executable'><span class='num'>78</span>    public string $label;
</div><div class='line not-executable'><span class='num'>79</span>    public string $category;
</div><div class='line not-executable'><span class='num'>80</span>    public string $type;
</div><div class='line not-executable'><span class='num'>81</span>
</div><div class='line not-executable'><span class='num'>82</span>    public array $data = [];
</div><div class='line not-executable'><span class='num'>83</span>
</div><div class='line not-executable'><span class='num'>84</span>    public function __construct(string $id, string $label, string $category, string $type, array $data)
</div><div class='line not-executable'><span class='num'>85</span>    {
</div><div class='line covered'><span class='num'>86</span>        $this-&gt;validate($id, $label, $category, $type);
</div><div class='line covered'><span class='num'>87</span>        $this-&gt;id       = $id;
</div><div class='line covered'><span class='num'>88</span>        $this-&gt;label    = $label;
</div><div class='line covered'><span class='num'>89</span>        $this-&gt;category = $category;
</div><div class='line covered'><span class='num'>90</span>        $this-&gt;type     = $type;
</div><div class='line covered'><span class='num'>91</span>        $this-&gt;data     = $data;
</div><div class='line covered'><span class='num'>92</span>    }
</div><div class='line not-executable'><span class='num'>93</span>
</div><div class='line not-executable'><span class='num'>94</span>    private function validate(string $id, string $label, string $category, string $type): void
</div><div class='line not-executable'><span class='num'>95</span>    {
</div><div class='line covered'><span class='num'>96</span>        if (!preg_match(self::ID_VALIDATION_REGEX, $id)) {
</div><div class='line not-covered'><span class='num'>97</span>            throw new InvalidArgumentException(&quot;Invalid node ID: {$id}&quot;);
</div><div class='line not-executable'><span class='num'>98</span>        }
</div><div class='line not-executable'><span class='num'>99</span>
</div><div class='line covered'><span class='num'>100</span>        if (strlen($label) &gt; self::LABEL_MAX_LENGTH) {
</div><div class='line not-covered'><span class='num'>101</span>            throw new InvalidArgumentException(&quot;Node label exceeds maximum length of &quot; . self::LABEL_MAX_LENGTH);
</div><div class='line not-executable'><span class='num'>102</span>        }
</div><div class='line not-executable'><span class='num'>103</span>
</div><div class='line covered'><span class='num'>104</span>        if (!in_array($category, self::ALLOWED_CATEGORIES, true)) {
</div><div class='line not-covered'><span class='num'>105</span>            throw new InvalidArgumentException(&quot;Invalid node category: {$category}&quot;);
</div><div class='line not-executable'><span class='num'>106</span>        }
</div><div class='line not-executable'><span class='num'>107</span>
</div><div class='line covered'><span class='num'>108</span>        if (!in_array($type, self::ALLOWED_TYPES, true)) {
</div><div class='line not-covered'><span class='num'>109</span>            throw new InvalidArgumentException(&quot;Invalid node type: {$type}&quot;);
</div><div class='line not-executable'><span class='num'>110</span>        }
</div><div class='line covered'><span class='num'>111</span>    }
</div><div class='line not-executable'><span class='num'>112</span>
</div><div class='line not-executable'><span class='num'>113</span>    public function toArray(): array
</div><div class='line not-executable'><span class='num'>114</span>    {
</div><div class='line not-executable'><span class='num'>115</span>        return [
</div><div class='line covered'><span class='num'>116</span>            &#039;id&#039;       =&gt; $this-&gt;id,
</div><div class='line covered'><span class='num'>117</span>            &#039;label&#039;    =&gt; $this-&gt;label,
</div><div class='line covered'><span class='num'>118</span>            &#039;category&#039; =&gt; $this-&gt;category,
</div><div class='line covered'><span class='num'>119</span>            &#039;type&#039;     =&gt; $this-&gt;type,
</div><div class='line covered'><span class='num'>120</span>            &#039;data&#039;     =&gt; $this-&gt;data
</div><div class='line not-executable'><span class='num'>121</span>        ];
</div><div class='line not-covered'><span class='num'>122</span>    }
</div><div class='line not-executable'><span class='num'>123</span>}
</div><div class='line not-executable'><span class='num'>124</span>
</div><div class='line not-executable'><span class='num'>125</span>final class NodeStatus
</div><div class='line not-executable'><span class='num'>126</span>{
</div><div class='line not-executable'><span class='num'>127</span>    private const ALLOWED_NODE_STATUSES = [&#039;unknown&#039;, &#039;healthy&#039;, &#039;unhealthy&#039;, &#039;maintenance&#039;];
</div><div class='line not-executable'><span class='num'>128</span>
</div><div class='line not-executable'><span class='num'>129</span>    public string $nodeId;
</div><div class='line not-executable'><span class='num'>130</span>    public string $status;
</div><div class='line not-executable'><span class='num'>131</span>
</div><div class='line not-executable'><span class='num'>132</span>    public function __construct(string $nodeId, string $status)
</div><div class='line not-executable'><span class='num'>133</span>    {
</div><div class='line not-covered'><span class='num'>134</span>        if (!in_array($status, self::ALLOWED_NODE_STATUSES, true)) {
</div><div class='line not-covered'><span class='num'>135</span>            throw new InvalidArgumentException(&quot;Invalid node status: {$status}&quot;);
</div><div class='line not-executable'><span class='num'>136</span>        }
</div><div class='line not-covered'><span class='num'>137</span>        $this-&gt;nodeId = $nodeId;
</div><div class='line not-covered'><span class='num'>138</span>        $this-&gt;status = $status;
</div><div class='line not-covered'><span class='num'>139</span>    }
</div><div class='line not-executable'><span class='num'>140</span>
</div><div class='line not-executable'><span class='num'>141</span>    public function toArray(): array
</div><div class='line not-executable'><span class='num'>142</span>    {
</div><div class='line not-executable'><span class='num'>143</span>        return [
</div><div class='line not-covered'><span class='num'>144</span>            &#039;node_id&#039; =&gt; $this-&gt;nodeId,
</div><div class='line not-covered'><span class='num'>145</span>            &#039;status&#039;  =&gt; $this-&gt;status,
</div><div class='line not-executable'><span class='num'>146</span>        ];
</div><div class='line not-covered'><span class='num'>147</span>    }
</div><div class='line not-executable'><span class='num'>148</span>}
</div><div class='line not-executable'><span class='num'>149</span>
</div><div class='line not-executable'><span class='num'>150</span>final class NodeStatuses
</div><div class='line not-executable'><span class='num'>151</span>{
</div><div class='line not-executable'><span class='num'>152</span>    public array $statuses = [];
</div><div class='line not-executable'><span class='num'>153</span>
</div><div class='line not-executable'><span class='num'>154</span>    public function addStatus(NodeStatus $status): void
</div><div class='line not-executable'><span class='num'>155</span>    {
</div><div class='line not-covered'><span class='num'>156</span>        $this-&gt;statuses[] = $status;
</div><div class='line not-covered'><span class='num'>157</span>    }
</div><div class='line not-executable'><span class='num'>158</span>}
</div><div class='line not-executable'><span class='num'>159</span>
</div><div class='line not-executable'><span class='num'>160</span>final class Nodes
</div><div class='line not-executable'><span class='num'>161</span>{
</div><div class='line not-executable'><span class='num'>162</span>    public array $nodes = [];
</div><div class='line not-executable'><span class='num'>163</span>
</div><div class='line not-executable'><span class='num'>164</span>    public function addNode(Node $node): void
</div><div class='line not-executable'><span class='num'>165</span>    {
</div><div class='line not-covered'><span class='num'>166</span>        $this-&gt;nodes[] = $node;
</div><div class='line not-covered'><span class='num'>167</span>    }
</div><div class='line not-executable'><span class='num'>168</span>}
</div><div class='line not-executable'><span class='num'>169</span>
</div><div class='line not-executable'><span class='num'>170</span>final class Edge
</div><div class='line not-executable'><span class='num'>171</span>{
</div><div class='line not-executable'><span class='num'>172</span>    public ?string $id;
</div><div class='line not-executable'><span class='num'>173</span>    public string $source;
</div><div class='line not-executable'><span class='num'>174</span>    public string $target;
</div><div class='line not-executable'><span class='num'>175</span>    public array $data;
</div><div class='line not-executable'><span class='num'>176</span>
</div><div class='line not-executable'><span class='num'>177</span>    public function __construct(?string $id = null, string $source, string $target, array $data = [])
</div><div class='line not-executable'><span class='num'>178</span>    {
</div><div class='line not-covered'><span class='num'>179</span>        $this-&gt;id     = $id;
</div><div class='line not-covered'><span class='num'>180</span>        $this-&gt;source = $source;
</div><div class='line not-covered'><span class='num'>181</span>        $this-&gt;target = $target;
</div><div class='line not-covered'><span class='num'>182</span>        $this-&gt;data   = $data;
</div><div class='line not-covered'><span class='num'>183</span>    }
</div><div class='line not-executable'><span class='num'>184</span>
</div><div class='line not-executable'><span class='num'>185</span>    public function toArray(): array
</div><div class='line not-executable'><span class='num'>186</span>    {
</div><div class='line not-executable'><span class='num'>187</span>        return [
</div><div class='line not-covered'><span class='num'>188</span>            &#039;id&#039;     =&gt; $this-&gt;id,
</div><div class='line not-covered'><span class='num'>189</span>            &#039;source&#039; =&gt; $this-&gt;source,
</div><div class='line not-covered'><span class='num'>190</span>            &#039;target&#039; =&gt; $this-&gt;target,
</div><div class='line not-covered'><span class='num'>191</span>            &#039;data&#039;   =&gt; $this-&gt;data
</div><div class='line not-executable'><span class='num'>192</span>        ];
</div><div class='line not-covered'><span class='num'>193</span>    }
</div><div class='line not-executable'><span class='num'>194</span>}
</div><div class='line not-executable'><span class='num'>195</span>
</div><div class='line not-executable'><span class='num'>196</span>final class Edges
</div><div class='line not-executable'><span class='num'>197</span>{
</div><div class='line not-executable'><span class='num'>198</span>    public array $edges = [];
</div><div class='line not-executable'><span class='num'>199</span>    public function addEdge(Edge $edge): void
</div><div class='line not-executable'><span class='num'>200</span>    {
</div><div class='line not-covered'><span class='num'>201</span>        $this-&gt;edges[] = $edge;
</div><div class='line not-covered'><span class='num'>202</span>    }
</div><div class='line not-executable'><span class='num'>203</span>}
</div><div class='line not-executable'><span class='num'>204</span>
</div><div class='line not-executable'><span class='num'>205</span>final class AuditLog
</div><div class='line not-executable'><span class='num'>206</span>{
</div><div class='line not-executable'><span class='num'>207</span>    public string $entityType;
</div><div class='line not-executable'><span class='num'>208</span>    public string $entityId;
</div><div class='line not-executable'><span class='num'>209</span>    public string $action;
</div><div class='line not-executable'><span class='num'>210</span>    public ?array $oldData;
</div><div class='line not-executable'><span class='num'>211</span>    public ?array $newData;
</div><div class='line not-executable'><span class='num'>212</span>    public string $userId;
</div><div class='line not-executable'><span class='num'>213</span>    public string $ipAddress;
</div><div class='line not-executable'><span class='num'>214</span>    public string $createdAt;
</div><div class='line not-executable'><span class='num'>215</span>
</div><div class='line not-executable'><span class='num'>216</span>    public function __construct(string $entityType, string $entityId, string $action, ?array $oldData = null, ?array $newData = null)
</div><div class='line not-executable'><span class='num'>217</span>    {
</div><div class='line covered'><span class='num'>218</span>        $this-&gt;entityType = $entityType;
</div><div class='line covered'><span class='num'>219</span>        $this-&gt;entityId   = $entityId;
</div><div class='line covered'><span class='num'>220</span>        $this-&gt;action     = $action;
</div><div class='line covered'><span class='num'>221</span>        $this-&gt;oldData    = $oldData;
</div><div class='line covered'><span class='num'>222</span>        $this-&gt;newData    = $newData;
</div><div class='line covered'><span class='num'>223</span>    }
</div><div class='line not-executable'><span class='num'>224</span>}
</div><div class='line not-executable'><span class='num'>225</span>
</div><div class='line not-executable'><span class='num'>226</span>final class AuditLogs
</div><div class='line not-executable'><span class='num'>227</span>{
</div><div class='line not-executable'><span class='num'>228</span>    public array $logs = [];
</div><div class='line not-executable'><span class='num'>229</span>    public function addLog(AuditLog $log): void
</div><div class='line not-executable'><span class='num'>230</span>    {
</div><div class='line not-covered'><span class='num'>231</span>        $this-&gt;logs[] = $log;
</div><div class='line not-covered'><span class='num'>232</span>    }
</div><div class='line not-executable'><span class='num'>233</span>}
</div><div class='line not-executable'><span class='num'>234</span>
</div><div class='line not-executable'><span class='num'>235</span>final class GraphContext
</div><div class='line not-executable'><span class='num'>236</span>{
</div><div class='line not-executable'><span class='num'>237</span>    public static User $user;
</div><div class='line not-executable'><span class='num'>238</span>}
</div><div class='line not-executable'><span class='num'>239</span>
</div><div class='line not-executable'><span class='num'>240</span>interface LoggerInterface
</div><div class='line not-executable'><span class='num'>241</span>{
</div><div class='line not-executable'><span class='num'>242</span>    public function info(string $message, array $data = []): void;
</div><div class='line not-executable'><span class='num'>243</span>    public function debug(string $message, array $data = []): void;
</div><div class='line not-executable'><span class='num'>244</span>    public function error(string $message, array $data = []): void;
</div><div class='line not-executable'><span class='num'>245</span>}
</div><div class='line not-executable'><span class='num'>246</span>
</div><div class='line not-executable'><span class='num'>247</span>final class Logger implements LoggerInterface
</div><div class='line not-executable'><span class='num'>248</span>{
</div><div class='line not-executable'><span class='num'>249</span>    private string $fileName;
</div><div class='line not-executable'><span class='num'>250</span>    private $fd;
</div><div class='line not-executable'><span class='num'>251</span>
</div><div class='line not-executable'><span class='num'>252</span>    public function __construct($file_name)
</div><div class='line not-executable'><span class='num'>253</span>    {
</div><div class='line covered'><span class='num'>254</span>        $this-&gt;fileName = $file_name;
</div><div class='line covered'><span class='num'>255</span>        $this-&gt;fd = fopen($this-&gt;fileName, &#039;a&#039;);
</div><div class='line covered'><span class='num'>256</span>    }
</div><div class='line not-executable'><span class='num'>257</span>
</div><div class='line not-executable'><span class='num'>258</span>    public function info(string $message, array $data = []): void
</div><div class='line not-executable'><span class='num'>259</span>    {
</div><div class='line covered'><span class='num'>260</span>        $this-&gt;log(&#039;INFO&#039;, $message, $data);
</div><div class='line covered'><span class='num'>261</span>    }
</div><div class='line not-executable'><span class='num'>262</span>
</div><div class='line not-executable'><span class='num'>263</span>    public function debug(string $message, array $data = []): void
</div><div class='line not-executable'><span class='num'>264</span>    {
</div><div class='line covered'><span class='num'>265</span>        $this-&gt;log(&#039;DEBUG&#039;, $message, $data);
</div><div class='line covered'><span class='num'>266</span>    }
</div><div class='line not-executable'><span class='num'>267</span>
</div><div class='line not-executable'><span class='num'>268</span>    public function error(string $message, array $data = []): void
</div><div class='line not-executable'><span class='num'>269</span>    {
</div><div class='line not-covered'><span class='num'>270</span>        $this-&gt;log(&#039;ERROR&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>271</span>    }
</div><div class='line not-executable'><span class='num'>272</span>
</div><div class='line not-executable'><span class='num'>273</span>    private function log(string $type, $message, $data = [])
</div><div class='line not-executable'><span class='num'>274</span>    {
</div><div class='line covered'><span class='num'>275</span>        $trace = debug_backtrace(DEBUG_BACKTRACE_PROVIDE_OBJECT, 3);
</div><div class='line covered'><span class='num'>276</span>        $method = &quot;{$trace[2][&#039;class&#039;]}::{$trace[2][&#039;function&#039;]}&quot;;
</div><div class='line covered'><span class='num'>277</span>        $data = json_encode($data);
</div><div class='line covered'><span class='num'>278</span>        $message = &quot;[{$type}] {$method}: $message ($data)\n&quot;;
</div><div class='line covered'><span class='num'>279</span>        fwrite($this-&gt;fd, $message);
</div><div class='line covered'><span class='num'>280</span>    }
</div><div class='line not-executable'><span class='num'>281</span>}
</div><div class='line not-executable'><span class='num'>282</span>
</div><div class='line not-executable'><span class='num'>283</span>interface GraphDatabaseInterface
</div><div class='line not-executable'><span class='num'>284</span>{
</div><div class='line not-executable'><span class='num'>285</span>    public function getUser(string $id): ?array;
</div><div class='line not-executable'><span class='num'>286</span>    public function insertUser(string $id, string $group): void;
</div><div class='line not-executable'><span class='num'>287</span>    public function updateUser(string $id, string $group): void;
</div><div class='line not-executable'><span class='num'>288</span>
</div><div class='line not-executable'><span class='num'>289</span>    public function getNode(string $id): ?array;
</div><div class='line not-executable'><span class='num'>290</span>    public function getNodes(): array;
</div><div class='line not-executable'><span class='num'>291</span>    public function insertNode(string $id, string $label, string $category, string $type, array $data = []): void;
</div><div class='line not-executable'><span class='num'>292</span>    public function updateNode(string $id, string $label, string $category, string $type, array $data = []): void;
</div><div class='line not-executable'><span class='num'>293</span>    public function deleteNode(string $id): void;
</div><div class='line not-executable'><span class='num'>294</span>
</div><div class='line not-executable'><span class='num'>295</span>    public function getEdge(string $source, string $target): ?array;
</div><div class='line not-executable'><span class='num'>296</span>    public function getEdgeById(string $id): ?array;
</div><div class='line not-executable'><span class='num'>297</span>    public function getEdges(): array;
</div><div class='line not-executable'><span class='num'>298</span>    public function insertEdge(string $id, string $source, string $target, array $data = []): void;
</div><div class='line not-executable'><span class='num'>299</span>    public function updateEdge(string $id, string $source, string $target, array $data = []): void;
</div><div class='line not-executable'><span class='num'>300</span>    public function deleteEdge(string $id): void;
</div><div class='line not-executable'><span class='num'>301</span>
</div><div class='line not-executable'><span class='num'>302</span>    public function getStatuses(): array;
</div><div class='line not-executable'><span class='num'>303</span>    public function getNodeStatus(string $id): ?string;
</div><div class='line not-executable'><span class='num'>304</span>    public function setNodeStatus(string $id, string $status): void;
</div><div class='line not-executable'><span class='num'>305</span>
</div><div class='line not-executable'><span class='num'>306</span>    public function getLogs($limit): array;
</div><div class='line not-executable'><span class='num'>307</span>    public function insertAuditLog(
</div><div class='line not-executable'><span class='num'>308</span>        string $entity_type, 
</div><div class='line not-executable'><span class='num'>309</span>        string $entity_id, 
</div><div class='line not-executable'><span class='num'>310</span>        string $action, 
</div><div class='line not-executable'><span class='num'>311</span>        ?array $old_data = null, 
</div><div class='line not-executable'><span class='num'>312</span>        ?array $new_data = null,
</div><div class='line not-executable'><span class='num'>313</span>        string $user_id,
</div><div class='line not-executable'><span class='num'>314</span>        string $ip_address): bool;
</div><div class='line not-executable'><span class='num'>315</span>}
</div><div class='line not-executable'><span class='num'>316</span>
</div><div class='line not-executable'><span class='num'>317</span>final class DatabaseException extends RuntimeException
</div><div class='line not-executable'><span class='num'>318</span>{
</div><div class='line not-executable'><span class='num'>319</span>    private ?string $query;
</div><div class='line not-executable'><span class='num'>320</span>    private ?array $params;
</div><div class='line not-executable'><span class='num'>321</span>
</div><div class='line not-executable'><span class='num'>322</span>    
</div><div class='line not-executable'><span class='num'>323</span>    public function __construct(string $message = &quot;&quot;,  int $code = 0, ?Throwable $previous = null, ?string $query = null, ?array $params) {
</div><div class='line not-covered'><span class='num'>324</span>        parent::__construct($message, $code, $previous);
</div><div class='line not-covered'><span class='num'>325</span>        $this-&gt;query = $query;
</div><div class='line not-covered'><span class='num'>326</span>        $this-&gt;params = $params;
</div><div class='line not-covered'><span class='num'>327</span>    }
</div><div class='line not-executable'><span class='num'>328</span>}
</div><div class='line not-executable'><span class='num'>329</span>
</div><div class='line not-executable'><span class='num'>330</span>final class GraphDatabase implements GraphDatabaseInterface
</div><div class='line not-executable'><span class='num'>331</span>{
</div><div class='line not-executable'><span class='num'>332</span>    private PDO $pdo;
</div><div class='line not-executable'><span class='num'>333</span>    private Logger $logger;
</div><div class='line not-executable'><span class='num'>334</span>
</div><div class='line not-executable'><span class='num'>335</span>    public function __construct(PDO $pdo, Logger $logger)
</div><div class='line not-executable'><span class='num'>336</span>    {
</div><div class='line covered'><span class='num'>337</span>        $this-&gt;pdo = $pdo;
</div><div class='line covered'><span class='num'>338</span>        $this-&gt;logger = $logger;
</div><div class='line covered'><span class='num'>339</span>        $this-&gt;initSchema();
</div><div class='line covered'><span class='num'>340</span>    }
</div><div class='line not-executable'><span class='num'>341</span>
</div><div class='line not-executable'><span class='num'>342</span>    public function getUser(string $id): ?array
</div><div class='line not-executable'><span class='num'>343</span>    {
</div><div class='line not-covered'><span class='num'>344</span>        $this-&gt;logger-&gt;debug(&quot;getting user id: &#039;{$id}&#039;&quot;);
</div><div class='line not-executable'><span class='num'>345</span>        try {
</div><div class='line not-covered'><span class='num'>346</span>            $sql = &quot;SELECT * FROM users WHERE id = :id&quot;;
</div><div class='line not-covered'><span class='num'>347</span>            $params = [&#039;:id&#039; =&gt; $id];
</div><div class='line not-covered'><span class='num'>348</span>            $stmt = $this-&gt;pdo-&gt;prepare($sql);
</div><div class='line not-covered'><span class='num'>349</span>            $stmt-&gt;execute($params);
</div><div class='line not-covered'><span class='num'>350</span>            $row = $stmt-&gt;fetch();
</div><div class='line not-executable'><span class='num'>351</span>
</div><div class='line not-covered'><span class='num'>352</span>            if ($row) {
</div><div class='line not-covered'><span class='num'>353</span>                return $row;
</div><div class='line not-executable'><span class='num'>354</span>            }
</div><div class='line not-covered'><span class='num'>355</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>356</span>            $e = new DatabaseException(
</div><div class='line not-covered'><span class='num'>357</span>                &quot;GraphDatabase Exception while trying to get user data. ID: {$id}&quot;,
</div><div class='line not-covered'><span class='num'>358</span>                0,
</div><div class='line not-executable'><span class='num'>359</span>                $e,
</div><div class='line not-executable'><span class='num'>360</span>                $sql,
</div><div class='line not-executable'><span class='num'>361</span>                $params
</div><div class='line not-executable'><span class='num'>362</span>            );
</div><div class='line not-executable'><span class='num'>363</span>        }
</div><div class='line not-covered'><span class='num'>364</span>        return null;
</div><div class='line not-covered'><span class='num'>365</span>    }
</div><div class='line not-executable'><span class='num'>366</span>
</div><div class='line not-executable'><span class='num'>367</span>    public function insertUser(string $id, string $group): void
</div><div class='line not-executable'><span class='num'>368</span>    {
</div><div class='line not-executable'><span class='num'>369</span>        try {
</div><div class='line not-covered'><span class='num'>370</span>            $sql = &quot;
</div><div class='line not-executable'><span class='num'>371</span>                INSERT OR IGNORE INTO users 
</div><div class='line not-executable'><span class='num'>372</span>                (id, user_group)
</div><div class='line not-executable'><span class='num'>373</span>                VALUES (:id, :group)&quot;;
</div><div class='line not-executable'><span class='num'>374</span>            
</div><div class='line not-covered'><span class='num'>375</span>            $params = [
</div><div class='line not-covered'><span class='num'>376</span>                &#039;:id&#039;       =&gt; $id,
</div><div class='line not-covered'><span class='num'>377</span>                &#039;:group&#039;    =&gt; $group
</div><div class='line not-executable'><span class='num'>378</span>            ];
</div><div class='line not-executable'><span class='num'>379</span>
</div><div class='line not-covered'><span class='num'>380</span>            $stmt = $this-&gt;pdo-&gt;prepare($sql);
</div><div class='line not-covered'><span class='num'>381</span>            $stmt-&gt;execute($params);
</div><div class='line not-covered'><span class='num'>382</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>383</span>            $e = new DatabaseException(
</div><div class='line not-covered'><span class='num'>384</span>                &quot;GraphDatabase Exception while trying to insert new user. ID: {$id}&quot;,
</div><div class='line not-covered'><span class='num'>385</span>                0,
</div><div class='line not-executable'><span class='num'>386</span>                $e,
</div><div class='line not-executable'><span class='num'>387</span>                $sql,
</div><div class='line not-executable'><span class='num'>388</span>                $params
</div><div class='line not-executable'><span class='num'>389</span>            );
</div><div class='line not-executable'><span class='num'>390</span>        }
</div><div class='line not-covered'><span class='num'>391</span>    }
</div><div class='line not-executable'><span class='num'>392</span>
</div><div class='line not-executable'><span class='num'>393</span>    public function updateUser(string $id, string $group): void
</div><div class='line not-executable'><span class='num'>394</span>    {
</div><div class='line not-executable'><span class='num'>395</span>        try {
</div><div class='line not-covered'><span class='num'>396</span>            $sql = &quot;
</div><div class='line not-executable'><span class='num'>397</span>                UPDATE users
</div><div class='line not-executable'><span class='num'>398</span>                SET    user_group = :group
</div><div class='line not-executable'><span class='num'>399</span>                WHERE  id = :id
</div><div class='line not-executable'><span class='num'>400</span>            &quot;;
</div><div class='line not-executable'><span class='num'>401</span>
</div><div class='line not-covered'><span class='num'>402</span>            $params = [
</div><div class='line not-covered'><span class='num'>403</span>                &#039;:id&#039;       =&gt; $id,
</div><div class='line not-covered'><span class='num'>404</span>                &#039;:group&#039;    =&gt; $group
</div><div class='line not-executable'><span class='num'>405</span>            ];
</div><div class='line not-executable'><span class='num'>406</span>
</div><div class='line not-covered'><span class='num'>407</span>            $stmt = $this-&gt;pdo-&gt;prepare($sql);
</div><div class='line not-executable'><span class='num'>408</span>            
</div><div class='line not-covered'><span class='num'>409</span>            $stmt-&gt;execute($params);
</div><div class='line not-executable'><span class='num'>410</span>
</div><div class='line not-covered'><span class='num'>411</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>412</span>            $e = new DatabaseException(
</div><div class='line not-covered'><span class='num'>413</span>                &quot;GraphDatabase Exception while trying to update user. ID: {$id}&quot;,
</div><div class='line not-covered'><span class='num'>414</span>                0,
</div><div class='line not-executable'><span class='num'>415</span>                $e,
</div><div class='line not-executable'><span class='num'>416</span>                $sql,
</div><div class='line not-executable'><span class='num'>417</span>                $params
</div><div class='line not-executable'><span class='num'>418</span>            );
</div><div class='line not-executable'><span class='num'>419</span>        }
</div><div class='line not-covered'><span class='num'>420</span>    }
</div><div class='line not-executable'><span class='num'>421</span>
</div><div class='line not-executable'><span class='num'>422</span>    public function getNode(string $id): ?array
</div><div class='line not-executable'><span class='num'>423</span>    {
</div><div class='line covered'><span class='num'>424</span>        $this-&gt;logger-&gt;debug(&quot;fetching node &#039;{$id}&#039;&quot;);
</div><div class='line not-executable'><span class='num'>425</span>
</div><div class='line not-executable'><span class='num'>426</span>        try {
</div><div class='line covered'><span class='num'>427</span>            $sql = &quot;SELECT * FROM nodes WHERE id = :id&quot;;
</div><div class='line covered'><span class='num'>428</span>            $params = [&#039;:id&#039; =&gt; $id];
</div><div class='line covered'><span class='num'>429</span>            $stmt = $this-&gt;pdo-&gt;prepare($sql);
</div><div class='line covered'><span class='num'>430</span>            $stmt-&gt;execute($params);
</div><div class='line covered'><span class='num'>431</span>            $row = $stmt-&gt;fetch();
</div><div class='line not-executable'><span class='num'>432</span>
</div><div class='line covered'><span class='num'>433</span>            if ($row) {
</div><div class='line covered'><span class='num'>434</span>                return $row;
</div><div class='line not-executable'><span class='num'>435</span>            }
</div><div class='line not-covered'><span class='num'>436</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>437</span>            $this-&gt;logger-&gt;error(&quot;exception with node id &#039;{$id}&#039;&quot;);
</div><div class='line not-covered'><span class='num'>438</span>            throw new DatabaseException(&quot;could not get node data with id &#039;{$id}&#039;&quot;, 0, $e, $sql, $params);
</div><div class='line not-executable'><span class='num'>439</span>        }
</div><div class='line not-covered'><span class='num'>440</span>        return null;
</div><div class='line not-covered'><span class='num'>441</span>    }
</div><div class='line not-executable'><span class='num'>442</span>
</div><div class='line not-executable'><span class='num'>443</span>    public function getNodes(): array
</div><div class='line not-executable'><span class='num'>444</span>    {
</div><div class='line not-executable'><span class='num'>445</span>        try {
</div><div class='line not-covered'><span class='num'>446</span>            $stmt = $this-&gt;pdo-&gt;query(&quot;SELECT * FROM nodes&quot;);
</div><div class='line not-covered'><span class='num'>447</span>            $rows = $stmt-&gt;fetchAll();
</div><div class='line not-covered'><span class='num'>448</span>            return $rows;
</div><div class='line not-covered'><span class='num'>449</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>450</span>            error_log(&quot;GraphDatabase fetch all nodes failed: &quot; . $e-&gt;getMessage());
</div><div class='line not-covered'><span class='num'>451</span>            return [];
</div><div class='line not-executable'><span class='num'>452</span>        }
</div><div class='line not-covered'><span class='num'>453</span>    }
</div><div class='line not-executable'><span class='num'>454</span>
</div><div class='line not-executable'><span class='num'>455</span>    public function insertNode(string $id, string $label, string $category, string $type, array $data = []): void
</div><div class='line not-executable'><span class='num'>456</span>    {
</div><div class='line not-executable'><span class='num'>457</span>        try {
</div><div class='line covered'><span class='num'>458</span>            $sql = &quot;
</div><div class='line not-executable'><span class='num'>459</span>                INSERT OR IGNORE INTO nodes 
</div><div class='line not-executable'><span class='num'>460</span>                (id, label, category, type, data) 
</div><div class='line not-executable'><span class='num'>461</span>                VALUES (:id, :label, :category, :type, :data)&quot;;
</div><div class='line covered'><span class='num'>462</span>            $stmt             = $this-&gt;pdo-&gt;prepare($sql);
</div><div class='line covered'><span class='num'>463</span>            $data[&#039;id&#039;]       = $id;
</div><div class='line covered'><span class='num'>464</span>            $data[&#039;label&#039;]    = $label;
</div><div class='line covered'><span class='num'>465</span>            $data[&#039;category&#039;] = $category;
</div><div class='line covered'><span class='num'>466</span>            $data[&#039;type&#039;]     = $type;
</div><div class='line covered'><span class='num'>467</span>            $stmt-&gt;execute([
</div><div class='line covered'><span class='num'>468</span>                &#039;:id&#039;       =&gt; $id,
</div><div class='line covered'><span class='num'>469</span>                &#039;:label&#039;    =&gt; $label,
</div><div class='line covered'><span class='num'>470</span>                &#039;:category&#039; =&gt; $category,
</div><div class='line covered'><span class='num'>471</span>                &#039;:type&#039;     =&gt; $type,
</div><div class='line covered'><span class='num'>472</span>                &#039;:data&#039;     =&gt; json_encode($data, JSON_UNESCAPED_UNICODE)
</div><div class='line not-executable'><span class='num'>473</span>            ]);
</div><div class='line not-covered'><span class='num'>474</span>        } catch (PDOException $e) {
</div><div class='line not-executable'><span class='num'>475</span>            // TODO
</div><div class='line not-executable'><span class='num'>476</span>        }
</div><div class='line covered'><span class='num'>477</span>    }
</div><div class='line not-executable'><span class='num'>478</span>
</div><div class='line not-executable'><span class='num'>479</span>    public function updateNode(string $id, string $label, string $category, string $type, array $data = []): void
</div><div class='line not-executable'><span class='num'>480</span>    {
</div><div class='line not-executable'><span class='num'>481</span>        try {
</div><div class='line not-covered'><span class='num'>482</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-executable'><span class='num'>483</span>                UPDATE nodes
</div><div class='line not-executable'><span class='num'>484</span>                SET    label = :label, 
</div><div class='line not-executable'><span class='num'>485</span>                       category = :category, 
</div><div class='line not-executable'><span class='num'>486</span>                       type = :type, 
</div><div class='line not-executable'><span class='num'>487</span>                       data = :data
</div><div class='line not-executable'><span class='num'>488</span>                WHERE  id = :id&quot;);
</div><div class='line not-covered'><span class='num'>489</span>            $data[&#039;id&#039;]       = $id;
</div><div class='line not-covered'><span class='num'>490</span>            $data[&#039;label&#039;]    = $label;
</div><div class='line not-covered'><span class='num'>491</span>            $data[&#039;category&#039;] = $category;
</div><div class='line not-covered'><span class='num'>492</span>            $data[&#039;type&#039;]     = $type;
</div><div class='line not-executable'><span class='num'>493</span>
</div><div class='line not-covered'><span class='num'>494</span>            $stmt-&gt;execute([
</div><div class='line not-covered'><span class='num'>495</span>                &#039;:id&#039;       =&gt; $id,
</div><div class='line not-covered'><span class='num'>496</span>                &#039;:label&#039;    =&gt; $label,
</div><div class='line not-covered'><span class='num'>497</span>                &#039;:category&#039; =&gt; $category,
</div><div class='line not-covered'><span class='num'>498</span>                &#039;:type&#039;     =&gt; $type,
</div><div class='line not-covered'><span class='num'>499</span>                &#039;:data&#039;     =&gt; json_encode($data, JSON_UNESCAPED_UNICODE)
</div><div class='line not-executable'><span class='num'>500</span>            ]);
</div><div class='line not-covered'><span class='num'>501</span>        } catch (PDOException $e) {
</div><div class='line not-executable'><span class='num'>502</span>            // TODO
</div><div class='line not-executable'><span class='num'>503</span>        }
</div><div class='line not-covered'><span class='num'>504</span>    }
</div><div class='line not-executable'><span class='num'>505</span>
</div><div class='line not-executable'><span class='num'>506</span>    public function deleteNode(string $id): void
</div><div class='line not-executable'><span class='num'>507</span>    {
</div><div class='line not-executable'><span class='num'>508</span>        try {
</div><div class='line not-covered'><span class='num'>509</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;DELETE FROM nodes WHERE id = :id&quot;);
</div><div class='line not-covered'><span class='num'>510</span>            $stmt-&gt;execute([&#039;:id&#039; =&gt; $id]);
</div><div class='line not-covered'><span class='num'>511</span>        } catch (PDOException $e) {
</div><div class='line not-executable'><span class='num'>512</span>            // TODO
</div><div class='line not-executable'><span class='num'>513</span>        }
</div><div class='line not-covered'><span class='num'>514</span>    }
</div><div class='line not-executable'><span class='num'>515</span>
</div><div class='line not-executable'><span class='num'>516</span>    public function getEdge(string $source, string $target): ?array
</div><div class='line not-executable'><span class='num'>517</span>    {
</div><div class='line not-executable'><span class='num'>518</span>        try {
</div><div class='line not-covered'><span class='num'>519</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-executable'><span class='num'>520</span>                SELECT * FROM edges
</div><div class='line not-executable'><span class='num'>521</span>                WHERE source = :source AND target = :target
</div><div class='line not-executable'><span class='num'>522</span>            &quot;);
</div><div class='line not-covered'><span class='num'>523</span>            $stmt-&gt;execute([
</div><div class='line not-covered'><span class='num'>524</span>                &#039;:source&#039; =&gt; $source,
</div><div class='line not-covered'><span class='num'>525</span>                &#039;:target&#039; =&gt; $target
</div><div class='line not-executable'><span class='num'>526</span>            ]);
</div><div class='line not-covered'><span class='num'>527</span>            $row = $stmt-&gt;fetch();
</div><div class='line not-covered'><span class='num'>528</span>            if ($row) {
</div><div class='line not-covered'><span class='num'>529</span>                return $row;
</div><div class='line not-executable'><span class='num'>530</span>            }
</div><div class='line not-covered'><span class='num'>531</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>532</span>            error_log(&quot;GraphDatabase edge exists check failed: &quot; . $e-&gt;getMessage());
</div><div class='line not-executable'><span class='num'>533</span>        }
</div><div class='line not-covered'><span class='num'>534</span>        return null;
</div><div class='line not-covered'><span class='num'>535</span>    }
</div><div class='line not-executable'><span class='num'>536</span>
</div><div class='line not-executable'><span class='num'>537</span>    public function getEdgeById(string $id): ?array
</div><div class='line not-executable'><span class='num'>538</span>    {
</div><div class='line not-executable'><span class='num'>539</span>        try {
</div><div class='line not-covered'><span class='num'>540</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-executable'><span class='num'>541</span>                SELECT * FROM edges
</div><div class='line not-executable'><span class='num'>542</span>                WHERE id = :id
</div><div class='line not-executable'><span class='num'>543</span>            &quot;);
</div><div class='line not-covered'><span class='num'>544</span>            $stmt-&gt;execute([
</div><div class='line not-covered'><span class='num'>545</span>                &#039;:id&#039; =&gt; $id,
</div><div class='line not-executable'><span class='num'>546</span>            ]);
</div><div class='line not-covered'><span class='num'>547</span>            $row = $stmt-&gt;fetch();
</div><div class='line not-covered'><span class='num'>548</span>            if ($row) {
</div><div class='line not-covered'><span class='num'>549</span>                return $row;
</div><div class='line not-executable'><span class='num'>550</span>            }
</div><div class='line not-covered'><span class='num'>551</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>552</span>            error_log(&quot;GraphDatabase edge exists check failed: &quot; . $e-&gt;getMessage());
</div><div class='line not-executable'><span class='num'>553</span>        }
</div><div class='line not-covered'><span class='num'>554</span>        return null;
</div><div class='line not-covered'><span class='num'>555</span>    }
</div><div class='line not-executable'><span class='num'>556</span>
</div><div class='line not-executable'><span class='num'>557</span>    public function getEdges(): array
</div><div class='line not-executable'><span class='num'>558</span>    {
</div><div class='line not-executable'><span class='num'>559</span>        try {
</div><div class='line not-covered'><span class='num'>560</span>            $stmt  = $this-&gt;pdo-&gt;query(&quot;SELECT * FROM edges&quot;);
</div><div class='line not-covered'><span class='num'>561</span>            $rows  = $stmt-&gt;fetchAll();
</div><div class='line not-covered'><span class='num'>562</span>            return $rows;
</div><div class='line not-covered'><span class='num'>563</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>564</span>            error_log(&quot;GraphDatabase fetch all edges failed: &quot; . $e-&gt;getMessage());
</div><div class='line not-covered'><span class='num'>565</span>            return [];
</div><div class='line not-executable'><span class='num'>566</span>        }
</div><div class='line not-covered'><span class='num'>567</span>    }
</div><div class='line not-executable'><span class='num'>568</span>
</div><div class='line not-executable'><span class='num'>569</span>    public function insertEdge(string $id, string $source, string $target, array $data = []): void
</div><div class='line not-executable'><span class='num'>570</span>    {
</div><div class='line not-executable'><span class='num'>571</span>        // verify if the inverse edge exists
</div><div class='line not-covered'><span class='num'>572</span>        $r = $this-&gt;getEdge($target, $source);
</div><div class='line not-executable'><span class='num'>573</span>        
</div><div class='line not-executable'><span class='num'>574</span>        try {
</div><div class='line not-covered'><span class='num'>575</span>            $sql = &quot;
</div><div class='line not-executable'><span class='num'>576</span>                INSERT OR IGNORE INTO edges
</div><div class='line not-executable'><span class='num'>577</span>                (id, source, target, data)
</div><div class='line not-executable'><span class='num'>578</span>                VALUES (:id, :source, :target, :data)&quot;;
</div><div class='line not-covered'><span class='num'>579</span>            $stmt           = $this-&gt;pdo-&gt;prepare($sql);
</div><div class='line not-covered'><span class='num'>580</span>            $data[&#039;id&#039;]     = $id;
</div><div class='line not-covered'><span class='num'>581</span>            $data[&#039;source&#039;] = $source;
</div><div class='line not-covered'><span class='num'>582</span>            $data[&#039;target&#039;] = $target;
</div><div class='line not-covered'><span class='num'>583</span>            $stmt-&gt;execute([
</div><div class='line not-covered'><span class='num'>584</span>                &#039;:id&#039;     =&gt; $id,
</div><div class='line not-covered'><span class='num'>585</span>                &#039;:source&#039; =&gt; $source,
</div><div class='line not-covered'><span class='num'>586</span>                &#039;:target&#039; =&gt; $target,
</div><div class='line not-covered'><span class='num'>587</span>                &#039;:data&#039;   =&gt; json_encode($data, JSON_UNESCAPED_UNICODE)
</div><div class='line not-executable'><span class='num'>588</span>            ]);
</div><div class='line not-covered'><span class='num'>589</span>        } catch (PDOException $e) {
</div><div class='line not-executable'><span class='num'>590</span>            // TODO
</div><div class='line not-executable'><span class='num'>591</span>        }
</div><div class='line not-covered'><span class='num'>592</span>    }
</div><div class='line not-executable'><span class='num'>593</span>
</div><div class='line not-executable'><span class='num'>594</span>    public function updateEdge(string $id, string $source, string $target, array $data = []): void
</div><div class='line not-executable'><span class='num'>595</span>    {
</div><div class='line not-executable'><span class='num'>596</span>        try {
</div><div class='line not-covered'><span class='num'>597</span>            $data[&#039;id&#039;]     = $id;
</div><div class='line not-covered'><span class='num'>598</span>            $data[&#039;source&#039;] = $source;
</div><div class='line not-covered'><span class='num'>599</span>            $data[&#039;target&#039;] = $target;
</div><div class='line not-executable'><span class='num'>600</span>
</div><div class='line not-covered'><span class='num'>601</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-executable'><span class='num'>602</span>                UPDATE edges
</div><div class='line not-executable'><span class='num'>603</span>                SET data = :data
</div><div class='line not-executable'><span class='num'>604</span>                WHERE id = :id&quot;);
</div><div class='line not-covered'><span class='num'>605</span>            $stmt-&gt;execute([
</div><div class='line not-covered'><span class='num'>606</span>                &#039;:id&#039;   =&gt; $id,
</div><div class='line not-covered'><span class='num'>607</span>                &#039;:data&#039; =&gt; json_encode($data, JSON_UNESCAPED_UNICODE)
</div><div class='line not-executable'><span class='num'>608</span>            ]);
</div><div class='line not-covered'><span class='num'>609</span>        } catch (PDOException $e) {
</div><div class='line not-executable'><span class='num'>610</span>            // TODO
</div><div class='line not-executable'><span class='num'>611</span>        }
</div><div class='line not-covered'><span class='num'>612</span>    }
</div><div class='line not-executable'><span class='num'>613</span>
</div><div class='line not-executable'><span class='num'>614</span>    public function deleteEdge(string $id): void
</div><div class='line not-executable'><span class='num'>615</span>    {
</div><div class='line not-executable'><span class='num'>616</span>        try {
</div><div class='line not-covered'><span class='num'>617</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;DELETE FROM edges WHERE id = :id&quot;);
</div><div class='line not-covered'><span class='num'>618</span>            $stmt-&gt;execute([&#039;:id&#039; =&gt; $id]);
</div><div class='line not-covered'><span class='num'>619</span>        } catch (PDOException $e) {
</div><div class='line not-executable'><span class='num'>620</span>            // TODO
</div><div class='line not-executable'><span class='num'>621</span>        }
</div><div class='line not-covered'><span class='num'>622</span>    }
</div><div class='line not-executable'><span class='num'>623</span>
</div><div class='line not-executable'><span class='num'>624</span>    public function getStatuses(): array
</div><div class='line not-executable'><span class='num'>625</span>    {
</div><div class='line not-covered'><span class='num'>626</span>        $stmt   = $this-&gt;pdo-&gt;query(&quot;
</div><div class='line not-executable'><span class='num'>627</span>            SELECT n.id,
</div><div class='line not-executable'><span class='num'>628</span>                   s.status
</div><div class='line not-executable'><span class='num'>629</span>            FROM   nodes n
</div><div class='line not-executable'><span class='num'>630</span>            LEFT JOIN status s ON n.id = s.node_id&quot;);
</div><div class='line not-covered'><span class='num'>631</span>        $status = $stmt-&gt;fetchAll();
</div><div class='line not-covered'><span class='num'>632</span>        return $status;
</div><div class='line not-covered'><span class='num'>633</span>    }
</div><div class='line not-executable'><span class='num'>634</span>
</div><div class='line not-executable'><span class='num'>635</span>    public function getNodeStatus(string $id): ?string
</div><div class='line not-executable'><span class='num'>636</span>    {
</div><div class='line not-covered'><span class='num'>637</span>        $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-executable'><span class='num'>638</span>            SELECT s.status
</div><div class='line not-executable'><span class='num'>639</span>            FROM nodes n
</div><div class='line not-executable'><span class='num'>640</span>            LEFT JOIN status s
</div><div class='line not-executable'><span class='num'>641</span>            ON n.id = s.node_id
</div><div class='line not-executable'><span class='num'>642</span>            WHERE n.id = ?&quot;);
</div><div class='line not-covered'><span class='num'>643</span>        $stmt-&gt;execute([$id]);
</div><div class='line not-covered'><span class='num'>644</span>        $status = $stmt-&gt;fetch();
</div><div class='line not-covered'><span class='num'>645</span>        return $status ? $status[&#039;status&#039;] : null;
</div><div class='line not-covered'><span class='num'>646</span>    }
</div><div class='line not-executable'><span class='num'>647</span>
</div><div class='line not-executable'><span class='num'>648</span>    public function setNodeStatus(string $id, string $status): void
</div><div class='line not-executable'><span class='num'>649</span>    {
</div><div class='line not-covered'><span class='num'>650</span>        $stmt = $this-&gt;pdo-&gt;prepare(&quot;REPLACE INTO status (node_id, status) VALUES (?, ?)&quot;);
</div><div class='line not-covered'><span class='num'>651</span>        $stmt-&gt;execute([$id, $status]);
</div><div class='line not-covered'><span class='num'>652</span>    }
</div><div class='line not-executable'><span class='num'>653</span>
</div><div class='line not-executable'><span class='num'>654</span>    public function getLogs($limit): array
</div><div class='line not-executable'><span class='num'>655</span>    {
</div><div class='line not-covered'><span class='num'>656</span>        $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-executable'><span class='num'>657</span>            SELECT *
</div><div class='line not-executable'><span class='num'>658</span>            FROM audit
</div><div class='line not-executable'><span class='num'>659</span>            ORDER BY created_at DESC
</div><div class='line not-executable'><span class='num'>660</span>            LIMIT :limit
</div><div class='line not-executable'><span class='num'>661</span>        &quot;);
</div><div class='line not-covered'><span class='num'>662</span>        $stmt-&gt;bindValue(&#039;:limit&#039;, (int)$limit, PDO::PARAM_INT);
</div><div class='line not-covered'><span class='num'>663</span>        $stmt-&gt;execute();
</div><div class='line not-covered'><span class='num'>664</span>        $rows = $stmt-&gt;fetchAll();
</div><div class='line not-covered'><span class='num'>665</span>        return $rows;
</div><div class='line not-covered'><span class='num'>666</span>    }
</div><div class='line not-executable'><span class='num'>667</span>
</div><div class='line not-executable'><span class='num'>668</span>    public function insertAuditLog(string $entity_type, string $entity_id, string $action, ?array $old_data = null, ?array $new_data = null, string $user_id, string $ip_address): bool
</div><div class='line not-executable'><span class='num'>669</span>    {
</div><div class='line not-executable'><span class='num'>670</span>        try {
</div><div class='line covered'><span class='num'>671</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-executable'><span class='num'>672</span>                INSERT INTO audit (entity_type, entity_id, action, old_data, new_data, user_id, ip_address)
</div><div class='line not-executable'><span class='num'>673</span>                VALUES (:entity_type, :entity_id, :action, :old_data, :new_data, :user_id, :ip_address)
</div><div class='line not-executable'><span class='num'>674</span>            &quot;);
</div><div class='line not-executable'><span class='num'>675</span>
</div><div class='line covered'><span class='num'>676</span>            $stmt-&gt;execute([
</div><div class='line covered'><span class='num'>677</span>                &#039;:entity_type&#039; =&gt; $entity_type,
</div><div class='line covered'><span class='num'>678</span>                &#039;:entity_id&#039;   =&gt; $entity_id,
</div><div class='line covered'><span class='num'>679</span>                &#039;:action&#039;      =&gt; $action,
</div><div class='line not-covered'><span class='num'>680</span>                &#039;:old_data&#039;    =&gt; $old_data !== null ? json_encode($old_data, JSON_UNESCAPED_UNICODE) : null,
</div><div class='line covered'><span class='num'>681</span>                &#039;:new_data&#039;    =&gt; $new_data !== null ? json_encode($new_data, JSON_UNESCAPED_UNICODE) : null,
</div><div class='line covered'><span class='num'>682</span>                &#039;:user_id&#039;     =&gt; $user_id,
</div><div class='line covered'><span class='num'>683</span>                &#039;:ip_address&#039;  =&gt; $ip_address
</div><div class='line not-executable'><span class='num'>684</span>            ]);
</div><div class='line covered'><span class='num'>685</span>            return true;
</div><div class='line not-covered'><span class='num'>686</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>687</span>            error_log(&quot;GraphDatabase audit log insert failed: &quot; . $e-&gt;getMessage());
</div><div class='line not-covered'><span class='num'>688</span>            return false;
</div><div class='line not-executable'><span class='num'>689</span>        }
</div><div class='line not-covered'><span class='num'>690</span>    }
</div><div class='line not-executable'><span class='num'>691</span>
</div><div class='line not-executable'><span class='num'>692</span>    private function initSchema(): void
</div><div class='line not-executable'><span class='num'>693</span>    {
</div><div class='line covered'><span class='num'>694</span>        $this-&gt;pdo-&gt;exec(&quot;
</div><div class='line not-executable'><span class='num'>695</span>            CREATE TABLE IF NOT EXISTS users (
</div><div class='line not-executable'><span class='num'>696</span>                id TEXT PRIMARY KEY,
</div><div class='line not-executable'><span class='num'>697</span>                user_group TEXT NOT NULL
</div><div class='line not-executable'><span class='num'>698</span>            )
</div><div class='line not-executable'><span class='num'>699</span>        &quot;);
</div><div class='line not-executable'><span class='num'>700</span>
</div><div class='line covered'><span class='num'>701</span>        $this-&gt;pdo-&gt;exec(&quot;INSERT INTO users VALUES(&#039;admin&#039;, &#039;admin&#039;)&quot;);
</div><div class='line not-executable'><span class='num'>702</span>
</div><div class='line covered'><span class='num'>703</span>        $this-&gt;pdo-&gt;exec(&quot;
</div><div class='line not-executable'><span class='num'>704</span>            CREATE TABLE IF NOT EXISTS nodes (
</div><div class='line not-executable'><span class='num'>705</span>                id TEXT PRIMARY KEY,
</div><div class='line not-executable'><span class='num'>706</span>                label TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>707</span>                category TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>708</span>                type TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>709</span>                data TEXT NOT NULL
</div><div class='line not-executable'><span class='num'>710</span>            )
</div><div class='line not-executable'><span class='num'>711</span>        &quot;);
</div><div class='line not-executable'><span class='num'>712</span>
</div><div class='line covered'><span class='num'>713</span>        $this-&gt;pdo-&gt;exec(&quot;
</div><div class='line not-executable'><span class='num'>714</span>            CREATE TABLE IF NOT EXISTS edges (
</div><div class='line not-executable'><span class='num'>715</span>                id TEXT PRIMARY KEY,
</div><div class='line not-executable'><span class='num'>716</span>                source TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>717</span>                target TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>718</span>                data TEXT,
</div><div class='line not-executable'><span class='num'>719</span>                FOREIGN KEY (source) REFERENCES nodes(id) ON DELETE CASCADE,
</div><div class='line not-executable'><span class='num'>720</span>                FOREIGN KEY (target) REFERENCES nodes(id) ON DELETE CASCADE
</div><div class='line not-executable'><span class='num'>721</span>            )
</div><div class='line not-executable'><span class='num'>722</span>        &quot;);
</div><div class='line not-executable'><span class='num'>723</span>
</div><div class='line covered'><span class='num'>724</span>        $this-&gt;pdo-&gt;exec(&quot;CREATE UNIQUE INDEX IF NOT EXISTS idx_edges_source_target ON edges (source, target)&quot;);
</div><div class='line not-executable'><span class='num'>725</span>
</div><div class='line covered'><span class='num'>726</span>        $this-&gt;pdo-&gt;exec(&quot;
</div><div class='line not-executable'><span class='num'>727</span>            CREATE TABLE IF NOT EXISTS status (
</div><div class='line not-executable'><span class='num'>728</span>                node_id TEXT PRIMARY KEY NOT NULL,
</div><div class='line not-executable'><span class='num'>729</span>                status TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>730</span>                created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
</div><div class='line not-executable'><span class='num'>731</span>                FOREIGN KEY (node_id) REFERENCES nodes(id) ON DELETE CASCADE
</div><div class='line not-executable'><span class='num'>732</span>            )
</div><div class='line not-executable'><span class='num'>733</span>        &quot;);
</div><div class='line not-executable'><span class='num'>734</span>
</div><div class='line covered'><span class='num'>735</span>        $this-&gt;pdo-&gt;exec(&quot;CREATE INDEX IF NOT EXISTS idx_node_status_node_id ON status (node_id)&quot;);
</div><div class='line not-executable'><span class='num'>736</span>
</div><div class='line covered'><span class='num'>737</span>        $this-&gt;pdo-&gt;exec(&quot;
</div><div class='line not-executable'><span class='num'>738</span>            CREATE TABLE IF NOT EXISTS audit (
</div><div class='line not-executable'><span class='num'>739</span>                id INTEGER PRIMARY KEY AUTOINCREMENT,
</div><div class='line not-executable'><span class='num'>740</span>                entity_type TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>741</span>                entity_id TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>742</span>                action TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>743</span>                old_data TEXT,
</div><div class='line not-executable'><span class='num'>744</span>                new_data TEXT,
</div><div class='line not-executable'><span class='num'>745</span>                user_id TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>746</span>                ip_address TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>747</span>                created_at DATETIME DEFAULT CURRENT_TIMESTAMP
</div><div class='line not-executable'><span class='num'>748</span>            )
</div><div class='line not-executable'><span class='num'>749</span>        &quot;);
</div><div class='line covered'><span class='num'>750</span>    }
</div><div class='line not-executable'><span class='num'>751</span>
</div><div class='line not-executable'><span class='num'>752</span>    public static function createConnection(string $dsn): PDO
</div><div class='line not-executable'><span class='num'>753</span>    {
</div><div class='line covered'><span class='num'>754</span>        $pdo = new PDO($dsn);
</div><div class='line covered'><span class='num'>755</span>        $pdo-&gt;setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
</div><div class='line covered'><span class='num'>756</span>        $pdo-&gt;setAttribute(PDO::ATTR_DEFAULT_FETCH_MODE, PDO::FETCH_ASSOC);
</div><div class='line covered'><span class='num'>757</span>        $pdo-&gt;exec(&#039;PRAGMA foreign_keys = ON&#039;);
</div><div class='line covered'><span class='num'>758</span>        return $pdo;
</div><div class='line not-covered'><span class='num'>759</span>    }
</div><div class='line not-executable'><span class='num'>760</span>}
</div><div class='line not-executable'><span class='num'>761</span>
</div><div class='line not-executable'><span class='num'>762</span>final class GraphServiceException extends RuntimeException
</div><div class='line not-executable'><span class='num'>763</span>{
</div><div class='line not-executable'><span class='num'>764</span>}
</div><div class='line not-executable'><span class='num'>765</span>
</div><div class='line not-executable'><span class='num'>766</span>interface GraphServiceInterface
</div><div class='line not-executable'><span class='num'>767</span>{
</div><div class='line not-executable'><span class='num'>768</span>    public function getUser(string $id): ?User;
</div><div class='line not-executable'><span class='num'>769</span>    public function insertUser(User $user): void;
</div><div class='line not-executable'><span class='num'>770</span>    public function updateUser(User $user): void;
</div><div class='line not-executable'><span class='num'>771</span>
</div><div class='line not-executable'><span class='num'>772</span>    public function getGraph(): Graph;
</div><div class='line not-executable'><span class='num'>773</span>
</div><div class='line not-executable'><span class='num'>774</span>    public function getNode(string $id): ?Node;
</div><div class='line not-executable'><span class='num'>775</span>    public function getNodes(): Nodes;
</div><div class='line not-executable'><span class='num'>776</span>    public function insertNode(Node $node): void;
</div><div class='line not-executable'><span class='num'>777</span>    public function updateNode(Node $node): void;
</div><div class='line not-executable'><span class='num'>778</span>    public function deleteNode(string $id): void;
</div><div class='line not-executable'><span class='num'>779</span>
</div><div class='line not-executable'><span class='num'>780</span>    public function getEdge(string $source, string $target): ?Edge;
</div><div class='line not-executable'><span class='num'>781</span>    public function getEdges(): Edges;
</div><div class='line not-executable'><span class='num'>782</span>    public function insertEdge(Edge $edge): void;
</div><div class='line not-executable'><span class='num'>783</span>    public function updateEdge(Edge $edge): void;
</div><div class='line not-executable'><span class='num'>784</span>    public function deleteEdge(string $id): void;
</div><div class='line not-executable'><span class='num'>785</span>
</div><div class='line not-executable'><span class='num'>786</span>    public function getStatuses(): NodeStatuses;
</div><div class='line not-executable'><span class='num'>787</span>    public function getNodeStatus(string $id): NodeStatus;
</div><div class='line not-executable'><span class='num'>788</span>    public function setNodeStatus(NodeStatus $status): void;
</div><div class='line not-executable'><span class='num'>789</span>
</div><div class='line not-executable'><span class='num'>790</span>    public function getLogs($limit): AuditLogs;
</div><div class='line not-executable'><span class='num'>791</span>}
</div><div class='line not-executable'><span class='num'>792</span>
</div><div class='line not-executable'><span class='num'>793</span>final class GraphService implements GraphServiceInterface
</div><div class='line not-executable'><span class='num'>794</span>{
</div><div class='line not-executable'><span class='num'>795</span>    private const SECURE_ACTIONS = [
</div><div class='line not-executable'><span class='num'>796</span>        &#039;GraphService::getGraph&#039;      =&gt; true,
</div><div class='line not-executable'><span class='num'>797</span>        &#039;GraphService::getNode&#039;       =&gt; true,
</div><div class='line not-executable'><span class='num'>798</span>        &#039;GraphService::getNodes&#039;      =&gt; true,
</div><div class='line not-executable'><span class='num'>799</span>        &#039;GraphService::getEdge&#039;       =&gt; true,
</div><div class='line not-executable'><span class='num'>800</span>        &#039;GraphService::getEdges&#039;      =&gt; true,
</div><div class='line not-executable'><span class='num'>801</span>        &#039;GraphService::getStatuses&#039;   =&gt; true,
</div><div class='line not-executable'><span class='num'>802</span>        &#039;GraphService::getNodeStatus&#039; =&gt; true,
</div><div class='line not-executable'><span class='num'>803</span>        &#039;GraphService::setNodeStatus&#039; =&gt; true,
</div><div class='line not-executable'><span class='num'>804</span>        &#039;GraphService::getLogs&#039;       =&gt; true,
</div><div class='line not-executable'><span class='num'>805</span>        &#039;GraphService::insertNode&#039;    =&gt; false,
</div><div class='line not-executable'><span class='num'>806</span>        &#039;GraphService::updateNode&#039;    =&gt; false,
</div><div class='line not-executable'><span class='num'>807</span>        &#039;GraphService::deleteNode&#039;    =&gt; false,
</div><div class='line not-executable'><span class='num'>808</span>        &#039;GraphService::insertEdge&#039;    =&gt; false,
</div><div class='line not-executable'><span class='num'>809</span>        &#039;GraphService::updateEdge&#039;    =&gt; false,
</div><div class='line not-executable'><span class='num'>810</span>        &#039;GraphService::deleteEdge&#039;    =&gt; false,
</div><div class='line not-executable'><span class='num'>811</span>
</div><div class='line not-executable'><span class='num'>812</span>        &#039;GraphService::insertAuditLog&#039; =&gt; false,
</div><div class='line not-executable'><span class='num'>813</span>    ];
</div><div class='line not-executable'><span class='num'>814</span>
</div><div class='line not-executable'><span class='num'>815</span>    private GraphDatabaseInterface $db;
</div><div class='line not-executable'><span class='num'>816</span>    private Logger $logger;
</div><div class='line not-executable'><span class='num'>817</span>
</div><div class='line not-executable'><span class='num'>818</span>    public function __construct(GraphDatabaseInterface $db, Logger $logger)
</div><div class='line not-executable'><span class='num'>819</span>    {
</div><div class='line covered'><span class='num'>820</span>        $this-&gt;db = $db;
</div><div class='line covered'><span class='num'>821</span>        $this-&gt;logger = $logger;
</div><div class='line covered'><span class='num'>822</span>    }
</div><div class='line not-executable'><span class='num'>823</span>
</div><div class='line not-executable'><span class='num'>824</span>    public function getUser(string $id): ?User
</div><div class='line not-executable'><span class='num'>825</span>    {
</div><div class='line not-covered'><span class='num'>826</span>        $data = $this-&gt;db-&gt;getUser($id);
</div><div class='line not-covered'><span class='num'>827</span>        if ($data) {
</div><div class='line not-covered'><span class='num'>828</span>            $user = new User($id, null, $data[&#039;user_group&#039;]);
</div><div class='line not-covered'><span class='num'>829</span>            return $user;
</div><div class='line not-executable'><span class='num'>830</span>        }
</div><div class='line not-covered'><span class='num'>831</span>        return null;
</div><div class='line not-covered'><span class='num'>832</span>    }
</div><div class='line not-executable'><span class='num'>833</span>
</div><div class='line not-executable'><span class='num'>834</span>    public function insertUser(User $user): void
</div><div class='line not-executable'><span class='num'>835</span>    {
</div><div class='line not-covered'><span class='num'>836</span>        $this-&gt;db-&gt;insertUser($user-&gt;id, $user-&gt;group-&gt;id);
</div><div class='line not-covered'><span class='num'>837</span>    }
</div><div class='line not-executable'><span class='num'>838</span>
</div><div class='line not-executable'><span class='num'>839</span>    public function updateUser(User $user): void
</div><div class='line not-executable'><span class='num'>840</span>    {
</div><div class='line not-covered'><span class='num'>841</span>        $this-&gt;db-&gt;updateUser($user-&gt;id, $user-&gt;group-&gt;id);
</div><div class='line not-covered'><span class='num'>842</span>    }
</div><div class='line not-executable'><span class='num'>843</span>
</div><div class='line not-executable'><span class='num'>844</span>    public function getGraph(): Graph
</div><div class='line not-executable'><span class='num'>845</span>    {
</div><div class='line not-covered'><span class='num'>846</span>        $nodes = $this-&gt;getNodes()-&gt;nodes;
</div><div class='line not-covered'><span class='num'>847</span>        $edges = $this-&gt;getEdges()-&gt;edges;
</div><div class='line not-covered'><span class='num'>848</span>        return new Graph($nodes, $edges);
</div><div class='line not-covered'><span class='num'>849</span>    }
</div><div class='line not-executable'><span class='num'>850</span>
</div><div class='line not-executable'><span class='num'>851</span>    public function getNode(string $id): ?Node
</div><div class='line not-executable'><span class='num'>852</span>    {
</div><div class='line covered'><span class='num'>853</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>854</span>            throw new RuntimeException(&quot;Permission denied to get node.&quot;);
</div><div class='line not-executable'><span class='num'>855</span>        }
</div><div class='line not-executable'><span class='num'>856</span>
</div><div class='line covered'><span class='num'>857</span>        $data = $this-&gt;db-&gt;getNode($id);
</div><div class='line covered'><span class='num'>858</span>        if ($data) {
</div><div class='line covered'><span class='num'>859</span>            return new Node(
</div><div class='line covered'><span class='num'>860</span>                $data[&#039;id&#039;],
</div><div class='line covered'><span class='num'>861</span>                $data[&#039;label&#039;],
</div><div class='line covered'><span class='num'>862</span>                $data[&#039;category&#039;],
</div><div class='line covered'><span class='num'>863</span>                $data[&#039;type&#039;],
</div><div class='line covered'><span class='num'>864</span>                json_decode($data[&#039;data&#039;], true)
</div><div class='line not-executable'><span class='num'>865</span>            );
</div><div class='line not-executable'><span class='num'>866</span>        }
</div><div class='line not-covered'><span class='num'>867</span>        return null;
</div><div class='line not-covered'><span class='num'>868</span>    }
</div><div class='line not-executable'><span class='num'>869</span>
</div><div class='line not-executable'><span class='num'>870</span>    public function getNodes(): Nodes
</div><div class='line not-executable'><span class='num'>871</span>    {
</div><div class='line not-covered'><span class='num'>872</span>        if(! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>873</span>            throw new RuntimeException(&quot;Permission denied to get nodes.&quot;);
</div><div class='line not-executable'><span class='num'>874</span>        }
</div><div class='line not-executable'><span class='num'>875</span>
</div><div class='line not-covered'><span class='num'>876</span>        $nodesData = $this-&gt;db-&gt;getNodes();
</div><div class='line not-covered'><span class='num'>877</span>        $nodes     = new Nodes();
</div><div class='line not-covered'><span class='num'>878</span>        foreach ($nodesData as $data) {
</div><div class='line not-covered'><span class='num'>879</span>            $node = new Node(
</div><div class='line not-covered'><span class='num'>880</span>                $data[&#039;id&#039;],
</div><div class='line not-covered'><span class='num'>881</span>                $data[&#039;label&#039;],
</div><div class='line not-covered'><span class='num'>882</span>                $data[&#039;category&#039;],
</div><div class='line not-covered'><span class='num'>883</span>                $data[&#039;type&#039;],
</div><div class='line not-covered'><span class='num'>884</span>                json_decode($data[&#039;data&#039;], true)
</div><div class='line not-executable'><span class='num'>885</span>            );
</div><div class='line not-covered'><span class='num'>886</span>            $nodes-&gt;addNode($node);
</div><div class='line not-executable'><span class='num'>887</span>        }
</div><div class='line not-covered'><span class='num'>888</span>        return $nodes;
</div><div class='line not-covered'><span class='num'>889</span>    }
</div><div class='line not-executable'><span class='num'>890</span>
</div><div class='line not-executable'><span class='num'>891</span>    public function insertNode(Node $node): void
</div><div class='line not-executable'><span class='num'>892</span>    {
</div><div class='line covered'><span class='num'>893</span>        $this-&gt;logger-&gt;debug(&#039;inserting node&#039;, $node-&gt;toArray());
</div><div class='line not-executable'><span class='num'>894</span>
</div><div class='line covered'><span class='num'>895</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>896</span>            $this-&gt;logger-&gt;info(&#039;permission denied&#039;, $node-&gt;toArray());
</div><div class='line not-covered'><span class='num'>897</span>            throw new GraphServiceException(&#039;permission denied&#039;);
</div><div class='line not-executable'><span class='num'>898</span>        }
</div><div class='line not-executable'><span class='num'>899</span>
</div><div class='line covered'><span class='num'>900</span>        $this-&gt;logger-&gt;info(&#039;permission allowed&#039;, $node-&gt;toArray());
</div><div class='line not-executable'><span class='num'>901</span>
</div><div class='line covered'><span class='num'>902</span>        $this-&gt;insertAuditLog(new AuditLog( &#039;node&#039;, $node-&gt;id, &#039;insert&#039;, null, $node-&gt;toArray()));
</div><div class='line not-executable'><span class='num'>903</span>
</div><div class='line covered'><span class='num'>904</span>        $this-&gt;db-&gt;insertNode(
</div><div class='line covered'><span class='num'>905</span>            $node-&gt;id,
</div><div class='line covered'><span class='num'>906</span>            $node-&gt;label,
</div><div class='line covered'><span class='num'>907</span>            $node-&gt;category,
</div><div class='line covered'><span class='num'>908</span>            $node-&gt;type,
</div><div class='line covered'><span class='num'>909</span>            $node-&gt;data
</div><div class='line not-executable'><span class='num'>910</span>        );
</div><div class='line covered'><span class='num'>911</span>    }
</div><div class='line not-executable'><span class='num'>912</span>
</div><div class='line not-executable'><span class='num'>913</span>    public function updateNode(Node $node): void
</div><div class='line not-executable'><span class='num'>914</span>    {
</div><div class='line not-covered'><span class='num'>915</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>916</span>            throw new RuntimeException(&quot;Permission denied to update node.&quot;);
</div><div class='line not-executable'><span class='num'>917</span>        }
</div><div class='line not-executable'><span class='num'>918</span>
</div><div class='line not-covered'><span class='num'>919</span>        $old = $this-&gt;getNode($node-&gt;id);
</div><div class='line not-covered'><span class='num'>920</span>        $this-&gt;insertAuditLog(new AuditLog( &#039;node&#039;, $node-&gt;id, &#039;update&#039;, $old-&gt;toArray(), $node-&gt;toArray()));
</div><div class='line not-executable'><span class='num'>921</span>
</div><div class='line not-covered'><span class='num'>922</span>        $this-&gt;db-&gt;updateNode(
</div><div class='line not-covered'><span class='num'>923</span>            $node-&gt;id,
</div><div class='line not-covered'><span class='num'>924</span>            $node-&gt;label,
</div><div class='line not-covered'><span class='num'>925</span>            $node-&gt;category,
</div><div class='line not-covered'><span class='num'>926</span>            $node-&gt;type,
</div><div class='line not-covered'><span class='num'>927</span>            $node-&gt;data
</div><div class='line not-executable'><span class='num'>928</span>        );
</div><div class='line not-covered'><span class='num'>929</span>    }
</div><div class='line not-executable'><span class='num'>930</span>
</div><div class='line not-executable'><span class='num'>931</span>    public function deleteNode(string $id): void
</div><div class='line not-executable'><span class='num'>932</span>    {
</div><div class='line not-covered'><span class='num'>933</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>934</span>            throw new RuntimeException(&quot;Permission denied to delete node.&quot;);
</div><div class='line not-executable'><span class='num'>935</span>        }
</div><div class='line not-executable'><span class='num'>936</span>
</div><div class='line not-covered'><span class='num'>937</span>        $old = $this-&gt;getNode($id);
</div><div class='line not-covered'><span class='num'>938</span>        $this-&gt;insertAuditLog(new AuditLog( &#039;node&#039;, $id, &#039;delete&#039;, $old-&gt;toArray(), null));
</div><div class='line not-covered'><span class='num'>939</span>        $this-&gt;db-&gt;deleteNode($id);
</div><div class='line not-covered'><span class='num'>940</span>    }
</div><div class='line not-executable'><span class='num'>941</span>
</div><div class='line not-executable'><span class='num'>942</span>    public function getEdge(string $source, string $target): ?Edge
</div><div class='line not-executable'><span class='num'>943</span>    {
</div><div class='line not-covered'><span class='num'>944</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>945</span>            throw new RuntimeException(&quot;Permission denied to get edge.&quot;);
</div><div class='line not-executable'><span class='num'>946</span>        }
</div><div class='line not-executable'><span class='num'>947</span>
</div><div class='line not-covered'><span class='num'>948</span>        $edgesData = $this-&gt;db-&gt;getEdges();
</div><div class='line not-covered'><span class='num'>949</span>        foreach ($edgesData as $data) {
</div><div class='line not-covered'><span class='num'>950</span>            if ($data[&#039;source&#039;] === $source &amp;&amp; $data[&#039;target&#039;] === $target) {
</div><div class='line not-covered'><span class='num'>951</span>                return new Edge(
</div><div class='line not-covered'><span class='num'>952</span>                    $data[&#039;id&#039;],
</div><div class='line not-covered'><span class='num'>953</span>                    $data[&#039;source&#039;],
</div><div class='line not-covered'><span class='num'>954</span>                    $data[&#039;target&#039;],
</div><div class='line not-covered'><span class='num'>955</span>                    json_decode($data[&#039;data&#039;], true)
</div><div class='line not-executable'><span class='num'>956</span>                );
</div><div class='line not-executable'><span class='num'>957</span>            }
</div><div class='line not-executable'><span class='num'>958</span>        }
</div><div class='line not-covered'><span class='num'>959</span>        return null;
</div><div class='line not-covered'><span class='num'>960</span>    }
</div><div class='line not-executable'><span class='num'>961</span>
</div><div class='line not-executable'><span class='num'>962</span>    public function getEdges(): Edges
</div><div class='line not-executable'><span class='num'>963</span>    {
</div><div class='line not-covered'><span class='num'>964</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>965</span>            throw new RuntimeException(&quot;Permission denied to get edges.&quot;);
</div><div class='line not-executable'><span class='num'>966</span>        }
</div><div class='line not-covered'><span class='num'>967</span>        $edgesData = $this-&gt;db-&gt;getEdges();
</div><div class='line not-covered'><span class='num'>968</span>        $edges     = new Edges();
</div><div class='line not-covered'><span class='num'>969</span>        foreach ($edgesData as $data) {
</div><div class='line not-covered'><span class='num'>970</span>            $edge = new Edge(
</div><div class='line not-covered'><span class='num'>971</span>                $data[&#039;id&#039;],
</div><div class='line not-covered'><span class='num'>972</span>                $data[&#039;source&#039;],
</div><div class='line not-covered'><span class='num'>973</span>                $data[&#039;target&#039;],
</div><div class='line not-covered'><span class='num'>974</span>                json_decode($data[&#039;data&#039;], true)
</div><div class='line not-executable'><span class='num'>975</span>            );
</div><div class='line not-covered'><span class='num'>976</span>            $edges-&gt;addEdge($edge);
</div><div class='line not-executable'><span class='num'>977</span>        }
</div><div class='line not-covered'><span class='num'>978</span>        return $edges;
</div><div class='line not-covered'><span class='num'>979</span>    }
</div><div class='line not-executable'><span class='num'>980</span>
</div><div class='line not-executable'><span class='num'>981</span>    public function insertEdge(Edge $edge): void
</div><div class='line not-executable'><span class='num'>982</span>    {
</div><div class='line not-covered'><span class='num'>983</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>984</span>            throw new RuntimeException(&quot;Permission denied to insert edge.&quot;);
</div><div class='line not-executable'><span class='num'>985</span>        }
</div><div class='line not-covered'><span class='num'>986</span>        $this-&gt;insertAuditLog(new AuditLog( &#039;edge&#039;, $edge-&gt;id, &#039;insert&#039;, null, $edge-&gt;toArray()));
</div><div class='line not-covered'><span class='num'>987</span>        $this-&gt;db-&gt;insertEdge(
</div><div class='line not-covered'><span class='num'>988</span>            $edge-&gt;id,
</div><div class='line not-covered'><span class='num'>989</span>            $edge-&gt;source,
</div><div class='line not-covered'><span class='num'>990</span>            $edge-&gt;target,
</div><div class='line not-covered'><span class='num'>991</span>            $edge-&gt;data
</div><div class='line not-executable'><span class='num'>992</span>        );
</div><div class='line not-covered'><span class='num'>993</span>    }
</div><div class='line not-executable'><span class='num'>994</span>
</div><div class='line not-executable'><span class='num'>995</span>    public function updateEdge(Edge $edge): void
</div><div class='line not-executable'><span class='num'>996</span>    {
</div><div class='line not-covered'><span class='num'>997</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>998</span>            throw new RuntimeException(&quot;Permission denied to update edge.&quot;);
</div><div class='line not-executable'><span class='num'>999</span>        }
</div><div class='line not-covered'><span class='num'>1000</span>        $old = $this-&gt;getEdge($edge-&gt;source, $edge-&gt;target);
</div><div class='line not-covered'><span class='num'>1001</span>        $this-&gt;insertAuditLog(new AuditLog( &#039;edge&#039;, $edge-&gt;id, &#039;update&#039;, $old-&gt;toArray(), $edge-&gt;toArray()));
</div><div class='line not-executable'><span class='num'>1002</span>
</div><div class='line not-covered'><span class='num'>1003</span>        $this-&gt;db-&gt;updateEdge(
</div><div class='line not-covered'><span class='num'>1004</span>            $edge-&gt;id,
</div><div class='line not-covered'><span class='num'>1005</span>            $edge-&gt;source,
</div><div class='line not-covered'><span class='num'>1006</span>            $edge-&gt;target,
</div><div class='line not-covered'><span class='num'>1007</span>            $edge-&gt;data
</div><div class='line not-executable'><span class='num'>1008</span>        );
</div><div class='line not-covered'><span class='num'>1009</span>    }
</div><div class='line not-executable'><span class='num'>1010</span>
</div><div class='line not-executable'><span class='num'>1011</span>    public function deleteEdge(string $id): void
</div><div class='line not-executable'><span class='num'>1012</span>    {
</div><div class='line not-covered'><span class='num'>1013</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>1014</span>            throw new RuntimeException(&quot;Permission denied to delete edge.&quot;);
</div><div class='line not-executable'><span class='num'>1015</span>        }
</div><div class='line not-covered'><span class='num'>1016</span>        $this-&gt;db-&gt;deleteEdge($id);
</div><div class='line not-covered'><span class='num'>1017</span>    }
</div><div class='line not-executable'><span class='num'>1018</span>
</div><div class='line not-executable'><span class='num'>1019</span>    public function getStatuses(): NodeStatuses
</div><div class='line not-executable'><span class='num'>1020</span>    {
</div><div class='line not-covered'><span class='num'>1021</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>1022</span>            throw new RuntimeException(&quot;Permission denied to get statuses.&quot;);
</div><div class='line not-executable'><span class='num'>1023</span>        }
</div><div class='line not-executable'><span class='num'>1024</span>
</div><div class='line not-covered'><span class='num'>1025</span>        $statusesData = $this-&gt;db-&gt;getStatuses();
</div><div class='line not-covered'><span class='num'>1026</span>        $nodeStatuses = new NodeStatuses();
</div><div class='line not-covered'><span class='num'>1027</span>        foreach ($statusesData as $data) {
</div><div class='line not-covered'><span class='num'>1028</span>            $status = new NodeStatus(
</div><div class='line not-covered'><span class='num'>1029</span>                $data[&#039;id&#039;],
</div><div class='line not-covered'><span class='num'>1030</span>                $data[&#039;status&#039;] ?? &#039;unknown&#039;
</div><div class='line not-executable'><span class='num'>1031</span>            );
</div><div class='line not-covered'><span class='num'>1032</span>            $nodeStatuses-&gt;addStatus($status);
</div><div class='line not-executable'><span class='num'>1033</span>        }
</div><div class='line not-covered'><span class='num'>1034</span>        return $nodeStatuses;
</div><div class='line not-covered'><span class='num'>1035</span>    }
</div><div class='line not-executable'><span class='num'>1036</span>
</div><div class='line not-executable'><span class='num'>1037</span>    public function getNodeStatus(string $id): NodeStatus
</div><div class='line not-executable'><span class='num'>1038</span>    {
</div><div class='line not-covered'><span class='num'>1039</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>1040</span>            throw new RuntimeException(&quot;Permission denied to get node status.&quot;);
</div><div class='line not-executable'><span class='num'>1041</span>        }
</div><div class='line not-executable'><span class='num'>1042</span>
</div><div class='line not-covered'><span class='num'>1043</span>        $statusData = $this-&gt;db-&gt;getNodeStatus($id);
</div><div class='line not-covered'><span class='num'>1044</span>        return new NodeStatus(
</div><div class='line not-covered'><span class='num'>1045</span>            $id,
</div><div class='line not-covered'><span class='num'>1046</span>            $statusData ?? &#039;unknown&#039;
</div><div class='line not-executable'><span class='num'>1047</span>        );
</div><div class='line not-covered'><span class='num'>1048</span>    }
</div><div class='line not-executable'><span class='num'>1049</span>
</div><div class='line not-executable'><span class='num'>1050</span>    public function setNodeStatus(NodeStatus $status): void
</div><div class='line not-executable'><span class='num'>1051</span>    {
</div><div class='line not-covered'><span class='num'>1052</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>1053</span>            throw new RuntimeException(&quot;Permission denied to set node status.&quot;);
</div><div class='line not-executable'><span class='num'>1054</span>        }
</div><div class='line not-executable'><span class='num'>1055</span>
</div><div class='line not-covered'><span class='num'>1056</span>        $this-&gt;db-&gt;setNodeStatus($status-&gt;nodeId, $status-&gt;status);
</div><div class='line not-covered'><span class='num'>1057</span>    }
</div><div class='line not-executable'><span class='num'>1058</span>
</div><div class='line not-executable'><span class='num'>1059</span>    public function getLogs($limit): AuditLogs
</div><div class='line not-executable'><span class='num'>1060</span>    {
</div><div class='line not-covered'><span class='num'>1061</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>1062</span>            throw new RuntimeException(&quot;Permission denied to get audit logs.&quot;);
</div><div class='line not-executable'><span class='num'>1063</span>        }
</div><div class='line not-executable'><span class='num'>1064</span>
</div><div class='line not-covered'><span class='num'>1065</span>        $logs = new AuditLogs();
</div><div class='line not-covered'><span class='num'>1066</span>        $rows = $this-&gt;db-&gt;getLogs($limit);
</div><div class='line not-covered'><span class='num'>1067</span>        foreach ($rows as $row) {
</div><div class='line not-covered'><span class='num'>1068</span>            $old_data = $row[&#039;old_data&#039;] ? json_decode($row[&#039;old_data&#039;], true) : [];
</div><div class='line not-covered'><span class='num'>1069</span>            $new_data = $row[&#039;new_data&#039;] ?  json_decode($row[&#039;new_data&#039;], true) : [];
</div><div class='line not-covered'><span class='num'>1070</span>            $log = new AuditLog(
</div><div class='line not-covered'><span class='num'>1071</span>                $row[&#039;entity_type&#039;],
</div><div class='line not-covered'><span class='num'>1072</span>                $row[&#039;entity_id&#039;],
</div><div class='line not-covered'><span class='num'>1073</span>                $row[&#039;action&#039;],
</div><div class='line not-executable'><span class='num'>1074</span>                $old_data,
</div><div class='line not-executable'><span class='num'>1075</span>                $new_data,
</div><div class='line not-executable'><span class='num'>1076</span>            );
</div><div class='line not-covered'><span class='num'>1077</span>            $log-&gt;userId    = $row[&#039;user_id&#039;];
</div><div class='line not-covered'><span class='num'>1078</span>            $log-&gt;ipAddress = $row[&#039;ip_address&#039;];
</div><div class='line not-covered'><span class='num'>1079</span>            $log-&gt;createdAt = $row[&#039;created_at&#039;];
</div><div class='line not-executable'><span class='num'>1080</span>
</div><div class='line not-covered'><span class='num'>1081</span>            $logs-&gt;addLog($log);
</div><div class='line not-executable'><span class='num'>1082</span>        }
</div><div class='line not-covered'><span class='num'>1083</span>        return $logs;
</div><div class='line not-covered'><span class='num'>1084</span>    }
</div><div class='line not-executable'><span class='num'>1085</span>
</div><div class='line not-executable'><span class='num'>1086</span>    private function insertAuditLog(AuditLog $auditLog): void
</div><div class='line not-executable'><span class='num'>1087</span>    {
</div><div class='line covered'><span class='num'>1088</span>        $user_id   = GraphContext::$user-&gt;id;
</div><div class='line covered'><span class='num'>1089</span>        $ip_address = GraphContext::$user-&gt;ipAddress;
</div><div class='line not-executable'><span class='num'>1090</span>
</div><div class='line covered'><span class='num'>1091</span>        $this-&gt;db-&gt;insertAuditLog(
</div><div class='line covered'><span class='num'>1092</span>            $auditLog-&gt;entityType,
</div><div class='line covered'><span class='num'>1093</span>            $auditLog-&gt;entityId,
</div><div class='line covered'><span class='num'>1094</span>            $auditLog-&gt;action,
</div><div class='line covered'><span class='num'>1095</span>            $auditLog-&gt;oldData,
</div><div class='line covered'><span class='num'>1096</span>            $auditLog-&gt;newData,
</div><div class='line not-executable'><span class='num'>1097</span>            $user_id,
</div><div class='line not-executable'><span class='num'>1098</span>            $ip_address
</div><div class='line not-executable'><span class='num'>1099</span>        );
</div><div class='line covered'><span class='num'>1100</span>    }
</div><div class='line not-executable'><span class='num'>1101</span>
</div><div class='line not-executable'><span class='num'>1102</span>    private function isAllowed(string $action): bool
</div><div class='line not-executable'><span class='num'>1103</span>    {
</div><div class='line covered'><span class='num'>1104</span>        $group = GraphContext::$user-&gt;group;
</div><div class='line not-executable'><span class='num'>1105</span>
</div><div class='line not-executable'><span class='num'>1106</span>        // validate action
</div><div class='line not-executable'><span class='num'>1107</span>        // if action is one of the keys in the array self::SECURE_ACTIONS
</div><div class='line covered'><span class='num'>1108</span>        if (!array_key_exists($action, self::SECURE_ACTIONS)) {
</div><div class='line not-covered'><span class='num'>1109</span>            throw new RuntimeException(&quot;Action not defined in secure actions. Action: {$action}&quot;);
</div><div class='line not-executable'><span class='num'>1110</span>        }
</div><div class='line not-executable'><span class='num'>1111</span>
</div><div class='line not-executable'><span class='num'>1112</span>        // if is admin, allow all
</div><div class='line covered'><span class='num'>1113</span>        if ($group-&gt;id === &#039;admin&#039;) {
</div><div class='line not-covered'><span class='num'>1114</span>            return true;
</div><div class='line not-executable'><span class='num'>1115</span>        }
</div><div class='line not-executable'><span class='num'>1116</span>
</div><div class='line not-executable'><span class='num'>1117</span>        // if action is in the SAFE_ACTIONS, allow all
</div><div class='line covered'><span class='num'>1118</span>        if (self::SECURE_ACTIONS[$action]) {
</div><div class='line covered'><span class='num'>1119</span>            return true;
</div><div class='line not-executable'><span class='num'>1120</span>        }
</div><div class='line not-executable'><span class='num'>1121</span>        
</div><div class='line not-executable'><span class='num'>1122</span>        // if action is restricted, only allow contributor
</div><div class='line covered'><span class='num'>1123</span>        if (self::SECURE_ACTIONS[$action] == false &amp;&amp; $group-&gt;id == &#039;contributor&#039;)
</div><div class='line not-executable'><span class='num'>1124</span>        {
</div><div class='line covered'><span class='num'>1125</span>            return true;
</div><div class='line not-executable'><span class='num'>1126</span>        }
</div><div class='line not-executable'><span class='num'>1127</span>
</div><div class='line not-covered'><span class='num'>1128</span>        return false;
</div><div class='line not-covered'><span class='num'>1129</span>    }
</div><div class='line not-executable'><span class='num'>1130</span>}
</div><div class='line not-executable'><span class='num'>1131</span>
</div><div class='line not-executable'><span class='num'>1132</span>final class Request
</div><div class='line not-executable'><span class='num'>1133</span>{
</div><div class='line not-executable'><span class='num'>1134</span>    public array $data;
</div><div class='line not-executable'><span class='num'>1135</span>
</div><div class='line not-executable'><span class='num'>1136</span>    public function getParam($name): string
</div><div class='line not-executable'><span class='num'>1137</span>    {
</div><div class='line covered'><span class='num'>1138</span>        if(isset($_GET[$name])) {
</div><div class='line covered'><span class='num'>1139</span>            return $_GET[$name];
</div><div class='line not-executable'><span class='num'>1140</span>        }
</div><div class='line not-executable'><span class='num'>1141</span>
</div><div class='line not-covered'><span class='num'>1142</span>        throw new RuntimeException(&quot;param &#039;{$name}&#039; not found&quot;);
</div><div class='line not-covered'><span class='num'>1143</span>    }
</div><div class='line not-executable'><span class='num'>1144</span>
</div><div class='line not-executable'><span class='num'>1145</span>    public function getPath(): string
</div><div class='line not-executable'><span class='num'>1146</span>    {
</div><div class='line not-covered'><span class='num'>1147</span>        $scriptName = $_SERVER[&#039;SCRIPT_NAME&#039;];
</div><div class='line not-covered'><span class='num'>1148</span>        $requestUri = $_SERVER[&#039;REQUEST_URI&#039;];
</div><div class='line not-covered'><span class='num'>1149</span>        $requestUri = strtok($requestUri, &#039;?&#039;);
</div><div class='line not-covered'><span class='num'>1150</span>        $path = str_replace($scriptName, &#039;&#039;, $requestUri);
</div><div class='line not-covered'><span class='num'>1151</span>        return $path;
</div><div class='line not-covered'><span class='num'>1152</span>    }
</div><div class='line not-executable'><span class='num'>1153</span>}
</div><div class='line not-executable'><span class='num'>1154</span>
</div><div class='line not-executable'><span class='num'>1155</span>interface ResponseInterface
</div><div class='line not-executable'><span class='num'>1156</span>{
</div><div class='line not-executable'><span class='num'>1157</span>    public function send(): void;
</div><div class='line not-executable'><span class='num'>1158</span>}
</div><div class='line not-executable'><span class='num'>1159</span>
</div><div class='line not-executable'><span class='num'>1160</span>class Response implements ResponseInterface
</div><div class='line not-executable'><span class='num'>1161</span>{
</div><div class='line not-executable'><span class='num'>1162</span>    public int $code;
</div><div class='line not-executable'><span class='num'>1163</span>    public string $status;
</div><div class='line not-executable'><span class='num'>1164</span>    public string $message;
</div><div class='line not-executable'><span class='num'>1165</span>    public array $data;
</div><div class='line not-executable'><span class='num'>1166</span>
</div><div class='line not-executable'><span class='num'>1167</span>    public function __construct(int $code, string $status, string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1168</span>    {
</div><div class='line covered'><span class='num'>1169</span>        $this-&gt;code = $code;
</div><div class='line covered'><span class='num'>1170</span>        $this-&gt;status = $status;
</div><div class='line covered'><span class='num'>1171</span>        $this-&gt;message = $message;
</div><div class='line covered'><span class='num'>1172</span>        $this-&gt;data = $data;
</div><div class='line covered'><span class='num'>1173</span>    }
</div><div class='line not-executable'><span class='num'>1174</span>
</div><div class='line not-executable'><span class='num'>1175</span>    public function send(): void
</div><div class='line not-executable'><span class='num'>1176</span>    {
</div><div class='line not-covered'><span class='num'>1177</span>        header(&#039;Content-Type: application/json; charset=utf-8&#039;);
</div><div class='line not-covered'><span class='num'>1178</span>        http_response_code($this-&gt;code);
</div><div class='line not-covered'><span class='num'>1179</span>        $this-&gt;data = [&#039;code&#039; =&gt; $this-&gt;code, &#039;status&#039; =&gt; $this-&gt;status, &#039;message&#039; =&gt; $this-&gt;message, &#039;data&#039; =&gt; $this-&gt;data];
</div><div class='line not-covered'><span class='num'>1180</span>        echo json_encode($this-&gt;data, JSON_UNESCAPED_UNICODE |  JSON_UNESCAPED_SLASHES |  JSON_PRETTY_PRINT);
</div><div class='line not-covered'><span class='num'>1181</span>    }
</div><div class='line not-executable'><span class='num'>1182</span>}
</div><div class='line not-executable'><span class='num'>1183</span>
</div><div class='line not-executable'><span class='num'>1184</span>class OKResponse extends Response
</div><div class='line not-executable'><span class='num'>1185</span>{
</div><div class='line not-executable'><span class='num'>1186</span>    public function __construct(string $message, array $data)
</div><div class='line not-executable'><span class='num'>1187</span>    {
</div><div class='line covered'><span class='num'>1188</span>        return parent::__construct(200, &#039;success&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1189</span>    }
</div><div class='line not-executable'><span class='num'>1190</span>}
</div><div class='line not-executable'><span class='num'>1191</span>
</div><div class='line not-executable'><span class='num'>1192</span>class CreatedResponse extends Response
</div><div class='line not-executable'><span class='num'>1193</span>{
</div><div class='line not-executable'><span class='num'>1194</span>    public function __construct(string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1195</span>    {
</div><div class='line covered'><span class='num'>1196</span>        return parent::__construct(201, &#039;success&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1197</span>    }
</div><div class='line not-executable'><span class='num'>1198</span>}
</div><div class='line not-executable'><span class='num'>1199</span>
</div><div class='line not-executable'><span class='num'>1200</span>class BadRequestResponse extends Response
</div><div class='line not-executable'><span class='num'>1201</span>{
</div><div class='line not-executable'><span class='num'>1202</span>    public function __construct(string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1203</span>    {
</div><div class='line not-covered'><span class='num'>1204</span>        return parent::__construct(400, &#039;error&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1205</span>    }
</div><div class='line not-executable'><span class='num'>1206</span>}
</div><div class='line not-executable'><span class='num'>1207</span>
</div><div class='line not-executable'><span class='num'>1208</span>class UnauthorizedResponse extends Response
</div><div class='line not-executable'><span class='num'>1209</span>{
</div><div class='line not-executable'><span class='num'>1210</span>    public function __construct(string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1211</span>    {
</div><div class='line not-covered'><span class='num'>1212</span>        return parent::__construct(401, &#039;error&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1213</span>    }
</div><div class='line not-executable'><span class='num'>1214</span>}
</div><div class='line not-executable'><span class='num'>1215</span>
</div><div class='line not-executable'><span class='num'>1216</span>class ForbiddenResponse extends Response
</div><div class='line not-executable'><span class='num'>1217</span>{
</div><div class='line not-executable'><span class='num'>1218</span>    public function __construct(string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1219</span>    {
</div><div class='line not-covered'><span class='num'>1220</span>        return parent::__construct(403, &#039;error&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1221</span>    }
</div><div class='line not-executable'><span class='num'>1222</span>}
</div><div class='line not-executable'><span class='num'>1223</span>
</div><div class='line not-executable'><span class='num'>1224</span>class NotFoundResponse extends Response
</div><div class='line not-executable'><span class='num'>1225</span>{
</div><div class='line not-executable'><span class='num'>1226</span>    public function __construct(string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1227</span>    {
</div><div class='line not-covered'><span class='num'>1228</span>        return parent::__construct(404, &#039;error&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1229</span>    }
</div><div class='line not-executable'><span class='num'>1230</span>}
</div><div class='line not-executable'><span class='num'>1231</span>
</div><div class='line not-executable'><span class='num'>1232</span>class InternalServerErrorResponse extends Response
</div><div class='line not-executable'><span class='num'>1233</span>{
</div><div class='line not-executable'><span class='num'>1234</span>    public function __construct(string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1235</span>    {
</div><div class='line not-covered'><span class='num'>1236</span>        return parent::__construct(500, &#039;error&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1237</span>    }
</div><div class='line not-executable'><span class='num'>1238</span>}
</div><div class='line not-executable'><span class='num'>1239</span>
</div><div class='line not-executable'><span class='num'>1240</span>interface GraphControllerInterface
</div><div class='line not-executable'><span class='num'>1241</span>{
</div><div class='line not-executable'><span class='num'>1242</span>    public function getUser(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1243</span>    public function insertUser(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1244</span>    public function updateUser(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1245</span>
</div><div class='line not-executable'><span class='num'>1246</span>    public function getGraph(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1247</span>
</div><div class='line not-executable'><span class='num'>1248</span>    public function getNode(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1249</span>    public function getNodes(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1250</span>    public function insertNode(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1251</span>    public function updateNode(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1252</span>    public function deleteNode(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1253</span>
</div><div class='line not-executable'><span class='num'>1254</span>    public function getEdge(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1255</span>    public function getEdges(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1256</span>    public function insertEdge(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1257</span>    public function updateEdge(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1258</span>    public function deleteEdge(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1259</span>
</div><div class='line not-executable'><span class='num'>1260</span>    public function getStatuses(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1261</span>    public function getNodeStatus(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1262</span>    public function setNodeStatus(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1263</span>
</div><div class='line not-executable'><span class='num'>1264</span>    public function getLogs(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1265</span>}
</div><div class='line not-executable'><span class='num'>1266</span>
</div><div class='line not-executable'><span class='num'>1267</span>final class GraphControllerException extends RuntimeException
</div><div class='line not-executable'><span class='num'>1268</span>{
</div><div class='line not-executable'><span class='num'>1269</span>}
</div><div class='line not-executable'><span class='num'>1270</span>
</div><div class='line not-executable'><span class='num'>1271</span>final class GraphController implements GraphControllerInterface
</div><div class='line not-executable'><span class='num'>1272</span>{
</div><div class='line not-executable'><span class='num'>1273</span>    private GraphServiceInterface $service;
</div><div class='line not-executable'><span class='num'>1274</span>    private Logger $logger;
</div><div class='line not-executable'><span class='num'>1275</span>
</div><div class='line not-executable'><span class='num'>1276</span>    public function __construct(GraphServiceInterface $service, Logger $logger)
</div><div class='line not-executable'><span class='num'>1277</span>    {
</div><div class='line covered'><span class='num'>1278</span>        $this-&gt;service = $service;
</div><div class='line covered'><span class='num'>1279</span>        $this-&gt;logger = $logger;
</div><div class='line covered'><span class='num'>1280</span>    }
</div><div class='line not-executable'><span class='num'>1281</span>
</div><div class='line not-executable'><span class='num'>1282</span>    public function getUser(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1283</span>    {
</div><div class='line not-covered'><span class='num'>1284</span>        $data = $this-&gt;service-&gt;getUser($req-&gt;data[&#039;id&#039;]);
</div><div class='line not-covered'><span class='num'>1285</span>        $user = new User($data[&#039;id&#039;], null, new Group($data[&#039;user_group&#039;]));
</div><div class='line not-covered'><span class='num'>1286</span>        return new OKResponse(&#039;user found&#039;, $user-&gt;toArray());
</div><div class='line not-covered'><span class='num'>1287</span>    }
</div><div class='line not-executable'><span class='num'>1288</span>
</div><div class='line not-executable'><span class='num'>1289</span>    public function insertUser(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1290</span>    {
</div><div class='line not-covered'><span class='num'>1291</span>        $user = new User($req-&gt;data[&#039;id&#039;], null, $req-&gt;data[&#039;user_group&#039;]);
</div><div class='line not-covered'><span class='num'>1292</span>        $this-&gt;service-&gt;insertUser($user);
</div><div class='line not-covered'><span class='num'>1293</span>        return new OKResponse(&#039;user created&#039;, $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1294</span>    }
</div><div class='line not-executable'><span class='num'>1295</span>
</div><div class='line not-executable'><span class='num'>1296</span>    public function updateUser(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1297</span>    {
</div><div class='line not-covered'><span class='num'>1298</span>        $user = new User($req-&gt;data[&#039;id&#039;], null, $req-&gt;data[&#039;user_group&#039;]);
</div><div class='line not-covered'><span class='num'>1299</span>        $this-&gt;service-&gt;updateUser($user);
</div><div class='line not-covered'><span class='num'>1300</span>        return new CreatedResponse(&#039;user updated&#039;, $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1301</span>    }
</div><div class='line not-executable'><span class='num'>1302</span>
</div><div class='line not-executable'><span class='num'>1303</span>    public function getGraph(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1304</span>    {
</div><div class='line not-executable'><span class='num'>1305</span>        try {
</div><div class='line not-covered'><span class='num'>1306</span>            $data = $this-&gt;service-&gt;getGraph()-&gt;toArray();
</div><div class='line not-covered'><span class='num'>1307</span>            return new OKResponse(&#039;get graph&#039;, $data);
</div><div class='line not-covered'><span class='num'>1308</span>            return $resp;
</div><div class='line not-covered'><span class='num'>1309</span>        } catch (Exception $e) {
</div><div class='line not-covered'><span class='num'>1310</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1311</span>        }
</div><div class='line not-executable'><span class='num'>1312</span>
</div><div class='line not-covered'><span class='num'>1313</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1314</span>    }
</div><div class='line not-executable'><span class='num'>1315</span>
</div><div class='line not-executable'><span class='num'>1316</span>    public function getNode(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1317</span>    {
</div><div class='line not-executable'><span class='num'>1318</span>        try {
</div><div class='line covered'><span class='num'>1319</span>            $id = $req-&gt;getParam(&#039;id&#039;);
</div><div class='line covered'><span class='num'>1320</span>            $node = $this-&gt;service-&gt;getNode($id);
</div><div class='line covered'><span class='num'>1321</span>            $data = $node-&gt;toArray();
</div><div class='line covered'><span class='num'>1322</span>            return new OKResponse(&#039;node found&#039;, $data);
</div><div class='line not-covered'><span class='num'>1323</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1324</span>        {
</div><div class='line not-covered'><span class='num'>1325</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1326</span>        }
</div><div class='line not-executable'><span class='num'>1327</span>
</div><div class='line not-covered'><span class='num'>1328</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1329</span>    }
</div><div class='line not-executable'><span class='num'>1330</span>
</div><div class='line not-executable'><span class='num'>1331</span>    public function getNodes(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1332</span>    {
</div><div class='line not-executable'><span class='num'>1333</span>        try {
</div><div class='line not-covered'><span class='num'>1334</span>            $nodes = $this-&gt;service-&gt;getNodes();
</div><div class='line not-executable'><span class='num'>1335</span>            // TODO: corrigir
</div><div class='line not-covered'><span class='num'>1336</span>            return new OKResponse(&#039;nodes found&#039;, []);
</div><div class='line not-covered'><span class='num'>1337</span>            return $resp;
</div><div class='line not-covered'><span class='num'>1338</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1339</span>        {
</div><div class='line not-covered'><span class='num'>1340</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1341</span>        }
</div><div class='line not-executable'><span class='num'>1342</span>        
</div><div class='line not-covered'><span class='num'>1343</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1344</span>    }
</div><div class='line not-executable'><span class='num'>1345</span>
</div><div class='line not-executable'><span class='num'>1346</span>    public function insertNode(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1347</span>    {
</div><div class='line covered'><span class='num'>1348</span>        $this-&gt;logger-&gt;debug(&#039;inserting node&#039;, $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1349</span>        try {
</div><div class='line covered'><span class='num'>1350</span>            $node = new Node($req-&gt;data[&#039;id&#039;], $req-&gt;data[&#039;label&#039;], $req-&gt;data[&#039;category&#039;], $req-&gt;data[&#039;type&#039;], $req-&gt;data[&#039;data&#039;]);
</div><div class='line covered'><span class='num'>1351</span>            $this-&gt;service-&gt;insertNode($node);
</div><div class='line covered'><span class='num'>1352</span>            $this-&gt;logger-&gt;info(&#039;node inserted&#039;, $req-&gt;data);
</div><div class='line covered'><span class='num'>1353</span>            return new CreatedResponse(&#039;node inserted&#039;, $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1354</span>        } catch( GraphServiceException $e)
</div><div class='line not-executable'><span class='num'>1355</span>        {
</div><div class='line not-covered'><span class='num'>1356</span>            $this-&gt;logger-&gt;error(&#039;The service could not insert new node:&#039; . $e-&gt;getMessage());
</div><div class='line not-covered'><span class='num'>1357</span>            throw new GraphControllerException(&#039;The service could not insert new node:&#039; . $e-&gt;getMessage(), 0, $e);
</div><div class='line not-executable'><span class='num'>1358</span>        }
</div><div class='line not-covered'><span class='num'>1359</span>        return new InternalServerErrorResponse(&#039;unknow error inserting node&#039;, $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1360</span>    }
</div><div class='line not-executable'><span class='num'>1361</span>    
</div><div class='line not-executable'><span class='num'>1362</span>    public function updateNode(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1363</span>    {
</div><div class='line not-executable'><span class='num'>1364</span>        try {
</div><div class='line not-covered'><span class='num'>1365</span>            $edge = new Edge($req-&gt;data[&#039;id&#039;], $req-&gt;data[&#039;source&#039;], $req-&gt;data[&#039;target&#039;], $req-&gt;data[&#039;data&#039;]);
</div><div class='line not-covered'><span class='num'>1366</span>            $this-&gt;service-&gt;insertEdge($edge);
</div><div class='line not-covered'><span class='num'>1367</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1368</span>        {
</div><div class='line not-covered'><span class='num'>1369</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1370</span>        }
</div><div class='line not-executable'><span class='num'>1371</span>        
</div><div class='line not-covered'><span class='num'>1372</span>        return new InternalServerErrorResponse(&#039;unknow todo in updateNode&#039;, $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1373</span>    }
</div><div class='line not-executable'><span class='num'>1374</span>    
</div><div class='line not-executable'><span class='num'>1375</span>    public function deleteNode(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1376</span>    {
</div><div class='line not-executable'><span class='num'>1377</span>        try {
</div><div class='line not-covered'><span class='num'>1378</span>            $this-&gt;service-&gt;deleteEdge($req-&gt;data[&#039;id&#039;]);
</div><div class='line not-covered'><span class='num'>1379</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1380</span>        {
</div><div class='line not-covered'><span class='num'>1381</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1382</span>        }
</div><div class='line not-executable'><span class='num'>1383</span>        
</div><div class='line not-covered'><span class='num'>1384</span>        return new InternalServerErrorResponse(&#039;unknow todo in deleteNode&#039;, $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1385</span>    }
</div><div class='line not-executable'><span class='num'>1386</span>
</div><div class='line not-executable'><span class='num'>1387</span>    public function getEdge(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1388</span>    {
</div><div class='line not-executable'><span class='num'>1389</span>        try {
</div><div class='line not-covered'><span class='num'>1390</span>            $edge = $this-&gt;service-&gt;getEdge($req-&gt;data[&#039;source&#039;], $req-&gt;data[&#039;target&#039;]);
</div><div class='line not-covered'><span class='num'>1391</span>            $data = $edge-&gt;toArray();
</div><div class='line not-covered'><span class='num'>1392</span>            return new OKResponse(&#039;node found&#039;, $data);
</div><div class='line not-covered'><span class='num'>1393</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1394</span>        {
</div><div class='line not-covered'><span class='num'>1395</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1396</span>        }
</div><div class='line not-executable'><span class='num'>1397</span>        
</div><div class='line not-covered'><span class='num'>1398</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1399</span>    }
</div><div class='line not-executable'><span class='num'>1400</span>    
</div><div class='line not-executable'><span class='num'>1401</span>    public function getEdges(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1402</span>    {
</div><div class='line not-executable'><span class='num'>1403</span>        try {
</div><div class='line not-covered'><span class='num'>1404</span>            $edges = $this-&gt;service-&gt;getEdges();
</div><div class='line not-executable'><span class='num'>1405</span>            // TODO: corrigir
</div><div class='line not-covered'><span class='num'>1406</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1407</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1408</span>        {
</div><div class='line not-covered'><span class='num'>1409</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1410</span>        }
</div><div class='line not-executable'><span class='num'>1411</span>        
</div><div class='line not-covered'><span class='num'>1412</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1413</span>    }
</div><div class='line not-executable'><span class='num'>1414</span>    
</div><div class='line not-executable'><span class='num'>1415</span>    public function insertEdge(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1416</span>    {
</div><div class='line not-executable'><span class='num'>1417</span>        try {
</div><div class='line not-covered'><span class='num'>1418</span>            $edge = new Edge(null, $req-&gt;data[&#039;source&#039;], $req-&gt;data[&#039;target&#039;]);
</div><div class='line not-covered'><span class='num'>1419</span>            $this-&gt;service-&gt;insertEdge($edge);
</div><div class='line not-covered'><span class='num'>1420</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1421</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1422</span>        {
</div><div class='line not-covered'><span class='num'>1423</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1424</span>        }
</div><div class='line not-executable'><span class='num'>1425</span>        
</div><div class='line not-covered'><span class='num'>1426</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1427</span>    }
</div><div class='line not-executable'><span class='num'>1428</span>    
</div><div class='line not-executable'><span class='num'>1429</span>    public function updateEdge(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1430</span>    {
</div><div class='line not-executable'><span class='num'>1431</span>        try {
</div><div class='line not-covered'><span class='num'>1432</span>            $edge = new Edge($req-&gt;data[&#039;id&#039;], $req-&gt;data[&#039;source&#039;], $req-&gt;data[&#039;target&#039;], $req-&gt;data[&#039;data&#039;]);
</div><div class='line not-covered'><span class='num'>1433</span>            $this-&gt;service-&gt;updateEdge($edge);
</div><div class='line not-covered'><span class='num'>1434</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1435</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1436</span>        {
</div><div class='line not-covered'><span class='num'>1437</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1438</span>        }
</div><div class='line not-executable'><span class='num'>1439</span>        
</div><div class='line not-covered'><span class='num'>1440</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1441</span>    }
</div><div class='line not-executable'><span class='num'>1442</span>    
</div><div class='line not-executable'><span class='num'>1443</span>    public function deleteEdge(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1444</span>    {
</div><div class='line not-executable'><span class='num'>1445</span>        try {
</div><div class='line not-covered'><span class='num'>1446</span>            $id = $req-&gt;data[&#039;id&#039;];
</div><div class='line not-covered'><span class='num'>1447</span>            $this-&gt;service-&gt;deleteEdge($id);
</div><div class='line not-covered'><span class='num'>1448</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1449</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1450</span>        {
</div><div class='line not-covered'><span class='num'>1451</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1452</span>        }
</div><div class='line not-executable'><span class='num'>1453</span>        
</div><div class='line not-covered'><span class='num'>1454</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1455</span>    }
</div><div class='line not-executable'><span class='num'>1456</span>
</div><div class='line not-executable'><span class='num'>1457</span>    public function getStatuses(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1458</span>    {
</div><div class='line not-executable'><span class='num'>1459</span>        try {
</div><div class='line not-covered'><span class='num'>1460</span>            $statuses = $this-&gt;service-&gt;getStatuses();
</div><div class='line not-covered'><span class='num'>1461</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1462</span>            return $resp;
</div><div class='line not-covered'><span class='num'>1463</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1464</span>        {
</div><div class='line not-covered'><span class='num'>1465</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1466</span>        }
</div><div class='line not-executable'><span class='num'>1467</span>        
</div><div class='line not-covered'><span class='num'>1468</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1469</span>    }
</div><div class='line not-executable'><span class='num'>1470</span>    
</div><div class='line not-executable'><span class='num'>1471</span>    public function getNodeStatus(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1472</span>    {
</div><div class='line not-executable'><span class='num'>1473</span>        try {
</div><div class='line not-covered'><span class='num'>1474</span>            $status = $this-&gt;service-&gt;getNodeStatus($req-&gt;data[&#039;id&#039;]);
</div><div class='line not-covered'><span class='num'>1475</span>            $data = $status-&gt;toArray();
</div><div class='line not-covered'><span class='num'>1476</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1477</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1478</span>        {
</div><div class='line not-covered'><span class='num'>1479</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1480</span>        }
</div><div class='line not-executable'><span class='num'>1481</span>        
</div><div class='line not-covered'><span class='num'>1482</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1483</span>    }
</div><div class='line not-executable'><span class='num'>1484</span>    
</div><div class='line not-executable'><span class='num'>1485</span>    public function setNodeStatus(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1486</span>    {
</div><div class='line not-executable'><span class='num'>1487</span>        try {
</div><div class='line not-covered'><span class='num'>1488</span>            $status = new NodeStatus($req-&gt;data[&#039;node_id&#039;], $req-&gt;data[&#039;status&#039;]);
</div><div class='line not-covered'><span class='num'>1489</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1490</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1491</span>        {
</div><div class='line not-covered'><span class='num'>1492</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1493</span>        }
</div><div class='line not-executable'><span class='num'>1494</span>        
</div><div class='line not-covered'><span class='num'>1495</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1496</span>    }
</div><div class='line not-executable'><span class='num'>1497</span>
</div><div class='line not-executable'><span class='num'>1498</span>    public function getLogs(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1499</span>    {
</div><div class='line not-executable'><span class='num'>1500</span>        try {
</div><div class='line not-covered'><span class='num'>1501</span>            $logs = $this-&gt;service-&gt;getLogs($req-&gt;getParam(&#039;limit&#039;));
</div><div class='line not-covered'><span class='num'>1502</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1503</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1504</span>        {
</div><div class='line not-covered'><span class='num'>1505</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1506</span>        }
</div><div class='line not-executable'><span class='num'>1507</span>        
</div><div class='line not-covered'><span class='num'>1508</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1509</span>    }
</div><div class='line not-executable'><span class='num'>1510</span>}
</div><div class='line not-executable'><span class='num'>1511</span>
</div><div class='line not-executable'><span class='num'>1512</span>final class RequestRouter
</div><div class='line not-executable'><span class='num'>1513</span>{
</div><div class='line not-executable'><span class='num'>1514</span>    private $routes = [
</div><div class='line not-executable'><span class='num'>1515</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getGraph&#039;, &#039;class_method&#039; =&gt; &#039;getGraph&#039;],
</div><div class='line not-executable'><span class='num'>1516</span>        
</div><div class='line not-executable'><span class='num'>1517</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getNode&#039;, &#039;class_method&#039; =&gt; &#039;getNode&#039;],
</div><div class='line not-executable'><span class='num'>1518</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getNodes&#039;, &#039;class_method&#039; =&gt; &#039;getNodes&#039;],
</div><div class='line not-executable'><span class='num'>1519</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/insertNode&#039;, &#039;class_method&#039; =&gt; &#039;insertNode&#039;],
</div><div class='line not-executable'><span class='num'>1520</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/updateNode&#039;, &#039;class_method&#039; =&gt; &#039;updateNode&#039;],
</div><div class='line not-executable'><span class='num'>1521</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/deleteNode&#039;, &#039;class_method&#039; =&gt; &#039;deleteNode&#039;],
</div><div class='line not-executable'><span class='num'>1522</span>
</div><div class='line not-executable'><span class='num'>1523</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getEdge&#039;, &#039;class_method&#039; =&gt; &#039;getEdge&#039;],
</div><div class='line not-executable'><span class='num'>1524</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getEdges&#039;, &#039;class_method&#039; =&gt; &#039;getEdges&#039;],
</div><div class='line not-executable'><span class='num'>1525</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/insertEdge&#039;, &#039;class_method&#039; =&gt; &#039;insertEdge&#039;],
</div><div class='line not-executable'><span class='num'>1526</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/updateEdge&#039;, &#039;class_method&#039; =&gt; &#039;updateEdge&#039;],
</div><div class='line not-executable'><span class='num'>1527</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/deleteEdge&#039;, &#039;class_method&#039; =&gt; &#039;deleteEdge&#039;],
</div><div class='line not-executable'><span class='num'>1528</span>
</div><div class='line not-executable'><span class='num'>1529</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getStatuses&#039;, &#039;class_method&#039; =&gt; &#039;getStatuses&#039;],
</div><div class='line not-executable'><span class='num'>1530</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getNodeStatus&#039;, &#039;class_method&#039; =&gt; &#039;getNodeStatus&#039;],
</div><div class='line not-executable'><span class='num'>1531</span>
</div><div class='line not-executable'><span class='num'>1532</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getLogs&#039;, &#039;class_method&#039; =&gt; &#039;getLogs&#039;],
</div><div class='line not-executable'><span class='num'>1533</span>
</div><div class='line not-executable'><span class='num'>1534</span>        ];
</div><div class='line not-executable'><span class='num'>1535</span>
</div><div class='line not-executable'><span class='num'>1536</span>    public GraphController $controller;
</div><div class='line not-executable'><span class='num'>1537</span>    
</div><div class='line not-executable'><span class='num'>1538</span>    public function __construct(GraphController $controller)
</div><div class='line not-executable'><span class='num'>1539</span>    {
</div><div class='line not-covered'><span class='num'>1540</span>        $this-&gt;controller = $controller;
</div><div class='line not-covered'><span class='num'>1541</span>    }
</div><div class='line not-executable'><span class='num'>1542</span>
</div><div class='line not-executable'><span class='num'>1543</span>    public function handle(): void
</div><div class='line not-executable'><span class='num'>1544</span>    {
</div><div class='line not-covered'><span class='num'>1545</span>        $method = $_SERVER[&#039;REQUEST_METHOD&#039;];
</div><div class='line not-executable'><span class='num'>1546</span>
</div><div class='line not-covered'><span class='num'>1547</span>        $scriptName = $_SERVER[&#039;SCRIPT_NAME&#039;];
</div><div class='line not-covered'><span class='num'>1548</span>        $requestUri = $_SERVER[&#039;REQUEST_URI&#039;];
</div><div class='line not-covered'><span class='num'>1549</span>        $requestUri = strtok($requestUri, &#039;?&#039;);
</div><div class='line not-executable'><span class='num'>1550</span>        
</div><div class='line not-covered'><span class='num'>1551</span>        $path = str_replace($scriptName, &#039;&#039;, $requestUri);
</div><div class='line not-executable'><span class='num'>1552</span>        
</div><div class='line not-covered'><span class='num'>1553</span>        $req = new Request();
</div><div class='line not-executable'><span class='num'>1554</span>
</div><div class='line not-covered'><span class='num'>1555</span>        foreach($this-&gt;routes as $route)
</div><div class='line not-executable'><span class='num'>1556</span>        {
</div><div class='line not-covered'><span class='num'>1557</span>            if ($route[&#039;method&#039;] == $method &amp;&amp; $route[&#039;path&#039;] == $path)
</div><div class='line not-executable'><span class='num'>1558</span>            {
</div><div class='line not-covered'><span class='num'>1559</span>                $method = $route[&#039;class_method&#039;];
</div><div class='line not-covered'><span class='num'>1560</span>                $resp = $this-&gt;controller-&gt;$method($req);
</div><div class='line not-covered'><span class='num'>1561</span>                print_r($resp);
</div><div class='line not-covered'><span class='num'>1562</span>                exit();
</div><div class='line not-executable'><span class='num'>1563</span>            }
</div><div class='line not-executable'><span class='num'>1564</span>        }
</div><div class='line not-covered'><span class='num'>1565</span>    }
</div><div class='line not-executable'><span class='num'>1566</span>}
</div><div class='line not-executable'><span class='num'>1567</span>
</div><div class='line not-executable'><span class='num'>1568</span>
</div></body></html><html><head><meta charset='UTF-8'><style>
body { font-family: monospace; font-size: 12px; background: #222; color: #ddd; margin: 0; }
.covered { background: #1a4d1a; }
.not-covered { background: #4d1a1a; }
.not-executable { background: #2a2a2a; color: #666; }
.line { padding: 2px 10px; white-space: pre; border-left: 3px solid transparent; }
.covered { border-left-color: #0f0; }
.not-covered { border-left-color: #f00; }
.num { color: #666; width: 50px; display: inline-block; text-align: right; margin-right: 10px; }
h2 { background: #333; padding: 10px; margin: 20px 0 0 0; position: sticky; top: 0; }
</style></head><body><h2>/home/tarcisio/projects/graph/tests.php - 75.86% (44/58)</h2><div class='line not-executable'><span class='num'>1</span>&lt;?php
</div><div class='line not-executable'><span class='num'>2</span>
</div><div class='line not-executable'><span class='num'>3</span>declare(strict_types=1);
</div><div class='line not-executable'><span class='num'>4</span>
</div><div class='line not-executable'><span class='num'>5</span>require_once __DIR__ . &#039;/graph.php&#039;;
</div><div class='line not-executable'><span class='num'>6</span>
</div><div class='line not-executable'><span class='num'>7</span>ini_set(&#039;xdebug.mode&#039;, &#039;1&#039;);
</div><div class='line not-executable'><span class='num'>8</span>xdebug_start_code_coverage(XDEBUG_CC_UNUSED | XDEBUG_CC_DEAD_CODE);
</div><div class='line not-executable'><span class='num'>9</span>
</div><div class='line not-executable'><span class='num'>10</span>function array_diff_recursive($array1, $array2) {
</div><div class='line covered'><span class='num'>11</span>    $diff = [];
</div><div class='line not-executable'><span class='num'>12</span>    
</div><div class='line covered'><span class='num'>13</span>    foreach ($array1 as $key =&gt; $value) {
</div><div class='line covered'><span class='num'>14</span>        if (!array_key_exists($key, $array2)) {
</div><div class='line not-covered'><span class='num'>15</span>            $diff[$key] = $value;
</div><div class='line covered'><span class='num'>16</span>        } elseif (is_array($value)) {
</div><div class='line covered'><span class='num'>17</span>            if (!is_array($array2[$key])) {
</div><div class='line not-covered'><span class='num'>18</span>                $diff[$key] = $value;
</div><div class='line not-executable'><span class='num'>19</span>            } else {
</div><div class='line covered'><span class='num'>20</span>                $recursiveDiff = array_diff_recursive($value, $array2[$key]);
</div><div class='line covered'><span class='num'>21</span>                if (count($recursiveDiff)) {
</div><div class='line not-covered'><span class='num'>22</span>                    $diff[$key] = $recursiveDiff;
</div><div class='line not-executable'><span class='num'>23</span>                }
</div><div class='line not-executable'><span class='num'>24</span>            }
</div><div class='line covered'><span class='num'>25</span>        } elseif ($value !== $array2[$key]) {
</div><div class='line not-covered'><span class='num'>26</span>            $diff[$key] = $value;
</div><div class='line not-executable'><span class='num'>27</span>        }
</div><div class='line not-executable'><span class='num'>28</span>    }
</div><div class='line not-executable'><span class='num'>29</span>    
</div><div class='line covered'><span class='num'>30</span>    return $diff;
</div><div class='line not-covered'><span class='num'>31</span>}
</div><div class='line not-executable'><span class='num'>32</span>
</div><div class='line not-executable'><span class='num'>33</span>function get_test_graph_controller()
</div><div class='line not-executable'><span class='num'>34</span>{
</div><div class='line covered'><span class='num'>35</span>    GraphContext::$user = new User(&#039;test_user&#039;, &#039;127.0.0.1&#039;, new Group(&#039;contributor&#039;));
</div><div class='line covered'><span class='num'>36</span>    $pdo = GraphDatabase::createConnection(&#039;sqlite::memory:&#039;);
</div><div class='line covered'><span class='num'>37</span>    $databaseLogger = new Logger(&#039;database.log&#039;);
</div><div class='line not-executable'><span class='num'>38</span>
</div><div class='line covered'><span class='num'>39</span>    $graphDb = new GraphDatabase($pdo, $databaseLogger);
</div><div class='line not-executable'><span class='num'>40</span>
</div><div class='line covered'><span class='num'>41</span>    $serviceLogger = new Logger(&#039;service.log&#039;);
</div><div class='line covered'><span class='num'>42</span>    $graphService = new GraphService($graphDb, $serviceLogger);
</div><div class='line not-executable'><span class='num'>43</span>
</div><div class='line covered'><span class='num'>44</span>    $controllerLogger = new Logger(&#039;controller.log&#039;);
</div><div class='line covered'><span class='num'>45</span>    $graphController = new GraphController($graphService, $controllerLogger);
</div><div class='line not-executable'><span class='num'>46</span>    
</div><div class='line covered'><span class='num'>47</span>    return $graphController;
</div><div class='line not-covered'><span class='num'>48</span>}
</div><div class='line not-executable'><span class='num'>49</span>
</div><div class='line not-executable'><span class='num'>50</span>function test_node_good_path()
</div><div class='line not-executable'><span class='num'>51</span>{
</div><div class='line covered'><span class='num'>52</span>    $graphController = get_test_graph_controller();
</div><div class='line covered'><span class='num'>53</span>    $insertNodeReq = new Request();
</div><div class='line covered'><span class='num'>54</span>    $insertNodeReq-&gt;data = [&#039;id&#039; =&gt; &#039;node1&#039;, &#039;label&#039; =&gt; &#039;node1&#039;, &#039;category&#039; =&gt; &#039;business&#039;, &#039;type&#039; =&gt; &#039;server&#039;, &#039;data&#039; =&gt; [&#039;info&#039; =&gt; &#039;first node&#039;]];
</div><div class='line covered'><span class='num'>55</span>    $resp = $graphController-&gt;insertNode($insertNodeReq);
</div><div class='line not-executable'><span class='num'>56</span>    
</div><div class='line covered'><span class='num'>57</span>    $expected = [
</div><div class='line not-executable'><span class='num'>58</span>        &#039;id&#039;       =&gt; &#039;node1&#039;,
</div><div class='line not-executable'><span class='num'>59</span>        &#039;label&#039;    =&gt; &#039;node1&#039;,
</div><div class='line not-executable'><span class='num'>60</span>        &#039;category&#039; =&gt; &#039;business&#039;,
</div><div class='line not-executable'><span class='num'>61</span>        &#039;type&#039; =&gt; &#039;server&#039;,
</div><div class='line not-executable'><span class='num'>62</span>        &#039;data&#039; =&gt; [
</div><div class='line not-executable'><span class='num'>63</span>                &#039;info&#039; =&gt; &#039;first node&#039;
</div><div class='line not-executable'><span class='num'>64</span>        ]
</div><div class='line not-executable'><span class='num'>65</span>    ];
</div><div class='line not-executable'><span class='num'>66</span>
</div><div class='line covered'><span class='num'>67</span>    if($resp-&gt;code != 201) {
</div><div class='line not-covered'><span class='num'>68</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>69</span>    }
</div><div class='line not-executable'><span class='num'>70</span>
</div><div class='line covered'><span class='num'>71</span>    if($resp-&gt;status != &#039;success&#039;) {
</div><div class='line not-covered'><span class='num'>72</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>73</span>    }
</div><div class='line not-executable'><span class='num'>74</span>
</div><div class='line covered'><span class='num'>75</span>    if ($resp-&gt;message != &#039;node inserted&#039;) {
</div><div class='line not-covered'><span class='num'>76</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>77</span>    }
</div><div class='line not-executable'><span class='num'>78</span>
</div><div class='line covered'><span class='num'>79</span>    $diff = array_diff_recursive($resp-&gt;data, $expected);
</div><div class='line covered'><span class='num'>80</span>    if (! empty($diff)) {
</div><div class='line not-covered'><span class='num'>81</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>82</span>    }
</div><div class='line not-executable'><span class='num'>83</span>
</div><div class='line covered'><span class='num'>84</span>    $_GET[&#039;id&#039;] = &#039;node1&#039;;
</div><div class='line covered'><span class='num'>85</span>    $req = new Request();
</div><div class='line covered'><span class='num'>86</span>    $resp = $graphController-&gt;getNode($req);
</div><div class='line not-executable'><span class='num'>87</span>
</div><div class='line covered'><span class='num'>88</span>    if ($resp-&gt;code != 200) {
</div><div class='line not-covered'><span class='num'>89</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>90</span>    }
</div><div class='line not-executable'><span class='num'>91</span>
</div><div class='line covered'><span class='num'>92</span>    if($resp-&gt;status != &#039;success&#039;) {
</div><div class='line not-covered'><span class='num'>93</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>94</span>    }
</div><div class='line not-executable'><span class='num'>95</span>
</div><div class='line covered'><span class='num'>96</span>    if ($resp-&gt;message != &#039;node found&#039;) {
</div><div class='line not-covered'><span class='num'>97</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>98</span>    }
</div><div class='line not-executable'><span class='num'>99</span>
</div><div class='line covered'><span class='num'>100</span>    $expected = [
</div><div class='line not-executable'><span class='num'>101</span>        &#039;info&#039;     =&gt; &#039;first node&#039;,
</div><div class='line not-executable'><span class='num'>102</span>        &#039;id&#039;       =&gt; &#039;node1&#039;,
</div><div class='line not-executable'><span class='num'>103</span>        &#039;label&#039;    =&gt; &#039;node1&#039;,
</div><div class='line not-executable'><span class='num'>104</span>        &#039;category&#039; =&gt; &#039;business&#039;,
</div><div class='line not-executable'><span class='num'>105</span>        &#039;type&#039;     =&gt; &#039;server&#039;,
</div><div class='line not-executable'><span class='num'>106</span>    ];
</div><div class='line not-executable'><span class='num'>107</span>
</div><div class='line covered'><span class='num'>108</span>    $diff = array_diff_recursive($resp-&gt;data[&#039;data&#039;], $expected);
</div><div class='line covered'><span class='num'>109</span>    if (! empty($diff)) {
</div><div class='line not-covered'><span class='num'>110</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>111</span>    }
</div><div class='line covered'><span class='num'>112</span>    
</div><div class='line covered'><span class='num'>113</span>    $req = new Request();
</div><div class='line not-executable'><span class='num'>114</span>    $req-&gt;data = [
</div><div class='line not-executable'><span class='num'>115</span>        &#039;id&#039;       =&gt; &#039;node1&#039;,
</div><div class='line covered'><span class='num'>116</span>        &#039;label&#039;    =&gt; &#039;node1&#039;,
</div><div class='line covered'><span class='num'>117</span>        &#039;category&#039; =&gt; &#039;business&#039;,
</div><div class='line covered'><span class='num'>118</span>        &#039;type&#039; =&gt; &#039;server&#039;,
</div><div class='line not-executable'><span class='num'>119</span>        &#039;data&#039; =&gt; [
</div><div class='line covered'><span class='num'>120</span>                &#039;info&#039; =&gt; &#039;first node&#039;
</div><div class='line not-executable'><span class='num'>121</span>        ]
</div><div class='line covered'><span class='num'>122</span>    ];
</div><div class='line not-executable'><span class='num'>123</span>    $resp = $graphController-&gt;updateNode($req);
</div><div class='line not-executable'><span class='num'>124</span>}
</div><div class='line not-executable'><span class='num'>125</span>
</div><div class='line not-executable'><span class='num'>126</span>function tests() {
</div><div class='line not-executable'><span class='num'>127</span>    test_node_good_path();
</div><div class='line not-executable'><span class='num'>128</span>    echo &quot;fim&quot;;
</div><div class='line not-executable'><span class='num'>129</span>}
</div><div class='line not-executable'><span class='num'>130</span>
</div><div class='line not-executable'><span class='num'>131</span>tests();
</div><div class='line not-executable'><span class='num'>132</span>
</div><div class='line not-executable'><span class='num'>133</span>$coverage = xdebug_get_code_coverage();
</div><div class='line not-executable'><span class='num'>134</span>xdebug_stop_code_coverage();
</div><div class='line not-executable'><span class='num'>135</span>
</div><div class='line not-executable'><span class='num'>136</span>// Salvar em arquivo
</div><div class='line not-executable'><span class='num'>137</span>file_put_contents(&#039;coverage.json&#039;, json_encode($coverage, JSON_PRETTY_PRINT));
</div><div class='line not-executable'><span class='num'>138</span>
</div><div class='line not-executable'><span class='num'>139</span>echo &#039;fim&#039;;</div><h2>/home/tarcisio/projects/graph/graph.php - 23.89% (151/632)</h2><div class='line not-executable'><span class='num'>1</span>&lt;?php
</div><div class='line not-executable'><span class='num'>2</span>
</div><div class='line not-executable'><span class='num'>3</span>declare(strict_types=1);
</div><div class='line not-executable'><span class='num'>4</span>
</div><div class='line not-executable'><span class='num'>5</span>final class User
</div><div class='line not-executable'><span class='num'>6</span>{
</div><div class='line not-executable'><span class='num'>7</span>    public string $id;
</div><div class='line not-executable'><span class='num'>8</span>    public ?string $ipAddress;
</div><div class='line not-executable'><span class='num'>9</span>    public Group $group;
</div><div class='line not-executable'><span class='num'>10</span>
</div><div class='line not-executable'><span class='num'>11</span>    public function __construct(string $id, ?string $ipAddress, Group $group)
</div><div class='line not-executable'><span class='num'>12</span>    {
</div><div class='line covered'><span class='num'>13</span>        $this-&gt;id = $id;
</div><div class='line covered'><span class='num'>14</span>        $this-&gt;ipAddress = $ipAddress;
</div><div class='line covered'><span class='num'>15</span>        $this-&gt;group = $group;
</div><div class='line covered'><span class='num'>16</span>    }
</div><div class='line not-executable'><span class='num'>17</span>
</div><div class='line not-executable'><span class='num'>18</span>    public function toArray(): array
</div><div class='line not-executable'><span class='num'>19</span>    {
</div><div class='line not-executable'><span class='num'>20</span>        return [
</div><div class='line not-covered'><span class='num'>21</span>            &#039;id&#039; =&gt; $this-&gt;id,
</div><div class='line not-executable'><span class='num'>22</span>            &#039;group&#039; =&gt; [
</div><div class='line not-covered'><span class='num'>23</span>                &#039;id&#039; =&gt; $this-&gt;group-&gt;id,
</div><div class='line not-executable'><span class='num'>24</span>            ],
</div><div class='line not-executable'><span class='num'>25</span>        ];
</div><div class='line not-covered'><span class='num'>26</span>    }
</div><div class='line not-executable'><span class='num'>27</span>}
</div><div class='line not-executable'><span class='num'>28</span>
</div><div class='line not-executable'><span class='num'>29</span>final class Group
</div><div class='line not-executable'><span class='num'>30</span>{
</div><div class='line not-executable'><span class='num'>31</span>    private const ALLOWED_GROUPS = [&#039;anonymous&#039;, &#039;consumer&#039;, &#039;contributor&#039;, &#039;admin&#039;];
</div><div class='line not-executable'><span class='num'>32</span>    
</div><div class='line not-executable'><span class='num'>33</span>    public string $id;
</div><div class='line not-executable'><span class='num'>34</span>    
</div><div class='line not-executable'><span class='num'>35</span>    public function __construct(string $id)
</div><div class='line not-executable'><span class='num'>36</span>    {
</div><div class='line covered'><span class='num'>37</span>        if (!in_array($id, self::ALLOWED_GROUPS, true)) {
</div><div class='line not-covered'><span class='num'>38</span>            throw new InvalidArgumentException(&quot;Invalid user group: {$id}&quot;);
</div><div class='line not-executable'><span class='num'>39</span>        }
</div><div class='line covered'><span class='num'>40</span>        $this-&gt;id  = $id;
</div><div class='line covered'><span class='num'>41</span>    }
</div><div class='line not-executable'><span class='num'>42</span>}
</div><div class='line not-executable'><span class='num'>43</span>
</div><div class='line not-executable'><span class='num'>44</span>final class Graph
</div><div class='line not-executable'><span class='num'>45</span>{
</div><div class='line not-executable'><span class='num'>46</span>    public array $nodes = [];
</div><div class='line not-executable'><span class='num'>47</span>    public array $edges = [];
</div><div class='line not-executable'><span class='num'>48</span>    public array $data  = [];
</div><div class='line not-executable'><span class='num'>49</span>    public array $layout = [];
</div><div class='line not-executable'><span class='num'>50</span>    public array $styles = [];
</div><div class='line not-executable'><span class='num'>51</span>
</div><div class='line not-executable'><span class='num'>52</span>    public function __construct(array $nodes, array $edges)
</div><div class='line not-executable'><span class='num'>53</span>    {
</div><div class='line not-covered'><span class='num'>54</span>        $this-&gt;nodes = $nodes;
</div><div class='line not-covered'><span class='num'>55</span>        $this-&gt;edges = $edges;
</div><div class='line not-covered'><span class='num'>56</span>    }
</div><div class='line not-executable'><span class='num'>57</span>
</div><div class='line not-executable'><span class='num'>58</span>    public function toArray(): array
</div><div class='line not-executable'><span class='num'>59</span>    {
</div><div class='line not-executable'><span class='num'>60</span>        return [
</div><div class='line not-covered'><span class='num'>61</span>            &#039;nodes&#039; =&gt; $this-&gt;nodes,
</div><div class='line not-covered'><span class='num'>62</span>            &#039;edges&#039; =&gt; $this-&gt;edges,
</div><div class='line not-covered'><span class='num'>63</span>            &#039;data&#039; =&gt; $this-&gt;data,
</div><div class='line not-covered'><span class='num'>64</span>            &#039;layout&#039; =&gt; $this-&gt;layout,
</div><div class='line not-covered'><span class='num'>65</span>            &#039;styles&#039; =&gt; $this-&gt;styles,
</div><div class='line not-executable'><span class='num'>66</span>        ];
</div><div class='line not-covered'><span class='num'>67</span>    }
</div><div class='line not-executable'><span class='num'>68</span>}
</div><div class='line not-executable'><span class='num'>69</span>
</div><div class='line not-executable'><span class='num'>70</span>final class Node
</div><div class='line not-executable'><span class='num'>71</span>{
</div><div class='line not-executable'><span class='num'>72</span>    private const ALLOWED_CATEGORIES  = [&#039;business&#039;, &#039;application&#039;, &#039;infrastructure&#039;];
</div><div class='line not-executable'><span class='num'>73</span>    private const ALLOWED_TYPES       = [&#039;server&#039;, &#039;database&#039;, &#039;application&#039;, &#039;network&#039;];
</div><div class='line not-executable'><span class='num'>74</span>    private const ID_VALIDATION_REGEX = &#039;/^[a-zA-Z0-9\-_]+$/&#039;;
</div><div class='line not-executable'><span class='num'>75</span>    private const LABEL_MAX_LENGTH    = 20;
</div><div class='line not-executable'><span class='num'>76</span>    
</div><div class='line not-executable'><span class='num'>77</span>    public string $id;
</div><div class='line not-executable'><span class='num'>78</span>    public string $label;
</div><div class='line not-executable'><span class='num'>79</span>    public string $category;
</div><div class='line not-executable'><span class='num'>80</span>    public string $type;
</div><div class='line not-executable'><span class='num'>81</span>
</div><div class='line not-executable'><span class='num'>82</span>    public array $data = [];
</div><div class='line not-executable'><span class='num'>83</span>
</div><div class='line not-executable'><span class='num'>84</span>    public function __construct(string $id, string $label, string $category, string $type, array $data)
</div><div class='line not-executable'><span class='num'>85</span>    {
</div><div class='line covered'><span class='num'>86</span>        $this-&gt;validate($id, $label, $category, $type);
</div><div class='line covered'><span class='num'>87</span>        $this-&gt;id       = $id;
</div><div class='line covered'><span class='num'>88</span>        $this-&gt;label    = $label;
</div><div class='line covered'><span class='num'>89</span>        $this-&gt;category = $category;
</div><div class='line covered'><span class='num'>90</span>        $this-&gt;type     = $type;
</div><div class='line covered'><span class='num'>91</span>        $this-&gt;data     = $data;
</div><div class='line covered'><span class='num'>92</span>    }
</div><div class='line not-executable'><span class='num'>93</span>
</div><div class='line not-executable'><span class='num'>94</span>    private function validate(string $id, string $label, string $category, string $type): void
</div><div class='line not-executable'><span class='num'>95</span>    {
</div><div class='line covered'><span class='num'>96</span>        if (!preg_match(self::ID_VALIDATION_REGEX, $id)) {
</div><div class='line not-covered'><span class='num'>97</span>            throw new InvalidArgumentException(&quot;Invalid node ID: {$id}&quot;);
</div><div class='line not-executable'><span class='num'>98</span>        }
</div><div class='line not-executable'><span class='num'>99</span>
</div><div class='line covered'><span class='num'>100</span>        if (strlen($label) &gt; self::LABEL_MAX_LENGTH) {
</div><div class='line not-covered'><span class='num'>101</span>            throw new InvalidArgumentException(&quot;Node label exceeds maximum length of &quot; . self::LABEL_MAX_LENGTH);
</div><div class='line not-executable'><span class='num'>102</span>        }
</div><div class='line not-executable'><span class='num'>103</span>
</div><div class='line covered'><span class='num'>104</span>        if (!in_array($category, self::ALLOWED_CATEGORIES, true)) {
</div><div class='line not-covered'><span class='num'>105</span>            throw new InvalidArgumentException(&quot;Invalid node category: {$category}&quot;);
</div><div class='line not-executable'><span class='num'>106</span>        }
</div><div class='line not-executable'><span class='num'>107</span>
</div><div class='line covered'><span class='num'>108</span>        if (!in_array($type, self::ALLOWED_TYPES, true)) {
</div><div class='line not-covered'><span class='num'>109</span>            throw new InvalidArgumentException(&quot;Invalid node type: {$type}&quot;);
</div><div class='line not-executable'><span class='num'>110</span>        }
</div><div class='line covered'><span class='num'>111</span>    }
</div><div class='line not-executable'><span class='num'>112</span>
</div><div class='line not-executable'><span class='num'>113</span>    public function toArray(): array
</div><div class='line not-executable'><span class='num'>114</span>    {
</div><div class='line not-executable'><span class='num'>115</span>        return [
</div><div class='line covered'><span class='num'>116</span>            &#039;id&#039;       =&gt; $this-&gt;id,
</div><div class='line covered'><span class='num'>117</span>            &#039;label&#039;    =&gt; $this-&gt;label,
</div><div class='line covered'><span class='num'>118</span>            &#039;category&#039; =&gt; $this-&gt;category,
</div><div class='line covered'><span class='num'>119</span>            &#039;type&#039;     =&gt; $this-&gt;type,
</div><div class='line covered'><span class='num'>120</span>            &#039;data&#039;     =&gt; $this-&gt;data
</div><div class='line not-executable'><span class='num'>121</span>        ];
</div><div class='line not-covered'><span class='num'>122</span>    }
</div><div class='line not-executable'><span class='num'>123</span>}
</div><div class='line not-executable'><span class='num'>124</span>
</div><div class='line not-executable'><span class='num'>125</span>final class NodeStatus
</div><div class='line not-executable'><span class='num'>126</span>{
</div><div class='line not-executable'><span class='num'>127</span>    private const ALLOWED_NODE_STATUSES = [&#039;unknown&#039;, &#039;healthy&#039;, &#039;unhealthy&#039;, &#039;maintenance&#039;];
</div><div class='line not-executable'><span class='num'>128</span>
</div><div class='line not-executable'><span class='num'>129</span>    public string $nodeId;
</div><div class='line not-executable'><span class='num'>130</span>    public string $status;
</div><div class='line not-executable'><span class='num'>131</span>
</div><div class='line not-executable'><span class='num'>132</span>    public function __construct(string $nodeId, string $status)
</div><div class='line not-executable'><span class='num'>133</span>    {
</div><div class='line not-covered'><span class='num'>134</span>        if (!in_array($status, self::ALLOWED_NODE_STATUSES, true)) {
</div><div class='line not-covered'><span class='num'>135</span>            throw new InvalidArgumentException(&quot;Invalid node status: {$status}&quot;);
</div><div class='line not-executable'><span class='num'>136</span>        }
</div><div class='line not-covered'><span class='num'>137</span>        $this-&gt;nodeId = $nodeId;
</div><div class='line not-covered'><span class='num'>138</span>        $this-&gt;status = $status;
</div><div class='line not-covered'><span class='num'>139</span>    }
</div><div class='line not-executable'><span class='num'>140</span>
</div><div class='line not-executable'><span class='num'>141</span>    public function toArray(): array
</div><div class='line not-executable'><span class='num'>142</span>    {
</div><div class='line not-executable'><span class='num'>143</span>        return [
</div><div class='line not-covered'><span class='num'>144</span>            &#039;node_id&#039; =&gt; $this-&gt;nodeId,
</div><div class='line not-covered'><span class='num'>145</span>            &#039;status&#039;  =&gt; $this-&gt;status,
</div><div class='line not-executable'><span class='num'>146</span>        ];
</div><div class='line not-covered'><span class='num'>147</span>    }
</div><div class='line not-executable'><span class='num'>148</span>}
</div><div class='line not-executable'><span class='num'>149</span>
</div><div class='line not-executable'><span class='num'>150</span>final class NodeStatuses
</div><div class='line not-executable'><span class='num'>151</span>{
</div><div class='line not-executable'><span class='num'>152</span>    public array $statuses = [];
</div><div class='line not-executable'><span class='num'>153</span>
</div><div class='line not-executable'><span class='num'>154</span>    public function addStatus(NodeStatus $status): void
</div><div class='line not-executable'><span class='num'>155</span>    {
</div><div class='line not-covered'><span class='num'>156</span>        $this-&gt;statuses[] = $status;
</div><div class='line not-covered'><span class='num'>157</span>    }
</div><div class='line not-executable'><span class='num'>158</span>}
</div><div class='line not-executable'><span class='num'>159</span>
</div><div class='line not-executable'><span class='num'>160</span>final class Nodes
</div><div class='line not-executable'><span class='num'>161</span>{
</div><div class='line not-executable'><span class='num'>162</span>    public array $nodes = [];
</div><div class='line not-executable'><span class='num'>163</span>
</div><div class='line not-executable'><span class='num'>164</span>    public function addNode(Node $node): void
</div><div class='line not-executable'><span class='num'>165</span>    {
</div><div class='line not-covered'><span class='num'>166</span>        $this-&gt;nodes[] = $node;
</div><div class='line not-covered'><span class='num'>167</span>    }
</div><div class='line not-executable'><span class='num'>168</span>}
</div><div class='line not-executable'><span class='num'>169</span>
</div><div class='line not-executable'><span class='num'>170</span>final class Edge
</div><div class='line not-executable'><span class='num'>171</span>{
</div><div class='line not-executable'><span class='num'>172</span>    public ?string $id;
</div><div class='line not-executable'><span class='num'>173</span>    public string $source;
</div><div class='line not-executable'><span class='num'>174</span>    public string $target;
</div><div class='line not-executable'><span class='num'>175</span>    public array $data;
</div><div class='line not-executable'><span class='num'>176</span>
</div><div class='line not-executable'><span class='num'>177</span>    public function __construct(?string $id = null, string $source, string $target, array $data = [])
</div><div class='line not-executable'><span class='num'>178</span>    {
</div><div class='line not-covered'><span class='num'>179</span>        $this-&gt;id     = $id;
</div><div class='line not-covered'><span class='num'>180</span>        $this-&gt;source = $source;
</div><div class='line not-covered'><span class='num'>181</span>        $this-&gt;target = $target;
</div><div class='line not-covered'><span class='num'>182</span>        $this-&gt;data   = $data;
</div><div class='line not-covered'><span class='num'>183</span>    }
</div><div class='line not-executable'><span class='num'>184</span>
</div><div class='line not-executable'><span class='num'>185</span>    public function toArray(): array
</div><div class='line not-executable'><span class='num'>186</span>    {
</div><div class='line not-executable'><span class='num'>187</span>        return [
</div><div class='line not-covered'><span class='num'>188</span>            &#039;id&#039;     =&gt; $this-&gt;id,
</div><div class='line not-covered'><span class='num'>189</span>            &#039;source&#039; =&gt; $this-&gt;source,
</div><div class='line not-covered'><span class='num'>190</span>            &#039;target&#039; =&gt; $this-&gt;target,
</div><div class='line not-covered'><span class='num'>191</span>            &#039;data&#039;   =&gt; $this-&gt;data
</div><div class='line not-executable'><span class='num'>192</span>        ];
</div><div class='line not-covered'><span class='num'>193</span>    }
</div><div class='line not-executable'><span class='num'>194</span>}
</div><div class='line not-executable'><span class='num'>195</span>
</div><div class='line not-executable'><span class='num'>196</span>final class Edges
</div><div class='line not-executable'><span class='num'>197</span>{
</div><div class='line not-executable'><span class='num'>198</span>    public array $edges = [];
</div><div class='line not-executable'><span class='num'>199</span>    public function addEdge(Edge $edge): void
</div><div class='line not-executable'><span class='num'>200</span>    {
</div><div class='line not-covered'><span class='num'>201</span>        $this-&gt;edges[] = $edge;
</div><div class='line not-covered'><span class='num'>202</span>    }
</div><div class='line not-executable'><span class='num'>203</span>}
</div><div class='line not-executable'><span class='num'>204</span>
</div><div class='line not-executable'><span class='num'>205</span>final class AuditLog
</div><div class='line not-executable'><span class='num'>206</span>{
</div><div class='line not-executable'><span class='num'>207</span>    public string $entityType;
</div><div class='line not-executable'><span class='num'>208</span>    public string $entityId;
</div><div class='line not-executable'><span class='num'>209</span>    public string $action;
</div><div class='line not-executable'><span class='num'>210</span>    public ?array $oldData;
</div><div class='line not-executable'><span class='num'>211</span>    public ?array $newData;
</div><div class='line not-executable'><span class='num'>212</span>    public string $userId;
</div><div class='line not-executable'><span class='num'>213</span>    public string $ipAddress;
</div><div class='line not-executable'><span class='num'>214</span>    public string $createdAt;
</div><div class='line not-executable'><span class='num'>215</span>
</div><div class='line not-executable'><span class='num'>216</span>    public function __construct(string $entityType, string $entityId, string $action, ?array $oldData = null, ?array $newData = null)
</div><div class='line not-executable'><span class='num'>217</span>    {
</div><div class='line covered'><span class='num'>218</span>        $this-&gt;entityType = $entityType;
</div><div class='line covered'><span class='num'>219</span>        $this-&gt;entityId   = $entityId;
</div><div class='line covered'><span class='num'>220</span>        $this-&gt;action     = $action;
</div><div class='line covered'><span class='num'>221</span>        $this-&gt;oldData    = $oldData;
</div><div class='line covered'><span class='num'>222</span>        $this-&gt;newData    = $newData;
</div><div class='line covered'><span class='num'>223</span>    }
</div><div class='line not-executable'><span class='num'>224</span>}
</div><div class='line not-executable'><span class='num'>225</span>
</div><div class='line not-executable'><span class='num'>226</span>final class AuditLogs
</div><div class='line not-executable'><span class='num'>227</span>{
</div><div class='line not-executable'><span class='num'>228</span>    public array $logs = [];
</div><div class='line not-executable'><span class='num'>229</span>    public function addLog(AuditLog $log): void
</div><div class='line not-executable'><span class='num'>230</span>    {
</div><div class='line not-covered'><span class='num'>231</span>        $this-&gt;logs[] = $log;
</div><div class='line not-covered'><span class='num'>232</span>    }
</div><div class='line not-executable'><span class='num'>233</span>}
</div><div class='line not-executable'><span class='num'>234</span>
</div><div class='line not-executable'><span class='num'>235</span>final class GraphContext
</div><div class='line not-executable'><span class='num'>236</span>{
</div><div class='line not-executable'><span class='num'>237</span>    public static User $user;
</div><div class='line not-executable'><span class='num'>238</span>}
</div><div class='line not-executable'><span class='num'>239</span>
</div><div class='line not-executable'><span class='num'>240</span>interface LoggerInterface
</div><div class='line not-executable'><span class='num'>241</span>{
</div><div class='line not-executable'><span class='num'>242</span>    public function info(string $message, array $data = []): void;
</div><div class='line not-executable'><span class='num'>243</span>    public function debug(string $message, array $data = []): void;
</div><div class='line not-executable'><span class='num'>244</span>    public function error(string $message, array $data = []): void;
</div><div class='line not-executable'><span class='num'>245</span>}
</div><div class='line not-executable'><span class='num'>246</span>
</div><div class='line not-executable'><span class='num'>247</span>final class Logger implements LoggerInterface
</div><div class='line not-executable'><span class='num'>248</span>{
</div><div class='line not-executable'><span class='num'>249</span>    private string $fileName;
</div><div class='line not-executable'><span class='num'>250</span>    private $fd;
</div><div class='line not-executable'><span class='num'>251</span>
</div><div class='line not-executable'><span class='num'>252</span>    public function __construct($file_name)
</div><div class='line not-executable'><span class='num'>253</span>    {
</div><div class='line covered'><span class='num'>254</span>        $this-&gt;fileName = $file_name;
</div><div class='line covered'><span class='num'>255</span>        $this-&gt;fd = fopen($this-&gt;fileName, &#039;a&#039;);
</div><div class='line covered'><span class='num'>256</span>    }
</div><div class='line not-executable'><span class='num'>257</span>
</div><div class='line not-executable'><span class='num'>258</span>    public function info(string $message, array $data = []): void
</div><div class='line not-executable'><span class='num'>259</span>    {
</div><div class='line covered'><span class='num'>260</span>        $this-&gt;log(&#039;INFO&#039;, $message, $data);
</div><div class='line covered'><span class='num'>261</span>    }
</div><div class='line not-executable'><span class='num'>262</span>
</div><div class='line not-executable'><span class='num'>263</span>    public function debug(string $message, array $data = []): void
</div><div class='line not-executable'><span class='num'>264</span>    {
</div><div class='line covered'><span class='num'>265</span>        $this-&gt;log(&#039;DEBUG&#039;, $message, $data);
</div><div class='line covered'><span class='num'>266</span>    }
</div><div class='line not-executable'><span class='num'>267</span>
</div><div class='line not-executable'><span class='num'>268</span>    public function error(string $message, array $data = []): void
</div><div class='line not-executable'><span class='num'>269</span>    {
</div><div class='line not-covered'><span class='num'>270</span>        $this-&gt;log(&#039;ERROR&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>271</span>    }
</div><div class='line not-executable'><span class='num'>272</span>
</div><div class='line not-executable'><span class='num'>273</span>    private function log(string $type, $message, $data = [])
</div><div class='line not-executable'><span class='num'>274</span>    {
</div><div class='line covered'><span class='num'>275</span>        $trace = debug_backtrace(DEBUG_BACKTRACE_PROVIDE_OBJECT, 3);
</div><div class='line covered'><span class='num'>276</span>        $method = &quot;{$trace[2][&#039;class&#039;]}::{$trace[2][&#039;function&#039;]}&quot;;
</div><div class='line covered'><span class='num'>277</span>        $data = json_encode($data);
</div><div class='line covered'><span class='num'>278</span>        $message = &quot;[{$type}] {$method}: $message ($data)\n&quot;;
</div><div class='line covered'><span class='num'>279</span>        fwrite($this-&gt;fd, $message);
</div><div class='line covered'><span class='num'>280</span>    }
</div><div class='line not-executable'><span class='num'>281</span>}
</div><div class='line not-executable'><span class='num'>282</span>
</div><div class='line not-executable'><span class='num'>283</span>interface GraphDatabaseInterface
</div><div class='line not-executable'><span class='num'>284</span>{
</div><div class='line not-executable'><span class='num'>285</span>    public function getUser(string $id): ?array;
</div><div class='line not-executable'><span class='num'>286</span>    public function insertUser(string $id, string $group): void;
</div><div class='line not-executable'><span class='num'>287</span>    public function updateUser(string $id, string $group): void;
</div><div class='line not-executable'><span class='num'>288</span>
</div><div class='line not-executable'><span class='num'>289</span>    public function getNode(string $id): ?array;
</div><div class='line not-executable'><span class='num'>290</span>    public function getNodes(): array;
</div><div class='line not-executable'><span class='num'>291</span>    public function insertNode(string $id, string $label, string $category, string $type, array $data = []): void;
</div><div class='line not-executable'><span class='num'>292</span>    public function updateNode(string $id, string $label, string $category, string $type, array $data = []): void;
</div><div class='line not-executable'><span class='num'>293</span>    public function deleteNode(string $id): void;
</div><div class='line not-executable'><span class='num'>294</span>
</div><div class='line not-executable'><span class='num'>295</span>    public function getEdge(string $source, string $target): ?array;
</div><div class='line not-executable'><span class='num'>296</span>    public function getEdgeById(string $id): ?array;
</div><div class='line not-executable'><span class='num'>297</span>    public function getEdges(): array;
</div><div class='line not-executable'><span class='num'>298</span>    public function insertEdge(string $id, string $source, string $target, array $data = []): void;
</div><div class='line not-executable'><span class='num'>299</span>    public function updateEdge(string $id, string $source, string $target, array $data = []): void;
</div><div class='line not-executable'><span class='num'>300</span>    public function deleteEdge(string $id): void;
</div><div class='line not-executable'><span class='num'>301</span>
</div><div class='line not-executable'><span class='num'>302</span>    public function getStatuses(): array;
</div><div class='line not-executable'><span class='num'>303</span>    public function getNodeStatus(string $id): ?string;
</div><div class='line not-executable'><span class='num'>304</span>    public function setNodeStatus(string $id, string $status): void;
</div><div class='line not-executable'><span class='num'>305</span>
</div><div class='line not-executable'><span class='num'>306</span>    public function getLogs($limit): array;
</div><div class='line not-executable'><span class='num'>307</span>    public function insertAuditLog(
</div><div class='line not-executable'><span class='num'>308</span>        string $entity_type, 
</div><div class='line not-executable'><span class='num'>309</span>        string $entity_id, 
</div><div class='line not-executable'><span class='num'>310</span>        string $action, 
</div><div class='line not-executable'><span class='num'>311</span>        ?array $old_data = null, 
</div><div class='line not-executable'><span class='num'>312</span>        ?array $new_data = null,
</div><div class='line not-executable'><span class='num'>313</span>        string $user_id,
</div><div class='line not-executable'><span class='num'>314</span>        string $ip_address): bool;
</div><div class='line not-executable'><span class='num'>315</span>}
</div><div class='line not-executable'><span class='num'>316</span>
</div><div class='line not-executable'><span class='num'>317</span>final class DatabaseException extends RuntimeException
</div><div class='line not-executable'><span class='num'>318</span>{
</div><div class='line not-executable'><span class='num'>319</span>    private ?string $query;
</div><div class='line not-executable'><span class='num'>320</span>    private ?array $params;
</div><div class='line not-executable'><span class='num'>321</span>
</div><div class='line not-executable'><span class='num'>322</span>    
</div><div class='line not-executable'><span class='num'>323</span>    public function __construct(string $message = &quot;&quot;,  int $code = 0, ?Throwable $previous = null, ?string $query = null, ?array $params) {
</div><div class='line not-covered'><span class='num'>324</span>        parent::__construct($message, $code, $previous);
</div><div class='line not-covered'><span class='num'>325</span>        $this-&gt;query = $query;
</div><div class='line not-covered'><span class='num'>326</span>        $this-&gt;params = $params;
</div><div class='line not-covered'><span class='num'>327</span>    }
</div><div class='line not-executable'><span class='num'>328</span>}
</div><div class='line not-executable'><span class='num'>329</span>
</div><div class='line not-executable'><span class='num'>330</span>final class GraphDatabase implements GraphDatabaseInterface
</div><div class='line not-executable'><span class='num'>331</span>{
</div><div class='line not-executable'><span class='num'>332</span>    private PDO $pdo;
</div><div class='line not-executable'><span class='num'>333</span>    private Logger $logger;
</div><div class='line not-executable'><span class='num'>334</span>
</div><div class='line not-executable'><span class='num'>335</span>    public function __construct(PDO $pdo, Logger $logger)
</div><div class='line not-executable'><span class='num'>336</span>    {
</div><div class='line covered'><span class='num'>337</span>        $this-&gt;pdo = $pdo;
</div><div class='line covered'><span class='num'>338</span>        $this-&gt;logger = $logger;
</div><div class='line covered'><span class='num'>339</span>        $this-&gt;initSchema();
</div><div class='line covered'><span class='num'>340</span>    }
</div><div class='line not-executable'><span class='num'>341</span>
</div><div class='line not-executable'><span class='num'>342</span>    public function getUser(string $id): ?array
</div><div class='line not-executable'><span class='num'>343</span>    {
</div><div class='line not-covered'><span class='num'>344</span>        $this-&gt;logger-&gt;debug(&quot;getting user id: &#039;{$id}&#039;&quot;);
</div><div class='line not-executable'><span class='num'>345</span>        try {
</div><div class='line not-covered'><span class='num'>346</span>            $sql = &quot;SELECT * FROM users WHERE id = :id&quot;;
</div><div class='line not-covered'><span class='num'>347</span>            $params = [&#039;:id&#039; =&gt; $id];
</div><div class='line not-covered'><span class='num'>348</span>            $stmt = $this-&gt;pdo-&gt;prepare($sql);
</div><div class='line not-covered'><span class='num'>349</span>            $stmt-&gt;execute($params);
</div><div class='line not-covered'><span class='num'>350</span>            $row = $stmt-&gt;fetch();
</div><div class='line not-executable'><span class='num'>351</span>
</div><div class='line not-covered'><span class='num'>352</span>            if ($row) {
</div><div class='line not-covered'><span class='num'>353</span>                return $row;
</div><div class='line not-executable'><span class='num'>354</span>            }
</div><div class='line not-covered'><span class='num'>355</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>356</span>            $e = new DatabaseException(
</div><div class='line not-covered'><span class='num'>357</span>                &quot;GraphDatabase Exception while trying to get user data. ID: {$id}&quot;,
</div><div class='line not-covered'><span class='num'>358</span>                0,
</div><div class='line not-executable'><span class='num'>359</span>                $e,
</div><div class='line not-executable'><span class='num'>360</span>                $sql,
</div><div class='line not-executable'><span class='num'>361</span>                $params
</div><div class='line not-executable'><span class='num'>362</span>            );
</div><div class='line not-executable'><span class='num'>363</span>        }
</div><div class='line not-covered'><span class='num'>364</span>        return null;
</div><div class='line not-covered'><span class='num'>365</span>    }
</div><div class='line not-executable'><span class='num'>366</span>
</div><div class='line not-executable'><span class='num'>367</span>    public function insertUser(string $id, string $group): void
</div><div class='line not-executable'><span class='num'>368</span>    {
</div><div class='line not-executable'><span class='num'>369</span>        try {
</div><div class='line not-covered'><span class='num'>370</span>            $sql = &quot;
</div><div class='line not-executable'><span class='num'>371</span>                INSERT OR IGNORE INTO users 
</div><div class='line not-executable'><span class='num'>372</span>                (id, user_group)
</div><div class='line not-executable'><span class='num'>373</span>                VALUES (:id, :group)&quot;;
</div><div class='line not-executable'><span class='num'>374</span>            
</div><div class='line not-covered'><span class='num'>375</span>            $params = [
</div><div class='line not-covered'><span class='num'>376</span>                &#039;:id&#039;       =&gt; $id,
</div><div class='line not-covered'><span class='num'>377</span>                &#039;:group&#039;    =&gt; $group
</div><div class='line not-executable'><span class='num'>378</span>            ];
</div><div class='line not-executable'><span class='num'>379</span>
</div><div class='line not-covered'><span class='num'>380</span>            $stmt = $this-&gt;pdo-&gt;prepare($sql);
</div><div class='line not-covered'><span class='num'>381</span>            $stmt-&gt;execute($params);
</div><div class='line not-covered'><span class='num'>382</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>383</span>            $e = new DatabaseException(
</div><div class='line not-covered'><span class='num'>384</span>                &quot;GraphDatabase Exception while trying to insert new user. ID: {$id}&quot;,
</div><div class='line not-covered'><span class='num'>385</span>                0,
</div><div class='line not-executable'><span class='num'>386</span>                $e,
</div><div class='line not-executable'><span class='num'>387</span>                $sql,
</div><div class='line not-executable'><span class='num'>388</span>                $params
</div><div class='line not-executable'><span class='num'>389</span>            );
</div><div class='line not-executable'><span class='num'>390</span>        }
</div><div class='line not-covered'><span class='num'>391</span>    }
</div><div class='line not-executable'><span class='num'>392</span>
</div><div class='line not-executable'><span class='num'>393</span>    public function updateUser(string $id, string $group): void
</div><div class='line not-executable'><span class='num'>394</span>    {
</div><div class='line not-executable'><span class='num'>395</span>        try {
</div><div class='line not-covered'><span class='num'>396</span>            $sql = &quot;
</div><div class='line not-executable'><span class='num'>397</span>                UPDATE users
</div><div class='line not-executable'><span class='num'>398</span>                SET    user_group = :group
</div><div class='line not-executable'><span class='num'>399</span>                WHERE  id = :id
</div><div class='line not-executable'><span class='num'>400</span>            &quot;;
</div><div class='line not-executable'><span class='num'>401</span>
</div><div class='line not-covered'><span class='num'>402</span>            $params = [
</div><div class='line not-covered'><span class='num'>403</span>                &#039;:id&#039;       =&gt; $id,
</div><div class='line not-covered'><span class='num'>404</span>                &#039;:group&#039;    =&gt; $group
</div><div class='line not-executable'><span class='num'>405</span>            ];
</div><div class='line not-executable'><span class='num'>406</span>
</div><div class='line not-covered'><span class='num'>407</span>            $stmt = $this-&gt;pdo-&gt;prepare($sql);
</div><div class='line not-executable'><span class='num'>408</span>            
</div><div class='line not-covered'><span class='num'>409</span>            $stmt-&gt;execute($params);
</div><div class='line not-executable'><span class='num'>410</span>
</div><div class='line not-covered'><span class='num'>411</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>412</span>            $e = new DatabaseException(
</div><div class='line not-covered'><span class='num'>413</span>                &quot;GraphDatabase Exception while trying to update user. ID: {$id}&quot;,
</div><div class='line not-covered'><span class='num'>414</span>                0,
</div><div class='line not-executable'><span class='num'>415</span>                $e,
</div><div class='line not-executable'><span class='num'>416</span>                $sql,
</div><div class='line not-executable'><span class='num'>417</span>                $params
</div><div class='line not-executable'><span class='num'>418</span>            );
</div><div class='line not-executable'><span class='num'>419</span>        }
</div><div class='line not-covered'><span class='num'>420</span>    }
</div><div class='line not-executable'><span class='num'>421</span>
</div><div class='line not-executable'><span class='num'>422</span>    public function getNode(string $id): ?array
</div><div class='line not-executable'><span class='num'>423</span>    {
</div><div class='line covered'><span class='num'>424</span>        $this-&gt;logger-&gt;debug(&quot;fetching node &#039;{$id}&#039;&quot;);
</div><div class='line not-executable'><span class='num'>425</span>
</div><div class='line not-executable'><span class='num'>426</span>        try {
</div><div class='line covered'><span class='num'>427</span>            $sql = &quot;SELECT * FROM nodes WHERE id = :id&quot;;
</div><div class='line covered'><span class='num'>428</span>            $params = [&#039;:id&#039; =&gt; $id];
</div><div class='line covered'><span class='num'>429</span>            $stmt = $this-&gt;pdo-&gt;prepare($sql);
</div><div class='line covered'><span class='num'>430</span>            $stmt-&gt;execute($params);
</div><div class='line covered'><span class='num'>431</span>            $row = $stmt-&gt;fetch();
</div><div class='line not-executable'><span class='num'>432</span>            if ($row) {
</div><div class='line covered'><span class='num'>433</span>                return $row;
</div><div class='line covered'><span class='num'>434</span>            }
</div><div class='line not-executable'><span class='num'>435</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>436</span>            $this-&gt;logger-&gt;error(&quot;exception with node id &#039;{$id}&#039;&quot;);
</div><div class='line not-covered'><span class='num'>437</span>            throw new DatabaseException(&quot;could not get node data with id &#039;{$id}&#039;&quot;, 0, $e, $sql, $params);
</div><div class='line not-covered'><span class='num'>438</span>        }
</div><div class='line not-executable'><span class='num'>439</span>        return null;
</div><div class='line not-covered'><span class='num'>440</span>    }
</div><div class='line not-covered'><span class='num'>441</span>
</div><div class='line not-executable'><span class='num'>442</span>    public function getNodes(): array
</div><div class='line not-executable'><span class='num'>443</span>    {
</div><div class='line not-executable'><span class='num'>444</span>        try {
</div><div class='line not-executable'><span class='num'>445</span>            $stmt = $this-&gt;pdo-&gt;query(&quot;SELECT * FROM nodes&quot;);
</div><div class='line not-covered'><span class='num'>446</span>            $rows = $stmt-&gt;fetchAll();
</div><div class='line not-covered'><span class='num'>447</span>            return $rows;
</div><div class='line not-covered'><span class='num'>448</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>449</span>            error_log(&quot;GraphDatabase fetch all nodes failed: &quot; . $e-&gt;getMessage());
</div><div class='line not-covered'><span class='num'>450</span>            return [];
</div><div class='line not-covered'><span class='num'>451</span>        }
</div><div class='line not-executable'><span class='num'>452</span>    }
</div><div class='line not-covered'><span class='num'>453</span>
</div><div class='line not-executable'><span class='num'>454</span>    public function insertNode(string $id, string $label, string $category, string $type, array $data = []): void
</div><div class='line not-executable'><span class='num'>455</span>    {
</div><div class='line not-executable'><span class='num'>456</span>        try {
</div><div class='line not-executable'><span class='num'>457</span>            $sql = &quot;
</div><div class='line covered'><span class='num'>458</span>                INSERT OR IGNORE INTO nodes 
</div><div class='line not-executable'><span class='num'>459</span>                (id, label, category, type, data) 
</div><div class='line not-executable'><span class='num'>460</span>                VALUES (:id, :label, :category, :type, :data)&quot;;
</div><div class='line not-executable'><span class='num'>461</span>            $stmt             = $this-&gt;pdo-&gt;prepare($sql);
</div><div class='line covered'><span class='num'>462</span>            $data[&#039;id&#039;]       = $id;
</div><div class='line covered'><span class='num'>463</span>            $data[&#039;label&#039;]    = $label;
</div><div class='line covered'><span class='num'>464</span>            $data[&#039;category&#039;] = $category;
</div><div class='line covered'><span class='num'>465</span>            $data[&#039;type&#039;]     = $type;
</div><div class='line covered'><span class='num'>466</span>            $stmt-&gt;execute([
</div><div class='line covered'><span class='num'>467</span>                &#039;:id&#039;       =&gt; $id,
</div><div class='line covered'><span class='num'>468</span>                &#039;:label&#039;    =&gt; $label,
</div><div class='line covered'><span class='num'>469</span>                &#039;:category&#039; =&gt; $category,
</div><div class='line covered'><span class='num'>470</span>                &#039;:type&#039;     =&gt; $type,
</div><div class='line covered'><span class='num'>471</span>                &#039;:data&#039;     =&gt; json_encode($data, JSON_UNESCAPED_UNICODE)
</div><div class='line covered'><span class='num'>472</span>            ]);
</div><div class='line not-executable'><span class='num'>473</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>474</span>            // TODO
</div><div class='line not-executable'><span class='num'>475</span>        }
</div><div class='line not-executable'><span class='num'>476</span>    }
</div><div class='line covered'><span class='num'>477</span>
</div><div class='line not-executable'><span class='num'>478</span>    public function updateNode(string $id, string $label, string $category, string $type, array $data = []): void
</div><div class='line not-executable'><span class='num'>479</span>    {
</div><div class='line not-executable'><span class='num'>480</span>        try {
</div><div class='line not-executable'><span class='num'>481</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-covered'><span class='num'>482</span>                UPDATE nodes
</div><div class='line not-executable'><span class='num'>483</span>                SET    label = :label, 
</div><div class='line not-executable'><span class='num'>484</span>                       category = :category, 
</div><div class='line not-executable'><span class='num'>485</span>                       type = :type, 
</div><div class='line not-executable'><span class='num'>486</span>                       data = :data
</div><div class='line not-executable'><span class='num'>487</span>                WHERE  id = :id&quot;);
</div><div class='line not-executable'><span class='num'>488</span>            $data[&#039;id&#039;]       = $id;
</div><div class='line not-covered'><span class='num'>489</span>            $data[&#039;label&#039;]    = $label;
</div><div class='line not-covered'><span class='num'>490</span>            $data[&#039;category&#039;] = $category;
</div><div class='line not-covered'><span class='num'>491</span>            $data[&#039;type&#039;]     = $type;
</div><div class='line not-covered'><span class='num'>492</span>
</div><div class='line not-executable'><span class='num'>493</span>            $stmt-&gt;execute([
</div><div class='line not-covered'><span class='num'>494</span>                &#039;:id&#039;       =&gt; $id,
</div><div class='line not-covered'><span class='num'>495</span>                &#039;:label&#039;    =&gt; $label,
</div><div class='line not-covered'><span class='num'>496</span>                &#039;:category&#039; =&gt; $category,
</div><div class='line not-covered'><span class='num'>497</span>                &#039;:type&#039;     =&gt; $type,
</div><div class='line not-covered'><span class='num'>498</span>                &#039;:data&#039;     =&gt; json_encode($data, JSON_UNESCAPED_UNICODE)
</div><div class='line not-covered'><span class='num'>499</span>            ]);
</div><div class='line not-executable'><span class='num'>500</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>501</span>            // TODO
</div><div class='line not-executable'><span class='num'>502</span>        }
</div><div class='line not-executable'><span class='num'>503</span>    }
</div><div class='line not-covered'><span class='num'>504</span>
</div><div class='line not-executable'><span class='num'>505</span>    public function deleteNode(string $id): void
</div><div class='line not-executable'><span class='num'>506</span>    {
</div><div class='line not-executable'><span class='num'>507</span>        try {
</div><div class='line not-executable'><span class='num'>508</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;DELETE FROM nodes WHERE id = :id&quot;);
</div><div class='line not-covered'><span class='num'>509</span>            $stmt-&gt;execute([&#039;:id&#039; =&gt; $id]);
</div><div class='line not-covered'><span class='num'>510</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>511</span>            // TODO
</div><div class='line not-executable'><span class='num'>512</span>        }
</div><div class='line not-executable'><span class='num'>513</span>    }
</div><div class='line not-covered'><span class='num'>514</span>
</div><div class='line not-executable'><span class='num'>515</span>    public function getEdge(string $source, string $target): ?array
</div><div class='line not-executable'><span class='num'>516</span>    {
</div><div class='line not-executable'><span class='num'>517</span>        try {
</div><div class='line not-executable'><span class='num'>518</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-covered'><span class='num'>519</span>                SELECT * FROM edges
</div><div class='line not-executable'><span class='num'>520</span>                WHERE source = :source AND target = :target
</div><div class='line not-executable'><span class='num'>521</span>            &quot;);
</div><div class='line not-executable'><span class='num'>522</span>            $stmt-&gt;execute([
</div><div class='line not-covered'><span class='num'>523</span>                &#039;:source&#039; =&gt; $source,
</div><div class='line not-covered'><span class='num'>524</span>                &#039;:target&#039; =&gt; $target
</div><div class='line not-covered'><span class='num'>525</span>            ]);
</div><div class='line not-executable'><span class='num'>526</span>            $row = $stmt-&gt;fetch();
</div><div class='line not-covered'><span class='num'>527</span>            if ($row) {
</div><div class='line not-covered'><span class='num'>528</span>                return $row;
</div><div class='line not-covered'><span class='num'>529</span>            }
</div><div class='line not-executable'><span class='num'>530</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>531</span>            error_log(&quot;GraphDatabase edge exists check failed: &quot; . $e-&gt;getMessage());
</div><div class='line not-covered'><span class='num'>532</span>        }
</div><div class='line not-executable'><span class='num'>533</span>        return null;
</div><div class='line not-covered'><span class='num'>534</span>    }
</div><div class='line not-covered'><span class='num'>535</span>
</div><div class='line not-executable'><span class='num'>536</span>    public function getEdgeById(string $id): ?array
</div><div class='line not-executable'><span class='num'>537</span>    {
</div><div class='line not-executable'><span class='num'>538</span>        try {
</div><div class='line not-executable'><span class='num'>539</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-covered'><span class='num'>540</span>                SELECT * FROM edges
</div><div class='line not-executable'><span class='num'>541</span>                WHERE id = :id
</div><div class='line not-executable'><span class='num'>542</span>            &quot;);
</div><div class='line not-executable'><span class='num'>543</span>            $stmt-&gt;execute([
</div><div class='line not-covered'><span class='num'>544</span>                &#039;:id&#039; =&gt; $id,
</div><div class='line not-covered'><span class='num'>545</span>            ]);
</div><div class='line not-executable'><span class='num'>546</span>            $row = $stmt-&gt;fetch();
</div><div class='line not-covered'><span class='num'>547</span>            if ($row) {
</div><div class='line not-covered'><span class='num'>548</span>                return $row;
</div><div class='line not-covered'><span class='num'>549</span>            }
</div><div class='line not-executable'><span class='num'>550</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>551</span>            error_log(&quot;GraphDatabase edge exists check failed: &quot; . $e-&gt;getMessage());
</div><div class='line not-covered'><span class='num'>552</span>        }
</div><div class='line not-executable'><span class='num'>553</span>        return null;
</div><div class='line not-covered'><span class='num'>554</span>    }
</div><div class='line not-covered'><span class='num'>555</span>
</div><div class='line not-executable'><span class='num'>556</span>    public function getEdges(): array
</div><div class='line not-executable'><span class='num'>557</span>    {
</div><div class='line not-executable'><span class='num'>558</span>        try {
</div><div class='line not-executable'><span class='num'>559</span>            $stmt  = $this-&gt;pdo-&gt;query(&quot;SELECT * FROM edges&quot;);
</div><div class='line not-covered'><span class='num'>560</span>            $rows  = $stmt-&gt;fetchAll();
</div><div class='line not-covered'><span class='num'>561</span>            return $rows;
</div><div class='line not-covered'><span class='num'>562</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>563</span>            error_log(&quot;GraphDatabase fetch all edges failed: &quot; . $e-&gt;getMessage());
</div><div class='line not-covered'><span class='num'>564</span>            return [];
</div><div class='line not-covered'><span class='num'>565</span>        }
</div><div class='line not-executable'><span class='num'>566</span>    }
</div><div class='line not-covered'><span class='num'>567</span>
</div><div class='line not-executable'><span class='num'>568</span>    public function insertEdge(string $id, string $source, string $target, array $data = []): void
</div><div class='line not-executable'><span class='num'>569</span>    {
</div><div class='line not-executable'><span class='num'>570</span>        // verify if the inverse edge exists
</div><div class='line not-executable'><span class='num'>571</span>        $r = $this-&gt;getEdge($target, $source);
</div><div class='line not-covered'><span class='num'>572</span>        
</div><div class='line not-executable'><span class='num'>573</span>        try {
</div><div class='line not-executable'><span class='num'>574</span>            $sql = &quot;
</div><div class='line not-covered'><span class='num'>575</span>                INSERT OR IGNORE INTO edges
</div><div class='line not-executable'><span class='num'>576</span>                (id, source, target, data)
</div><div class='line not-executable'><span class='num'>577</span>                VALUES (:id, :source, :target, :data)&quot;;
</div><div class='line not-executable'><span class='num'>578</span>            $stmt           = $this-&gt;pdo-&gt;prepare($sql);
</div><div class='line not-covered'><span class='num'>579</span>            $data[&#039;id&#039;]     = $id;
</div><div class='line not-covered'><span class='num'>580</span>            $data[&#039;source&#039;] = $source;
</div><div class='line not-covered'><span class='num'>581</span>            $data[&#039;target&#039;] = $target;
</div><div class='line not-covered'><span class='num'>582</span>            $stmt-&gt;execute([
</div><div class='line not-covered'><span class='num'>583</span>                &#039;:id&#039;     =&gt; $id,
</div><div class='line not-covered'><span class='num'>584</span>                &#039;:source&#039; =&gt; $source,
</div><div class='line not-covered'><span class='num'>585</span>                &#039;:target&#039; =&gt; $target,
</div><div class='line not-covered'><span class='num'>586</span>                &#039;:data&#039;   =&gt; json_encode($data, JSON_UNESCAPED_UNICODE)
</div><div class='line not-covered'><span class='num'>587</span>            ]);
</div><div class='line not-executable'><span class='num'>588</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>589</span>            // TODO
</div><div class='line not-executable'><span class='num'>590</span>        }
</div><div class='line not-executable'><span class='num'>591</span>    }
</div><div class='line not-covered'><span class='num'>592</span>
</div><div class='line not-executable'><span class='num'>593</span>    public function updateEdge(string $id, string $source, string $target, array $data = []): void
</div><div class='line not-executable'><span class='num'>594</span>    {
</div><div class='line not-executable'><span class='num'>595</span>        try {
</div><div class='line not-executable'><span class='num'>596</span>            $data[&#039;id&#039;]     = $id;
</div><div class='line not-covered'><span class='num'>597</span>            $data[&#039;source&#039;] = $source;
</div><div class='line not-covered'><span class='num'>598</span>            $data[&#039;target&#039;] = $target;
</div><div class='line not-covered'><span class='num'>599</span>
</div><div class='line not-executable'><span class='num'>600</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-covered'><span class='num'>601</span>                UPDATE edges
</div><div class='line not-executable'><span class='num'>602</span>                SET data = :data
</div><div class='line not-executable'><span class='num'>603</span>                WHERE id = :id&quot;);
</div><div class='line not-executable'><span class='num'>604</span>            $stmt-&gt;execute([
</div><div class='line not-covered'><span class='num'>605</span>                &#039;:id&#039;   =&gt; $id,
</div><div class='line not-covered'><span class='num'>606</span>                &#039;:data&#039; =&gt; json_encode($data, JSON_UNESCAPED_UNICODE)
</div><div class='line not-covered'><span class='num'>607</span>            ]);
</div><div class='line not-executable'><span class='num'>608</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>609</span>            // TODO
</div><div class='line not-executable'><span class='num'>610</span>        }
</div><div class='line not-executable'><span class='num'>611</span>    }
</div><div class='line not-covered'><span class='num'>612</span>
</div><div class='line not-executable'><span class='num'>613</span>    public function deleteEdge(string $id): void
</div><div class='line not-executable'><span class='num'>614</span>    {
</div><div class='line not-executable'><span class='num'>615</span>        try {
</div><div class='line not-executable'><span class='num'>616</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;DELETE FROM edges WHERE id = :id&quot;);
</div><div class='line not-covered'><span class='num'>617</span>            $stmt-&gt;execute([&#039;:id&#039; =&gt; $id]);
</div><div class='line not-covered'><span class='num'>618</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>619</span>            // TODO
</div><div class='line not-executable'><span class='num'>620</span>        }
</div><div class='line not-executable'><span class='num'>621</span>    }
</div><div class='line not-covered'><span class='num'>622</span>
</div><div class='line not-executable'><span class='num'>623</span>    public function getStatuses(): array
</div><div class='line not-executable'><span class='num'>624</span>    {
</div><div class='line not-executable'><span class='num'>625</span>        $stmt   = $this-&gt;pdo-&gt;query(&quot;
</div><div class='line not-covered'><span class='num'>626</span>            SELECT n.id,
</div><div class='line not-executable'><span class='num'>627</span>                   s.status
</div><div class='line not-executable'><span class='num'>628</span>            FROM   nodes n
</div><div class='line not-executable'><span class='num'>629</span>            LEFT JOIN status s ON n.id = s.node_id&quot;);
</div><div class='line not-executable'><span class='num'>630</span>        $status = $stmt-&gt;fetchAll();
</div><div class='line not-covered'><span class='num'>631</span>        return $status;
</div><div class='line not-covered'><span class='num'>632</span>    }
</div><div class='line not-covered'><span class='num'>633</span>
</div><div class='line not-executable'><span class='num'>634</span>    public function getNodeStatus(string $id): ?string
</div><div class='line not-executable'><span class='num'>635</span>    {
</div><div class='line not-executable'><span class='num'>636</span>        $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-covered'><span class='num'>637</span>            SELECT s.status
</div><div class='line not-executable'><span class='num'>638</span>            FROM nodes n
</div><div class='line not-executable'><span class='num'>639</span>            LEFT JOIN status s
</div><div class='line not-executable'><span class='num'>640</span>            ON n.id = s.node_id
</div><div class='line not-executable'><span class='num'>641</span>            WHERE n.id = ?&quot;);
</div><div class='line not-executable'><span class='num'>642</span>        $stmt-&gt;execute([$id]);
</div><div class='line not-covered'><span class='num'>643</span>        $status = $stmt-&gt;fetch();
</div><div class='line not-covered'><span class='num'>644</span>        return $status ? $status[&#039;status&#039;] : null;
</div><div class='line not-covered'><span class='num'>645</span>    }
</div><div class='line not-covered'><span class='num'>646</span>
</div><div class='line not-executable'><span class='num'>647</span>    public function setNodeStatus(string $id, string $status): void
</div><div class='line not-executable'><span class='num'>648</span>    {
</div><div class='line not-executable'><span class='num'>649</span>        $stmt = $this-&gt;pdo-&gt;prepare(&quot;REPLACE INTO status (node_id, status) VALUES (?, ?)&quot;);
</div><div class='line not-covered'><span class='num'>650</span>        $stmt-&gt;execute([$id, $status]);
</div><div class='line not-covered'><span class='num'>651</span>    }
</div><div class='line not-covered'><span class='num'>652</span>
</div><div class='line not-executable'><span class='num'>653</span>    public function getLogs($limit): array
</div><div class='line not-executable'><span class='num'>654</span>    {
</div><div class='line not-executable'><span class='num'>655</span>        $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-covered'><span class='num'>656</span>            SELECT *
</div><div class='line not-executable'><span class='num'>657</span>            FROM audit
</div><div class='line not-executable'><span class='num'>658</span>            ORDER BY created_at DESC
</div><div class='line not-executable'><span class='num'>659</span>            LIMIT :limit
</div><div class='line not-executable'><span class='num'>660</span>        &quot;);
</div><div class='line not-executable'><span class='num'>661</span>        $stmt-&gt;bindValue(&#039;:limit&#039;, (int)$limit, PDO::PARAM_INT);
</div><div class='line not-covered'><span class='num'>662</span>        $stmt-&gt;execute();
</div><div class='line not-covered'><span class='num'>663</span>        $rows = $stmt-&gt;fetchAll();
</div><div class='line not-covered'><span class='num'>664</span>        return $rows;
</div><div class='line not-covered'><span class='num'>665</span>    }
</div><div class='line not-covered'><span class='num'>666</span>
</div><div class='line not-executable'><span class='num'>667</span>    public function insertAuditLog(string $entity_type, string $entity_id, string $action, ?array $old_data = null, ?array $new_data = null, string $user_id, string $ip_address): bool
</div><div class='line not-executable'><span class='num'>668</span>    {
</div><div class='line not-executable'><span class='num'>669</span>        try {
</div><div class='line not-executable'><span class='num'>670</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line covered'><span class='num'>671</span>                INSERT INTO audit (entity_type, entity_id, action, old_data, new_data, user_id, ip_address)
</div><div class='line not-executable'><span class='num'>672</span>                VALUES (:entity_type, :entity_id, :action, :old_data, :new_data, :user_id, :ip_address)
</div><div class='line not-executable'><span class='num'>673</span>            &quot;);
</div><div class='line not-executable'><span class='num'>674</span>
</div><div class='line not-executable'><span class='num'>675</span>            $stmt-&gt;execute([
</div><div class='line covered'><span class='num'>676</span>                &#039;:entity_type&#039; =&gt; $entity_type,
</div><div class='line covered'><span class='num'>677</span>                &#039;:entity_id&#039;   =&gt; $entity_id,
</div><div class='line covered'><span class='num'>678</span>                &#039;:action&#039;      =&gt; $action,
</div><div class='line covered'><span class='num'>679</span>                &#039;:old_data&#039;    =&gt; $old_data !== null ? json_encode($old_data, JSON_UNESCAPED_UNICODE) : null,
</div><div class='line not-covered'><span class='num'>680</span>                &#039;:new_data&#039;    =&gt; $new_data !== null ? json_encode($new_data, JSON_UNESCAPED_UNICODE) : null,
</div><div class='line covered'><span class='num'>681</span>                &#039;:user_id&#039;     =&gt; $user_id,
</div><div class='line covered'><span class='num'>682</span>                &#039;:ip_address&#039;  =&gt; $ip_address
</div><div class='line covered'><span class='num'>683</span>            ]);
</div><div class='line not-executable'><span class='num'>684</span>            return true;
</div><div class='line covered'><span class='num'>685</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>686</span>            error_log(&quot;GraphDatabase audit log insert failed: &quot; . $e-&gt;getMessage());
</div><div class='line not-covered'><span class='num'>687</span>            return false;
</div><div class='line not-covered'><span class='num'>688</span>        }
</div><div class='line not-executable'><span class='num'>689</span>    }
</div><div class='line not-covered'><span class='num'>690</span>
</div><div class='line not-executable'><span class='num'>691</span>    private function initSchema(): void
</div><div class='line not-executable'><span class='num'>692</span>    {
</div><div class='line not-executable'><span class='num'>693</span>        $this-&gt;pdo-&gt;exec(&quot;
</div><div class='line covered'><span class='num'>694</span>            CREATE TABLE IF NOT EXISTS users (
</div><div class='line not-executable'><span class='num'>695</span>                id TEXT PRIMARY KEY,
</div><div class='line not-executable'><span class='num'>696</span>                user_group TEXT NOT NULL
</div><div class='line not-executable'><span class='num'>697</span>            )
</div><div class='line not-executable'><span class='num'>698</span>        &quot;);
</div><div class='line not-executable'><span class='num'>699</span>
</div><div class='line not-executable'><span class='num'>700</span>        $this-&gt;pdo-&gt;exec(&quot;INSERT INTO users VALUES(&#039;admin&#039;, &#039;admin&#039;)&quot;);
</div><div class='line covered'><span class='num'>701</span>
</div><div class='line not-executable'><span class='num'>702</span>        $this-&gt;pdo-&gt;exec(&quot;
</div><div class='line covered'><span class='num'>703</span>            CREATE TABLE IF NOT EXISTS nodes (
</div><div class='line not-executable'><span class='num'>704</span>                id TEXT PRIMARY KEY,
</div><div class='line not-executable'><span class='num'>705</span>                label TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>706</span>                category TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>707</span>                type TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>708</span>                data TEXT NOT NULL
</div><div class='line not-executable'><span class='num'>709</span>            )
</div><div class='line not-executable'><span class='num'>710</span>        &quot;);
</div><div class='line not-executable'><span class='num'>711</span>
</div><div class='line not-executable'><span class='num'>712</span>        $this-&gt;pdo-&gt;exec(&quot;
</div><div class='line covered'><span class='num'>713</span>            CREATE TABLE IF NOT EXISTS edges (
</div><div class='line not-executable'><span class='num'>714</span>                id TEXT PRIMARY KEY,
</div><div class='line not-executable'><span class='num'>715</span>                source TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>716</span>                target TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>717</span>                data TEXT,
</div><div class='line not-executable'><span class='num'>718</span>                FOREIGN KEY (source) REFERENCES nodes(id) ON DELETE CASCADE,
</div><div class='line not-executable'><span class='num'>719</span>                FOREIGN KEY (target) REFERENCES nodes(id) ON DELETE CASCADE
</div><div class='line not-executable'><span class='num'>720</span>            )
</div><div class='line not-executable'><span class='num'>721</span>        &quot;);
</div><div class='line not-executable'><span class='num'>722</span>
</div><div class='line not-executable'><span class='num'>723</span>        $this-&gt;pdo-&gt;exec(&quot;CREATE UNIQUE INDEX IF NOT EXISTS idx_edges_source_target ON edges (source, target)&quot;);
</div><div class='line covered'><span class='num'>724</span>
</div><div class='line not-executable'><span class='num'>725</span>        $this-&gt;pdo-&gt;exec(&quot;
</div><div class='line covered'><span class='num'>726</span>            CREATE TABLE IF NOT EXISTS status (
</div><div class='line not-executable'><span class='num'>727</span>                node_id TEXT PRIMARY KEY NOT NULL,
</div><div class='line not-executable'><span class='num'>728</span>                status TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>729</span>                created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
</div><div class='line not-executable'><span class='num'>730</span>                FOREIGN KEY (node_id) REFERENCES nodes(id) ON DELETE CASCADE
</div><div class='line not-executable'><span class='num'>731</span>            )
</div><div class='line not-executable'><span class='num'>732</span>        &quot;);
</div><div class='line not-executable'><span class='num'>733</span>
</div><div class='line not-executable'><span class='num'>734</span>        $this-&gt;pdo-&gt;exec(&quot;CREATE INDEX IF NOT EXISTS idx_node_status_node_id ON status (node_id)&quot;);
</div><div class='line covered'><span class='num'>735</span>
</div><div class='line not-executable'><span class='num'>736</span>        $this-&gt;pdo-&gt;exec(&quot;
</div><div class='line covered'><span class='num'>737</span>            CREATE TABLE IF NOT EXISTS audit (
</div><div class='line not-executable'><span class='num'>738</span>                id INTEGER PRIMARY KEY AUTOINCREMENT,
</div><div class='line not-executable'><span class='num'>739</span>                entity_type TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>740</span>                entity_id TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>741</span>                action TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>742</span>                old_data TEXT,
</div><div class='line not-executable'><span class='num'>743</span>                new_data TEXT,
</div><div class='line not-executable'><span class='num'>744</span>                user_id TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>745</span>                ip_address TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>746</span>                created_at DATETIME DEFAULT CURRENT_TIMESTAMP
</div><div class='line not-executable'><span class='num'>747</span>            )
</div><div class='line not-executable'><span class='num'>748</span>        &quot;);
</div><div class='line not-executable'><span class='num'>749</span>    }
</div><div class='line covered'><span class='num'>750</span>
</div><div class='line not-executable'><span class='num'>751</span>    public static function createConnection(string $dsn): PDO
</div><div class='line not-executable'><span class='num'>752</span>    {
</div><div class='line not-executable'><span class='num'>753</span>        $pdo = new PDO($dsn);
</div><div class='line covered'><span class='num'>754</span>        $pdo-&gt;setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
</div><div class='line covered'><span class='num'>755</span>        $pdo-&gt;setAttribute(PDO::ATTR_DEFAULT_FETCH_MODE, PDO::FETCH_ASSOC);
</div><div class='line covered'><span class='num'>756</span>        $pdo-&gt;exec(&#039;PRAGMA foreign_keys = ON&#039;);
</div><div class='line covered'><span class='num'>757</span>        return $pdo;
</div><div class='line covered'><span class='num'>758</span>    }
</div><div class='line not-covered'><span class='num'>759</span>}
</div><div class='line not-executable'><span class='num'>760</span>
</div><div class='line not-executable'><span class='num'>761</span>final class GraphServiceException extends RuntimeException
</div><div class='line not-executable'><span class='num'>762</span>{
</div><div class='line not-executable'><span class='num'>763</span>}
</div><div class='line not-executable'><span class='num'>764</span>
</div><div class='line not-executable'><span class='num'>765</span>interface GraphServiceInterface
</div><div class='line not-executable'><span class='num'>766</span>{
</div><div class='line not-executable'><span class='num'>767</span>    public function getUser(string $id): ?User;
</div><div class='line not-executable'><span class='num'>768</span>    public function insertUser(User $user): void;
</div><div class='line not-executable'><span class='num'>769</span>    public function updateUser(User $user): void;
</div><div class='line not-executable'><span class='num'>770</span>
</div><div class='line not-executable'><span class='num'>771</span>    public function getGraph(): Graph;
</div><div class='line not-executable'><span class='num'>772</span>
</div><div class='line not-executable'><span class='num'>773</span>    public function getNode(string $id): ?Node;
</div><div class='line not-executable'><span class='num'>774</span>    public function getNodes(): Nodes;
</div><div class='line not-executable'><span class='num'>775</span>    public function insertNode(Node $node): void;
</div><div class='line not-executable'><span class='num'>776</span>    public function updateNode(Node $node): void;
</div><div class='line not-executable'><span class='num'>777</span>    public function deleteNode(string $id): void;
</div><div class='line not-executable'><span class='num'>778</span>
</div><div class='line not-executable'><span class='num'>779</span>    public function getEdge(string $source, string $target): ?Edge;
</div><div class='line not-executable'><span class='num'>780</span>    public function getEdges(): Edges;
</div><div class='line not-executable'><span class='num'>781</span>    public function insertEdge(Edge $edge): void;
</div><div class='line not-executable'><span class='num'>782</span>    public function updateEdge(Edge $edge): void;
</div><div class='line not-executable'><span class='num'>783</span>    public function deleteEdge(string $id): void;
</div><div class='line not-executable'><span class='num'>784</span>
</div><div class='line not-executable'><span class='num'>785</span>    public function getStatuses(): NodeStatuses;
</div><div class='line not-executable'><span class='num'>786</span>    public function getNodeStatus(string $id): NodeStatus;
</div><div class='line not-executable'><span class='num'>787</span>    public function setNodeStatus(NodeStatus $status): void;
</div><div class='line not-executable'><span class='num'>788</span>
</div><div class='line not-executable'><span class='num'>789</span>    public function getLogs($limit): AuditLogs;
</div><div class='line not-executable'><span class='num'>790</span>}
</div><div class='line not-executable'><span class='num'>791</span>
</div><div class='line not-executable'><span class='num'>792</span>final class GraphService implements GraphServiceInterface
</div><div class='line not-executable'><span class='num'>793</span>{
</div><div class='line not-executable'><span class='num'>794</span>    private const SECURE_ACTIONS = [
</div><div class='line not-executable'><span class='num'>795</span>        &#039;GraphService::getGraph&#039;      =&gt; true,
</div><div class='line not-executable'><span class='num'>796</span>        &#039;GraphService::getNode&#039;       =&gt; true,
</div><div class='line not-executable'><span class='num'>797</span>        &#039;GraphService::getNodes&#039;      =&gt; true,
</div><div class='line not-executable'><span class='num'>798</span>        &#039;GraphService::getEdge&#039;       =&gt; true,
</div><div class='line not-executable'><span class='num'>799</span>        &#039;GraphService::getEdges&#039;      =&gt; true,
</div><div class='line not-executable'><span class='num'>800</span>        &#039;GraphService::getStatuses&#039;   =&gt; true,
</div><div class='line not-executable'><span class='num'>801</span>        &#039;GraphService::getNodeStatus&#039; =&gt; true,
</div><div class='line not-executable'><span class='num'>802</span>        &#039;GraphService::setNodeStatus&#039; =&gt; true,
</div><div class='line not-executable'><span class='num'>803</span>        &#039;GraphService::getLogs&#039;       =&gt; true,
</div><div class='line not-executable'><span class='num'>804</span>        &#039;GraphService::insertNode&#039;    =&gt; false,
</div><div class='line not-executable'><span class='num'>805</span>        &#039;GraphService::updateNode&#039;    =&gt; false,
</div><div class='line not-executable'><span class='num'>806</span>        &#039;GraphService::deleteNode&#039;    =&gt; false,
</div><div class='line not-executable'><span class='num'>807</span>        &#039;GraphService::insertEdge&#039;    =&gt; false,
</div><div class='line not-executable'><span class='num'>808</span>        &#039;GraphService::updateEdge&#039;    =&gt; false,
</div><div class='line not-executable'><span class='num'>809</span>        &#039;GraphService::deleteEdge&#039;    =&gt; false,
</div><div class='line not-executable'><span class='num'>810</span>
</div><div class='line not-executable'><span class='num'>811</span>        &#039;GraphService::insertAuditLog&#039; =&gt; false,
</div><div class='line not-executable'><span class='num'>812</span>    ];
</div><div class='line not-executable'><span class='num'>813</span>
</div><div class='line not-executable'><span class='num'>814</span>    private GraphDatabaseInterface $db;
</div><div class='line not-executable'><span class='num'>815</span>    private Logger $logger;
</div><div class='line not-executable'><span class='num'>816</span>
</div><div class='line not-executable'><span class='num'>817</span>    public function __construct(GraphDatabaseInterface $db, Logger $logger)
</div><div class='line not-executable'><span class='num'>818</span>    {
</div><div class='line not-executable'><span class='num'>819</span>        $this-&gt;db = $db;
</div><div class='line covered'><span class='num'>820</span>        $this-&gt;logger = $logger;
</div><div class='line covered'><span class='num'>821</span>    }
</div><div class='line covered'><span class='num'>822</span>
</div><div class='line not-executable'><span class='num'>823</span>    public function getUser(string $id): ?User
</div><div class='line not-executable'><span class='num'>824</span>    {
</div><div class='line not-executable'><span class='num'>825</span>        $data = $this-&gt;db-&gt;getUser($id);
</div><div class='line not-covered'><span class='num'>826</span>        if ($data) {
</div><div class='line not-covered'><span class='num'>827</span>            $user = new User($id, null, $data[&#039;user_group&#039;]);
</div><div class='line not-covered'><span class='num'>828</span>            return $user;
</div><div class='line not-covered'><span class='num'>829</span>        }
</div><div class='line not-executable'><span class='num'>830</span>        return null;
</div><div class='line not-covered'><span class='num'>831</span>    }
</div><div class='line not-covered'><span class='num'>832</span>
</div><div class='line not-executable'><span class='num'>833</span>    public function insertUser(User $user): void
</div><div class='line not-executable'><span class='num'>834</span>    {
</div><div class='line not-executable'><span class='num'>835</span>        $this-&gt;db-&gt;insertUser($user-&gt;id, $user-&gt;group-&gt;id);
</div><div class='line not-covered'><span class='num'>836</span>    }
</div><div class='line not-covered'><span class='num'>837</span>
</div><div class='line not-executable'><span class='num'>838</span>    public function updateUser(User $user): void
</div><div class='line not-executable'><span class='num'>839</span>    {
</div><div class='line not-executable'><span class='num'>840</span>        $this-&gt;db-&gt;updateUser($user-&gt;id, $user-&gt;group-&gt;id);
</div><div class='line not-covered'><span class='num'>841</span>    }
</div><div class='line not-covered'><span class='num'>842</span>
</div><div class='line not-executable'><span class='num'>843</span>    public function getGraph(): Graph
</div><div class='line not-executable'><span class='num'>844</span>    {
</div><div class='line not-executable'><span class='num'>845</span>        $nodes = $this-&gt;getNodes()-&gt;nodes;
</div><div class='line not-covered'><span class='num'>846</span>        $edges = $this-&gt;getEdges()-&gt;edges;
</div><div class='line not-covered'><span class='num'>847</span>        return new Graph($nodes, $edges);
</div><div class='line not-covered'><span class='num'>848</span>    }
</div><div class='line not-covered'><span class='num'>849</span>
</div><div class='line not-executable'><span class='num'>850</span>    public function getNode(string $id): ?Node
</div><div class='line not-executable'><span class='num'>851</span>    {
</div><div class='line not-executable'><span class='num'>852</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line covered'><span class='num'>853</span>            throw new RuntimeException(&quot;Permission denied to get node.&quot;);
</div><div class='line not-covered'><span class='num'>854</span>        }
</div><div class='line not-executable'><span class='num'>855</span>
</div><div class='line not-executable'><span class='num'>856</span>        $data = $this-&gt;db-&gt;getNode($id);
</div><div class='line covered'><span class='num'>857</span>        if ($data) {
</div><div class='line covered'><span class='num'>858</span>            return new Node(
</div><div class='line covered'><span class='num'>859</span>                $data[&#039;id&#039;],
</div><div class='line covered'><span class='num'>860</span>                $data[&#039;label&#039;],
</div><div class='line covered'><span class='num'>861</span>                $data[&#039;category&#039;],
</div><div class='line covered'><span class='num'>862</span>                $data[&#039;type&#039;],
</div><div class='line covered'><span class='num'>863</span>                json_decode($data[&#039;data&#039;], true)
</div><div class='line covered'><span class='num'>864</span>            );
</div><div class='line not-executable'><span class='num'>865</span>        }
</div><div class='line not-executable'><span class='num'>866</span>        return null;
</div><div class='line not-covered'><span class='num'>867</span>    }
</div><div class='line not-covered'><span class='num'>868</span>
</div><div class='line not-executable'><span class='num'>869</span>    public function getNodes(): Nodes
</div><div class='line not-executable'><span class='num'>870</span>    {
</div><div class='line not-executable'><span class='num'>871</span>        if(! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>872</span>            throw new RuntimeException(&quot;Permission denied to get nodes.&quot;);
</div><div class='line not-covered'><span class='num'>873</span>        }
</div><div class='line not-executable'><span class='num'>874</span>
</div><div class='line not-executable'><span class='num'>875</span>        $nodesData = $this-&gt;db-&gt;getNodes();
</div><div class='line not-covered'><span class='num'>876</span>        $nodes     = new Nodes();
</div><div class='line not-covered'><span class='num'>877</span>        foreach ($nodesData as $data) {
</div><div class='line not-covered'><span class='num'>878</span>            $node = new Node(
</div><div class='line not-covered'><span class='num'>879</span>                $data[&#039;id&#039;],
</div><div class='line not-covered'><span class='num'>880</span>                $data[&#039;label&#039;],
</div><div class='line not-covered'><span class='num'>881</span>                $data[&#039;category&#039;],
</div><div class='line not-covered'><span class='num'>882</span>                $data[&#039;type&#039;],
</div><div class='line not-covered'><span class='num'>883</span>                json_decode($data[&#039;data&#039;], true)
</div><div class='line not-covered'><span class='num'>884</span>            );
</div><div class='line not-executable'><span class='num'>885</span>            $nodes-&gt;addNode($node);
</div><div class='line not-covered'><span class='num'>886</span>        }
</div><div class='line not-executable'><span class='num'>887</span>        return $nodes;
</div><div class='line not-covered'><span class='num'>888</span>    }
</div><div class='line not-covered'><span class='num'>889</span>
</div><div class='line not-executable'><span class='num'>890</span>    public function insertNode(Node $node): void
</div><div class='line not-executable'><span class='num'>891</span>    {
</div><div class='line not-executable'><span class='num'>892</span>        $this-&gt;logger-&gt;debug(&#039;inserting node&#039;, $node-&gt;toArray());
</div><div class='line covered'><span class='num'>893</span>
</div><div class='line not-executable'><span class='num'>894</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line covered'><span class='num'>895</span>            $this-&gt;logger-&gt;info(&#039;permission denied&#039;, $node-&gt;toArray());
</div><div class='line not-covered'><span class='num'>896</span>            throw new GraphServiceException(&#039;permission denied&#039;);
</div><div class='line not-covered'><span class='num'>897</span>        }
</div><div class='line not-executable'><span class='num'>898</span>
</div><div class='line not-executable'><span class='num'>899</span>        $this-&gt;logger-&gt;info(&#039;permission allowed&#039;, $node-&gt;toArray());
</div><div class='line covered'><span class='num'>900</span>
</div><div class='line not-executable'><span class='num'>901</span>        $this-&gt;insertAuditLog(new AuditLog( &#039;node&#039;, $node-&gt;id, &#039;insert&#039;, null, $node-&gt;toArray()));
</div><div class='line covered'><span class='num'>902</span>
</div><div class='line not-executable'><span class='num'>903</span>        $this-&gt;db-&gt;insertNode(
</div><div class='line covered'><span class='num'>904</span>            $node-&gt;id,
</div><div class='line covered'><span class='num'>905</span>            $node-&gt;label,
</div><div class='line covered'><span class='num'>906</span>            $node-&gt;category,
</div><div class='line covered'><span class='num'>907</span>            $node-&gt;type,
</div><div class='line covered'><span class='num'>908</span>            $node-&gt;data
</div><div class='line covered'><span class='num'>909</span>        );
</div><div class='line not-executable'><span class='num'>910</span>    }
</div><div class='line covered'><span class='num'>911</span>
</div><div class='line not-executable'><span class='num'>912</span>    public function updateNode(Node $node): void
</div><div class='line not-executable'><span class='num'>913</span>    {
</div><div class='line not-executable'><span class='num'>914</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>915</span>            throw new RuntimeException(&quot;Permission denied to update node.&quot;);
</div><div class='line not-covered'><span class='num'>916</span>        }
</div><div class='line not-executable'><span class='num'>917</span>
</div><div class='line not-executable'><span class='num'>918</span>        $old = $this-&gt;getNode($node-&gt;id);
</div><div class='line not-covered'><span class='num'>919</span>        $this-&gt;insertAuditLog(new AuditLog( &#039;node&#039;, $node-&gt;id, &#039;update&#039;, $old-&gt;toArray(), $node-&gt;toArray()));
</div><div class='line not-covered'><span class='num'>920</span>
</div><div class='line not-executable'><span class='num'>921</span>        $this-&gt;db-&gt;updateNode(
</div><div class='line not-covered'><span class='num'>922</span>            $node-&gt;id,
</div><div class='line not-covered'><span class='num'>923</span>            $node-&gt;label,
</div><div class='line not-covered'><span class='num'>924</span>            $node-&gt;category,
</div><div class='line not-covered'><span class='num'>925</span>            $node-&gt;type,
</div><div class='line not-covered'><span class='num'>926</span>            $node-&gt;data
</div><div class='line not-covered'><span class='num'>927</span>        );
</div><div class='line not-executable'><span class='num'>928</span>    }
</div><div class='line not-covered'><span class='num'>929</span>
</div><div class='line not-executable'><span class='num'>930</span>    public function deleteNode(string $id): void
</div><div class='line not-executable'><span class='num'>931</span>    {
</div><div class='line not-executable'><span class='num'>932</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>933</span>            throw new RuntimeException(&quot;Permission denied to delete node.&quot;);
</div><div class='line not-covered'><span class='num'>934</span>        }
</div><div class='line not-executable'><span class='num'>935</span>
</div><div class='line not-executable'><span class='num'>936</span>        $old = $this-&gt;getNode($id);
</div><div class='line not-covered'><span class='num'>937</span>        $this-&gt;insertAuditLog(new AuditLog( &#039;node&#039;, $id, &#039;delete&#039;, $old-&gt;toArray(), null));
</div><div class='line not-covered'><span class='num'>938</span>        $this-&gt;db-&gt;deleteNode($id);
</div><div class='line not-covered'><span class='num'>939</span>    }
</div><div class='line not-covered'><span class='num'>940</span>
</div><div class='line not-executable'><span class='num'>941</span>    public function getEdge(string $source, string $target): ?Edge
</div><div class='line not-executable'><span class='num'>942</span>    {
</div><div class='line not-executable'><span class='num'>943</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>944</span>            throw new RuntimeException(&quot;Permission denied to get edge.&quot;);
</div><div class='line not-covered'><span class='num'>945</span>        }
</div><div class='line not-executable'><span class='num'>946</span>
</div><div class='line not-executable'><span class='num'>947</span>        $edgesData = $this-&gt;db-&gt;getEdges();
</div><div class='line not-covered'><span class='num'>948</span>        foreach ($edgesData as $data) {
</div><div class='line not-covered'><span class='num'>949</span>            if ($data[&#039;source&#039;] === $source &amp;&amp; $data[&#039;target&#039;] === $target) {
</div><div class='line not-covered'><span class='num'>950</span>                return new Edge(
</div><div class='line not-covered'><span class='num'>951</span>                    $data[&#039;id&#039;],
</div><div class='line not-covered'><span class='num'>952</span>                    $data[&#039;source&#039;],
</div><div class='line not-covered'><span class='num'>953</span>                    $data[&#039;target&#039;],
</div><div class='line not-covered'><span class='num'>954</span>                    json_decode($data[&#039;data&#039;], true)
</div><div class='line not-covered'><span class='num'>955</span>                );
</div><div class='line not-executable'><span class='num'>956</span>            }
</div><div class='line not-executable'><span class='num'>957</span>        }
</div><div class='line not-executable'><span class='num'>958</span>        return null;
</div><div class='line not-covered'><span class='num'>959</span>    }
</div><div class='line not-covered'><span class='num'>960</span>
</div><div class='line not-executable'><span class='num'>961</span>    public function getEdges(): Edges
</div><div class='line not-executable'><span class='num'>962</span>    {
</div><div class='line not-executable'><span class='num'>963</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>964</span>            throw new RuntimeException(&quot;Permission denied to get edges.&quot;);
</div><div class='line not-covered'><span class='num'>965</span>        }
</div><div class='line not-executable'><span class='num'>966</span>        $edgesData = $this-&gt;db-&gt;getEdges();
</div><div class='line not-covered'><span class='num'>967</span>        $edges     = new Edges();
</div><div class='line not-covered'><span class='num'>968</span>        foreach ($edgesData as $data) {
</div><div class='line not-covered'><span class='num'>969</span>            $edge = new Edge(
</div><div class='line not-covered'><span class='num'>970</span>                $data[&#039;id&#039;],
</div><div class='line not-covered'><span class='num'>971</span>                $data[&#039;source&#039;],
</div><div class='line not-covered'><span class='num'>972</span>                $data[&#039;target&#039;],
</div><div class='line not-covered'><span class='num'>973</span>                json_decode($data[&#039;data&#039;], true)
</div><div class='line not-covered'><span class='num'>974</span>            );
</div><div class='line not-executable'><span class='num'>975</span>            $edges-&gt;addEdge($edge);
</div><div class='line not-covered'><span class='num'>976</span>        }
</div><div class='line not-executable'><span class='num'>977</span>        return $edges;
</div><div class='line not-covered'><span class='num'>978</span>    }
</div><div class='line not-covered'><span class='num'>979</span>
</div><div class='line not-executable'><span class='num'>980</span>    public function insertEdge(Edge $edge): void
</div><div class='line not-executable'><span class='num'>981</span>    {
</div><div class='line not-executable'><span class='num'>982</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>983</span>            throw new RuntimeException(&quot;Permission denied to insert edge.&quot;);
</div><div class='line not-covered'><span class='num'>984</span>        }
</div><div class='line not-executable'><span class='num'>985</span>        $this-&gt;insertAuditLog(new AuditLog( &#039;edge&#039;, $edge-&gt;id, &#039;insert&#039;, null, $edge-&gt;toArray()));
</div><div class='line not-covered'><span class='num'>986</span>        $this-&gt;db-&gt;insertEdge(
</div><div class='line not-covered'><span class='num'>987</span>            $edge-&gt;id,
</div><div class='line not-covered'><span class='num'>988</span>            $edge-&gt;source,
</div><div class='line not-covered'><span class='num'>989</span>            $edge-&gt;target,
</div><div class='line not-covered'><span class='num'>990</span>            $edge-&gt;data
</div><div class='line not-covered'><span class='num'>991</span>        );
</div><div class='line not-executable'><span class='num'>992</span>    }
</div><div class='line not-covered'><span class='num'>993</span>
</div><div class='line not-executable'><span class='num'>994</span>    public function updateEdge(Edge $edge): void
</div><div class='line not-executable'><span class='num'>995</span>    {
</div><div class='line not-executable'><span class='num'>996</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>997</span>            throw new RuntimeException(&quot;Permission denied to update edge.&quot;);
</div><div class='line not-covered'><span class='num'>998</span>        }
</div><div class='line not-executable'><span class='num'>999</span>        $old = $this-&gt;getEdge($edge-&gt;source, $edge-&gt;target);
</div><div class='line not-covered'><span class='num'>1000</span>        $this-&gt;insertAuditLog(new AuditLog( &#039;edge&#039;, $edge-&gt;id, &#039;update&#039;, $old-&gt;toArray(), $edge-&gt;toArray()));
</div><div class='line not-covered'><span class='num'>1001</span>
</div><div class='line not-executable'><span class='num'>1002</span>        $this-&gt;db-&gt;updateEdge(
</div><div class='line not-covered'><span class='num'>1003</span>            $edge-&gt;id,
</div><div class='line not-covered'><span class='num'>1004</span>            $edge-&gt;source,
</div><div class='line not-covered'><span class='num'>1005</span>            $edge-&gt;target,
</div><div class='line not-covered'><span class='num'>1006</span>            $edge-&gt;data
</div><div class='line not-covered'><span class='num'>1007</span>        );
</div><div class='line not-executable'><span class='num'>1008</span>    }
</div><div class='line not-covered'><span class='num'>1009</span>
</div><div class='line not-executable'><span class='num'>1010</span>    public function deleteEdge(string $id): void
</div><div class='line not-executable'><span class='num'>1011</span>    {
</div><div class='line not-executable'><span class='num'>1012</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>1013</span>            throw new RuntimeException(&quot;Permission denied to delete edge.&quot;);
</div><div class='line not-covered'><span class='num'>1014</span>        }
</div><div class='line not-executable'><span class='num'>1015</span>        $this-&gt;db-&gt;deleteEdge($id);
</div><div class='line not-covered'><span class='num'>1016</span>    }
</div><div class='line not-covered'><span class='num'>1017</span>
</div><div class='line not-executable'><span class='num'>1018</span>    public function getStatuses(): NodeStatuses
</div><div class='line not-executable'><span class='num'>1019</span>    {
</div><div class='line not-executable'><span class='num'>1020</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>1021</span>            throw new RuntimeException(&quot;Permission denied to get statuses.&quot;);
</div><div class='line not-covered'><span class='num'>1022</span>        }
</div><div class='line not-executable'><span class='num'>1023</span>
</div><div class='line not-executable'><span class='num'>1024</span>        $statusesData = $this-&gt;db-&gt;getStatuses();
</div><div class='line not-covered'><span class='num'>1025</span>        $nodeStatuses = new NodeStatuses();
</div><div class='line not-covered'><span class='num'>1026</span>        foreach ($statusesData as $data) {
</div><div class='line not-covered'><span class='num'>1027</span>            $status = new NodeStatus(
</div><div class='line not-covered'><span class='num'>1028</span>                $data[&#039;id&#039;],
</div><div class='line not-covered'><span class='num'>1029</span>                $data[&#039;status&#039;] ?? &#039;unknown&#039;
</div><div class='line not-covered'><span class='num'>1030</span>            );
</div><div class='line not-executable'><span class='num'>1031</span>            $nodeStatuses-&gt;addStatus($status);
</div><div class='line not-covered'><span class='num'>1032</span>        }
</div><div class='line not-executable'><span class='num'>1033</span>        return $nodeStatuses;
</div><div class='line not-covered'><span class='num'>1034</span>    }
</div><div class='line not-covered'><span class='num'>1035</span>
</div><div class='line not-executable'><span class='num'>1036</span>    public function getNodeStatus(string $id): NodeStatus
</div><div class='line not-executable'><span class='num'>1037</span>    {
</div><div class='line not-executable'><span class='num'>1038</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>1039</span>            throw new RuntimeException(&quot;Permission denied to get node status.&quot;);
</div><div class='line not-covered'><span class='num'>1040</span>        }
</div><div class='line not-executable'><span class='num'>1041</span>
</div><div class='line not-executable'><span class='num'>1042</span>        $statusData = $this-&gt;db-&gt;getNodeStatus($id);
</div><div class='line not-covered'><span class='num'>1043</span>        return new NodeStatus(
</div><div class='line not-covered'><span class='num'>1044</span>            $id,
</div><div class='line not-covered'><span class='num'>1045</span>            $statusData ?? &#039;unknown&#039;
</div><div class='line not-covered'><span class='num'>1046</span>        );
</div><div class='line not-executable'><span class='num'>1047</span>    }
</div><div class='line not-covered'><span class='num'>1048</span>
</div><div class='line not-executable'><span class='num'>1049</span>    public function setNodeStatus(NodeStatus $status): void
</div><div class='line not-executable'><span class='num'>1050</span>    {
</div><div class='line not-executable'><span class='num'>1051</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>1052</span>            throw new RuntimeException(&quot;Permission denied to set node status.&quot;);
</div><div class='line not-covered'><span class='num'>1053</span>        }
</div><div class='line not-executable'><span class='num'>1054</span>
</div><div class='line not-executable'><span class='num'>1055</span>        $this-&gt;db-&gt;setNodeStatus($status-&gt;nodeId, $status-&gt;status);
</div><div class='line not-covered'><span class='num'>1056</span>    }
</div><div class='line not-covered'><span class='num'>1057</span>
</div><div class='line not-executable'><span class='num'>1058</span>    public function getLogs($limit): AuditLogs
</div><div class='line not-executable'><span class='num'>1059</span>    {
</div><div class='line not-executable'><span class='num'>1060</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>1061</span>            throw new RuntimeException(&quot;Permission denied to get audit logs.&quot;);
</div><div class='line not-covered'><span class='num'>1062</span>        }
</div><div class='line not-executable'><span class='num'>1063</span>
</div><div class='line not-executable'><span class='num'>1064</span>        $logs = new AuditLogs();
</div><div class='line not-covered'><span class='num'>1065</span>        $rows = $this-&gt;db-&gt;getLogs($limit);
</div><div class='line not-covered'><span class='num'>1066</span>        foreach ($rows as $row) {
</div><div class='line not-covered'><span class='num'>1067</span>            $old_data = $row[&#039;old_data&#039;] ? json_decode($row[&#039;old_data&#039;], true) : [];
</div><div class='line not-covered'><span class='num'>1068</span>            $new_data = $row[&#039;new_data&#039;] ?  json_decode($row[&#039;new_data&#039;], true) : [];
</div><div class='line not-covered'><span class='num'>1069</span>            $log = new AuditLog(
</div><div class='line not-covered'><span class='num'>1070</span>                $row[&#039;entity_type&#039;],
</div><div class='line not-covered'><span class='num'>1071</span>                $row[&#039;entity_id&#039;],
</div><div class='line not-covered'><span class='num'>1072</span>                $row[&#039;action&#039;],
</div><div class='line not-covered'><span class='num'>1073</span>                $old_data,
</div><div class='line not-executable'><span class='num'>1074</span>                $new_data,
</div><div class='line not-executable'><span class='num'>1075</span>            );
</div><div class='line not-executable'><span class='num'>1076</span>            $log-&gt;userId    = $row[&#039;user_id&#039;];
</div><div class='line not-covered'><span class='num'>1077</span>            $log-&gt;ipAddress = $row[&#039;ip_address&#039;];
</div><div class='line not-covered'><span class='num'>1078</span>            $log-&gt;createdAt = $row[&#039;created_at&#039;];
</div><div class='line not-covered'><span class='num'>1079</span>
</div><div class='line not-executable'><span class='num'>1080</span>            $logs-&gt;addLog($log);
</div><div class='line not-covered'><span class='num'>1081</span>        }
</div><div class='line not-executable'><span class='num'>1082</span>        return $logs;
</div><div class='line not-covered'><span class='num'>1083</span>    }
</div><div class='line not-covered'><span class='num'>1084</span>
</div><div class='line not-executable'><span class='num'>1085</span>    private function insertAuditLog(AuditLog $auditLog): void
</div><div class='line not-executable'><span class='num'>1086</span>    {
</div><div class='line not-executable'><span class='num'>1087</span>        $user_id   = GraphContext::$user-&gt;id;
</div><div class='line covered'><span class='num'>1088</span>        $ip_address = GraphContext::$user-&gt;ipAddress;
</div><div class='line covered'><span class='num'>1089</span>
</div><div class='line not-executable'><span class='num'>1090</span>        $this-&gt;db-&gt;insertAuditLog(
</div><div class='line covered'><span class='num'>1091</span>            $auditLog-&gt;entityType,
</div><div class='line covered'><span class='num'>1092</span>            $auditLog-&gt;entityId,
</div><div class='line covered'><span class='num'>1093</span>            $auditLog-&gt;action,
</div><div class='line covered'><span class='num'>1094</span>            $auditLog-&gt;oldData,
</div><div class='line covered'><span class='num'>1095</span>            $auditLog-&gt;newData,
</div><div class='line covered'><span class='num'>1096</span>            $user_id,
</div><div class='line not-executable'><span class='num'>1097</span>            $ip_address
</div><div class='line not-executable'><span class='num'>1098</span>        );
</div><div class='line not-executable'><span class='num'>1099</span>    }
</div><div class='line covered'><span class='num'>1100</span>
</div><div class='line not-executable'><span class='num'>1101</span>    private function isAllowed(string $action): bool
</div><div class='line not-executable'><span class='num'>1102</span>    {
</div><div class='line not-executable'><span class='num'>1103</span>        $group = GraphContext::$user-&gt;group;
</div><div class='line covered'><span class='num'>1104</span>
</div><div class='line not-executable'><span class='num'>1105</span>        // validate action
</div><div class='line not-executable'><span class='num'>1106</span>        // if action is one of the keys in the array self::SECURE_ACTIONS
</div><div class='line not-executable'><span class='num'>1107</span>        if (!array_key_exists($action, self::SECURE_ACTIONS)) {
</div><div class='line covered'><span class='num'>1108</span>            throw new RuntimeException(&quot;Action not defined in secure actions. Action: {$action}&quot;);
</div><div class='line not-covered'><span class='num'>1109</span>        }
</div><div class='line not-executable'><span class='num'>1110</span>
</div><div class='line not-executable'><span class='num'>1111</span>        // if is admin, allow all
</div><div class='line not-executable'><span class='num'>1112</span>        if ($group-&gt;id === &#039;admin&#039;) {
</div><div class='line covered'><span class='num'>1113</span>            return true;
</div><div class='line not-covered'><span class='num'>1114</span>        }
</div><div class='line not-executable'><span class='num'>1115</span>
</div><div class='line not-executable'><span class='num'>1116</span>        // if action is in the SAFE_ACTIONS, allow all
</div><div class='line not-executable'><span class='num'>1117</span>        if (self::SECURE_ACTIONS[$action]) {
</div><div class='line covered'><span class='num'>1118</span>            return true;
</div><div class='line covered'><span class='num'>1119</span>        }
</div><div class='line not-executable'><span class='num'>1120</span>        
</div><div class='line not-executable'><span class='num'>1121</span>        // if action is restricted, only allow contributor
</div><div class='line not-executable'><span class='num'>1122</span>        if (self::SECURE_ACTIONS[$action] == false &amp;&amp; $group-&gt;id == &#039;contributor&#039;)
</div><div class='line covered'><span class='num'>1123</span>        {
</div><div class='line not-executable'><span class='num'>1124</span>            return true;
</div><div class='line covered'><span class='num'>1125</span>        }
</div><div class='line not-executable'><span class='num'>1126</span>
</div><div class='line not-executable'><span class='num'>1127</span>        return false;
</div><div class='line not-covered'><span class='num'>1128</span>    }
</div><div class='line not-covered'><span class='num'>1129</span>}
</div><div class='line not-executable'><span class='num'>1130</span>
</div><div class='line not-executable'><span class='num'>1131</span>final class Request
</div><div class='line not-executable'><span class='num'>1132</span>{
</div><div class='line not-executable'><span class='num'>1133</span>    public array $data;
</div><div class='line not-executable'><span class='num'>1134</span>
</div><div class='line not-executable'><span class='num'>1135</span>    public function getParam($name): string
</div><div class='line not-executable'><span class='num'>1136</span>    {
</div><div class='line not-executable'><span class='num'>1137</span>        if(isset($_GET[$name])) {
</div><div class='line covered'><span class='num'>1138</span>            return $_GET[$name];
</div><div class='line covered'><span class='num'>1139</span>        }
</div><div class='line not-executable'><span class='num'>1140</span>
</div><div class='line not-executable'><span class='num'>1141</span>        throw new RuntimeException(&quot;param &#039;{$name}&#039; not found&quot;);
</div><div class='line not-covered'><span class='num'>1142</span>    }
</div><div class='line not-covered'><span class='num'>1143</span>
</div><div class='line not-executable'><span class='num'>1144</span>    public function getPath(): string
</div><div class='line not-executable'><span class='num'>1145</span>    {
</div><div class='line not-executable'><span class='num'>1146</span>        $scriptName = $_SERVER[&#039;SCRIPT_NAME&#039;];
</div><div class='line not-covered'><span class='num'>1147</span>        $requestUri = $_SERVER[&#039;REQUEST_URI&#039;];
</div><div class='line not-covered'><span class='num'>1148</span>        $requestUri = strtok($requestUri, &#039;?&#039;);
</div><div class='line not-covered'><span class='num'>1149</span>        $path = str_replace($scriptName, &#039;&#039;, $requestUri);
</div><div class='line not-covered'><span class='num'>1150</span>        return $path;
</div><div class='line not-covered'><span class='num'>1151</span>    }
</div><div class='line not-covered'><span class='num'>1152</span>}
</div><div class='line not-executable'><span class='num'>1153</span>
</div><div class='line not-executable'><span class='num'>1154</span>interface ResponseInterface
</div><div class='line not-executable'><span class='num'>1155</span>{
</div><div class='line not-executable'><span class='num'>1156</span>    public function send(): void;
</div><div class='line not-executable'><span class='num'>1157</span>}
</div><div class='line not-executable'><span class='num'>1158</span>
</div><div class='line not-executable'><span class='num'>1159</span>class Response implements ResponseInterface
</div><div class='line not-executable'><span class='num'>1160</span>{
</div><div class='line not-executable'><span class='num'>1161</span>    public int $code;
</div><div class='line not-executable'><span class='num'>1162</span>    public string $status;
</div><div class='line not-executable'><span class='num'>1163</span>    public string $message;
</div><div class='line not-executable'><span class='num'>1164</span>    public array $data;
</div><div class='line not-executable'><span class='num'>1165</span>
</div><div class='line not-executable'><span class='num'>1166</span>    public function __construct(int $code, string $status, string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1167</span>    {
</div><div class='line not-executable'><span class='num'>1168</span>        $this-&gt;code = $code;
</div><div class='line covered'><span class='num'>1169</span>        $this-&gt;status = $status;
</div><div class='line covered'><span class='num'>1170</span>        $this-&gt;message = $message;
</div><div class='line covered'><span class='num'>1171</span>        $this-&gt;data = $data;
</div><div class='line covered'><span class='num'>1172</span>    }
</div><div class='line covered'><span class='num'>1173</span>
</div><div class='line not-executable'><span class='num'>1174</span>    public function send(): void
</div><div class='line not-executable'><span class='num'>1175</span>    {
</div><div class='line not-executable'><span class='num'>1176</span>        header(&#039;Content-Type: application/json; charset=utf-8&#039;);
</div><div class='line not-covered'><span class='num'>1177</span>        http_response_code($this-&gt;code);
</div><div class='line not-covered'><span class='num'>1178</span>        $this-&gt;data = [&#039;code&#039; =&gt; $this-&gt;code, &#039;status&#039; =&gt; $this-&gt;status, &#039;message&#039; =&gt; $this-&gt;message, &#039;data&#039; =&gt; $this-&gt;data];
</div><div class='line not-covered'><span class='num'>1179</span>        echo json_encode($this-&gt;data, JSON_UNESCAPED_UNICODE |  JSON_UNESCAPED_SLASHES |  JSON_PRETTY_PRINT);
</div><div class='line not-covered'><span class='num'>1180</span>    }
</div><div class='line not-covered'><span class='num'>1181</span>}
</div><div class='line not-executable'><span class='num'>1182</span>
</div><div class='line not-executable'><span class='num'>1183</span>class OKResponse extends Response
</div><div class='line not-executable'><span class='num'>1184</span>{
</div><div class='line not-executable'><span class='num'>1185</span>    public function __construct(string $message, array $data)
</div><div class='line not-executable'><span class='num'>1186</span>    {
</div><div class='line not-executable'><span class='num'>1187</span>        return parent::__construct(200, &#039;success&#039;, $message, $data);
</div><div class='line covered'><span class='num'>1188</span>    }
</div><div class='line not-covered'><span class='num'>1189</span>}
</div><div class='line not-executable'><span class='num'>1190</span>
</div><div class='line not-executable'><span class='num'>1191</span>class CreatedResponse extends Response
</div><div class='line not-executable'><span class='num'>1192</span>{
</div><div class='line not-executable'><span class='num'>1193</span>    public function __construct(string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1194</span>    {
</div><div class='line not-executable'><span class='num'>1195</span>        return parent::__construct(201, &#039;success&#039;, $message, $data);
</div><div class='line covered'><span class='num'>1196</span>    }
</div><div class='line not-covered'><span class='num'>1197</span>}
</div><div class='line not-executable'><span class='num'>1198</span>
</div><div class='line not-executable'><span class='num'>1199</span>class BadRequestResponse extends Response
</div><div class='line not-executable'><span class='num'>1200</span>{
</div><div class='line not-executable'><span class='num'>1201</span>    public function __construct(string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1202</span>    {
</div><div class='line not-executable'><span class='num'>1203</span>        return parent::__construct(400, &#039;error&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1204</span>    }
</div><div class='line not-covered'><span class='num'>1205</span>}
</div><div class='line not-executable'><span class='num'>1206</span>
</div><div class='line not-executable'><span class='num'>1207</span>class UnauthorizedResponse extends Response
</div><div class='line not-executable'><span class='num'>1208</span>{
</div><div class='line not-executable'><span class='num'>1209</span>    public function __construct(string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1210</span>    {
</div><div class='line not-executable'><span class='num'>1211</span>        return parent::__construct(401, &#039;error&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1212</span>    }
</div><div class='line not-covered'><span class='num'>1213</span>}
</div><div class='line not-executable'><span class='num'>1214</span>
</div><div class='line not-executable'><span class='num'>1215</span>class ForbiddenResponse extends Response
</div><div class='line not-executable'><span class='num'>1216</span>{
</div><div class='line not-executable'><span class='num'>1217</span>    public function __construct(string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1218</span>    {
</div><div class='line not-executable'><span class='num'>1219</span>        return parent::__construct(403, &#039;error&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1220</span>    }
</div><div class='line not-covered'><span class='num'>1221</span>}
</div><div class='line not-executable'><span class='num'>1222</span>
</div><div class='line not-executable'><span class='num'>1223</span>class NotFoundResponse extends Response
</div><div class='line not-executable'><span class='num'>1224</span>{
</div><div class='line not-executable'><span class='num'>1225</span>    public function __construct(string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1226</span>    {
</div><div class='line not-executable'><span class='num'>1227</span>        return parent::__construct(404, &#039;error&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1228</span>    }
</div><div class='line not-covered'><span class='num'>1229</span>}
</div><div class='line not-executable'><span class='num'>1230</span>
</div><div class='line not-executable'><span class='num'>1231</span>class InternalServerErrorResponse extends Response
</div><div class='line not-executable'><span class='num'>1232</span>{
</div><div class='line not-executable'><span class='num'>1233</span>    public function __construct(string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1234</span>    {
</div><div class='line not-executable'><span class='num'>1235</span>        return parent::__construct(500, &#039;error&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1236</span>    }
</div><div class='line not-covered'><span class='num'>1237</span>}
</div><div class='line not-executable'><span class='num'>1238</span>
</div><div class='line not-executable'><span class='num'>1239</span>interface GraphControllerInterface
</div><div class='line not-executable'><span class='num'>1240</span>{
</div><div class='line not-executable'><span class='num'>1241</span>    public function getUser(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1242</span>    public function insertUser(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1243</span>    public function updateUser(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1244</span>
</div><div class='line not-executable'><span class='num'>1245</span>    public function getGraph(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1246</span>
</div><div class='line not-executable'><span class='num'>1247</span>    public function getNode(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1248</span>    public function getNodes(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1249</span>    public function insertNode(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1250</span>    public function updateNode(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1251</span>    public function deleteNode(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1252</span>
</div><div class='line not-executable'><span class='num'>1253</span>    public function getEdge(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1254</span>    public function getEdges(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1255</span>    public function insertEdge(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1256</span>    public function updateEdge(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1257</span>    public function deleteEdge(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1258</span>
</div><div class='line not-executable'><span class='num'>1259</span>    public function getStatuses(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1260</span>    public function getNodeStatus(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1261</span>    public function setNodeStatus(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1262</span>
</div><div class='line not-executable'><span class='num'>1263</span>    public function getLogs(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1264</span>}
</div><div class='line not-executable'><span class='num'>1265</span>
</div><div class='line not-executable'><span class='num'>1266</span>final class GraphControllerException extends RuntimeException
</div><div class='line not-executable'><span class='num'>1267</span>{
</div><div class='line not-executable'><span class='num'>1268</span>}
</div><div class='line not-executable'><span class='num'>1269</span>
</div><div class='line not-executable'><span class='num'>1270</span>final class GraphController implements GraphControllerInterface
</div><div class='line not-executable'><span class='num'>1271</span>{
</div><div class='line not-executable'><span class='num'>1272</span>    private GraphServiceInterface $service;
</div><div class='line not-executable'><span class='num'>1273</span>    private Logger $logger;
</div><div class='line not-executable'><span class='num'>1274</span>
</div><div class='line not-executable'><span class='num'>1275</span>    public function __construct(GraphServiceInterface $service, Logger $logger)
</div><div class='line not-executable'><span class='num'>1276</span>    {
</div><div class='line not-executable'><span class='num'>1277</span>        $this-&gt;service = $service;
</div><div class='line covered'><span class='num'>1278</span>        $this-&gt;logger = $logger;
</div><div class='line covered'><span class='num'>1279</span>    }
</div><div class='line covered'><span class='num'>1280</span>
</div><div class='line not-executable'><span class='num'>1281</span>    public function getUser(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1282</span>    {
</div><div class='line not-executable'><span class='num'>1283</span>        $data = $this-&gt;service-&gt;getUser($req-&gt;data[&#039;id&#039;]);
</div><div class='line not-covered'><span class='num'>1284</span>        $user = new User($data[&#039;id&#039;], null, new Group($data[&#039;user_group&#039;]));
</div><div class='line not-covered'><span class='num'>1285</span>        return new OKResponse(&#039;user found&#039;, $user-&gt;toArray());
</div><div class='line not-covered'><span class='num'>1286</span>    }
</div><div class='line not-covered'><span class='num'>1287</span>
</div><div class='line not-executable'><span class='num'>1288</span>    public function insertUser(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1289</span>    {
</div><div class='line not-executable'><span class='num'>1290</span>        $user = new User($req-&gt;data[&#039;id&#039;], null, $req-&gt;data[&#039;user_group&#039;]);
</div><div class='line not-covered'><span class='num'>1291</span>        $this-&gt;service-&gt;insertUser($user);
</div><div class='line not-covered'><span class='num'>1292</span>        return new OKResponse(&#039;user created&#039;, $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1293</span>    }
</div><div class='line not-covered'><span class='num'>1294</span>
</div><div class='line not-executable'><span class='num'>1295</span>    public function updateUser(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1296</span>    {
</div><div class='line not-executable'><span class='num'>1297</span>        $user = new User($req-&gt;data[&#039;id&#039;], null, $req-&gt;data[&#039;user_group&#039;]);
</div><div class='line not-covered'><span class='num'>1298</span>        $this-&gt;service-&gt;updateUser($user);
</div><div class='line not-covered'><span class='num'>1299</span>        return new CreatedResponse(&#039;user updated&#039;, $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1300</span>    }
</div><div class='line not-covered'><span class='num'>1301</span>
</div><div class='line not-executable'><span class='num'>1302</span>    public function getGraph(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1303</span>    {
</div><div class='line not-executable'><span class='num'>1304</span>        try {
</div><div class='line not-executable'><span class='num'>1305</span>            $data = $this-&gt;service-&gt;getGraph()-&gt;toArray();
</div><div class='line not-covered'><span class='num'>1306</span>            return new OKResponse(&#039;get graph&#039;, $data);
</div><div class='line not-covered'><span class='num'>1307</span>            return $resp;
</div><div class='line not-covered'><span class='num'>1308</span>        } catch (Exception $e) {
</div><div class='line not-covered'><span class='num'>1309</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1310</span>        }
</div><div class='line not-executable'><span class='num'>1311</span>
</div><div class='line not-executable'><span class='num'>1312</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1313</span>    }
</div><div class='line not-covered'><span class='num'>1314</span>
</div><div class='line not-executable'><span class='num'>1315</span>    public function getNode(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1316</span>    {
</div><div class='line not-executable'><span class='num'>1317</span>        try {
</div><div class='line not-executable'><span class='num'>1318</span>            $id = $req-&gt;getParam(&#039;id&#039;);
</div><div class='line covered'><span class='num'>1319</span>            $node = $this-&gt;service-&gt;getNode($id);
</div><div class='line covered'><span class='num'>1320</span>            $data = $node-&gt;toArray();
</div><div class='line covered'><span class='num'>1321</span>            return new OKResponse(&#039;node found&#039;, $data);
</div><div class='line covered'><span class='num'>1322</span>        } catch( Exception $e)
</div><div class='line not-covered'><span class='num'>1323</span>        {
</div><div class='line not-executable'><span class='num'>1324</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1325</span>        }
</div><div class='line not-executable'><span class='num'>1326</span>
</div><div class='line not-executable'><span class='num'>1327</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1328</span>    }
</div><div class='line not-covered'><span class='num'>1329</span>
</div><div class='line not-executable'><span class='num'>1330</span>    public function getNodes(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1331</span>    {
</div><div class='line not-executable'><span class='num'>1332</span>        try {
</div><div class='line not-executable'><span class='num'>1333</span>            $nodes = $this-&gt;service-&gt;getNodes();
</div><div class='line not-covered'><span class='num'>1334</span>            // TODO: corrigir
</div><div class='line not-executable'><span class='num'>1335</span>            return new OKResponse(&#039;nodes found&#039;, []);
</div><div class='line not-covered'><span class='num'>1336</span>            return $resp;
</div><div class='line not-covered'><span class='num'>1337</span>        } catch( Exception $e)
</div><div class='line not-covered'><span class='num'>1338</span>        {
</div><div class='line not-executable'><span class='num'>1339</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1340</span>        }
</div><div class='line not-executable'><span class='num'>1341</span>        
</div><div class='line not-executable'><span class='num'>1342</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1343</span>    }
</div><div class='line not-covered'><span class='num'>1344</span>
</div><div class='line not-executable'><span class='num'>1345</span>    public function insertNode(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1346</span>    {
</div><div class='line not-executable'><span class='num'>1347</span>        $this-&gt;logger-&gt;debug(&#039;inserting node&#039;, $req-&gt;data);
</div><div class='line covered'><span class='num'>1348</span>        try {
</div><div class='line not-executable'><span class='num'>1349</span>            $node = new Node($req-&gt;data[&#039;id&#039;], $req-&gt;data[&#039;label&#039;], $req-&gt;data[&#039;category&#039;], $req-&gt;data[&#039;type&#039;], $req-&gt;data[&#039;data&#039;]);
</div><div class='line covered'><span class='num'>1350</span>            $this-&gt;service-&gt;insertNode($node);
</div><div class='line covered'><span class='num'>1351</span>            $this-&gt;logger-&gt;info(&#039;node inserted&#039;, $req-&gt;data);
</div><div class='line covered'><span class='num'>1352</span>            return new CreatedResponse(&#039;node inserted&#039;, $req-&gt;data);
</div><div class='line covered'><span class='num'>1353</span>        } catch( GraphServiceException $e)
</div><div class='line not-covered'><span class='num'>1354</span>        {
</div><div class='line not-executable'><span class='num'>1355</span>            $this-&gt;logger-&gt;error(&#039;The service could not insert new node:&#039; . $e-&gt;getMessage());
</div><div class='line not-covered'><span class='num'>1356</span>            throw new GraphControllerException(&#039;The service could not insert new node:&#039; . $e-&gt;getMessage(), 0, $e);
</div><div class='line not-covered'><span class='num'>1357</span>        }
</div><div class='line not-executable'><span class='num'>1358</span>        return new InternalServerErrorResponse(&#039;unknow error inserting node&#039;, $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1359</span>    }
</div><div class='line not-covered'><span class='num'>1360</span>    
</div><div class='line not-executable'><span class='num'>1361</span>    public function updateNode(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1362</span>    {
</div><div class='line not-executable'><span class='num'>1363</span>        try {
</div><div class='line not-executable'><span class='num'>1364</span>            $edge = new Edge($req-&gt;data[&#039;id&#039;], $req-&gt;data[&#039;source&#039;], $req-&gt;data[&#039;target&#039;], $req-&gt;data[&#039;data&#039;]);
</div><div class='line not-covered'><span class='num'>1365</span>            $this-&gt;service-&gt;insertEdge($edge);
</div><div class='line not-covered'><span class='num'>1366</span>        } catch( Exception $e)
</div><div class='line not-covered'><span class='num'>1367</span>        {
</div><div class='line not-executable'><span class='num'>1368</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1369</span>        }
</div><div class='line not-executable'><span class='num'>1370</span>        
</div><div class='line not-executable'><span class='num'>1371</span>        return new InternalServerErrorResponse(&#039;unknow todo in updateNode&#039;, $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1372</span>    }
</div><div class='line not-covered'><span class='num'>1373</span>    
</div><div class='line not-executable'><span class='num'>1374</span>    public function deleteNode(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1375</span>    {
</div><div class='line not-executable'><span class='num'>1376</span>        try {
</div><div class='line not-executable'><span class='num'>1377</span>            $this-&gt;service-&gt;deleteEdge($req-&gt;data[&#039;id&#039;]);
</div><div class='line not-covered'><span class='num'>1378</span>        } catch( Exception $e)
</div><div class='line not-covered'><span class='num'>1379</span>        {
</div><div class='line not-executable'><span class='num'>1380</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1381</span>        }
</div><div class='line not-executable'><span class='num'>1382</span>        
</div><div class='line not-executable'><span class='num'>1383</span>        return new InternalServerErrorResponse(&#039;unknow todo in deleteNode&#039;, $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1384</span>    }
</div><div class='line not-covered'><span class='num'>1385</span>
</div><div class='line not-executable'><span class='num'>1386</span>    public function getEdge(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1387</span>    {
</div><div class='line not-executable'><span class='num'>1388</span>        try {
</div><div class='line not-executable'><span class='num'>1389</span>            $edge = $this-&gt;service-&gt;getEdge($req-&gt;data[&#039;source&#039;], $req-&gt;data[&#039;target&#039;]);
</div><div class='line not-covered'><span class='num'>1390</span>            $data = $edge-&gt;toArray();
</div><div class='line not-covered'><span class='num'>1391</span>            return new OKResponse(&#039;node found&#039;, $data);
</div><div class='line not-covered'><span class='num'>1392</span>        } catch( Exception $e)
</div><div class='line not-covered'><span class='num'>1393</span>        {
</div><div class='line not-executable'><span class='num'>1394</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1395</span>        }
</div><div class='line not-executable'><span class='num'>1396</span>        
</div><div class='line not-executable'><span class='num'>1397</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1398</span>    }
</div><div class='line not-covered'><span class='num'>1399</span>    
</div><div class='line not-executable'><span class='num'>1400</span>    public function getEdges(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1401</span>    {
</div><div class='line not-executable'><span class='num'>1402</span>        try {
</div><div class='line not-executable'><span class='num'>1403</span>            $edges = $this-&gt;service-&gt;getEdges();
</div><div class='line not-covered'><span class='num'>1404</span>            // TODO: corrigir
</div><div class='line not-executable'><span class='num'>1405</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1406</span>        } catch( Exception $e)
</div><div class='line not-covered'><span class='num'>1407</span>        {
</div><div class='line not-executable'><span class='num'>1408</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1409</span>        }
</div><div class='line not-executable'><span class='num'>1410</span>        
</div><div class='line not-executable'><span class='num'>1411</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1412</span>    }
</div><div class='line not-covered'><span class='num'>1413</span>    
</div><div class='line not-executable'><span class='num'>1414</span>    public function insertEdge(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1415</span>    {
</div><div class='line not-executable'><span class='num'>1416</span>        try {
</div><div class='line not-executable'><span class='num'>1417</span>            $edge = new Edge(null, $req-&gt;data[&#039;source&#039;], $req-&gt;data[&#039;target&#039;]);
</div><div class='line not-covered'><span class='num'>1418</span>            $this-&gt;service-&gt;insertEdge($edge);
</div><div class='line not-covered'><span class='num'>1419</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1420</span>        } catch( Exception $e)
</div><div class='line not-covered'><span class='num'>1421</span>        {
</div><div class='line not-executable'><span class='num'>1422</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1423</span>        }
</div><div class='line not-executable'><span class='num'>1424</span>        
</div><div class='line not-executable'><span class='num'>1425</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1426</span>    }
</div><div class='line not-covered'><span class='num'>1427</span>    
</div><div class='line not-executable'><span class='num'>1428</span>    public function updateEdge(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1429</span>    {
</div><div class='line not-executable'><span class='num'>1430</span>        try {
</div><div class='line not-executable'><span class='num'>1431</span>            $edge = new Edge($req-&gt;data[&#039;id&#039;], $req-&gt;data[&#039;source&#039;], $req-&gt;data[&#039;target&#039;], $req-&gt;data[&#039;data&#039;]);
</div><div class='line not-covered'><span class='num'>1432</span>            $this-&gt;service-&gt;updateEdge($edge);
</div><div class='line not-covered'><span class='num'>1433</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1434</span>        } catch( Exception $e)
</div><div class='line not-covered'><span class='num'>1435</span>        {
</div><div class='line not-executable'><span class='num'>1436</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1437</span>        }
</div><div class='line not-executable'><span class='num'>1438</span>        
</div><div class='line not-executable'><span class='num'>1439</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1440</span>    }
</div><div class='line not-covered'><span class='num'>1441</span>    
</div><div class='line not-executable'><span class='num'>1442</span>    public function deleteEdge(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1443</span>    {
</div><div class='line not-executable'><span class='num'>1444</span>        try {
</div><div class='line not-executable'><span class='num'>1445</span>            $id = $req-&gt;data[&#039;id&#039;];
</div><div class='line not-covered'><span class='num'>1446</span>            $this-&gt;service-&gt;deleteEdge($id);
</div><div class='line not-covered'><span class='num'>1447</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1448</span>        } catch( Exception $e)
</div><div class='line not-covered'><span class='num'>1449</span>        {
</div><div class='line not-executable'><span class='num'>1450</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1451</span>        }
</div><div class='line not-executable'><span class='num'>1452</span>        
</div><div class='line not-executable'><span class='num'>1453</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1454</span>    }
</div><div class='line not-covered'><span class='num'>1455</span>
</div><div class='line not-executable'><span class='num'>1456</span>    public function getStatuses(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1457</span>    {
</div><div class='line not-executable'><span class='num'>1458</span>        try {
</div><div class='line not-executable'><span class='num'>1459</span>            $statuses = $this-&gt;service-&gt;getStatuses();
</div><div class='line not-covered'><span class='num'>1460</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1461</span>            return $resp;
</div><div class='line not-covered'><span class='num'>1462</span>        } catch( Exception $e)
</div><div class='line not-covered'><span class='num'>1463</span>        {
</div><div class='line not-executable'><span class='num'>1464</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1465</span>        }
</div><div class='line not-executable'><span class='num'>1466</span>        
</div><div class='line not-executable'><span class='num'>1467</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1468</span>    }
</div><div class='line not-covered'><span class='num'>1469</span>    
</div><div class='line not-executable'><span class='num'>1470</span>    public function getNodeStatus(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1471</span>    {
</div><div class='line not-executable'><span class='num'>1472</span>        try {
</div><div class='line not-executable'><span class='num'>1473</span>            $status = $this-&gt;service-&gt;getNodeStatus($req-&gt;data[&#039;id&#039;]);
</div><div class='line not-covered'><span class='num'>1474</span>            $data = $status-&gt;toArray();
</div><div class='line not-covered'><span class='num'>1475</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1476</span>        } catch( Exception $e)
</div><div class='line not-covered'><span class='num'>1477</span>        {
</div><div class='line not-executable'><span class='num'>1478</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1479</span>        }
</div><div class='line not-executable'><span class='num'>1480</span>        
</div><div class='line not-executable'><span class='num'>1481</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1482</span>    }
</div><div class='line not-covered'><span class='num'>1483</span>    
</div><div class='line not-executable'><span class='num'>1484</span>    public function setNodeStatus(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1485</span>    {
</div><div class='line not-executable'><span class='num'>1486</span>        try {
</div><div class='line not-executable'><span class='num'>1487</span>            $status = new NodeStatus($req-&gt;data[&#039;node_id&#039;], $req-&gt;data[&#039;status&#039;]);
</div><div class='line not-covered'><span class='num'>1488</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1489</span>        } catch( Exception $e)
</div><div class='line not-covered'><span class='num'>1490</span>        {
</div><div class='line not-executable'><span class='num'>1491</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1492</span>        }
</div><div class='line not-executable'><span class='num'>1493</span>        
</div><div class='line not-executable'><span class='num'>1494</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1495</span>    }
</div><div class='line not-covered'><span class='num'>1496</span>
</div><div class='line not-executable'><span class='num'>1497</span>    public function getLogs(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1498</span>    {
</div><div class='line not-executable'><span class='num'>1499</span>        try {
</div><div class='line not-executable'><span class='num'>1500</span>            $logs = $this-&gt;service-&gt;getLogs($req-&gt;getParam(&#039;limit&#039;));
</div><div class='line not-covered'><span class='num'>1501</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1502</span>        } catch( Exception $e)
</div><div class='line not-covered'><span class='num'>1503</span>        {
</div><div class='line not-executable'><span class='num'>1504</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1505</span>        }
</div><div class='line not-executable'><span class='num'>1506</span>        
</div><div class='line not-executable'><span class='num'>1507</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1508</span>    }
</div><div class='line not-covered'><span class='num'>1509</span>}
</div><div class='line not-executable'><span class='num'>1510</span>
</div><div class='line not-executable'><span class='num'>1511</span>final class RequestRouter
</div><div class='line not-executable'><span class='num'>1512</span>{
</div><div class='line not-executable'><span class='num'>1513</span>    private $routes = [
</div><div class='line not-executable'><span class='num'>1514</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getGraph&#039;, &#039;class_method&#039; =&gt; &#039;getGraph&#039;],
</div><div class='line not-executable'><span class='num'>1515</span>        
</div><div class='line not-executable'><span class='num'>1516</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getNode&#039;, &#039;class_method&#039; =&gt; &#039;getNode&#039;],
</div><div class='line not-executable'><span class='num'>1517</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getNodes&#039;, &#039;class_method&#039; =&gt; &#039;getNodes&#039;],
</div><div class='line not-executable'><span class='num'>1518</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/insertNode&#039;, &#039;class_method&#039; =&gt; &#039;insertNode&#039;],
</div><div class='line not-executable'><span class='num'>1519</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/updateNode&#039;, &#039;class_method&#039; =&gt; &#039;updateNode&#039;],
</div><div class='line not-executable'><span class='num'>1520</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/deleteNode&#039;, &#039;class_method&#039; =&gt; &#039;deleteNode&#039;],
</div><div class='line not-executable'><span class='num'>1521</span>
</div><div class='line not-executable'><span class='num'>1522</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getEdge&#039;, &#039;class_method&#039; =&gt; &#039;getEdge&#039;],
</div><div class='line not-executable'><span class='num'>1523</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getEdges&#039;, &#039;class_method&#039; =&gt; &#039;getEdges&#039;],
</div><div class='line not-executable'><span class='num'>1524</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/insertEdge&#039;, &#039;class_method&#039; =&gt; &#039;insertEdge&#039;],
</div><div class='line not-executable'><span class='num'>1525</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/updateEdge&#039;, &#039;class_method&#039; =&gt; &#039;updateEdge&#039;],
</div><div class='line not-executable'><span class='num'>1526</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/deleteEdge&#039;, &#039;class_method&#039; =&gt; &#039;deleteEdge&#039;],
</div><div class='line not-executable'><span class='num'>1527</span>
</div><div class='line not-executable'><span class='num'>1528</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getStatuses&#039;, &#039;class_method&#039; =&gt; &#039;getStatuses&#039;],
</div><div class='line not-executable'><span class='num'>1529</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getNodeStatus&#039;, &#039;class_method&#039; =&gt; &#039;getNodeStatus&#039;],
</div><div class='line not-executable'><span class='num'>1530</span>
</div><div class='line not-executable'><span class='num'>1531</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getLogs&#039;, &#039;class_method&#039; =&gt; &#039;getLogs&#039;],
</div><div class='line not-executable'><span class='num'>1532</span>
</div><div class='line not-executable'><span class='num'>1533</span>        ];
</div><div class='line not-executable'><span class='num'>1534</span>
</div><div class='line not-executable'><span class='num'>1535</span>    public GraphController $controller;
</div><div class='line not-executable'><span class='num'>1536</span>    
</div><div class='line not-executable'><span class='num'>1537</span>    public function __construct(GraphController $controller)
</div><div class='line not-executable'><span class='num'>1538</span>    {
</div><div class='line not-executable'><span class='num'>1539</span>        $this-&gt;controller = $controller;
</div><div class='line not-covered'><span class='num'>1540</span>    }
</div><div class='line not-covered'><span class='num'>1541</span>
</div><div class='line not-executable'><span class='num'>1542</span>    public function handle(): void
</div><div class='line not-executable'><span class='num'>1543</span>    {
</div><div class='line not-executable'><span class='num'>1544</span>        $method = $_SERVER[&#039;REQUEST_METHOD&#039;];
</div><div class='line not-covered'><span class='num'>1545</span>
</div><div class='line not-executable'><span class='num'>1546</span>        $scriptName = $_SERVER[&#039;SCRIPT_NAME&#039;];
</div><div class='line not-covered'><span class='num'>1547</span>        $requestUri = $_SERVER[&#039;REQUEST_URI&#039;];
</div><div class='line not-covered'><span class='num'>1548</span>        $requestUri = strtok($requestUri, &#039;?&#039;);
</div><div class='line not-covered'><span class='num'>1549</span>        
</div><div class='line not-executable'><span class='num'>1550</span>        $path = str_replace($scriptName, &#039;&#039;, $requestUri);
</div><div class='line not-covered'><span class='num'>1551</span>        
</div><div class='line not-executable'><span class='num'>1552</span>        $req = new Request();
</div><div class='line not-covered'><span class='num'>1553</span>
</div><div class='line not-executable'><span class='num'>1554</span>        foreach($this-&gt;routes as $route)
</div><div class='line not-covered'><span class='num'>1555</span>        {
</div><div class='line not-executable'><span class='num'>1556</span>            if ($route[&#039;method&#039;] == $method &amp;&amp; $route[&#039;path&#039;] == $path)
</div><div class='line not-covered'><span class='num'>1557</span>            {
</div><div class='line not-executable'><span class='num'>1558</span>                $method = $route[&#039;class_method&#039;];
</div><div class='line not-covered'><span class='num'>1559</span>                $resp = $this-&gt;controller-&gt;$method($req);
</div><div class='line not-covered'><span class='num'>1560</span>                print_r($resp);
</div><div class='line not-covered'><span class='num'>1561</span>                exit();
</div><div class='line not-covered'><span class='num'>1562</span>            }
</div><div class='line not-executable'><span class='num'>1563</span>        }
</div><div class='line not-executable'><span class='num'>1564</span>    }
</div><div class='line not-covered'><span class='num'>1565</span>}
</div><div class='line not-executable'><span class='num'>1566</span>
</div><div class='line not-executable'><span class='num'>1567</span>
</div></body></html><html><head><meta charset='UTF-8'><style>
body { font-family: monospace; font-size: 12px; background: #222; color: #ddd; margin: 0; }
.covered { background: #1a4d1a; }
.not-covered { background: #4d1a1a; }
.not-executable { background: #2a2a2a; color: #666; }
.line { padding: 2px 10px; white-space: pre; border-left: 3px solid transparent; }
.covered { border-left-color: #0f0; }
.not-covered { border-left-color: #f00; }
.num { color: #666; width: 50px; display: inline-block; text-align: right; margin-right: 10px; }
h2 { background: #333; padding: 10px; margin: 20px 0 0 0; position: sticky; top: 0; }
</style></head><body><h2>/home/tarcisio/projects/graph/tests.php - 77.05% (47/61)</h2><div class='line not-executable'><span class='num'>1</span>&lt;?php
</div><div class='line not-executable'><span class='num'>2</span>
</div><div class='line not-executable'><span class='num'>3</span>declare(strict_types=1);
</div><div class='line not-executable'><span class='num'>4</span>
</div><div class='line not-executable'><span class='num'>5</span>require_once __DIR__ . &#039;/graph.php&#039;;
</div><div class='line not-executable'><span class='num'>6</span>
</div><div class='line not-executable'><span class='num'>7</span>ini_set(&#039;xdebug.mode&#039;, &#039;1&#039;);
</div><div class='line not-executable'><span class='num'>8</span>xdebug_start_code_coverage(XDEBUG_CC_UNUSED | XDEBUG_CC_DEAD_CODE);
</div><div class='line not-executable'><span class='num'>9</span>
</div><div class='line not-executable'><span class='num'>10</span>function array_diff_recursive($array1, $array2) {
</div><div class='line covered'><span class='num'>11</span>    $diff = [];
</div><div class='line not-executable'><span class='num'>12</span>    
</div><div class='line covered'><span class='num'>13</span>    foreach ($array1 as $key =&gt; $value) {
</div><div class='line covered'><span class='num'>14</span>        if (!array_key_exists($key, $array2)) {
</div><div class='line not-covered'><span class='num'>15</span>            $diff[$key] = $value;
</div><div class='line covered'><span class='num'>16</span>        } elseif (is_array($value)) {
</div><div class='line covered'><span class='num'>17</span>            if (!is_array($array2[$key])) {
</div><div class='line not-covered'><span class='num'>18</span>                $diff[$key] = $value;
</div><div class='line not-executable'><span class='num'>19</span>            } else {
</div><div class='line covered'><span class='num'>20</span>                $recursiveDiff = array_diff_recursive($value, $array2[$key]);
</div><div class='line covered'><span class='num'>21</span>                if (count($recursiveDiff)) {
</div><div class='line not-covered'><span class='num'>22</span>                    $diff[$key] = $recursiveDiff;
</div><div class='line not-executable'><span class='num'>23</span>                }
</div><div class='line not-executable'><span class='num'>24</span>            }
</div><div class='line covered'><span class='num'>25</span>        } elseif ($value !== $array2[$key]) {
</div><div class='line not-covered'><span class='num'>26</span>            $diff[$key] = $value;
</div><div class='line not-executable'><span class='num'>27</span>        }
</div><div class='line not-executable'><span class='num'>28</span>    }
</div><div class='line not-executable'><span class='num'>29</span>    
</div><div class='line covered'><span class='num'>30</span>    return $diff;
</div><div class='line not-covered'><span class='num'>31</span>}
</div><div class='line not-executable'><span class='num'>32</span>
</div><div class='line not-executable'><span class='num'>33</span>function get_test_graph_controller()
</div><div class='line not-executable'><span class='num'>34</span>{
</div><div class='line covered'><span class='num'>35</span>    GraphContext::$user = new User(&#039;test_user&#039;, &#039;127.0.0.1&#039;, new Group(&#039;contributor&#039;));
</div><div class='line covered'><span class='num'>36</span>    $pdo = GraphDatabase::createConnection(&#039;sqlite::memory:&#039;);
</div><div class='line covered'><span class='num'>37</span>    $databaseLogger = new Logger(&#039;database.log&#039;);
</div><div class='line not-executable'><span class='num'>38</span>
</div><div class='line covered'><span class='num'>39</span>    $graphDb = new GraphDatabase($pdo, $databaseLogger);
</div><div class='line not-executable'><span class='num'>40</span>
</div><div class='line covered'><span class='num'>41</span>    $serviceLogger = new Logger(&#039;service.log&#039;);
</div><div class='line covered'><span class='num'>42</span>    $graphService = new GraphService($graphDb, $serviceLogger);
</div><div class='line not-executable'><span class='num'>43</span>
</div><div class='line covered'><span class='num'>44</span>    $controllerLogger = new Logger(&#039;controller.log&#039;);
</div><div class='line covered'><span class='num'>45</span>    $graphController = new GraphController($graphService, $controllerLogger);
</div><div class='line not-executable'><span class='num'>46</span>    
</div><div class='line covered'><span class='num'>47</span>    return $graphController;
</div><div class='line not-covered'><span class='num'>48</span>}
</div><div class='line not-executable'><span class='num'>49</span>
</div><div class='line not-executable'><span class='num'>50</span>function test_node_good_path()
</div><div class='line not-executable'><span class='num'>51</span>{
</div><div class='line covered'><span class='num'>52</span>    $graphController = get_test_graph_controller();
</div><div class='line covered'><span class='num'>53</span>    $insertNodeReq = new Request();
</div><div class='line covered'><span class='num'>54</span>    $insertNodeReq-&gt;data = [&#039;id&#039; =&gt; &#039;node1&#039;, &#039;label&#039; =&gt; &#039;node1&#039;, &#039;category&#039; =&gt; &#039;business&#039;, &#039;type&#039; =&gt; &#039;server&#039;, &#039;data&#039; =&gt; [&#039;info&#039; =&gt; &#039;first node&#039;]];
</div><div class='line covered'><span class='num'>55</span>    $resp = $graphController-&gt;insertNode($insertNodeReq);
</div><div class='line not-executable'><span class='num'>56</span>    
</div><div class='line covered'><span class='num'>57</span>    $expected = [
</div><div class='line not-executable'><span class='num'>58</span>        &#039;id&#039;       =&gt; &#039;node1&#039;,
</div><div class='line not-executable'><span class='num'>59</span>        &#039;label&#039;    =&gt; &#039;node1&#039;,
</div><div class='line not-executable'><span class='num'>60</span>        &#039;category&#039; =&gt; &#039;business&#039;,
</div><div class='line not-executable'><span class='num'>61</span>        &#039;type&#039; =&gt; &#039;server&#039;,
</div><div class='line not-executable'><span class='num'>62</span>        &#039;data&#039; =&gt; [
</div><div class='line not-executable'><span class='num'>63</span>                &#039;info&#039; =&gt; &#039;first node&#039;
</div><div class='line not-executable'><span class='num'>64</span>        ]
</div><div class='line not-executable'><span class='num'>65</span>    ];
</div><div class='line not-executable'><span class='num'>66</span>
</div><div class='line covered'><span class='num'>67</span>    if($resp-&gt;code != 201) {
</div><div class='line not-covered'><span class='num'>68</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>69</span>    }
</div><div class='line not-executable'><span class='num'>70</span>
</div><div class='line covered'><span class='num'>71</span>    if($resp-&gt;status != &#039;success&#039;) {
</div><div class='line not-covered'><span class='num'>72</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>73</span>    }
</div><div class='line not-executable'><span class='num'>74</span>
</div><div class='line covered'><span class='num'>75</span>    if ($resp-&gt;message != &#039;node inserted&#039;) {
</div><div class='line not-covered'><span class='num'>76</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>77</span>    }
</div><div class='line not-executable'><span class='num'>78</span>
</div><div class='line covered'><span class='num'>79</span>    $diff = array_diff_recursive($resp-&gt;data, $expected);
</div><div class='line covered'><span class='num'>80</span>    if (! empty($diff)) {
</div><div class='line not-covered'><span class='num'>81</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>82</span>    }
</div><div class='line not-executable'><span class='num'>83</span>
</div><div class='line covered'><span class='num'>84</span>    $_GET[&#039;id&#039;] = &#039;node1&#039;;
</div><div class='line covered'><span class='num'>85</span>    $req = new Request();
</div><div class='line covered'><span class='num'>86</span>    $resp = $graphController-&gt;getNode($req);
</div><div class='line not-executable'><span class='num'>87</span>
</div><div class='line covered'><span class='num'>88</span>    if ($resp-&gt;code != 200) {
</div><div class='line not-covered'><span class='num'>89</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>90</span>    }
</div><div class='line not-executable'><span class='num'>91</span>
</div><div class='line covered'><span class='num'>92</span>    if($resp-&gt;status != &#039;success&#039;) {
</div><div class='line not-covered'><span class='num'>93</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>94</span>    }
</div><div class='line not-executable'><span class='num'>95</span>
</div><div class='line covered'><span class='num'>96</span>    if ($resp-&gt;message != &#039;node found&#039;) {
</div><div class='line not-covered'><span class='num'>97</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>98</span>    }
</div><div class='line not-executable'><span class='num'>99</span>
</div><div class='line covered'><span class='num'>100</span>    $expected = [
</div><div class='line not-executable'><span class='num'>101</span>        &#039;info&#039;     =&gt; &#039;first node&#039;,
</div><div class='line not-executable'><span class='num'>102</span>        &#039;id&#039;       =&gt; &#039;node1&#039;,
</div><div class='line not-executable'><span class='num'>103</span>        &#039;label&#039;    =&gt; &#039;node1&#039;,
</div><div class='line not-executable'><span class='num'>104</span>        &#039;category&#039; =&gt; &#039;business&#039;,
</div><div class='line not-executable'><span class='num'>105</span>        &#039;type&#039;     =&gt; &#039;server&#039;,
</div><div class='line not-executable'><span class='num'>106</span>    ];
</div><div class='line not-executable'><span class='num'>107</span>
</div><div class='line covered'><span class='num'>108</span>    $diff = array_diff_recursive($resp-&gt;data[&#039;data&#039;], $expected);
</div><div class='line covered'><span class='num'>109</span>    if (! empty($diff)) {
</div><div class='line not-covered'><span class='num'>110</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>111</span>    }
</div><div class='line not-executable'><span class='num'>112</span>    
</div><div class='line covered'><span class='num'>113</span>    $req = new Request();
</div><div class='line covered'><span class='num'>114</span>    $req-&gt;data = [
</div><div class='line not-executable'><span class='num'>115</span>        &#039;id&#039;       =&gt; &#039;node1&#039;,
</div><div class='line not-executable'><span class='num'>116</span>        &#039;label&#039;    =&gt; &#039;node1&#039;,
</div><div class='line not-executable'><span class='num'>117</span>        &#039;category&#039; =&gt; &#039;business&#039;,
</div><div class='line not-executable'><span class='num'>118</span>        &#039;type&#039; =&gt; &#039;server&#039;,
</div><div class='line not-executable'><span class='num'>119</span>        &#039;data&#039; =&gt; [
</div><div class='line not-executable'><span class='num'>120</span>                &#039;info&#039; =&gt; &#039;first node updated&#039;
</div><div class='line not-executable'><span class='num'>121</span>        ]
</div><div class='line not-executable'><span class='num'>122</span>    ];
</div><div class='line covered'><span class='num'>123</span>    $resp = $graphController-&gt;updateNode($req);
</div><div class='line covered'><span class='num'>124</span>    print_r($resp);
</div><div class='line covered'><span class='num'>125</span>}
</div><div class='line not-executable'><span class='num'>126</span>
</div><div class='line not-executable'><span class='num'>127</span>function tests() {
</div><div class='line covered'><span class='num'>128</span>    test_node_good_path();
</div><div class='line covered'><span class='num'>129</span>    echo &quot;fim&quot;;
</div><div class='line covered'><span class='num'>130</span>}
</div><div class='line not-executable'><span class='num'>131</span>
</div><div class='line covered'><span class='num'>132</span>tests();
</div><div class='line not-executable'><span class='num'>133</span>
</div><div class='line covered'><span class='num'>134</span>$coverage = xdebug_get_code_coverage();
</div><div class='line not-executable'><span class='num'>135</span>xdebug_stop_code_coverage();
</div><div class='line not-executable'><span class='num'>136</span>
</div><div class='line not-executable'><span class='num'>137</span>// Salvar em arquivo
</div><div class='line not-executable'><span class='num'>138</span>file_put_contents(&#039;coverage.json&#039;, json_encode($coverage, JSON_PRETTY_PRINT));
</div><div class='line not-executable'><span class='num'>139</span>
</div><div class='line not-executable'><span class='num'>140</span>echo &#039;fim&#039;;</div><h2>/home/tarcisio/projects/graph/graph.php - 30.66% (195/636)</h2><div class='line not-executable'><span class='num'>1</span>&lt;?php
</div><div class='line not-executable'><span class='num'>2</span>
</div><div class='line not-executable'><span class='num'>3</span>declare(strict_types=1);
</div><div class='line not-executable'><span class='num'>4</span>
</div><div class='line not-executable'><span class='num'>5</span>final class User
</div><div class='line not-executable'><span class='num'>6</span>{
</div><div class='line not-executable'><span class='num'>7</span>    public string $id;
</div><div class='line not-executable'><span class='num'>8</span>    public ?string $ipAddress;
</div><div class='line not-executable'><span class='num'>9</span>    public Group $group;
</div><div class='line not-executable'><span class='num'>10</span>
</div><div class='line not-executable'><span class='num'>11</span>    public function __construct(string $id, ?string $ipAddress, Group $group)
</div><div class='line not-executable'><span class='num'>12</span>    {
</div><div class='line covered'><span class='num'>13</span>        $this-&gt;id = $id;
</div><div class='line covered'><span class='num'>14</span>        $this-&gt;ipAddress = $ipAddress;
</div><div class='line covered'><span class='num'>15</span>        $this-&gt;group = $group;
</div><div class='line covered'><span class='num'>16</span>    }
</div><div class='line not-executable'><span class='num'>17</span>
</div><div class='line not-executable'><span class='num'>18</span>    public function toArray(): array
</div><div class='line not-executable'><span class='num'>19</span>    {
</div><div class='line not-executable'><span class='num'>20</span>        return [
</div><div class='line not-covered'><span class='num'>21</span>            &#039;id&#039; =&gt; $this-&gt;id,
</div><div class='line not-executable'><span class='num'>22</span>            &#039;group&#039; =&gt; [
</div><div class='line not-covered'><span class='num'>23</span>                &#039;id&#039; =&gt; $this-&gt;group-&gt;id,
</div><div class='line not-executable'><span class='num'>24</span>            ],
</div><div class='line not-executable'><span class='num'>25</span>        ];
</div><div class='line not-covered'><span class='num'>26</span>    }
</div><div class='line not-executable'><span class='num'>27</span>}
</div><div class='line not-executable'><span class='num'>28</span>
</div><div class='line not-executable'><span class='num'>29</span>final class Group
</div><div class='line not-executable'><span class='num'>30</span>{
</div><div class='line not-executable'><span class='num'>31</span>    private const ALLOWED_GROUPS = [&#039;anonymous&#039;, &#039;consumer&#039;, &#039;contributor&#039;, &#039;admin&#039;];
</div><div class='line not-executable'><span class='num'>32</span>    
</div><div class='line not-executable'><span class='num'>33</span>    public string $id;
</div><div class='line not-executable'><span class='num'>34</span>    
</div><div class='line not-executable'><span class='num'>35</span>    public function __construct(string $id)
</div><div class='line not-executable'><span class='num'>36</span>    {
</div><div class='line covered'><span class='num'>37</span>        if (!in_array($id, self::ALLOWED_GROUPS, true)) {
</div><div class='line not-covered'><span class='num'>38</span>            throw new InvalidArgumentException(&quot;Invalid user group: {$id}&quot;);
</div><div class='line not-executable'><span class='num'>39</span>        }
</div><div class='line covered'><span class='num'>40</span>        $this-&gt;id  = $id;
</div><div class='line covered'><span class='num'>41</span>    }
</div><div class='line not-executable'><span class='num'>42</span>}
</div><div class='line not-executable'><span class='num'>43</span>
</div><div class='line not-executable'><span class='num'>44</span>final class Graph
</div><div class='line not-executable'><span class='num'>45</span>{
</div><div class='line not-executable'><span class='num'>46</span>    public array $nodes = [];
</div><div class='line not-executable'><span class='num'>47</span>    public array $edges = [];
</div><div class='line not-executable'><span class='num'>48</span>    public array $data  = [];
</div><div class='line not-executable'><span class='num'>49</span>    public array $layout = [];
</div><div class='line not-executable'><span class='num'>50</span>    public array $styles = [];
</div><div class='line not-executable'><span class='num'>51</span>
</div><div class='line not-executable'><span class='num'>52</span>    public function __construct(array $nodes, array $edges)
</div><div class='line not-executable'><span class='num'>53</span>    {
</div><div class='line not-covered'><span class='num'>54</span>        $this-&gt;nodes = $nodes;
</div><div class='line not-covered'><span class='num'>55</span>        $this-&gt;edges = $edges;
</div><div class='line not-covered'><span class='num'>56</span>    }
</div><div class='line not-executable'><span class='num'>57</span>
</div><div class='line not-executable'><span class='num'>58</span>    public function toArray(): array
</div><div class='line not-executable'><span class='num'>59</span>    {
</div><div class='line not-executable'><span class='num'>60</span>        return [
</div><div class='line not-covered'><span class='num'>61</span>            &#039;nodes&#039; =&gt; $this-&gt;nodes,
</div><div class='line not-covered'><span class='num'>62</span>            &#039;edges&#039; =&gt; $this-&gt;edges,
</div><div class='line not-covered'><span class='num'>63</span>            &#039;data&#039; =&gt; $this-&gt;data,
</div><div class='line not-covered'><span class='num'>64</span>            &#039;layout&#039; =&gt; $this-&gt;layout,
</div><div class='line not-covered'><span class='num'>65</span>            &#039;styles&#039; =&gt; $this-&gt;styles,
</div><div class='line not-executable'><span class='num'>66</span>        ];
</div><div class='line not-covered'><span class='num'>67</span>    }
</div><div class='line not-executable'><span class='num'>68</span>}
</div><div class='line not-executable'><span class='num'>69</span>
</div><div class='line not-executable'><span class='num'>70</span>final class Node
</div><div class='line not-executable'><span class='num'>71</span>{
</div><div class='line not-executable'><span class='num'>72</span>    private const ALLOWED_CATEGORIES  = [&#039;business&#039;, &#039;application&#039;, &#039;infrastructure&#039;];
</div><div class='line not-executable'><span class='num'>73</span>    private const ALLOWED_TYPES       = [&#039;server&#039;, &#039;database&#039;, &#039;application&#039;, &#039;network&#039;];
</div><div class='line not-executable'><span class='num'>74</span>    private const ID_VALIDATION_REGEX = &#039;/^[a-zA-Z0-9\-_]+$/&#039;;
</div><div class='line not-executable'><span class='num'>75</span>    private const LABEL_MAX_LENGTH    = 20;
</div><div class='line not-executable'><span class='num'>76</span>    
</div><div class='line not-executable'><span class='num'>77</span>    public string $id;
</div><div class='line not-executable'><span class='num'>78</span>    public string $label;
</div><div class='line not-executable'><span class='num'>79</span>    public string $category;
</div><div class='line not-executable'><span class='num'>80</span>    public string $type;
</div><div class='line not-executable'><span class='num'>81</span>
</div><div class='line not-executable'><span class='num'>82</span>    public array $data = [];
</div><div class='line not-executable'><span class='num'>83</span>
</div><div class='line not-executable'><span class='num'>84</span>    public function __construct(string $id, string $label, string $category, string $type, array $data)
</div><div class='line not-executable'><span class='num'>85</span>    {
</div><div class='line covered'><span class='num'>86</span>        $this-&gt;validate($id, $label, $category, $type);
</div><div class='line covered'><span class='num'>87</span>        $this-&gt;id       = $id;
</div><div class='line covered'><span class='num'>88</span>        $this-&gt;label    = $label;
</div><div class='line covered'><span class='num'>89</span>        $this-&gt;category = $category;
</div><div class='line covered'><span class='num'>90</span>        $this-&gt;type     = $type;
</div><div class='line covered'><span class='num'>91</span>        $this-&gt;data     = $data;
</div><div class='line covered'><span class='num'>92</span>    }
</div><div class='line not-executable'><span class='num'>93</span>
</div><div class='line not-executable'><span class='num'>94</span>    private function validate(string $id, string $label, string $category, string $type): void
</div><div class='line not-executable'><span class='num'>95</span>    {
</div><div class='line covered'><span class='num'>96</span>        if (!preg_match(self::ID_VALIDATION_REGEX, $id)) {
</div><div class='line not-covered'><span class='num'>97</span>            throw new InvalidArgumentException(&quot;Invalid node ID: {$id}&quot;);
</div><div class='line not-executable'><span class='num'>98</span>        }
</div><div class='line not-executable'><span class='num'>99</span>
</div><div class='line covered'><span class='num'>100</span>        if (strlen($label) &gt; self::LABEL_MAX_LENGTH) {
</div><div class='line not-covered'><span class='num'>101</span>            throw new InvalidArgumentException(&quot;Node label exceeds maximum length of &quot; . self::LABEL_MAX_LENGTH);
</div><div class='line not-executable'><span class='num'>102</span>        }
</div><div class='line not-executable'><span class='num'>103</span>
</div><div class='line covered'><span class='num'>104</span>        if (!in_array($category, self::ALLOWED_CATEGORIES, true)) {
</div><div class='line not-covered'><span class='num'>105</span>            throw new InvalidArgumentException(&quot;Invalid node category: {$category}&quot;);
</div><div class='line not-executable'><span class='num'>106</span>        }
</div><div class='line not-executable'><span class='num'>107</span>
</div><div class='line covered'><span class='num'>108</span>        if (!in_array($type, self::ALLOWED_TYPES, true)) {
</div><div class='line not-covered'><span class='num'>109</span>            throw new InvalidArgumentException(&quot;Invalid node type: {$type}&quot;);
</div><div class='line not-executable'><span class='num'>110</span>        }
</div><div class='line covered'><span class='num'>111</span>    }
</div><div class='line not-executable'><span class='num'>112</span>
</div><div class='line not-executable'><span class='num'>113</span>    public function toArray(): array
</div><div class='line not-executable'><span class='num'>114</span>    {
</div><div class='line not-executable'><span class='num'>115</span>        return [
</div><div class='line covered'><span class='num'>116</span>            &#039;id&#039;       =&gt; $this-&gt;id,
</div><div class='line covered'><span class='num'>117</span>            &#039;label&#039;    =&gt; $this-&gt;label,
</div><div class='line covered'><span class='num'>118</span>            &#039;category&#039; =&gt; $this-&gt;category,
</div><div class='line covered'><span class='num'>119</span>            &#039;type&#039;     =&gt; $this-&gt;type,
</div><div class='line covered'><span class='num'>120</span>            &#039;data&#039;     =&gt; $this-&gt;data
</div><div class='line not-executable'><span class='num'>121</span>        ];
</div><div class='line not-covered'><span class='num'>122</span>    }
</div><div class='line not-executable'><span class='num'>123</span>}
</div><div class='line not-executable'><span class='num'>124</span>
</div><div class='line not-executable'><span class='num'>125</span>final class NodeStatus
</div><div class='line not-executable'><span class='num'>126</span>{
</div><div class='line not-executable'><span class='num'>127</span>    private const ALLOWED_NODE_STATUSES = [&#039;unknown&#039;, &#039;healthy&#039;, &#039;unhealthy&#039;, &#039;maintenance&#039;];
</div><div class='line not-executable'><span class='num'>128</span>
</div><div class='line not-executable'><span class='num'>129</span>    public string $nodeId;
</div><div class='line not-executable'><span class='num'>130</span>    public string $status;
</div><div class='line not-executable'><span class='num'>131</span>
</div><div class='line not-executable'><span class='num'>132</span>    public function __construct(string $nodeId, string $status)
</div><div class='line not-executable'><span class='num'>133</span>    {
</div><div class='line not-covered'><span class='num'>134</span>        if (!in_array($status, self::ALLOWED_NODE_STATUSES, true)) {
</div><div class='line not-covered'><span class='num'>135</span>            throw new InvalidArgumentException(&quot;Invalid node status: {$status}&quot;);
</div><div class='line not-executable'><span class='num'>136</span>        }
</div><div class='line not-covered'><span class='num'>137</span>        $this-&gt;nodeId = $nodeId;
</div><div class='line not-covered'><span class='num'>138</span>        $this-&gt;status = $status;
</div><div class='line not-covered'><span class='num'>139</span>    }
</div><div class='line not-executable'><span class='num'>140</span>
</div><div class='line not-executable'><span class='num'>141</span>    public function toArray(): array
</div><div class='line not-executable'><span class='num'>142</span>    {
</div><div class='line not-executable'><span class='num'>143</span>        return [
</div><div class='line not-covered'><span class='num'>144</span>            &#039;node_id&#039; =&gt; $this-&gt;nodeId,
</div><div class='line not-covered'><span class='num'>145</span>            &#039;status&#039;  =&gt; $this-&gt;status,
</div><div class='line not-executable'><span class='num'>146</span>        ];
</div><div class='line not-covered'><span class='num'>147</span>    }
</div><div class='line not-executable'><span class='num'>148</span>}
</div><div class='line not-executable'><span class='num'>149</span>
</div><div class='line not-executable'><span class='num'>150</span>final class NodeStatuses
</div><div class='line not-executable'><span class='num'>151</span>{
</div><div class='line not-executable'><span class='num'>152</span>    public array $statuses = [];
</div><div class='line not-executable'><span class='num'>153</span>
</div><div class='line not-executable'><span class='num'>154</span>    public function addStatus(NodeStatus $status): void
</div><div class='line not-executable'><span class='num'>155</span>    {
</div><div class='line not-covered'><span class='num'>156</span>        $this-&gt;statuses[] = $status;
</div><div class='line not-covered'><span class='num'>157</span>    }
</div><div class='line not-executable'><span class='num'>158</span>}
</div><div class='line not-executable'><span class='num'>159</span>
</div><div class='line not-executable'><span class='num'>160</span>final class Nodes
</div><div class='line not-executable'><span class='num'>161</span>{
</div><div class='line not-executable'><span class='num'>162</span>    public array $nodes = [];
</div><div class='line not-executable'><span class='num'>163</span>
</div><div class='line not-executable'><span class='num'>164</span>    public function addNode(Node $node): void
</div><div class='line not-executable'><span class='num'>165</span>    {
</div><div class='line not-covered'><span class='num'>166</span>        $this-&gt;nodes[] = $node;
</div><div class='line not-covered'><span class='num'>167</span>    }
</div><div class='line not-executable'><span class='num'>168</span>}
</div><div class='line not-executable'><span class='num'>169</span>
</div><div class='line not-executable'><span class='num'>170</span>final class Edge
</div><div class='line not-executable'><span class='num'>171</span>{
</div><div class='line not-executable'><span class='num'>172</span>    public ?string $id;
</div><div class='line not-executable'><span class='num'>173</span>    public string $source;
</div><div class='line not-executable'><span class='num'>174</span>    public string $target;
</div><div class='line not-executable'><span class='num'>175</span>    public array $data;
</div><div class='line not-executable'><span class='num'>176</span>
</div><div class='line not-executable'><span class='num'>177</span>    public function __construct(?string $id = null, string $source, string $target, array $data = [])
</div><div class='line not-executable'><span class='num'>178</span>    {
</div><div class='line covered'><span class='num'>179</span>        $this-&gt;id     = $id;
</div><div class='line covered'><span class='num'>180</span>        $this-&gt;source = $source;
</div><div class='line covered'><span class='num'>181</span>        $this-&gt;target = $target;
</div><div class='line covered'><span class='num'>182</span>        $this-&gt;data   = $data;
</div><div class='line covered'><span class='num'>183</span>    }
</div><div class='line not-executable'><span class='num'>184</span>
</div><div class='line not-executable'><span class='num'>185</span>    public function toArray(): array
</div><div class='line not-executable'><span class='num'>186</span>    {
</div><div class='line not-executable'><span class='num'>187</span>        return [
</div><div class='line covered'><span class='num'>188</span>            &#039;id&#039;     =&gt; $this-&gt;id,
</div><div class='line covered'><span class='num'>189</span>            &#039;source&#039; =&gt; $this-&gt;source,
</div><div class='line covered'><span class='num'>190</span>            &#039;target&#039; =&gt; $this-&gt;target,
</div><div class='line covered'><span class='num'>191</span>            &#039;data&#039;   =&gt; $this-&gt;data
</div><div class='line not-executable'><span class='num'>192</span>        ];
</div><div class='line not-covered'><span class='num'>193</span>    }
</div><div class='line not-executable'><span class='num'>194</span>}
</div><div class='line not-executable'><span class='num'>195</span>
</div><div class='line not-executable'><span class='num'>196</span>final class Edges
</div><div class='line not-executable'><span class='num'>197</span>{
</div><div class='line not-executable'><span class='num'>198</span>    public array $edges = [];
</div><div class='line not-executable'><span class='num'>199</span>    public function addEdge(Edge $edge): void
</div><div class='line not-executable'><span class='num'>200</span>    {
</div><div class='line not-covered'><span class='num'>201</span>        $this-&gt;edges[] = $edge;
</div><div class='line not-covered'><span class='num'>202</span>    }
</div><div class='line not-executable'><span class='num'>203</span>}
</div><div class='line not-executable'><span class='num'>204</span>
</div><div class='line not-executable'><span class='num'>205</span>final class AuditLog
</div><div class='line not-executable'><span class='num'>206</span>{
</div><div class='line not-executable'><span class='num'>207</span>    public string $entityType;
</div><div class='line not-executable'><span class='num'>208</span>    public string $entityId;
</div><div class='line not-executable'><span class='num'>209</span>    public string $action;
</div><div class='line not-executable'><span class='num'>210</span>    public ?array $oldData;
</div><div class='line not-executable'><span class='num'>211</span>    public ?array $newData;
</div><div class='line not-executable'><span class='num'>212</span>    public string $userId;
</div><div class='line not-executable'><span class='num'>213</span>    public string $ipAddress;
</div><div class='line not-executable'><span class='num'>214</span>    public string $createdAt;
</div><div class='line not-executable'><span class='num'>215</span>
</div><div class='line not-executable'><span class='num'>216</span>    public function __construct(string $entityType, string $entityId, string $action, ?array $oldData = null, ?array $newData = null)
</div><div class='line not-executable'><span class='num'>217</span>    {
</div><div class='line covered'><span class='num'>218</span>        $this-&gt;entityType = $entityType;
</div><div class='line covered'><span class='num'>219</span>        $this-&gt;entityId   = $entityId;
</div><div class='line covered'><span class='num'>220</span>        $this-&gt;action     = $action;
</div><div class='line covered'><span class='num'>221</span>        $this-&gt;oldData    = $oldData;
</div><div class='line covered'><span class='num'>222</span>        $this-&gt;newData    = $newData;
</div><div class='line covered'><span class='num'>223</span>    }
</div><div class='line not-executable'><span class='num'>224</span>}
</div><div class='line not-executable'><span class='num'>225</span>
</div><div class='line not-executable'><span class='num'>226</span>final class AuditLogs
</div><div class='line not-executable'><span class='num'>227</span>{
</div><div class='line not-executable'><span class='num'>228</span>    public array $logs = [];
</div><div class='line not-executable'><span class='num'>229</span>    public function addLog(AuditLog $log): void
</div><div class='line not-executable'><span class='num'>230</span>    {
</div><div class='line not-covered'><span class='num'>231</span>        $this-&gt;logs[] = $log;
</div><div class='line not-covered'><span class='num'>232</span>    }
</div><div class='line not-executable'><span class='num'>233</span>}
</div><div class='line not-executable'><span class='num'>234</span>
</div><div class='line not-executable'><span class='num'>235</span>final class GraphContext
</div><div class='line not-executable'><span class='num'>236</span>{
</div><div class='line not-executable'><span class='num'>237</span>    public static User $user;
</div><div class='line not-executable'><span class='num'>238</span>}
</div><div class='line not-executable'><span class='num'>239</span>
</div><div class='line not-executable'><span class='num'>240</span>interface LoggerInterface
</div><div class='line not-executable'><span class='num'>241</span>{
</div><div class='line not-executable'><span class='num'>242</span>    public function info(string $message, array $data = []): void;
</div><div class='line not-executable'><span class='num'>243</span>    public function debug(string $message, array $data = []): void;
</div><div class='line not-executable'><span class='num'>244</span>    public function error(string $message, array $data = []): void;
</div><div class='line not-executable'><span class='num'>245</span>}
</div><div class='line not-executable'><span class='num'>246</span>
</div><div class='line not-executable'><span class='num'>247</span>final class Logger implements LoggerInterface
</div><div class='line not-executable'><span class='num'>248</span>{
</div><div class='line not-executable'><span class='num'>249</span>    private string $fileName;
</div><div class='line not-executable'><span class='num'>250</span>    private $fd;
</div><div class='line not-executable'><span class='num'>251</span>
</div><div class='line not-executable'><span class='num'>252</span>    public function __construct($file_name)
</div><div class='line not-executable'><span class='num'>253</span>    {
</div><div class='line covered'><span class='num'>254</span>        $this-&gt;fileName = $file_name;
</div><div class='line covered'><span class='num'>255</span>        $this-&gt;fd = fopen($this-&gt;fileName, &#039;a&#039;);
</div><div class='line covered'><span class='num'>256</span>    }
</div><div class='line not-executable'><span class='num'>257</span>
</div><div class='line not-executable'><span class='num'>258</span>    public function info(string $message, array $data = []): void
</div><div class='line not-executable'><span class='num'>259</span>    {
</div><div class='line covered'><span class='num'>260</span>        $this-&gt;log(&#039;INFO&#039;, $message, $data);
</div><div class='line covered'><span class='num'>261</span>    }
</div><div class='line not-executable'><span class='num'>262</span>
</div><div class='line not-executable'><span class='num'>263</span>    public function debug(string $message, array $data = []): void
</div><div class='line not-executable'><span class='num'>264</span>    {
</div><div class='line covered'><span class='num'>265</span>        $this-&gt;log(&#039;DEBUG&#039;, $message, $data);
</div><div class='line covered'><span class='num'>266</span>    }
</div><div class='line not-executable'><span class='num'>267</span>
</div><div class='line not-executable'><span class='num'>268</span>    public function error(string $message, array $data = []): void
</div><div class='line not-executable'><span class='num'>269</span>    {
</div><div class='line not-covered'><span class='num'>270</span>        $this-&gt;log(&#039;ERROR&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>271</span>    }
</div><div class='line not-executable'><span class='num'>272</span>
</div><div class='line not-executable'><span class='num'>273</span>    private function log(string $type, $message, $data = [])
</div><div class='line not-executable'><span class='num'>274</span>    {
</div><div class='line covered'><span class='num'>275</span>        $trace = debug_backtrace(DEBUG_BACKTRACE_PROVIDE_OBJECT, 3);
</div><div class='line covered'><span class='num'>276</span>        $method = &quot;{$trace[2][&#039;class&#039;]}::{$trace[2][&#039;function&#039;]}&quot;;
</div><div class='line covered'><span class='num'>277</span>        $data = json_encode($data);
</div><div class='line covered'><span class='num'>278</span>        $message = &quot;[{$type}] {$method}: $message ($data)\n&quot;;
</div><div class='line covered'><span class='num'>279</span>        fwrite($this-&gt;fd, $message);
</div><div class='line covered'><span class='num'>280</span>    }
</div><div class='line not-executable'><span class='num'>281</span>}
</div><div class='line not-executable'><span class='num'>282</span>
</div><div class='line not-executable'><span class='num'>283</span>interface GraphDatabaseInterface
</div><div class='line not-executable'><span class='num'>284</span>{
</div><div class='line not-executable'><span class='num'>285</span>    public function getUser(string $id): ?array;
</div><div class='line not-executable'><span class='num'>286</span>    public function insertUser(string $id, string $group): void;
</div><div class='line not-executable'><span class='num'>287</span>    public function updateUser(string $id, string $group): void;
</div><div class='line not-executable'><span class='num'>288</span>
</div><div class='line not-executable'><span class='num'>289</span>    public function getNode(string $id): ?array;
</div><div class='line not-executable'><span class='num'>290</span>    public function getNodes(): array;
</div><div class='line not-executable'><span class='num'>291</span>    public function insertNode(string $id, string $label, string $category, string $type, array $data = []): void;
</div><div class='line not-executable'><span class='num'>292</span>    public function updateNode(string $id, string $label, string $category, string $type, array $data = []): void;
</div><div class='line not-executable'><span class='num'>293</span>    public function deleteNode(string $id): void;
</div><div class='line not-executable'><span class='num'>294</span>
</div><div class='line not-executable'><span class='num'>295</span>    public function getEdge(string $source, string $target): ?array;
</div><div class='line not-executable'><span class='num'>296</span>    public function getEdgeById(string $id): ?array;
</div><div class='line not-executable'><span class='num'>297</span>    public function getEdges(): array;
</div><div class='line not-executable'><span class='num'>298</span>    public function insertEdge(string $id, string $source, string $target, array $data = []): void;
</div><div class='line not-executable'><span class='num'>299</span>    public function updateEdge(string $id, string $source, string $target, array $data = []): void;
</div><div class='line not-executable'><span class='num'>300</span>    public function deleteEdge(string $id): void;
</div><div class='line not-executable'><span class='num'>301</span>
</div><div class='line not-executable'><span class='num'>302</span>    public function getStatuses(): array;
</div><div class='line not-executable'><span class='num'>303</span>    public function getNodeStatus(string $id): ?string;
</div><div class='line not-executable'><span class='num'>304</span>    public function setNodeStatus(string $id, string $status): void;
</div><div class='line not-executable'><span class='num'>305</span>
</div><div class='line not-executable'><span class='num'>306</span>    public function getLogs($limit): array;
</div><div class='line not-executable'><span class='num'>307</span>    public function insertAuditLog(
</div><div class='line not-executable'><span class='num'>308</span>        string $entity_type, 
</div><div class='line not-executable'><span class='num'>309</span>        string $entity_id, 
</div><div class='line not-executable'><span class='num'>310</span>        string $action, 
</div><div class='line not-executable'><span class='num'>311</span>        ?array $old_data = null, 
</div><div class='line not-executable'><span class='num'>312</span>        ?array $new_data = null,
</div><div class='line not-executable'><span class='num'>313</span>        string $user_id,
</div><div class='line not-executable'><span class='num'>314</span>        string $ip_address): bool;
</div><div class='line not-executable'><span class='num'>315</span>}
</div><div class='line not-executable'><span class='num'>316</span>
</div><div class='line not-executable'><span class='num'>317</span>final class DatabaseException extends RuntimeException
</div><div class='line not-executable'><span class='num'>318</span>{
</div><div class='line not-executable'><span class='num'>319</span>    private ?string $query;
</div><div class='line not-executable'><span class='num'>320</span>    private ?array $params;
</div><div class='line not-executable'><span class='num'>321</span>
</div><div class='line not-executable'><span class='num'>322</span>    
</div><div class='line not-executable'><span class='num'>323</span>    public function __construct(string $message = &quot;&quot;,  int $code = 0, ?Throwable $previous = null, ?string $query = null, ?array $params) {
</div><div class='line not-covered'><span class='num'>324</span>        parent::__construct($message, $code, $previous);
</div><div class='line not-covered'><span class='num'>325</span>        $this-&gt;query = $query;
</div><div class='line not-covered'><span class='num'>326</span>        $this-&gt;params = $params;
</div><div class='line not-covered'><span class='num'>327</span>    }
</div><div class='line not-executable'><span class='num'>328</span>}
</div><div class='line not-executable'><span class='num'>329</span>
</div><div class='line not-executable'><span class='num'>330</span>final class GraphDatabase implements GraphDatabaseInterface
</div><div class='line not-executable'><span class='num'>331</span>{
</div><div class='line not-executable'><span class='num'>332</span>    private PDO $pdo;
</div><div class='line not-executable'><span class='num'>333</span>    private Logger $logger;
</div><div class='line not-executable'><span class='num'>334</span>
</div><div class='line not-executable'><span class='num'>335</span>    public function __construct(PDO $pdo, Logger $logger)
</div><div class='line not-executable'><span class='num'>336</span>    {
</div><div class='line covered'><span class='num'>337</span>        $this-&gt;pdo = $pdo;
</div><div class='line covered'><span class='num'>338</span>        $this-&gt;logger = $logger;
</div><div class='line covered'><span class='num'>339</span>        $this-&gt;initSchema();
</div><div class='line covered'><span class='num'>340</span>    }
</div><div class='line not-executable'><span class='num'>341</span>
</div><div class='line not-executable'><span class='num'>342</span>    public function getUser(string $id): ?array
</div><div class='line not-executable'><span class='num'>343</span>    {
</div><div class='line not-covered'><span class='num'>344</span>        $this-&gt;logger-&gt;debug(&quot;getting user id: &#039;{$id}&#039;&quot;);
</div><div class='line not-executable'><span class='num'>345</span>        try {
</div><div class='line not-covered'><span class='num'>346</span>            $sql = &quot;SELECT * FROM users WHERE id = :id&quot;;
</div><div class='line not-covered'><span class='num'>347</span>            $params = [&#039;:id&#039; =&gt; $id];
</div><div class='line not-covered'><span class='num'>348</span>            $stmt = $this-&gt;pdo-&gt;prepare($sql);
</div><div class='line not-covered'><span class='num'>349</span>            $stmt-&gt;execute($params);
</div><div class='line not-covered'><span class='num'>350</span>            $row = $stmt-&gt;fetch();
</div><div class='line not-executable'><span class='num'>351</span>
</div><div class='line not-covered'><span class='num'>352</span>            if ($row) {
</div><div class='line not-covered'><span class='num'>353</span>                return $row;
</div><div class='line not-executable'><span class='num'>354</span>            }
</div><div class='line not-covered'><span class='num'>355</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>356</span>            $e = new DatabaseException(
</div><div class='line not-covered'><span class='num'>357</span>                &quot;GraphDatabase Exception while trying to get user data. ID: {$id}&quot;,
</div><div class='line not-covered'><span class='num'>358</span>                0,
</div><div class='line not-executable'><span class='num'>359</span>                $e,
</div><div class='line not-executable'><span class='num'>360</span>                $sql,
</div><div class='line not-executable'><span class='num'>361</span>                $params
</div><div class='line not-executable'><span class='num'>362</span>            );
</div><div class='line not-executable'><span class='num'>363</span>        }
</div><div class='line not-covered'><span class='num'>364</span>        return null;
</div><div class='line not-covered'><span class='num'>365</span>    }
</div><div class='line not-executable'><span class='num'>366</span>
</div><div class='line not-executable'><span class='num'>367</span>    public function insertUser(string $id, string $group): void
</div><div class='line not-executable'><span class='num'>368</span>    {
</div><div class='line not-executable'><span class='num'>369</span>        try {
</div><div class='line not-covered'><span class='num'>370</span>            $sql = &quot;
</div><div class='line not-executable'><span class='num'>371</span>                INSERT OR IGNORE INTO users 
</div><div class='line not-executable'><span class='num'>372</span>                (id, user_group)
</div><div class='line not-executable'><span class='num'>373</span>                VALUES (:id, :group)&quot;;
</div><div class='line not-executable'><span class='num'>374</span>            
</div><div class='line not-covered'><span class='num'>375</span>            $params = [
</div><div class='line not-covered'><span class='num'>376</span>                &#039;:id&#039;       =&gt; $id,
</div><div class='line not-covered'><span class='num'>377</span>                &#039;:group&#039;    =&gt; $group
</div><div class='line not-executable'><span class='num'>378</span>            ];
</div><div class='line not-executable'><span class='num'>379</span>
</div><div class='line not-covered'><span class='num'>380</span>            $stmt = $this-&gt;pdo-&gt;prepare($sql);
</div><div class='line not-covered'><span class='num'>381</span>            $stmt-&gt;execute($params);
</div><div class='line not-covered'><span class='num'>382</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>383</span>            $e = new DatabaseException(
</div><div class='line not-covered'><span class='num'>384</span>                &quot;GraphDatabase Exception while trying to insert new user. ID: {$id}&quot;,
</div><div class='line not-covered'><span class='num'>385</span>                0,
</div><div class='line not-executable'><span class='num'>386</span>                $e,
</div><div class='line not-executable'><span class='num'>387</span>                $sql,
</div><div class='line not-executable'><span class='num'>388</span>                $params
</div><div class='line not-executable'><span class='num'>389</span>            );
</div><div class='line not-executable'><span class='num'>390</span>        }
</div><div class='line not-covered'><span class='num'>391</span>    }
</div><div class='line not-executable'><span class='num'>392</span>
</div><div class='line not-executable'><span class='num'>393</span>    public function updateUser(string $id, string $group): void
</div><div class='line not-executable'><span class='num'>394</span>    {
</div><div class='line not-executable'><span class='num'>395</span>        try {
</div><div class='line not-covered'><span class='num'>396</span>            $sql = &quot;
</div><div class='line not-executable'><span class='num'>397</span>                UPDATE users
</div><div class='line not-executable'><span class='num'>398</span>                SET    user_group = :group
</div><div class='line not-executable'><span class='num'>399</span>                WHERE  id = :id
</div><div class='line not-executable'><span class='num'>400</span>            &quot;;
</div><div class='line not-executable'><span class='num'>401</span>
</div><div class='line not-covered'><span class='num'>402</span>            $params = [
</div><div class='line not-covered'><span class='num'>403</span>                &#039;:id&#039;       =&gt; $id,
</div><div class='line not-covered'><span class='num'>404</span>                &#039;:group&#039;    =&gt; $group
</div><div class='line not-executable'><span class='num'>405</span>            ];
</div><div class='line not-executable'><span class='num'>406</span>
</div><div class='line not-covered'><span class='num'>407</span>            $stmt = $this-&gt;pdo-&gt;prepare($sql);
</div><div class='line not-executable'><span class='num'>408</span>            
</div><div class='line not-covered'><span class='num'>409</span>            $stmt-&gt;execute($params);
</div><div class='line not-executable'><span class='num'>410</span>
</div><div class='line not-covered'><span class='num'>411</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>412</span>            $e = new DatabaseException(
</div><div class='line not-covered'><span class='num'>413</span>                &quot;GraphDatabase Exception while trying to update user. ID: {$id}&quot;,
</div><div class='line not-covered'><span class='num'>414</span>                0,
</div><div class='line not-executable'><span class='num'>415</span>                $e,
</div><div class='line not-executable'><span class='num'>416</span>                $sql,
</div><div class='line not-executable'><span class='num'>417</span>                $params
</div><div class='line not-executable'><span class='num'>418</span>            );
</div><div class='line not-executable'><span class='num'>419</span>        }
</div><div class='line not-covered'><span class='num'>420</span>    }
</div><div class='line not-executable'><span class='num'>421</span>
</div><div class='line not-executable'><span class='num'>422</span>    public function getNode(string $id): ?array
</div><div class='line not-executable'><span class='num'>423</span>    {
</div><div class='line covered'><span class='num'>424</span>        $this-&gt;logger-&gt;debug(&quot;fetching node &#039;{$id}&#039;&quot;);
</div><div class='line not-executable'><span class='num'>425</span>
</div><div class='line not-executable'><span class='num'>426</span>        try {
</div><div class='line covered'><span class='num'>427</span>            $sql = &quot;SELECT * FROM nodes WHERE id = :id&quot;;
</div><div class='line covered'><span class='num'>428</span>            $params = [&#039;:id&#039; =&gt; $id];
</div><div class='line covered'><span class='num'>429</span>            $stmt = $this-&gt;pdo-&gt;prepare($sql);
</div><div class='line covered'><span class='num'>430</span>            $stmt-&gt;execute($params);
</div><div class='line covered'><span class='num'>431</span>            $row = $stmt-&gt;fetch();
</div><div class='line covered'><span class='num'>432</span>            if ($row) {
</div><div class='line covered'><span class='num'>433</span>                return $row;
</div><div class='line not-executable'><span class='num'>434</span>            }
</div><div class='line not-covered'><span class='num'>435</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>436</span>            $this-&gt;logger-&gt;error(&quot;exception with node id &#039;{$id}&#039;&quot;);
</div><div class='line not-covered'><span class='num'>437</span>            throw new DatabaseException(&quot;could not get node data with id &#039;{$id}&#039;&quot;, 0, $e, $sql, $params);
</div><div class='line not-executable'><span class='num'>438</span>        }
</div><div class='line not-covered'><span class='num'>439</span>        return null;
</div><div class='line not-covered'><span class='num'>440</span>    }
</div><div class='line not-executable'><span class='num'>441</span>
</div><div class='line not-executable'><span class='num'>442</span>    public function getNodes(): array
</div><div class='line not-executable'><span class='num'>443</span>    {
</div><div class='line not-executable'><span class='num'>444</span>        try {
</div><div class='line not-covered'><span class='num'>445</span>            $stmt = $this-&gt;pdo-&gt;query(&quot;SELECT * FROM nodes&quot;);
</div><div class='line not-covered'><span class='num'>446</span>            $rows = $stmt-&gt;fetchAll();
</div><div class='line not-covered'><span class='num'>447</span>            return $rows;
</div><div class='line not-covered'><span class='num'>448</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>449</span>            error_log(&quot;GraphDatabase fetch all nodes failed: &quot; . $e-&gt;getMessage());
</div><div class='line not-covered'><span class='num'>450</span>            return [];
</div><div class='line not-executable'><span class='num'>451</span>        }
</div><div class='line not-covered'><span class='num'>452</span>    }
</div><div class='line not-executable'><span class='num'>453</span>
</div><div class='line not-executable'><span class='num'>454</span>    public function insertNode(string $id, string $label, string $category, string $type, array $data = []): void
</div><div class='line not-executable'><span class='num'>455</span>    {
</div><div class='line not-executable'><span class='num'>456</span>        try {
</div><div class='line covered'><span class='num'>457</span>            $sql = &quot;
</div><div class='line not-executable'><span class='num'>458</span>                INSERT OR IGNORE INTO nodes 
</div><div class='line not-executable'><span class='num'>459</span>                (id, label, category, type, data) 
</div><div class='line not-executable'><span class='num'>460</span>                VALUES (:id, :label, :category, :type, :data)&quot;;
</div><div class='line covered'><span class='num'>461</span>            $stmt             = $this-&gt;pdo-&gt;prepare($sql);
</div><div class='line covered'><span class='num'>462</span>            $data[&#039;id&#039;]       = $id;
</div><div class='line covered'><span class='num'>463</span>            $data[&#039;label&#039;]    = $label;
</div><div class='line covered'><span class='num'>464</span>            $data[&#039;category&#039;] = $category;
</div><div class='line covered'><span class='num'>465</span>            $data[&#039;type&#039;]     = $type;
</div><div class='line covered'><span class='num'>466</span>            $stmt-&gt;execute([
</div><div class='line covered'><span class='num'>467</span>                &#039;:id&#039;       =&gt; $id,
</div><div class='line covered'><span class='num'>468</span>                &#039;:label&#039;    =&gt; $label,
</div><div class='line covered'><span class='num'>469</span>                &#039;:category&#039; =&gt; $category,
</div><div class='line covered'><span class='num'>470</span>                &#039;:type&#039;     =&gt; $type,
</div><div class='line covered'><span class='num'>471</span>                &#039;:data&#039;     =&gt; json_encode($data, JSON_UNESCAPED_UNICODE)
</div><div class='line not-executable'><span class='num'>472</span>            ]);
</div><div class='line not-covered'><span class='num'>473</span>        } catch (PDOException $e) {
</div><div class='line not-executable'><span class='num'>474</span>            // TODO
</div><div class='line not-executable'><span class='num'>475</span>        }
</div><div class='line covered'><span class='num'>476</span>    }
</div><div class='line not-executable'><span class='num'>477</span>
</div><div class='line not-executable'><span class='num'>478</span>    public function updateNode(string $id, string $label, string $category, string $type, array $data = []): void
</div><div class='line not-executable'><span class='num'>479</span>    {
</div><div class='line not-executable'><span class='num'>480</span>        try {
</div><div class='line not-covered'><span class='num'>481</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-executable'><span class='num'>482</span>                UPDATE nodes
</div><div class='line not-executable'><span class='num'>483</span>                SET    label = :label, 
</div><div class='line not-executable'><span class='num'>484</span>                       category = :category, 
</div><div class='line not-executable'><span class='num'>485</span>                       type = :type, 
</div><div class='line not-executable'><span class='num'>486</span>                       data = :data
</div><div class='line not-executable'><span class='num'>487</span>                WHERE  id = :id&quot;);
</div><div class='line not-covered'><span class='num'>488</span>            $data[&#039;id&#039;]       = $id;
</div><div class='line not-covered'><span class='num'>489</span>            $data[&#039;label&#039;]    = $label;
</div><div class='line not-covered'><span class='num'>490</span>            $data[&#039;category&#039;] = $category;
</div><div class='line not-covered'><span class='num'>491</span>            $data[&#039;type&#039;]     = $type;
</div><div class='line not-executable'><span class='num'>492</span>
</div><div class='line not-covered'><span class='num'>493</span>            $stmt-&gt;execute([
</div><div class='line not-covered'><span class='num'>494</span>                &#039;:id&#039;       =&gt; $id,
</div><div class='line not-covered'><span class='num'>495</span>                &#039;:label&#039;    =&gt; $label,
</div><div class='line not-covered'><span class='num'>496</span>                &#039;:category&#039; =&gt; $category,
</div><div class='line not-covered'><span class='num'>497</span>                &#039;:type&#039;     =&gt; $type,
</div><div class='line not-covered'><span class='num'>498</span>                &#039;:data&#039;     =&gt; json_encode($data, JSON_UNESCAPED_UNICODE)
</div><div class='line not-executable'><span class='num'>499</span>            ]);
</div><div class='line not-covered'><span class='num'>500</span>        } catch (PDOException $e) {
</div><div class='line not-executable'><span class='num'>501</span>            // TODO
</div><div class='line not-executable'><span class='num'>502</span>        }
</div><div class='line not-covered'><span class='num'>503</span>    }
</div><div class='line not-executable'><span class='num'>504</span>
</div><div class='line not-executable'><span class='num'>505</span>    public function deleteNode(string $id): void
</div><div class='line not-executable'><span class='num'>506</span>    {
</div><div class='line not-executable'><span class='num'>507</span>        try {
</div><div class='line not-covered'><span class='num'>508</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;DELETE FROM nodes WHERE id = :id&quot;);
</div><div class='line not-covered'><span class='num'>509</span>            $stmt-&gt;execute([&#039;:id&#039; =&gt; $id]);
</div><div class='line not-covered'><span class='num'>510</span>        } catch (PDOException $e) {
</div><div class='line not-executable'><span class='num'>511</span>            // TODO
</div><div class='line not-executable'><span class='num'>512</span>        }
</div><div class='line not-covered'><span class='num'>513</span>    }
</div><div class='line not-executable'><span class='num'>514</span>
</div><div class='line not-executable'><span class='num'>515</span>    public function getEdge(string $source, string $target): ?array
</div><div class='line not-executable'><span class='num'>516</span>    {
</div><div class='line not-executable'><span class='num'>517</span>        try {
</div><div class='line covered'><span class='num'>518</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-executable'><span class='num'>519</span>                SELECT * FROM edges
</div><div class='line not-executable'><span class='num'>520</span>                WHERE source = :source AND target = :target
</div><div class='line not-executable'><span class='num'>521</span>            &quot;);
</div><div class='line covered'><span class='num'>522</span>            $stmt-&gt;execute([
</div><div class='line covered'><span class='num'>523</span>                &#039;:source&#039; =&gt; $source,
</div><div class='line covered'><span class='num'>524</span>                &#039;:target&#039; =&gt; $target
</div><div class='line not-executable'><span class='num'>525</span>            ]);
</div><div class='line covered'><span class='num'>526</span>            $row = $stmt-&gt;fetch();
</div><div class='line covered'><span class='num'>527</span>            if ($row) {
</div><div class='line covered'><span class='num'>528</span>                return $row;
</div><div class='line not-executable'><span class='num'>529</span>            }
</div><div class='line not-covered'><span class='num'>530</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>531</span>            error_log(&quot;GraphDatabase edge exists check failed: &quot; . $e-&gt;getMessage());
</div><div class='line not-executable'><span class='num'>532</span>        }
</div><div class='line covered'><span class='num'>533</span>        return null;
</div><div class='line not-covered'><span class='num'>534</span>    }
</div><div class='line not-executable'><span class='num'>535</span>
</div><div class='line not-executable'><span class='num'>536</span>    public function getEdgeById(string $id): ?array
</div><div class='line not-executable'><span class='num'>537</span>    {
</div><div class='line not-executable'><span class='num'>538</span>        try {
</div><div class='line not-covered'><span class='num'>539</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-executable'><span class='num'>540</span>                SELECT * FROM edges
</div><div class='line not-executable'><span class='num'>541</span>                WHERE id = :id
</div><div class='line not-executable'><span class='num'>542</span>            &quot;);
</div><div class='line not-covered'><span class='num'>543</span>            $stmt-&gt;execute([
</div><div class='line not-covered'><span class='num'>544</span>                &#039;:id&#039; =&gt; $id,
</div><div class='line not-executable'><span class='num'>545</span>            ]);
</div><div class='line not-covered'><span class='num'>546</span>            $row = $stmt-&gt;fetch();
</div><div class='line not-covered'><span class='num'>547</span>            if ($row) {
</div><div class='line not-covered'><span class='num'>548</span>                return $row;
</div><div class='line not-executable'><span class='num'>549</span>            }
</div><div class='line not-covered'><span class='num'>550</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>551</span>            error_log(&quot;GraphDatabase edge exists check failed: &quot; . $e-&gt;getMessage());
</div><div class='line not-executable'><span class='num'>552</span>        }
</div><div class='line not-covered'><span class='num'>553</span>        return null;
</div><div class='line not-covered'><span class='num'>554</span>    }
</div><div class='line not-executable'><span class='num'>555</span>
</div><div class='line not-executable'><span class='num'>556</span>    public function getEdges(): array
</div><div class='line not-executable'><span class='num'>557</span>    {
</div><div class='line not-executable'><span class='num'>558</span>        try {
</div><div class='line not-covered'><span class='num'>559</span>            $stmt  = $this-&gt;pdo-&gt;query(&quot;SELECT * FROM edges&quot;);
</div><div class='line not-covered'><span class='num'>560</span>            $rows  = $stmt-&gt;fetchAll();
</div><div class='line not-covered'><span class='num'>561</span>            return $rows;
</div><div class='line not-covered'><span class='num'>562</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>563</span>            error_log(&quot;GraphDatabase fetch all edges failed: &quot; . $e-&gt;getMessage());
</div><div class='line not-covered'><span class='num'>564</span>            return [];
</div><div class='line not-executable'><span class='num'>565</span>        }
</div><div class='line not-covered'><span class='num'>566</span>    }
</div><div class='line not-executable'><span class='num'>567</span>
</div><div class='line not-executable'><span class='num'>568</span>    public function insertEdge(string $id, string $source, string $target, array $data = []): void
</div><div class='line not-executable'><span class='num'>569</span>    {
</div><div class='line not-executable'><span class='num'>570</span>        // verify if the inverse edge exists
</div><div class='line covered'><span class='num'>571</span>        $r = $this-&gt;getEdge($target, $source);
</div><div class='line not-executable'><span class='num'>572</span>        
</div><div class='line not-executable'><span class='num'>573</span>        try {
</div><div class='line covered'><span class='num'>574</span>            $sql = &quot;
</div><div class='line not-executable'><span class='num'>575</span>                INSERT OR IGNORE INTO edges
</div><div class='line not-executable'><span class='num'>576</span>                (id, source, target, data)
</div><div class='line not-executable'><span class='num'>577</span>                VALUES (:id, :source, :target, :data)&quot;;
</div><div class='line covered'><span class='num'>578</span>            $stmt           = $this-&gt;pdo-&gt;prepare($sql);
</div><div class='line covered'><span class='num'>579</span>            $data[&#039;id&#039;]     = $id;
</div><div class='line covered'><span class='num'>580</span>            $data[&#039;source&#039;] = $source;
</div><div class='line covered'><span class='num'>581</span>            $data[&#039;target&#039;] = $target;
</div><div class='line covered'><span class='num'>582</span>            $stmt-&gt;execute([
</div><div class='line covered'><span class='num'>583</span>                &#039;:id&#039;     =&gt; $id,
</div><div class='line covered'><span class='num'>584</span>                &#039;:source&#039; =&gt; $source,
</div><div class='line covered'><span class='num'>585</span>                &#039;:target&#039; =&gt; $target,
</div><div class='line covered'><span class='num'>586</span>                &#039;:data&#039;   =&gt; json_encode($data, JSON_UNESCAPED_UNICODE)
</div><div class='line not-executable'><span class='num'>587</span>            ]);
</div><div class='line covered'><span class='num'>588</span>        } catch (PDOException $e) {
</div><div class='line not-executable'><span class='num'>589</span>            // TODO
</div><div class='line not-executable'><span class='num'>590</span>        }
</div><div class='line covered'><span class='num'>591</span>    }
</div><div class='line not-executable'><span class='num'>592</span>
</div><div class='line not-executable'><span class='num'>593</span>    public function updateEdge(string $id, string $source, string $target, array $data = []): void
</div><div class='line not-executable'><span class='num'>594</span>    {
</div><div class='line not-executable'><span class='num'>595</span>        try {
</div><div class='line not-covered'><span class='num'>596</span>            $data[&#039;id&#039;]     = $id;
</div><div class='line not-covered'><span class='num'>597</span>            $data[&#039;source&#039;] = $source;
</div><div class='line not-covered'><span class='num'>598</span>            $data[&#039;target&#039;] = $target;
</div><div class='line not-executable'><span class='num'>599</span>
</div><div class='line not-covered'><span class='num'>600</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-executable'><span class='num'>601</span>                UPDATE edges
</div><div class='line not-executable'><span class='num'>602</span>                SET data = :data
</div><div class='line not-executable'><span class='num'>603</span>                WHERE id = :id&quot;);
</div><div class='line not-covered'><span class='num'>604</span>            $stmt-&gt;execute([
</div><div class='line not-covered'><span class='num'>605</span>                &#039;:id&#039;   =&gt; $id,
</div><div class='line not-covered'><span class='num'>606</span>                &#039;:data&#039; =&gt; json_encode($data, JSON_UNESCAPED_UNICODE)
</div><div class='line not-executable'><span class='num'>607</span>            ]);
</div><div class='line not-covered'><span class='num'>608</span>        } catch (PDOException $e) {
</div><div class='line not-executable'><span class='num'>609</span>            // TODO
</div><div class='line not-executable'><span class='num'>610</span>        }
</div><div class='line not-covered'><span class='num'>611</span>    }
</div><div class='line not-executable'><span class='num'>612</span>
</div><div class='line not-executable'><span class='num'>613</span>    public function deleteEdge(string $id): void
</div><div class='line not-executable'><span class='num'>614</span>    {
</div><div class='line not-executable'><span class='num'>615</span>        try {
</div><div class='line not-covered'><span class='num'>616</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;DELETE FROM edges WHERE id = :id&quot;);
</div><div class='line not-covered'><span class='num'>617</span>            $stmt-&gt;execute([&#039;:id&#039; =&gt; $id]);
</div><div class='line not-covered'><span class='num'>618</span>        } catch (PDOException $e) {
</div><div class='line not-executable'><span class='num'>619</span>            // TODO
</div><div class='line not-executable'><span class='num'>620</span>        }
</div><div class='line not-covered'><span class='num'>621</span>    }
</div><div class='line not-executable'><span class='num'>622</span>
</div><div class='line not-executable'><span class='num'>623</span>    public function getStatuses(): array
</div><div class='line not-executable'><span class='num'>624</span>    {
</div><div class='line not-covered'><span class='num'>625</span>        $stmt   = $this-&gt;pdo-&gt;query(&quot;
</div><div class='line not-executable'><span class='num'>626</span>            SELECT n.id,
</div><div class='line not-executable'><span class='num'>627</span>                   s.status
</div><div class='line not-executable'><span class='num'>628</span>            FROM   nodes n
</div><div class='line not-executable'><span class='num'>629</span>            LEFT JOIN status s ON n.id = s.node_id&quot;);
</div><div class='line not-covered'><span class='num'>630</span>        $status = $stmt-&gt;fetchAll();
</div><div class='line not-covered'><span class='num'>631</span>        return $status;
</div><div class='line not-covered'><span class='num'>632</span>    }
</div><div class='line not-executable'><span class='num'>633</span>
</div><div class='line not-executable'><span class='num'>634</span>    public function getNodeStatus(string $id): ?string
</div><div class='line not-executable'><span class='num'>635</span>    {
</div><div class='line not-covered'><span class='num'>636</span>        $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-executable'><span class='num'>637</span>            SELECT s.status
</div><div class='line not-executable'><span class='num'>638</span>            FROM nodes n
</div><div class='line not-executable'><span class='num'>639</span>            LEFT JOIN status s
</div><div class='line not-executable'><span class='num'>640</span>            ON n.id = s.node_id
</div><div class='line not-executable'><span class='num'>641</span>            WHERE n.id = ?&quot;);
</div><div class='line not-covered'><span class='num'>642</span>        $stmt-&gt;execute([$id]);
</div><div class='line not-covered'><span class='num'>643</span>        $status = $stmt-&gt;fetch();
</div><div class='line not-covered'><span class='num'>644</span>        return $status ? $status[&#039;status&#039;] : null;
</div><div class='line not-covered'><span class='num'>645</span>    }
</div><div class='line not-executable'><span class='num'>646</span>
</div><div class='line not-executable'><span class='num'>647</span>    public function setNodeStatus(string $id, string $status): void
</div><div class='line not-executable'><span class='num'>648</span>    {
</div><div class='line not-covered'><span class='num'>649</span>        $stmt = $this-&gt;pdo-&gt;prepare(&quot;REPLACE INTO status (node_id, status) VALUES (?, ?)&quot;);
</div><div class='line not-covered'><span class='num'>650</span>        $stmt-&gt;execute([$id, $status]);
</div><div class='line not-covered'><span class='num'>651</span>    }
</div><div class='line not-executable'><span class='num'>652</span>
</div><div class='line not-executable'><span class='num'>653</span>    public function getLogs($limit): array
</div><div class='line not-executable'><span class='num'>654</span>    {
</div><div class='line not-covered'><span class='num'>655</span>        $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-executable'><span class='num'>656</span>            SELECT *
</div><div class='line not-executable'><span class='num'>657</span>            FROM audit
</div><div class='line not-executable'><span class='num'>658</span>            ORDER BY created_at DESC
</div><div class='line not-executable'><span class='num'>659</span>            LIMIT :limit
</div><div class='line not-executable'><span class='num'>660</span>        &quot;);
</div><div class='line not-covered'><span class='num'>661</span>        $stmt-&gt;bindValue(&#039;:limit&#039;, (int)$limit, PDO::PARAM_INT);
</div><div class='line not-covered'><span class='num'>662</span>        $stmt-&gt;execute();
</div><div class='line not-covered'><span class='num'>663</span>        $rows = $stmt-&gt;fetchAll();
</div><div class='line not-covered'><span class='num'>664</span>        return $rows;
</div><div class='line not-covered'><span class='num'>665</span>    }
</div><div class='line not-executable'><span class='num'>666</span>
</div><div class='line not-executable'><span class='num'>667</span>    public function insertAuditLog(string $entity_type, string $entity_id, string $action, ?array $old_data = null, ?array $new_data = null, string $user_id, string $ip_address): bool
</div><div class='line not-executable'><span class='num'>668</span>    {
</div><div class='line not-executable'><span class='num'>669</span>        try {
</div><div class='line covered'><span class='num'>670</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-executable'><span class='num'>671</span>                INSERT INTO audit (entity_type, entity_id, action, old_data, new_data, user_id, ip_address)
</div><div class='line not-executable'><span class='num'>672</span>                VALUES (:entity_type, :entity_id, :action, :old_data, :new_data, :user_id, :ip_address)
</div><div class='line not-executable'><span class='num'>673</span>            &quot;);
</div><div class='line not-executable'><span class='num'>674</span>
</div><div class='line covered'><span class='num'>675</span>            $stmt-&gt;execute([
</div><div class='line covered'><span class='num'>676</span>                &#039;:entity_type&#039; =&gt; $entity_type,
</div><div class='line covered'><span class='num'>677</span>                &#039;:entity_id&#039;   =&gt; $entity_id,
</div><div class='line covered'><span class='num'>678</span>                &#039;:action&#039;      =&gt; $action,
</div><div class='line not-covered'><span class='num'>679</span>                &#039;:old_data&#039;    =&gt; $old_data !== null ? json_encode($old_data, JSON_UNESCAPED_UNICODE) : null,
</div><div class='line covered'><span class='num'>680</span>                &#039;:new_data&#039;    =&gt; $new_data !== null ? json_encode($new_data, JSON_UNESCAPED_UNICODE) : null,
</div><div class='line covered'><span class='num'>681</span>                &#039;:user_id&#039;     =&gt; $user_id,
</div><div class='line covered'><span class='num'>682</span>                &#039;:ip_address&#039;  =&gt; $ip_address
</div><div class='line not-executable'><span class='num'>683</span>            ]);
</div><div class='line covered'><span class='num'>684</span>            return true;
</div><div class='line not-covered'><span class='num'>685</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>686</span>            error_log(&quot;GraphDatabase audit log insert failed: &quot; . $e-&gt;getMessage());
</div><div class='line not-covered'><span class='num'>687</span>            return false;
</div><div class='line not-executable'><span class='num'>688</span>        }
</div><div class='line not-covered'><span class='num'>689</span>    }
</div><div class='line not-executable'><span class='num'>690</span>
</div><div class='line not-executable'><span class='num'>691</span>    private function initSchema(): void
</div><div class='line not-executable'><span class='num'>692</span>    {
</div><div class='line covered'><span class='num'>693</span>        $this-&gt;pdo-&gt;exec(&quot;
</div><div class='line not-executable'><span class='num'>694</span>            CREATE TABLE IF NOT EXISTS users (
</div><div class='line not-executable'><span class='num'>695</span>                id TEXT PRIMARY KEY,
</div><div class='line not-executable'><span class='num'>696</span>                user_group TEXT NOT NULL
</div><div class='line not-executable'><span class='num'>697</span>            )
</div><div class='line not-executable'><span class='num'>698</span>        &quot;);
</div><div class='line not-executable'><span class='num'>699</span>
</div><div class='line covered'><span class='num'>700</span>        $this-&gt;pdo-&gt;exec(&quot;INSERT INTO users VALUES(&#039;admin&#039;, &#039;admin&#039;)&quot;);
</div><div class='line not-executable'><span class='num'>701</span>
</div><div class='line covered'><span class='num'>702</span>        $this-&gt;pdo-&gt;exec(&quot;
</div><div class='line not-executable'><span class='num'>703</span>            CREATE TABLE IF NOT EXISTS nodes (
</div><div class='line not-executable'><span class='num'>704</span>                id TEXT PRIMARY KEY,
</div><div class='line not-executable'><span class='num'>705</span>                label TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>706</span>                category TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>707</span>                type TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>708</span>                data TEXT NOT NULL
</div><div class='line not-executable'><span class='num'>709</span>            )
</div><div class='line not-executable'><span class='num'>710</span>        &quot;);
</div><div class='line not-executable'><span class='num'>711</span>
</div><div class='line covered'><span class='num'>712</span>        $this-&gt;pdo-&gt;exec(&quot;
</div><div class='line not-executable'><span class='num'>713</span>            CREATE TABLE IF NOT EXISTS edges (
</div><div class='line not-executable'><span class='num'>714</span>                id TEXT PRIMARY KEY,
</div><div class='line not-executable'><span class='num'>715</span>                source TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>716</span>                target TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>717</span>                data TEXT,
</div><div class='line not-executable'><span class='num'>718</span>                FOREIGN KEY (source) REFERENCES nodes(id) ON DELETE CASCADE,
</div><div class='line not-executable'><span class='num'>719</span>                FOREIGN KEY (target) REFERENCES nodes(id) ON DELETE CASCADE
</div><div class='line not-executable'><span class='num'>720</span>            )
</div><div class='line not-executable'><span class='num'>721</span>        &quot;);
</div><div class='line not-executable'><span class='num'>722</span>
</div><div class='line covered'><span class='num'>723</span>        $this-&gt;pdo-&gt;exec(&quot;CREATE UNIQUE INDEX IF NOT EXISTS idx_edges_source_target ON edges (source, target)&quot;);
</div><div class='line not-executable'><span class='num'>724</span>
</div><div class='line covered'><span class='num'>725</span>        $this-&gt;pdo-&gt;exec(&quot;
</div><div class='line not-executable'><span class='num'>726</span>            CREATE TABLE IF NOT EXISTS status (
</div><div class='line not-executable'><span class='num'>727</span>                node_id TEXT PRIMARY KEY NOT NULL,
</div><div class='line not-executable'><span class='num'>728</span>                status TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>729</span>                created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
</div><div class='line not-executable'><span class='num'>730</span>                FOREIGN KEY (node_id) REFERENCES nodes(id) ON DELETE CASCADE
</div><div class='line not-executable'><span class='num'>731</span>            )
</div><div class='line not-executable'><span class='num'>732</span>        &quot;);
</div><div class='line not-executable'><span class='num'>733</span>
</div><div class='line covered'><span class='num'>734</span>        $this-&gt;pdo-&gt;exec(&quot;CREATE INDEX IF NOT EXISTS idx_node_status_node_id ON status (node_id)&quot;);
</div><div class='line not-executable'><span class='num'>735</span>
</div><div class='line covered'><span class='num'>736</span>        $this-&gt;pdo-&gt;exec(&quot;
</div><div class='line not-executable'><span class='num'>737</span>            CREATE TABLE IF NOT EXISTS audit (
</div><div class='line not-executable'><span class='num'>738</span>                id INTEGER PRIMARY KEY AUTOINCREMENT,
</div><div class='line not-executable'><span class='num'>739</span>                entity_type TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>740</span>                entity_id TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>741</span>                action TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>742</span>                old_data TEXT,
</div><div class='line not-executable'><span class='num'>743</span>                new_data TEXT,
</div><div class='line not-executable'><span class='num'>744</span>                user_id TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>745</span>                ip_address TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>746</span>                created_at DATETIME DEFAULT CURRENT_TIMESTAMP
</div><div class='line not-executable'><span class='num'>747</span>            )
</div><div class='line not-executable'><span class='num'>748</span>        &quot;);
</div><div class='line covered'><span class='num'>749</span>    }
</div><div class='line not-executable'><span class='num'>750</span>
</div><div class='line not-executable'><span class='num'>751</span>    public static function createConnection(string $dsn): PDO
</div><div class='line not-executable'><span class='num'>752</span>    {
</div><div class='line covered'><span class='num'>753</span>        $pdo = new PDO($dsn);
</div><div class='line covered'><span class='num'>754</span>        $pdo-&gt;setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
</div><div class='line covered'><span class='num'>755</span>        $pdo-&gt;setAttribute(PDO::ATTR_DEFAULT_FETCH_MODE, PDO::FETCH_ASSOC);
</div><div class='line covered'><span class='num'>756</span>        $pdo-&gt;exec(&#039;PRAGMA foreign_keys = ON&#039;);
</div><div class='line covered'><span class='num'>757</span>        return $pdo;
</div><div class='line not-covered'><span class='num'>758</span>    }
</div><div class='line not-executable'><span class='num'>759</span>}
</div><div class='line not-executable'><span class='num'>760</span>
</div><div class='line not-executable'><span class='num'>761</span>final class GraphServiceException extends RuntimeException
</div><div class='line not-executable'><span class='num'>762</span>{
</div><div class='line not-executable'><span class='num'>763</span>}
</div><div class='line not-executable'><span class='num'>764</span>
</div><div class='line not-executable'><span class='num'>765</span>interface GraphServiceInterface
</div><div class='line not-executable'><span class='num'>766</span>{
</div><div class='line not-executable'><span class='num'>767</span>    public function getUser(string $id): ?User;
</div><div class='line not-executable'><span class='num'>768</span>    public function insertUser(User $user): void;
</div><div class='line not-executable'><span class='num'>769</span>    public function updateUser(User $user): void;
</div><div class='line not-executable'><span class='num'>770</span>
</div><div class='line not-executable'><span class='num'>771</span>    public function getGraph(): Graph;
</div><div class='line not-executable'><span class='num'>772</span>
</div><div class='line not-executable'><span class='num'>773</span>    public function getNode(string $id): ?Node;
</div><div class='line not-executable'><span class='num'>774</span>    public function getNodes(): Nodes;
</div><div class='line not-executable'><span class='num'>775</span>    public function insertNode(Node $node): void;
</div><div class='line not-executable'><span class='num'>776</span>    public function updateNode(Node $node): void;
</div><div class='line not-executable'><span class='num'>777</span>    public function deleteNode(string $id): void;
</div><div class='line not-executable'><span class='num'>778</span>
</div><div class='line not-executable'><span class='num'>779</span>    public function getEdge(string $source, string $target): ?Edge;
</div><div class='line not-executable'><span class='num'>780</span>    public function getEdges(): Edges;
</div><div class='line not-executable'><span class='num'>781</span>    public function insertEdge(Edge $edge): void;
</div><div class='line not-executable'><span class='num'>782</span>    public function updateEdge(Edge $edge): void;
</div><div class='line not-executable'><span class='num'>783</span>    public function deleteEdge(string $id): void;
</div><div class='line not-executable'><span class='num'>784</span>
</div><div class='line not-executable'><span class='num'>785</span>    public function getStatuses(): NodeStatuses;
</div><div class='line not-executable'><span class='num'>786</span>    public function getNodeStatus(string $id): NodeStatus;
</div><div class='line not-executable'><span class='num'>787</span>    public function setNodeStatus(NodeStatus $status): void;
</div><div class='line not-executable'><span class='num'>788</span>
</div><div class='line not-executable'><span class='num'>789</span>    public function getLogs($limit): AuditLogs;
</div><div class='line not-executable'><span class='num'>790</span>}
</div><div class='line not-executable'><span class='num'>791</span>
</div><div class='line not-executable'><span class='num'>792</span>final class GraphService implements GraphServiceInterface
</div><div class='line not-executable'><span class='num'>793</span>{
</div><div class='line not-executable'><span class='num'>794</span>    private const SECURE_ACTIONS = [
</div><div class='line not-executable'><span class='num'>795</span>        &#039;GraphService::getGraph&#039;      =&gt; true,
</div><div class='line not-executable'><span class='num'>796</span>        &#039;GraphService::getNode&#039;       =&gt; true,
</div><div class='line not-executable'><span class='num'>797</span>        &#039;GraphService::getNodes&#039;      =&gt; true,
</div><div class='line not-executable'><span class='num'>798</span>        &#039;GraphService::getEdge&#039;       =&gt; true,
</div><div class='line not-executable'><span class='num'>799</span>        &#039;GraphService::getEdges&#039;      =&gt; true,
</div><div class='line not-executable'><span class='num'>800</span>        &#039;GraphService::getStatuses&#039;   =&gt; true,
</div><div class='line not-executable'><span class='num'>801</span>        &#039;GraphService::getNodeStatus&#039; =&gt; true,
</div><div class='line not-executable'><span class='num'>802</span>        &#039;GraphService::setNodeStatus&#039; =&gt; true,
</div><div class='line not-executable'><span class='num'>803</span>        &#039;GraphService::getLogs&#039;       =&gt; true,
</div><div class='line not-executable'><span class='num'>804</span>        &#039;GraphService::insertNode&#039;    =&gt; false,
</div><div class='line not-executable'><span class='num'>805</span>        &#039;GraphService::updateNode&#039;    =&gt; false,
</div><div class='line not-executable'><span class='num'>806</span>        &#039;GraphService::deleteNode&#039;    =&gt; false,
</div><div class='line not-executable'><span class='num'>807</span>        &#039;GraphService::insertEdge&#039;    =&gt; false,
</div><div class='line not-executable'><span class='num'>808</span>        &#039;GraphService::updateEdge&#039;    =&gt; false,
</div><div class='line not-executable'><span class='num'>809</span>        &#039;GraphService::deleteEdge&#039;    =&gt; false,
</div><div class='line not-executable'><span class='num'>810</span>
</div><div class='line not-executable'><span class='num'>811</span>        &#039;GraphService::insertAuditLog&#039; =&gt; false,
</div><div class='line not-executable'><span class='num'>812</span>    ];
</div><div class='line not-executable'><span class='num'>813</span>
</div><div class='line not-executable'><span class='num'>814</span>    private GraphDatabaseInterface $db;
</div><div class='line not-executable'><span class='num'>815</span>    private Logger $logger;
</div><div class='line not-executable'><span class='num'>816</span>
</div><div class='line not-executable'><span class='num'>817</span>    public function __construct(GraphDatabaseInterface $db, Logger $logger)
</div><div class='line not-executable'><span class='num'>818</span>    {
</div><div class='line covered'><span class='num'>819</span>        $this-&gt;db = $db;
</div><div class='line covered'><span class='num'>820</span>        $this-&gt;logger = $logger;
</div><div class='line covered'><span class='num'>821</span>    }
</div><div class='line not-executable'><span class='num'>822</span>
</div><div class='line not-executable'><span class='num'>823</span>    public function getUser(string $id): ?User
</div><div class='line not-executable'><span class='num'>824</span>    {
</div><div class='line not-covered'><span class='num'>825</span>        $data = $this-&gt;db-&gt;getUser($id);
</div><div class='line not-covered'><span class='num'>826</span>        if ($data) {
</div><div class='line not-covered'><span class='num'>827</span>            $user = new User($id, null, $data[&#039;user_group&#039;]);
</div><div class='line not-covered'><span class='num'>828</span>            return $user;
</div><div class='line not-executable'><span class='num'>829</span>        }
</div><div class='line not-covered'><span class='num'>830</span>        return null;
</div><div class='line not-covered'><span class='num'>831</span>    }
</div><div class='line not-executable'><span class='num'>832</span>
</div><div class='line not-executable'><span class='num'>833</span>    public function insertUser(User $user): void
</div><div class='line not-executable'><span class='num'>834</span>    {
</div><div class='line not-covered'><span class='num'>835</span>        $this-&gt;db-&gt;insertUser($user-&gt;id, $user-&gt;group-&gt;id);
</div><div class='line not-covered'><span class='num'>836</span>    }
</div><div class='line not-executable'><span class='num'>837</span>
</div><div class='line not-executable'><span class='num'>838</span>    public function updateUser(User $user): void
</div><div class='line not-executable'><span class='num'>839</span>    {
</div><div class='line not-covered'><span class='num'>840</span>        $this-&gt;db-&gt;updateUser($user-&gt;id, $user-&gt;group-&gt;id);
</div><div class='line not-covered'><span class='num'>841</span>    }
</div><div class='line not-executable'><span class='num'>842</span>
</div><div class='line not-executable'><span class='num'>843</span>    public function getGraph(): Graph
</div><div class='line not-executable'><span class='num'>844</span>    {
</div><div class='line not-covered'><span class='num'>845</span>        $nodes = $this-&gt;getNodes()-&gt;nodes;
</div><div class='line not-covered'><span class='num'>846</span>        $edges = $this-&gt;getEdges()-&gt;edges;
</div><div class='line not-covered'><span class='num'>847</span>        return new Graph($nodes, $edges);
</div><div class='line not-covered'><span class='num'>848</span>    }
</div><div class='line not-executable'><span class='num'>849</span>
</div><div class='line not-executable'><span class='num'>850</span>    public function getNode(string $id): ?Node
</div><div class='line not-executable'><span class='num'>851</span>    {
</div><div class='line covered'><span class='num'>852</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>853</span>            throw new RuntimeException(&quot;Permission denied to get node.&quot;);
</div><div class='line not-executable'><span class='num'>854</span>        }
</div><div class='line not-executable'><span class='num'>855</span>
</div><div class='line covered'><span class='num'>856</span>        $data = $this-&gt;db-&gt;getNode($id);
</div><div class='line covered'><span class='num'>857</span>        if ($data) {
</div><div class='line covered'><span class='num'>858</span>            return new Node(
</div><div class='line covered'><span class='num'>859</span>                $data[&#039;id&#039;],
</div><div class='line covered'><span class='num'>860</span>                $data[&#039;label&#039;],
</div><div class='line covered'><span class='num'>861</span>                $data[&#039;category&#039;],
</div><div class='line covered'><span class='num'>862</span>                $data[&#039;type&#039;],
</div><div class='line covered'><span class='num'>863</span>                json_decode($data[&#039;data&#039;], true)
</div><div class='line not-executable'><span class='num'>864</span>            );
</div><div class='line not-executable'><span class='num'>865</span>        }
</div><div class='line not-covered'><span class='num'>866</span>        return null;
</div><div class='line not-covered'><span class='num'>867</span>    }
</div><div class='line not-executable'><span class='num'>868</span>
</div><div class='line not-executable'><span class='num'>869</span>    public function getNodes(): Nodes
</div><div class='line not-executable'><span class='num'>870</span>    {
</div><div class='line not-covered'><span class='num'>871</span>        if(! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>872</span>            throw new RuntimeException(&quot;Permission denied to get nodes.&quot;);
</div><div class='line not-executable'><span class='num'>873</span>        }
</div><div class='line not-executable'><span class='num'>874</span>
</div><div class='line not-covered'><span class='num'>875</span>        $nodesData = $this-&gt;db-&gt;getNodes();
</div><div class='line not-covered'><span class='num'>876</span>        $nodes     = new Nodes();
</div><div class='line not-covered'><span class='num'>877</span>        foreach ($nodesData as $data) {
</div><div class='line not-covered'><span class='num'>878</span>            $node = new Node(
</div><div class='line not-covered'><span class='num'>879</span>                $data[&#039;id&#039;],
</div><div class='line not-covered'><span class='num'>880</span>                $data[&#039;label&#039;],
</div><div class='line not-covered'><span class='num'>881</span>                $data[&#039;category&#039;],
</div><div class='line not-covered'><span class='num'>882</span>                $data[&#039;type&#039;],
</div><div class='line not-covered'><span class='num'>883</span>                json_decode($data[&#039;data&#039;], true)
</div><div class='line not-executable'><span class='num'>884</span>            );
</div><div class='line not-covered'><span class='num'>885</span>            $nodes-&gt;addNode($node);
</div><div class='line not-executable'><span class='num'>886</span>        }
</div><div class='line not-covered'><span class='num'>887</span>        return $nodes;
</div><div class='line not-covered'><span class='num'>888</span>    }
</div><div class='line not-executable'><span class='num'>889</span>
</div><div class='line not-executable'><span class='num'>890</span>    public function insertNode(Node $node): void
</div><div class='line not-executable'><span class='num'>891</span>    {
</div><div class='line covered'><span class='num'>892</span>        $this-&gt;logger-&gt;debug(&#039;inserting node&#039;, $node-&gt;toArray());
</div><div class='line not-executable'><span class='num'>893</span>
</div><div class='line covered'><span class='num'>894</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>895</span>            $this-&gt;logger-&gt;info(&#039;permission denied&#039;, $node-&gt;toArray());
</div><div class='line not-covered'><span class='num'>896</span>            throw new GraphServiceException(&#039;permission denied&#039;);
</div><div class='line not-executable'><span class='num'>897</span>        }
</div><div class='line not-executable'><span class='num'>898</span>
</div><div class='line covered'><span class='num'>899</span>        $this-&gt;logger-&gt;info(&#039;permission allowed&#039;, $node-&gt;toArray());
</div><div class='line not-executable'><span class='num'>900</span>
</div><div class='line covered'><span class='num'>901</span>        $this-&gt;insertAuditLog(new AuditLog( &#039;node&#039;, $node-&gt;id, &#039;insert&#039;, null, $node-&gt;toArray()));
</div><div class='line not-executable'><span class='num'>902</span>
</div><div class='line covered'><span class='num'>903</span>        $this-&gt;db-&gt;insertNode(
</div><div class='line covered'><span class='num'>904</span>            $node-&gt;id,
</div><div class='line covered'><span class='num'>905</span>            $node-&gt;label,
</div><div class='line covered'><span class='num'>906</span>            $node-&gt;category,
</div><div class='line covered'><span class='num'>907</span>            $node-&gt;type,
</div><div class='line covered'><span class='num'>908</span>            $node-&gt;data
</div><div class='line not-executable'><span class='num'>909</span>        );
</div><div class='line covered'><span class='num'>910</span>    }
</div><div class='line not-executable'><span class='num'>911</span>
</div><div class='line not-executable'><span class='num'>912</span>    public function updateNode(Node $node): void
</div><div class='line not-executable'><span class='num'>913</span>    {
</div><div class='line not-covered'><span class='num'>914</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>915</span>            throw new RuntimeException(&quot;Permission denied to update node.&quot;);
</div><div class='line not-executable'><span class='num'>916</span>        }
</div><div class='line not-executable'><span class='num'>917</span>
</div><div class='line not-covered'><span class='num'>918</span>        $old = $this-&gt;getNode($node-&gt;id);
</div><div class='line not-covered'><span class='num'>919</span>        $this-&gt;insertAuditLog(new AuditLog( &#039;node&#039;, $node-&gt;id, &#039;update&#039;, $old-&gt;toArray(), $node-&gt;toArray()));
</div><div class='line not-executable'><span class='num'>920</span>
</div><div class='line not-covered'><span class='num'>921</span>        $this-&gt;db-&gt;updateNode(
</div><div class='line not-covered'><span class='num'>922</span>            $node-&gt;id,
</div><div class='line not-covered'><span class='num'>923</span>            $node-&gt;label,
</div><div class='line not-covered'><span class='num'>924</span>            $node-&gt;category,
</div><div class='line not-covered'><span class='num'>925</span>            $node-&gt;type,
</div><div class='line not-covered'><span class='num'>926</span>            $node-&gt;data
</div><div class='line not-executable'><span class='num'>927</span>        );
</div><div class='line not-covered'><span class='num'>928</span>    }
</div><div class='line not-executable'><span class='num'>929</span>
</div><div class='line not-executable'><span class='num'>930</span>    public function deleteNode(string $id): void
</div><div class='line not-executable'><span class='num'>931</span>    {
</div><div class='line not-covered'><span class='num'>932</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>933</span>            throw new RuntimeException(&quot;Permission denied to delete node.&quot;);
</div><div class='line not-executable'><span class='num'>934</span>        }
</div><div class='line not-executable'><span class='num'>935</span>
</div><div class='line not-covered'><span class='num'>936</span>        $old = $this-&gt;getNode($id);
</div><div class='line not-covered'><span class='num'>937</span>        $this-&gt;insertAuditLog(new AuditLog( &#039;node&#039;, $id, &#039;delete&#039;, $old-&gt;toArray(), null));
</div><div class='line not-covered'><span class='num'>938</span>        $this-&gt;db-&gt;deleteNode($id);
</div><div class='line not-covered'><span class='num'>939</span>    }
</div><div class='line not-executable'><span class='num'>940</span>
</div><div class='line not-executable'><span class='num'>941</span>    public function getEdge(string $source, string $target): ?Edge
</div><div class='line not-executable'><span class='num'>942</span>    {
</div><div class='line not-covered'><span class='num'>943</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>944</span>            throw new RuntimeException(&quot;Permission denied to get edge.&quot;);
</div><div class='line not-executable'><span class='num'>945</span>        }
</div><div class='line not-executable'><span class='num'>946</span>
</div><div class='line not-covered'><span class='num'>947</span>        $edgesData = $this-&gt;db-&gt;getEdges();
</div><div class='line not-covered'><span class='num'>948</span>        foreach ($edgesData as $data) {
</div><div class='line not-covered'><span class='num'>949</span>            if ($data[&#039;source&#039;] === $source &amp;&amp; $data[&#039;target&#039;] === $target) {
</div><div class='line not-covered'><span class='num'>950</span>                return new Edge(
</div><div class='line not-covered'><span class='num'>951</span>                    $data[&#039;id&#039;],
</div><div class='line not-covered'><span class='num'>952</span>                    $data[&#039;source&#039;],
</div><div class='line not-covered'><span class='num'>953</span>                    $data[&#039;target&#039;],
</div><div class='line not-covered'><span class='num'>954</span>                    json_decode($data[&#039;data&#039;], true)
</div><div class='line not-executable'><span class='num'>955</span>                );
</div><div class='line not-executable'><span class='num'>956</span>            }
</div><div class='line not-executable'><span class='num'>957</span>        }
</div><div class='line not-covered'><span class='num'>958</span>        return null;
</div><div class='line not-covered'><span class='num'>959</span>    }
</div><div class='line not-executable'><span class='num'>960</span>
</div><div class='line not-executable'><span class='num'>961</span>    public function getEdges(): Edges
</div><div class='line not-executable'><span class='num'>962</span>    {
</div><div class='line not-covered'><span class='num'>963</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>964</span>            throw new RuntimeException(&quot;Permission denied to get edges.&quot;);
</div><div class='line not-executable'><span class='num'>965</span>        }
</div><div class='line not-covered'><span class='num'>966</span>        $edgesData = $this-&gt;db-&gt;getEdges();
</div><div class='line not-covered'><span class='num'>967</span>        $edges     = new Edges();
</div><div class='line not-covered'><span class='num'>968</span>        foreach ($edgesData as $data) {
</div><div class='line not-covered'><span class='num'>969</span>            $edge = new Edge(
</div><div class='line not-covered'><span class='num'>970</span>                $data[&#039;id&#039;],
</div><div class='line not-covered'><span class='num'>971</span>                $data[&#039;source&#039;],
</div><div class='line not-covered'><span class='num'>972</span>                $data[&#039;target&#039;],
</div><div class='line not-covered'><span class='num'>973</span>                json_decode($data[&#039;data&#039;], true)
</div><div class='line not-executable'><span class='num'>974</span>            );
</div><div class='line not-covered'><span class='num'>975</span>            $edges-&gt;addEdge($edge);
</div><div class='line not-executable'><span class='num'>976</span>        }
</div><div class='line not-covered'><span class='num'>977</span>        return $edges;
</div><div class='line not-covered'><span class='num'>978</span>    }
</div><div class='line not-executable'><span class='num'>979</span>
</div><div class='line not-executable'><span class='num'>980</span>    public function insertEdge(Edge $edge): void
</div><div class='line not-executable'><span class='num'>981</span>    {
</div><div class='line covered'><span class='num'>982</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>983</span>            throw new RuntimeException(&quot;Permission denied to insert edge.&quot;);
</div><div class='line not-executable'><span class='num'>984</span>        }
</div><div class='line covered'><span class='num'>985</span>        $this-&gt;insertAuditLog(new AuditLog( &#039;edge&#039;, $edge-&gt;id, &#039;insert&#039;, null, $edge-&gt;toArray()));
</div><div class='line covered'><span class='num'>986</span>        $this-&gt;db-&gt;insertEdge(
</div><div class='line covered'><span class='num'>987</span>            $edge-&gt;id,
</div><div class='line covered'><span class='num'>988</span>            $edge-&gt;source,
</div><div class='line covered'><span class='num'>989</span>            $edge-&gt;target,
</div><div class='line covered'><span class='num'>990</span>            $edge-&gt;data
</div><div class='line not-executable'><span class='num'>991</span>        );
</div><div class='line covered'><span class='num'>992</span>    }
</div><div class='line not-executable'><span class='num'>993</span>
</div><div class='line not-executable'><span class='num'>994</span>    public function updateEdge(Edge $edge): void
</div><div class='line not-executable'><span class='num'>995</span>    {
</div><div class='line not-covered'><span class='num'>996</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>997</span>            throw new RuntimeException(&quot;Permission denied to update edge.&quot;);
</div><div class='line not-executable'><span class='num'>998</span>        }
</div><div class='line not-covered'><span class='num'>999</span>        $old = $this-&gt;getEdge($edge-&gt;source, $edge-&gt;target);
</div><div class='line not-covered'><span class='num'>1000</span>        $this-&gt;insertAuditLog(new AuditLog( &#039;edge&#039;, $edge-&gt;id, &#039;update&#039;, $old-&gt;toArray(), $edge-&gt;toArray()));
</div><div class='line not-executable'><span class='num'>1001</span>
</div><div class='line not-covered'><span class='num'>1002</span>        $this-&gt;db-&gt;updateEdge(
</div><div class='line not-covered'><span class='num'>1003</span>            $edge-&gt;id,
</div><div class='line not-covered'><span class='num'>1004</span>            $edge-&gt;source,
</div><div class='line not-covered'><span class='num'>1005</span>            $edge-&gt;target,
</div><div class='line not-covered'><span class='num'>1006</span>            $edge-&gt;data
</div><div class='line not-executable'><span class='num'>1007</span>        );
</div><div class='line not-covered'><span class='num'>1008</span>    }
</div><div class='line not-executable'><span class='num'>1009</span>
</div><div class='line not-executable'><span class='num'>1010</span>    public function deleteEdge(string $id): void
</div><div class='line not-executable'><span class='num'>1011</span>    {
</div><div class='line not-covered'><span class='num'>1012</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>1013</span>            throw new RuntimeException(&quot;Permission denied to delete edge.&quot;);
</div><div class='line not-executable'><span class='num'>1014</span>        }
</div><div class='line not-covered'><span class='num'>1015</span>        $this-&gt;db-&gt;deleteEdge($id);
</div><div class='line not-covered'><span class='num'>1016</span>    }
</div><div class='line not-executable'><span class='num'>1017</span>
</div><div class='line not-executable'><span class='num'>1018</span>    public function getStatuses(): NodeStatuses
</div><div class='line not-executable'><span class='num'>1019</span>    {
</div><div class='line not-covered'><span class='num'>1020</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>1021</span>            throw new RuntimeException(&quot;Permission denied to get statuses.&quot;);
</div><div class='line not-executable'><span class='num'>1022</span>        }
</div><div class='line not-executable'><span class='num'>1023</span>
</div><div class='line not-covered'><span class='num'>1024</span>        $statusesData = $this-&gt;db-&gt;getStatuses();
</div><div class='line not-covered'><span class='num'>1025</span>        $nodeStatuses = new NodeStatuses();
</div><div class='line not-covered'><span class='num'>1026</span>        foreach ($statusesData as $data) {
</div><div class='line not-covered'><span class='num'>1027</span>            $status = new NodeStatus(
</div><div class='line not-covered'><span class='num'>1028</span>                $data[&#039;id&#039;],
</div><div class='line not-covered'><span class='num'>1029</span>                $data[&#039;status&#039;] ?? &#039;unknown&#039;
</div><div class='line not-executable'><span class='num'>1030</span>            );
</div><div class='line not-covered'><span class='num'>1031</span>            $nodeStatuses-&gt;addStatus($status);
</div><div class='line not-executable'><span class='num'>1032</span>        }
</div><div class='line not-covered'><span class='num'>1033</span>        return $nodeStatuses;
</div><div class='line not-covered'><span class='num'>1034</span>    }
</div><div class='line not-executable'><span class='num'>1035</span>
</div><div class='line not-executable'><span class='num'>1036</span>    public function getNodeStatus(string $id): NodeStatus
</div><div class='line not-executable'><span class='num'>1037</span>    {
</div><div class='line not-covered'><span class='num'>1038</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>1039</span>            throw new RuntimeException(&quot;Permission denied to get node status.&quot;);
</div><div class='line not-executable'><span class='num'>1040</span>        }
</div><div class='line not-executable'><span class='num'>1041</span>
</div><div class='line not-covered'><span class='num'>1042</span>        $statusData = $this-&gt;db-&gt;getNodeStatus($id);
</div><div class='line not-covered'><span class='num'>1043</span>        return new NodeStatus(
</div><div class='line not-covered'><span class='num'>1044</span>            $id,
</div><div class='line not-covered'><span class='num'>1045</span>            $statusData ?? &#039;unknown&#039;
</div><div class='line not-executable'><span class='num'>1046</span>        );
</div><div class='line not-covered'><span class='num'>1047</span>    }
</div><div class='line not-executable'><span class='num'>1048</span>
</div><div class='line not-executable'><span class='num'>1049</span>    public function setNodeStatus(NodeStatus $status): void
</div><div class='line not-executable'><span class='num'>1050</span>    {
</div><div class='line not-covered'><span class='num'>1051</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>1052</span>            throw new RuntimeException(&quot;Permission denied to set node status.&quot;);
</div><div class='line not-executable'><span class='num'>1053</span>        }
</div><div class='line not-executable'><span class='num'>1054</span>
</div><div class='line not-covered'><span class='num'>1055</span>        $this-&gt;db-&gt;setNodeStatus($status-&gt;nodeId, $status-&gt;status);
</div><div class='line not-covered'><span class='num'>1056</span>    }
</div><div class='line not-executable'><span class='num'>1057</span>
</div><div class='line not-executable'><span class='num'>1058</span>    public function getLogs($limit): AuditLogs
</div><div class='line not-executable'><span class='num'>1059</span>    {
</div><div class='line not-covered'><span class='num'>1060</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>1061</span>            throw new RuntimeException(&quot;Permission denied to get audit logs.&quot;);
</div><div class='line not-executable'><span class='num'>1062</span>        }
</div><div class='line not-executable'><span class='num'>1063</span>
</div><div class='line not-covered'><span class='num'>1064</span>        $logs = new AuditLogs();
</div><div class='line not-covered'><span class='num'>1065</span>        $rows = $this-&gt;db-&gt;getLogs($limit);
</div><div class='line not-covered'><span class='num'>1066</span>        foreach ($rows as $row) {
</div><div class='line not-covered'><span class='num'>1067</span>            $old_data = $row[&#039;old_data&#039;] ? json_decode($row[&#039;old_data&#039;], true) : [];
</div><div class='line not-covered'><span class='num'>1068</span>            $new_data = $row[&#039;new_data&#039;] ?  json_decode($row[&#039;new_data&#039;], true) : [];
</div><div class='line not-covered'><span class='num'>1069</span>            $log = new AuditLog(
</div><div class='line not-covered'><span class='num'>1070</span>                $row[&#039;entity_type&#039;],
</div><div class='line not-covered'><span class='num'>1071</span>                $row[&#039;entity_id&#039;],
</div><div class='line not-covered'><span class='num'>1072</span>                $row[&#039;action&#039;],
</div><div class='line not-executable'><span class='num'>1073</span>                $old_data,
</div><div class='line not-executable'><span class='num'>1074</span>                $new_data,
</div><div class='line not-executable'><span class='num'>1075</span>            );
</div><div class='line not-covered'><span class='num'>1076</span>            $log-&gt;userId    = $row[&#039;user_id&#039;];
</div><div class='line not-covered'><span class='num'>1077</span>            $log-&gt;ipAddress = $row[&#039;ip_address&#039;];
</div><div class='line not-covered'><span class='num'>1078</span>            $log-&gt;createdAt = $row[&#039;created_at&#039;];
</div><div class='line not-executable'><span class='num'>1079</span>
</div><div class='line not-covered'><span class='num'>1080</span>            $logs-&gt;addLog($log);
</div><div class='line not-executable'><span class='num'>1081</span>        }
</div><div class='line not-covered'><span class='num'>1082</span>        return $logs;
</div><div class='line not-covered'><span class='num'>1083</span>    }
</div><div class='line not-executable'><span class='num'>1084</span>
</div><div class='line not-executable'><span class='num'>1085</span>    private function insertAuditLog(AuditLog $auditLog): void
</div><div class='line not-executable'><span class='num'>1086</span>    {
</div><div class='line covered'><span class='num'>1087</span>        $user_id   = GraphContext::$user-&gt;id;
</div><div class='line covered'><span class='num'>1088</span>        $ip_address = GraphContext::$user-&gt;ipAddress;
</div><div class='line not-executable'><span class='num'>1089</span>
</div><div class='line covered'><span class='num'>1090</span>        $this-&gt;db-&gt;insertAuditLog(
</div><div class='line covered'><span class='num'>1091</span>            $auditLog-&gt;entityType,
</div><div class='line covered'><span class='num'>1092</span>            $auditLog-&gt;entityId,
</div><div class='line covered'><span class='num'>1093</span>            $auditLog-&gt;action,
</div><div class='line covered'><span class='num'>1094</span>            $auditLog-&gt;oldData,
</div><div class='line covered'><span class='num'>1095</span>            $auditLog-&gt;newData,
</div><div class='line not-executable'><span class='num'>1096</span>            $user_id,
</div><div class='line not-executable'><span class='num'>1097</span>            $ip_address
</div><div class='line not-executable'><span class='num'>1098</span>        );
</div><div class='line covered'><span class='num'>1099</span>    }
</div><div class='line not-executable'><span class='num'>1100</span>
</div><div class='line not-executable'><span class='num'>1101</span>    private function isAllowed(string $action): bool
</div><div class='line not-executable'><span class='num'>1102</span>    {
</div><div class='line covered'><span class='num'>1103</span>        $group = GraphContext::$user-&gt;group;
</div><div class='line not-executable'><span class='num'>1104</span>
</div><div class='line not-executable'><span class='num'>1105</span>        // validate action
</div><div class='line not-executable'><span class='num'>1106</span>        // if action is one of the keys in the array self::SECURE_ACTIONS
</div><div class='line covered'><span class='num'>1107</span>        if (!array_key_exists($action, self::SECURE_ACTIONS)) {
</div><div class='line not-covered'><span class='num'>1108</span>            throw new RuntimeException(&quot;Action not defined in secure actions. Action: {$action}&quot;);
</div><div class='line not-executable'><span class='num'>1109</span>        }
</div><div class='line not-executable'><span class='num'>1110</span>
</div><div class='line not-executable'><span class='num'>1111</span>        // if is admin, allow all
</div><div class='line covered'><span class='num'>1112</span>        if ($group-&gt;id === &#039;admin&#039;) {
</div><div class='line not-covered'><span class='num'>1113</span>            return true;
</div><div class='line not-executable'><span class='num'>1114</span>        }
</div><div class='line not-executable'><span class='num'>1115</span>
</div><div class='line not-executable'><span class='num'>1116</span>        // if action is in the SAFE_ACTIONS, allow all
</div><div class='line covered'><span class='num'>1117</span>        if (self::SECURE_ACTIONS[$action]) {
</div><div class='line covered'><span class='num'>1118</span>            return true;
</div><div class='line not-executable'><span class='num'>1119</span>        }
</div><div class='line not-executable'><span class='num'>1120</span>        
</div><div class='line not-executable'><span class='num'>1121</span>        // if action is restricted, only allow contributor
</div><div class='line covered'><span class='num'>1122</span>        if (self::SECURE_ACTIONS[$action] == false &amp;&amp; $group-&gt;id == &#039;contributor&#039;)
</div><div class='line not-executable'><span class='num'>1123</span>        {
</div><div class='line covered'><span class='num'>1124</span>            return true;
</div><div class='line not-executable'><span class='num'>1125</span>        }
</div><div class='line not-executable'><span class='num'>1126</span>
</div><div class='line not-covered'><span class='num'>1127</span>        return false;
</div><div class='line not-covered'><span class='num'>1128</span>    }
</div><div class='line not-executable'><span class='num'>1129</span>}
</div><div class='line not-executable'><span class='num'>1130</span>
</div><div class='line not-executable'><span class='num'>1131</span>final class Request
</div><div class='line not-executable'><span class='num'>1132</span>{
</div><div class='line not-executable'><span class='num'>1133</span>    public array $data;
</div><div class='line not-executable'><span class='num'>1134</span>
</div><div class='line not-executable'><span class='num'>1135</span>    public function getParam($name): string
</div><div class='line not-executable'><span class='num'>1136</span>    {
</div><div class='line covered'><span class='num'>1137</span>        if(isset($_GET[$name])) {
</div><div class='line covered'><span class='num'>1138</span>            return $_GET[$name];
</div><div class='line not-executable'><span class='num'>1139</span>        }
</div><div class='line not-executable'><span class='num'>1140</span>
</div><div class='line not-covered'><span class='num'>1141</span>        throw new RuntimeException(&quot;param &#039;{$name}&#039; not found&quot;);
</div><div class='line not-covered'><span class='num'>1142</span>    }
</div><div class='line not-executable'><span class='num'>1143</span>
</div><div class='line not-executable'><span class='num'>1144</span>    public function getPath(): string
</div><div class='line not-executable'><span class='num'>1145</span>    {
</div><div class='line not-covered'><span class='num'>1146</span>        $scriptName = $_SERVER[&#039;SCRIPT_NAME&#039;];
</div><div class='line not-covered'><span class='num'>1147</span>        $requestUri = $_SERVER[&#039;REQUEST_URI&#039;];
</div><div class='line not-covered'><span class='num'>1148</span>        $requestUri = strtok($requestUri, &#039;?&#039;);
</div><div class='line not-covered'><span class='num'>1149</span>        $path = str_replace($scriptName, &#039;&#039;, $requestUri);
</div><div class='line not-covered'><span class='num'>1150</span>        return $path;
</div><div class='line not-covered'><span class='num'>1151</span>    }
</div><div class='line not-executable'><span class='num'>1152</span>}
</div><div class='line not-executable'><span class='num'>1153</span>
</div><div class='line not-executable'><span class='num'>1154</span>interface ResponseInterface
</div><div class='line not-executable'><span class='num'>1155</span>{
</div><div class='line not-executable'><span class='num'>1156</span>    public function send(): void;
</div><div class='line not-executable'><span class='num'>1157</span>}
</div><div class='line not-executable'><span class='num'>1158</span>
</div><div class='line not-executable'><span class='num'>1159</span>class Response implements ResponseInterface
</div><div class='line not-executable'><span class='num'>1160</span>{
</div><div class='line not-executable'><span class='num'>1161</span>    public int $code;
</div><div class='line not-executable'><span class='num'>1162</span>    public string $status;
</div><div class='line not-executable'><span class='num'>1163</span>    public string $message;
</div><div class='line not-executable'><span class='num'>1164</span>    public array $data;
</div><div class='line not-executable'><span class='num'>1165</span>
</div><div class='line not-executable'><span class='num'>1166</span>    public function __construct(int $code, string $status, string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1167</span>    {
</div><div class='line covered'><span class='num'>1168</span>        $this-&gt;code = $code;
</div><div class='line covered'><span class='num'>1169</span>        $this-&gt;status = $status;
</div><div class='line covered'><span class='num'>1170</span>        $this-&gt;message = $message;
</div><div class='line covered'><span class='num'>1171</span>        $this-&gt;data = $data;
</div><div class='line covered'><span class='num'>1172</span>    }
</div><div class='line not-executable'><span class='num'>1173</span>
</div><div class='line not-executable'><span class='num'>1174</span>    public function send(): void
</div><div class='line not-executable'><span class='num'>1175</span>    {
</div><div class='line not-covered'><span class='num'>1176</span>        header(&#039;Content-Type: application/json; charset=utf-8&#039;);
</div><div class='line not-covered'><span class='num'>1177</span>        http_response_code($this-&gt;code);
</div><div class='line not-covered'><span class='num'>1178</span>        $this-&gt;data = [&#039;code&#039; =&gt; $this-&gt;code, &#039;status&#039; =&gt; $this-&gt;status, &#039;message&#039; =&gt; $this-&gt;message, &#039;data&#039; =&gt; $this-&gt;data];
</div><div class='line not-covered'><span class='num'>1179</span>        echo json_encode($this-&gt;data, JSON_UNESCAPED_UNICODE |  JSON_UNESCAPED_SLASHES |  JSON_PRETTY_PRINT);
</div><div class='line not-covered'><span class='num'>1180</span>    }
</div><div class='line not-executable'><span class='num'>1181</span>}
</div><div class='line not-executable'><span class='num'>1182</span>
</div><div class='line not-executable'><span class='num'>1183</span>class OKResponse extends Response
</div><div class='line not-executable'><span class='num'>1184</span>{
</div><div class='line not-executable'><span class='num'>1185</span>    public function __construct(string $message, array $data)
</div><div class='line not-executable'><span class='num'>1186</span>    {
</div><div class='line covered'><span class='num'>1187</span>        return parent::__construct(200, &#039;success&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1188</span>    }
</div><div class='line not-executable'><span class='num'>1189</span>}
</div><div class='line not-executable'><span class='num'>1190</span>
</div><div class='line not-executable'><span class='num'>1191</span>class CreatedResponse extends Response
</div><div class='line not-executable'><span class='num'>1192</span>{
</div><div class='line not-executable'><span class='num'>1193</span>    public function __construct(string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1194</span>    {
</div><div class='line covered'><span class='num'>1195</span>        return parent::__construct(201, &#039;success&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1196</span>    }
</div><div class='line not-executable'><span class='num'>1197</span>}
</div><div class='line not-executable'><span class='num'>1198</span>
</div><div class='line not-executable'><span class='num'>1199</span>class BadRequestResponse extends Response
</div><div class='line not-executable'><span class='num'>1200</span>{
</div><div class='line not-executable'><span class='num'>1201</span>    public function __construct(string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1202</span>    {
</div><div class='line not-covered'><span class='num'>1203</span>        return parent::__construct(400, &#039;error&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1204</span>    }
</div><div class='line not-executable'><span class='num'>1205</span>}
</div><div class='line not-executable'><span class='num'>1206</span>
</div><div class='line not-executable'><span class='num'>1207</span>class UnauthorizedResponse extends Response
</div><div class='line not-executable'><span class='num'>1208</span>{
</div><div class='line not-executable'><span class='num'>1209</span>    public function __construct(string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1210</span>    {
</div><div class='line not-covered'><span class='num'>1211</span>        return parent::__construct(401, &#039;error&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1212</span>    }
</div><div class='line not-executable'><span class='num'>1213</span>}
</div><div class='line not-executable'><span class='num'>1214</span>
</div><div class='line not-executable'><span class='num'>1215</span>class ForbiddenResponse extends Response
</div><div class='line not-executable'><span class='num'>1216</span>{
</div><div class='line not-executable'><span class='num'>1217</span>    public function __construct(string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1218</span>    {
</div><div class='line not-covered'><span class='num'>1219</span>        return parent::__construct(403, &#039;error&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1220</span>    }
</div><div class='line not-executable'><span class='num'>1221</span>}
</div><div class='line not-executable'><span class='num'>1222</span>
</div><div class='line not-executable'><span class='num'>1223</span>class NotFoundResponse extends Response
</div><div class='line not-executable'><span class='num'>1224</span>{
</div><div class='line not-executable'><span class='num'>1225</span>    public function __construct(string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1226</span>    {
</div><div class='line not-covered'><span class='num'>1227</span>        return parent::__construct(404, &#039;error&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1228</span>    }
</div><div class='line not-executable'><span class='num'>1229</span>}
</div><div class='line not-executable'><span class='num'>1230</span>
</div><div class='line not-executable'><span class='num'>1231</span>class InternalServerErrorResponse extends Response
</div><div class='line not-executable'><span class='num'>1232</span>{
</div><div class='line not-executable'><span class='num'>1233</span>    public function __construct(string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1234</span>    {
</div><div class='line not-covered'><span class='num'>1235</span>        return parent::__construct(500, &#039;error&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1236</span>    }
</div><div class='line not-executable'><span class='num'>1237</span>}
</div><div class='line not-executable'><span class='num'>1238</span>
</div><div class='line not-executable'><span class='num'>1239</span>interface GraphControllerInterface
</div><div class='line not-executable'><span class='num'>1240</span>{
</div><div class='line not-executable'><span class='num'>1241</span>    public function getUser(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1242</span>    public function insertUser(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1243</span>    public function updateUser(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1244</span>
</div><div class='line not-executable'><span class='num'>1245</span>    public function getGraph(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1246</span>
</div><div class='line not-executable'><span class='num'>1247</span>    public function getNode(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1248</span>    public function getNodes(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1249</span>    public function insertNode(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1250</span>    public function updateNode(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1251</span>    public function deleteNode(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1252</span>
</div><div class='line not-executable'><span class='num'>1253</span>    public function getEdge(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1254</span>    public function getEdges(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1255</span>    public function insertEdge(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1256</span>    public function updateEdge(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1257</span>    public function deleteEdge(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1258</span>
</div><div class='line not-executable'><span class='num'>1259</span>    public function getStatuses(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1260</span>    public function getNodeStatus(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1261</span>    public function setNodeStatus(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1262</span>
</div><div class='line not-executable'><span class='num'>1263</span>    public function getLogs(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1264</span>}
</div><div class='line not-executable'><span class='num'>1265</span>
</div><div class='line not-executable'><span class='num'>1266</span>final class GraphControllerException extends RuntimeException
</div><div class='line not-executable'><span class='num'>1267</span>{
</div><div class='line not-executable'><span class='num'>1268</span>}
</div><div class='line not-executable'><span class='num'>1269</span>
</div><div class='line not-executable'><span class='num'>1270</span>final class GraphController implements GraphControllerInterface
</div><div class='line not-executable'><span class='num'>1271</span>{
</div><div class='line not-executable'><span class='num'>1272</span>    private GraphServiceInterface $service;
</div><div class='line not-executable'><span class='num'>1273</span>    private Logger $logger;
</div><div class='line not-executable'><span class='num'>1274</span>
</div><div class='line not-executable'><span class='num'>1275</span>    public function __construct(GraphServiceInterface $service, Logger $logger)
</div><div class='line not-executable'><span class='num'>1276</span>    {
</div><div class='line covered'><span class='num'>1277</span>        $this-&gt;service = $service;
</div><div class='line covered'><span class='num'>1278</span>        $this-&gt;logger = $logger;
</div><div class='line covered'><span class='num'>1279</span>    }
</div><div class='line not-executable'><span class='num'>1280</span>
</div><div class='line not-executable'><span class='num'>1281</span>    public function getUser(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1282</span>    {
</div><div class='line not-covered'><span class='num'>1283</span>        $data = $this-&gt;service-&gt;getUser($req-&gt;data[&#039;id&#039;]);
</div><div class='line not-covered'><span class='num'>1284</span>        $user = new User($data[&#039;id&#039;], null, new Group($data[&#039;user_group&#039;]));
</div><div class='line not-covered'><span class='num'>1285</span>        return new OKResponse(&#039;user found&#039;, $user-&gt;toArray());
</div><div class='line not-covered'><span class='num'>1286</span>    }
</div><div class='line not-executable'><span class='num'>1287</span>
</div><div class='line not-executable'><span class='num'>1288</span>    public function insertUser(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1289</span>    {
</div><div class='line not-covered'><span class='num'>1290</span>        $user = new User($req-&gt;data[&#039;id&#039;], null, $req-&gt;data[&#039;user_group&#039;]);
</div><div class='line not-covered'><span class='num'>1291</span>        $this-&gt;service-&gt;insertUser($user);
</div><div class='line not-covered'><span class='num'>1292</span>        return new OKResponse(&#039;user created&#039;, $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1293</span>    }
</div><div class='line not-executable'><span class='num'>1294</span>
</div><div class='line not-executable'><span class='num'>1295</span>    public function updateUser(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1296</span>    {
</div><div class='line not-covered'><span class='num'>1297</span>        $user = new User($req-&gt;data[&#039;id&#039;], null, $req-&gt;data[&#039;user_group&#039;]);
</div><div class='line not-covered'><span class='num'>1298</span>        $this-&gt;service-&gt;updateUser($user);
</div><div class='line not-covered'><span class='num'>1299</span>        return new CreatedResponse(&#039;user updated&#039;, $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1300</span>    }
</div><div class='line not-executable'><span class='num'>1301</span>
</div><div class='line not-executable'><span class='num'>1302</span>    public function getGraph(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1303</span>    {
</div><div class='line not-executable'><span class='num'>1304</span>        try {
</div><div class='line not-covered'><span class='num'>1305</span>            $data = $this-&gt;service-&gt;getGraph()-&gt;toArray();
</div><div class='line not-covered'><span class='num'>1306</span>            return new OKResponse(&#039;get graph&#039;, $data);
</div><div class='line not-covered'><span class='num'>1307</span>            return $resp;
</div><div class='line not-covered'><span class='num'>1308</span>        } catch (Exception $e) {
</div><div class='line not-covered'><span class='num'>1309</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1310</span>        }
</div><div class='line not-executable'><span class='num'>1311</span>
</div><div class='line not-covered'><span class='num'>1312</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1313</span>    }
</div><div class='line not-executable'><span class='num'>1314</span>
</div><div class='line not-executable'><span class='num'>1315</span>    public function getNode(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1316</span>    {
</div><div class='line not-executable'><span class='num'>1317</span>        try {
</div><div class='line covered'><span class='num'>1318</span>            $id = $req-&gt;getParam(&#039;id&#039;);
</div><div class='line covered'><span class='num'>1319</span>            $node = $this-&gt;service-&gt;getNode($id);
</div><div class='line covered'><span class='num'>1320</span>            $data = $node-&gt;toArray();
</div><div class='line covered'><span class='num'>1321</span>            return new OKResponse(&#039;node found&#039;, $data);
</div><div class='line not-covered'><span class='num'>1322</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1323</span>        {
</div><div class='line not-covered'><span class='num'>1324</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1325</span>        }
</div><div class='line not-executable'><span class='num'>1326</span>
</div><div class='line not-covered'><span class='num'>1327</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1328</span>    }
</div><div class='line not-executable'><span class='num'>1329</span>
</div><div class='line not-executable'><span class='num'>1330</span>    public function getNodes(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1331</span>    {
</div><div class='line not-executable'><span class='num'>1332</span>        try {
</div><div class='line not-covered'><span class='num'>1333</span>            $nodes = $this-&gt;service-&gt;getNodes();
</div><div class='line not-executable'><span class='num'>1334</span>            // TODO: corrigir
</div><div class='line not-covered'><span class='num'>1335</span>            return new OKResponse(&#039;nodes found&#039;, []);
</div><div class='line not-covered'><span class='num'>1336</span>            return $resp;
</div><div class='line not-covered'><span class='num'>1337</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1338</span>        {
</div><div class='line not-covered'><span class='num'>1339</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1340</span>        }
</div><div class='line not-executable'><span class='num'>1341</span>        
</div><div class='line not-covered'><span class='num'>1342</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1343</span>    }
</div><div class='line not-executable'><span class='num'>1344</span>
</div><div class='line not-executable'><span class='num'>1345</span>    public function insertNode(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1346</span>    {
</div><div class='line covered'><span class='num'>1347</span>        $this-&gt;logger-&gt;debug(&#039;inserting node&#039;, $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1348</span>        try {
</div><div class='line covered'><span class='num'>1349</span>            $node = new Node($req-&gt;data[&#039;id&#039;], $req-&gt;data[&#039;label&#039;], $req-&gt;data[&#039;category&#039;], $req-&gt;data[&#039;type&#039;], $req-&gt;data[&#039;data&#039;]);
</div><div class='line covered'><span class='num'>1350</span>            $this-&gt;service-&gt;insertNode($node);
</div><div class='line covered'><span class='num'>1351</span>            $this-&gt;logger-&gt;info(&#039;node inserted&#039;, $req-&gt;data);
</div><div class='line covered'><span class='num'>1352</span>            return new CreatedResponse(&#039;node inserted&#039;, $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1353</span>        } catch( GraphServiceException $e)
</div><div class='line not-executable'><span class='num'>1354</span>        {
</div><div class='line not-covered'><span class='num'>1355</span>            $this-&gt;logger-&gt;error(&#039;The service could not insert new node:&#039; . $e-&gt;getMessage());
</div><div class='line not-covered'><span class='num'>1356</span>            throw new GraphControllerException(&#039;The service could not insert new node:&#039; . $e-&gt;getMessage(), 0, $e);
</div><div class='line not-executable'><span class='num'>1357</span>        }
</div><div class='line not-covered'><span class='num'>1358</span>        return new InternalServerErrorResponse(&#039;unknow error inserting node&#039;, $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1359</span>    }
</div><div class='line not-executable'><span class='num'>1360</span>    
</div><div class='line not-executable'><span class='num'>1361</span>    public function updateNode(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1362</span>    {
</div><div class='line covered'><span class='num'>1363</span>        $this-&gt;logger-&gt;debug(&#039;updating node&#039;, $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1364</span>
</div><div class='line not-executable'><span class='num'>1365</span>        try {
</div><div class='line covered'><span class='num'>1366</span>            $edge = new Edge($req-&gt;data[&#039;id&#039;], $req-&gt;data[&#039;category&#039;], $req-&gt;data[&#039;type&#039;], $req-&gt;data[&#039;data&#039;]);
</div><div class='line covered'><span class='num'>1367</span>            $this-&gt;service-&gt;insertEdge($edge);
</div><div class='line covered'><span class='num'>1368</span>            $this-&gt;logger-&gt;info(&#039;edge inserted&#039;, $req-&gt;data);
</div><div class='line covered'><span class='num'>1369</span>            $resp = new CreatedResponse(&#039;edge created&#039;, $req-&gt;data);
</div><div class='line covered'><span class='num'>1370</span>            return $resp;
</div><div class='line not-covered'><span class='num'>1371</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1372</span>        {
</div><div class='line not-covered'><span class='num'>1373</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1374</span>        }
</div><div class='line not-executable'><span class='num'>1375</span>        
</div><div class='line not-covered'><span class='num'>1376</span>        return new InternalServerErrorResponse(&#039;unknow todo in updateNode&#039;, $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1377</span>    }
</div><div class='line not-executable'><span class='num'>1378</span>    
</div><div class='line not-executable'><span class='num'>1379</span>    public function deleteNode(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1380</span>    {
</div><div class='line not-executable'><span class='num'>1381</span>        try {
</div><div class='line not-covered'><span class='num'>1382</span>            $this-&gt;service-&gt;deleteEdge($req-&gt;data[&#039;id&#039;]);
</div><div class='line not-covered'><span class='num'>1383</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1384</span>        {
</div><div class='line not-covered'><span class='num'>1385</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1386</span>        }
</div><div class='line not-executable'><span class='num'>1387</span>        
</div><div class='line not-covered'><span class='num'>1388</span>        return new InternalServerErrorResponse(&#039;unknow todo in deleteNode&#039;, $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1389</span>    }
</div><div class='line not-executable'><span class='num'>1390</span>
</div><div class='line not-executable'><span class='num'>1391</span>    public function getEdge(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1392</span>    {
</div><div class='line not-executable'><span class='num'>1393</span>        try {
</div><div class='line not-covered'><span class='num'>1394</span>            $edge = $this-&gt;service-&gt;getEdge($req-&gt;data[&#039;source&#039;], $req-&gt;data[&#039;target&#039;]);
</div><div class='line not-covered'><span class='num'>1395</span>            $data = $edge-&gt;toArray();
</div><div class='line not-covered'><span class='num'>1396</span>            return new OKResponse(&#039;node found&#039;, $data);
</div><div class='line not-covered'><span class='num'>1397</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1398</span>        {
</div><div class='line not-covered'><span class='num'>1399</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1400</span>        }
</div><div class='line not-executable'><span class='num'>1401</span>        
</div><div class='line not-covered'><span class='num'>1402</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1403</span>    }
</div><div class='line not-executable'><span class='num'>1404</span>    
</div><div class='line not-executable'><span class='num'>1405</span>    public function getEdges(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1406</span>    {
</div><div class='line not-executable'><span class='num'>1407</span>        try {
</div><div class='line not-covered'><span class='num'>1408</span>            $edges = $this-&gt;service-&gt;getEdges();
</div><div class='line not-executable'><span class='num'>1409</span>            // TODO: corrigir
</div><div class='line not-covered'><span class='num'>1410</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1411</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1412</span>        {
</div><div class='line not-covered'><span class='num'>1413</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1414</span>        }
</div><div class='line not-executable'><span class='num'>1415</span>        
</div><div class='line not-covered'><span class='num'>1416</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1417</span>    }
</div><div class='line not-executable'><span class='num'>1418</span>    
</div><div class='line not-executable'><span class='num'>1419</span>    public function insertEdge(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1420</span>    {
</div><div class='line not-executable'><span class='num'>1421</span>        try {
</div><div class='line not-covered'><span class='num'>1422</span>            $edge = new Edge(null, $req-&gt;data[&#039;source&#039;], $req-&gt;data[&#039;target&#039;]);
</div><div class='line not-covered'><span class='num'>1423</span>            $this-&gt;service-&gt;insertEdge($edge);
</div><div class='line not-covered'><span class='num'>1424</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1425</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1426</span>        {
</div><div class='line not-covered'><span class='num'>1427</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1428</span>        }
</div><div class='line not-executable'><span class='num'>1429</span>        
</div><div class='line not-covered'><span class='num'>1430</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1431</span>    }
</div><div class='line not-executable'><span class='num'>1432</span>    
</div><div class='line not-executable'><span class='num'>1433</span>    public function updateEdge(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1434</span>    {
</div><div class='line not-executable'><span class='num'>1435</span>        try {
</div><div class='line not-covered'><span class='num'>1436</span>            $edge = new Edge($req-&gt;data[&#039;id&#039;], $req-&gt;data[&#039;source&#039;], $req-&gt;data[&#039;target&#039;], $req-&gt;data[&#039;data&#039;]);
</div><div class='line not-covered'><span class='num'>1437</span>            $this-&gt;service-&gt;updateEdge($edge);
</div><div class='line not-covered'><span class='num'>1438</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1439</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1440</span>        {
</div><div class='line not-covered'><span class='num'>1441</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1442</span>        }
</div><div class='line not-executable'><span class='num'>1443</span>        
</div><div class='line not-covered'><span class='num'>1444</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1445</span>    }
</div><div class='line not-executable'><span class='num'>1446</span>    
</div><div class='line not-executable'><span class='num'>1447</span>    public function deleteEdge(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1448</span>    {
</div><div class='line not-executable'><span class='num'>1449</span>        try {
</div><div class='line not-covered'><span class='num'>1450</span>            $id = $req-&gt;data[&#039;id&#039;];
</div><div class='line not-covered'><span class='num'>1451</span>            $this-&gt;service-&gt;deleteEdge($id);
</div><div class='line not-covered'><span class='num'>1452</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1453</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1454</span>        {
</div><div class='line not-covered'><span class='num'>1455</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1456</span>        }
</div><div class='line not-executable'><span class='num'>1457</span>        
</div><div class='line not-covered'><span class='num'>1458</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1459</span>    }
</div><div class='line not-executable'><span class='num'>1460</span>
</div><div class='line not-executable'><span class='num'>1461</span>    public function getStatuses(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1462</span>    {
</div><div class='line not-executable'><span class='num'>1463</span>        try {
</div><div class='line not-covered'><span class='num'>1464</span>            $statuses = $this-&gt;service-&gt;getStatuses();
</div><div class='line not-covered'><span class='num'>1465</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1466</span>            return $resp;
</div><div class='line not-covered'><span class='num'>1467</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1468</span>        {
</div><div class='line not-covered'><span class='num'>1469</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1470</span>        }
</div><div class='line not-executable'><span class='num'>1471</span>        
</div><div class='line not-covered'><span class='num'>1472</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1473</span>    }
</div><div class='line not-executable'><span class='num'>1474</span>    
</div><div class='line not-executable'><span class='num'>1475</span>    public function getNodeStatus(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1476</span>    {
</div><div class='line not-executable'><span class='num'>1477</span>        try {
</div><div class='line not-covered'><span class='num'>1478</span>            $status = $this-&gt;service-&gt;getNodeStatus($req-&gt;data[&#039;id&#039;]);
</div><div class='line not-covered'><span class='num'>1479</span>            $data = $status-&gt;toArray();
</div><div class='line not-covered'><span class='num'>1480</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1481</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1482</span>        {
</div><div class='line not-covered'><span class='num'>1483</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1484</span>        }
</div><div class='line not-executable'><span class='num'>1485</span>        
</div><div class='line not-covered'><span class='num'>1486</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1487</span>    }
</div><div class='line not-executable'><span class='num'>1488</span>    
</div><div class='line not-executable'><span class='num'>1489</span>    public function setNodeStatus(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1490</span>    {
</div><div class='line not-executable'><span class='num'>1491</span>        try {
</div><div class='line not-covered'><span class='num'>1492</span>            $status = new NodeStatus($req-&gt;data[&#039;node_id&#039;], $req-&gt;data[&#039;status&#039;]);
</div><div class='line not-covered'><span class='num'>1493</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1494</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1495</span>        {
</div><div class='line not-covered'><span class='num'>1496</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1497</span>        }
</div><div class='line not-executable'><span class='num'>1498</span>        
</div><div class='line not-covered'><span class='num'>1499</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1500</span>    }
</div><div class='line not-executable'><span class='num'>1501</span>
</div><div class='line not-executable'><span class='num'>1502</span>    public function getLogs(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1503</span>    {
</div><div class='line not-executable'><span class='num'>1504</span>        try {
</div><div class='line not-covered'><span class='num'>1505</span>            $logs = $this-&gt;service-&gt;getLogs($req-&gt;getParam(&#039;limit&#039;));
</div><div class='line not-covered'><span class='num'>1506</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1507</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1508</span>        {
</div><div class='line not-covered'><span class='num'>1509</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1510</span>        }
</div><div class='line not-executable'><span class='num'>1511</span>        
</div><div class='line not-covered'><span class='num'>1512</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1513</span>    }
</div><div class='line not-executable'><span class='num'>1514</span>}
</div><div class='line not-executable'><span class='num'>1515</span>
</div><div class='line not-executable'><span class='num'>1516</span>final class RequestRouter
</div><div class='line not-executable'><span class='num'>1517</span>{
</div><div class='line not-executable'><span class='num'>1518</span>    private $routes = [
</div><div class='line not-executable'><span class='num'>1519</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getGraph&#039;, &#039;class_method&#039; =&gt; &#039;getGraph&#039;],
</div><div class='line not-executable'><span class='num'>1520</span>        
</div><div class='line not-executable'><span class='num'>1521</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getNode&#039;, &#039;class_method&#039; =&gt; &#039;getNode&#039;],
</div><div class='line not-executable'><span class='num'>1522</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getNodes&#039;, &#039;class_method&#039; =&gt; &#039;getNodes&#039;],
</div><div class='line not-executable'><span class='num'>1523</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/insertNode&#039;, &#039;class_method&#039; =&gt; &#039;insertNode&#039;],
</div><div class='line not-executable'><span class='num'>1524</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/updateNode&#039;, &#039;class_method&#039; =&gt; &#039;updateNode&#039;],
</div><div class='line not-executable'><span class='num'>1525</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/deleteNode&#039;, &#039;class_method&#039; =&gt; &#039;deleteNode&#039;],
</div><div class='line not-executable'><span class='num'>1526</span>
</div><div class='line not-executable'><span class='num'>1527</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getEdge&#039;, &#039;class_method&#039; =&gt; &#039;getEdge&#039;],
</div><div class='line not-executable'><span class='num'>1528</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getEdges&#039;, &#039;class_method&#039; =&gt; &#039;getEdges&#039;],
</div><div class='line not-executable'><span class='num'>1529</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/insertEdge&#039;, &#039;class_method&#039; =&gt; &#039;insertEdge&#039;],
</div><div class='line not-executable'><span class='num'>1530</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/updateEdge&#039;, &#039;class_method&#039; =&gt; &#039;updateEdge&#039;],
</div><div class='line not-executable'><span class='num'>1531</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/deleteEdge&#039;, &#039;class_method&#039; =&gt; &#039;deleteEdge&#039;],
</div><div class='line not-executable'><span class='num'>1532</span>
</div><div class='line not-executable'><span class='num'>1533</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getStatuses&#039;, &#039;class_method&#039; =&gt; &#039;getStatuses&#039;],
</div><div class='line not-executable'><span class='num'>1534</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getNodeStatus&#039;, &#039;class_method&#039; =&gt; &#039;getNodeStatus&#039;],
</div><div class='line not-executable'><span class='num'>1535</span>
</div><div class='line not-executable'><span class='num'>1536</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getLogs&#039;, &#039;class_method&#039; =&gt; &#039;getLogs&#039;],
</div><div class='line not-executable'><span class='num'>1537</span>
</div><div class='line not-executable'><span class='num'>1538</span>        ];
</div><div class='line not-executable'><span class='num'>1539</span>
</div><div class='line not-executable'><span class='num'>1540</span>    public GraphController $controller;
</div><div class='line not-executable'><span class='num'>1541</span>    
</div><div class='line not-executable'><span class='num'>1542</span>    public function __construct(GraphController $controller)
</div><div class='line not-executable'><span class='num'>1543</span>    {
</div><div class='line not-covered'><span class='num'>1544</span>        $this-&gt;controller = $controller;
</div><div class='line not-covered'><span class='num'>1545</span>    }
</div><div class='line not-executable'><span class='num'>1546</span>
</div><div class='line not-executable'><span class='num'>1547</span>    public function handle(): void
</div><div class='line not-executable'><span class='num'>1548</span>    {
</div><div class='line not-covered'><span class='num'>1549</span>        $method = $_SERVER[&#039;REQUEST_METHOD&#039;];
</div><div class='line not-executable'><span class='num'>1550</span>
</div><div class='line not-covered'><span class='num'>1551</span>        $scriptName = $_SERVER[&#039;SCRIPT_NAME&#039;];
</div><div class='line not-covered'><span class='num'>1552</span>        $requestUri = $_SERVER[&#039;REQUEST_URI&#039;];
</div><div class='line not-covered'><span class='num'>1553</span>        $requestUri = strtok($requestUri, &#039;?&#039;);
</div><div class='line not-executable'><span class='num'>1554</span>        
</div><div class='line not-covered'><span class='num'>1555</span>        $path = str_replace($scriptName, &#039;&#039;, $requestUri);
</div><div class='line not-executable'><span class='num'>1556</span>        
</div><div class='line not-covered'><span class='num'>1557</span>        $req = new Request();
</div><div class='line not-executable'><span class='num'>1558</span>
</div><div class='line not-covered'><span class='num'>1559</span>        foreach($this-&gt;routes as $route)
</div><div class='line not-executable'><span class='num'>1560</span>        {
</div><div class='line not-covered'><span class='num'>1561</span>            if ($route[&#039;method&#039;] == $method &amp;&amp; $route[&#039;path&#039;] == $path)
</div><div class='line not-executable'><span class='num'>1562</span>            {
</div><div class='line not-covered'><span class='num'>1563</span>                $method = $route[&#039;class_method&#039;];
</div><div class='line not-covered'><span class='num'>1564</span>                $resp = $this-&gt;controller-&gt;$method($req);
</div><div class='line not-covered'><span class='num'>1565</span>                print_r($resp);
</div><div class='line not-covered'><span class='num'>1566</span>                exit();
</div><div class='line not-executable'><span class='num'>1567</span>            }
</div><div class='line not-executable'><span class='num'>1568</span>        }
</div><div class='line not-covered'><span class='num'>1569</span>    }
</div><div class='line not-executable'><span class='num'>1570</span>}
</div><div class='line not-executable'><span class='num'>1571</span>
</div><div class='line not-executable'><span class='num'>1572</span>
</div></body></html><html><head><meta charset='UTF-8'><style>
body { font-family: monospace; font-size: 12px; background: #222; color: #ddd; margin: 0; }
.covered { background: #1a4d1a; }
.not-covered { background: #4d1a1a; }
.not-executable { background: #2a2a2a; color: #666; }
.line { padding: 2px 10px; white-space: pre; border-left: 3px solid transparent; }
.covered { border-left-color: #0f0; }
.not-covered { border-left-color: #f00; }
.num { color: #666; width: 50px; display: inline-block; text-align: right; margin-right: 10px; }
h2 { background: #333; padding: 10px; margin: 20px 0 0 0; position: sticky; top: 0; }
</style></head><body><h2>/home/tarcisio/projects/graph/tests.php - 77.05% (47/61)</h2><div class='line not-executable'><span class='num'>1</span>&lt;?php
</div><div class='line not-executable'><span class='num'>2</span>
</div><div class='line not-executable'><span class='num'>3</span>declare(strict_types=1);
</div><div class='line not-executable'><span class='num'>4</span>
</div><div class='line not-executable'><span class='num'>5</span>require_once __DIR__ . &#039;/graph.php&#039;;
</div><div class='line not-executable'><span class='num'>6</span>
</div><div class='line not-executable'><span class='num'>7</span>ini_set(&#039;xdebug.mode&#039;, &#039;1&#039;);
</div><div class='line not-executable'><span class='num'>8</span>xdebug_start_code_coverage(XDEBUG_CC_UNUSED | XDEBUG_CC_DEAD_CODE);
</div><div class='line not-executable'><span class='num'>9</span>
</div><div class='line not-executable'><span class='num'>10</span>function array_diff_recursive($array1, $array2) {
</div><div class='line covered'><span class='num'>11</span>    $diff = [];
</div><div class='line not-executable'><span class='num'>12</span>    
</div><div class='line covered'><span class='num'>13</span>    foreach ($array1 as $key =&gt; $value) {
</div><div class='line covered'><span class='num'>14</span>        if (!array_key_exists($key, $array2)) {
</div><div class='line not-covered'><span class='num'>15</span>            $diff[$key] = $value;
</div><div class='line covered'><span class='num'>16</span>        } elseif (is_array($value)) {
</div><div class='line covered'><span class='num'>17</span>            if (!is_array($array2[$key])) {
</div><div class='line not-covered'><span class='num'>18</span>                $diff[$key] = $value;
</div><div class='line not-executable'><span class='num'>19</span>            } else {
</div><div class='line covered'><span class='num'>20</span>                $recursiveDiff = array_diff_recursive($value, $array2[$key]);
</div><div class='line covered'><span class='num'>21</span>                if (count($recursiveDiff)) {
</div><div class='line not-covered'><span class='num'>22</span>                    $diff[$key] = $recursiveDiff;
</div><div class='line not-executable'><span class='num'>23</span>                }
</div><div class='line not-executable'><span class='num'>24</span>            }
</div><div class='line covered'><span class='num'>25</span>        } elseif ($value !== $array2[$key]) {
</div><div class='line not-covered'><span class='num'>26</span>            $diff[$key] = $value;
</div><div class='line not-executable'><span class='num'>27</span>        }
</div><div class='line not-executable'><span class='num'>28</span>    }
</div><div class='line not-executable'><span class='num'>29</span>    
</div><div class='line covered'><span class='num'>30</span>    return $diff;
</div><div class='line not-covered'><span class='num'>31</span>}
</div><div class='line not-executable'><span class='num'>32</span>
</div><div class='line not-executable'><span class='num'>33</span>function get_test_graph_controller()
</div><div class='line not-executable'><span class='num'>34</span>{
</div><div class='line covered'><span class='num'>35</span>    GraphContext::$user = new User(&#039;test_user&#039;, &#039;127.0.0.1&#039;, new Group(&#039;contributor&#039;));
</div><div class='line covered'><span class='num'>36</span>    $pdo = GraphDatabase::createConnection(&#039;sqlite::memory:&#039;);
</div><div class='line covered'><span class='num'>37</span>    $databaseLogger = new Logger(&#039;database.log&#039;);
</div><div class='line not-executable'><span class='num'>38</span>
</div><div class='line covered'><span class='num'>39</span>    $graphDb = new GraphDatabase($pdo, $databaseLogger);
</div><div class='line not-executable'><span class='num'>40</span>
</div><div class='line covered'><span class='num'>41</span>    $serviceLogger = new Logger(&#039;service.log&#039;);
</div><div class='line covered'><span class='num'>42</span>    $graphService = new GraphService($graphDb, $serviceLogger);
</div><div class='line not-executable'><span class='num'>43</span>
</div><div class='line covered'><span class='num'>44</span>    $controllerLogger = new Logger(&#039;controller.log&#039;);
</div><div class='line covered'><span class='num'>45</span>    $graphController = new GraphController($graphService, $controllerLogger);
</div><div class='line not-executable'><span class='num'>46</span>    
</div><div class='line covered'><span class='num'>47</span>    return $graphController;
</div><div class='line not-covered'><span class='num'>48</span>}
</div><div class='line not-executable'><span class='num'>49</span>
</div><div class='line not-executable'><span class='num'>50</span>function test_node_good_path()
</div><div class='line not-executable'><span class='num'>51</span>{
</div><div class='line covered'><span class='num'>52</span>    $graphController = get_test_graph_controller();
</div><div class='line covered'><span class='num'>53</span>    $insertNodeReq = new Request();
</div><div class='line covered'><span class='num'>54</span>    $insertNodeReq-&gt;data = [&#039;id&#039; =&gt; &#039;node1&#039;, &#039;label&#039; =&gt; &#039;node1&#039;, &#039;category&#039; =&gt; &#039;business&#039;, &#039;type&#039; =&gt; &#039;server&#039;, &#039;data&#039; =&gt; [&#039;info&#039; =&gt; &#039;first node&#039;]];
</div><div class='line covered'><span class='num'>55</span>    $resp = $graphController-&gt;insertNode($insertNodeReq);
</div><div class='line not-executable'><span class='num'>56</span>    
</div><div class='line covered'><span class='num'>57</span>    $expected = [
</div><div class='line not-executable'><span class='num'>58</span>        &#039;id&#039;       =&gt; &#039;node1&#039;,
</div><div class='line not-executable'><span class='num'>59</span>        &#039;label&#039;    =&gt; &#039;node1&#039;,
</div><div class='line not-executable'><span class='num'>60</span>        &#039;category&#039; =&gt; &#039;business&#039;,
</div><div class='line not-executable'><span class='num'>61</span>        &#039;type&#039; =&gt; &#039;server&#039;,
</div><div class='line not-executable'><span class='num'>62</span>        &#039;data&#039; =&gt; [
</div><div class='line not-executable'><span class='num'>63</span>                &#039;info&#039; =&gt; &#039;first node&#039;
</div><div class='line not-executable'><span class='num'>64</span>        ]
</div><div class='line not-executable'><span class='num'>65</span>    ];
</div><div class='line not-executable'><span class='num'>66</span>
</div><div class='line covered'><span class='num'>67</span>    if($resp-&gt;code != 201) {
</div><div class='line not-covered'><span class='num'>68</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>69</span>    }
</div><div class='line not-executable'><span class='num'>70</span>
</div><div class='line covered'><span class='num'>71</span>    if($resp-&gt;status != &#039;success&#039;) {
</div><div class='line not-covered'><span class='num'>72</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>73</span>    }
</div><div class='line not-executable'><span class='num'>74</span>
</div><div class='line covered'><span class='num'>75</span>    if ($resp-&gt;message != &#039;node inserted&#039;) {
</div><div class='line not-covered'><span class='num'>76</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>77</span>    }
</div><div class='line not-executable'><span class='num'>78</span>
</div><div class='line covered'><span class='num'>79</span>    $diff = array_diff_recursive($resp-&gt;data, $expected);
</div><div class='line covered'><span class='num'>80</span>    if (! empty($diff)) {
</div><div class='line not-covered'><span class='num'>81</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>82</span>    }
</div><div class='line not-executable'><span class='num'>83</span>
</div><div class='line covered'><span class='num'>84</span>    $_GET[&#039;id&#039;] = &#039;node1&#039;;
</div><div class='line covered'><span class='num'>85</span>    $req = new Request();
</div><div class='line covered'><span class='num'>86</span>    $resp = $graphController-&gt;getNode($req);
</div><div class='line not-executable'><span class='num'>87</span>
</div><div class='line covered'><span class='num'>88</span>    if ($resp-&gt;code != 200) {
</div><div class='line not-covered'><span class='num'>89</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>90</span>    }
</div><div class='line not-executable'><span class='num'>91</span>
</div><div class='line covered'><span class='num'>92</span>    if($resp-&gt;status != &#039;success&#039;) {
</div><div class='line not-covered'><span class='num'>93</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>94</span>    }
</div><div class='line not-executable'><span class='num'>95</span>
</div><div class='line covered'><span class='num'>96</span>    if ($resp-&gt;message != &#039;node found&#039;) {
</div><div class='line not-covered'><span class='num'>97</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>98</span>    }
</div><div class='line not-executable'><span class='num'>99</span>
</div><div class='line covered'><span class='num'>100</span>    $expected = [
</div><div class='line not-executable'><span class='num'>101</span>        &#039;info&#039;     =&gt; &#039;first node&#039;,
</div><div class='line not-executable'><span class='num'>102</span>        &#039;id&#039;       =&gt; &#039;node1&#039;,
</div><div class='line not-executable'><span class='num'>103</span>        &#039;label&#039;    =&gt; &#039;node1&#039;,
</div><div class='line not-executable'><span class='num'>104</span>        &#039;category&#039; =&gt; &#039;business&#039;,
</div><div class='line not-executable'><span class='num'>105</span>        &#039;type&#039;     =&gt; &#039;server&#039;,
</div><div class='line not-executable'><span class='num'>106</span>    ];
</div><div class='line not-executable'><span class='num'>107</span>
</div><div class='line covered'><span class='num'>108</span>    $diff = array_diff_recursive($resp-&gt;data[&#039;data&#039;], $expected);
</div><div class='line covered'><span class='num'>109</span>    if (! empty($diff)) {
</div><div class='line not-covered'><span class='num'>110</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>111</span>    }
</div><div class='line not-executable'><span class='num'>112</span>    
</div><div class='line covered'><span class='num'>113</span>    $req = new Request();
</div><div class='line covered'><span class='num'>114</span>    $req-&gt;data = [
</div><div class='line not-executable'><span class='num'>115</span>        &#039;id&#039;       =&gt; &#039;node1&#039;,
</div><div class='line not-executable'><span class='num'>116</span>        &#039;label&#039;    =&gt; &#039;node1&#039;,
</div><div class='line not-executable'><span class='num'>117</span>        &#039;category&#039; =&gt; &#039;business&#039;,
</div><div class='line not-executable'><span class='num'>118</span>        &#039;type&#039; =&gt; &#039;server&#039;,
</div><div class='line not-executable'><span class='num'>119</span>        &#039;data&#039; =&gt; [
</div><div class='line not-executable'><span class='num'>120</span>                &#039;info&#039; =&gt; &#039;first node updated&#039;
</div><div class='line not-executable'><span class='num'>121</span>        ]
</div><div class='line not-executable'><span class='num'>122</span>    ];
</div><div class='line covered'><span class='num'>123</span>    $resp = $graphController-&gt;updateNode($req);
</div><div class='line covered'><span class='num'>124</span>    print_r($resp);
</div><div class='line covered'><span class='num'>125</span>}
</div><div class='line not-executable'><span class='num'>126</span>
</div><div class='line not-executable'><span class='num'>127</span>function tests() {
</div><div class='line covered'><span class='num'>128</span>    test_node_good_path();
</div><div class='line covered'><span class='num'>129</span>    echo &quot;fim&quot;;
</div><div class='line covered'><span class='num'>130</span>}
</div><div class='line not-executable'><span class='num'>131</span>
</div><div class='line covered'><span class='num'>132</span>tests();
</div><div class='line not-executable'><span class='num'>133</span>
</div><div class='line covered'><span class='num'>134</span>$coverage = xdebug_get_code_coverage();
</div><div class='line not-executable'><span class='num'>135</span>xdebug_stop_code_coverage();
</div><div class='line not-executable'><span class='num'>136</span>
</div><div class='line not-executable'><span class='num'>137</span>// Salvar em arquivo
</div><div class='line not-executable'><span class='num'>138</span>file_put_contents(&#039;coverage.json&#039;, json_encode($coverage, JSON_PRETTY_PRINT));
</div><div class='line not-executable'><span class='num'>139</span>
</div><div class='line not-executable'><span class='num'>140</span>echo &#039;fim&#039;;</div><h2>/home/tarcisio/projects/graph/graph.php - 30.66% (195/636)</h2><div class='line not-executable'><span class='num'>1</span>&lt;?php
</div><div class='line not-executable'><span class='num'>2</span>
</div><div class='line not-executable'><span class='num'>3</span>declare(strict_types=1);
</div><div class='line not-executable'><span class='num'>4</span>
</div><div class='line not-executable'><span class='num'>5</span>final class User
</div><div class='line not-executable'><span class='num'>6</span>{
</div><div class='line not-executable'><span class='num'>7</span>    public string $id;
</div><div class='line not-executable'><span class='num'>8</span>    public ?string $ipAddress;
</div><div class='line not-executable'><span class='num'>9</span>    public Group $group;
</div><div class='line not-executable'><span class='num'>10</span>
</div><div class='line not-executable'><span class='num'>11</span>    public function __construct(string $id, ?string $ipAddress, Group $group)
</div><div class='line not-executable'><span class='num'>12</span>    {
</div><div class='line covered'><span class='num'>13</span>        $this-&gt;id = $id;
</div><div class='line covered'><span class='num'>14</span>        $this-&gt;ipAddress = $ipAddress;
</div><div class='line covered'><span class='num'>15</span>        $this-&gt;group = $group;
</div><div class='line covered'><span class='num'>16</span>    }
</div><div class='line not-executable'><span class='num'>17</span>
</div><div class='line not-executable'><span class='num'>18</span>    public function toArray(): array
</div><div class='line not-executable'><span class='num'>19</span>    {
</div><div class='line not-executable'><span class='num'>20</span>        return [
</div><div class='line not-covered'><span class='num'>21</span>            &#039;id&#039; =&gt; $this-&gt;id,
</div><div class='line not-executable'><span class='num'>22</span>            &#039;group&#039; =&gt; [
</div><div class='line not-covered'><span class='num'>23</span>                &#039;id&#039; =&gt; $this-&gt;group-&gt;id,
</div><div class='line not-executable'><span class='num'>24</span>            ],
</div><div class='line not-executable'><span class='num'>25</span>        ];
</div><div class='line not-covered'><span class='num'>26</span>    }
</div><div class='line not-executable'><span class='num'>27</span>}
</div><div class='line not-executable'><span class='num'>28</span>
</div><div class='line not-executable'><span class='num'>29</span>final class Group
</div><div class='line not-executable'><span class='num'>30</span>{
</div><div class='line not-executable'><span class='num'>31</span>    private const ALLOWED_GROUPS = [&#039;anonymous&#039;, &#039;consumer&#039;, &#039;contributor&#039;, &#039;admin&#039;];
</div><div class='line not-executable'><span class='num'>32</span>    
</div><div class='line not-executable'><span class='num'>33</span>    public string $id;
</div><div class='line not-executable'><span class='num'>34</span>    
</div><div class='line not-executable'><span class='num'>35</span>    public function __construct(string $id)
</div><div class='line not-executable'><span class='num'>36</span>    {
</div><div class='line covered'><span class='num'>37</span>        if (!in_array($id, self::ALLOWED_GROUPS, true)) {
</div><div class='line not-covered'><span class='num'>38</span>            throw new InvalidArgumentException(&quot;Invalid user group: {$id}&quot;);
</div><div class='line not-executable'><span class='num'>39</span>        }
</div><div class='line covered'><span class='num'>40</span>        $this-&gt;id  = $id;
</div><div class='line covered'><span class='num'>41</span>    }
</div><div class='line not-executable'><span class='num'>42</span>}
</div><div class='line not-executable'><span class='num'>43</span>
</div><div class='line not-executable'><span class='num'>44</span>final class Graph
</div><div class='line not-executable'><span class='num'>45</span>{
</div><div class='line not-executable'><span class='num'>46</span>    public array $nodes = [];
</div><div class='line not-executable'><span class='num'>47</span>    public array $edges = [];
</div><div class='line not-executable'><span class='num'>48</span>    public array $data  = [];
</div><div class='line not-executable'><span class='num'>49</span>    public array $layout = [];
</div><div class='line not-executable'><span class='num'>50</span>    public array $styles = [];
</div><div class='line not-executable'><span class='num'>51</span>
</div><div class='line not-executable'><span class='num'>52</span>    public function __construct(array $nodes, array $edges)
</div><div class='line not-executable'><span class='num'>53</span>    {
</div><div class='line not-covered'><span class='num'>54</span>        $this-&gt;nodes = $nodes;
</div><div class='line not-covered'><span class='num'>55</span>        $this-&gt;edges = $edges;
</div><div class='line not-covered'><span class='num'>56</span>    }
</div><div class='line not-executable'><span class='num'>57</span>
</div><div class='line not-executable'><span class='num'>58</span>    public function toArray(): array
</div><div class='line not-executable'><span class='num'>59</span>    {
</div><div class='line not-executable'><span class='num'>60</span>        return [
</div><div class='line not-covered'><span class='num'>61</span>            &#039;nodes&#039; =&gt; $this-&gt;nodes,
</div><div class='line not-covered'><span class='num'>62</span>            &#039;edges&#039; =&gt; $this-&gt;edges,
</div><div class='line not-covered'><span class='num'>63</span>            &#039;data&#039; =&gt; $this-&gt;data,
</div><div class='line not-covered'><span class='num'>64</span>            &#039;layout&#039; =&gt; $this-&gt;layout,
</div><div class='line not-covered'><span class='num'>65</span>            &#039;styles&#039; =&gt; $this-&gt;styles,
</div><div class='line not-executable'><span class='num'>66</span>        ];
</div><div class='line not-covered'><span class='num'>67</span>    }
</div><div class='line not-executable'><span class='num'>68</span>}
</div><div class='line not-executable'><span class='num'>69</span>
</div><div class='line not-executable'><span class='num'>70</span>final class Node
</div><div class='line not-executable'><span class='num'>71</span>{
</div><div class='line not-executable'><span class='num'>72</span>    private const ALLOWED_CATEGORIES  = [&#039;business&#039;, &#039;application&#039;, &#039;infrastructure&#039;];
</div><div class='line not-executable'><span class='num'>73</span>    private const ALLOWED_TYPES       = [&#039;server&#039;, &#039;database&#039;, &#039;application&#039;, &#039;network&#039;];
</div><div class='line not-executable'><span class='num'>74</span>    private const ID_VALIDATION_REGEX = &#039;/^[a-zA-Z0-9\-_]+$/&#039;;
</div><div class='line not-executable'><span class='num'>75</span>    private const LABEL_MAX_LENGTH    = 20;
</div><div class='line not-executable'><span class='num'>76</span>    
</div><div class='line not-executable'><span class='num'>77</span>    public string $id;
</div><div class='line not-executable'><span class='num'>78</span>    public string $label;
</div><div class='line not-executable'><span class='num'>79</span>    public string $category;
</div><div class='line not-executable'><span class='num'>80</span>    public string $type;
</div><div class='line not-executable'><span class='num'>81</span>
</div><div class='line not-executable'><span class='num'>82</span>    public array $data = [];
</div><div class='line not-executable'><span class='num'>83</span>
</div><div class='line not-executable'><span class='num'>84</span>    public function __construct(string $id, string $label, string $category, string $type, array $data)
</div><div class='line not-executable'><span class='num'>85</span>    {
</div><div class='line covered'><span class='num'>86</span>        $this-&gt;validate($id, $label, $category, $type);
</div><div class='line covered'><span class='num'>87</span>        $this-&gt;id       = $id;
</div><div class='line covered'><span class='num'>88</span>        $this-&gt;label    = $label;
</div><div class='line covered'><span class='num'>89</span>        $this-&gt;category = $category;
</div><div class='line covered'><span class='num'>90</span>        $this-&gt;type     = $type;
</div><div class='line covered'><span class='num'>91</span>        $this-&gt;data     = $data;
</div><div class='line covered'><span class='num'>92</span>    }
</div><div class='line not-executable'><span class='num'>93</span>
</div><div class='line not-executable'><span class='num'>94</span>    private function validate(string $id, string $label, string $category, string $type): void
</div><div class='line not-executable'><span class='num'>95</span>    {
</div><div class='line covered'><span class='num'>96</span>        if (!preg_match(self::ID_VALIDATION_REGEX, $id)) {
</div><div class='line not-covered'><span class='num'>97</span>            throw new InvalidArgumentException(&quot;Invalid node ID: {$id}&quot;);
</div><div class='line not-executable'><span class='num'>98</span>        }
</div><div class='line not-executable'><span class='num'>99</span>
</div><div class='line covered'><span class='num'>100</span>        if (strlen($label) &gt; self::LABEL_MAX_LENGTH) {
</div><div class='line not-covered'><span class='num'>101</span>            throw new InvalidArgumentException(&quot;Node label exceeds maximum length of &quot; . self::LABEL_MAX_LENGTH);
</div><div class='line not-executable'><span class='num'>102</span>        }
</div><div class='line not-executable'><span class='num'>103</span>
</div><div class='line covered'><span class='num'>104</span>        if (!in_array($category, self::ALLOWED_CATEGORIES, true)) {
</div><div class='line not-covered'><span class='num'>105</span>            throw new InvalidArgumentException(&quot;Invalid node category: {$category}&quot;);
</div><div class='line not-executable'><span class='num'>106</span>        }
</div><div class='line not-executable'><span class='num'>107</span>
</div><div class='line covered'><span class='num'>108</span>        if (!in_array($type, self::ALLOWED_TYPES, true)) {
</div><div class='line not-covered'><span class='num'>109</span>            throw new InvalidArgumentException(&quot;Invalid node type: {$type}&quot;);
</div><div class='line not-executable'><span class='num'>110</span>        }
</div><div class='line covered'><span class='num'>111</span>    }
</div><div class='line not-executable'><span class='num'>112</span>
</div><div class='line not-executable'><span class='num'>113</span>    public function toArray(): array
</div><div class='line not-executable'><span class='num'>114</span>    {
</div><div class='line not-executable'><span class='num'>115</span>        return [
</div><div class='line covered'><span class='num'>116</span>            &#039;id&#039;       =&gt; $this-&gt;id,
</div><div class='line covered'><span class='num'>117</span>            &#039;label&#039;    =&gt; $this-&gt;label,
</div><div class='line covered'><span class='num'>118</span>            &#039;category&#039; =&gt; $this-&gt;category,
</div><div class='line covered'><span class='num'>119</span>            &#039;type&#039;     =&gt; $this-&gt;type,
</div><div class='line covered'><span class='num'>120</span>            &#039;data&#039;     =&gt; $this-&gt;data
</div><div class='line not-executable'><span class='num'>121</span>        ];
</div><div class='line not-covered'><span class='num'>122</span>    }
</div><div class='line not-executable'><span class='num'>123</span>}
</div><div class='line not-executable'><span class='num'>124</span>
</div><div class='line not-executable'><span class='num'>125</span>final class NodeStatus
</div><div class='line not-executable'><span class='num'>126</span>{
</div><div class='line not-executable'><span class='num'>127</span>    private const ALLOWED_NODE_STATUSES = [&#039;unknown&#039;, &#039;healthy&#039;, &#039;unhealthy&#039;, &#039;maintenance&#039;];
</div><div class='line not-executable'><span class='num'>128</span>
</div><div class='line not-executable'><span class='num'>129</span>    public string $nodeId;
</div><div class='line not-executable'><span class='num'>130</span>    public string $status;
</div><div class='line not-executable'><span class='num'>131</span>
</div><div class='line not-executable'><span class='num'>132</span>    public function __construct(string $nodeId, string $status)
</div><div class='line not-executable'><span class='num'>133</span>    {
</div><div class='line not-covered'><span class='num'>134</span>        if (!in_array($status, self::ALLOWED_NODE_STATUSES, true)) {
</div><div class='line not-covered'><span class='num'>135</span>            throw new InvalidArgumentException(&quot;Invalid node status: {$status}&quot;);
</div><div class='line not-executable'><span class='num'>136</span>        }
</div><div class='line not-covered'><span class='num'>137</span>        $this-&gt;nodeId = $nodeId;
</div><div class='line not-covered'><span class='num'>138</span>        $this-&gt;status = $status;
</div><div class='line not-covered'><span class='num'>139</span>    }
</div><div class='line not-executable'><span class='num'>140</span>
</div><div class='line not-executable'><span class='num'>141</span>    public function toArray(): array
</div><div class='line not-executable'><span class='num'>142</span>    {
</div><div class='line not-executable'><span class='num'>143</span>        return [
</div><div class='line not-covered'><span class='num'>144</span>            &#039;node_id&#039; =&gt; $this-&gt;nodeId,
</div><div class='line not-covered'><span class='num'>145</span>            &#039;status&#039;  =&gt; $this-&gt;status,
</div><div class='line not-executable'><span class='num'>146</span>        ];
</div><div class='line not-covered'><span class='num'>147</span>    }
</div><div class='line not-executable'><span class='num'>148</span>}
</div><div class='line not-executable'><span class='num'>149</span>
</div><div class='line not-executable'><span class='num'>150</span>final class NodeStatuses
</div><div class='line not-executable'><span class='num'>151</span>{
</div><div class='line not-executable'><span class='num'>152</span>    public array $statuses = [];
</div><div class='line not-executable'><span class='num'>153</span>
</div><div class='line not-executable'><span class='num'>154</span>    public function addStatus(NodeStatus $status): void
</div><div class='line not-executable'><span class='num'>155</span>    {
</div><div class='line not-covered'><span class='num'>156</span>        $this-&gt;statuses[] = $status;
</div><div class='line not-covered'><span class='num'>157</span>    }
</div><div class='line not-executable'><span class='num'>158</span>}
</div><div class='line not-executable'><span class='num'>159</span>
</div><div class='line not-executable'><span class='num'>160</span>final class Nodes
</div><div class='line not-executable'><span class='num'>161</span>{
</div><div class='line not-executable'><span class='num'>162</span>    public array $nodes = [];
</div><div class='line not-executable'><span class='num'>163</span>
</div><div class='line not-executable'><span class='num'>164</span>    public function addNode(Node $node): void
</div><div class='line not-executable'><span class='num'>165</span>    {
</div><div class='line not-covered'><span class='num'>166</span>        $this-&gt;nodes[] = $node;
</div><div class='line not-covered'><span class='num'>167</span>    }
</div><div class='line not-executable'><span class='num'>168</span>}
</div><div class='line not-executable'><span class='num'>169</span>
</div><div class='line not-executable'><span class='num'>170</span>final class Edge
</div><div class='line not-executable'><span class='num'>171</span>{
</div><div class='line not-executable'><span class='num'>172</span>    public ?string $id;
</div><div class='line not-executable'><span class='num'>173</span>    public string $source;
</div><div class='line not-executable'><span class='num'>174</span>    public string $target;
</div><div class='line not-executable'><span class='num'>175</span>    public array $data;
</div><div class='line not-executable'><span class='num'>176</span>
</div><div class='line not-executable'><span class='num'>177</span>    public function __construct(?string $id = null, string $source, string $target, array $data = [])
</div><div class='line not-executable'><span class='num'>178</span>    {
</div><div class='line covered'><span class='num'>179</span>        $this-&gt;id     = $id;
</div><div class='line covered'><span class='num'>180</span>        $this-&gt;source = $source;
</div><div class='line covered'><span class='num'>181</span>        $this-&gt;target = $target;
</div><div class='line covered'><span class='num'>182</span>        $this-&gt;data   = $data;
</div><div class='line covered'><span class='num'>183</span>    }
</div><div class='line not-executable'><span class='num'>184</span>
</div><div class='line not-executable'><span class='num'>185</span>    public function toArray(): array
</div><div class='line not-executable'><span class='num'>186</span>    {
</div><div class='line not-executable'><span class='num'>187</span>        return [
</div><div class='line covered'><span class='num'>188</span>            &#039;id&#039;     =&gt; $this-&gt;id,
</div><div class='line covered'><span class='num'>189</span>            &#039;source&#039; =&gt; $this-&gt;source,
</div><div class='line covered'><span class='num'>190</span>            &#039;target&#039; =&gt; $this-&gt;target,
</div><div class='line covered'><span class='num'>191</span>            &#039;data&#039;   =&gt; $this-&gt;data
</div><div class='line not-executable'><span class='num'>192</span>        ];
</div><div class='line not-covered'><span class='num'>193</span>    }
</div><div class='line not-executable'><span class='num'>194</span>}
</div><div class='line not-executable'><span class='num'>195</span>
</div><div class='line not-executable'><span class='num'>196</span>final class Edges
</div><div class='line not-executable'><span class='num'>197</span>{
</div><div class='line not-executable'><span class='num'>198</span>    public array $edges = [];
</div><div class='line not-executable'><span class='num'>199</span>    public function addEdge(Edge $edge): void
</div><div class='line not-executable'><span class='num'>200</span>    {
</div><div class='line not-covered'><span class='num'>201</span>        $this-&gt;edges[] = $edge;
</div><div class='line not-covered'><span class='num'>202</span>    }
</div><div class='line not-executable'><span class='num'>203</span>}
</div><div class='line not-executable'><span class='num'>204</span>
</div><div class='line not-executable'><span class='num'>205</span>final class AuditLog
</div><div class='line not-executable'><span class='num'>206</span>{
</div><div class='line not-executable'><span class='num'>207</span>    public string $entityType;
</div><div class='line not-executable'><span class='num'>208</span>    public string $entityId;
</div><div class='line not-executable'><span class='num'>209</span>    public string $action;
</div><div class='line not-executable'><span class='num'>210</span>    public ?array $oldData;
</div><div class='line not-executable'><span class='num'>211</span>    public ?array $newData;
</div><div class='line not-executable'><span class='num'>212</span>    public string $userId;
</div><div class='line not-executable'><span class='num'>213</span>    public string $ipAddress;
</div><div class='line not-executable'><span class='num'>214</span>    public string $createdAt;
</div><div class='line not-executable'><span class='num'>215</span>
</div><div class='line not-executable'><span class='num'>216</span>    public function __construct(string $entityType, string $entityId, string $action, ?array $oldData = null, ?array $newData = null)
</div><div class='line not-executable'><span class='num'>217</span>    {
</div><div class='line covered'><span class='num'>218</span>        $this-&gt;entityType = $entityType;
</div><div class='line covered'><span class='num'>219</span>        $this-&gt;entityId   = $entityId;
</div><div class='line covered'><span class='num'>220</span>        $this-&gt;action     = $action;
</div><div class='line covered'><span class='num'>221</span>        $this-&gt;oldData    = $oldData;
</div><div class='line covered'><span class='num'>222</span>        $this-&gt;newData    = $newData;
</div><div class='line covered'><span class='num'>223</span>    }
</div><div class='line not-executable'><span class='num'>224</span>}
</div><div class='line not-executable'><span class='num'>225</span>
</div><div class='line not-executable'><span class='num'>226</span>final class AuditLogs
</div><div class='line not-executable'><span class='num'>227</span>{
</div><div class='line not-executable'><span class='num'>228</span>    public array $logs = [];
</div><div class='line not-executable'><span class='num'>229</span>    public function addLog(AuditLog $log): void
</div><div class='line not-executable'><span class='num'>230</span>    {
</div><div class='line not-covered'><span class='num'>231</span>        $this-&gt;logs[] = $log;
</div><div class='line not-covered'><span class='num'>232</span>    }
</div><div class='line not-executable'><span class='num'>233</span>}
</div><div class='line not-executable'><span class='num'>234</span>
</div><div class='line not-executable'><span class='num'>235</span>final class GraphContext
</div><div class='line not-executable'><span class='num'>236</span>{
</div><div class='line not-executable'><span class='num'>237</span>    public static User $user;
</div><div class='line not-executable'><span class='num'>238</span>}
</div><div class='line not-executable'><span class='num'>239</span>
</div><div class='line not-executable'><span class='num'>240</span>interface LoggerInterface
</div><div class='line not-executable'><span class='num'>241</span>{
</div><div class='line not-executable'><span class='num'>242</span>    public function info(string $message, array $data = []): void;
</div><div class='line not-executable'><span class='num'>243</span>    public function debug(string $message, array $data = []): void;
</div><div class='line not-executable'><span class='num'>244</span>    public function error(string $message, array $data = []): void;
</div><div class='line not-executable'><span class='num'>245</span>}
</div><div class='line not-executable'><span class='num'>246</span>
</div><div class='line not-executable'><span class='num'>247</span>final class Logger implements LoggerInterface
</div><div class='line not-executable'><span class='num'>248</span>{
</div><div class='line not-executable'><span class='num'>249</span>    private string $fileName;
</div><div class='line not-executable'><span class='num'>250</span>    private $fd;
</div><div class='line not-executable'><span class='num'>251</span>
</div><div class='line not-executable'><span class='num'>252</span>    public function __construct($file_name)
</div><div class='line not-executable'><span class='num'>253</span>    {
</div><div class='line covered'><span class='num'>254</span>        $this-&gt;fileName = $file_name;
</div><div class='line covered'><span class='num'>255</span>        $this-&gt;fd = fopen($this-&gt;fileName, &#039;a&#039;);
</div><div class='line covered'><span class='num'>256</span>    }
</div><div class='line not-executable'><span class='num'>257</span>
</div><div class='line not-executable'><span class='num'>258</span>    public function info(string $message, array $data = []): void
</div><div class='line not-executable'><span class='num'>259</span>    {
</div><div class='line covered'><span class='num'>260</span>        $this-&gt;log(&#039;INFO&#039;, $message, $data);
</div><div class='line covered'><span class='num'>261</span>    }
</div><div class='line not-executable'><span class='num'>262</span>
</div><div class='line not-executable'><span class='num'>263</span>    public function debug(string $message, array $data = []): void
</div><div class='line not-executable'><span class='num'>264</span>    {
</div><div class='line covered'><span class='num'>265</span>        $this-&gt;log(&#039;DEBUG&#039;, $message, $data);
</div><div class='line covered'><span class='num'>266</span>    }
</div><div class='line not-executable'><span class='num'>267</span>
</div><div class='line not-executable'><span class='num'>268</span>    public function error(string $message, array $data = []): void
</div><div class='line not-executable'><span class='num'>269</span>    {
</div><div class='line not-covered'><span class='num'>270</span>        $this-&gt;log(&#039;ERROR&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>271</span>    }
</div><div class='line not-executable'><span class='num'>272</span>
</div><div class='line not-executable'><span class='num'>273</span>    private function log(string $type, $message, $data = [])
</div><div class='line not-executable'><span class='num'>274</span>    {
</div><div class='line covered'><span class='num'>275</span>        $trace = debug_backtrace(DEBUG_BACKTRACE_PROVIDE_OBJECT, 3);
</div><div class='line covered'><span class='num'>276</span>        $method = &quot;{$trace[2][&#039;class&#039;]}::{$trace[2][&#039;function&#039;]}&quot;;
</div><div class='line covered'><span class='num'>277</span>        $data = json_encode($data);
</div><div class='line covered'><span class='num'>278</span>        $message = &quot;[{$type}] {$method}: $message ($data)\n&quot;;
</div><div class='line covered'><span class='num'>279</span>        fwrite($this-&gt;fd, $message);
</div><div class='line covered'><span class='num'>280</span>    }
</div><div class='line not-executable'><span class='num'>281</span>}
</div><div class='line not-executable'><span class='num'>282</span>
</div><div class='line not-executable'><span class='num'>283</span>interface GraphDatabaseInterface
</div><div class='line not-executable'><span class='num'>284</span>{
</div><div class='line not-executable'><span class='num'>285</span>    public function getUser(string $id): ?array;
</div><div class='line not-executable'><span class='num'>286</span>    public function insertUser(string $id, string $group): void;
</div><div class='line not-executable'><span class='num'>287</span>    public function updateUser(string $id, string $group): void;
</div><div class='line not-executable'><span class='num'>288</span>
</div><div class='line not-executable'><span class='num'>289</span>    public function getNode(string $id): ?array;
</div><div class='line not-executable'><span class='num'>290</span>    public function getNodes(): array;
</div><div class='line not-executable'><span class='num'>291</span>    public function insertNode(string $id, string $label, string $category, string $type, array $data = []): void;
</div><div class='line not-executable'><span class='num'>292</span>    public function updateNode(string $id, string $label, string $category, string $type, array $data = []): void;
</div><div class='line not-executable'><span class='num'>293</span>    public function deleteNode(string $id): void;
</div><div class='line not-executable'><span class='num'>294</span>
</div><div class='line not-executable'><span class='num'>295</span>    public function getEdge(string $source, string $target): ?array;
</div><div class='line not-executable'><span class='num'>296</span>    public function getEdgeById(string $id): ?array;
</div><div class='line not-executable'><span class='num'>297</span>    public function getEdges(): array;
</div><div class='line not-executable'><span class='num'>298</span>    public function insertEdge(string $id, string $source, string $target, array $data = []): void;
</div><div class='line not-executable'><span class='num'>299</span>    public function updateEdge(string $id, string $source, string $target, array $data = []): void;
</div><div class='line not-executable'><span class='num'>300</span>    public function deleteEdge(string $id): void;
</div><div class='line not-executable'><span class='num'>301</span>
</div><div class='line not-executable'><span class='num'>302</span>    public function getStatuses(): array;
</div><div class='line not-executable'><span class='num'>303</span>    public function getNodeStatus(string $id): ?string;
</div><div class='line not-executable'><span class='num'>304</span>    public function setNodeStatus(string $id, string $status): void;
</div><div class='line not-executable'><span class='num'>305</span>
</div><div class='line not-executable'><span class='num'>306</span>    public function getLogs($limit): array;
</div><div class='line not-executable'><span class='num'>307</span>    public function insertAuditLog(
</div><div class='line not-executable'><span class='num'>308</span>        string $entity_type, 
</div><div class='line not-executable'><span class='num'>309</span>        string $entity_id, 
</div><div class='line not-executable'><span class='num'>310</span>        string $action, 
</div><div class='line not-executable'><span class='num'>311</span>        ?array $old_data = null, 
</div><div class='line not-executable'><span class='num'>312</span>        ?array $new_data = null,
</div><div class='line not-executable'><span class='num'>313</span>        string $user_id,
</div><div class='line not-executable'><span class='num'>314</span>        string $ip_address): bool;
</div><div class='line not-executable'><span class='num'>315</span>}
</div><div class='line not-executable'><span class='num'>316</span>
</div><div class='line not-executable'><span class='num'>317</span>final class DatabaseException extends RuntimeException
</div><div class='line not-executable'><span class='num'>318</span>{
</div><div class='line not-executable'><span class='num'>319</span>    private ?string $query;
</div><div class='line not-executable'><span class='num'>320</span>    private ?array $params;
</div><div class='line not-executable'><span class='num'>321</span>
</div><div class='line not-executable'><span class='num'>322</span>    
</div><div class='line not-executable'><span class='num'>323</span>    public function __construct(string $message = &quot;&quot;,  int $code = 0, ?Throwable $previous = null, ?string $query = null, ?array $params) {
</div><div class='line not-covered'><span class='num'>324</span>        parent::__construct($message, $code, $previous);
</div><div class='line not-covered'><span class='num'>325</span>        $this-&gt;query = $query;
</div><div class='line not-covered'><span class='num'>326</span>        $this-&gt;params = $params;
</div><div class='line not-covered'><span class='num'>327</span>    }
</div><div class='line not-executable'><span class='num'>328</span>}
</div><div class='line not-executable'><span class='num'>329</span>
</div><div class='line not-executable'><span class='num'>330</span>final class GraphDatabase implements GraphDatabaseInterface
</div><div class='line not-executable'><span class='num'>331</span>{
</div><div class='line not-executable'><span class='num'>332</span>    private PDO $pdo;
</div><div class='line not-executable'><span class='num'>333</span>    private Logger $logger;
</div><div class='line not-executable'><span class='num'>334</span>
</div><div class='line not-executable'><span class='num'>335</span>    public function __construct(PDO $pdo, Logger $logger)
</div><div class='line not-executable'><span class='num'>336</span>    {
</div><div class='line covered'><span class='num'>337</span>        $this-&gt;pdo = $pdo;
</div><div class='line covered'><span class='num'>338</span>        $this-&gt;logger = $logger;
</div><div class='line covered'><span class='num'>339</span>        $this-&gt;initSchema();
</div><div class='line covered'><span class='num'>340</span>    }
</div><div class='line not-executable'><span class='num'>341</span>
</div><div class='line not-executable'><span class='num'>342</span>    public function getUser(string $id): ?array
</div><div class='line not-executable'><span class='num'>343</span>    {
</div><div class='line not-covered'><span class='num'>344</span>        $this-&gt;logger-&gt;debug(&quot;getting user id: &#039;{$id}&#039;&quot;);
</div><div class='line not-executable'><span class='num'>345</span>        try {
</div><div class='line not-covered'><span class='num'>346</span>            $sql = &quot;SELECT * FROM users WHERE id = :id&quot;;
</div><div class='line not-covered'><span class='num'>347</span>            $params = [&#039;:id&#039; =&gt; $id];
</div><div class='line not-covered'><span class='num'>348</span>            $stmt = $this-&gt;pdo-&gt;prepare($sql);
</div><div class='line not-covered'><span class='num'>349</span>            $stmt-&gt;execute($params);
</div><div class='line not-covered'><span class='num'>350</span>            $row = $stmt-&gt;fetch();
</div><div class='line not-executable'><span class='num'>351</span>
</div><div class='line not-covered'><span class='num'>352</span>            if ($row) {
</div><div class='line not-covered'><span class='num'>353</span>                return $row;
</div><div class='line not-executable'><span class='num'>354</span>            }
</div><div class='line not-covered'><span class='num'>355</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>356</span>            $e = new DatabaseException(
</div><div class='line not-covered'><span class='num'>357</span>                &quot;GraphDatabase Exception while trying to get user data. ID: {$id}&quot;,
</div><div class='line not-covered'><span class='num'>358</span>                0,
</div><div class='line not-executable'><span class='num'>359</span>                $e,
</div><div class='line not-executable'><span class='num'>360</span>                $sql,
</div><div class='line not-executable'><span class='num'>361</span>                $params
</div><div class='line not-executable'><span class='num'>362</span>            );
</div><div class='line not-executable'><span class='num'>363</span>        }
</div><div class='line not-covered'><span class='num'>364</span>        return null;
</div><div class='line not-covered'><span class='num'>365</span>    }
</div><div class='line not-executable'><span class='num'>366</span>
</div><div class='line not-executable'><span class='num'>367</span>    public function insertUser(string $id, string $group): void
</div><div class='line not-executable'><span class='num'>368</span>    {
</div><div class='line not-executable'><span class='num'>369</span>        try {
</div><div class='line not-covered'><span class='num'>370</span>            $sql = &quot;
</div><div class='line not-executable'><span class='num'>371</span>                INSERT OR IGNORE INTO users 
</div><div class='line not-executable'><span class='num'>372</span>                (id, user_group)
</div><div class='line not-executable'><span class='num'>373</span>                VALUES (:id, :group)&quot;;
</div><div class='line not-executable'><span class='num'>374</span>            
</div><div class='line not-covered'><span class='num'>375</span>            $params = [
</div><div class='line not-covered'><span class='num'>376</span>                &#039;:id&#039;       =&gt; $id,
</div><div class='line not-covered'><span class='num'>377</span>                &#039;:group&#039;    =&gt; $group
</div><div class='line not-executable'><span class='num'>378</span>            ];
</div><div class='line not-executable'><span class='num'>379</span>
</div><div class='line not-covered'><span class='num'>380</span>            $stmt = $this-&gt;pdo-&gt;prepare($sql);
</div><div class='line not-covered'><span class='num'>381</span>            $stmt-&gt;execute($params);
</div><div class='line not-covered'><span class='num'>382</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>383</span>            $e = new DatabaseException(
</div><div class='line not-covered'><span class='num'>384</span>                &quot;GraphDatabase Exception while trying to insert new user. ID: {$id}&quot;,
</div><div class='line not-covered'><span class='num'>385</span>                0,
</div><div class='line not-executable'><span class='num'>386</span>                $e,
</div><div class='line not-executable'><span class='num'>387</span>                $sql,
</div><div class='line not-executable'><span class='num'>388</span>                $params
</div><div class='line not-executable'><span class='num'>389</span>            );
</div><div class='line not-executable'><span class='num'>390</span>        }
</div><div class='line not-covered'><span class='num'>391</span>    }
</div><div class='line not-executable'><span class='num'>392</span>
</div><div class='line not-executable'><span class='num'>393</span>    public function updateUser(string $id, string $group): void
</div><div class='line not-executable'><span class='num'>394</span>    {
</div><div class='line not-executable'><span class='num'>395</span>        try {
</div><div class='line not-covered'><span class='num'>396</span>            $sql = &quot;
</div><div class='line not-executable'><span class='num'>397</span>                UPDATE users
</div><div class='line not-executable'><span class='num'>398</span>                SET    user_group = :group
</div><div class='line not-executable'><span class='num'>399</span>                WHERE  id = :id
</div><div class='line not-executable'><span class='num'>400</span>            &quot;;
</div><div class='line not-executable'><span class='num'>401</span>
</div><div class='line not-covered'><span class='num'>402</span>            $params = [
</div><div class='line not-covered'><span class='num'>403</span>                &#039;:id&#039;       =&gt; $id,
</div><div class='line not-covered'><span class='num'>404</span>                &#039;:group&#039;    =&gt; $group
</div><div class='line not-executable'><span class='num'>405</span>            ];
</div><div class='line not-executable'><span class='num'>406</span>
</div><div class='line not-covered'><span class='num'>407</span>            $stmt = $this-&gt;pdo-&gt;prepare($sql);
</div><div class='line not-executable'><span class='num'>408</span>            
</div><div class='line not-covered'><span class='num'>409</span>            $stmt-&gt;execute($params);
</div><div class='line not-executable'><span class='num'>410</span>
</div><div class='line not-covered'><span class='num'>411</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>412</span>            $e = new DatabaseException(
</div><div class='line not-covered'><span class='num'>413</span>                &quot;GraphDatabase Exception while trying to update user. ID: {$id}&quot;,
</div><div class='line not-covered'><span class='num'>414</span>                0,
</div><div class='line not-executable'><span class='num'>415</span>                $e,
</div><div class='line not-executable'><span class='num'>416</span>                $sql,
</div><div class='line not-executable'><span class='num'>417</span>                $params
</div><div class='line not-executable'><span class='num'>418</span>            );
</div><div class='line not-executable'><span class='num'>419</span>        }
</div><div class='line not-covered'><span class='num'>420</span>    }
</div><div class='line not-executable'><span class='num'>421</span>
</div><div class='line not-executable'><span class='num'>422</span>    public function getNode(string $id): ?array
</div><div class='line not-executable'><span class='num'>423</span>    {
</div><div class='line covered'><span class='num'>424</span>        $this-&gt;logger-&gt;debug(&quot;fetching node &#039;{$id}&#039;&quot;);
</div><div class='line not-executable'><span class='num'>425</span>
</div><div class='line not-executable'><span class='num'>426</span>        try {
</div><div class='line covered'><span class='num'>427</span>            $sql = &quot;SELECT * FROM nodes WHERE id = :id&quot;;
</div><div class='line covered'><span class='num'>428</span>            $params = [&#039;:id&#039; =&gt; $id];
</div><div class='line covered'><span class='num'>429</span>            $stmt = $this-&gt;pdo-&gt;prepare($sql);
</div><div class='line covered'><span class='num'>430</span>            $stmt-&gt;execute($params);
</div><div class='line covered'><span class='num'>431</span>            $row = $stmt-&gt;fetch();
</div><div class='line covered'><span class='num'>432</span>            if ($row) {
</div><div class='line covered'><span class='num'>433</span>                return $row;
</div><div class='line not-executable'><span class='num'>434</span>            }
</div><div class='line not-covered'><span class='num'>435</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>436</span>            $this-&gt;logger-&gt;error(&quot;exception with node id &#039;{$id}&#039;&quot;);
</div><div class='line not-covered'><span class='num'>437</span>            throw new DatabaseException(&quot;could not get node data with id &#039;{$id}&#039;&quot;, 0, $e, $sql, $params);
</div><div class='line not-executable'><span class='num'>438</span>        }
</div><div class='line not-covered'><span class='num'>439</span>        return null;
</div><div class='line not-covered'><span class='num'>440</span>    }
</div><div class='line not-executable'><span class='num'>441</span>
</div><div class='line not-executable'><span class='num'>442</span>    public function getNodes(): array
</div><div class='line not-executable'><span class='num'>443</span>    {
</div><div class='line not-executable'><span class='num'>444</span>        try {
</div><div class='line not-covered'><span class='num'>445</span>            $stmt = $this-&gt;pdo-&gt;query(&quot;SELECT * FROM nodes&quot;);
</div><div class='line not-covered'><span class='num'>446</span>            $rows = $stmt-&gt;fetchAll();
</div><div class='line not-covered'><span class='num'>447</span>            return $rows;
</div><div class='line not-covered'><span class='num'>448</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>449</span>            error_log(&quot;GraphDatabase fetch all nodes failed: &quot; . $e-&gt;getMessage());
</div><div class='line not-covered'><span class='num'>450</span>            return [];
</div><div class='line not-executable'><span class='num'>451</span>        }
</div><div class='line not-covered'><span class='num'>452</span>    }
</div><div class='line not-executable'><span class='num'>453</span>
</div><div class='line not-executable'><span class='num'>454</span>    public function insertNode(string $id, string $label, string $category, string $type, array $data = []): void
</div><div class='line not-executable'><span class='num'>455</span>    {
</div><div class='line not-executable'><span class='num'>456</span>        try {
</div><div class='line covered'><span class='num'>457</span>            $sql = &quot;
</div><div class='line not-executable'><span class='num'>458</span>                INSERT OR IGNORE INTO nodes 
</div><div class='line not-executable'><span class='num'>459</span>                (id, label, category, type, data) 
</div><div class='line not-executable'><span class='num'>460</span>                VALUES (:id, :label, :category, :type, :data)&quot;;
</div><div class='line covered'><span class='num'>461</span>            $stmt             = $this-&gt;pdo-&gt;prepare($sql);
</div><div class='line covered'><span class='num'>462</span>            $data[&#039;id&#039;]       = $id;
</div><div class='line covered'><span class='num'>463</span>            $data[&#039;label&#039;]    = $label;
</div><div class='line covered'><span class='num'>464</span>            $data[&#039;category&#039;] = $category;
</div><div class='line covered'><span class='num'>465</span>            $data[&#039;type&#039;]     = $type;
</div><div class='line covered'><span class='num'>466</span>            $stmt-&gt;execute([
</div><div class='line covered'><span class='num'>467</span>                &#039;:id&#039;       =&gt; $id,
</div><div class='line covered'><span class='num'>468</span>                &#039;:label&#039;    =&gt; $label,
</div><div class='line covered'><span class='num'>469</span>                &#039;:category&#039; =&gt; $category,
</div><div class='line covered'><span class='num'>470</span>                &#039;:type&#039;     =&gt; $type,
</div><div class='line covered'><span class='num'>471</span>                &#039;:data&#039;     =&gt; json_encode($data, JSON_UNESCAPED_UNICODE)
</div><div class='line not-executable'><span class='num'>472</span>            ]);
</div><div class='line not-covered'><span class='num'>473</span>        } catch (PDOException $e) {
</div><div class='line not-executable'><span class='num'>474</span>            // TODO
</div><div class='line not-executable'><span class='num'>475</span>        }
</div><div class='line covered'><span class='num'>476</span>    }
</div><div class='line not-executable'><span class='num'>477</span>
</div><div class='line not-executable'><span class='num'>478</span>    public function updateNode(string $id, string $label, string $category, string $type, array $data = []): void
</div><div class='line not-executable'><span class='num'>479</span>    {
</div><div class='line not-executable'><span class='num'>480</span>        try {
</div><div class='line not-covered'><span class='num'>481</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-executable'><span class='num'>482</span>                UPDATE nodes
</div><div class='line not-executable'><span class='num'>483</span>                SET    label = :label, 
</div><div class='line not-executable'><span class='num'>484</span>                       category = :category, 
</div><div class='line not-executable'><span class='num'>485</span>                       type = :type, 
</div><div class='line not-executable'><span class='num'>486</span>                       data = :data
</div><div class='line not-executable'><span class='num'>487</span>                WHERE  id = :id&quot;);
</div><div class='line not-covered'><span class='num'>488</span>            $data[&#039;id&#039;]       = $id;
</div><div class='line not-covered'><span class='num'>489</span>            $data[&#039;label&#039;]    = $label;
</div><div class='line not-covered'><span class='num'>490</span>            $data[&#039;category&#039;] = $category;
</div><div class='line not-covered'><span class='num'>491</span>            $data[&#039;type&#039;]     = $type;
</div><div class='line not-executable'><span class='num'>492</span>
</div><div class='line not-covered'><span class='num'>493</span>            $stmt-&gt;execute([
</div><div class='line not-covered'><span class='num'>494</span>                &#039;:id&#039;       =&gt; $id,
</div><div class='line not-covered'><span class='num'>495</span>                &#039;:label&#039;    =&gt; $label,
</div><div class='line not-covered'><span class='num'>496</span>                &#039;:category&#039; =&gt; $category,
</div><div class='line not-covered'><span class='num'>497</span>                &#039;:type&#039;     =&gt; $type,
</div><div class='line not-covered'><span class='num'>498</span>                &#039;:data&#039;     =&gt; json_encode($data, JSON_UNESCAPED_UNICODE)
</div><div class='line not-executable'><span class='num'>499</span>            ]);
</div><div class='line not-covered'><span class='num'>500</span>        } catch (PDOException $e) {
</div><div class='line not-executable'><span class='num'>501</span>            // TODO
</div><div class='line not-executable'><span class='num'>502</span>        }
</div><div class='line not-covered'><span class='num'>503</span>    }
</div><div class='line not-executable'><span class='num'>504</span>
</div><div class='line not-executable'><span class='num'>505</span>    public function deleteNode(string $id): void
</div><div class='line not-executable'><span class='num'>506</span>    {
</div><div class='line not-executable'><span class='num'>507</span>        try {
</div><div class='line not-covered'><span class='num'>508</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;DELETE FROM nodes WHERE id = :id&quot;);
</div><div class='line not-covered'><span class='num'>509</span>            $stmt-&gt;execute([&#039;:id&#039; =&gt; $id]);
</div><div class='line not-covered'><span class='num'>510</span>        } catch (PDOException $e) {
</div><div class='line not-executable'><span class='num'>511</span>            // TODO
</div><div class='line not-executable'><span class='num'>512</span>        }
</div><div class='line not-covered'><span class='num'>513</span>    }
</div><div class='line not-executable'><span class='num'>514</span>
</div><div class='line not-executable'><span class='num'>515</span>    public function getEdge(string $source, string $target): ?array
</div><div class='line not-executable'><span class='num'>516</span>    {
</div><div class='line not-executable'><span class='num'>517</span>        try {
</div><div class='line covered'><span class='num'>518</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-executable'><span class='num'>519</span>                SELECT * FROM edges
</div><div class='line not-executable'><span class='num'>520</span>                WHERE source = :source AND target = :target
</div><div class='line not-executable'><span class='num'>521</span>            &quot;);
</div><div class='line covered'><span class='num'>522</span>            $stmt-&gt;execute([
</div><div class='line covered'><span class='num'>523</span>                &#039;:source&#039; =&gt; $source,
</div><div class='line covered'><span class='num'>524</span>                &#039;:target&#039; =&gt; $target
</div><div class='line not-executable'><span class='num'>525</span>            ]);
</div><div class='line covered'><span class='num'>526</span>            $row = $stmt-&gt;fetch();
</div><div class='line covered'><span class='num'>527</span>            if ($row) {
</div><div class='line covered'><span class='num'>528</span>                return $row;
</div><div class='line not-executable'><span class='num'>529</span>            }
</div><div class='line not-covered'><span class='num'>530</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>531</span>            error_log(&quot;GraphDatabase edge exists check failed: &quot; . $e-&gt;getMessage());
</div><div class='line not-executable'><span class='num'>532</span>        }
</div><div class='line covered'><span class='num'>533</span>        return null;
</div><div class='line not-covered'><span class='num'>534</span>    }
</div><div class='line not-executable'><span class='num'>535</span>
</div><div class='line not-executable'><span class='num'>536</span>    public function getEdgeById(string $id): ?array
</div><div class='line not-executable'><span class='num'>537</span>    {
</div><div class='line not-executable'><span class='num'>538</span>        try {
</div><div class='line not-covered'><span class='num'>539</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-executable'><span class='num'>540</span>                SELECT * FROM edges
</div><div class='line not-executable'><span class='num'>541</span>                WHERE id = :id
</div><div class='line not-executable'><span class='num'>542</span>            &quot;);
</div><div class='line not-covered'><span class='num'>543</span>            $stmt-&gt;execute([
</div><div class='line not-covered'><span class='num'>544</span>                &#039;:id&#039; =&gt; $id,
</div><div class='line not-executable'><span class='num'>545</span>            ]);
</div><div class='line not-covered'><span class='num'>546</span>            $row = $stmt-&gt;fetch();
</div><div class='line not-covered'><span class='num'>547</span>            if ($row) {
</div><div class='line not-covered'><span class='num'>548</span>                return $row;
</div><div class='line not-executable'><span class='num'>549</span>            }
</div><div class='line not-covered'><span class='num'>550</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>551</span>            error_log(&quot;GraphDatabase edge exists check failed: &quot; . $e-&gt;getMessage());
</div><div class='line not-executable'><span class='num'>552</span>        }
</div><div class='line not-covered'><span class='num'>553</span>        return null;
</div><div class='line not-covered'><span class='num'>554</span>    }
</div><div class='line not-executable'><span class='num'>555</span>
</div><div class='line not-executable'><span class='num'>556</span>    public function getEdges(): array
</div><div class='line not-executable'><span class='num'>557</span>    {
</div><div class='line not-executable'><span class='num'>558</span>        try {
</div><div class='line not-covered'><span class='num'>559</span>            $stmt  = $this-&gt;pdo-&gt;query(&quot;SELECT * FROM edges&quot;);
</div><div class='line not-covered'><span class='num'>560</span>            $rows  = $stmt-&gt;fetchAll();
</div><div class='line not-covered'><span class='num'>561</span>            return $rows;
</div><div class='line not-covered'><span class='num'>562</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>563</span>            error_log(&quot;GraphDatabase fetch all edges failed: &quot; . $e-&gt;getMessage());
</div><div class='line not-covered'><span class='num'>564</span>            return [];
</div><div class='line not-executable'><span class='num'>565</span>        }
</div><div class='line not-covered'><span class='num'>566</span>    }
</div><div class='line not-executable'><span class='num'>567</span>
</div><div class='line not-executable'><span class='num'>568</span>    public function insertEdge(string $id, string $source, string $target, array $data = []): void
</div><div class='line not-executable'><span class='num'>569</span>    {
</div><div class='line not-executable'><span class='num'>570</span>        // verify if the inverse edge exists
</div><div class='line covered'><span class='num'>571</span>        $r = $this-&gt;getEdge($target, $source);
</div><div class='line not-executable'><span class='num'>572</span>        
</div><div class='line not-executable'><span class='num'>573</span>        try {
</div><div class='line covered'><span class='num'>574</span>            $sql = &quot;
</div><div class='line not-executable'><span class='num'>575</span>                INSERT OR IGNORE INTO edges
</div><div class='line not-executable'><span class='num'>576</span>                (id, source, target, data)
</div><div class='line not-executable'><span class='num'>577</span>                VALUES (:id, :source, :target, :data)&quot;;
</div><div class='line covered'><span class='num'>578</span>            $stmt           = $this-&gt;pdo-&gt;prepare($sql);
</div><div class='line covered'><span class='num'>579</span>            $data[&#039;id&#039;]     = $id;
</div><div class='line covered'><span class='num'>580</span>            $data[&#039;source&#039;] = $source;
</div><div class='line covered'><span class='num'>581</span>            $data[&#039;target&#039;] = $target;
</div><div class='line covered'><span class='num'>582</span>            $stmt-&gt;execute([
</div><div class='line covered'><span class='num'>583</span>                &#039;:id&#039;     =&gt; $id,
</div><div class='line covered'><span class='num'>584</span>                &#039;:source&#039; =&gt; $source,
</div><div class='line covered'><span class='num'>585</span>                &#039;:target&#039; =&gt; $target,
</div><div class='line covered'><span class='num'>586</span>                &#039;:data&#039;   =&gt; json_encode($data, JSON_UNESCAPED_UNICODE)
</div><div class='line not-executable'><span class='num'>587</span>            ]);
</div><div class='line covered'><span class='num'>588</span>        } catch (PDOException $e) {
</div><div class='line not-executable'><span class='num'>589</span>            // TODO
</div><div class='line not-executable'><span class='num'>590</span>        }
</div><div class='line covered'><span class='num'>591</span>    }
</div><div class='line not-executable'><span class='num'>592</span>
</div><div class='line not-executable'><span class='num'>593</span>    public function updateEdge(string $id, string $source, string $target, array $data = []): void
</div><div class='line not-executable'><span class='num'>594</span>    {
</div><div class='line not-executable'><span class='num'>595</span>        try {
</div><div class='line not-covered'><span class='num'>596</span>            $data[&#039;id&#039;]     = $id;
</div><div class='line not-covered'><span class='num'>597</span>            $data[&#039;source&#039;] = $source;
</div><div class='line not-covered'><span class='num'>598</span>            $data[&#039;target&#039;] = $target;
</div><div class='line not-executable'><span class='num'>599</span>
</div><div class='line not-covered'><span class='num'>600</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-executable'><span class='num'>601</span>                UPDATE edges
</div><div class='line not-executable'><span class='num'>602</span>                SET data = :data
</div><div class='line not-executable'><span class='num'>603</span>                WHERE id = :id&quot;);
</div><div class='line not-covered'><span class='num'>604</span>            $stmt-&gt;execute([
</div><div class='line not-covered'><span class='num'>605</span>                &#039;:id&#039;   =&gt; $id,
</div><div class='line not-covered'><span class='num'>606</span>                &#039;:data&#039; =&gt; json_encode($data, JSON_UNESCAPED_UNICODE)
</div><div class='line not-executable'><span class='num'>607</span>            ]);
</div><div class='line not-covered'><span class='num'>608</span>        } catch (PDOException $e) {
</div><div class='line not-executable'><span class='num'>609</span>            // TODO
</div><div class='line not-executable'><span class='num'>610</span>        }
</div><div class='line not-covered'><span class='num'>611</span>    }
</div><div class='line not-executable'><span class='num'>612</span>
</div><div class='line not-executable'><span class='num'>613</span>    public function deleteEdge(string $id): void
</div><div class='line not-executable'><span class='num'>614</span>    {
</div><div class='line not-executable'><span class='num'>615</span>        try {
</div><div class='line not-covered'><span class='num'>616</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;DELETE FROM edges WHERE id = :id&quot;);
</div><div class='line not-covered'><span class='num'>617</span>            $stmt-&gt;execute([&#039;:id&#039; =&gt; $id]);
</div><div class='line not-covered'><span class='num'>618</span>        } catch (PDOException $e) {
</div><div class='line not-executable'><span class='num'>619</span>            // TODO
</div><div class='line not-executable'><span class='num'>620</span>        }
</div><div class='line not-covered'><span class='num'>621</span>    }
</div><div class='line not-executable'><span class='num'>622</span>
</div><div class='line not-executable'><span class='num'>623</span>    public function getStatuses(): array
</div><div class='line not-executable'><span class='num'>624</span>    {
</div><div class='line not-covered'><span class='num'>625</span>        $stmt   = $this-&gt;pdo-&gt;query(&quot;
</div><div class='line not-executable'><span class='num'>626</span>            SELECT n.id,
</div><div class='line not-executable'><span class='num'>627</span>                   s.status
</div><div class='line not-executable'><span class='num'>628</span>            FROM   nodes n
</div><div class='line not-executable'><span class='num'>629</span>            LEFT JOIN status s ON n.id = s.node_id&quot;);
</div><div class='line not-covered'><span class='num'>630</span>        $status = $stmt-&gt;fetchAll();
</div><div class='line not-covered'><span class='num'>631</span>        return $status;
</div><div class='line not-covered'><span class='num'>632</span>    }
</div><div class='line not-executable'><span class='num'>633</span>
</div><div class='line not-executable'><span class='num'>634</span>    public function getNodeStatus(string $id): ?string
</div><div class='line not-executable'><span class='num'>635</span>    {
</div><div class='line not-covered'><span class='num'>636</span>        $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-executable'><span class='num'>637</span>            SELECT s.status
</div><div class='line not-executable'><span class='num'>638</span>            FROM nodes n
</div><div class='line not-executable'><span class='num'>639</span>            LEFT JOIN status s
</div><div class='line not-executable'><span class='num'>640</span>            ON n.id = s.node_id
</div><div class='line not-executable'><span class='num'>641</span>            WHERE n.id = ?&quot;);
</div><div class='line not-covered'><span class='num'>642</span>        $stmt-&gt;execute([$id]);
</div><div class='line not-covered'><span class='num'>643</span>        $status = $stmt-&gt;fetch();
</div><div class='line not-covered'><span class='num'>644</span>        return $status ? $status[&#039;status&#039;] : null;
</div><div class='line not-covered'><span class='num'>645</span>    }
</div><div class='line not-executable'><span class='num'>646</span>
</div><div class='line not-executable'><span class='num'>647</span>    public function setNodeStatus(string $id, string $status): void
</div><div class='line not-executable'><span class='num'>648</span>    {
</div><div class='line not-covered'><span class='num'>649</span>        $stmt = $this-&gt;pdo-&gt;prepare(&quot;REPLACE INTO status (node_id, status) VALUES (?, ?)&quot;);
</div><div class='line not-covered'><span class='num'>650</span>        $stmt-&gt;execute([$id, $status]);
</div><div class='line not-covered'><span class='num'>651</span>    }
</div><div class='line not-executable'><span class='num'>652</span>
</div><div class='line not-executable'><span class='num'>653</span>    public function getLogs($limit): array
</div><div class='line not-executable'><span class='num'>654</span>    {
</div><div class='line not-covered'><span class='num'>655</span>        $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-executable'><span class='num'>656</span>            SELECT *
</div><div class='line not-executable'><span class='num'>657</span>            FROM audit
</div><div class='line not-executable'><span class='num'>658</span>            ORDER BY created_at DESC
</div><div class='line not-executable'><span class='num'>659</span>            LIMIT :limit
</div><div class='line not-executable'><span class='num'>660</span>        &quot;);
</div><div class='line not-covered'><span class='num'>661</span>        $stmt-&gt;bindValue(&#039;:limit&#039;, (int)$limit, PDO::PARAM_INT);
</div><div class='line not-covered'><span class='num'>662</span>        $stmt-&gt;execute();
</div><div class='line not-covered'><span class='num'>663</span>        $rows = $stmt-&gt;fetchAll();
</div><div class='line not-covered'><span class='num'>664</span>        return $rows;
</div><div class='line not-covered'><span class='num'>665</span>    }
</div><div class='line not-executable'><span class='num'>666</span>
</div><div class='line not-executable'><span class='num'>667</span>    public function insertAuditLog(string $entity_type, string $entity_id, string $action, ?array $old_data = null, ?array $new_data = null, string $user_id, string $ip_address): bool
</div><div class='line not-executable'><span class='num'>668</span>    {
</div><div class='line not-executable'><span class='num'>669</span>        try {
</div><div class='line covered'><span class='num'>670</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-executable'><span class='num'>671</span>                INSERT INTO audit (entity_type, entity_id, action, old_data, new_data, user_id, ip_address)
</div><div class='line not-executable'><span class='num'>672</span>                VALUES (:entity_type, :entity_id, :action, :old_data, :new_data, :user_id, :ip_address)
</div><div class='line not-executable'><span class='num'>673</span>            &quot;);
</div><div class='line not-executable'><span class='num'>674</span>
</div><div class='line covered'><span class='num'>675</span>            $stmt-&gt;execute([
</div><div class='line covered'><span class='num'>676</span>                &#039;:entity_type&#039; =&gt; $entity_type,
</div><div class='line covered'><span class='num'>677</span>                &#039;:entity_id&#039;   =&gt; $entity_id,
</div><div class='line covered'><span class='num'>678</span>                &#039;:action&#039;      =&gt; $action,
</div><div class='line not-covered'><span class='num'>679</span>                &#039;:old_data&#039;    =&gt; $old_data !== null ? json_encode($old_data, JSON_UNESCAPED_UNICODE) : null,
</div><div class='line covered'><span class='num'>680</span>                &#039;:new_data&#039;    =&gt; $new_data !== null ? json_encode($new_data, JSON_UNESCAPED_UNICODE) : null,
</div><div class='line covered'><span class='num'>681</span>                &#039;:user_id&#039;     =&gt; $user_id,
</div><div class='line covered'><span class='num'>682</span>                &#039;:ip_address&#039;  =&gt; $ip_address
</div><div class='line not-executable'><span class='num'>683</span>            ]);
</div><div class='line covered'><span class='num'>684</span>            return true;
</div><div class='line not-covered'><span class='num'>685</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>686</span>            error_log(&quot;GraphDatabase audit log insert failed: &quot; . $e-&gt;getMessage());
</div><div class='line not-covered'><span class='num'>687</span>            return false;
</div><div class='line not-executable'><span class='num'>688</span>        }
</div><div class='line not-covered'><span class='num'>689</span>    }
</div><div class='line not-executable'><span class='num'>690</span>
</div><div class='line not-executable'><span class='num'>691</span>    private function initSchema(): void
</div><div class='line not-executable'><span class='num'>692</span>    {
</div><div class='line covered'><span class='num'>693</span>        $this-&gt;pdo-&gt;exec(&quot;
</div><div class='line not-executable'><span class='num'>694</span>            CREATE TABLE IF NOT EXISTS users (
</div><div class='line not-executable'><span class='num'>695</span>                id TEXT PRIMARY KEY,
</div><div class='line not-executable'><span class='num'>696</span>                user_group TEXT NOT NULL
</div><div class='line not-executable'><span class='num'>697</span>            )
</div><div class='line not-executable'><span class='num'>698</span>        &quot;);
</div><div class='line not-executable'><span class='num'>699</span>
</div><div class='line covered'><span class='num'>700</span>        $this-&gt;pdo-&gt;exec(&quot;INSERT INTO users VALUES(&#039;admin&#039;, &#039;admin&#039;)&quot;);
</div><div class='line not-executable'><span class='num'>701</span>
</div><div class='line covered'><span class='num'>702</span>        $this-&gt;pdo-&gt;exec(&quot;
</div><div class='line not-executable'><span class='num'>703</span>            CREATE TABLE IF NOT EXISTS nodes (
</div><div class='line not-executable'><span class='num'>704</span>                id TEXT PRIMARY KEY,
</div><div class='line not-executable'><span class='num'>705</span>                label TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>706</span>                category TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>707</span>                type TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>708</span>                data TEXT NOT NULL
</div><div class='line not-executable'><span class='num'>709</span>            )
</div><div class='line not-executable'><span class='num'>710</span>        &quot;);
</div><div class='line not-executable'><span class='num'>711</span>
</div><div class='line covered'><span class='num'>712</span>        $this-&gt;pdo-&gt;exec(&quot;
</div><div class='line not-executable'><span class='num'>713</span>            CREATE TABLE IF NOT EXISTS edges (
</div><div class='line not-executable'><span class='num'>714</span>                id TEXT PRIMARY KEY,
</div><div class='line not-executable'><span class='num'>715</span>                source TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>716</span>                target TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>717</span>                data TEXT,
</div><div class='line not-executable'><span class='num'>718</span>                FOREIGN KEY (source) REFERENCES nodes(id) ON DELETE CASCADE,
</div><div class='line not-executable'><span class='num'>719</span>                FOREIGN KEY (target) REFERENCES nodes(id) ON DELETE CASCADE
</div><div class='line not-executable'><span class='num'>720</span>            )
</div><div class='line not-executable'><span class='num'>721</span>        &quot;);
</div><div class='line not-executable'><span class='num'>722</span>
</div><div class='line covered'><span class='num'>723</span>        $this-&gt;pdo-&gt;exec(&quot;CREATE UNIQUE INDEX IF NOT EXISTS idx_edges_source_target ON edges (source, target)&quot;);
</div><div class='line not-executable'><span class='num'>724</span>
</div><div class='line covered'><span class='num'>725</span>        $this-&gt;pdo-&gt;exec(&quot;
</div><div class='line not-executable'><span class='num'>726</span>            CREATE TABLE IF NOT EXISTS status (
</div><div class='line not-executable'><span class='num'>727</span>                node_id TEXT PRIMARY KEY NOT NULL,
</div><div class='line not-executable'><span class='num'>728</span>                status TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>729</span>                created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
</div><div class='line not-executable'><span class='num'>730</span>                FOREIGN KEY (node_id) REFERENCES nodes(id) ON DELETE CASCADE
</div><div class='line not-executable'><span class='num'>731</span>            )
</div><div class='line not-executable'><span class='num'>732</span>        &quot;);
</div><div class='line not-executable'><span class='num'>733</span>
</div><div class='line covered'><span class='num'>734</span>        $this-&gt;pdo-&gt;exec(&quot;CREATE INDEX IF NOT EXISTS idx_node_status_node_id ON status (node_id)&quot;);
</div><div class='line not-executable'><span class='num'>735</span>
</div><div class='line covered'><span class='num'>736</span>        $this-&gt;pdo-&gt;exec(&quot;
</div><div class='line not-executable'><span class='num'>737</span>            CREATE TABLE IF NOT EXISTS audit (
</div><div class='line not-executable'><span class='num'>738</span>                id INTEGER PRIMARY KEY AUTOINCREMENT,
</div><div class='line not-executable'><span class='num'>739</span>                entity_type TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>740</span>                entity_id TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>741</span>                action TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>742</span>                old_data TEXT,
</div><div class='line not-executable'><span class='num'>743</span>                new_data TEXT,
</div><div class='line not-executable'><span class='num'>744</span>                user_id TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>745</span>                ip_address TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>746</span>                created_at DATETIME DEFAULT CURRENT_TIMESTAMP
</div><div class='line not-executable'><span class='num'>747</span>            )
</div><div class='line not-executable'><span class='num'>748</span>        &quot;);
</div><div class='line covered'><span class='num'>749</span>    }
</div><div class='line not-executable'><span class='num'>750</span>
</div><div class='line not-executable'><span class='num'>751</span>    public static function createConnection(string $dsn): PDO
</div><div class='line not-executable'><span class='num'>752</span>    {
</div><div class='line covered'><span class='num'>753</span>        $pdo = new PDO($dsn);
</div><div class='line covered'><span class='num'>754</span>        $pdo-&gt;setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
</div><div class='line covered'><span class='num'>755</span>        $pdo-&gt;setAttribute(PDO::ATTR_DEFAULT_FETCH_MODE, PDO::FETCH_ASSOC);
</div><div class='line covered'><span class='num'>756</span>        $pdo-&gt;exec(&#039;PRAGMA foreign_keys = ON&#039;);
</div><div class='line covered'><span class='num'>757</span>        return $pdo;
</div><div class='line not-covered'><span class='num'>758</span>    }
</div><div class='line not-executable'><span class='num'>759</span>}
</div><div class='line not-executable'><span class='num'>760</span>
</div><div class='line not-executable'><span class='num'>761</span>final class GraphServiceException extends RuntimeException
</div><div class='line not-executable'><span class='num'>762</span>{
</div><div class='line not-executable'><span class='num'>763</span>}
</div><div class='line not-executable'><span class='num'>764</span>
</div><div class='line not-executable'><span class='num'>765</span>interface GraphServiceInterface
</div><div class='line not-executable'><span class='num'>766</span>{
</div><div class='line not-executable'><span class='num'>767</span>    public function getUser(string $id): ?User;
</div><div class='line not-executable'><span class='num'>768</span>    public function insertUser(User $user): void;
</div><div class='line not-executable'><span class='num'>769</span>    public function updateUser(User $user): void;
</div><div class='line not-executable'><span class='num'>770</span>
</div><div class='line not-executable'><span class='num'>771</span>    public function getGraph(): Graph;
</div><div class='line not-executable'><span class='num'>772</span>
</div><div class='line not-executable'><span class='num'>773</span>    public function getNode(string $id): ?Node;
</div><div class='line not-executable'><span class='num'>774</span>    public function getNodes(): Nodes;
</div><div class='line not-executable'><span class='num'>775</span>    public function insertNode(Node $node): void;
</div><div class='line not-executable'><span class='num'>776</span>    public function updateNode(Node $node): void;
</div><div class='line not-executable'><span class='num'>777</span>    public function deleteNode(string $id): void;
</div><div class='line not-executable'><span class='num'>778</span>
</div><div class='line not-executable'><span class='num'>779</span>    public function getEdge(string $source, string $target): ?Edge;
</div><div class='line not-executable'><span class='num'>780</span>    public function getEdges(): Edges;
</div><div class='line not-executable'><span class='num'>781</span>    public function insertEdge(Edge $edge): void;
</div><div class='line not-executable'><span class='num'>782</span>    public function updateEdge(Edge $edge): void;
</div><div class='line not-executable'><span class='num'>783</span>    public function deleteEdge(string $id): void;
</div><div class='line not-executable'><span class='num'>784</span>
</div><div class='line not-executable'><span class='num'>785</span>    public function getStatuses(): NodeStatuses;
</div><div class='line not-executable'><span class='num'>786</span>    public function getNodeStatus(string $id): NodeStatus;
</div><div class='line not-executable'><span class='num'>787</span>    public function setNodeStatus(NodeStatus $status): void;
</div><div class='line not-executable'><span class='num'>788</span>
</div><div class='line not-executable'><span class='num'>789</span>    public function getLogs($limit): AuditLogs;
</div><div class='line not-executable'><span class='num'>790</span>}
</div><div class='line not-executable'><span class='num'>791</span>
</div><div class='line not-executable'><span class='num'>792</span>final class GraphService implements GraphServiceInterface
</div><div class='line not-executable'><span class='num'>793</span>{
</div><div class='line not-executable'><span class='num'>794</span>    private const SECURE_ACTIONS = [
</div><div class='line not-executable'><span class='num'>795</span>        &#039;GraphService::getGraph&#039;      =&gt; true,
</div><div class='line not-executable'><span class='num'>796</span>        &#039;GraphService::getNode&#039;       =&gt; true,
</div><div class='line not-executable'><span class='num'>797</span>        &#039;GraphService::getNodes&#039;      =&gt; true,
</div><div class='line not-executable'><span class='num'>798</span>        &#039;GraphService::getEdge&#039;       =&gt; true,
</div><div class='line not-executable'><span class='num'>799</span>        &#039;GraphService::getEdges&#039;      =&gt; true,
</div><div class='line not-executable'><span class='num'>800</span>        &#039;GraphService::getStatuses&#039;   =&gt; true,
</div><div class='line not-executable'><span class='num'>801</span>        &#039;GraphService::getNodeStatus&#039; =&gt; true,
</div><div class='line not-executable'><span class='num'>802</span>        &#039;GraphService::setNodeStatus&#039; =&gt; true,
</div><div class='line not-executable'><span class='num'>803</span>        &#039;GraphService::getLogs&#039;       =&gt; true,
</div><div class='line not-executable'><span class='num'>804</span>        &#039;GraphService::insertNode&#039;    =&gt; false,
</div><div class='line not-executable'><span class='num'>805</span>        &#039;GraphService::updateNode&#039;    =&gt; false,
</div><div class='line not-executable'><span class='num'>806</span>        &#039;GraphService::deleteNode&#039;    =&gt; false,
</div><div class='line not-executable'><span class='num'>807</span>        &#039;GraphService::insertEdge&#039;    =&gt; false,
</div><div class='line not-executable'><span class='num'>808</span>        &#039;GraphService::updateEdge&#039;    =&gt; false,
</div><div class='line not-executable'><span class='num'>809</span>        &#039;GraphService::deleteEdge&#039;    =&gt; false,
</div><div class='line not-executable'><span class='num'>810</span>
</div><div class='line not-executable'><span class='num'>811</span>        &#039;GraphService::insertAuditLog&#039; =&gt; false,
</div><div class='line not-executable'><span class='num'>812</span>    ];
</div><div class='line not-executable'><span class='num'>813</span>
</div><div class='line not-executable'><span class='num'>814</span>    private GraphDatabaseInterface $db;
</div><div class='line not-executable'><span class='num'>815</span>    private Logger $logger;
</div><div class='line not-executable'><span class='num'>816</span>
</div><div class='line not-executable'><span class='num'>817</span>    public function __construct(GraphDatabaseInterface $db, Logger $logger)
</div><div class='line not-executable'><span class='num'>818</span>    {
</div><div class='line covered'><span class='num'>819</span>        $this-&gt;db = $db;
</div><div class='line covered'><span class='num'>820</span>        $this-&gt;logger = $logger;
</div><div class='line covered'><span class='num'>821</span>    }
</div><div class='line not-executable'><span class='num'>822</span>
</div><div class='line not-executable'><span class='num'>823</span>    public function getUser(string $id): ?User
</div><div class='line not-executable'><span class='num'>824</span>    {
</div><div class='line not-covered'><span class='num'>825</span>        $data = $this-&gt;db-&gt;getUser($id);
</div><div class='line not-covered'><span class='num'>826</span>        if ($data) {
</div><div class='line not-covered'><span class='num'>827</span>            $user = new User($id, null, $data[&#039;user_group&#039;]);
</div><div class='line not-covered'><span class='num'>828</span>            return $user;
</div><div class='line not-executable'><span class='num'>829</span>        }
</div><div class='line not-covered'><span class='num'>830</span>        return null;
</div><div class='line not-covered'><span class='num'>831</span>    }
</div><div class='line not-executable'><span class='num'>832</span>
</div><div class='line not-executable'><span class='num'>833</span>    public function insertUser(User $user): void
</div><div class='line not-executable'><span class='num'>834</span>    {
</div><div class='line not-covered'><span class='num'>835</span>        $this-&gt;db-&gt;insertUser($user-&gt;id, $user-&gt;group-&gt;id);
</div><div class='line not-covered'><span class='num'>836</span>    }
</div><div class='line not-executable'><span class='num'>837</span>
</div><div class='line not-executable'><span class='num'>838</span>    public function updateUser(User $user): void
</div><div class='line not-executable'><span class='num'>839</span>    {
</div><div class='line not-covered'><span class='num'>840</span>        $this-&gt;db-&gt;updateUser($user-&gt;id, $user-&gt;group-&gt;id);
</div><div class='line not-covered'><span class='num'>841</span>    }
</div><div class='line not-executable'><span class='num'>842</span>
</div><div class='line not-executable'><span class='num'>843</span>    public function getGraph(): Graph
</div><div class='line not-executable'><span class='num'>844</span>    {
</div><div class='line not-covered'><span class='num'>845</span>        $nodes = $this-&gt;getNodes()-&gt;nodes;
</div><div class='line not-covered'><span class='num'>846</span>        $edges = $this-&gt;getEdges()-&gt;edges;
</div><div class='line not-covered'><span class='num'>847</span>        return new Graph($nodes, $edges);
</div><div class='line not-covered'><span class='num'>848</span>    }
</div><div class='line not-executable'><span class='num'>849</span>
</div><div class='line not-executable'><span class='num'>850</span>    public function getNode(string $id): ?Node
</div><div class='line not-executable'><span class='num'>851</span>    {
</div><div class='line covered'><span class='num'>852</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>853</span>            throw new RuntimeException(&quot;Permission denied to get node.&quot;);
</div><div class='line not-executable'><span class='num'>854</span>        }
</div><div class='line not-executable'><span class='num'>855</span>
</div><div class='line covered'><span class='num'>856</span>        $data = $this-&gt;db-&gt;getNode($id);
</div><div class='line covered'><span class='num'>857</span>        if ($data) {
</div><div class='line covered'><span class='num'>858</span>            return new Node(
</div><div class='line covered'><span class='num'>859</span>                $data[&#039;id&#039;],
</div><div class='line covered'><span class='num'>860</span>                $data[&#039;label&#039;],
</div><div class='line covered'><span class='num'>861</span>                $data[&#039;category&#039;],
</div><div class='line covered'><span class='num'>862</span>                $data[&#039;type&#039;],
</div><div class='line covered'><span class='num'>863</span>                json_decode($data[&#039;data&#039;], true)
</div><div class='line not-executable'><span class='num'>864</span>            );
</div><div class='line not-executable'><span class='num'>865</span>        }
</div><div class='line not-covered'><span class='num'>866</span>        return null;
</div><div class='line not-covered'><span class='num'>867</span>    }
</div><div class='line not-executable'><span class='num'>868</span>
</div><div class='line not-executable'><span class='num'>869</span>    public function getNodes(): Nodes
</div><div class='line not-executable'><span class='num'>870</span>    {
</div><div class='line not-covered'><span class='num'>871</span>        if(! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>872</span>            throw new RuntimeException(&quot;Permission denied to get nodes.&quot;);
</div><div class='line not-executable'><span class='num'>873</span>        }
</div><div class='line not-executable'><span class='num'>874</span>
</div><div class='line not-covered'><span class='num'>875</span>        $nodesData = $this-&gt;db-&gt;getNodes();
</div><div class='line not-covered'><span class='num'>876</span>        $nodes     = new Nodes();
</div><div class='line not-covered'><span class='num'>877</span>        foreach ($nodesData as $data) {
</div><div class='line not-covered'><span class='num'>878</span>            $node = new Node(
</div><div class='line not-covered'><span class='num'>879</span>                $data[&#039;id&#039;],
</div><div class='line not-covered'><span class='num'>880</span>                $data[&#039;label&#039;],
</div><div class='line not-covered'><span class='num'>881</span>                $data[&#039;category&#039;],
</div><div class='line not-covered'><span class='num'>882</span>                $data[&#039;type&#039;],
</div><div class='line not-covered'><span class='num'>883</span>                json_decode($data[&#039;data&#039;], true)
</div><div class='line not-executable'><span class='num'>884</span>            );
</div><div class='line not-covered'><span class='num'>885</span>            $nodes-&gt;addNode($node);
</div><div class='line not-executable'><span class='num'>886</span>        }
</div><div class='line not-covered'><span class='num'>887</span>        return $nodes;
</div><div class='line not-covered'><span class='num'>888</span>    }
</div><div class='line not-executable'><span class='num'>889</span>
</div><div class='line not-executable'><span class='num'>890</span>    public function insertNode(Node $node): void
</div><div class='line not-executable'><span class='num'>891</span>    {
</div><div class='line covered'><span class='num'>892</span>        $this-&gt;logger-&gt;debug(&#039;inserting node&#039;, $node-&gt;toArray());
</div><div class='line not-executable'><span class='num'>893</span>
</div><div class='line covered'><span class='num'>894</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>895</span>            $this-&gt;logger-&gt;info(&#039;permission denied&#039;, $node-&gt;toArray());
</div><div class='line not-covered'><span class='num'>896</span>            throw new GraphServiceException(&#039;permission denied&#039;);
</div><div class='line not-executable'><span class='num'>897</span>        }
</div><div class='line not-executable'><span class='num'>898</span>
</div><div class='line covered'><span class='num'>899</span>        $this-&gt;logger-&gt;info(&#039;permission allowed&#039;, $node-&gt;toArray());
</div><div class='line not-executable'><span class='num'>900</span>
</div><div class='line covered'><span class='num'>901</span>        $this-&gt;insertAuditLog(new AuditLog( &#039;node&#039;, $node-&gt;id, &#039;insert&#039;, null, $node-&gt;toArray()));
</div><div class='line not-executable'><span class='num'>902</span>
</div><div class='line covered'><span class='num'>903</span>        $this-&gt;db-&gt;insertNode(
</div><div class='line covered'><span class='num'>904</span>            $node-&gt;id,
</div><div class='line covered'><span class='num'>905</span>            $node-&gt;label,
</div><div class='line covered'><span class='num'>906</span>            $node-&gt;category,
</div><div class='line covered'><span class='num'>907</span>            $node-&gt;type,
</div><div class='line covered'><span class='num'>908</span>            $node-&gt;data
</div><div class='line not-executable'><span class='num'>909</span>        );
</div><div class='line covered'><span class='num'>910</span>    }
</div><div class='line not-executable'><span class='num'>911</span>
</div><div class='line not-executable'><span class='num'>912</span>    public function updateNode(Node $node): void
</div><div class='line not-executable'><span class='num'>913</span>    {
</div><div class='line not-covered'><span class='num'>914</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>915</span>            throw new RuntimeException(&quot;Permission denied to update node.&quot;);
</div><div class='line not-executable'><span class='num'>916</span>        }
</div><div class='line not-executable'><span class='num'>917</span>
</div><div class='line not-covered'><span class='num'>918</span>        $old = $this-&gt;getNode($node-&gt;id);
</div><div class='line not-covered'><span class='num'>919</span>        $this-&gt;insertAuditLog(new AuditLog( &#039;node&#039;, $node-&gt;id, &#039;update&#039;, $old-&gt;toArray(), $node-&gt;toArray()));
</div><div class='line not-executable'><span class='num'>920</span>
</div><div class='line not-covered'><span class='num'>921</span>        $this-&gt;db-&gt;updateNode(
</div><div class='line not-covered'><span class='num'>922</span>            $node-&gt;id,
</div><div class='line not-covered'><span class='num'>923</span>            $node-&gt;label,
</div><div class='line not-covered'><span class='num'>924</span>            $node-&gt;category,
</div><div class='line not-covered'><span class='num'>925</span>            $node-&gt;type,
</div><div class='line not-covered'><span class='num'>926</span>            $node-&gt;data
</div><div class='line not-executable'><span class='num'>927</span>        );
</div><div class='line not-covered'><span class='num'>928</span>    }
</div><div class='line not-executable'><span class='num'>929</span>
</div><div class='line not-executable'><span class='num'>930</span>    public function deleteNode(string $id): void
</div><div class='line not-executable'><span class='num'>931</span>    {
</div><div class='line not-covered'><span class='num'>932</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>933</span>            throw new RuntimeException(&quot;Permission denied to delete node.&quot;);
</div><div class='line not-executable'><span class='num'>934</span>        }
</div><div class='line not-executable'><span class='num'>935</span>
</div><div class='line not-covered'><span class='num'>936</span>        $old = $this-&gt;getNode($id);
</div><div class='line not-covered'><span class='num'>937</span>        $this-&gt;insertAuditLog(new AuditLog( &#039;node&#039;, $id, &#039;delete&#039;, $old-&gt;toArray(), null));
</div><div class='line not-covered'><span class='num'>938</span>        $this-&gt;db-&gt;deleteNode($id);
</div><div class='line not-covered'><span class='num'>939</span>    }
</div><div class='line not-executable'><span class='num'>940</span>
</div><div class='line not-executable'><span class='num'>941</span>    public function getEdge(string $source, string $target): ?Edge
</div><div class='line not-executable'><span class='num'>942</span>    {
</div><div class='line not-covered'><span class='num'>943</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>944</span>            throw new RuntimeException(&quot;Permission denied to get edge.&quot;);
</div><div class='line not-executable'><span class='num'>945</span>        }
</div><div class='line not-executable'><span class='num'>946</span>
</div><div class='line not-covered'><span class='num'>947</span>        $edgesData = $this-&gt;db-&gt;getEdges();
</div><div class='line not-covered'><span class='num'>948</span>        foreach ($edgesData as $data) {
</div><div class='line not-covered'><span class='num'>949</span>            if ($data[&#039;source&#039;] === $source &amp;&amp; $data[&#039;target&#039;] === $target) {
</div><div class='line not-covered'><span class='num'>950</span>                return new Edge(
</div><div class='line not-covered'><span class='num'>951</span>                    $data[&#039;id&#039;],
</div><div class='line not-covered'><span class='num'>952</span>                    $data[&#039;source&#039;],
</div><div class='line not-covered'><span class='num'>953</span>                    $data[&#039;target&#039;],
</div><div class='line not-covered'><span class='num'>954</span>                    json_decode($data[&#039;data&#039;], true)
</div><div class='line not-executable'><span class='num'>955</span>                );
</div><div class='line not-executable'><span class='num'>956</span>            }
</div><div class='line not-executable'><span class='num'>957</span>        }
</div><div class='line not-covered'><span class='num'>958</span>        return null;
</div><div class='line not-covered'><span class='num'>959</span>    }
</div><div class='line not-executable'><span class='num'>960</span>
</div><div class='line not-executable'><span class='num'>961</span>    public function getEdges(): Edges
</div><div class='line not-executable'><span class='num'>962</span>    {
</div><div class='line not-covered'><span class='num'>963</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>964</span>            throw new RuntimeException(&quot;Permission denied to get edges.&quot;);
</div><div class='line not-executable'><span class='num'>965</span>        }
</div><div class='line not-covered'><span class='num'>966</span>        $edgesData = $this-&gt;db-&gt;getEdges();
</div><div class='line not-covered'><span class='num'>967</span>        $edges     = new Edges();
</div><div class='line not-covered'><span class='num'>968</span>        foreach ($edgesData as $data) {
</div><div class='line not-covered'><span class='num'>969</span>            $edge = new Edge(
</div><div class='line not-covered'><span class='num'>970</span>                $data[&#039;id&#039;],
</div><div class='line not-covered'><span class='num'>971</span>                $data[&#039;source&#039;],
</div><div class='line not-covered'><span class='num'>972</span>                $data[&#039;target&#039;],
</div><div class='line not-covered'><span class='num'>973</span>                json_decode($data[&#039;data&#039;], true)
</div><div class='line not-executable'><span class='num'>974</span>            );
</div><div class='line not-covered'><span class='num'>975</span>            $edges-&gt;addEdge($edge);
</div><div class='line not-executable'><span class='num'>976</span>        }
</div><div class='line not-covered'><span class='num'>977</span>        return $edges;
</div><div class='line not-covered'><span class='num'>978</span>    }
</div><div class='line not-executable'><span class='num'>979</span>
</div><div class='line not-executable'><span class='num'>980</span>    public function insertEdge(Edge $edge): void
</div><div class='line not-executable'><span class='num'>981</span>    {
</div><div class='line covered'><span class='num'>982</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>983</span>            throw new RuntimeException(&quot;Permission denied to insert edge.&quot;);
</div><div class='line not-executable'><span class='num'>984</span>        }
</div><div class='line covered'><span class='num'>985</span>        $this-&gt;insertAuditLog(new AuditLog( &#039;edge&#039;, $edge-&gt;id, &#039;insert&#039;, null, $edge-&gt;toArray()));
</div><div class='line covered'><span class='num'>986</span>        $this-&gt;db-&gt;insertEdge(
</div><div class='line covered'><span class='num'>987</span>            $edge-&gt;id,
</div><div class='line covered'><span class='num'>988</span>            $edge-&gt;source,
</div><div class='line covered'><span class='num'>989</span>            $edge-&gt;target,
</div><div class='line covered'><span class='num'>990</span>            $edge-&gt;data
</div><div class='line not-executable'><span class='num'>991</span>        );
</div><div class='line covered'><span class='num'>992</span>    }
</div><div class='line not-executable'><span class='num'>993</span>
</div><div class='line not-executable'><span class='num'>994</span>    public function updateEdge(Edge $edge): void
</div><div class='line not-executable'><span class='num'>995</span>    {
</div><div class='line not-covered'><span class='num'>996</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>997</span>            throw new RuntimeException(&quot;Permission denied to update edge.&quot;);
</div><div class='line not-executable'><span class='num'>998</span>        }
</div><div class='line not-covered'><span class='num'>999</span>        $old = $this-&gt;getEdge($edge-&gt;source, $edge-&gt;target);
</div><div class='line not-covered'><span class='num'>1000</span>        $this-&gt;insertAuditLog(new AuditLog( &#039;edge&#039;, $edge-&gt;id, &#039;update&#039;, $old-&gt;toArray(), $edge-&gt;toArray()));
</div><div class='line not-executable'><span class='num'>1001</span>
</div><div class='line not-covered'><span class='num'>1002</span>        $this-&gt;db-&gt;updateEdge(
</div><div class='line not-covered'><span class='num'>1003</span>            $edge-&gt;id,
</div><div class='line not-covered'><span class='num'>1004</span>            $edge-&gt;source,
</div><div class='line not-covered'><span class='num'>1005</span>            $edge-&gt;target,
</div><div class='line not-covered'><span class='num'>1006</span>            $edge-&gt;data
</div><div class='line not-executable'><span class='num'>1007</span>        );
</div><div class='line not-covered'><span class='num'>1008</span>    }
</div><div class='line not-executable'><span class='num'>1009</span>
</div><div class='line not-executable'><span class='num'>1010</span>    public function deleteEdge(string $id): void
</div><div class='line not-executable'><span class='num'>1011</span>    {
</div><div class='line not-covered'><span class='num'>1012</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>1013</span>            throw new RuntimeException(&quot;Permission denied to delete edge.&quot;);
</div><div class='line not-executable'><span class='num'>1014</span>        }
</div><div class='line not-covered'><span class='num'>1015</span>        $this-&gt;db-&gt;deleteEdge($id);
</div><div class='line not-covered'><span class='num'>1016</span>    }
</div><div class='line not-executable'><span class='num'>1017</span>
</div><div class='line not-executable'><span class='num'>1018</span>    public function getStatuses(): NodeStatuses
</div><div class='line not-executable'><span class='num'>1019</span>    {
</div><div class='line not-covered'><span class='num'>1020</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>1021</span>            throw new RuntimeException(&quot;Permission denied to get statuses.&quot;);
</div><div class='line not-executable'><span class='num'>1022</span>        }
</div><div class='line not-executable'><span class='num'>1023</span>
</div><div class='line not-covered'><span class='num'>1024</span>        $statusesData = $this-&gt;db-&gt;getStatuses();
</div><div class='line not-covered'><span class='num'>1025</span>        $nodeStatuses = new NodeStatuses();
</div><div class='line not-covered'><span class='num'>1026</span>        foreach ($statusesData as $data) {
</div><div class='line not-covered'><span class='num'>1027</span>            $status = new NodeStatus(
</div><div class='line not-covered'><span class='num'>1028</span>                $data[&#039;id&#039;],
</div><div class='line not-covered'><span class='num'>1029</span>                $data[&#039;status&#039;] ?? &#039;unknown&#039;
</div><div class='line not-executable'><span class='num'>1030</span>            );
</div><div class='line not-covered'><span class='num'>1031</span>            $nodeStatuses-&gt;addStatus($status);
</div><div class='line not-executable'><span class='num'>1032</span>        }
</div><div class='line not-covered'><span class='num'>1033</span>        return $nodeStatuses;
</div><div class='line not-covered'><span class='num'>1034</span>    }
</div><div class='line not-executable'><span class='num'>1035</span>
</div><div class='line not-executable'><span class='num'>1036</span>    public function getNodeStatus(string $id): NodeStatus
</div><div class='line not-executable'><span class='num'>1037</span>    {
</div><div class='line not-covered'><span class='num'>1038</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>1039</span>            throw new RuntimeException(&quot;Permission denied to get node status.&quot;);
</div><div class='line not-executable'><span class='num'>1040</span>        }
</div><div class='line not-executable'><span class='num'>1041</span>
</div><div class='line not-covered'><span class='num'>1042</span>        $statusData = $this-&gt;db-&gt;getNodeStatus($id);
</div><div class='line not-covered'><span class='num'>1043</span>        return new NodeStatus(
</div><div class='line not-covered'><span class='num'>1044</span>            $id,
</div><div class='line not-covered'><span class='num'>1045</span>            $statusData ?? &#039;unknown&#039;
</div><div class='line not-executable'><span class='num'>1046</span>        );
</div><div class='line not-covered'><span class='num'>1047</span>    }
</div><div class='line not-executable'><span class='num'>1048</span>
</div><div class='line not-executable'><span class='num'>1049</span>    public function setNodeStatus(NodeStatus $status): void
</div><div class='line not-executable'><span class='num'>1050</span>    {
</div><div class='line not-covered'><span class='num'>1051</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>1052</span>            throw new RuntimeException(&quot;Permission denied to set node status.&quot;);
</div><div class='line not-executable'><span class='num'>1053</span>        }
</div><div class='line not-executable'><span class='num'>1054</span>
</div><div class='line not-covered'><span class='num'>1055</span>        $this-&gt;db-&gt;setNodeStatus($status-&gt;nodeId, $status-&gt;status);
</div><div class='line not-covered'><span class='num'>1056</span>    }
</div><div class='line not-executable'><span class='num'>1057</span>
</div><div class='line not-executable'><span class='num'>1058</span>    public function getLogs($limit): AuditLogs
</div><div class='line not-executable'><span class='num'>1059</span>    {
</div><div class='line not-covered'><span class='num'>1060</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>1061</span>            throw new RuntimeException(&quot;Permission denied to get audit logs.&quot;);
</div><div class='line not-executable'><span class='num'>1062</span>        }
</div><div class='line not-executable'><span class='num'>1063</span>
</div><div class='line not-covered'><span class='num'>1064</span>        $logs = new AuditLogs();
</div><div class='line not-covered'><span class='num'>1065</span>        $rows = $this-&gt;db-&gt;getLogs($limit);
</div><div class='line not-covered'><span class='num'>1066</span>        foreach ($rows as $row) {
</div><div class='line not-covered'><span class='num'>1067</span>            $old_data = $row[&#039;old_data&#039;] ? json_decode($row[&#039;old_data&#039;], true) : [];
</div><div class='line not-covered'><span class='num'>1068</span>            $new_data = $row[&#039;new_data&#039;] ?  json_decode($row[&#039;new_data&#039;], true) : [];
</div><div class='line not-covered'><span class='num'>1069</span>            $log = new AuditLog(
</div><div class='line not-covered'><span class='num'>1070</span>                $row[&#039;entity_type&#039;],
</div><div class='line not-covered'><span class='num'>1071</span>                $row[&#039;entity_id&#039;],
</div><div class='line not-covered'><span class='num'>1072</span>                $row[&#039;action&#039;],
</div><div class='line not-executable'><span class='num'>1073</span>                $old_data,
</div><div class='line not-executable'><span class='num'>1074</span>                $new_data,
</div><div class='line not-executable'><span class='num'>1075</span>            );
</div><div class='line not-covered'><span class='num'>1076</span>            $log-&gt;userId    = $row[&#039;user_id&#039;];
</div><div class='line not-covered'><span class='num'>1077</span>            $log-&gt;ipAddress = $row[&#039;ip_address&#039;];
</div><div class='line not-covered'><span class='num'>1078</span>            $log-&gt;createdAt = $row[&#039;created_at&#039;];
</div><div class='line not-executable'><span class='num'>1079</span>
</div><div class='line not-covered'><span class='num'>1080</span>            $logs-&gt;addLog($log);
</div><div class='line not-executable'><span class='num'>1081</span>        }
</div><div class='line not-covered'><span class='num'>1082</span>        return $logs;
</div><div class='line not-covered'><span class='num'>1083</span>    }
</div><div class='line not-executable'><span class='num'>1084</span>
</div><div class='line not-executable'><span class='num'>1085</span>    private function insertAuditLog(AuditLog $auditLog): void
</div><div class='line not-executable'><span class='num'>1086</span>    {
</div><div class='line covered'><span class='num'>1087</span>        $user_id   = GraphContext::$user-&gt;id;
</div><div class='line covered'><span class='num'>1088</span>        $ip_address = GraphContext::$user-&gt;ipAddress;
</div><div class='line not-executable'><span class='num'>1089</span>
</div><div class='line covered'><span class='num'>1090</span>        $this-&gt;db-&gt;insertAuditLog(
</div><div class='line covered'><span class='num'>1091</span>            $auditLog-&gt;entityType,
</div><div class='line covered'><span class='num'>1092</span>            $auditLog-&gt;entityId,
</div><div class='line covered'><span class='num'>1093</span>            $auditLog-&gt;action,
</div><div class='line covered'><span class='num'>1094</span>            $auditLog-&gt;oldData,
</div><div class='line covered'><span class='num'>1095</span>            $auditLog-&gt;newData,
</div><div class='line not-executable'><span class='num'>1096</span>            $user_id,
</div><div class='line not-executable'><span class='num'>1097</span>            $ip_address
</div><div class='line not-executable'><span class='num'>1098</span>        );
</div><div class='line covered'><span class='num'>1099</span>    }
</div><div class='line not-executable'><span class='num'>1100</span>
</div><div class='line not-executable'><span class='num'>1101</span>    private function isAllowed(string $action): bool
</div><div class='line not-executable'><span class='num'>1102</span>    {
</div><div class='line covered'><span class='num'>1103</span>        $group = GraphContext::$user-&gt;group;
</div><div class='line not-executable'><span class='num'>1104</span>
</div><div class='line not-executable'><span class='num'>1105</span>        // validate action
</div><div class='line not-executable'><span class='num'>1106</span>        // if action is one of the keys in the array self::SECURE_ACTIONS
</div><div class='line covered'><span class='num'>1107</span>        if (!array_key_exists($action, self::SECURE_ACTIONS)) {
</div><div class='line not-covered'><span class='num'>1108</span>            throw new RuntimeException(&quot;Action not defined in secure actions. Action: {$action}&quot;);
</div><div class='line not-executable'><span class='num'>1109</span>        }
</div><div class='line not-executable'><span class='num'>1110</span>
</div><div class='line not-executable'><span class='num'>1111</span>        // if is admin, allow all
</div><div class='line covered'><span class='num'>1112</span>        if ($group-&gt;id === &#039;admin&#039;) {
</div><div class='line not-covered'><span class='num'>1113</span>            return true;
</div><div class='line not-executable'><span class='num'>1114</span>        }
</div><div class='line not-executable'><span class='num'>1115</span>
</div><div class='line not-executable'><span class='num'>1116</span>        // if action is in the SAFE_ACTIONS, allow all
</div><div class='line covered'><span class='num'>1117</span>        if (self::SECURE_ACTIONS[$action]) {
</div><div class='line covered'><span class='num'>1118</span>            return true;
</div><div class='line not-executable'><span class='num'>1119</span>        }
</div><div class='line not-executable'><span class='num'>1120</span>        
</div><div class='line not-executable'><span class='num'>1121</span>        // if action is restricted, only allow contributor
</div><div class='line covered'><span class='num'>1122</span>        if (self::SECURE_ACTIONS[$action] == false &amp;&amp; $group-&gt;id == &#039;contributor&#039;)
</div><div class='line not-executable'><span class='num'>1123</span>        {
</div><div class='line covered'><span class='num'>1124</span>            return true;
</div><div class='line not-executable'><span class='num'>1125</span>        }
</div><div class='line not-executable'><span class='num'>1126</span>
</div><div class='line not-covered'><span class='num'>1127</span>        return false;
</div><div class='line not-covered'><span class='num'>1128</span>    }
</div><div class='line not-executable'><span class='num'>1129</span>}
</div><div class='line not-executable'><span class='num'>1130</span>
</div><div class='line not-executable'><span class='num'>1131</span>final class Request
</div><div class='line not-executable'><span class='num'>1132</span>{
</div><div class='line not-executable'><span class='num'>1133</span>    public array $data;
</div><div class='line not-executable'><span class='num'>1134</span>
</div><div class='line not-executable'><span class='num'>1135</span>    public function getParam($name): string
</div><div class='line not-executable'><span class='num'>1136</span>    {
</div><div class='line covered'><span class='num'>1137</span>        if(isset($_GET[$name])) {
</div><div class='line covered'><span class='num'>1138</span>            return $_GET[$name];
</div><div class='line not-executable'><span class='num'>1139</span>        }
</div><div class='line not-executable'><span class='num'>1140</span>
</div><div class='line not-covered'><span class='num'>1141</span>        throw new RuntimeException(&quot;param &#039;{$name}&#039; not found&quot;);
</div><div class='line not-covered'><span class='num'>1142</span>    }
</div><div class='line not-executable'><span class='num'>1143</span>
</div><div class='line not-executable'><span class='num'>1144</span>    public function getPath(): string
</div><div class='line not-executable'><span class='num'>1145</span>    {
</div><div class='line not-covered'><span class='num'>1146</span>        $scriptName = $_SERVER[&#039;SCRIPT_NAME&#039;];
</div><div class='line not-covered'><span class='num'>1147</span>        $requestUri = $_SERVER[&#039;REQUEST_URI&#039;];
</div><div class='line not-covered'><span class='num'>1148</span>        $requestUri = strtok($requestUri, &#039;?&#039;);
</div><div class='line not-covered'><span class='num'>1149</span>        $path = str_replace($scriptName, &#039;&#039;, $requestUri);
</div><div class='line not-covered'><span class='num'>1150</span>        return $path;
</div><div class='line not-covered'><span class='num'>1151</span>    }
</div><div class='line not-executable'><span class='num'>1152</span>}
</div><div class='line not-executable'><span class='num'>1153</span>
</div><div class='line not-executable'><span class='num'>1154</span>interface ResponseInterface
</div><div class='line not-executable'><span class='num'>1155</span>{
</div><div class='line not-executable'><span class='num'>1156</span>    public function send(): void;
</div><div class='line not-executable'><span class='num'>1157</span>}
</div><div class='line not-executable'><span class='num'>1158</span>
</div><div class='line not-executable'><span class='num'>1159</span>class Response implements ResponseInterface
</div><div class='line not-executable'><span class='num'>1160</span>{
</div><div class='line not-executable'><span class='num'>1161</span>    public int $code;
</div><div class='line not-executable'><span class='num'>1162</span>    public string $status;
</div><div class='line not-executable'><span class='num'>1163</span>    public string $message;
</div><div class='line not-executable'><span class='num'>1164</span>    public array $data;
</div><div class='line not-executable'><span class='num'>1165</span>
</div><div class='line not-executable'><span class='num'>1166</span>    public function __construct(int $code, string $status, string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1167</span>    {
</div><div class='line covered'><span class='num'>1168</span>        $this-&gt;code = $code;
</div><div class='line covered'><span class='num'>1169</span>        $this-&gt;status = $status;
</div><div class='line covered'><span class='num'>1170</span>        $this-&gt;message = $message;
</div><div class='line covered'><span class='num'>1171</span>        $this-&gt;data = $data;
</div><div class='line covered'><span class='num'>1172</span>    }
</div><div class='line not-executable'><span class='num'>1173</span>
</div><div class='line not-executable'><span class='num'>1174</span>    public function send(): void
</div><div class='line not-executable'><span class='num'>1175</span>    {
</div><div class='line not-covered'><span class='num'>1176</span>        header(&#039;Content-Type: application/json; charset=utf-8&#039;);
</div><div class='line not-covered'><span class='num'>1177</span>        http_response_code($this-&gt;code);
</div><div class='line not-covered'><span class='num'>1178</span>        $this-&gt;data = [&#039;code&#039; =&gt; $this-&gt;code, &#039;status&#039; =&gt; $this-&gt;status, &#039;message&#039; =&gt; $this-&gt;message, &#039;data&#039; =&gt; $this-&gt;data];
</div><div class='line not-covered'><span class='num'>1179</span>        echo json_encode($this-&gt;data, JSON_UNESCAPED_UNICODE |  JSON_UNESCAPED_SLASHES |  JSON_PRETTY_PRINT);
</div><div class='line not-covered'><span class='num'>1180</span>    }
</div><div class='line not-executable'><span class='num'>1181</span>}
</div><div class='line not-executable'><span class='num'>1182</span>
</div><div class='line not-executable'><span class='num'>1183</span>class OKResponse extends Response
</div><div class='line not-executable'><span class='num'>1184</span>{
</div><div class='line not-executable'><span class='num'>1185</span>    public function __construct(string $message, array $data)
</div><div class='line not-executable'><span class='num'>1186</span>    {
</div><div class='line covered'><span class='num'>1187</span>        return parent::__construct(200, &#039;success&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1188</span>    }
</div><div class='line not-executable'><span class='num'>1189</span>}
</div><div class='line not-executable'><span class='num'>1190</span>
</div><div class='line not-executable'><span class='num'>1191</span>class CreatedResponse extends Response
</div><div class='line not-executable'><span class='num'>1192</span>{
</div><div class='line not-executable'><span class='num'>1193</span>    public function __construct(string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1194</span>    {
</div><div class='line covered'><span class='num'>1195</span>        return parent::__construct(201, &#039;success&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1196</span>    }
</div><div class='line not-executable'><span class='num'>1197</span>}
</div><div class='line not-executable'><span class='num'>1198</span>
</div><div class='line not-executable'><span class='num'>1199</span>class BadRequestResponse extends Response
</div><div class='line not-executable'><span class='num'>1200</span>{
</div><div class='line not-executable'><span class='num'>1201</span>    public function __construct(string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1202</span>    {
</div><div class='line not-covered'><span class='num'>1203</span>        return parent::__construct(400, &#039;error&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1204</span>    }
</div><div class='line not-executable'><span class='num'>1205</span>}
</div><div class='line not-executable'><span class='num'>1206</span>
</div><div class='line not-executable'><span class='num'>1207</span>class UnauthorizedResponse extends Response
</div><div class='line not-executable'><span class='num'>1208</span>{
</div><div class='line not-executable'><span class='num'>1209</span>    public function __construct(string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1210</span>    {
</div><div class='line not-covered'><span class='num'>1211</span>        return parent::__construct(401, &#039;error&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1212</span>    }
</div><div class='line not-executable'><span class='num'>1213</span>}
</div><div class='line not-executable'><span class='num'>1214</span>
</div><div class='line not-executable'><span class='num'>1215</span>class ForbiddenResponse extends Response
</div><div class='line not-executable'><span class='num'>1216</span>{
</div><div class='line not-executable'><span class='num'>1217</span>    public function __construct(string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1218</span>    {
</div><div class='line not-covered'><span class='num'>1219</span>        return parent::__construct(403, &#039;error&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1220</span>    }
</div><div class='line not-executable'><span class='num'>1221</span>}
</div><div class='line not-executable'><span class='num'>1222</span>
</div><div class='line not-executable'><span class='num'>1223</span>class NotFoundResponse extends Response
</div><div class='line not-executable'><span class='num'>1224</span>{
</div><div class='line not-executable'><span class='num'>1225</span>    public function __construct(string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1226</span>    {
</div><div class='line not-covered'><span class='num'>1227</span>        return parent::__construct(404, &#039;error&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1228</span>    }
</div><div class='line not-executable'><span class='num'>1229</span>}
</div><div class='line not-executable'><span class='num'>1230</span>
</div><div class='line not-executable'><span class='num'>1231</span>class InternalServerErrorResponse extends Response
</div><div class='line not-executable'><span class='num'>1232</span>{
</div><div class='line not-executable'><span class='num'>1233</span>    public function __construct(string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1234</span>    {
</div><div class='line not-covered'><span class='num'>1235</span>        return parent::__construct(500, &#039;error&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1236</span>    }
</div><div class='line not-executable'><span class='num'>1237</span>}
</div><div class='line not-executable'><span class='num'>1238</span>
</div><div class='line not-executable'><span class='num'>1239</span>interface GraphControllerInterface
</div><div class='line not-executable'><span class='num'>1240</span>{
</div><div class='line not-executable'><span class='num'>1241</span>    public function getUser(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1242</span>    public function insertUser(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1243</span>    public function updateUser(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1244</span>
</div><div class='line not-executable'><span class='num'>1245</span>    public function getGraph(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1246</span>
</div><div class='line not-executable'><span class='num'>1247</span>    public function getNode(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1248</span>    public function getNodes(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1249</span>    public function insertNode(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1250</span>    public function updateNode(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1251</span>    public function deleteNode(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1252</span>
</div><div class='line not-executable'><span class='num'>1253</span>    public function getEdge(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1254</span>    public function getEdges(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1255</span>    public function insertEdge(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1256</span>    public function updateEdge(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1257</span>    public function deleteEdge(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1258</span>
</div><div class='line not-executable'><span class='num'>1259</span>    public function getStatuses(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1260</span>    public function getNodeStatus(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1261</span>    public function setNodeStatus(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1262</span>
</div><div class='line not-executable'><span class='num'>1263</span>    public function getLogs(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1264</span>}
</div><div class='line not-executable'><span class='num'>1265</span>
</div><div class='line not-executable'><span class='num'>1266</span>final class GraphControllerException extends RuntimeException
</div><div class='line not-executable'><span class='num'>1267</span>{
</div><div class='line not-executable'><span class='num'>1268</span>}
</div><div class='line not-executable'><span class='num'>1269</span>
</div><div class='line not-executable'><span class='num'>1270</span>final class GraphController implements GraphControllerInterface
</div><div class='line not-executable'><span class='num'>1271</span>{
</div><div class='line not-executable'><span class='num'>1272</span>    private GraphServiceInterface $service;
</div><div class='line not-executable'><span class='num'>1273</span>    private Logger $logger;
</div><div class='line not-executable'><span class='num'>1274</span>
</div><div class='line not-executable'><span class='num'>1275</span>    public function __construct(GraphServiceInterface $service, Logger $logger)
</div><div class='line not-executable'><span class='num'>1276</span>    {
</div><div class='line covered'><span class='num'>1277</span>        $this-&gt;service = $service;
</div><div class='line covered'><span class='num'>1278</span>        $this-&gt;logger = $logger;
</div><div class='line covered'><span class='num'>1279</span>    }
</div><div class='line not-executable'><span class='num'>1280</span>
</div><div class='line not-executable'><span class='num'>1281</span>    public function getUser(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1282</span>    {
</div><div class='line not-covered'><span class='num'>1283</span>        $data = $this-&gt;service-&gt;getUser($req-&gt;data[&#039;id&#039;]);
</div><div class='line not-covered'><span class='num'>1284</span>        $user = new User($data[&#039;id&#039;], null, new Group($data[&#039;user_group&#039;]));
</div><div class='line not-covered'><span class='num'>1285</span>        return new OKResponse(&#039;user found&#039;, $user-&gt;toArray());
</div><div class='line not-covered'><span class='num'>1286</span>    }
</div><div class='line not-executable'><span class='num'>1287</span>
</div><div class='line not-executable'><span class='num'>1288</span>    public function insertUser(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1289</span>    {
</div><div class='line not-covered'><span class='num'>1290</span>        $user = new User($req-&gt;data[&#039;id&#039;], null, $req-&gt;data[&#039;user_group&#039;]);
</div><div class='line not-covered'><span class='num'>1291</span>        $this-&gt;service-&gt;insertUser($user);
</div><div class='line not-covered'><span class='num'>1292</span>        return new OKResponse(&#039;user created&#039;, $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1293</span>    }
</div><div class='line not-executable'><span class='num'>1294</span>
</div><div class='line not-executable'><span class='num'>1295</span>    public function updateUser(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1296</span>    {
</div><div class='line not-covered'><span class='num'>1297</span>        $user = new User($req-&gt;data[&#039;id&#039;], null, $req-&gt;data[&#039;user_group&#039;]);
</div><div class='line not-covered'><span class='num'>1298</span>        $this-&gt;service-&gt;updateUser($user);
</div><div class='line not-covered'><span class='num'>1299</span>        return new CreatedResponse(&#039;user updated&#039;, $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1300</span>    }
</div><div class='line not-executable'><span class='num'>1301</span>
</div><div class='line not-executable'><span class='num'>1302</span>    public function getGraph(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1303</span>    {
</div><div class='line not-executable'><span class='num'>1304</span>        try {
</div><div class='line not-covered'><span class='num'>1305</span>            $data = $this-&gt;service-&gt;getGraph()-&gt;toArray();
</div><div class='line not-covered'><span class='num'>1306</span>            return new OKResponse(&#039;get graph&#039;, $data);
</div><div class='line not-covered'><span class='num'>1307</span>            return $resp;
</div><div class='line not-covered'><span class='num'>1308</span>        } catch (Exception $e) {
</div><div class='line not-covered'><span class='num'>1309</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1310</span>        }
</div><div class='line not-executable'><span class='num'>1311</span>
</div><div class='line not-covered'><span class='num'>1312</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1313</span>    }
</div><div class='line not-executable'><span class='num'>1314</span>
</div><div class='line not-executable'><span class='num'>1315</span>    public function getNode(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1316</span>    {
</div><div class='line not-executable'><span class='num'>1317</span>        try {
</div><div class='line covered'><span class='num'>1318</span>            $id = $req-&gt;getParam(&#039;id&#039;);
</div><div class='line covered'><span class='num'>1319</span>            $node = $this-&gt;service-&gt;getNode($id);
</div><div class='line covered'><span class='num'>1320</span>            $data = $node-&gt;toArray();
</div><div class='line covered'><span class='num'>1321</span>            return new OKResponse(&#039;node found&#039;, $data);
</div><div class='line not-covered'><span class='num'>1322</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1323</span>        {
</div><div class='line not-covered'><span class='num'>1324</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1325</span>        }
</div><div class='line not-executable'><span class='num'>1326</span>
</div><div class='line not-covered'><span class='num'>1327</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1328</span>    }
</div><div class='line not-executable'><span class='num'>1329</span>
</div><div class='line not-executable'><span class='num'>1330</span>    public function getNodes(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1331</span>    {
</div><div class='line not-executable'><span class='num'>1332</span>        try {
</div><div class='line not-covered'><span class='num'>1333</span>            $nodes = $this-&gt;service-&gt;getNodes();
</div><div class='line not-executable'><span class='num'>1334</span>            // TODO: corrigir
</div><div class='line not-covered'><span class='num'>1335</span>            return new OKResponse(&#039;nodes found&#039;, []);
</div><div class='line not-covered'><span class='num'>1336</span>            return $resp;
</div><div class='line not-covered'><span class='num'>1337</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1338</span>        {
</div><div class='line not-covered'><span class='num'>1339</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1340</span>        }
</div><div class='line not-executable'><span class='num'>1341</span>        
</div><div class='line not-covered'><span class='num'>1342</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1343</span>    }
</div><div class='line not-executable'><span class='num'>1344</span>
</div><div class='line not-executable'><span class='num'>1345</span>    public function insertNode(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1346</span>    {
</div><div class='line covered'><span class='num'>1347</span>        $this-&gt;logger-&gt;debug(&#039;inserting node&#039;, $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1348</span>        try {
</div><div class='line covered'><span class='num'>1349</span>            $node = new Node($req-&gt;data[&#039;id&#039;], $req-&gt;data[&#039;label&#039;], $req-&gt;data[&#039;category&#039;], $req-&gt;data[&#039;type&#039;], $req-&gt;data[&#039;data&#039;]);
</div><div class='line covered'><span class='num'>1350</span>            $this-&gt;service-&gt;insertNode($node);
</div><div class='line covered'><span class='num'>1351</span>            $this-&gt;logger-&gt;info(&#039;node inserted&#039;, $req-&gt;data);
</div><div class='line covered'><span class='num'>1352</span>            return new CreatedResponse(&#039;node inserted&#039;, $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1353</span>        } catch( GraphServiceException $e)
</div><div class='line not-executable'><span class='num'>1354</span>        {
</div><div class='line not-covered'><span class='num'>1355</span>            $this-&gt;logger-&gt;error(&#039;The service could not insert new node:&#039; . $e-&gt;getMessage());
</div><div class='line not-covered'><span class='num'>1356</span>            throw new GraphControllerException(&#039;The service could not insert new node:&#039; . $e-&gt;getMessage(), 0, $e);
</div><div class='line not-executable'><span class='num'>1357</span>        }
</div><div class='line not-covered'><span class='num'>1358</span>        return new InternalServerErrorResponse(&#039;unknow error inserting node&#039;, $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1359</span>    }
</div><div class='line not-executable'><span class='num'>1360</span>    
</div><div class='line not-executable'><span class='num'>1361</span>    public function updateNode(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1362</span>    {
</div><div class='line covered'><span class='num'>1363</span>        $this-&gt;logger-&gt;debug(&#039;updating node&#039;, $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1364</span>
</div><div class='line not-executable'><span class='num'>1365</span>        try {
</div><div class='line covered'><span class='num'>1366</span>            $edge = new Edge($req-&gt;data[&#039;id&#039;], $req-&gt;data[&#039;category&#039;], $req-&gt;data[&#039;type&#039;], $req-&gt;data[&#039;data&#039;]);
</div><div class='line covered'><span class='num'>1367</span>            $this-&gt;service-&gt;insertEdge($edge);
</div><div class='line covered'><span class='num'>1368</span>            $this-&gt;logger-&gt;info(&#039;edge inserted&#039;, $req-&gt;data);
</div><div class='line covered'><span class='num'>1369</span>            $resp = new CreatedResponse(&#039;edge created&#039;, $req-&gt;data);
</div><div class='line covered'><span class='num'>1370</span>            return $resp;
</div><div class='line not-covered'><span class='num'>1371</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1372</span>        {
</div><div class='line not-covered'><span class='num'>1373</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1374</span>        }
</div><div class='line not-executable'><span class='num'>1375</span>        
</div><div class='line not-covered'><span class='num'>1376</span>        return new InternalServerErrorResponse(&#039;unknow todo in updateNode&#039;, $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1377</span>    }
</div><div class='line not-executable'><span class='num'>1378</span>    
</div><div class='line not-executable'><span class='num'>1379</span>    public function deleteNode(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1380</span>    {
</div><div class='line not-executable'><span class='num'>1381</span>        try {
</div><div class='line not-covered'><span class='num'>1382</span>            $this-&gt;service-&gt;deleteEdge($req-&gt;data[&#039;id&#039;]);
</div><div class='line not-covered'><span class='num'>1383</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1384</span>        {
</div><div class='line not-covered'><span class='num'>1385</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1386</span>        }
</div><div class='line not-executable'><span class='num'>1387</span>        
</div><div class='line not-covered'><span class='num'>1388</span>        return new InternalServerErrorResponse(&#039;unknow todo in deleteNode&#039;, $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1389</span>    }
</div><div class='line not-executable'><span class='num'>1390</span>
</div><div class='line not-executable'><span class='num'>1391</span>    public function getEdge(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1392</span>    {
</div><div class='line not-executable'><span class='num'>1393</span>        try {
</div><div class='line not-covered'><span class='num'>1394</span>            $edge = $this-&gt;service-&gt;getEdge($req-&gt;data[&#039;source&#039;], $req-&gt;data[&#039;target&#039;]);
</div><div class='line not-covered'><span class='num'>1395</span>            $data = $edge-&gt;toArray();
</div><div class='line not-covered'><span class='num'>1396</span>            return new OKResponse(&#039;node found&#039;, $data);
</div><div class='line not-covered'><span class='num'>1397</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1398</span>        {
</div><div class='line not-covered'><span class='num'>1399</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1400</span>        }
</div><div class='line not-executable'><span class='num'>1401</span>        
</div><div class='line not-covered'><span class='num'>1402</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1403</span>    }
</div><div class='line not-executable'><span class='num'>1404</span>    
</div><div class='line not-executable'><span class='num'>1405</span>    public function getEdges(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1406</span>    {
</div><div class='line not-executable'><span class='num'>1407</span>        try {
</div><div class='line not-covered'><span class='num'>1408</span>            $edges = $this-&gt;service-&gt;getEdges();
</div><div class='line not-executable'><span class='num'>1409</span>            // TODO: corrigir
</div><div class='line not-covered'><span class='num'>1410</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1411</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1412</span>        {
</div><div class='line not-covered'><span class='num'>1413</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1414</span>        }
</div><div class='line not-executable'><span class='num'>1415</span>        
</div><div class='line not-covered'><span class='num'>1416</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1417</span>    }
</div><div class='line not-executable'><span class='num'>1418</span>    
</div><div class='line not-executable'><span class='num'>1419</span>    public function insertEdge(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1420</span>    {
</div><div class='line not-executable'><span class='num'>1421</span>        try {
</div><div class='line not-covered'><span class='num'>1422</span>            $edge = new Edge(null, $req-&gt;data[&#039;source&#039;], $req-&gt;data[&#039;target&#039;]);
</div><div class='line not-covered'><span class='num'>1423</span>            $this-&gt;service-&gt;insertEdge($edge);
</div><div class='line not-covered'><span class='num'>1424</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1425</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1426</span>        {
</div><div class='line not-covered'><span class='num'>1427</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1428</span>        }
</div><div class='line not-executable'><span class='num'>1429</span>        
</div><div class='line not-covered'><span class='num'>1430</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1431</span>    }
</div><div class='line not-executable'><span class='num'>1432</span>    
</div><div class='line not-executable'><span class='num'>1433</span>    public function updateEdge(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1434</span>    {
</div><div class='line not-executable'><span class='num'>1435</span>        try {
</div><div class='line not-covered'><span class='num'>1436</span>            $edge = new Edge($req-&gt;data[&#039;id&#039;], $req-&gt;data[&#039;source&#039;], $req-&gt;data[&#039;target&#039;], $req-&gt;data[&#039;data&#039;]);
</div><div class='line not-covered'><span class='num'>1437</span>            $this-&gt;service-&gt;updateEdge($edge);
</div><div class='line not-covered'><span class='num'>1438</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1439</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1440</span>        {
</div><div class='line not-covered'><span class='num'>1441</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1442</span>        }
</div><div class='line not-executable'><span class='num'>1443</span>        
</div><div class='line not-covered'><span class='num'>1444</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1445</span>    }
</div><div class='line not-executable'><span class='num'>1446</span>    
</div><div class='line not-executable'><span class='num'>1447</span>    public function deleteEdge(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1448</span>    {
</div><div class='line not-executable'><span class='num'>1449</span>        try {
</div><div class='line not-covered'><span class='num'>1450</span>            $id = $req-&gt;data[&#039;id&#039;];
</div><div class='line not-covered'><span class='num'>1451</span>            $this-&gt;service-&gt;deleteEdge($id);
</div><div class='line not-covered'><span class='num'>1452</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1453</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1454</span>        {
</div><div class='line not-covered'><span class='num'>1455</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1456</span>        }
</div><div class='line not-executable'><span class='num'>1457</span>        
</div><div class='line not-covered'><span class='num'>1458</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1459</span>    }
</div><div class='line not-executable'><span class='num'>1460</span>
</div><div class='line not-executable'><span class='num'>1461</span>    public function getStatuses(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1462</span>    {
</div><div class='line not-executable'><span class='num'>1463</span>        try {
</div><div class='line not-covered'><span class='num'>1464</span>            $statuses = $this-&gt;service-&gt;getStatuses();
</div><div class='line not-covered'><span class='num'>1465</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1466</span>            return $resp;
</div><div class='line not-covered'><span class='num'>1467</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1468</span>        {
</div><div class='line not-covered'><span class='num'>1469</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1470</span>        }
</div><div class='line not-executable'><span class='num'>1471</span>        
</div><div class='line not-covered'><span class='num'>1472</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1473</span>    }
</div><div class='line not-executable'><span class='num'>1474</span>    
</div><div class='line not-executable'><span class='num'>1475</span>    public function getNodeStatus(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1476</span>    {
</div><div class='line not-executable'><span class='num'>1477</span>        try {
</div><div class='line not-covered'><span class='num'>1478</span>            $status = $this-&gt;service-&gt;getNodeStatus($req-&gt;data[&#039;id&#039;]);
</div><div class='line not-covered'><span class='num'>1479</span>            $data = $status-&gt;toArray();
</div><div class='line not-covered'><span class='num'>1480</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1481</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1482</span>        {
</div><div class='line not-covered'><span class='num'>1483</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1484</span>        }
</div><div class='line not-executable'><span class='num'>1485</span>        
</div><div class='line not-covered'><span class='num'>1486</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1487</span>    }
</div><div class='line not-executable'><span class='num'>1488</span>    
</div><div class='line not-executable'><span class='num'>1489</span>    public function setNodeStatus(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1490</span>    {
</div><div class='line not-executable'><span class='num'>1491</span>        try {
</div><div class='line not-covered'><span class='num'>1492</span>            $status = new NodeStatus($req-&gt;data[&#039;node_id&#039;], $req-&gt;data[&#039;status&#039;]);
</div><div class='line not-covered'><span class='num'>1493</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1494</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1495</span>        {
</div><div class='line not-covered'><span class='num'>1496</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1497</span>        }
</div><div class='line not-executable'><span class='num'>1498</span>        
</div><div class='line not-covered'><span class='num'>1499</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1500</span>    }
</div><div class='line not-executable'><span class='num'>1501</span>
</div><div class='line not-executable'><span class='num'>1502</span>    public function getLogs(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1503</span>    {
</div><div class='line not-executable'><span class='num'>1504</span>        try {
</div><div class='line not-covered'><span class='num'>1505</span>            $logs = $this-&gt;service-&gt;getLogs($req-&gt;getParam(&#039;limit&#039;));
</div><div class='line not-covered'><span class='num'>1506</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1507</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1508</span>        {
</div><div class='line not-covered'><span class='num'>1509</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1510</span>        }
</div><div class='line not-executable'><span class='num'>1511</span>        
</div><div class='line not-covered'><span class='num'>1512</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1513</span>    }
</div><div class='line not-executable'><span class='num'>1514</span>}
</div><div class='line not-executable'><span class='num'>1515</span>
</div><div class='line not-executable'><span class='num'>1516</span>final class RequestRouter
</div><div class='line not-executable'><span class='num'>1517</span>{
</div><div class='line not-executable'><span class='num'>1518</span>    private $routes = [
</div><div class='line not-executable'><span class='num'>1519</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getGraph&#039;, &#039;class_method&#039; =&gt; &#039;getGraph&#039;],
</div><div class='line not-executable'><span class='num'>1520</span>        
</div><div class='line not-executable'><span class='num'>1521</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getNode&#039;, &#039;class_method&#039; =&gt; &#039;getNode&#039;],
</div><div class='line not-executable'><span class='num'>1522</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getNodes&#039;, &#039;class_method&#039; =&gt; &#039;getNodes&#039;],
</div><div class='line not-executable'><span class='num'>1523</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/insertNode&#039;, &#039;class_method&#039; =&gt; &#039;insertNode&#039;],
</div><div class='line not-executable'><span class='num'>1524</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/updateNode&#039;, &#039;class_method&#039; =&gt; &#039;updateNode&#039;],
</div><div class='line not-executable'><span class='num'>1525</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/deleteNode&#039;, &#039;class_method&#039; =&gt; &#039;deleteNode&#039;],
</div><div class='line not-executable'><span class='num'>1526</span>
</div><div class='line not-executable'><span class='num'>1527</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getEdge&#039;, &#039;class_method&#039; =&gt; &#039;getEdge&#039;],
</div><div class='line not-executable'><span class='num'>1528</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getEdges&#039;, &#039;class_method&#039; =&gt; &#039;getEdges&#039;],
</div><div class='line not-executable'><span class='num'>1529</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/insertEdge&#039;, &#039;class_method&#039; =&gt; &#039;insertEdge&#039;],
</div><div class='line not-executable'><span class='num'>1530</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/updateEdge&#039;, &#039;class_method&#039; =&gt; &#039;updateEdge&#039;],
</div><div class='line not-executable'><span class='num'>1531</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/deleteEdge&#039;, &#039;class_method&#039; =&gt; &#039;deleteEdge&#039;],
</div><div class='line not-executable'><span class='num'>1532</span>
</div><div class='line not-executable'><span class='num'>1533</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getStatuses&#039;, &#039;class_method&#039; =&gt; &#039;getStatuses&#039;],
</div><div class='line not-executable'><span class='num'>1534</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getNodeStatus&#039;, &#039;class_method&#039; =&gt; &#039;getNodeStatus&#039;],
</div><div class='line not-executable'><span class='num'>1535</span>
</div><div class='line not-executable'><span class='num'>1536</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getLogs&#039;, &#039;class_method&#039; =&gt; &#039;getLogs&#039;],
</div><div class='line not-executable'><span class='num'>1537</span>
</div><div class='line not-executable'><span class='num'>1538</span>        ];
</div><div class='line not-executable'><span class='num'>1539</span>
</div><div class='line not-executable'><span class='num'>1540</span>    public GraphController $controller;
</div><div class='line not-executable'><span class='num'>1541</span>    
</div><div class='line not-executable'><span class='num'>1542</span>    public function __construct(GraphController $controller)
</div><div class='line not-executable'><span class='num'>1543</span>    {
</div><div class='line not-covered'><span class='num'>1544</span>        $this-&gt;controller = $controller;
</div><div class='line not-covered'><span class='num'>1545</span>    }
</div><div class='line not-executable'><span class='num'>1546</span>
</div><div class='line not-executable'><span class='num'>1547</span>    public function handle(): void
</div><div class='line not-executable'><span class='num'>1548</span>    {
</div><div class='line not-covered'><span class='num'>1549</span>        $method = $_SERVER[&#039;REQUEST_METHOD&#039;];
</div><div class='line not-executable'><span class='num'>1550</span>
</div><div class='line not-covered'><span class='num'>1551</span>        $scriptName = $_SERVER[&#039;SCRIPT_NAME&#039;];
</div><div class='line not-covered'><span class='num'>1552</span>        $requestUri = $_SERVER[&#039;REQUEST_URI&#039;];
</div><div class='line not-covered'><span class='num'>1553</span>        $requestUri = strtok($requestUri, &#039;?&#039;);
</div><div class='line not-executable'><span class='num'>1554</span>        
</div><div class='line not-covered'><span class='num'>1555</span>        $path = str_replace($scriptName, &#039;&#039;, $requestUri);
</div><div class='line not-executable'><span class='num'>1556</span>        
</div><div class='line not-covered'><span class='num'>1557</span>        $req = new Request();
</div><div class='line not-executable'><span class='num'>1558</span>
</div><div class='line not-covered'><span class='num'>1559</span>        foreach($this-&gt;routes as $route)
</div><div class='line not-executable'><span class='num'>1560</span>        {
</div><div class='line not-covered'><span class='num'>1561</span>            if ($route[&#039;method&#039;] == $method &amp;&amp; $route[&#039;path&#039;] == $path)
</div><div class='line not-executable'><span class='num'>1562</span>            {
</div><div class='line not-covered'><span class='num'>1563</span>                $method = $route[&#039;class_method&#039;];
</div><div class='line not-covered'><span class='num'>1564</span>                $resp = $this-&gt;controller-&gt;$method($req);
</div><div class='line not-covered'><span class='num'>1565</span>                print_r($resp);
</div><div class='line not-covered'><span class='num'>1566</span>                exit();
</div><div class='line not-executable'><span class='num'>1567</span>            }
</div><div class='line not-executable'><span class='num'>1568</span>        }
</div><div class='line not-covered'><span class='num'>1569</span>    }
</div><div class='line not-executable'><span class='num'>1570</span>}
</div><div class='line not-executable'><span class='num'>1571</span>
</div><div class='line not-executable'><span class='num'>1572</span>
</div></body></html><html><head><meta charset='UTF-8'><style>
body { font-family: monospace; font-size: 12px; background: #222; color: #ddd; margin: 0; }
.covered { background: #1a4d1a; }
.not-covered { background: #4d1a1a; }
.not-executable { background: #2a2a2a; color: #666; }
.line { padding: 2px 10px; white-space: pre; border-left: 3px solid transparent; }
.covered { border-left-color: #0f0; }
.not-covered { border-left-color: #f00; }
.num { color: #666; width: 50px; display: inline-block; text-align: right; margin-right: 10px; }
h2 { background: #333; padding: 10px; margin: 20px 0 0 0; position: sticky; top: 0; }
</style></head><body><h2>/home/tarcisio/projects/graph/tests.php - 77.05% (47/61)</h2><div class='line not-executable'><span class='num'>1</span>&lt;?php
</div><div class='line not-executable'><span class='num'>2</span>
</div><div class='line not-executable'><span class='num'>3</span>declare(strict_types=1);
</div><div class='line not-executable'><span class='num'>4</span>
</div><div class='line not-executable'><span class='num'>5</span>require_once __DIR__ . &#039;/graph.php&#039;;
</div><div class='line not-executable'><span class='num'>6</span>
</div><div class='line not-executable'><span class='num'>7</span>ini_set(&#039;xdebug.mode&#039;, &#039;1&#039;);
</div><div class='line not-executable'><span class='num'>8</span>xdebug_start_code_coverage(XDEBUG_CC_UNUSED | XDEBUG_CC_DEAD_CODE);
</div><div class='line not-executable'><span class='num'>9</span>
</div><div class='line not-executable'><span class='num'>10</span>function array_diff_recursive($array1, $array2) {
</div><div class='line covered'><span class='num'>11</span>    $diff = [];
</div><div class='line not-executable'><span class='num'>12</span>    
</div><div class='line covered'><span class='num'>13</span>    foreach ($array1 as $key =&gt; $value) {
</div><div class='line covered'><span class='num'>14</span>        if (!array_key_exists($key, $array2)) {
</div><div class='line not-covered'><span class='num'>15</span>            $diff[$key] = $value;
</div><div class='line covered'><span class='num'>16</span>        } elseif (is_array($value)) {
</div><div class='line covered'><span class='num'>17</span>            if (!is_array($array2[$key])) {
</div><div class='line not-covered'><span class='num'>18</span>                $diff[$key] = $value;
</div><div class='line not-executable'><span class='num'>19</span>            } else {
</div><div class='line covered'><span class='num'>20</span>                $recursiveDiff = array_diff_recursive($value, $array2[$key]);
</div><div class='line covered'><span class='num'>21</span>                if (count($recursiveDiff)) {
</div><div class='line not-covered'><span class='num'>22</span>                    $diff[$key] = $recursiveDiff;
</div><div class='line not-executable'><span class='num'>23</span>                }
</div><div class='line not-executable'><span class='num'>24</span>            }
</div><div class='line covered'><span class='num'>25</span>        } elseif ($value !== $array2[$key]) {
</div><div class='line not-covered'><span class='num'>26</span>            $diff[$key] = $value;
</div><div class='line not-executable'><span class='num'>27</span>        }
</div><div class='line not-executable'><span class='num'>28</span>    }
</div><div class='line not-executable'><span class='num'>29</span>    
</div><div class='line covered'><span class='num'>30</span>    return $diff;
</div><div class='line not-covered'><span class='num'>31</span>}
</div><div class='line not-executable'><span class='num'>32</span>
</div><div class='line not-executable'><span class='num'>33</span>function get_test_graph_controller()
</div><div class='line not-executable'><span class='num'>34</span>{
</div><div class='line covered'><span class='num'>35</span>    GraphContext::$user = new User(&#039;test_user&#039;, &#039;127.0.0.1&#039;, new Group(&#039;contributor&#039;));
</div><div class='line covered'><span class='num'>36</span>    $pdo = GraphDatabase::createConnection(&#039;sqlite::memory:&#039;);
</div><div class='line covered'><span class='num'>37</span>    $databaseLogger = new Logger(&#039;database.log&#039;);
</div><div class='line not-executable'><span class='num'>38</span>
</div><div class='line covered'><span class='num'>39</span>    $graphDb = new GraphDatabase($pdo, $databaseLogger);
</div><div class='line not-executable'><span class='num'>40</span>
</div><div class='line covered'><span class='num'>41</span>    $serviceLogger = new Logger(&#039;service.log&#039;);
</div><div class='line covered'><span class='num'>42</span>    $graphService = new GraphService($graphDb, $serviceLogger);
</div><div class='line not-executable'><span class='num'>43</span>
</div><div class='line covered'><span class='num'>44</span>    $controllerLogger = new Logger(&#039;controller.log&#039;);
</div><div class='line covered'><span class='num'>45</span>    $graphController = new GraphController($graphService, $controllerLogger);
</div><div class='line not-executable'><span class='num'>46</span>    
</div><div class='line covered'><span class='num'>47</span>    return $graphController;
</div><div class='line not-covered'><span class='num'>48</span>}
</div><div class='line not-executable'><span class='num'>49</span>
</div><div class='line not-executable'><span class='num'>50</span>function test_node_good_path()
</div><div class='line not-executable'><span class='num'>51</span>{
</div><div class='line covered'><span class='num'>52</span>    $graphController = get_test_graph_controller();
</div><div class='line covered'><span class='num'>53</span>    $insertNodeReq = new Request();
</div><div class='line covered'><span class='num'>54</span>    $insertNodeReq-&gt;data = [&#039;id&#039; =&gt; &#039;node1&#039;, &#039;label&#039; =&gt; &#039;node1&#039;, &#039;category&#039; =&gt; &#039;business&#039;, &#039;type&#039; =&gt; &#039;server&#039;, &#039;data&#039; =&gt; [&#039;info&#039; =&gt; &#039;first node&#039;]];
</div><div class='line covered'><span class='num'>55</span>    $resp = $graphController-&gt;insertNode($insertNodeReq);
</div><div class='line not-executable'><span class='num'>56</span>    
</div><div class='line covered'><span class='num'>57</span>    $expected = [
</div><div class='line not-executable'><span class='num'>58</span>        &#039;id&#039;       =&gt; &#039;node1&#039;,
</div><div class='line not-executable'><span class='num'>59</span>        &#039;label&#039;    =&gt; &#039;node1&#039;,
</div><div class='line not-executable'><span class='num'>60</span>        &#039;category&#039; =&gt; &#039;business&#039;,
</div><div class='line not-executable'><span class='num'>61</span>        &#039;type&#039; =&gt; &#039;server&#039;,
</div><div class='line not-executable'><span class='num'>62</span>        &#039;data&#039; =&gt; [
</div><div class='line not-executable'><span class='num'>63</span>                &#039;info&#039; =&gt; &#039;first node&#039;
</div><div class='line not-executable'><span class='num'>64</span>        ]
</div><div class='line not-executable'><span class='num'>65</span>    ];
</div><div class='line not-executable'><span class='num'>66</span>
</div><div class='line covered'><span class='num'>67</span>    if($resp-&gt;code != 201) {
</div><div class='line not-covered'><span class='num'>68</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>69</span>    }
</div><div class='line not-executable'><span class='num'>70</span>
</div><div class='line covered'><span class='num'>71</span>    if($resp-&gt;status != &#039;success&#039;) {
</div><div class='line not-covered'><span class='num'>72</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>73</span>    }
</div><div class='line not-executable'><span class='num'>74</span>
</div><div class='line covered'><span class='num'>75</span>    if ($resp-&gt;message != &#039;node inserted&#039;) {
</div><div class='line not-covered'><span class='num'>76</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>77</span>    }
</div><div class='line not-executable'><span class='num'>78</span>
</div><div class='line covered'><span class='num'>79</span>    $diff = array_diff_recursive($resp-&gt;data, $expected);
</div><div class='line covered'><span class='num'>80</span>    if (! empty($diff)) {
</div><div class='line not-covered'><span class='num'>81</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>82</span>    }
</div><div class='line not-executable'><span class='num'>83</span>
</div><div class='line covered'><span class='num'>84</span>    $_GET[&#039;id&#039;] = &#039;node1&#039;;
</div><div class='line covered'><span class='num'>85</span>    $req = new Request();
</div><div class='line covered'><span class='num'>86</span>    $resp = $graphController-&gt;getNode($req);
</div><div class='line not-executable'><span class='num'>87</span>
</div><div class='line covered'><span class='num'>88</span>    if ($resp-&gt;code != 200) {
</div><div class='line not-covered'><span class='num'>89</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>90</span>    }
</div><div class='line not-executable'><span class='num'>91</span>
</div><div class='line covered'><span class='num'>92</span>    if($resp-&gt;status != &#039;success&#039;) {
</div><div class='line not-covered'><span class='num'>93</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>94</span>    }
</div><div class='line not-executable'><span class='num'>95</span>
</div><div class='line covered'><span class='num'>96</span>    if ($resp-&gt;message != &#039;node found&#039;) {
</div><div class='line not-covered'><span class='num'>97</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>98</span>    }
</div><div class='line not-executable'><span class='num'>99</span>
</div><div class='line covered'><span class='num'>100</span>    $expected = [
</div><div class='line not-executable'><span class='num'>101</span>        &#039;info&#039;     =&gt; &#039;first node&#039;,
</div><div class='line not-executable'><span class='num'>102</span>        &#039;id&#039;       =&gt; &#039;node1&#039;,
</div><div class='line not-executable'><span class='num'>103</span>        &#039;label&#039;    =&gt; &#039;node1&#039;,
</div><div class='line not-executable'><span class='num'>104</span>        &#039;category&#039; =&gt; &#039;business&#039;,
</div><div class='line not-executable'><span class='num'>105</span>        &#039;type&#039;     =&gt; &#039;server&#039;,
</div><div class='line not-executable'><span class='num'>106</span>    ];
</div><div class='line not-executable'><span class='num'>107</span>
</div><div class='line covered'><span class='num'>108</span>    $diff = array_diff_recursive($resp-&gt;data[&#039;data&#039;], $expected);
</div><div class='line covered'><span class='num'>109</span>    if (! empty($diff)) {
</div><div class='line not-covered'><span class='num'>110</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>111</span>    }
</div><div class='line not-executable'><span class='num'>112</span>    
</div><div class='line covered'><span class='num'>113</span>    $req = new Request();
</div><div class='line covered'><span class='num'>114</span>    $req-&gt;data = [
</div><div class='line not-executable'><span class='num'>115</span>        &#039;id&#039;       =&gt; &#039;node1&#039;,
</div><div class='line not-executable'><span class='num'>116</span>        &#039;label&#039;    =&gt; &#039;node1&#039;,
</div><div class='line not-executable'><span class='num'>117</span>        &#039;category&#039; =&gt; &#039;business&#039;,
</div><div class='line not-executable'><span class='num'>118</span>        &#039;type&#039; =&gt; &#039;server&#039;,
</div><div class='line not-executable'><span class='num'>119</span>        &#039;data&#039; =&gt; [
</div><div class='line not-executable'><span class='num'>120</span>                &#039;info&#039; =&gt; &#039;first node updated&#039;
</div><div class='line not-executable'><span class='num'>121</span>        ]
</div><div class='line not-executable'><span class='num'>122</span>    ];
</div><div class='line covered'><span class='num'>123</span>    $resp = $graphController-&gt;updateNode($req);
</div><div class='line covered'><span class='num'>124</span>    print_r($resp);
</div><div class='line covered'><span class='num'>125</span>}
</div><div class='line not-executable'><span class='num'>126</span>
</div><div class='line not-executable'><span class='num'>127</span>function tests() {
</div><div class='line covered'><span class='num'>128</span>    test_node_good_path();
</div><div class='line covered'><span class='num'>129</span>    echo &quot;fim&quot;;
</div><div class='line covered'><span class='num'>130</span>}
</div><div class='line not-executable'><span class='num'>131</span>
</div><div class='line covered'><span class='num'>132</span>tests();
</div><div class='line not-executable'><span class='num'>133</span>
</div><div class='line covered'><span class='num'>134</span>$coverage = xdebug_get_code_coverage();
</div><div class='line not-executable'><span class='num'>135</span>xdebug_stop_code_coverage();
</div><div class='line not-executable'><span class='num'>136</span>
</div><div class='line not-executable'><span class='num'>137</span>// Salvar em arquivo
</div><div class='line not-executable'><span class='num'>138</span>file_put_contents(&#039;coverage.json&#039;, json_encode($coverage, JSON_PRETTY_PRINT));
</div><div class='line not-executable'><span class='num'>139</span>
</div><div class='line not-executable'><span class='num'>140</span>echo &#039;fim&#039;;</div><h2>/home/tarcisio/projects/graph/graph.php - 30.66% (195/636)</h2><div class='line not-executable'><span class='num'>1</span>&lt;?php
</div><div class='line not-executable'><span class='num'>2</span>
</div><div class='line not-executable'><span class='num'>3</span>declare(strict_types=1);
</div><div class='line not-executable'><span class='num'>4</span>
</div><div class='line not-executable'><span class='num'>5</span>final class User
</div><div class='line not-executable'><span class='num'>6</span>{
</div><div class='line not-executable'><span class='num'>7</span>    public string $id;
</div><div class='line not-executable'><span class='num'>8</span>    public ?string $ipAddress;
</div><div class='line not-executable'><span class='num'>9</span>    public Group $group;
</div><div class='line not-executable'><span class='num'>10</span>
</div><div class='line not-executable'><span class='num'>11</span>    public function __construct(string $id, ?string $ipAddress, Group $group)
</div><div class='line not-executable'><span class='num'>12</span>    {
</div><div class='line covered'><span class='num'>13</span>        $this-&gt;id = $id;
</div><div class='line covered'><span class='num'>14</span>        $this-&gt;ipAddress = $ipAddress;
</div><div class='line covered'><span class='num'>15</span>        $this-&gt;group = $group;
</div><div class='line covered'><span class='num'>16</span>    }
</div><div class='line not-executable'><span class='num'>17</span>
</div><div class='line not-executable'><span class='num'>18</span>    public function toArray(): array
</div><div class='line not-executable'><span class='num'>19</span>    {
</div><div class='line not-executable'><span class='num'>20</span>        return [
</div><div class='line not-covered'><span class='num'>21</span>            &#039;id&#039; =&gt; $this-&gt;id,
</div><div class='line not-executable'><span class='num'>22</span>            &#039;group&#039; =&gt; [
</div><div class='line not-covered'><span class='num'>23</span>                &#039;id&#039; =&gt; $this-&gt;group-&gt;id,
</div><div class='line not-executable'><span class='num'>24</span>            ],
</div><div class='line not-executable'><span class='num'>25</span>        ];
</div><div class='line not-covered'><span class='num'>26</span>    }
</div><div class='line not-executable'><span class='num'>27</span>}
</div><div class='line not-executable'><span class='num'>28</span>
</div><div class='line not-executable'><span class='num'>29</span>final class Group
</div><div class='line not-executable'><span class='num'>30</span>{
</div><div class='line not-executable'><span class='num'>31</span>    private const ALLOWED_GROUPS = [&#039;anonymous&#039;, &#039;consumer&#039;, &#039;contributor&#039;, &#039;admin&#039;];
</div><div class='line not-executable'><span class='num'>32</span>    
</div><div class='line not-executable'><span class='num'>33</span>    public string $id;
</div><div class='line not-executable'><span class='num'>34</span>    
</div><div class='line not-executable'><span class='num'>35</span>    public function __construct(string $id)
</div><div class='line not-executable'><span class='num'>36</span>    {
</div><div class='line covered'><span class='num'>37</span>        if (!in_array($id, self::ALLOWED_GROUPS, true)) {
</div><div class='line not-covered'><span class='num'>38</span>            throw new InvalidArgumentException(&quot;Invalid user group: {$id}&quot;);
</div><div class='line not-executable'><span class='num'>39</span>        }
</div><div class='line covered'><span class='num'>40</span>        $this-&gt;id  = $id;
</div><div class='line covered'><span class='num'>41</span>    }
</div><div class='line not-executable'><span class='num'>42</span>}
</div><div class='line not-executable'><span class='num'>43</span>
</div><div class='line not-executable'><span class='num'>44</span>final class Graph
</div><div class='line not-executable'><span class='num'>45</span>{
</div><div class='line not-executable'><span class='num'>46</span>    public array $nodes = [];
</div><div class='line not-executable'><span class='num'>47</span>    public array $edges = [];
</div><div class='line not-executable'><span class='num'>48</span>    public array $data  = [];
</div><div class='line not-executable'><span class='num'>49</span>    public array $layout = [];
</div><div class='line not-executable'><span class='num'>50</span>    public array $styles = [];
</div><div class='line not-executable'><span class='num'>51</span>
</div><div class='line not-executable'><span class='num'>52</span>    public function __construct(array $nodes, array $edges)
</div><div class='line not-executable'><span class='num'>53</span>    {
</div><div class='line not-covered'><span class='num'>54</span>        $this-&gt;nodes = $nodes;
</div><div class='line not-covered'><span class='num'>55</span>        $this-&gt;edges = $edges;
</div><div class='line not-covered'><span class='num'>56</span>    }
</div><div class='line not-executable'><span class='num'>57</span>
</div><div class='line not-executable'><span class='num'>58</span>    public function toArray(): array
</div><div class='line not-executable'><span class='num'>59</span>    {
</div><div class='line not-executable'><span class='num'>60</span>        return [
</div><div class='line not-covered'><span class='num'>61</span>            &#039;nodes&#039; =&gt; $this-&gt;nodes,
</div><div class='line not-covered'><span class='num'>62</span>            &#039;edges&#039; =&gt; $this-&gt;edges,
</div><div class='line not-covered'><span class='num'>63</span>            &#039;data&#039; =&gt; $this-&gt;data,
</div><div class='line not-covered'><span class='num'>64</span>            &#039;layout&#039; =&gt; $this-&gt;layout,
</div><div class='line not-covered'><span class='num'>65</span>            &#039;styles&#039; =&gt; $this-&gt;styles,
</div><div class='line not-executable'><span class='num'>66</span>        ];
</div><div class='line not-covered'><span class='num'>67</span>    }
</div><div class='line not-executable'><span class='num'>68</span>}
</div><div class='line not-executable'><span class='num'>69</span>
</div><div class='line not-executable'><span class='num'>70</span>final class Node
</div><div class='line not-executable'><span class='num'>71</span>{
</div><div class='line not-executable'><span class='num'>72</span>    private const ALLOWED_CATEGORIES  = [&#039;business&#039;, &#039;application&#039;, &#039;infrastructure&#039;];
</div><div class='line not-executable'><span class='num'>73</span>    private const ALLOWED_TYPES       = [&#039;server&#039;, &#039;database&#039;, &#039;application&#039;, &#039;network&#039;];
</div><div class='line not-executable'><span class='num'>74</span>    private const ID_VALIDATION_REGEX = &#039;/^[a-zA-Z0-9\-_]+$/&#039;;
</div><div class='line not-executable'><span class='num'>75</span>    private const LABEL_MAX_LENGTH    = 20;
</div><div class='line not-executable'><span class='num'>76</span>    
</div><div class='line not-executable'><span class='num'>77</span>    public string $id;
</div><div class='line not-executable'><span class='num'>78</span>    public string $label;
</div><div class='line not-executable'><span class='num'>79</span>    public string $category;
</div><div class='line not-executable'><span class='num'>80</span>    public string $type;
</div><div class='line not-executable'><span class='num'>81</span>
</div><div class='line not-executable'><span class='num'>82</span>    public array $data = [];
</div><div class='line not-executable'><span class='num'>83</span>
</div><div class='line not-executable'><span class='num'>84</span>    public function __construct(string $id, string $label, string $category, string $type, array $data)
</div><div class='line not-executable'><span class='num'>85</span>    {
</div><div class='line covered'><span class='num'>86</span>        $this-&gt;validate($id, $label, $category, $type);
</div><div class='line covered'><span class='num'>87</span>        $this-&gt;id       = $id;
</div><div class='line covered'><span class='num'>88</span>        $this-&gt;label    = $label;
</div><div class='line covered'><span class='num'>89</span>        $this-&gt;category = $category;
</div><div class='line covered'><span class='num'>90</span>        $this-&gt;type     = $type;
</div><div class='line covered'><span class='num'>91</span>        $this-&gt;data     = $data;
</div><div class='line covered'><span class='num'>92</span>    }
</div><div class='line not-executable'><span class='num'>93</span>
</div><div class='line not-executable'><span class='num'>94</span>    private function validate(string $id, string $label, string $category, string $type): void
</div><div class='line not-executable'><span class='num'>95</span>    {
</div><div class='line covered'><span class='num'>96</span>        if (!preg_match(self::ID_VALIDATION_REGEX, $id)) {
</div><div class='line not-covered'><span class='num'>97</span>            throw new InvalidArgumentException(&quot;Invalid node ID: {$id}&quot;);
</div><div class='line not-executable'><span class='num'>98</span>        }
</div><div class='line not-executable'><span class='num'>99</span>
</div><div class='line covered'><span class='num'>100</span>        if (strlen($label) &gt; self::LABEL_MAX_LENGTH) {
</div><div class='line not-covered'><span class='num'>101</span>            throw new InvalidArgumentException(&quot;Node label exceeds maximum length of &quot; . self::LABEL_MAX_LENGTH);
</div><div class='line not-executable'><span class='num'>102</span>        }
</div><div class='line not-executable'><span class='num'>103</span>
</div><div class='line covered'><span class='num'>104</span>        if (!in_array($category, self::ALLOWED_CATEGORIES, true)) {
</div><div class='line not-covered'><span class='num'>105</span>            throw new InvalidArgumentException(&quot;Invalid node category: {$category}&quot;);
</div><div class='line not-executable'><span class='num'>106</span>        }
</div><div class='line not-executable'><span class='num'>107</span>
</div><div class='line covered'><span class='num'>108</span>        if (!in_array($type, self::ALLOWED_TYPES, true)) {
</div><div class='line not-covered'><span class='num'>109</span>            throw new InvalidArgumentException(&quot;Invalid node type: {$type}&quot;);
</div><div class='line not-executable'><span class='num'>110</span>        }
</div><div class='line covered'><span class='num'>111</span>    }
</div><div class='line not-executable'><span class='num'>112</span>
</div><div class='line not-executable'><span class='num'>113</span>    public function toArray(): array
</div><div class='line not-executable'><span class='num'>114</span>    {
</div><div class='line not-executable'><span class='num'>115</span>        return [
</div><div class='line covered'><span class='num'>116</span>            &#039;id&#039;       =&gt; $this-&gt;id,
</div><div class='line covered'><span class='num'>117</span>            &#039;label&#039;    =&gt; $this-&gt;label,
</div><div class='line covered'><span class='num'>118</span>            &#039;category&#039; =&gt; $this-&gt;category,
</div><div class='line covered'><span class='num'>119</span>            &#039;type&#039;     =&gt; $this-&gt;type,
</div><div class='line covered'><span class='num'>120</span>            &#039;data&#039;     =&gt; $this-&gt;data
</div><div class='line not-executable'><span class='num'>121</span>        ];
</div><div class='line not-covered'><span class='num'>122</span>    }
</div><div class='line not-executable'><span class='num'>123</span>}
</div><div class='line not-executable'><span class='num'>124</span>
</div><div class='line not-executable'><span class='num'>125</span>final class NodeStatus
</div><div class='line not-executable'><span class='num'>126</span>{
</div><div class='line not-executable'><span class='num'>127</span>    private const ALLOWED_NODE_STATUSES = [&#039;unknown&#039;, &#039;healthy&#039;, &#039;unhealthy&#039;, &#039;maintenance&#039;];
</div><div class='line not-executable'><span class='num'>128</span>
</div><div class='line not-executable'><span class='num'>129</span>    public string $nodeId;
</div><div class='line not-executable'><span class='num'>130</span>    public string $status;
</div><div class='line not-executable'><span class='num'>131</span>
</div><div class='line not-executable'><span class='num'>132</span>    public function __construct(string $nodeId, string $status)
</div><div class='line not-executable'><span class='num'>133</span>    {
</div><div class='line not-covered'><span class='num'>134</span>        if (!in_array($status, self::ALLOWED_NODE_STATUSES, true)) {
</div><div class='line not-covered'><span class='num'>135</span>            throw new InvalidArgumentException(&quot;Invalid node status: {$status}&quot;);
</div><div class='line not-executable'><span class='num'>136</span>        }
</div><div class='line not-covered'><span class='num'>137</span>        $this-&gt;nodeId = $nodeId;
</div><div class='line not-covered'><span class='num'>138</span>        $this-&gt;status = $status;
</div><div class='line not-covered'><span class='num'>139</span>    }
</div><div class='line not-executable'><span class='num'>140</span>
</div><div class='line not-executable'><span class='num'>141</span>    public function toArray(): array
</div><div class='line not-executable'><span class='num'>142</span>    {
</div><div class='line not-executable'><span class='num'>143</span>        return [
</div><div class='line not-covered'><span class='num'>144</span>            &#039;node_id&#039; =&gt; $this-&gt;nodeId,
</div><div class='line not-covered'><span class='num'>145</span>            &#039;status&#039;  =&gt; $this-&gt;status,
</div><div class='line not-executable'><span class='num'>146</span>        ];
</div><div class='line not-covered'><span class='num'>147</span>    }
</div><div class='line not-executable'><span class='num'>148</span>}
</div><div class='line not-executable'><span class='num'>149</span>
</div><div class='line not-executable'><span class='num'>150</span>final class NodeStatuses
</div><div class='line not-executable'><span class='num'>151</span>{
</div><div class='line not-executable'><span class='num'>152</span>    public array $statuses = [];
</div><div class='line not-executable'><span class='num'>153</span>
</div><div class='line not-executable'><span class='num'>154</span>    public function addStatus(NodeStatus $status): void
</div><div class='line not-executable'><span class='num'>155</span>    {
</div><div class='line not-covered'><span class='num'>156</span>        $this-&gt;statuses[] = $status;
</div><div class='line not-covered'><span class='num'>157</span>    }
</div><div class='line not-executable'><span class='num'>158</span>}
</div><div class='line not-executable'><span class='num'>159</span>
</div><div class='line not-executable'><span class='num'>160</span>final class Nodes
</div><div class='line not-executable'><span class='num'>161</span>{
</div><div class='line not-executable'><span class='num'>162</span>    public array $nodes = [];
</div><div class='line not-executable'><span class='num'>163</span>
</div><div class='line not-executable'><span class='num'>164</span>    public function addNode(Node $node): void
</div><div class='line not-executable'><span class='num'>165</span>    {
</div><div class='line not-covered'><span class='num'>166</span>        $this-&gt;nodes[] = $node;
</div><div class='line not-covered'><span class='num'>167</span>    }
</div><div class='line not-executable'><span class='num'>168</span>}
</div><div class='line not-executable'><span class='num'>169</span>
</div><div class='line not-executable'><span class='num'>170</span>final class Edge
</div><div class='line not-executable'><span class='num'>171</span>{
</div><div class='line not-executable'><span class='num'>172</span>    public ?string $id;
</div><div class='line not-executable'><span class='num'>173</span>    public string $source;
</div><div class='line not-executable'><span class='num'>174</span>    public string $target;
</div><div class='line not-executable'><span class='num'>175</span>    public array $data;
</div><div class='line not-executable'><span class='num'>176</span>
</div><div class='line not-executable'><span class='num'>177</span>    public function __construct(?string $id = null, string $source, string $target, array $data = [])
</div><div class='line not-executable'><span class='num'>178</span>    {
</div><div class='line covered'><span class='num'>179</span>        $this-&gt;id     = $id;
</div><div class='line covered'><span class='num'>180</span>        $this-&gt;source = $source;
</div><div class='line covered'><span class='num'>181</span>        $this-&gt;target = $target;
</div><div class='line covered'><span class='num'>182</span>        $this-&gt;data   = $data;
</div><div class='line covered'><span class='num'>183</span>    }
</div><div class='line not-executable'><span class='num'>184</span>
</div><div class='line not-executable'><span class='num'>185</span>    public function toArray(): array
</div><div class='line not-executable'><span class='num'>186</span>    {
</div><div class='line not-executable'><span class='num'>187</span>        return [
</div><div class='line covered'><span class='num'>188</span>            &#039;id&#039;     =&gt; $this-&gt;id,
</div><div class='line covered'><span class='num'>189</span>            &#039;source&#039; =&gt; $this-&gt;source,
</div><div class='line covered'><span class='num'>190</span>            &#039;target&#039; =&gt; $this-&gt;target,
</div><div class='line covered'><span class='num'>191</span>            &#039;data&#039;   =&gt; $this-&gt;data
</div><div class='line not-executable'><span class='num'>192</span>        ];
</div><div class='line not-covered'><span class='num'>193</span>    }
</div><div class='line not-executable'><span class='num'>194</span>}
</div><div class='line not-executable'><span class='num'>195</span>
</div><div class='line not-executable'><span class='num'>196</span>final class Edges
</div><div class='line not-executable'><span class='num'>197</span>{
</div><div class='line not-executable'><span class='num'>198</span>    public array $edges = [];
</div><div class='line not-executable'><span class='num'>199</span>    public function addEdge(Edge $edge): void
</div><div class='line not-executable'><span class='num'>200</span>    {
</div><div class='line not-covered'><span class='num'>201</span>        $this-&gt;edges[] = $edge;
</div><div class='line not-covered'><span class='num'>202</span>    }
</div><div class='line not-executable'><span class='num'>203</span>}
</div><div class='line not-executable'><span class='num'>204</span>
</div><div class='line not-executable'><span class='num'>205</span>final class AuditLog
</div><div class='line not-executable'><span class='num'>206</span>{
</div><div class='line not-executable'><span class='num'>207</span>    public string $entityType;
</div><div class='line not-executable'><span class='num'>208</span>    public string $entityId;
</div><div class='line not-executable'><span class='num'>209</span>    public string $action;
</div><div class='line not-executable'><span class='num'>210</span>    public ?array $oldData;
</div><div class='line not-executable'><span class='num'>211</span>    public ?array $newData;
</div><div class='line not-executable'><span class='num'>212</span>    public string $userId;
</div><div class='line not-executable'><span class='num'>213</span>    public string $ipAddress;
</div><div class='line not-executable'><span class='num'>214</span>    public string $createdAt;
</div><div class='line not-executable'><span class='num'>215</span>
</div><div class='line not-executable'><span class='num'>216</span>    public function __construct(string $entityType, string $entityId, string $action, ?array $oldData = null, ?array $newData = null)
</div><div class='line not-executable'><span class='num'>217</span>    {
</div><div class='line covered'><span class='num'>218</span>        $this-&gt;entityType = $entityType;
</div><div class='line covered'><span class='num'>219</span>        $this-&gt;entityId   = $entityId;
</div><div class='line covered'><span class='num'>220</span>        $this-&gt;action     = $action;
</div><div class='line covered'><span class='num'>221</span>        $this-&gt;oldData    = $oldData;
</div><div class='line covered'><span class='num'>222</span>        $this-&gt;newData    = $newData;
</div><div class='line covered'><span class='num'>223</span>    }
</div><div class='line not-executable'><span class='num'>224</span>}
</div><div class='line not-executable'><span class='num'>225</span>
</div><div class='line not-executable'><span class='num'>226</span>final class AuditLogs
</div><div class='line not-executable'><span class='num'>227</span>{
</div><div class='line not-executable'><span class='num'>228</span>    public array $logs = [];
</div><div class='line not-executable'><span class='num'>229</span>    public function addLog(AuditLog $log): void
</div><div class='line not-executable'><span class='num'>230</span>    {
</div><div class='line not-covered'><span class='num'>231</span>        $this-&gt;logs[] = $log;
</div><div class='line not-covered'><span class='num'>232</span>    }
</div><div class='line not-executable'><span class='num'>233</span>}
</div><div class='line not-executable'><span class='num'>234</span>
</div><div class='line not-executable'><span class='num'>235</span>final class GraphContext
</div><div class='line not-executable'><span class='num'>236</span>{
</div><div class='line not-executable'><span class='num'>237</span>    public static User $user;
</div><div class='line not-executable'><span class='num'>238</span>}
</div><div class='line not-executable'><span class='num'>239</span>
</div><div class='line not-executable'><span class='num'>240</span>interface LoggerInterface
</div><div class='line not-executable'><span class='num'>241</span>{
</div><div class='line not-executable'><span class='num'>242</span>    public function info(string $message, array $data = []): void;
</div><div class='line not-executable'><span class='num'>243</span>    public function debug(string $message, array $data = []): void;
</div><div class='line not-executable'><span class='num'>244</span>    public function error(string $message, array $data = []): void;
</div><div class='line not-executable'><span class='num'>245</span>}
</div><div class='line not-executable'><span class='num'>246</span>
</div><div class='line not-executable'><span class='num'>247</span>final class Logger implements LoggerInterface
</div><div class='line not-executable'><span class='num'>248</span>{
</div><div class='line not-executable'><span class='num'>249</span>    private string $fileName;
</div><div class='line not-executable'><span class='num'>250</span>    private $fd;
</div><div class='line not-executable'><span class='num'>251</span>
</div><div class='line not-executable'><span class='num'>252</span>    public function __construct($file_name)
</div><div class='line not-executable'><span class='num'>253</span>    {
</div><div class='line covered'><span class='num'>254</span>        $this-&gt;fileName = $file_name;
</div><div class='line covered'><span class='num'>255</span>        $this-&gt;fd = fopen($this-&gt;fileName, &#039;a&#039;);
</div><div class='line covered'><span class='num'>256</span>    }
</div><div class='line not-executable'><span class='num'>257</span>
</div><div class='line not-executable'><span class='num'>258</span>    public function info(string $message, array $data = []): void
</div><div class='line not-executable'><span class='num'>259</span>    {
</div><div class='line covered'><span class='num'>260</span>        $this-&gt;log(&#039;INFO&#039;, $message, $data);
</div><div class='line covered'><span class='num'>261</span>    }
</div><div class='line not-executable'><span class='num'>262</span>
</div><div class='line not-executable'><span class='num'>263</span>    public function debug(string $message, array $data = []): void
</div><div class='line not-executable'><span class='num'>264</span>    {
</div><div class='line covered'><span class='num'>265</span>        $this-&gt;log(&#039;DEBUG&#039;, $message, $data);
</div><div class='line covered'><span class='num'>266</span>    }
</div><div class='line not-executable'><span class='num'>267</span>
</div><div class='line not-executable'><span class='num'>268</span>    public function error(string $message, array $data = []): void
</div><div class='line not-executable'><span class='num'>269</span>    {
</div><div class='line not-covered'><span class='num'>270</span>        $this-&gt;log(&#039;ERROR&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>271</span>    }
</div><div class='line not-executable'><span class='num'>272</span>
</div><div class='line not-executable'><span class='num'>273</span>    private function log(string $type, $message, $data = [])
</div><div class='line not-executable'><span class='num'>274</span>    {
</div><div class='line covered'><span class='num'>275</span>        $trace = debug_backtrace(DEBUG_BACKTRACE_PROVIDE_OBJECT, 3);
</div><div class='line covered'><span class='num'>276</span>        $method = &quot;{$trace[2][&#039;class&#039;]}::{$trace[2][&#039;function&#039;]}&quot;;
</div><div class='line covered'><span class='num'>277</span>        $data = json_encode($data);
</div><div class='line covered'><span class='num'>278</span>        $message = &quot;[{$type}] {$method}: $message ($data)\n&quot;;
</div><div class='line covered'><span class='num'>279</span>        fwrite($this-&gt;fd, $message);
</div><div class='line covered'><span class='num'>280</span>    }
</div><div class='line not-executable'><span class='num'>281</span>}
</div><div class='line not-executable'><span class='num'>282</span>
</div><div class='line not-executable'><span class='num'>283</span>interface GraphDatabaseInterface
</div><div class='line not-executable'><span class='num'>284</span>{
</div><div class='line not-executable'><span class='num'>285</span>    public function getUser(string $id): ?array;
</div><div class='line not-executable'><span class='num'>286</span>    public function insertUser(string $id, string $group): void;
</div><div class='line not-executable'><span class='num'>287</span>    public function updateUser(string $id, string $group): void;
</div><div class='line not-executable'><span class='num'>288</span>
</div><div class='line not-executable'><span class='num'>289</span>    public function getNode(string $id): ?array;
</div><div class='line not-executable'><span class='num'>290</span>    public function getNodes(): array;
</div><div class='line not-executable'><span class='num'>291</span>    public function insertNode(string $id, string $label, string $category, string $type, array $data = []): void;
</div><div class='line not-executable'><span class='num'>292</span>    public function updateNode(string $id, string $label, string $category, string $type, array $data = []): void;
</div><div class='line not-executable'><span class='num'>293</span>    public function deleteNode(string $id): void;
</div><div class='line not-executable'><span class='num'>294</span>
</div><div class='line not-executable'><span class='num'>295</span>    public function getEdge(string $source, string $target): ?array;
</div><div class='line not-executable'><span class='num'>296</span>    public function getEdgeById(string $id): ?array;
</div><div class='line not-executable'><span class='num'>297</span>    public function getEdges(): array;
</div><div class='line not-executable'><span class='num'>298</span>    public function insertEdge(string $id, string $source, string $target, array $data = []): void;
</div><div class='line not-executable'><span class='num'>299</span>    public function updateEdge(string $id, string $source, string $target, array $data = []): void;
</div><div class='line not-executable'><span class='num'>300</span>    public function deleteEdge(string $id): void;
</div><div class='line not-executable'><span class='num'>301</span>
</div><div class='line not-executable'><span class='num'>302</span>    public function getStatuses(): array;
</div><div class='line not-executable'><span class='num'>303</span>    public function getNodeStatus(string $id): ?string;
</div><div class='line not-executable'><span class='num'>304</span>    public function setNodeStatus(string $id, string $status): void;
</div><div class='line not-executable'><span class='num'>305</span>
</div><div class='line not-executable'><span class='num'>306</span>    public function getLogs($limit): array;
</div><div class='line not-executable'><span class='num'>307</span>    public function insertAuditLog(
</div><div class='line not-executable'><span class='num'>308</span>        string $entity_type, 
</div><div class='line not-executable'><span class='num'>309</span>        string $entity_id, 
</div><div class='line not-executable'><span class='num'>310</span>        string $action, 
</div><div class='line not-executable'><span class='num'>311</span>        ?array $old_data = null, 
</div><div class='line not-executable'><span class='num'>312</span>        ?array $new_data = null,
</div><div class='line not-executable'><span class='num'>313</span>        string $user_id,
</div><div class='line not-executable'><span class='num'>314</span>        string $ip_address): bool;
</div><div class='line not-executable'><span class='num'>315</span>}
</div><div class='line not-executable'><span class='num'>316</span>
</div><div class='line not-executable'><span class='num'>317</span>final class DatabaseException extends RuntimeException
</div><div class='line not-executable'><span class='num'>318</span>{
</div><div class='line not-executable'><span class='num'>319</span>    private ?string $query;
</div><div class='line not-executable'><span class='num'>320</span>    private ?array $params;
</div><div class='line not-executable'><span class='num'>321</span>
</div><div class='line not-executable'><span class='num'>322</span>    
</div><div class='line not-executable'><span class='num'>323</span>    public function __construct(string $message = &quot;&quot;,  int $code = 0, ?Throwable $previous = null, ?string $query = null, ?array $params) {
</div><div class='line not-covered'><span class='num'>324</span>        parent::__construct($message, $code, $previous);
</div><div class='line not-covered'><span class='num'>325</span>        $this-&gt;query = $query;
</div><div class='line not-covered'><span class='num'>326</span>        $this-&gt;params = $params;
</div><div class='line not-covered'><span class='num'>327</span>    }
</div><div class='line not-executable'><span class='num'>328</span>}
</div><div class='line not-executable'><span class='num'>329</span>
</div><div class='line not-executable'><span class='num'>330</span>final class GraphDatabase implements GraphDatabaseInterface
</div><div class='line not-executable'><span class='num'>331</span>{
</div><div class='line not-executable'><span class='num'>332</span>    private PDO $pdo;
</div><div class='line not-executable'><span class='num'>333</span>    private Logger $logger;
</div><div class='line not-executable'><span class='num'>334</span>
</div><div class='line not-executable'><span class='num'>335</span>    public function __construct(PDO $pdo, Logger $logger)
</div><div class='line not-executable'><span class='num'>336</span>    {
</div><div class='line covered'><span class='num'>337</span>        $this-&gt;pdo = $pdo;
</div><div class='line covered'><span class='num'>338</span>        $this-&gt;logger = $logger;
</div><div class='line covered'><span class='num'>339</span>        $this-&gt;initSchema();
</div><div class='line covered'><span class='num'>340</span>    }
</div><div class='line not-executable'><span class='num'>341</span>
</div><div class='line not-executable'><span class='num'>342</span>    public function getUser(string $id): ?array
</div><div class='line not-executable'><span class='num'>343</span>    {
</div><div class='line not-covered'><span class='num'>344</span>        $this-&gt;logger-&gt;debug(&quot;getting user id: &#039;{$id}&#039;&quot;);
</div><div class='line not-executable'><span class='num'>345</span>        try {
</div><div class='line not-covered'><span class='num'>346</span>            $sql = &quot;SELECT * FROM users WHERE id = :id&quot;;
</div><div class='line not-covered'><span class='num'>347</span>            $params = [&#039;:id&#039; =&gt; $id];
</div><div class='line not-covered'><span class='num'>348</span>            $stmt = $this-&gt;pdo-&gt;prepare($sql);
</div><div class='line not-covered'><span class='num'>349</span>            $stmt-&gt;execute($params);
</div><div class='line not-covered'><span class='num'>350</span>            $row = $stmt-&gt;fetch();
</div><div class='line not-executable'><span class='num'>351</span>
</div><div class='line not-covered'><span class='num'>352</span>            if ($row) {
</div><div class='line not-covered'><span class='num'>353</span>                return $row;
</div><div class='line not-executable'><span class='num'>354</span>            }
</div><div class='line not-covered'><span class='num'>355</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>356</span>            $e = new DatabaseException(
</div><div class='line not-covered'><span class='num'>357</span>                &quot;GraphDatabase Exception while trying to get user data. ID: {$id}&quot;,
</div><div class='line not-covered'><span class='num'>358</span>                0,
</div><div class='line not-executable'><span class='num'>359</span>                $e,
</div><div class='line not-executable'><span class='num'>360</span>                $sql,
</div><div class='line not-executable'><span class='num'>361</span>                $params
</div><div class='line not-executable'><span class='num'>362</span>            );
</div><div class='line not-executable'><span class='num'>363</span>        }
</div><div class='line not-covered'><span class='num'>364</span>        return null;
</div><div class='line not-covered'><span class='num'>365</span>    }
</div><div class='line not-executable'><span class='num'>366</span>
</div><div class='line not-executable'><span class='num'>367</span>    public function insertUser(string $id, string $group): void
</div><div class='line not-executable'><span class='num'>368</span>    {
</div><div class='line not-executable'><span class='num'>369</span>        try {
</div><div class='line not-covered'><span class='num'>370</span>            $sql = &quot;
</div><div class='line not-executable'><span class='num'>371</span>                INSERT OR IGNORE INTO users 
</div><div class='line not-executable'><span class='num'>372</span>                (id, user_group)
</div><div class='line not-executable'><span class='num'>373</span>                VALUES (:id, :group)&quot;;
</div><div class='line not-executable'><span class='num'>374</span>            
</div><div class='line not-covered'><span class='num'>375</span>            $params = [
</div><div class='line not-covered'><span class='num'>376</span>                &#039;:id&#039;       =&gt; $id,
</div><div class='line not-covered'><span class='num'>377</span>                &#039;:group&#039;    =&gt; $group
</div><div class='line not-executable'><span class='num'>378</span>            ];
</div><div class='line not-executable'><span class='num'>379</span>
</div><div class='line not-covered'><span class='num'>380</span>            $stmt = $this-&gt;pdo-&gt;prepare($sql);
</div><div class='line not-covered'><span class='num'>381</span>            $stmt-&gt;execute($params);
</div><div class='line not-covered'><span class='num'>382</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>383</span>            $e = new DatabaseException(
</div><div class='line not-covered'><span class='num'>384</span>                &quot;GraphDatabase Exception while trying to insert new user. ID: {$id}&quot;,
</div><div class='line not-covered'><span class='num'>385</span>                0,
</div><div class='line not-executable'><span class='num'>386</span>                $e,
</div><div class='line not-executable'><span class='num'>387</span>                $sql,
</div><div class='line not-executable'><span class='num'>388</span>                $params
</div><div class='line not-executable'><span class='num'>389</span>            );
</div><div class='line not-executable'><span class='num'>390</span>        }
</div><div class='line not-covered'><span class='num'>391</span>    }
</div><div class='line not-executable'><span class='num'>392</span>
</div><div class='line not-executable'><span class='num'>393</span>    public function updateUser(string $id, string $group): void
</div><div class='line not-executable'><span class='num'>394</span>    {
</div><div class='line not-executable'><span class='num'>395</span>        try {
</div><div class='line not-covered'><span class='num'>396</span>            $sql = &quot;
</div><div class='line not-executable'><span class='num'>397</span>                UPDATE users
</div><div class='line not-executable'><span class='num'>398</span>                SET    user_group = :group
</div><div class='line not-executable'><span class='num'>399</span>                WHERE  id = :id
</div><div class='line not-executable'><span class='num'>400</span>            &quot;;
</div><div class='line not-executable'><span class='num'>401</span>
</div><div class='line not-covered'><span class='num'>402</span>            $params = [
</div><div class='line not-covered'><span class='num'>403</span>                &#039;:id&#039;       =&gt; $id,
</div><div class='line not-covered'><span class='num'>404</span>                &#039;:group&#039;    =&gt; $group
</div><div class='line not-executable'><span class='num'>405</span>            ];
</div><div class='line not-executable'><span class='num'>406</span>
</div><div class='line not-covered'><span class='num'>407</span>            $stmt = $this-&gt;pdo-&gt;prepare($sql);
</div><div class='line not-executable'><span class='num'>408</span>            
</div><div class='line not-covered'><span class='num'>409</span>            $stmt-&gt;execute($params);
</div><div class='line not-executable'><span class='num'>410</span>
</div><div class='line not-covered'><span class='num'>411</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>412</span>            $e = new DatabaseException(
</div><div class='line not-covered'><span class='num'>413</span>                &quot;GraphDatabase Exception while trying to update user. ID: {$id}&quot;,
</div><div class='line not-covered'><span class='num'>414</span>                0,
</div><div class='line not-executable'><span class='num'>415</span>                $e,
</div><div class='line not-executable'><span class='num'>416</span>                $sql,
</div><div class='line not-executable'><span class='num'>417</span>                $params
</div><div class='line not-executable'><span class='num'>418</span>            );
</div><div class='line not-executable'><span class='num'>419</span>        }
</div><div class='line not-covered'><span class='num'>420</span>    }
</div><div class='line not-executable'><span class='num'>421</span>
</div><div class='line not-executable'><span class='num'>422</span>    public function getNode(string $id): ?array
</div><div class='line not-executable'><span class='num'>423</span>    {
</div><div class='line covered'><span class='num'>424</span>        $this-&gt;logger-&gt;debug(&quot;fetching node &#039;{$id}&#039;&quot;);
</div><div class='line not-executable'><span class='num'>425</span>
</div><div class='line not-executable'><span class='num'>426</span>        try {
</div><div class='line covered'><span class='num'>427</span>            $sql = &quot;SELECT * FROM nodes WHERE id = :id&quot;;
</div><div class='line covered'><span class='num'>428</span>            $params = [&#039;:id&#039; =&gt; $id];
</div><div class='line covered'><span class='num'>429</span>            $stmt = $this-&gt;pdo-&gt;prepare($sql);
</div><div class='line covered'><span class='num'>430</span>            $stmt-&gt;execute($params);
</div><div class='line covered'><span class='num'>431</span>            $row = $stmt-&gt;fetch();
</div><div class='line covered'><span class='num'>432</span>            if ($row) {
</div><div class='line covered'><span class='num'>433</span>                return $row;
</div><div class='line not-executable'><span class='num'>434</span>            }
</div><div class='line not-covered'><span class='num'>435</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>436</span>            $this-&gt;logger-&gt;error(&quot;exception with node id &#039;{$id}&#039;&quot;);
</div><div class='line not-covered'><span class='num'>437</span>            throw new DatabaseException(&quot;could not get node data with id &#039;{$id}&#039;&quot;, 0, $e, $sql, $params);
</div><div class='line not-executable'><span class='num'>438</span>        }
</div><div class='line not-covered'><span class='num'>439</span>        return null;
</div><div class='line not-covered'><span class='num'>440</span>    }
</div><div class='line not-executable'><span class='num'>441</span>
</div><div class='line not-executable'><span class='num'>442</span>    public function getNodes(): array
</div><div class='line not-executable'><span class='num'>443</span>    {
</div><div class='line not-executable'><span class='num'>444</span>        try {
</div><div class='line not-covered'><span class='num'>445</span>            $stmt = $this-&gt;pdo-&gt;query(&quot;SELECT * FROM nodes&quot;);
</div><div class='line not-covered'><span class='num'>446</span>            $rows = $stmt-&gt;fetchAll();
</div><div class='line not-covered'><span class='num'>447</span>            return $rows;
</div><div class='line not-covered'><span class='num'>448</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>449</span>            error_log(&quot;GraphDatabase fetch all nodes failed: &quot; . $e-&gt;getMessage());
</div><div class='line not-covered'><span class='num'>450</span>            return [];
</div><div class='line not-executable'><span class='num'>451</span>        }
</div><div class='line not-covered'><span class='num'>452</span>    }
</div><div class='line not-executable'><span class='num'>453</span>
</div><div class='line not-executable'><span class='num'>454</span>    public function insertNode(string $id, string $label, string $category, string $type, array $data = []): void
</div><div class='line not-executable'><span class='num'>455</span>    {
</div><div class='line not-executable'><span class='num'>456</span>        try {
</div><div class='line covered'><span class='num'>457</span>            $sql = &quot;
</div><div class='line not-executable'><span class='num'>458</span>                INSERT OR IGNORE INTO nodes 
</div><div class='line not-executable'><span class='num'>459</span>                (id, label, category, type, data) 
</div><div class='line not-executable'><span class='num'>460</span>                VALUES (:id, :label, :category, :type, :data)&quot;;
</div><div class='line covered'><span class='num'>461</span>            $stmt             = $this-&gt;pdo-&gt;prepare($sql);
</div><div class='line covered'><span class='num'>462</span>            $data[&#039;id&#039;]       = $id;
</div><div class='line covered'><span class='num'>463</span>            $data[&#039;label&#039;]    = $label;
</div><div class='line covered'><span class='num'>464</span>            $data[&#039;category&#039;] = $category;
</div><div class='line covered'><span class='num'>465</span>            $data[&#039;type&#039;]     = $type;
</div><div class='line covered'><span class='num'>466</span>            $stmt-&gt;execute([
</div><div class='line covered'><span class='num'>467</span>                &#039;:id&#039;       =&gt; $id,
</div><div class='line covered'><span class='num'>468</span>                &#039;:label&#039;    =&gt; $label,
</div><div class='line covered'><span class='num'>469</span>                &#039;:category&#039; =&gt; $category,
</div><div class='line covered'><span class='num'>470</span>                &#039;:type&#039;     =&gt; $type,
</div><div class='line covered'><span class='num'>471</span>                &#039;:data&#039;     =&gt; json_encode($data, JSON_UNESCAPED_UNICODE)
</div><div class='line not-executable'><span class='num'>472</span>            ]);
</div><div class='line not-covered'><span class='num'>473</span>        } catch (PDOException $e) {
</div><div class='line not-executable'><span class='num'>474</span>            // TODO
</div><div class='line not-executable'><span class='num'>475</span>        }
</div><div class='line covered'><span class='num'>476</span>    }
</div><div class='line not-executable'><span class='num'>477</span>
</div><div class='line not-executable'><span class='num'>478</span>    public function updateNode(string $id, string $label, string $category, string $type, array $data = []): void
</div><div class='line not-executable'><span class='num'>479</span>    {
</div><div class='line not-executable'><span class='num'>480</span>        try {
</div><div class='line not-covered'><span class='num'>481</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-executable'><span class='num'>482</span>                UPDATE nodes
</div><div class='line not-executable'><span class='num'>483</span>                SET    label = :label, 
</div><div class='line not-executable'><span class='num'>484</span>                       category = :category, 
</div><div class='line not-executable'><span class='num'>485</span>                       type = :type, 
</div><div class='line not-executable'><span class='num'>486</span>                       data = :data
</div><div class='line not-executable'><span class='num'>487</span>                WHERE  id = :id&quot;);
</div><div class='line not-covered'><span class='num'>488</span>            $data[&#039;id&#039;]       = $id;
</div><div class='line not-covered'><span class='num'>489</span>            $data[&#039;label&#039;]    = $label;
</div><div class='line not-covered'><span class='num'>490</span>            $data[&#039;category&#039;] = $category;
</div><div class='line not-covered'><span class='num'>491</span>            $data[&#039;type&#039;]     = $type;
</div><div class='line not-executable'><span class='num'>492</span>
</div><div class='line not-covered'><span class='num'>493</span>            $stmt-&gt;execute([
</div><div class='line not-covered'><span class='num'>494</span>                &#039;:id&#039;       =&gt; $id,
</div><div class='line not-covered'><span class='num'>495</span>                &#039;:label&#039;    =&gt; $label,
</div><div class='line not-covered'><span class='num'>496</span>                &#039;:category&#039; =&gt; $category,
</div><div class='line not-covered'><span class='num'>497</span>                &#039;:type&#039;     =&gt; $type,
</div><div class='line not-covered'><span class='num'>498</span>                &#039;:data&#039;     =&gt; json_encode($data, JSON_UNESCAPED_UNICODE)
</div><div class='line not-executable'><span class='num'>499</span>            ]);
</div><div class='line not-covered'><span class='num'>500</span>        } catch (PDOException $e) {
</div><div class='line not-executable'><span class='num'>501</span>            // TODO
</div><div class='line not-executable'><span class='num'>502</span>        }
</div><div class='line not-covered'><span class='num'>503</span>    }
</div><div class='line not-executable'><span class='num'>504</span>
</div><div class='line not-executable'><span class='num'>505</span>    public function deleteNode(string $id): void
</div><div class='line not-executable'><span class='num'>506</span>    {
</div><div class='line not-executable'><span class='num'>507</span>        try {
</div><div class='line not-covered'><span class='num'>508</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;DELETE FROM nodes WHERE id = :id&quot;);
</div><div class='line not-covered'><span class='num'>509</span>            $stmt-&gt;execute([&#039;:id&#039; =&gt; $id]);
</div><div class='line not-covered'><span class='num'>510</span>        } catch (PDOException $e) {
</div><div class='line not-executable'><span class='num'>511</span>            // TODO
</div><div class='line not-executable'><span class='num'>512</span>        }
</div><div class='line not-covered'><span class='num'>513</span>    }
</div><div class='line not-executable'><span class='num'>514</span>
</div><div class='line not-executable'><span class='num'>515</span>    public function getEdge(string $source, string $target): ?array
</div><div class='line not-executable'><span class='num'>516</span>    {
</div><div class='line not-executable'><span class='num'>517</span>        try {
</div><div class='line covered'><span class='num'>518</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-executable'><span class='num'>519</span>                SELECT * FROM edges
</div><div class='line not-executable'><span class='num'>520</span>                WHERE source = :source AND target = :target
</div><div class='line not-executable'><span class='num'>521</span>            &quot;);
</div><div class='line covered'><span class='num'>522</span>            $stmt-&gt;execute([
</div><div class='line covered'><span class='num'>523</span>                &#039;:source&#039; =&gt; $source,
</div><div class='line covered'><span class='num'>524</span>                &#039;:target&#039; =&gt; $target
</div><div class='line not-executable'><span class='num'>525</span>            ]);
</div><div class='line covered'><span class='num'>526</span>            $row = $stmt-&gt;fetch();
</div><div class='line covered'><span class='num'>527</span>            if ($row) {
</div><div class='line covered'><span class='num'>528</span>                return $row;
</div><div class='line not-executable'><span class='num'>529</span>            }
</div><div class='line not-covered'><span class='num'>530</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>531</span>            error_log(&quot;GraphDatabase edge exists check failed: &quot; . $e-&gt;getMessage());
</div><div class='line not-executable'><span class='num'>532</span>        }
</div><div class='line covered'><span class='num'>533</span>        return null;
</div><div class='line not-covered'><span class='num'>534</span>    }
</div><div class='line not-executable'><span class='num'>535</span>
</div><div class='line not-executable'><span class='num'>536</span>    public function getEdgeById(string $id): ?array
</div><div class='line not-executable'><span class='num'>537</span>    {
</div><div class='line not-executable'><span class='num'>538</span>        try {
</div><div class='line not-covered'><span class='num'>539</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-executable'><span class='num'>540</span>                SELECT * FROM edges
</div><div class='line not-executable'><span class='num'>541</span>                WHERE id = :id
</div><div class='line not-executable'><span class='num'>542</span>            &quot;);
</div><div class='line not-covered'><span class='num'>543</span>            $stmt-&gt;execute([
</div><div class='line not-covered'><span class='num'>544</span>                &#039;:id&#039; =&gt; $id,
</div><div class='line not-executable'><span class='num'>545</span>            ]);
</div><div class='line not-covered'><span class='num'>546</span>            $row = $stmt-&gt;fetch();
</div><div class='line not-covered'><span class='num'>547</span>            if ($row) {
</div><div class='line not-covered'><span class='num'>548</span>                return $row;
</div><div class='line not-executable'><span class='num'>549</span>            }
</div><div class='line not-covered'><span class='num'>550</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>551</span>            error_log(&quot;GraphDatabase edge exists check failed: &quot; . $e-&gt;getMessage());
</div><div class='line not-executable'><span class='num'>552</span>        }
</div><div class='line not-covered'><span class='num'>553</span>        return null;
</div><div class='line not-covered'><span class='num'>554</span>    }
</div><div class='line not-executable'><span class='num'>555</span>
</div><div class='line not-executable'><span class='num'>556</span>    public function getEdges(): array
</div><div class='line not-executable'><span class='num'>557</span>    {
</div><div class='line not-executable'><span class='num'>558</span>        try {
</div><div class='line not-covered'><span class='num'>559</span>            $stmt  = $this-&gt;pdo-&gt;query(&quot;SELECT * FROM edges&quot;);
</div><div class='line not-covered'><span class='num'>560</span>            $rows  = $stmt-&gt;fetchAll();
</div><div class='line not-covered'><span class='num'>561</span>            return $rows;
</div><div class='line not-covered'><span class='num'>562</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>563</span>            error_log(&quot;GraphDatabase fetch all edges failed: &quot; . $e-&gt;getMessage());
</div><div class='line not-covered'><span class='num'>564</span>            return [];
</div><div class='line not-executable'><span class='num'>565</span>        }
</div><div class='line not-covered'><span class='num'>566</span>    }
</div><div class='line not-executable'><span class='num'>567</span>
</div><div class='line not-executable'><span class='num'>568</span>    public function insertEdge(string $id, string $source, string $target, array $data = []): void
</div><div class='line not-executable'><span class='num'>569</span>    {
</div><div class='line not-executable'><span class='num'>570</span>        // verify if the inverse edge exists
</div><div class='line covered'><span class='num'>571</span>        $r = $this-&gt;getEdge($target, $source);
</div><div class='line not-executable'><span class='num'>572</span>        
</div><div class='line not-executable'><span class='num'>573</span>        try {
</div><div class='line covered'><span class='num'>574</span>            $sql = &quot;
</div><div class='line not-executable'><span class='num'>575</span>                INSERT OR IGNORE INTO edges
</div><div class='line not-executable'><span class='num'>576</span>                (id, source, target, data)
</div><div class='line not-executable'><span class='num'>577</span>                VALUES (:id, :source, :target, :data)&quot;;
</div><div class='line covered'><span class='num'>578</span>            $stmt           = $this-&gt;pdo-&gt;prepare($sql);
</div><div class='line covered'><span class='num'>579</span>            $data[&#039;id&#039;]     = $id;
</div><div class='line covered'><span class='num'>580</span>            $data[&#039;source&#039;] = $source;
</div><div class='line covered'><span class='num'>581</span>            $data[&#039;target&#039;] = $target;
</div><div class='line covered'><span class='num'>582</span>            $stmt-&gt;execute([
</div><div class='line covered'><span class='num'>583</span>                &#039;:id&#039;     =&gt; $id,
</div><div class='line covered'><span class='num'>584</span>                &#039;:source&#039; =&gt; $source,
</div><div class='line covered'><span class='num'>585</span>                &#039;:target&#039; =&gt; $target,
</div><div class='line covered'><span class='num'>586</span>                &#039;:data&#039;   =&gt; json_encode($data, JSON_UNESCAPED_UNICODE)
</div><div class='line not-executable'><span class='num'>587</span>            ]);
</div><div class='line covered'><span class='num'>588</span>        } catch (PDOException $e) {
</div><div class='line not-executable'><span class='num'>589</span>            // TODO
</div><div class='line not-executable'><span class='num'>590</span>        }
</div><div class='line covered'><span class='num'>591</span>    }
</div><div class='line not-executable'><span class='num'>592</span>
</div><div class='line not-executable'><span class='num'>593</span>    public function updateEdge(string $id, string $source, string $target, array $data = []): void
</div><div class='line not-executable'><span class='num'>594</span>    {
</div><div class='line not-executable'><span class='num'>595</span>        try {
</div><div class='line not-covered'><span class='num'>596</span>            $data[&#039;id&#039;]     = $id;
</div><div class='line not-covered'><span class='num'>597</span>            $data[&#039;source&#039;] = $source;
</div><div class='line not-covered'><span class='num'>598</span>            $data[&#039;target&#039;] = $target;
</div><div class='line not-executable'><span class='num'>599</span>
</div><div class='line not-covered'><span class='num'>600</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-executable'><span class='num'>601</span>                UPDATE edges
</div><div class='line not-executable'><span class='num'>602</span>                SET data = :data
</div><div class='line not-executable'><span class='num'>603</span>                WHERE id = :id&quot;);
</div><div class='line not-covered'><span class='num'>604</span>            $stmt-&gt;execute([
</div><div class='line not-covered'><span class='num'>605</span>                &#039;:id&#039;   =&gt; $id,
</div><div class='line not-covered'><span class='num'>606</span>                &#039;:data&#039; =&gt; json_encode($data, JSON_UNESCAPED_UNICODE)
</div><div class='line not-executable'><span class='num'>607</span>            ]);
</div><div class='line not-covered'><span class='num'>608</span>        } catch (PDOException $e) {
</div><div class='line not-executable'><span class='num'>609</span>            // TODO
</div><div class='line not-executable'><span class='num'>610</span>        }
</div><div class='line not-covered'><span class='num'>611</span>    }
</div><div class='line not-executable'><span class='num'>612</span>
</div><div class='line not-executable'><span class='num'>613</span>    public function deleteEdge(string $id): void
</div><div class='line not-executable'><span class='num'>614</span>    {
</div><div class='line not-executable'><span class='num'>615</span>        try {
</div><div class='line not-covered'><span class='num'>616</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;DELETE FROM edges WHERE id = :id&quot;);
</div><div class='line not-covered'><span class='num'>617</span>            $stmt-&gt;execute([&#039;:id&#039; =&gt; $id]);
</div><div class='line not-covered'><span class='num'>618</span>        } catch (PDOException $e) {
</div><div class='line not-executable'><span class='num'>619</span>            // TODO
</div><div class='line not-executable'><span class='num'>620</span>        }
</div><div class='line not-covered'><span class='num'>621</span>    }
</div><div class='line not-executable'><span class='num'>622</span>
</div><div class='line not-executable'><span class='num'>623</span>    public function getStatuses(): array
</div><div class='line not-executable'><span class='num'>624</span>    {
</div><div class='line not-covered'><span class='num'>625</span>        $stmt   = $this-&gt;pdo-&gt;query(&quot;
</div><div class='line not-executable'><span class='num'>626</span>            SELECT n.id,
</div><div class='line not-executable'><span class='num'>627</span>                   s.status
</div><div class='line not-executable'><span class='num'>628</span>            FROM   nodes n
</div><div class='line not-executable'><span class='num'>629</span>            LEFT JOIN status s ON n.id = s.node_id&quot;);
</div><div class='line not-covered'><span class='num'>630</span>        $status = $stmt-&gt;fetchAll();
</div><div class='line not-covered'><span class='num'>631</span>        return $status;
</div><div class='line not-covered'><span class='num'>632</span>    }
</div><div class='line not-executable'><span class='num'>633</span>
</div><div class='line not-executable'><span class='num'>634</span>    public function getNodeStatus(string $id): ?string
</div><div class='line not-executable'><span class='num'>635</span>    {
</div><div class='line not-covered'><span class='num'>636</span>        $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-executable'><span class='num'>637</span>            SELECT s.status
</div><div class='line not-executable'><span class='num'>638</span>            FROM nodes n
</div><div class='line not-executable'><span class='num'>639</span>            LEFT JOIN status s
</div><div class='line not-executable'><span class='num'>640</span>            ON n.id = s.node_id
</div><div class='line not-executable'><span class='num'>641</span>            WHERE n.id = ?&quot;);
</div><div class='line not-covered'><span class='num'>642</span>        $stmt-&gt;execute([$id]);
</div><div class='line not-covered'><span class='num'>643</span>        $status = $stmt-&gt;fetch();
</div><div class='line not-covered'><span class='num'>644</span>        return $status ? $status[&#039;status&#039;] : null;
</div><div class='line not-covered'><span class='num'>645</span>    }
</div><div class='line not-executable'><span class='num'>646</span>
</div><div class='line not-executable'><span class='num'>647</span>    public function setNodeStatus(string $id, string $status): void
</div><div class='line not-executable'><span class='num'>648</span>    {
</div><div class='line not-covered'><span class='num'>649</span>        $stmt = $this-&gt;pdo-&gt;prepare(&quot;REPLACE INTO status (node_id, status) VALUES (?, ?)&quot;);
</div><div class='line not-covered'><span class='num'>650</span>        $stmt-&gt;execute([$id, $status]);
</div><div class='line not-covered'><span class='num'>651</span>    }
</div><div class='line not-executable'><span class='num'>652</span>
</div><div class='line not-executable'><span class='num'>653</span>    public function getLogs($limit): array
</div><div class='line not-executable'><span class='num'>654</span>    {
</div><div class='line not-covered'><span class='num'>655</span>        $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-executable'><span class='num'>656</span>            SELECT *
</div><div class='line not-executable'><span class='num'>657</span>            FROM audit
</div><div class='line not-executable'><span class='num'>658</span>            ORDER BY created_at DESC
</div><div class='line not-executable'><span class='num'>659</span>            LIMIT :limit
</div><div class='line not-executable'><span class='num'>660</span>        &quot;);
</div><div class='line not-covered'><span class='num'>661</span>        $stmt-&gt;bindValue(&#039;:limit&#039;, (int)$limit, PDO::PARAM_INT);
</div><div class='line not-covered'><span class='num'>662</span>        $stmt-&gt;execute();
</div><div class='line not-covered'><span class='num'>663</span>        $rows = $stmt-&gt;fetchAll();
</div><div class='line not-covered'><span class='num'>664</span>        return $rows;
</div><div class='line not-covered'><span class='num'>665</span>    }
</div><div class='line not-executable'><span class='num'>666</span>
</div><div class='line not-executable'><span class='num'>667</span>    public function insertAuditLog(string $entity_type, string $entity_id, string $action, ?array $old_data = null, ?array $new_data = null, string $user_id, string $ip_address): bool
</div><div class='line not-executable'><span class='num'>668</span>    {
</div><div class='line not-executable'><span class='num'>669</span>        try {
</div><div class='line covered'><span class='num'>670</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-executable'><span class='num'>671</span>                INSERT INTO audit (entity_type, entity_id, action, old_data, new_data, user_id, ip_address)
</div><div class='line not-executable'><span class='num'>672</span>                VALUES (:entity_type, :entity_id, :action, :old_data, :new_data, :user_id, :ip_address)
</div><div class='line not-executable'><span class='num'>673</span>            &quot;);
</div><div class='line not-executable'><span class='num'>674</span>
</div><div class='line covered'><span class='num'>675</span>            $stmt-&gt;execute([
</div><div class='line covered'><span class='num'>676</span>                &#039;:entity_type&#039; =&gt; $entity_type,
</div><div class='line covered'><span class='num'>677</span>                &#039;:entity_id&#039;   =&gt; $entity_id,
</div><div class='line covered'><span class='num'>678</span>                &#039;:action&#039;      =&gt; $action,
</div><div class='line not-covered'><span class='num'>679</span>                &#039;:old_data&#039;    =&gt; $old_data !== null ? json_encode($old_data, JSON_UNESCAPED_UNICODE) : null,
</div><div class='line covered'><span class='num'>680</span>                &#039;:new_data&#039;    =&gt; $new_data !== null ? json_encode($new_data, JSON_UNESCAPED_UNICODE) : null,
</div><div class='line covered'><span class='num'>681</span>                &#039;:user_id&#039;     =&gt; $user_id,
</div><div class='line covered'><span class='num'>682</span>                &#039;:ip_address&#039;  =&gt; $ip_address
</div><div class='line not-executable'><span class='num'>683</span>            ]);
</div><div class='line covered'><span class='num'>684</span>            return true;
</div><div class='line not-covered'><span class='num'>685</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>686</span>            error_log(&quot;GraphDatabase audit log insert failed: &quot; . $e-&gt;getMessage());
</div><div class='line not-covered'><span class='num'>687</span>            return false;
</div><div class='line not-executable'><span class='num'>688</span>        }
</div><div class='line not-covered'><span class='num'>689</span>    }
</div><div class='line not-executable'><span class='num'>690</span>
</div><div class='line not-executable'><span class='num'>691</span>    private function initSchema(): void
</div><div class='line not-executable'><span class='num'>692</span>    {
</div><div class='line covered'><span class='num'>693</span>        $this-&gt;pdo-&gt;exec(&quot;
</div><div class='line not-executable'><span class='num'>694</span>            CREATE TABLE IF NOT EXISTS users (
</div><div class='line not-executable'><span class='num'>695</span>                id TEXT PRIMARY KEY,
</div><div class='line not-executable'><span class='num'>696</span>                user_group TEXT NOT NULL
</div><div class='line not-executable'><span class='num'>697</span>            )
</div><div class='line not-executable'><span class='num'>698</span>        &quot;);
</div><div class='line not-executable'><span class='num'>699</span>
</div><div class='line covered'><span class='num'>700</span>        $this-&gt;pdo-&gt;exec(&quot;INSERT INTO users VALUES(&#039;admin&#039;, &#039;admin&#039;)&quot;);
</div><div class='line not-executable'><span class='num'>701</span>
</div><div class='line covered'><span class='num'>702</span>        $this-&gt;pdo-&gt;exec(&quot;
</div><div class='line not-executable'><span class='num'>703</span>            CREATE TABLE IF NOT EXISTS nodes (
</div><div class='line not-executable'><span class='num'>704</span>                id TEXT PRIMARY KEY,
</div><div class='line not-executable'><span class='num'>705</span>                label TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>706</span>                category TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>707</span>                type TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>708</span>                data TEXT NOT NULL
</div><div class='line not-executable'><span class='num'>709</span>            )
</div><div class='line not-executable'><span class='num'>710</span>        &quot;);
</div><div class='line not-executable'><span class='num'>711</span>
</div><div class='line covered'><span class='num'>712</span>        $this-&gt;pdo-&gt;exec(&quot;
</div><div class='line not-executable'><span class='num'>713</span>            CREATE TABLE IF NOT EXISTS edges (
</div><div class='line not-executable'><span class='num'>714</span>                id TEXT PRIMARY KEY,
</div><div class='line not-executable'><span class='num'>715</span>                source TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>716</span>                target TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>717</span>                data TEXT,
</div><div class='line not-executable'><span class='num'>718</span>                FOREIGN KEY (source) REFERENCES nodes(id) ON DELETE CASCADE,
</div><div class='line not-executable'><span class='num'>719</span>                FOREIGN KEY (target) REFERENCES nodes(id) ON DELETE CASCADE
</div><div class='line not-executable'><span class='num'>720</span>            )
</div><div class='line not-executable'><span class='num'>721</span>        &quot;);
</div><div class='line not-executable'><span class='num'>722</span>
</div><div class='line covered'><span class='num'>723</span>        $this-&gt;pdo-&gt;exec(&quot;CREATE UNIQUE INDEX IF NOT EXISTS idx_edges_source_target ON edges (source, target)&quot;);
</div><div class='line not-executable'><span class='num'>724</span>
</div><div class='line covered'><span class='num'>725</span>        $this-&gt;pdo-&gt;exec(&quot;
</div><div class='line not-executable'><span class='num'>726</span>            CREATE TABLE IF NOT EXISTS status (
</div><div class='line not-executable'><span class='num'>727</span>                node_id TEXT PRIMARY KEY NOT NULL,
</div><div class='line not-executable'><span class='num'>728</span>                status TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>729</span>                created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
</div><div class='line not-executable'><span class='num'>730</span>                FOREIGN KEY (node_id) REFERENCES nodes(id) ON DELETE CASCADE
</div><div class='line not-executable'><span class='num'>731</span>            )
</div><div class='line not-executable'><span class='num'>732</span>        &quot;);
</div><div class='line not-executable'><span class='num'>733</span>
</div><div class='line covered'><span class='num'>734</span>        $this-&gt;pdo-&gt;exec(&quot;CREATE INDEX IF NOT EXISTS idx_node_status_node_id ON status (node_id)&quot;);
</div><div class='line not-executable'><span class='num'>735</span>
</div><div class='line covered'><span class='num'>736</span>        $this-&gt;pdo-&gt;exec(&quot;
</div><div class='line not-executable'><span class='num'>737</span>            CREATE TABLE IF NOT EXISTS audit (
</div><div class='line not-executable'><span class='num'>738</span>                id INTEGER PRIMARY KEY AUTOINCREMENT,
</div><div class='line not-executable'><span class='num'>739</span>                entity_type TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>740</span>                entity_id TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>741</span>                action TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>742</span>                old_data TEXT,
</div><div class='line not-executable'><span class='num'>743</span>                new_data TEXT,
</div><div class='line not-executable'><span class='num'>744</span>                user_id TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>745</span>                ip_address TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>746</span>                created_at DATETIME DEFAULT CURRENT_TIMESTAMP
</div><div class='line not-executable'><span class='num'>747</span>            )
</div><div class='line not-executable'><span class='num'>748</span>        &quot;);
</div><div class='line covered'><span class='num'>749</span>    }
</div><div class='line not-executable'><span class='num'>750</span>
</div><div class='line not-executable'><span class='num'>751</span>    public static function createConnection(string $dsn): PDO
</div><div class='line not-executable'><span class='num'>752</span>    {
</div><div class='line covered'><span class='num'>753</span>        $pdo = new PDO($dsn);
</div><div class='line covered'><span class='num'>754</span>        $pdo-&gt;setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
</div><div class='line covered'><span class='num'>755</span>        $pdo-&gt;setAttribute(PDO::ATTR_DEFAULT_FETCH_MODE, PDO::FETCH_ASSOC);
</div><div class='line covered'><span class='num'>756</span>        $pdo-&gt;exec(&#039;PRAGMA foreign_keys = ON&#039;);
</div><div class='line covered'><span class='num'>757</span>        return $pdo;
</div><div class='line not-covered'><span class='num'>758</span>    }
</div><div class='line not-executable'><span class='num'>759</span>}
</div><div class='line not-executable'><span class='num'>760</span>
</div><div class='line not-executable'><span class='num'>761</span>final class GraphServiceException extends RuntimeException
</div><div class='line not-executable'><span class='num'>762</span>{
</div><div class='line not-executable'><span class='num'>763</span>}
</div><div class='line not-executable'><span class='num'>764</span>
</div><div class='line not-executable'><span class='num'>765</span>interface GraphServiceInterface
</div><div class='line not-executable'><span class='num'>766</span>{
</div><div class='line not-executable'><span class='num'>767</span>    public function getUser(string $id): ?User;
</div><div class='line not-executable'><span class='num'>768</span>    public function insertUser(User $user): void;
</div><div class='line not-executable'><span class='num'>769</span>    public function updateUser(User $user): void;
</div><div class='line not-executable'><span class='num'>770</span>
</div><div class='line not-executable'><span class='num'>771</span>    public function getGraph(): Graph;
</div><div class='line not-executable'><span class='num'>772</span>
</div><div class='line not-executable'><span class='num'>773</span>    public function getNode(string $id): ?Node;
</div><div class='line not-executable'><span class='num'>774</span>    public function getNodes(): Nodes;
</div><div class='line not-executable'><span class='num'>775</span>    public function insertNode(Node $node): void;
</div><div class='line not-executable'><span class='num'>776</span>    public function updateNode(Node $node): void;
</div><div class='line not-executable'><span class='num'>777</span>    public function deleteNode(string $id): void;
</div><div class='line not-executable'><span class='num'>778</span>
</div><div class='line not-executable'><span class='num'>779</span>    public function getEdge(string $source, string $target): ?Edge;
</div><div class='line not-executable'><span class='num'>780</span>    public function getEdges(): Edges;
</div><div class='line not-executable'><span class='num'>781</span>    public function insertEdge(Edge $edge): void;
</div><div class='line not-executable'><span class='num'>782</span>    public function updateEdge(Edge $edge): void;
</div><div class='line not-executable'><span class='num'>783</span>    public function deleteEdge(string $id): void;
</div><div class='line not-executable'><span class='num'>784</span>
</div><div class='line not-executable'><span class='num'>785</span>    public function getStatuses(): NodeStatuses;
</div><div class='line not-executable'><span class='num'>786</span>    public function getNodeStatus(string $id): NodeStatus;
</div><div class='line not-executable'><span class='num'>787</span>    public function setNodeStatus(NodeStatus $status): void;
</div><div class='line not-executable'><span class='num'>788</span>
</div><div class='line not-executable'><span class='num'>789</span>    public function getLogs($limit): AuditLogs;
</div><div class='line not-executable'><span class='num'>790</span>}
</div><div class='line not-executable'><span class='num'>791</span>
</div><div class='line not-executable'><span class='num'>792</span>final class GraphService implements GraphServiceInterface
</div><div class='line not-executable'><span class='num'>793</span>{
</div><div class='line not-executable'><span class='num'>794</span>    private const SECURE_ACTIONS = [
</div><div class='line not-executable'><span class='num'>795</span>        &#039;GraphService::getGraph&#039;      =&gt; true,
</div><div class='line not-executable'><span class='num'>796</span>        &#039;GraphService::getNode&#039;       =&gt; true,
</div><div class='line not-executable'><span class='num'>797</span>        &#039;GraphService::getNodes&#039;      =&gt; true,
</div><div class='line not-executable'><span class='num'>798</span>        &#039;GraphService::getEdge&#039;       =&gt; true,
</div><div class='line not-executable'><span class='num'>799</span>        &#039;GraphService::getEdges&#039;      =&gt; true,
</div><div class='line not-executable'><span class='num'>800</span>        &#039;GraphService::getStatuses&#039;   =&gt; true,
</div><div class='line not-executable'><span class='num'>801</span>        &#039;GraphService::getNodeStatus&#039; =&gt; true,
</div><div class='line not-executable'><span class='num'>802</span>        &#039;GraphService::setNodeStatus&#039; =&gt; true,
</div><div class='line not-executable'><span class='num'>803</span>        &#039;GraphService::getLogs&#039;       =&gt; true,
</div><div class='line not-executable'><span class='num'>804</span>        &#039;GraphService::insertNode&#039;    =&gt; false,
</div><div class='line not-executable'><span class='num'>805</span>        &#039;GraphService::updateNode&#039;    =&gt; false,
</div><div class='line not-executable'><span class='num'>806</span>        &#039;GraphService::deleteNode&#039;    =&gt; false,
</div><div class='line not-executable'><span class='num'>807</span>        &#039;GraphService::insertEdge&#039;    =&gt; false,
</div><div class='line not-executable'><span class='num'>808</span>        &#039;GraphService::updateEdge&#039;    =&gt; false,
</div><div class='line not-executable'><span class='num'>809</span>        &#039;GraphService::deleteEdge&#039;    =&gt; false,
</div><div class='line not-executable'><span class='num'>810</span>
</div><div class='line not-executable'><span class='num'>811</span>        &#039;GraphService::insertAuditLog&#039; =&gt; false,
</div><div class='line not-executable'><span class='num'>812</span>    ];
</div><div class='line not-executable'><span class='num'>813</span>
</div><div class='line not-executable'><span class='num'>814</span>    private GraphDatabaseInterface $db;
</div><div class='line not-executable'><span class='num'>815</span>    private Logger $logger;
</div><div class='line not-executable'><span class='num'>816</span>
</div><div class='line not-executable'><span class='num'>817</span>    public function __construct(GraphDatabaseInterface $db, Logger $logger)
</div><div class='line not-executable'><span class='num'>818</span>    {
</div><div class='line covered'><span class='num'>819</span>        $this-&gt;db = $db;
</div><div class='line covered'><span class='num'>820</span>        $this-&gt;logger = $logger;
</div><div class='line covered'><span class='num'>821</span>    }
</div><div class='line not-executable'><span class='num'>822</span>
</div><div class='line not-executable'><span class='num'>823</span>    public function getUser(string $id): ?User
</div><div class='line not-executable'><span class='num'>824</span>    {
</div><div class='line not-covered'><span class='num'>825</span>        $data = $this-&gt;db-&gt;getUser($id);
</div><div class='line not-covered'><span class='num'>826</span>        if ($data) {
</div><div class='line not-covered'><span class='num'>827</span>            $user = new User($id, null, $data[&#039;user_group&#039;]);
</div><div class='line not-covered'><span class='num'>828</span>            return $user;
</div><div class='line not-executable'><span class='num'>829</span>        }
</div><div class='line not-covered'><span class='num'>830</span>        return null;
</div><div class='line not-covered'><span class='num'>831</span>    }
</div><div class='line not-executable'><span class='num'>832</span>
</div><div class='line not-executable'><span class='num'>833</span>    public function insertUser(User $user): void
</div><div class='line not-executable'><span class='num'>834</span>    {
</div><div class='line not-covered'><span class='num'>835</span>        $this-&gt;db-&gt;insertUser($user-&gt;id, $user-&gt;group-&gt;id);
</div><div class='line not-covered'><span class='num'>836</span>    }
</div><div class='line not-executable'><span class='num'>837</span>
</div><div class='line not-executable'><span class='num'>838</span>    public function updateUser(User $user): void
</div><div class='line not-executable'><span class='num'>839</span>    {
</div><div class='line not-covered'><span class='num'>840</span>        $this-&gt;db-&gt;updateUser($user-&gt;id, $user-&gt;group-&gt;id);
</div><div class='line not-covered'><span class='num'>841</span>    }
</div><div class='line not-executable'><span class='num'>842</span>
</div><div class='line not-executable'><span class='num'>843</span>    public function getGraph(): Graph
</div><div class='line not-executable'><span class='num'>844</span>    {
</div><div class='line not-covered'><span class='num'>845</span>        $nodes = $this-&gt;getNodes()-&gt;nodes;
</div><div class='line not-covered'><span class='num'>846</span>        $edges = $this-&gt;getEdges()-&gt;edges;
</div><div class='line not-covered'><span class='num'>847</span>        return new Graph($nodes, $edges);
</div><div class='line not-covered'><span class='num'>848</span>    }
</div><div class='line not-executable'><span class='num'>849</span>
</div><div class='line not-executable'><span class='num'>850</span>    public function getNode(string $id): ?Node
</div><div class='line not-executable'><span class='num'>851</span>    {
</div><div class='line covered'><span class='num'>852</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>853</span>            throw new RuntimeException(&quot;Permission denied to get node.&quot;);
</div><div class='line not-executable'><span class='num'>854</span>        }
</div><div class='line not-executable'><span class='num'>855</span>
</div><div class='line covered'><span class='num'>856</span>        $data = $this-&gt;db-&gt;getNode($id);
</div><div class='line covered'><span class='num'>857</span>        if ($data) {
</div><div class='line covered'><span class='num'>858</span>            return new Node(
</div><div class='line covered'><span class='num'>859</span>                $data[&#039;id&#039;],
</div><div class='line covered'><span class='num'>860</span>                $data[&#039;label&#039;],
</div><div class='line covered'><span class='num'>861</span>                $data[&#039;category&#039;],
</div><div class='line covered'><span class='num'>862</span>                $data[&#039;type&#039;],
</div><div class='line covered'><span class='num'>863</span>                json_decode($data[&#039;data&#039;], true)
</div><div class='line not-executable'><span class='num'>864</span>            );
</div><div class='line not-executable'><span class='num'>865</span>        }
</div><div class='line not-covered'><span class='num'>866</span>        return null;
</div><div class='line not-covered'><span class='num'>867</span>    }
</div><div class='line not-executable'><span class='num'>868</span>
</div><div class='line not-executable'><span class='num'>869</span>    public function getNodes(): Nodes
</div><div class='line not-executable'><span class='num'>870</span>    {
</div><div class='line not-covered'><span class='num'>871</span>        if(! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>872</span>            throw new RuntimeException(&quot;Permission denied to get nodes.&quot;);
</div><div class='line not-executable'><span class='num'>873</span>        }
</div><div class='line not-executable'><span class='num'>874</span>
</div><div class='line not-covered'><span class='num'>875</span>        $nodesData = $this-&gt;db-&gt;getNodes();
</div><div class='line not-covered'><span class='num'>876</span>        $nodes     = new Nodes();
</div><div class='line not-covered'><span class='num'>877</span>        foreach ($nodesData as $data) {
</div><div class='line not-covered'><span class='num'>878</span>            $node = new Node(
</div><div class='line not-covered'><span class='num'>879</span>                $data[&#039;id&#039;],
</div><div class='line not-covered'><span class='num'>880</span>                $data[&#039;label&#039;],
</div><div class='line not-covered'><span class='num'>881</span>                $data[&#039;category&#039;],
</div><div class='line not-covered'><span class='num'>882</span>                $data[&#039;type&#039;],
</div><div class='line not-covered'><span class='num'>883</span>                json_decode($data[&#039;data&#039;], true)
</div><div class='line not-executable'><span class='num'>884</span>            );
</div><div class='line not-covered'><span class='num'>885</span>            $nodes-&gt;addNode($node);
</div><div class='line not-executable'><span class='num'>886</span>        }
</div><div class='line not-covered'><span class='num'>887</span>        return $nodes;
</div><div class='line not-covered'><span class='num'>888</span>    }
</div><div class='line not-executable'><span class='num'>889</span>
</div><div class='line not-executable'><span class='num'>890</span>    public function insertNode(Node $node): void
</div><div class='line not-executable'><span class='num'>891</span>    {
</div><div class='line covered'><span class='num'>892</span>        $this-&gt;logger-&gt;debug(&#039;inserting node&#039;, $node-&gt;toArray());
</div><div class='line not-executable'><span class='num'>893</span>
</div><div class='line covered'><span class='num'>894</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>895</span>            $this-&gt;logger-&gt;info(&#039;permission denied&#039;, $node-&gt;toArray());
</div><div class='line not-covered'><span class='num'>896</span>            throw new GraphServiceException(&#039;permission denied&#039;);
</div><div class='line not-executable'><span class='num'>897</span>        }
</div><div class='line not-executable'><span class='num'>898</span>
</div><div class='line covered'><span class='num'>899</span>        $this-&gt;logger-&gt;info(&#039;permission allowed&#039;, $node-&gt;toArray());
</div><div class='line not-executable'><span class='num'>900</span>
</div><div class='line covered'><span class='num'>901</span>        $this-&gt;insertAuditLog(new AuditLog( &#039;node&#039;, $node-&gt;id, &#039;insert&#039;, null, $node-&gt;toArray()));
</div><div class='line not-executable'><span class='num'>902</span>
</div><div class='line covered'><span class='num'>903</span>        $this-&gt;db-&gt;insertNode(
</div><div class='line covered'><span class='num'>904</span>            $node-&gt;id,
</div><div class='line covered'><span class='num'>905</span>            $node-&gt;label,
</div><div class='line covered'><span class='num'>906</span>            $node-&gt;category,
</div><div class='line covered'><span class='num'>907</span>            $node-&gt;type,
</div><div class='line covered'><span class='num'>908</span>            $node-&gt;data
</div><div class='line not-executable'><span class='num'>909</span>        );
</div><div class='line covered'><span class='num'>910</span>    }
</div><div class='line not-executable'><span class='num'>911</span>
</div><div class='line not-executable'><span class='num'>912</span>    public function updateNode(Node $node): void
</div><div class='line not-executable'><span class='num'>913</span>    {
</div><div class='line not-covered'><span class='num'>914</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>915</span>            throw new RuntimeException(&quot;Permission denied to update node.&quot;);
</div><div class='line not-executable'><span class='num'>916</span>        }
</div><div class='line not-executable'><span class='num'>917</span>
</div><div class='line not-covered'><span class='num'>918</span>        $old = $this-&gt;getNode($node-&gt;id);
</div><div class='line not-covered'><span class='num'>919</span>        $this-&gt;insertAuditLog(new AuditLog( &#039;node&#039;, $node-&gt;id, &#039;update&#039;, $old-&gt;toArray(), $node-&gt;toArray()));
</div><div class='line not-executable'><span class='num'>920</span>
</div><div class='line not-covered'><span class='num'>921</span>        $this-&gt;db-&gt;updateNode(
</div><div class='line not-covered'><span class='num'>922</span>            $node-&gt;id,
</div><div class='line not-covered'><span class='num'>923</span>            $node-&gt;label,
</div><div class='line not-covered'><span class='num'>924</span>            $node-&gt;category,
</div><div class='line not-covered'><span class='num'>925</span>            $node-&gt;type,
</div><div class='line not-covered'><span class='num'>926</span>            $node-&gt;data
</div><div class='line not-executable'><span class='num'>927</span>        );
</div><div class='line not-covered'><span class='num'>928</span>    }
</div><div class='line not-executable'><span class='num'>929</span>
</div><div class='line not-executable'><span class='num'>930</span>    public function deleteNode(string $id): void
</div><div class='line not-executable'><span class='num'>931</span>    {
</div><div class='line not-covered'><span class='num'>932</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>933</span>            throw new RuntimeException(&quot;Permission denied to delete node.&quot;);
</div><div class='line not-executable'><span class='num'>934</span>        }
</div><div class='line not-executable'><span class='num'>935</span>
</div><div class='line not-covered'><span class='num'>936</span>        $old = $this-&gt;getNode($id);
</div><div class='line not-covered'><span class='num'>937</span>        $this-&gt;insertAuditLog(new AuditLog( &#039;node&#039;, $id, &#039;delete&#039;, $old-&gt;toArray(), null));
</div><div class='line not-covered'><span class='num'>938</span>        $this-&gt;db-&gt;deleteNode($id);
</div><div class='line not-covered'><span class='num'>939</span>    }
</div><div class='line not-executable'><span class='num'>940</span>
</div><div class='line not-executable'><span class='num'>941</span>    public function getEdge(string $source, string $target): ?Edge
</div><div class='line not-executable'><span class='num'>942</span>    {
</div><div class='line not-covered'><span class='num'>943</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>944</span>            throw new RuntimeException(&quot;Permission denied to get edge.&quot;);
</div><div class='line not-executable'><span class='num'>945</span>        }
</div><div class='line not-executable'><span class='num'>946</span>
</div><div class='line not-covered'><span class='num'>947</span>        $edgesData = $this-&gt;db-&gt;getEdges();
</div><div class='line not-covered'><span class='num'>948</span>        foreach ($edgesData as $data) {
</div><div class='line not-covered'><span class='num'>949</span>            if ($data[&#039;source&#039;] === $source &amp;&amp; $data[&#039;target&#039;] === $target) {
</div><div class='line not-covered'><span class='num'>950</span>                return new Edge(
</div><div class='line not-covered'><span class='num'>951</span>                    $data[&#039;id&#039;],
</div><div class='line not-covered'><span class='num'>952</span>                    $data[&#039;source&#039;],
</div><div class='line not-covered'><span class='num'>953</span>                    $data[&#039;target&#039;],
</div><div class='line not-covered'><span class='num'>954</span>                    json_decode($data[&#039;data&#039;], true)
</div><div class='line not-executable'><span class='num'>955</span>                );
</div><div class='line not-executable'><span class='num'>956</span>            }
</div><div class='line not-executable'><span class='num'>957</span>        }
</div><div class='line not-covered'><span class='num'>958</span>        return null;
</div><div class='line not-covered'><span class='num'>959</span>    }
</div><div class='line not-executable'><span class='num'>960</span>
</div><div class='line not-executable'><span class='num'>961</span>    public function getEdges(): Edges
</div><div class='line not-executable'><span class='num'>962</span>    {
</div><div class='line not-covered'><span class='num'>963</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>964</span>            throw new RuntimeException(&quot;Permission denied to get edges.&quot;);
</div><div class='line not-executable'><span class='num'>965</span>        }
</div><div class='line not-covered'><span class='num'>966</span>        $edgesData = $this-&gt;db-&gt;getEdges();
</div><div class='line not-covered'><span class='num'>967</span>        $edges     = new Edges();
</div><div class='line not-covered'><span class='num'>968</span>        foreach ($edgesData as $data) {
</div><div class='line not-covered'><span class='num'>969</span>            $edge = new Edge(
</div><div class='line not-covered'><span class='num'>970</span>                $data[&#039;id&#039;],
</div><div class='line not-covered'><span class='num'>971</span>                $data[&#039;source&#039;],
</div><div class='line not-covered'><span class='num'>972</span>                $data[&#039;target&#039;],
</div><div class='line not-covered'><span class='num'>973</span>                json_decode($data[&#039;data&#039;], true)
</div><div class='line not-executable'><span class='num'>974</span>            );
</div><div class='line not-covered'><span class='num'>975</span>            $edges-&gt;addEdge($edge);
</div><div class='line not-executable'><span class='num'>976</span>        }
</div><div class='line not-covered'><span class='num'>977</span>        return $edges;
</div><div class='line not-covered'><span class='num'>978</span>    }
</div><div class='line not-executable'><span class='num'>979</span>
</div><div class='line not-executable'><span class='num'>980</span>    public function insertEdge(Edge $edge): void
</div><div class='line not-executable'><span class='num'>981</span>    {
</div><div class='line covered'><span class='num'>982</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>983</span>            throw new RuntimeException(&quot;Permission denied to insert edge.&quot;);
</div><div class='line not-executable'><span class='num'>984</span>        }
</div><div class='line covered'><span class='num'>985</span>        $this-&gt;insertAuditLog(new AuditLog( &#039;edge&#039;, $edge-&gt;id, &#039;insert&#039;, null, $edge-&gt;toArray()));
</div><div class='line covered'><span class='num'>986</span>        $this-&gt;db-&gt;insertEdge(
</div><div class='line covered'><span class='num'>987</span>            $edge-&gt;id,
</div><div class='line covered'><span class='num'>988</span>            $edge-&gt;source,
</div><div class='line covered'><span class='num'>989</span>            $edge-&gt;target,
</div><div class='line covered'><span class='num'>990</span>            $edge-&gt;data
</div><div class='line not-executable'><span class='num'>991</span>        );
</div><div class='line covered'><span class='num'>992</span>    }
</div><div class='line not-executable'><span class='num'>993</span>
</div><div class='line not-executable'><span class='num'>994</span>    public function updateEdge(Edge $edge): void
</div><div class='line not-executable'><span class='num'>995</span>    {
</div><div class='line not-covered'><span class='num'>996</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>997</span>            throw new RuntimeException(&quot;Permission denied to update edge.&quot;);
</div><div class='line not-executable'><span class='num'>998</span>        }
</div><div class='line not-covered'><span class='num'>999</span>        $old = $this-&gt;getEdge($edge-&gt;source, $edge-&gt;target);
</div><div class='line not-covered'><span class='num'>1000</span>        $this-&gt;insertAuditLog(new AuditLog( &#039;edge&#039;, $edge-&gt;id, &#039;update&#039;, $old-&gt;toArray(), $edge-&gt;toArray()));
</div><div class='line not-executable'><span class='num'>1001</span>
</div><div class='line not-covered'><span class='num'>1002</span>        $this-&gt;db-&gt;updateEdge(
</div><div class='line not-covered'><span class='num'>1003</span>            $edge-&gt;id,
</div><div class='line not-covered'><span class='num'>1004</span>            $edge-&gt;source,
</div><div class='line not-covered'><span class='num'>1005</span>            $edge-&gt;target,
</div><div class='line not-covered'><span class='num'>1006</span>            $edge-&gt;data
</div><div class='line not-executable'><span class='num'>1007</span>        );
</div><div class='line not-covered'><span class='num'>1008</span>    }
</div><div class='line not-executable'><span class='num'>1009</span>
</div><div class='line not-executable'><span class='num'>1010</span>    public function deleteEdge(string $id): void
</div><div class='line not-executable'><span class='num'>1011</span>    {
</div><div class='line not-covered'><span class='num'>1012</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>1013</span>            throw new RuntimeException(&quot;Permission denied to delete edge.&quot;);
</div><div class='line not-executable'><span class='num'>1014</span>        }
</div><div class='line not-covered'><span class='num'>1015</span>        $this-&gt;db-&gt;deleteEdge($id);
</div><div class='line not-covered'><span class='num'>1016</span>    }
</div><div class='line not-executable'><span class='num'>1017</span>
</div><div class='line not-executable'><span class='num'>1018</span>    public function getStatuses(): NodeStatuses
</div><div class='line not-executable'><span class='num'>1019</span>    {
</div><div class='line not-covered'><span class='num'>1020</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>1021</span>            throw new RuntimeException(&quot;Permission denied to get statuses.&quot;);
</div><div class='line not-executable'><span class='num'>1022</span>        }
</div><div class='line not-executable'><span class='num'>1023</span>
</div><div class='line not-covered'><span class='num'>1024</span>        $statusesData = $this-&gt;db-&gt;getStatuses();
</div><div class='line not-covered'><span class='num'>1025</span>        $nodeStatuses = new NodeStatuses();
</div><div class='line not-covered'><span class='num'>1026</span>        foreach ($statusesData as $data) {
</div><div class='line not-covered'><span class='num'>1027</span>            $status = new NodeStatus(
</div><div class='line not-covered'><span class='num'>1028</span>                $data[&#039;id&#039;],
</div><div class='line not-covered'><span class='num'>1029</span>                $data[&#039;status&#039;] ?? &#039;unknown&#039;
</div><div class='line not-executable'><span class='num'>1030</span>            );
</div><div class='line not-covered'><span class='num'>1031</span>            $nodeStatuses-&gt;addStatus($status);
</div><div class='line not-executable'><span class='num'>1032</span>        }
</div><div class='line not-covered'><span class='num'>1033</span>        return $nodeStatuses;
</div><div class='line not-covered'><span class='num'>1034</span>    }
</div><div class='line not-executable'><span class='num'>1035</span>
</div><div class='line not-executable'><span class='num'>1036</span>    public function getNodeStatus(string $id): NodeStatus
</div><div class='line not-executable'><span class='num'>1037</span>    {
</div><div class='line not-covered'><span class='num'>1038</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>1039</span>            throw new RuntimeException(&quot;Permission denied to get node status.&quot;);
</div><div class='line not-executable'><span class='num'>1040</span>        }
</div><div class='line not-executable'><span class='num'>1041</span>
</div><div class='line not-covered'><span class='num'>1042</span>        $statusData = $this-&gt;db-&gt;getNodeStatus($id);
</div><div class='line not-covered'><span class='num'>1043</span>        return new NodeStatus(
</div><div class='line not-covered'><span class='num'>1044</span>            $id,
</div><div class='line not-covered'><span class='num'>1045</span>            $statusData ?? &#039;unknown&#039;
</div><div class='line not-executable'><span class='num'>1046</span>        );
</div><div class='line not-covered'><span class='num'>1047</span>    }
</div><div class='line not-executable'><span class='num'>1048</span>
</div><div class='line not-executable'><span class='num'>1049</span>    public function setNodeStatus(NodeStatus $status): void
</div><div class='line not-executable'><span class='num'>1050</span>    {
</div><div class='line not-covered'><span class='num'>1051</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>1052</span>            throw new RuntimeException(&quot;Permission denied to set node status.&quot;);
</div><div class='line not-executable'><span class='num'>1053</span>        }
</div><div class='line not-executable'><span class='num'>1054</span>
</div><div class='line not-covered'><span class='num'>1055</span>        $this-&gt;db-&gt;setNodeStatus($status-&gt;nodeId, $status-&gt;status);
</div><div class='line not-covered'><span class='num'>1056</span>    }
</div><div class='line not-executable'><span class='num'>1057</span>
</div><div class='line not-executable'><span class='num'>1058</span>    public function getLogs($limit): AuditLogs
</div><div class='line not-executable'><span class='num'>1059</span>    {
</div><div class='line not-covered'><span class='num'>1060</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>1061</span>            throw new RuntimeException(&quot;Permission denied to get audit logs.&quot;);
</div><div class='line not-executable'><span class='num'>1062</span>        }
</div><div class='line not-executable'><span class='num'>1063</span>
</div><div class='line not-covered'><span class='num'>1064</span>        $logs = new AuditLogs();
</div><div class='line not-covered'><span class='num'>1065</span>        $rows = $this-&gt;db-&gt;getLogs($limit);
</div><div class='line not-covered'><span class='num'>1066</span>        foreach ($rows as $row) {
</div><div class='line not-covered'><span class='num'>1067</span>            $old_data = $row[&#039;old_data&#039;] ? json_decode($row[&#039;old_data&#039;], true) : [];
</div><div class='line not-covered'><span class='num'>1068</span>            $new_data = $row[&#039;new_data&#039;] ?  json_decode($row[&#039;new_data&#039;], true) : [];
</div><div class='line not-covered'><span class='num'>1069</span>            $log = new AuditLog(
</div><div class='line not-covered'><span class='num'>1070</span>                $row[&#039;entity_type&#039;],
</div><div class='line not-covered'><span class='num'>1071</span>                $row[&#039;entity_id&#039;],
</div><div class='line not-covered'><span class='num'>1072</span>                $row[&#039;action&#039;],
</div><div class='line not-executable'><span class='num'>1073</span>                $old_data,
</div><div class='line not-executable'><span class='num'>1074</span>                $new_data,
</div><div class='line not-executable'><span class='num'>1075</span>            );
</div><div class='line not-covered'><span class='num'>1076</span>            $log-&gt;userId    = $row[&#039;user_id&#039;];
</div><div class='line not-covered'><span class='num'>1077</span>            $log-&gt;ipAddress = $row[&#039;ip_address&#039;];
</div><div class='line not-covered'><span class='num'>1078</span>            $log-&gt;createdAt = $row[&#039;created_at&#039;];
</div><div class='line not-executable'><span class='num'>1079</span>
</div><div class='line not-covered'><span class='num'>1080</span>            $logs-&gt;addLog($log);
</div><div class='line not-executable'><span class='num'>1081</span>        }
</div><div class='line not-covered'><span class='num'>1082</span>        return $logs;
</div><div class='line not-covered'><span class='num'>1083</span>    }
</div><div class='line not-executable'><span class='num'>1084</span>
</div><div class='line not-executable'><span class='num'>1085</span>    private function insertAuditLog(AuditLog $auditLog): void
</div><div class='line not-executable'><span class='num'>1086</span>    {
</div><div class='line covered'><span class='num'>1087</span>        $user_id   = GraphContext::$user-&gt;id;
</div><div class='line covered'><span class='num'>1088</span>        $ip_address = GraphContext::$user-&gt;ipAddress;
</div><div class='line not-executable'><span class='num'>1089</span>
</div><div class='line covered'><span class='num'>1090</span>        $this-&gt;db-&gt;insertAuditLog(
</div><div class='line covered'><span class='num'>1091</span>            $auditLog-&gt;entityType,
</div><div class='line covered'><span class='num'>1092</span>            $auditLog-&gt;entityId,
</div><div class='line covered'><span class='num'>1093</span>            $auditLog-&gt;action,
</div><div class='line covered'><span class='num'>1094</span>            $auditLog-&gt;oldData,
</div><div class='line covered'><span class='num'>1095</span>            $auditLog-&gt;newData,
</div><div class='line not-executable'><span class='num'>1096</span>            $user_id,
</div><div class='line not-executable'><span class='num'>1097</span>            $ip_address
</div><div class='line not-executable'><span class='num'>1098</span>        );
</div><div class='line covered'><span class='num'>1099</span>    }
</div><div class='line not-executable'><span class='num'>1100</span>
</div><div class='line not-executable'><span class='num'>1101</span>    private function isAllowed(string $action): bool
</div><div class='line not-executable'><span class='num'>1102</span>    {
</div><div class='line covered'><span class='num'>1103</span>        $group = GraphContext::$user-&gt;group;
</div><div class='line not-executable'><span class='num'>1104</span>
</div><div class='line not-executable'><span class='num'>1105</span>        // validate action
</div><div class='line not-executable'><span class='num'>1106</span>        // if action is one of the keys in the array self::SECURE_ACTIONS
</div><div class='line covered'><span class='num'>1107</span>        if (!array_key_exists($action, self::SECURE_ACTIONS)) {
</div><div class='line not-covered'><span class='num'>1108</span>            throw new RuntimeException(&quot;Action not defined in secure actions. Action: {$action}&quot;);
</div><div class='line not-executable'><span class='num'>1109</span>        }
</div><div class='line not-executable'><span class='num'>1110</span>
</div><div class='line not-executable'><span class='num'>1111</span>        // if is admin, allow all
</div><div class='line covered'><span class='num'>1112</span>        if ($group-&gt;id === &#039;admin&#039;) {
</div><div class='line not-covered'><span class='num'>1113</span>            return true;
</div><div class='line not-executable'><span class='num'>1114</span>        }
</div><div class='line not-executable'><span class='num'>1115</span>
</div><div class='line not-executable'><span class='num'>1116</span>        // if action is in the SAFE_ACTIONS, allow all
</div><div class='line covered'><span class='num'>1117</span>        if (self::SECURE_ACTIONS[$action]) {
</div><div class='line covered'><span class='num'>1118</span>            return true;
</div><div class='line not-executable'><span class='num'>1119</span>        }
</div><div class='line not-executable'><span class='num'>1120</span>        
</div><div class='line not-executable'><span class='num'>1121</span>        // if action is restricted, only allow contributor
</div><div class='line covered'><span class='num'>1122</span>        if (self::SECURE_ACTIONS[$action] == false &amp;&amp; $group-&gt;id == &#039;contributor&#039;)
</div><div class='line not-executable'><span class='num'>1123</span>        {
</div><div class='line covered'><span class='num'>1124</span>            return true;
</div><div class='line not-executable'><span class='num'>1125</span>        }
</div><div class='line not-executable'><span class='num'>1126</span>
</div><div class='line not-covered'><span class='num'>1127</span>        return false;
</div><div class='line not-covered'><span class='num'>1128</span>    }
</div><div class='line not-executable'><span class='num'>1129</span>}
</div><div class='line not-executable'><span class='num'>1130</span>
</div><div class='line not-executable'><span class='num'>1131</span>final class Request
</div><div class='line not-executable'><span class='num'>1132</span>{
</div><div class='line not-executable'><span class='num'>1133</span>    public array $data;
</div><div class='line not-executable'><span class='num'>1134</span>
</div><div class='line not-executable'><span class='num'>1135</span>    public function getParam($name): string
</div><div class='line not-executable'><span class='num'>1136</span>    {
</div><div class='line covered'><span class='num'>1137</span>        if(isset($_GET[$name])) {
</div><div class='line covered'><span class='num'>1138</span>            return $_GET[$name];
</div><div class='line not-executable'><span class='num'>1139</span>        }
</div><div class='line not-executable'><span class='num'>1140</span>
</div><div class='line not-covered'><span class='num'>1141</span>        throw new RuntimeException(&quot;param &#039;{$name}&#039; not found&quot;);
</div><div class='line not-covered'><span class='num'>1142</span>    }
</div><div class='line not-executable'><span class='num'>1143</span>
</div><div class='line not-executable'><span class='num'>1144</span>    public function getPath(): string
</div><div class='line not-executable'><span class='num'>1145</span>    {
</div><div class='line not-covered'><span class='num'>1146</span>        $scriptName = $_SERVER[&#039;SCRIPT_NAME&#039;];
</div><div class='line not-covered'><span class='num'>1147</span>        $requestUri = $_SERVER[&#039;REQUEST_URI&#039;];
</div><div class='line not-covered'><span class='num'>1148</span>        $requestUri = strtok($requestUri, &#039;?&#039;);
</div><div class='line not-covered'><span class='num'>1149</span>        $path = str_replace($scriptName, &#039;&#039;, $requestUri);
</div><div class='line not-covered'><span class='num'>1150</span>        return $path;
</div><div class='line not-covered'><span class='num'>1151</span>    }
</div><div class='line not-executable'><span class='num'>1152</span>}
</div><div class='line not-executable'><span class='num'>1153</span>
</div><div class='line not-executable'><span class='num'>1154</span>interface ResponseInterface
</div><div class='line not-executable'><span class='num'>1155</span>{
</div><div class='line not-executable'><span class='num'>1156</span>    public function send(): void;
</div><div class='line not-executable'><span class='num'>1157</span>}
</div><div class='line not-executable'><span class='num'>1158</span>
</div><div class='line not-executable'><span class='num'>1159</span>class Response implements ResponseInterface
</div><div class='line not-executable'><span class='num'>1160</span>{
</div><div class='line not-executable'><span class='num'>1161</span>    public int $code;
</div><div class='line not-executable'><span class='num'>1162</span>    public string $status;
</div><div class='line not-executable'><span class='num'>1163</span>    public string $message;
</div><div class='line not-executable'><span class='num'>1164</span>    public array $data;
</div><div class='line not-executable'><span class='num'>1165</span>
</div><div class='line not-executable'><span class='num'>1166</span>    public function __construct(int $code, string $status, string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1167</span>    {
</div><div class='line covered'><span class='num'>1168</span>        $this-&gt;code = $code;
</div><div class='line covered'><span class='num'>1169</span>        $this-&gt;status = $status;
</div><div class='line covered'><span class='num'>1170</span>        $this-&gt;message = $message;
</div><div class='line covered'><span class='num'>1171</span>        $this-&gt;data = $data;
</div><div class='line covered'><span class='num'>1172</span>    }
</div><div class='line not-executable'><span class='num'>1173</span>
</div><div class='line not-executable'><span class='num'>1174</span>    public function send(): void
</div><div class='line not-executable'><span class='num'>1175</span>    {
</div><div class='line not-covered'><span class='num'>1176</span>        header(&#039;Content-Type: application/json; charset=utf-8&#039;);
</div><div class='line not-covered'><span class='num'>1177</span>        http_response_code($this-&gt;code);
</div><div class='line not-covered'><span class='num'>1178</span>        $this-&gt;data = [&#039;code&#039; =&gt; $this-&gt;code, &#039;status&#039; =&gt; $this-&gt;status, &#039;message&#039; =&gt; $this-&gt;message, &#039;data&#039; =&gt; $this-&gt;data];
</div><div class='line not-covered'><span class='num'>1179</span>        echo json_encode($this-&gt;data, JSON_UNESCAPED_UNICODE |  JSON_UNESCAPED_SLASHES |  JSON_PRETTY_PRINT);
</div><div class='line not-covered'><span class='num'>1180</span>    }
</div><div class='line not-executable'><span class='num'>1181</span>}
</div><div class='line not-executable'><span class='num'>1182</span>
</div><div class='line not-executable'><span class='num'>1183</span>class OKResponse extends Response
</div><div class='line not-executable'><span class='num'>1184</span>{
</div><div class='line not-executable'><span class='num'>1185</span>    public function __construct(string $message, array $data)
</div><div class='line not-executable'><span class='num'>1186</span>    {
</div><div class='line covered'><span class='num'>1187</span>        return parent::__construct(200, &#039;success&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1188</span>    }
</div><div class='line not-executable'><span class='num'>1189</span>}
</div><div class='line not-executable'><span class='num'>1190</span>
</div><div class='line not-executable'><span class='num'>1191</span>class CreatedResponse extends Response
</div><div class='line not-executable'><span class='num'>1192</span>{
</div><div class='line not-executable'><span class='num'>1193</span>    public function __construct(string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1194</span>    {
</div><div class='line covered'><span class='num'>1195</span>        return parent::__construct(201, &#039;success&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1196</span>    }
</div><div class='line not-executable'><span class='num'>1197</span>}
</div><div class='line not-executable'><span class='num'>1198</span>
</div><div class='line not-executable'><span class='num'>1199</span>class BadRequestResponse extends Response
</div><div class='line not-executable'><span class='num'>1200</span>{
</div><div class='line not-executable'><span class='num'>1201</span>    public function __construct(string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1202</span>    {
</div><div class='line not-covered'><span class='num'>1203</span>        return parent::__construct(400, &#039;error&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1204</span>    }
</div><div class='line not-executable'><span class='num'>1205</span>}
</div><div class='line not-executable'><span class='num'>1206</span>
</div><div class='line not-executable'><span class='num'>1207</span>class UnauthorizedResponse extends Response
</div><div class='line not-executable'><span class='num'>1208</span>{
</div><div class='line not-executable'><span class='num'>1209</span>    public function __construct(string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1210</span>    {
</div><div class='line not-covered'><span class='num'>1211</span>        return parent::__construct(401, &#039;error&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1212</span>    }
</div><div class='line not-executable'><span class='num'>1213</span>}
</div><div class='line not-executable'><span class='num'>1214</span>
</div><div class='line not-executable'><span class='num'>1215</span>class ForbiddenResponse extends Response
</div><div class='line not-executable'><span class='num'>1216</span>{
</div><div class='line not-executable'><span class='num'>1217</span>    public function __construct(string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1218</span>    {
</div><div class='line not-covered'><span class='num'>1219</span>        return parent::__construct(403, &#039;error&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1220</span>    }
</div><div class='line not-executable'><span class='num'>1221</span>}
</div><div class='line not-executable'><span class='num'>1222</span>
</div><div class='line not-executable'><span class='num'>1223</span>class NotFoundResponse extends Response
</div><div class='line not-executable'><span class='num'>1224</span>{
</div><div class='line not-executable'><span class='num'>1225</span>    public function __construct(string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1226</span>    {
</div><div class='line not-covered'><span class='num'>1227</span>        return parent::__construct(404, &#039;error&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1228</span>    }
</div><div class='line not-executable'><span class='num'>1229</span>}
</div><div class='line not-executable'><span class='num'>1230</span>
</div><div class='line not-executable'><span class='num'>1231</span>class InternalServerErrorResponse extends Response
</div><div class='line not-executable'><span class='num'>1232</span>{
</div><div class='line not-executable'><span class='num'>1233</span>    public function __construct(string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1234</span>    {
</div><div class='line not-covered'><span class='num'>1235</span>        return parent::__construct(500, &#039;error&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1236</span>    }
</div><div class='line not-executable'><span class='num'>1237</span>}
</div><div class='line not-executable'><span class='num'>1238</span>
</div><div class='line not-executable'><span class='num'>1239</span>interface GraphControllerInterface
</div><div class='line not-executable'><span class='num'>1240</span>{
</div><div class='line not-executable'><span class='num'>1241</span>    public function getUser(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1242</span>    public function insertUser(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1243</span>    public function updateUser(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1244</span>
</div><div class='line not-executable'><span class='num'>1245</span>    public function getGraph(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1246</span>
</div><div class='line not-executable'><span class='num'>1247</span>    public function getNode(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1248</span>    public function getNodes(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1249</span>    public function insertNode(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1250</span>    public function updateNode(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1251</span>    public function deleteNode(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1252</span>
</div><div class='line not-executable'><span class='num'>1253</span>    public function getEdge(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1254</span>    public function getEdges(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1255</span>    public function insertEdge(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1256</span>    public function updateEdge(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1257</span>    public function deleteEdge(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1258</span>
</div><div class='line not-executable'><span class='num'>1259</span>    public function getStatuses(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1260</span>    public function getNodeStatus(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1261</span>    public function setNodeStatus(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1262</span>
</div><div class='line not-executable'><span class='num'>1263</span>    public function getLogs(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1264</span>}
</div><div class='line not-executable'><span class='num'>1265</span>
</div><div class='line not-executable'><span class='num'>1266</span>final class GraphControllerException extends RuntimeException
</div><div class='line not-executable'><span class='num'>1267</span>{
</div><div class='line not-executable'><span class='num'>1268</span>}
</div><div class='line not-executable'><span class='num'>1269</span>
</div><div class='line not-executable'><span class='num'>1270</span>final class GraphController implements GraphControllerInterface
</div><div class='line not-executable'><span class='num'>1271</span>{
</div><div class='line not-executable'><span class='num'>1272</span>    private GraphServiceInterface $service;
</div><div class='line not-executable'><span class='num'>1273</span>    private Logger $logger;
</div><div class='line not-executable'><span class='num'>1274</span>
</div><div class='line not-executable'><span class='num'>1275</span>    public function __construct(GraphServiceInterface $service, Logger $logger)
</div><div class='line not-executable'><span class='num'>1276</span>    {
</div><div class='line covered'><span class='num'>1277</span>        $this-&gt;service = $service;
</div><div class='line covered'><span class='num'>1278</span>        $this-&gt;logger = $logger;
</div><div class='line covered'><span class='num'>1279</span>    }
</div><div class='line not-executable'><span class='num'>1280</span>
</div><div class='line not-executable'><span class='num'>1281</span>    public function getUser(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1282</span>    {
</div><div class='line not-covered'><span class='num'>1283</span>        $data = $this-&gt;service-&gt;getUser($req-&gt;data[&#039;id&#039;]);
</div><div class='line not-covered'><span class='num'>1284</span>        $user = new User($data[&#039;id&#039;], null, new Group($data[&#039;user_group&#039;]));
</div><div class='line not-covered'><span class='num'>1285</span>        return new OKResponse(&#039;user found&#039;, $user-&gt;toArray());
</div><div class='line not-covered'><span class='num'>1286</span>    }
</div><div class='line not-executable'><span class='num'>1287</span>
</div><div class='line not-executable'><span class='num'>1288</span>    public function insertUser(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1289</span>    {
</div><div class='line not-covered'><span class='num'>1290</span>        $user = new User($req-&gt;data[&#039;id&#039;], null, $req-&gt;data[&#039;user_group&#039;]);
</div><div class='line not-covered'><span class='num'>1291</span>        $this-&gt;service-&gt;insertUser($user);
</div><div class='line not-covered'><span class='num'>1292</span>        return new OKResponse(&#039;user created&#039;, $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1293</span>    }
</div><div class='line not-executable'><span class='num'>1294</span>
</div><div class='line not-executable'><span class='num'>1295</span>    public function updateUser(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1296</span>    {
</div><div class='line not-covered'><span class='num'>1297</span>        $user = new User($req-&gt;data[&#039;id&#039;], null, $req-&gt;data[&#039;user_group&#039;]);
</div><div class='line not-covered'><span class='num'>1298</span>        $this-&gt;service-&gt;updateUser($user);
</div><div class='line not-covered'><span class='num'>1299</span>        return new CreatedResponse(&#039;user updated&#039;, $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1300</span>    }
</div><div class='line not-executable'><span class='num'>1301</span>
</div><div class='line not-executable'><span class='num'>1302</span>    public function getGraph(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1303</span>    {
</div><div class='line not-executable'><span class='num'>1304</span>        try {
</div><div class='line not-covered'><span class='num'>1305</span>            $data = $this-&gt;service-&gt;getGraph()-&gt;toArray();
</div><div class='line not-covered'><span class='num'>1306</span>            return new OKResponse(&#039;get graph&#039;, $data);
</div><div class='line not-covered'><span class='num'>1307</span>            return $resp;
</div><div class='line not-covered'><span class='num'>1308</span>        } catch (Exception $e) {
</div><div class='line not-covered'><span class='num'>1309</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1310</span>        }
</div><div class='line not-executable'><span class='num'>1311</span>
</div><div class='line not-covered'><span class='num'>1312</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1313</span>    }
</div><div class='line not-executable'><span class='num'>1314</span>
</div><div class='line not-executable'><span class='num'>1315</span>    public function getNode(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1316</span>    {
</div><div class='line not-executable'><span class='num'>1317</span>        try {
</div><div class='line covered'><span class='num'>1318</span>            $id = $req-&gt;getParam(&#039;id&#039;);
</div><div class='line covered'><span class='num'>1319</span>            $node = $this-&gt;service-&gt;getNode($id);
</div><div class='line covered'><span class='num'>1320</span>            $data = $node-&gt;toArray();
</div><div class='line covered'><span class='num'>1321</span>            return new OKResponse(&#039;node found&#039;, $data);
</div><div class='line not-covered'><span class='num'>1322</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1323</span>        {
</div><div class='line not-covered'><span class='num'>1324</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1325</span>        }
</div><div class='line not-executable'><span class='num'>1326</span>
</div><div class='line not-covered'><span class='num'>1327</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1328</span>    }
</div><div class='line not-executable'><span class='num'>1329</span>
</div><div class='line not-executable'><span class='num'>1330</span>    public function getNodes(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1331</span>    {
</div><div class='line not-executable'><span class='num'>1332</span>        try {
</div><div class='line not-covered'><span class='num'>1333</span>            $nodes = $this-&gt;service-&gt;getNodes();
</div><div class='line not-executable'><span class='num'>1334</span>            // TODO: corrigir
</div><div class='line not-covered'><span class='num'>1335</span>            return new OKResponse(&#039;nodes found&#039;, []);
</div><div class='line not-covered'><span class='num'>1336</span>            return $resp;
</div><div class='line not-covered'><span class='num'>1337</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1338</span>        {
</div><div class='line not-covered'><span class='num'>1339</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1340</span>        }
</div><div class='line not-executable'><span class='num'>1341</span>        
</div><div class='line not-covered'><span class='num'>1342</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1343</span>    }
</div><div class='line not-executable'><span class='num'>1344</span>
</div><div class='line not-executable'><span class='num'>1345</span>    public function insertNode(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1346</span>    {
</div><div class='line covered'><span class='num'>1347</span>        $this-&gt;logger-&gt;debug(&#039;inserting node&#039;, $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1348</span>        try {
</div><div class='line covered'><span class='num'>1349</span>            $node = new Node($req-&gt;data[&#039;id&#039;], $req-&gt;data[&#039;label&#039;], $req-&gt;data[&#039;category&#039;], $req-&gt;data[&#039;type&#039;], $req-&gt;data[&#039;data&#039;]);
</div><div class='line covered'><span class='num'>1350</span>            $this-&gt;service-&gt;insertNode($node);
</div><div class='line covered'><span class='num'>1351</span>            $this-&gt;logger-&gt;info(&#039;node inserted&#039;, $req-&gt;data);
</div><div class='line covered'><span class='num'>1352</span>            return new CreatedResponse(&#039;node inserted&#039;, $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1353</span>        } catch( GraphServiceException $e)
</div><div class='line not-executable'><span class='num'>1354</span>        {
</div><div class='line not-covered'><span class='num'>1355</span>            $this-&gt;logger-&gt;error(&#039;The service could not insert new node:&#039; . $e-&gt;getMessage());
</div><div class='line not-covered'><span class='num'>1356</span>            throw new GraphControllerException(&#039;The service could not insert new node:&#039; . $e-&gt;getMessage(), 0, $e);
</div><div class='line not-executable'><span class='num'>1357</span>        }
</div><div class='line not-covered'><span class='num'>1358</span>        return new InternalServerErrorResponse(&#039;unknow error inserting node&#039;, $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1359</span>    }
</div><div class='line not-executable'><span class='num'>1360</span>    
</div><div class='line not-executable'><span class='num'>1361</span>    public function updateNode(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1362</span>    {
</div><div class='line covered'><span class='num'>1363</span>        $this-&gt;logger-&gt;debug(&#039;updating node&#039;, $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1364</span>
</div><div class='line not-executable'><span class='num'>1365</span>        try {
</div><div class='line covered'><span class='num'>1366</span>            $edge = new Edge($req-&gt;data[&#039;id&#039;], $req-&gt;data[&#039;category&#039;], $req-&gt;data[&#039;type&#039;], $req-&gt;data[&#039;data&#039;]);
</div><div class='line covered'><span class='num'>1367</span>            $this-&gt;service-&gt;insertEdge($edge);
</div><div class='line covered'><span class='num'>1368</span>            $this-&gt;logger-&gt;info(&#039;edge inserted&#039;, $req-&gt;data);
</div><div class='line covered'><span class='num'>1369</span>            $resp = new CreatedResponse(&#039;edge created&#039;, $req-&gt;data);
</div><div class='line covered'><span class='num'>1370</span>            return $resp;
</div><div class='line not-covered'><span class='num'>1371</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1372</span>        {
</div><div class='line not-covered'><span class='num'>1373</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1374</span>        }
</div><div class='line not-executable'><span class='num'>1375</span>        
</div><div class='line not-covered'><span class='num'>1376</span>        return new InternalServerErrorResponse(&#039;unknow todo in updateNode&#039;, $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1377</span>    }
</div><div class='line not-executable'><span class='num'>1378</span>    
</div><div class='line not-executable'><span class='num'>1379</span>    public function deleteNode(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1380</span>    {
</div><div class='line not-executable'><span class='num'>1381</span>        try {
</div><div class='line not-covered'><span class='num'>1382</span>            $this-&gt;service-&gt;deleteEdge($req-&gt;data[&#039;id&#039;]);
</div><div class='line not-covered'><span class='num'>1383</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1384</span>        {
</div><div class='line not-covered'><span class='num'>1385</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1386</span>        }
</div><div class='line not-executable'><span class='num'>1387</span>        
</div><div class='line not-covered'><span class='num'>1388</span>        return new InternalServerErrorResponse(&#039;unknow todo in deleteNode&#039;, $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1389</span>    }
</div><div class='line not-executable'><span class='num'>1390</span>
</div><div class='line not-executable'><span class='num'>1391</span>    public function getEdge(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1392</span>    {
</div><div class='line not-executable'><span class='num'>1393</span>        try {
</div><div class='line not-covered'><span class='num'>1394</span>            $edge = $this-&gt;service-&gt;getEdge($req-&gt;data[&#039;source&#039;], $req-&gt;data[&#039;target&#039;]);
</div><div class='line not-covered'><span class='num'>1395</span>            $data = $edge-&gt;toArray();
</div><div class='line not-covered'><span class='num'>1396</span>            return new OKResponse(&#039;node found&#039;, $data);
</div><div class='line not-covered'><span class='num'>1397</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1398</span>        {
</div><div class='line not-covered'><span class='num'>1399</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1400</span>        }
</div><div class='line not-executable'><span class='num'>1401</span>        
</div><div class='line not-covered'><span class='num'>1402</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1403</span>    }
</div><div class='line not-executable'><span class='num'>1404</span>    
</div><div class='line not-executable'><span class='num'>1405</span>    public function getEdges(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1406</span>    {
</div><div class='line not-executable'><span class='num'>1407</span>        try {
</div><div class='line not-covered'><span class='num'>1408</span>            $edges = $this-&gt;service-&gt;getEdges();
</div><div class='line not-executable'><span class='num'>1409</span>            // TODO: corrigir
</div><div class='line not-covered'><span class='num'>1410</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1411</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1412</span>        {
</div><div class='line not-covered'><span class='num'>1413</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1414</span>        }
</div><div class='line not-executable'><span class='num'>1415</span>        
</div><div class='line not-covered'><span class='num'>1416</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1417</span>    }
</div><div class='line not-executable'><span class='num'>1418</span>    
</div><div class='line not-executable'><span class='num'>1419</span>    public function insertEdge(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1420</span>    {
</div><div class='line not-executable'><span class='num'>1421</span>        try {
</div><div class='line not-covered'><span class='num'>1422</span>            $edge = new Edge(null, $req-&gt;data[&#039;source&#039;], $req-&gt;data[&#039;target&#039;]);
</div><div class='line not-covered'><span class='num'>1423</span>            $this-&gt;service-&gt;insertEdge($edge);
</div><div class='line not-covered'><span class='num'>1424</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1425</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1426</span>        {
</div><div class='line not-covered'><span class='num'>1427</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1428</span>        }
</div><div class='line not-executable'><span class='num'>1429</span>        
</div><div class='line not-covered'><span class='num'>1430</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1431</span>    }
</div><div class='line not-executable'><span class='num'>1432</span>    
</div><div class='line not-executable'><span class='num'>1433</span>    public function updateEdge(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1434</span>    {
</div><div class='line not-executable'><span class='num'>1435</span>        try {
</div><div class='line not-covered'><span class='num'>1436</span>            $edge = new Edge($req-&gt;data[&#039;id&#039;], $req-&gt;data[&#039;source&#039;], $req-&gt;data[&#039;target&#039;], $req-&gt;data[&#039;data&#039;]);
</div><div class='line not-covered'><span class='num'>1437</span>            $this-&gt;service-&gt;updateEdge($edge);
</div><div class='line not-covered'><span class='num'>1438</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1439</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1440</span>        {
</div><div class='line not-covered'><span class='num'>1441</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1442</span>        }
</div><div class='line not-executable'><span class='num'>1443</span>        
</div><div class='line not-covered'><span class='num'>1444</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1445</span>    }
</div><div class='line not-executable'><span class='num'>1446</span>    
</div><div class='line not-executable'><span class='num'>1447</span>    public function deleteEdge(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1448</span>    {
</div><div class='line not-executable'><span class='num'>1449</span>        try {
</div><div class='line not-covered'><span class='num'>1450</span>            $id = $req-&gt;data[&#039;id&#039;];
</div><div class='line not-covered'><span class='num'>1451</span>            $this-&gt;service-&gt;deleteEdge($id);
</div><div class='line not-covered'><span class='num'>1452</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1453</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1454</span>        {
</div><div class='line not-covered'><span class='num'>1455</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1456</span>        }
</div><div class='line not-executable'><span class='num'>1457</span>        
</div><div class='line not-covered'><span class='num'>1458</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1459</span>    }
</div><div class='line not-executable'><span class='num'>1460</span>
</div><div class='line not-executable'><span class='num'>1461</span>    public function getStatuses(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1462</span>    {
</div><div class='line not-executable'><span class='num'>1463</span>        try {
</div><div class='line not-covered'><span class='num'>1464</span>            $statuses = $this-&gt;service-&gt;getStatuses();
</div><div class='line not-covered'><span class='num'>1465</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1466</span>            return $resp;
</div><div class='line not-covered'><span class='num'>1467</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1468</span>        {
</div><div class='line not-covered'><span class='num'>1469</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1470</span>        }
</div><div class='line not-executable'><span class='num'>1471</span>        
</div><div class='line not-covered'><span class='num'>1472</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1473</span>    }
</div><div class='line not-executable'><span class='num'>1474</span>    
</div><div class='line not-executable'><span class='num'>1475</span>    public function getNodeStatus(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1476</span>    {
</div><div class='line not-executable'><span class='num'>1477</span>        try {
</div><div class='line not-covered'><span class='num'>1478</span>            $status = $this-&gt;service-&gt;getNodeStatus($req-&gt;data[&#039;id&#039;]);
</div><div class='line not-covered'><span class='num'>1479</span>            $data = $status-&gt;toArray();
</div><div class='line not-covered'><span class='num'>1480</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1481</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1482</span>        {
</div><div class='line not-covered'><span class='num'>1483</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1484</span>        }
</div><div class='line not-executable'><span class='num'>1485</span>        
</div><div class='line not-covered'><span class='num'>1486</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1487</span>    }
</div><div class='line not-executable'><span class='num'>1488</span>    
</div><div class='line not-executable'><span class='num'>1489</span>    public function setNodeStatus(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1490</span>    {
</div><div class='line not-executable'><span class='num'>1491</span>        try {
</div><div class='line not-covered'><span class='num'>1492</span>            $status = new NodeStatus($req-&gt;data[&#039;node_id&#039;], $req-&gt;data[&#039;status&#039;]);
</div><div class='line not-covered'><span class='num'>1493</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1494</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1495</span>        {
</div><div class='line not-covered'><span class='num'>1496</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1497</span>        }
</div><div class='line not-executable'><span class='num'>1498</span>        
</div><div class='line not-covered'><span class='num'>1499</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1500</span>    }
</div><div class='line not-executable'><span class='num'>1501</span>
</div><div class='line not-executable'><span class='num'>1502</span>    public function getLogs(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1503</span>    {
</div><div class='line not-executable'><span class='num'>1504</span>        try {
</div><div class='line not-covered'><span class='num'>1505</span>            $logs = $this-&gt;service-&gt;getLogs($req-&gt;getParam(&#039;limit&#039;));
</div><div class='line not-covered'><span class='num'>1506</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1507</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1508</span>        {
</div><div class='line not-covered'><span class='num'>1509</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1510</span>        }
</div><div class='line not-executable'><span class='num'>1511</span>        
</div><div class='line not-covered'><span class='num'>1512</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1513</span>    }
</div><div class='line not-executable'><span class='num'>1514</span>}
</div><div class='line not-executable'><span class='num'>1515</span>
</div><div class='line not-executable'><span class='num'>1516</span>final class RequestRouter
</div><div class='line not-executable'><span class='num'>1517</span>{
</div><div class='line not-executable'><span class='num'>1518</span>    private $routes = [
</div><div class='line not-executable'><span class='num'>1519</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getGraph&#039;, &#039;class_method&#039; =&gt; &#039;getGraph&#039;],
</div><div class='line not-executable'><span class='num'>1520</span>        
</div><div class='line not-executable'><span class='num'>1521</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getNode&#039;, &#039;class_method&#039; =&gt; &#039;getNode&#039;],
</div><div class='line not-executable'><span class='num'>1522</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getNodes&#039;, &#039;class_method&#039; =&gt; &#039;getNodes&#039;],
</div><div class='line not-executable'><span class='num'>1523</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/insertNode&#039;, &#039;class_method&#039; =&gt; &#039;insertNode&#039;],
</div><div class='line not-executable'><span class='num'>1524</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/updateNode&#039;, &#039;class_method&#039; =&gt; &#039;updateNode&#039;],
</div><div class='line not-executable'><span class='num'>1525</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/deleteNode&#039;, &#039;class_method&#039; =&gt; &#039;deleteNode&#039;],
</div><div class='line not-executable'><span class='num'>1526</span>
</div><div class='line not-executable'><span class='num'>1527</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getEdge&#039;, &#039;class_method&#039; =&gt; &#039;getEdge&#039;],
</div><div class='line not-executable'><span class='num'>1528</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getEdges&#039;, &#039;class_method&#039; =&gt; &#039;getEdges&#039;],
</div><div class='line not-executable'><span class='num'>1529</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/insertEdge&#039;, &#039;class_method&#039; =&gt; &#039;insertEdge&#039;],
</div><div class='line not-executable'><span class='num'>1530</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/updateEdge&#039;, &#039;class_method&#039; =&gt; &#039;updateEdge&#039;],
</div><div class='line not-executable'><span class='num'>1531</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/deleteEdge&#039;, &#039;class_method&#039; =&gt; &#039;deleteEdge&#039;],
</div><div class='line not-executable'><span class='num'>1532</span>
</div><div class='line not-executable'><span class='num'>1533</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getStatuses&#039;, &#039;class_method&#039; =&gt; &#039;getStatuses&#039;],
</div><div class='line not-executable'><span class='num'>1534</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getNodeStatus&#039;, &#039;class_method&#039; =&gt; &#039;getNodeStatus&#039;],
</div><div class='line not-executable'><span class='num'>1535</span>
</div><div class='line not-executable'><span class='num'>1536</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getLogs&#039;, &#039;class_method&#039; =&gt; &#039;getLogs&#039;],
</div><div class='line not-executable'><span class='num'>1537</span>
</div><div class='line not-executable'><span class='num'>1538</span>        ];
</div><div class='line not-executable'><span class='num'>1539</span>
</div><div class='line not-executable'><span class='num'>1540</span>    public GraphController $controller;
</div><div class='line not-executable'><span class='num'>1541</span>    
</div><div class='line not-executable'><span class='num'>1542</span>    public function __construct(GraphController $controller)
</div><div class='line not-executable'><span class='num'>1543</span>    {
</div><div class='line not-covered'><span class='num'>1544</span>        $this-&gt;controller = $controller;
</div><div class='line not-covered'><span class='num'>1545</span>    }
</div><div class='line not-executable'><span class='num'>1546</span>
</div><div class='line not-executable'><span class='num'>1547</span>    public function handle(): void
</div><div class='line not-executable'><span class='num'>1548</span>    {
</div><div class='line not-covered'><span class='num'>1549</span>        $method = $_SERVER[&#039;REQUEST_METHOD&#039;];
</div><div class='line not-executable'><span class='num'>1550</span>
</div><div class='line not-covered'><span class='num'>1551</span>        $scriptName = $_SERVER[&#039;SCRIPT_NAME&#039;];
</div><div class='line not-covered'><span class='num'>1552</span>        $requestUri = $_SERVER[&#039;REQUEST_URI&#039;];
</div><div class='line not-covered'><span class='num'>1553</span>        $requestUri = strtok($requestUri, &#039;?&#039;);
</div><div class='line not-executable'><span class='num'>1554</span>        
</div><div class='line not-covered'><span class='num'>1555</span>        $path = str_replace($scriptName, &#039;&#039;, $requestUri);
</div><div class='line not-executable'><span class='num'>1556</span>        
</div><div class='line not-covered'><span class='num'>1557</span>        $req = new Request();
</div><div class='line not-executable'><span class='num'>1558</span>
</div><div class='line not-covered'><span class='num'>1559</span>        foreach($this-&gt;routes as $route)
</div><div class='line not-executable'><span class='num'>1560</span>        {
</div><div class='line not-covered'><span class='num'>1561</span>            if ($route[&#039;method&#039;] == $method &amp;&amp; $route[&#039;path&#039;] == $path)
</div><div class='line not-executable'><span class='num'>1562</span>            {
</div><div class='line not-covered'><span class='num'>1563</span>                $method = $route[&#039;class_method&#039;];
</div><div class='line not-covered'><span class='num'>1564</span>                $resp = $this-&gt;controller-&gt;$method($req);
</div><div class='line not-covered'><span class='num'>1565</span>                print_r($resp);
</div><div class='line not-covered'><span class='num'>1566</span>                exit();
</div><div class='line not-executable'><span class='num'>1567</span>            }
</div><div class='line not-executable'><span class='num'>1568</span>        }
</div><div class='line not-covered'><span class='num'>1569</span>    }
</div><div class='line not-executable'><span class='num'>1570</span>}
</div><div class='line not-executable'><span class='num'>1571</span>
</div><div class='line not-executable'><span class='num'>1572</span>
</div></body></html><html><head><meta charset='UTF-8'><style>
body { font-family: monospace; font-size: 12px; background: #222; color: #ddd; margin: 0; }
.covered { background: #1a4d1a; }
.not-covered { background: #4d1a1a; }
.not-executable { background: #2a2a2a; color: #666; }
.line { padding: 2px 10px; white-space: pre; border-left: 3px solid transparent; }
.covered { border-left-color: #0f0; }
.not-covered { border-left-color: #f00; }
.num { color: #666; width: 50px; display: inline-block; text-align: right; margin-right: 10px; }
h2 { background: #333; padding: 10px; margin: 20px 0 0 0; position: sticky; top: 0; }
</style></head><body><h2>/home/tarcisio/projects/graph/tests.php - 77.05% (47/61)</h2><div class='line not-executable'><span class='num'>1</span>&lt;?php
</div><div class='line not-executable'><span class='num'>2</span>
</div><div class='line not-executable'><span class='num'>3</span>declare(strict_types=1);
</div><div class='line not-executable'><span class='num'>4</span>
</div><div class='line not-executable'><span class='num'>5</span>require_once __DIR__ . &#039;/graph.php&#039;;
</div><div class='line not-executable'><span class='num'>6</span>
</div><div class='line not-executable'><span class='num'>7</span>ini_set(&#039;xdebug.mode&#039;, &#039;1&#039;);
</div><div class='line not-executable'><span class='num'>8</span>xdebug_start_code_coverage(XDEBUG_CC_UNUSED | XDEBUG_CC_DEAD_CODE);
</div><div class='line not-executable'><span class='num'>9</span>
</div><div class='line not-executable'><span class='num'>10</span>function array_diff_recursive($array1, $array2) {
</div><div class='line covered'><span class='num'>11</span>    $diff = [];
</div><div class='line not-executable'><span class='num'>12</span>    
</div><div class='line covered'><span class='num'>13</span>    foreach ($array1 as $key =&gt; $value) {
</div><div class='line covered'><span class='num'>14</span>        if (!array_key_exists($key, $array2)) {
</div><div class='line not-covered'><span class='num'>15</span>            $diff[$key] = $value;
</div><div class='line covered'><span class='num'>16</span>        } elseif (is_array($value)) {
</div><div class='line covered'><span class='num'>17</span>            if (!is_array($array2[$key])) {
</div><div class='line not-covered'><span class='num'>18</span>                $diff[$key] = $value;
</div><div class='line not-executable'><span class='num'>19</span>            } else {
</div><div class='line covered'><span class='num'>20</span>                $recursiveDiff = array_diff_recursive($value, $array2[$key]);
</div><div class='line covered'><span class='num'>21</span>                if (count($recursiveDiff)) {
</div><div class='line not-covered'><span class='num'>22</span>                    $diff[$key] = $recursiveDiff;
</div><div class='line not-executable'><span class='num'>23</span>                }
</div><div class='line not-executable'><span class='num'>24</span>            }
</div><div class='line covered'><span class='num'>25</span>        } elseif ($value !== $array2[$key]) {
</div><div class='line not-covered'><span class='num'>26</span>            $diff[$key] = $value;
</div><div class='line not-executable'><span class='num'>27</span>        }
</div><div class='line not-executable'><span class='num'>28</span>    }
</div><div class='line not-executable'><span class='num'>29</span>    
</div><div class='line covered'><span class='num'>30</span>    return $diff;
</div><div class='line not-covered'><span class='num'>31</span>}
</div><div class='line not-executable'><span class='num'>32</span>
</div><div class='line not-executable'><span class='num'>33</span>function get_test_graph_controller()
</div><div class='line not-executable'><span class='num'>34</span>{
</div><div class='line covered'><span class='num'>35</span>    GraphContext::$user = new User(&#039;test_user&#039;, &#039;127.0.0.1&#039;, new Group(&#039;contributor&#039;));
</div><div class='line covered'><span class='num'>36</span>    $pdo = GraphDatabase::createConnection(&#039;sqlite::memory:&#039;);
</div><div class='line covered'><span class='num'>37</span>    $databaseLogger = new Logger(&#039;database.log&#039;);
</div><div class='line not-executable'><span class='num'>38</span>
</div><div class='line covered'><span class='num'>39</span>    $graphDb = new GraphDatabase($pdo, $databaseLogger);
</div><div class='line not-executable'><span class='num'>40</span>
</div><div class='line covered'><span class='num'>41</span>    $serviceLogger = new Logger(&#039;service.log&#039;);
</div><div class='line covered'><span class='num'>42</span>    $graphService = new GraphService($graphDb, $serviceLogger);
</div><div class='line not-executable'><span class='num'>43</span>
</div><div class='line covered'><span class='num'>44</span>    $controllerLogger = new Logger(&#039;controller.log&#039;);
</div><div class='line covered'><span class='num'>45</span>    $graphController = new GraphController($graphService, $controllerLogger);
</div><div class='line not-executable'><span class='num'>46</span>    
</div><div class='line covered'><span class='num'>47</span>    return $graphController;
</div><div class='line not-covered'><span class='num'>48</span>}
</div><div class='line not-executable'><span class='num'>49</span>
</div><div class='line not-executable'><span class='num'>50</span>function test_node_good_path()
</div><div class='line not-executable'><span class='num'>51</span>{
</div><div class='line covered'><span class='num'>52</span>    $graphController = get_test_graph_controller();
</div><div class='line covered'><span class='num'>53</span>    $insertNodeReq = new Request();
</div><div class='line covered'><span class='num'>54</span>    $insertNodeReq-&gt;data = [&#039;id&#039; =&gt; &#039;node1&#039;, &#039;label&#039; =&gt; &#039;node1&#039;, &#039;category&#039; =&gt; &#039;business&#039;, &#039;type&#039; =&gt; &#039;server&#039;, &#039;data&#039; =&gt; [&#039;info&#039; =&gt; &#039;first node&#039;]];
</div><div class='line covered'><span class='num'>55</span>    $resp = $graphController-&gt;insertNode($insertNodeReq);
</div><div class='line not-executable'><span class='num'>56</span>    
</div><div class='line covered'><span class='num'>57</span>    $expected = [
</div><div class='line not-executable'><span class='num'>58</span>        &#039;id&#039;       =&gt; &#039;node1&#039;,
</div><div class='line not-executable'><span class='num'>59</span>        &#039;label&#039;    =&gt; &#039;node1&#039;,
</div><div class='line not-executable'><span class='num'>60</span>        &#039;category&#039; =&gt; &#039;business&#039;,
</div><div class='line not-executable'><span class='num'>61</span>        &#039;type&#039; =&gt; &#039;server&#039;,
</div><div class='line not-executable'><span class='num'>62</span>        &#039;data&#039; =&gt; [
</div><div class='line not-executable'><span class='num'>63</span>                &#039;info&#039; =&gt; &#039;first node&#039;
</div><div class='line not-executable'><span class='num'>64</span>        ]
</div><div class='line not-executable'><span class='num'>65</span>    ];
</div><div class='line not-executable'><span class='num'>66</span>
</div><div class='line covered'><span class='num'>67</span>    if($resp-&gt;code != 201) {
</div><div class='line not-covered'><span class='num'>68</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>69</span>    }
</div><div class='line not-executable'><span class='num'>70</span>
</div><div class='line covered'><span class='num'>71</span>    if($resp-&gt;status != &#039;success&#039;) {
</div><div class='line not-covered'><span class='num'>72</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>73</span>    }
</div><div class='line not-executable'><span class='num'>74</span>
</div><div class='line covered'><span class='num'>75</span>    if ($resp-&gt;message != &#039;node inserted&#039;) {
</div><div class='line not-covered'><span class='num'>76</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>77</span>    }
</div><div class='line not-executable'><span class='num'>78</span>
</div><div class='line covered'><span class='num'>79</span>    $diff = array_diff_recursive($resp-&gt;data, $expected);
</div><div class='line covered'><span class='num'>80</span>    if (! empty($diff)) {
</div><div class='line not-covered'><span class='num'>81</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>82</span>    }
</div><div class='line not-executable'><span class='num'>83</span>
</div><div class='line covered'><span class='num'>84</span>    $_GET[&#039;id&#039;] = &#039;node1&#039;;
</div><div class='line covered'><span class='num'>85</span>    $req = new Request();
</div><div class='line covered'><span class='num'>86</span>    $resp = $graphController-&gt;getNode($req);
</div><div class='line not-executable'><span class='num'>87</span>
</div><div class='line covered'><span class='num'>88</span>    if ($resp-&gt;code != 200) {
</div><div class='line not-covered'><span class='num'>89</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>90</span>    }
</div><div class='line not-executable'><span class='num'>91</span>
</div><div class='line covered'><span class='num'>92</span>    if($resp-&gt;status != &#039;success&#039;) {
</div><div class='line not-covered'><span class='num'>93</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>94</span>    }
</div><div class='line not-executable'><span class='num'>95</span>
</div><div class='line covered'><span class='num'>96</span>    if ($resp-&gt;message != &#039;node found&#039;) {
</div><div class='line not-covered'><span class='num'>97</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>98</span>    }
</div><div class='line not-executable'><span class='num'>99</span>
</div><div class='line covered'><span class='num'>100</span>    $expected = [
</div><div class='line not-executable'><span class='num'>101</span>        &#039;info&#039;     =&gt; &#039;first node&#039;,
</div><div class='line not-executable'><span class='num'>102</span>        &#039;id&#039;       =&gt; &#039;node1&#039;,
</div><div class='line not-executable'><span class='num'>103</span>        &#039;label&#039;    =&gt; &#039;node1&#039;,
</div><div class='line not-executable'><span class='num'>104</span>        &#039;category&#039; =&gt; &#039;business&#039;,
</div><div class='line not-executable'><span class='num'>105</span>        &#039;type&#039;     =&gt; &#039;server&#039;,
</div><div class='line not-executable'><span class='num'>106</span>    ];
</div><div class='line not-executable'><span class='num'>107</span>
</div><div class='line covered'><span class='num'>108</span>    $diff = array_diff_recursive($resp-&gt;data[&#039;data&#039;], $expected);
</div><div class='line covered'><span class='num'>109</span>    if (! empty($diff)) {
</div><div class='line not-covered'><span class='num'>110</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>111</span>    }
</div><div class='line not-executable'><span class='num'>112</span>    
</div><div class='line covered'><span class='num'>113</span>    $req = new Request();
</div><div class='line covered'><span class='num'>114</span>    $req-&gt;data = [
</div><div class='line not-executable'><span class='num'>115</span>        &#039;id&#039;       =&gt; &#039;node1&#039;,
</div><div class='line not-executable'><span class='num'>116</span>        &#039;label&#039;    =&gt; &#039;node1&#039;,
</div><div class='line not-executable'><span class='num'>117</span>        &#039;category&#039; =&gt; &#039;business&#039;,
</div><div class='line not-executable'><span class='num'>118</span>        &#039;type&#039; =&gt; &#039;server&#039;,
</div><div class='line not-executable'><span class='num'>119</span>        &#039;data&#039; =&gt; [
</div><div class='line not-executable'><span class='num'>120</span>                &#039;info&#039; =&gt; &#039;first node updated&#039;
</div><div class='line not-executable'><span class='num'>121</span>        ]
</div><div class='line not-executable'><span class='num'>122</span>    ];
</div><div class='line covered'><span class='num'>123</span>    $resp = $graphController-&gt;updateNode($req);
</div><div class='line covered'><span class='num'>124</span>    print_r($resp);
</div><div class='line covered'><span class='num'>125</span>}
</div><div class='line not-executable'><span class='num'>126</span>
</div><div class='line not-executable'><span class='num'>127</span>function tests() {
</div><div class='line covered'><span class='num'>128</span>    test_node_good_path();
</div><div class='line covered'><span class='num'>129</span>    echo &quot;fim&quot;;
</div><div class='line covered'><span class='num'>130</span>}
</div><div class='line not-executable'><span class='num'>131</span>
</div><div class='line covered'><span class='num'>132</span>tests();
</div><div class='line not-executable'><span class='num'>133</span>
</div><div class='line covered'><span class='num'>134</span>$coverage = xdebug_get_code_coverage();
</div><div class='line not-executable'><span class='num'>135</span>xdebug_stop_code_coverage();
</div><div class='line not-executable'><span class='num'>136</span>
</div><div class='line not-executable'><span class='num'>137</span>// Salvar em arquivo
</div><div class='line not-executable'><span class='num'>138</span>file_put_contents(&#039;coverage.json&#039;, json_encode($coverage, JSON_PRETTY_PRINT));
</div><div class='line not-executable'><span class='num'>139</span>
</div><div class='line not-executable'><span class='num'>140</span>echo &#039;fim&#039;;</div><h2>/home/tarcisio/projects/graph/graph.php - 30.66% (195/636)</h2><div class='line not-executable'><span class='num'>1</span>&lt;?php
</div><div class='line not-executable'><span class='num'>2</span>
</div><div class='line not-executable'><span class='num'>3</span>declare(strict_types=1);
</div><div class='line not-executable'><span class='num'>4</span>
</div><div class='line not-executable'><span class='num'>5</span>final class User
</div><div class='line not-executable'><span class='num'>6</span>{
</div><div class='line not-executable'><span class='num'>7</span>    public string $id;
</div><div class='line not-executable'><span class='num'>8</span>    public ?string $ipAddress;
</div><div class='line not-executable'><span class='num'>9</span>    public Group $group;
</div><div class='line not-executable'><span class='num'>10</span>
</div><div class='line not-executable'><span class='num'>11</span>    public function __construct(string $id, ?string $ipAddress, Group $group)
</div><div class='line not-executable'><span class='num'>12</span>    {
</div><div class='line covered'><span class='num'>13</span>        $this-&gt;id = $id;
</div><div class='line covered'><span class='num'>14</span>        $this-&gt;ipAddress = $ipAddress;
</div><div class='line covered'><span class='num'>15</span>        $this-&gt;group = $group;
</div><div class='line covered'><span class='num'>16</span>    }
</div><div class='line not-executable'><span class='num'>17</span>
</div><div class='line not-executable'><span class='num'>18</span>    public function toArray(): array
</div><div class='line not-executable'><span class='num'>19</span>    {
</div><div class='line not-executable'><span class='num'>20</span>        return [
</div><div class='line not-covered'><span class='num'>21</span>            &#039;id&#039; =&gt; $this-&gt;id,
</div><div class='line not-executable'><span class='num'>22</span>            &#039;group&#039; =&gt; [
</div><div class='line not-covered'><span class='num'>23</span>                &#039;id&#039; =&gt; $this-&gt;group-&gt;id,
</div><div class='line not-executable'><span class='num'>24</span>            ],
</div><div class='line not-executable'><span class='num'>25</span>        ];
</div><div class='line not-covered'><span class='num'>26</span>    }
</div><div class='line not-executable'><span class='num'>27</span>}
</div><div class='line not-executable'><span class='num'>28</span>
</div><div class='line not-executable'><span class='num'>29</span>final class Group
</div><div class='line not-executable'><span class='num'>30</span>{
</div><div class='line not-executable'><span class='num'>31</span>    private const ALLOWED_GROUPS = [&#039;anonymous&#039;, &#039;consumer&#039;, &#039;contributor&#039;, &#039;admin&#039;];
</div><div class='line not-executable'><span class='num'>32</span>    
</div><div class='line not-executable'><span class='num'>33</span>    public string $id;
</div><div class='line not-executable'><span class='num'>34</span>    
</div><div class='line not-executable'><span class='num'>35</span>    public function __construct(string $id)
</div><div class='line not-executable'><span class='num'>36</span>    {
</div><div class='line covered'><span class='num'>37</span>        if (!in_array($id, self::ALLOWED_GROUPS, true)) {
</div><div class='line not-covered'><span class='num'>38</span>            throw new InvalidArgumentException(&quot;Invalid user group: {$id}&quot;);
</div><div class='line not-executable'><span class='num'>39</span>        }
</div><div class='line covered'><span class='num'>40</span>        $this-&gt;id  = $id;
</div><div class='line covered'><span class='num'>41</span>    }
</div><div class='line not-executable'><span class='num'>42</span>}
</div><div class='line not-executable'><span class='num'>43</span>
</div><div class='line not-executable'><span class='num'>44</span>final class Graph
</div><div class='line not-executable'><span class='num'>45</span>{
</div><div class='line not-executable'><span class='num'>46</span>    public array $nodes = [];
</div><div class='line not-executable'><span class='num'>47</span>    public array $edges = [];
</div><div class='line not-executable'><span class='num'>48</span>    public array $data  = [];
</div><div class='line not-executable'><span class='num'>49</span>    public array $layout = [];
</div><div class='line not-executable'><span class='num'>50</span>    public array $styles = [];
</div><div class='line not-executable'><span class='num'>51</span>
</div><div class='line not-executable'><span class='num'>52</span>    public function __construct(array $nodes, array $edges)
</div><div class='line not-executable'><span class='num'>53</span>    {
</div><div class='line not-covered'><span class='num'>54</span>        $this-&gt;nodes = $nodes;
</div><div class='line not-covered'><span class='num'>55</span>        $this-&gt;edges = $edges;
</div><div class='line not-covered'><span class='num'>56</span>    }
</div><div class='line not-executable'><span class='num'>57</span>
</div><div class='line not-executable'><span class='num'>58</span>    public function toArray(): array
</div><div class='line not-executable'><span class='num'>59</span>    {
</div><div class='line not-executable'><span class='num'>60</span>        return [
</div><div class='line not-covered'><span class='num'>61</span>            &#039;nodes&#039; =&gt; $this-&gt;nodes,
</div><div class='line not-covered'><span class='num'>62</span>            &#039;edges&#039; =&gt; $this-&gt;edges,
</div><div class='line not-covered'><span class='num'>63</span>            &#039;data&#039; =&gt; $this-&gt;data,
</div><div class='line not-covered'><span class='num'>64</span>            &#039;layout&#039; =&gt; $this-&gt;layout,
</div><div class='line not-covered'><span class='num'>65</span>            &#039;styles&#039; =&gt; $this-&gt;styles,
</div><div class='line not-executable'><span class='num'>66</span>        ];
</div><div class='line not-covered'><span class='num'>67</span>    }
</div><div class='line not-executable'><span class='num'>68</span>}
</div><div class='line not-executable'><span class='num'>69</span>
</div><div class='line not-executable'><span class='num'>70</span>final class Node
</div><div class='line not-executable'><span class='num'>71</span>{
</div><div class='line not-executable'><span class='num'>72</span>    private const ALLOWED_CATEGORIES  = [&#039;business&#039;, &#039;application&#039;, &#039;infrastructure&#039;];
</div><div class='line not-executable'><span class='num'>73</span>    private const ALLOWED_TYPES       = [&#039;server&#039;, &#039;database&#039;, &#039;application&#039;, &#039;network&#039;];
</div><div class='line not-executable'><span class='num'>74</span>    private const ID_VALIDATION_REGEX = &#039;/^[a-zA-Z0-9\-_]+$/&#039;;
</div><div class='line not-executable'><span class='num'>75</span>    private const LABEL_MAX_LENGTH    = 20;
</div><div class='line not-executable'><span class='num'>76</span>    
</div><div class='line not-executable'><span class='num'>77</span>    public string $id;
</div><div class='line not-executable'><span class='num'>78</span>    public string $label;
</div><div class='line not-executable'><span class='num'>79</span>    public string $category;
</div><div class='line not-executable'><span class='num'>80</span>    public string $type;
</div><div class='line not-executable'><span class='num'>81</span>
</div><div class='line not-executable'><span class='num'>82</span>    public array $data = [];
</div><div class='line not-executable'><span class='num'>83</span>
</div><div class='line not-executable'><span class='num'>84</span>    public function __construct(string $id, string $label, string $category, string $type, array $data)
</div><div class='line not-executable'><span class='num'>85</span>    {
</div><div class='line covered'><span class='num'>86</span>        $this-&gt;validate($id, $label, $category, $type);
</div><div class='line covered'><span class='num'>87</span>        $this-&gt;id       = $id;
</div><div class='line covered'><span class='num'>88</span>        $this-&gt;label    = $label;
</div><div class='line covered'><span class='num'>89</span>        $this-&gt;category = $category;
</div><div class='line covered'><span class='num'>90</span>        $this-&gt;type     = $type;
</div><div class='line covered'><span class='num'>91</span>        $this-&gt;data     = $data;
</div><div class='line covered'><span class='num'>92</span>    }
</div><div class='line not-executable'><span class='num'>93</span>
</div><div class='line not-executable'><span class='num'>94</span>    private function validate(string $id, string $label, string $category, string $type): void
</div><div class='line not-executable'><span class='num'>95</span>    {
</div><div class='line covered'><span class='num'>96</span>        if (!preg_match(self::ID_VALIDATION_REGEX, $id)) {
</div><div class='line not-covered'><span class='num'>97</span>            throw new InvalidArgumentException(&quot;Invalid node ID: {$id}&quot;);
</div><div class='line not-executable'><span class='num'>98</span>        }
</div><div class='line not-executable'><span class='num'>99</span>
</div><div class='line covered'><span class='num'>100</span>        if (strlen($label) &gt; self::LABEL_MAX_LENGTH) {
</div><div class='line not-covered'><span class='num'>101</span>            throw new InvalidArgumentException(&quot;Node label exceeds maximum length of &quot; . self::LABEL_MAX_LENGTH);
</div><div class='line not-executable'><span class='num'>102</span>        }
</div><div class='line not-executable'><span class='num'>103</span>
</div><div class='line covered'><span class='num'>104</span>        if (!in_array($category, self::ALLOWED_CATEGORIES, true)) {
</div><div class='line not-covered'><span class='num'>105</span>            throw new InvalidArgumentException(&quot;Invalid node category: {$category}&quot;);
</div><div class='line not-executable'><span class='num'>106</span>        }
</div><div class='line not-executable'><span class='num'>107</span>
</div><div class='line covered'><span class='num'>108</span>        if (!in_array($type, self::ALLOWED_TYPES, true)) {
</div><div class='line not-covered'><span class='num'>109</span>            throw new InvalidArgumentException(&quot;Invalid node type: {$type}&quot;);
</div><div class='line not-executable'><span class='num'>110</span>        }
</div><div class='line covered'><span class='num'>111</span>    }
</div><div class='line not-executable'><span class='num'>112</span>
</div><div class='line not-executable'><span class='num'>113</span>    public function toArray(): array
</div><div class='line not-executable'><span class='num'>114</span>    {
</div><div class='line not-executable'><span class='num'>115</span>        return [
</div><div class='line covered'><span class='num'>116</span>            &#039;id&#039;       =&gt; $this-&gt;id,
</div><div class='line covered'><span class='num'>117</span>            &#039;label&#039;    =&gt; $this-&gt;label,
</div><div class='line covered'><span class='num'>118</span>            &#039;category&#039; =&gt; $this-&gt;category,
</div><div class='line covered'><span class='num'>119</span>            &#039;type&#039;     =&gt; $this-&gt;type,
</div><div class='line covered'><span class='num'>120</span>            &#039;data&#039;     =&gt; $this-&gt;data
</div><div class='line not-executable'><span class='num'>121</span>        ];
</div><div class='line not-covered'><span class='num'>122</span>    }
</div><div class='line not-executable'><span class='num'>123</span>}
</div><div class='line not-executable'><span class='num'>124</span>
</div><div class='line not-executable'><span class='num'>125</span>final class NodeStatus
</div><div class='line not-executable'><span class='num'>126</span>{
</div><div class='line not-executable'><span class='num'>127</span>    private const ALLOWED_NODE_STATUSES = [&#039;unknown&#039;, &#039;healthy&#039;, &#039;unhealthy&#039;, &#039;maintenance&#039;];
</div><div class='line not-executable'><span class='num'>128</span>
</div><div class='line not-executable'><span class='num'>129</span>    public string $nodeId;
</div><div class='line not-executable'><span class='num'>130</span>    public string $status;
</div><div class='line not-executable'><span class='num'>131</span>
</div><div class='line not-executable'><span class='num'>132</span>    public function __construct(string $nodeId, string $status)
</div><div class='line not-executable'><span class='num'>133</span>    {
</div><div class='line not-covered'><span class='num'>134</span>        if (!in_array($status, self::ALLOWED_NODE_STATUSES, true)) {
</div><div class='line not-covered'><span class='num'>135</span>            throw new InvalidArgumentException(&quot;Invalid node status: {$status}&quot;);
</div><div class='line not-executable'><span class='num'>136</span>        }
</div><div class='line not-covered'><span class='num'>137</span>        $this-&gt;nodeId = $nodeId;
</div><div class='line not-covered'><span class='num'>138</span>        $this-&gt;status = $status;
</div><div class='line not-covered'><span class='num'>139</span>    }
</div><div class='line not-executable'><span class='num'>140</span>
</div><div class='line not-executable'><span class='num'>141</span>    public function toArray(): array
</div><div class='line not-executable'><span class='num'>142</span>    {
</div><div class='line not-executable'><span class='num'>143</span>        return [
</div><div class='line not-covered'><span class='num'>144</span>            &#039;node_id&#039; =&gt; $this-&gt;nodeId,
</div><div class='line not-covered'><span class='num'>145</span>            &#039;status&#039;  =&gt; $this-&gt;status,
</div><div class='line not-executable'><span class='num'>146</span>        ];
</div><div class='line not-covered'><span class='num'>147</span>    }
</div><div class='line not-executable'><span class='num'>148</span>}
</div><div class='line not-executable'><span class='num'>149</span>
</div><div class='line not-executable'><span class='num'>150</span>final class NodeStatuses
</div><div class='line not-executable'><span class='num'>151</span>{
</div><div class='line not-executable'><span class='num'>152</span>    public array $statuses = [];
</div><div class='line not-executable'><span class='num'>153</span>
</div><div class='line not-executable'><span class='num'>154</span>    public function addStatus(NodeStatus $status): void
</div><div class='line not-executable'><span class='num'>155</span>    {
</div><div class='line not-covered'><span class='num'>156</span>        $this-&gt;statuses[] = $status;
</div><div class='line not-covered'><span class='num'>157</span>    }
</div><div class='line not-executable'><span class='num'>158</span>}
</div><div class='line not-executable'><span class='num'>159</span>
</div><div class='line not-executable'><span class='num'>160</span>final class Nodes
</div><div class='line not-executable'><span class='num'>161</span>{
</div><div class='line not-executable'><span class='num'>162</span>    public array $nodes = [];
</div><div class='line not-executable'><span class='num'>163</span>
</div><div class='line not-executable'><span class='num'>164</span>    public function addNode(Node $node): void
</div><div class='line not-executable'><span class='num'>165</span>    {
</div><div class='line not-covered'><span class='num'>166</span>        $this-&gt;nodes[] = $node;
</div><div class='line not-covered'><span class='num'>167</span>    }
</div><div class='line not-executable'><span class='num'>168</span>}
</div><div class='line not-executable'><span class='num'>169</span>
</div><div class='line not-executable'><span class='num'>170</span>final class Edge
</div><div class='line not-executable'><span class='num'>171</span>{
</div><div class='line not-executable'><span class='num'>172</span>    public ?string $id;
</div><div class='line not-executable'><span class='num'>173</span>    public string $source;
</div><div class='line not-executable'><span class='num'>174</span>    public string $target;
</div><div class='line not-executable'><span class='num'>175</span>    public array $data;
</div><div class='line not-executable'><span class='num'>176</span>
</div><div class='line not-executable'><span class='num'>177</span>    public function __construct(?string $id = null, string $source, string $target, array $data = [])
</div><div class='line not-executable'><span class='num'>178</span>    {
</div><div class='line covered'><span class='num'>179</span>        $this-&gt;id     = $id;
</div><div class='line covered'><span class='num'>180</span>        $this-&gt;source = $source;
</div><div class='line covered'><span class='num'>181</span>        $this-&gt;target = $target;
</div><div class='line covered'><span class='num'>182</span>        $this-&gt;data   = $data;
</div><div class='line covered'><span class='num'>183</span>    }
</div><div class='line not-executable'><span class='num'>184</span>
</div><div class='line not-executable'><span class='num'>185</span>    public function toArray(): array
</div><div class='line not-executable'><span class='num'>186</span>    {
</div><div class='line not-executable'><span class='num'>187</span>        return [
</div><div class='line covered'><span class='num'>188</span>            &#039;id&#039;     =&gt; $this-&gt;id,
</div><div class='line covered'><span class='num'>189</span>            &#039;source&#039; =&gt; $this-&gt;source,
</div><div class='line covered'><span class='num'>190</span>            &#039;target&#039; =&gt; $this-&gt;target,
</div><div class='line covered'><span class='num'>191</span>            &#039;data&#039;   =&gt; $this-&gt;data
</div><div class='line not-executable'><span class='num'>192</span>        ];
</div><div class='line not-covered'><span class='num'>193</span>    }
</div><div class='line not-executable'><span class='num'>194</span>}
</div><div class='line not-executable'><span class='num'>195</span>
</div><div class='line not-executable'><span class='num'>196</span>final class Edges
</div><div class='line not-executable'><span class='num'>197</span>{
</div><div class='line not-executable'><span class='num'>198</span>    public array $edges = [];
</div><div class='line not-executable'><span class='num'>199</span>    public function addEdge(Edge $edge): void
</div><div class='line not-executable'><span class='num'>200</span>    {
</div><div class='line not-covered'><span class='num'>201</span>        $this-&gt;edges[] = $edge;
</div><div class='line not-covered'><span class='num'>202</span>    }
</div><div class='line not-executable'><span class='num'>203</span>}
</div><div class='line not-executable'><span class='num'>204</span>
</div><div class='line not-executable'><span class='num'>205</span>final class AuditLog
</div><div class='line not-executable'><span class='num'>206</span>{
</div><div class='line not-executable'><span class='num'>207</span>    public string $entityType;
</div><div class='line not-executable'><span class='num'>208</span>    public string $entityId;
</div><div class='line not-executable'><span class='num'>209</span>    public string $action;
</div><div class='line not-executable'><span class='num'>210</span>    public ?array $oldData;
</div><div class='line not-executable'><span class='num'>211</span>    public ?array $newData;
</div><div class='line not-executable'><span class='num'>212</span>    public string $userId;
</div><div class='line not-executable'><span class='num'>213</span>    public string $ipAddress;
</div><div class='line not-executable'><span class='num'>214</span>    public string $createdAt;
</div><div class='line not-executable'><span class='num'>215</span>
</div><div class='line not-executable'><span class='num'>216</span>    public function __construct(string $entityType, string $entityId, string $action, ?array $oldData = null, ?array $newData = null)
</div><div class='line not-executable'><span class='num'>217</span>    {
</div><div class='line covered'><span class='num'>218</span>        $this-&gt;entityType = $entityType;
</div><div class='line covered'><span class='num'>219</span>        $this-&gt;entityId   = $entityId;
</div><div class='line covered'><span class='num'>220</span>        $this-&gt;action     = $action;
</div><div class='line covered'><span class='num'>221</span>        $this-&gt;oldData    = $oldData;
</div><div class='line covered'><span class='num'>222</span>        $this-&gt;newData    = $newData;
</div><div class='line covered'><span class='num'>223</span>    }
</div><div class='line not-executable'><span class='num'>224</span>}
</div><div class='line not-executable'><span class='num'>225</span>
</div><div class='line not-executable'><span class='num'>226</span>final class AuditLogs
</div><div class='line not-executable'><span class='num'>227</span>{
</div><div class='line not-executable'><span class='num'>228</span>    public array $logs = [];
</div><div class='line not-executable'><span class='num'>229</span>    public function addLog(AuditLog $log): void
</div><div class='line not-executable'><span class='num'>230</span>    {
</div><div class='line not-covered'><span class='num'>231</span>        $this-&gt;logs[] = $log;
</div><div class='line not-covered'><span class='num'>232</span>    }
</div><div class='line not-executable'><span class='num'>233</span>}
</div><div class='line not-executable'><span class='num'>234</span>
</div><div class='line not-executable'><span class='num'>235</span>final class GraphContext
</div><div class='line not-executable'><span class='num'>236</span>{
</div><div class='line not-executable'><span class='num'>237</span>    public static User $user;
</div><div class='line not-executable'><span class='num'>238</span>}
</div><div class='line not-executable'><span class='num'>239</span>
</div><div class='line not-executable'><span class='num'>240</span>interface LoggerInterface
</div><div class='line not-executable'><span class='num'>241</span>{
</div><div class='line not-executable'><span class='num'>242</span>    public function info(string $message, array $data = []): void;
</div><div class='line not-executable'><span class='num'>243</span>    public function debug(string $message, array $data = []): void;
</div><div class='line not-executable'><span class='num'>244</span>    public function error(string $message, array $data = []): void;
</div><div class='line not-executable'><span class='num'>245</span>}
</div><div class='line not-executable'><span class='num'>246</span>
</div><div class='line not-executable'><span class='num'>247</span>final class Logger implements LoggerInterface
</div><div class='line not-executable'><span class='num'>248</span>{
</div><div class='line not-executable'><span class='num'>249</span>    private string $fileName;
</div><div class='line not-executable'><span class='num'>250</span>    private $fd;
</div><div class='line not-executable'><span class='num'>251</span>
</div><div class='line not-executable'><span class='num'>252</span>    public function __construct($file_name)
</div><div class='line not-executable'><span class='num'>253</span>    {
</div><div class='line covered'><span class='num'>254</span>        $this-&gt;fileName = $file_name;
</div><div class='line covered'><span class='num'>255</span>        $this-&gt;fd = fopen($this-&gt;fileName, &#039;a&#039;);
</div><div class='line covered'><span class='num'>256</span>    }
</div><div class='line not-executable'><span class='num'>257</span>
</div><div class='line not-executable'><span class='num'>258</span>    public function info(string $message, array $data = []): void
</div><div class='line not-executable'><span class='num'>259</span>    {
</div><div class='line covered'><span class='num'>260</span>        $this-&gt;log(&#039;INFO&#039;, $message, $data);
</div><div class='line covered'><span class='num'>261</span>    }
</div><div class='line not-executable'><span class='num'>262</span>
</div><div class='line not-executable'><span class='num'>263</span>    public function debug(string $message, array $data = []): void
</div><div class='line not-executable'><span class='num'>264</span>    {
</div><div class='line covered'><span class='num'>265</span>        $this-&gt;log(&#039;DEBUG&#039;, $message, $data);
</div><div class='line covered'><span class='num'>266</span>    }
</div><div class='line not-executable'><span class='num'>267</span>
</div><div class='line not-executable'><span class='num'>268</span>    public function error(string $message, array $data = []): void
</div><div class='line not-executable'><span class='num'>269</span>    {
</div><div class='line not-covered'><span class='num'>270</span>        $this-&gt;log(&#039;ERROR&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>271</span>    }
</div><div class='line not-executable'><span class='num'>272</span>
</div><div class='line not-executable'><span class='num'>273</span>    private function log(string $type, $message, $data = [])
</div><div class='line not-executable'><span class='num'>274</span>    {
</div><div class='line covered'><span class='num'>275</span>        $trace = debug_backtrace(DEBUG_BACKTRACE_PROVIDE_OBJECT, 3);
</div><div class='line covered'><span class='num'>276</span>        $method = &quot;{$trace[2][&#039;class&#039;]}::{$trace[2][&#039;function&#039;]}&quot;;
</div><div class='line covered'><span class='num'>277</span>        $data = json_encode($data);
</div><div class='line covered'><span class='num'>278</span>        $message = &quot;[{$type}] {$method}: $message ($data)\n&quot;;
</div><div class='line covered'><span class='num'>279</span>        fwrite($this-&gt;fd, $message);
</div><div class='line covered'><span class='num'>280</span>    }
</div><div class='line not-executable'><span class='num'>281</span>}
</div><div class='line not-executable'><span class='num'>282</span>
</div><div class='line not-executable'><span class='num'>283</span>interface GraphDatabaseInterface
</div><div class='line not-executable'><span class='num'>284</span>{
</div><div class='line not-executable'><span class='num'>285</span>    public function getUser(string $id): ?array;
</div><div class='line not-executable'><span class='num'>286</span>    public function insertUser(string $id, string $group): void;
</div><div class='line not-executable'><span class='num'>287</span>    public function updateUser(string $id, string $group): void;
</div><div class='line not-executable'><span class='num'>288</span>
</div><div class='line not-executable'><span class='num'>289</span>    public function getNode(string $id): ?array;
</div><div class='line not-executable'><span class='num'>290</span>    public function getNodes(): array;
</div><div class='line not-executable'><span class='num'>291</span>    public function insertNode(string $id, string $label, string $category, string $type, array $data = []): void;
</div><div class='line not-executable'><span class='num'>292</span>    public function updateNode(string $id, string $label, string $category, string $type, array $data = []): void;
</div><div class='line not-executable'><span class='num'>293</span>    public function deleteNode(string $id): void;
</div><div class='line not-executable'><span class='num'>294</span>
</div><div class='line not-executable'><span class='num'>295</span>    public function getEdge(string $source, string $target): ?array;
</div><div class='line not-executable'><span class='num'>296</span>    public function getEdgeById(string $id): ?array;
</div><div class='line not-executable'><span class='num'>297</span>    public function getEdges(): array;
</div><div class='line not-executable'><span class='num'>298</span>    public function insertEdge(string $id, string $source, string $target, array $data = []): void;
</div><div class='line not-executable'><span class='num'>299</span>    public function updateEdge(string $id, string $source, string $target, array $data = []): void;
</div><div class='line not-executable'><span class='num'>300</span>    public function deleteEdge(string $id): void;
</div><div class='line not-executable'><span class='num'>301</span>
</div><div class='line not-executable'><span class='num'>302</span>    public function getStatuses(): array;
</div><div class='line not-executable'><span class='num'>303</span>    public function getNodeStatus(string $id): ?string;
</div><div class='line not-executable'><span class='num'>304</span>    public function setNodeStatus(string $id, string $status): void;
</div><div class='line not-executable'><span class='num'>305</span>
</div><div class='line not-executable'><span class='num'>306</span>    public function getLogs($limit): array;
</div><div class='line not-executable'><span class='num'>307</span>    public function insertAuditLog(
</div><div class='line not-executable'><span class='num'>308</span>        string $entity_type, 
</div><div class='line not-executable'><span class='num'>309</span>        string $entity_id, 
</div><div class='line not-executable'><span class='num'>310</span>        string $action, 
</div><div class='line not-executable'><span class='num'>311</span>        ?array $old_data = null, 
</div><div class='line not-executable'><span class='num'>312</span>        ?array $new_data = null,
</div><div class='line not-executable'><span class='num'>313</span>        string $user_id,
</div><div class='line not-executable'><span class='num'>314</span>        string $ip_address): bool;
</div><div class='line not-executable'><span class='num'>315</span>}
</div><div class='line not-executable'><span class='num'>316</span>
</div><div class='line not-executable'><span class='num'>317</span>final class DatabaseException extends RuntimeException
</div><div class='line not-executable'><span class='num'>318</span>{
</div><div class='line not-executable'><span class='num'>319</span>    private ?string $query;
</div><div class='line not-executable'><span class='num'>320</span>    private ?array $params;
</div><div class='line not-executable'><span class='num'>321</span>
</div><div class='line not-executable'><span class='num'>322</span>    
</div><div class='line not-executable'><span class='num'>323</span>    public function __construct(string $message = &quot;&quot;,  int $code = 0, ?Throwable $previous = null, ?string $query = null, ?array $params) {
</div><div class='line not-covered'><span class='num'>324</span>        parent::__construct($message, $code, $previous);
</div><div class='line not-covered'><span class='num'>325</span>        $this-&gt;query = $query;
</div><div class='line not-covered'><span class='num'>326</span>        $this-&gt;params = $params;
</div><div class='line not-covered'><span class='num'>327</span>    }
</div><div class='line not-executable'><span class='num'>328</span>}
</div><div class='line not-executable'><span class='num'>329</span>
</div><div class='line not-executable'><span class='num'>330</span>final class GraphDatabase implements GraphDatabaseInterface
</div><div class='line not-executable'><span class='num'>331</span>{
</div><div class='line not-executable'><span class='num'>332</span>    private PDO $pdo;
</div><div class='line not-executable'><span class='num'>333</span>    private Logger $logger;
</div><div class='line not-executable'><span class='num'>334</span>
</div><div class='line not-executable'><span class='num'>335</span>    public function __construct(PDO $pdo, Logger $logger)
</div><div class='line not-executable'><span class='num'>336</span>    {
</div><div class='line covered'><span class='num'>337</span>        $this-&gt;pdo = $pdo;
</div><div class='line covered'><span class='num'>338</span>        $this-&gt;logger = $logger;
</div><div class='line covered'><span class='num'>339</span>        $this-&gt;initSchema();
</div><div class='line covered'><span class='num'>340</span>    }
</div><div class='line not-executable'><span class='num'>341</span>
</div><div class='line not-executable'><span class='num'>342</span>    public function getUser(string $id): ?array
</div><div class='line not-executable'><span class='num'>343</span>    {
</div><div class='line not-covered'><span class='num'>344</span>        $this-&gt;logger-&gt;debug(&quot;getting user id: &#039;{$id}&#039;&quot;);
</div><div class='line not-executable'><span class='num'>345</span>        try {
</div><div class='line not-covered'><span class='num'>346</span>            $sql = &quot;SELECT * FROM users WHERE id = :id&quot;;
</div><div class='line not-covered'><span class='num'>347</span>            $params = [&#039;:id&#039; =&gt; $id];
</div><div class='line not-covered'><span class='num'>348</span>            $stmt = $this-&gt;pdo-&gt;prepare($sql);
</div><div class='line not-covered'><span class='num'>349</span>            $stmt-&gt;execute($params);
</div><div class='line not-covered'><span class='num'>350</span>            $row = $stmt-&gt;fetch();
</div><div class='line not-executable'><span class='num'>351</span>
</div><div class='line not-covered'><span class='num'>352</span>            if ($row) {
</div><div class='line not-covered'><span class='num'>353</span>                return $row;
</div><div class='line not-executable'><span class='num'>354</span>            }
</div><div class='line not-covered'><span class='num'>355</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>356</span>            $e = new DatabaseException(
</div><div class='line not-covered'><span class='num'>357</span>                &quot;GraphDatabase Exception while trying to get user data. ID: {$id}&quot;,
</div><div class='line not-covered'><span class='num'>358</span>                0,
</div><div class='line not-executable'><span class='num'>359</span>                $e,
</div><div class='line not-executable'><span class='num'>360</span>                $sql,
</div><div class='line not-executable'><span class='num'>361</span>                $params
</div><div class='line not-executable'><span class='num'>362</span>            );
</div><div class='line not-executable'><span class='num'>363</span>        }
</div><div class='line not-covered'><span class='num'>364</span>        return null;
</div><div class='line not-covered'><span class='num'>365</span>    }
</div><div class='line not-executable'><span class='num'>366</span>
</div><div class='line not-executable'><span class='num'>367</span>    public function insertUser(string $id, string $group): void
</div><div class='line not-executable'><span class='num'>368</span>    {
</div><div class='line not-executable'><span class='num'>369</span>        try {
</div><div class='line not-covered'><span class='num'>370</span>            $sql = &quot;
</div><div class='line not-executable'><span class='num'>371</span>                INSERT OR IGNORE INTO users 
</div><div class='line not-executable'><span class='num'>372</span>                (id, user_group)
</div><div class='line not-executable'><span class='num'>373</span>                VALUES (:id, :group)&quot;;
</div><div class='line not-executable'><span class='num'>374</span>            
</div><div class='line not-covered'><span class='num'>375</span>            $params = [
</div><div class='line not-covered'><span class='num'>376</span>                &#039;:id&#039;       =&gt; $id,
</div><div class='line not-covered'><span class='num'>377</span>                &#039;:group&#039;    =&gt; $group
</div><div class='line not-executable'><span class='num'>378</span>            ];
</div><div class='line not-executable'><span class='num'>379</span>
</div><div class='line not-covered'><span class='num'>380</span>            $stmt = $this-&gt;pdo-&gt;prepare($sql);
</div><div class='line not-covered'><span class='num'>381</span>            $stmt-&gt;execute($params);
</div><div class='line not-covered'><span class='num'>382</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>383</span>            $e = new DatabaseException(
</div><div class='line not-covered'><span class='num'>384</span>                &quot;GraphDatabase Exception while trying to insert new user. ID: {$id}&quot;,
</div><div class='line not-covered'><span class='num'>385</span>                0,
</div><div class='line not-executable'><span class='num'>386</span>                $e,
</div><div class='line not-executable'><span class='num'>387</span>                $sql,
</div><div class='line not-executable'><span class='num'>388</span>                $params
</div><div class='line not-executable'><span class='num'>389</span>            );
</div><div class='line not-executable'><span class='num'>390</span>        }
</div><div class='line not-covered'><span class='num'>391</span>    }
</div><div class='line not-executable'><span class='num'>392</span>
</div><div class='line not-executable'><span class='num'>393</span>    public function updateUser(string $id, string $group): void
</div><div class='line not-executable'><span class='num'>394</span>    {
</div><div class='line not-executable'><span class='num'>395</span>        try {
</div><div class='line not-covered'><span class='num'>396</span>            $sql = &quot;
</div><div class='line not-executable'><span class='num'>397</span>                UPDATE users
</div><div class='line not-executable'><span class='num'>398</span>                SET    user_group = :group
</div><div class='line not-executable'><span class='num'>399</span>                WHERE  id = :id
</div><div class='line not-executable'><span class='num'>400</span>            &quot;;
</div><div class='line not-executable'><span class='num'>401</span>
</div><div class='line not-covered'><span class='num'>402</span>            $params = [
</div><div class='line not-covered'><span class='num'>403</span>                &#039;:id&#039;       =&gt; $id,
</div><div class='line not-covered'><span class='num'>404</span>                &#039;:group&#039;    =&gt; $group
</div><div class='line not-executable'><span class='num'>405</span>            ];
</div><div class='line not-executable'><span class='num'>406</span>
</div><div class='line not-covered'><span class='num'>407</span>            $stmt = $this-&gt;pdo-&gt;prepare($sql);
</div><div class='line not-executable'><span class='num'>408</span>            
</div><div class='line not-covered'><span class='num'>409</span>            $stmt-&gt;execute($params);
</div><div class='line not-executable'><span class='num'>410</span>
</div><div class='line not-covered'><span class='num'>411</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>412</span>            $e = new DatabaseException(
</div><div class='line not-covered'><span class='num'>413</span>                &quot;GraphDatabase Exception while trying to update user. ID: {$id}&quot;,
</div><div class='line not-covered'><span class='num'>414</span>                0,
</div><div class='line not-executable'><span class='num'>415</span>                $e,
</div><div class='line not-executable'><span class='num'>416</span>                $sql,
</div><div class='line not-executable'><span class='num'>417</span>                $params
</div><div class='line not-executable'><span class='num'>418</span>            );
</div><div class='line not-executable'><span class='num'>419</span>        }
</div><div class='line not-covered'><span class='num'>420</span>    }
</div><div class='line not-executable'><span class='num'>421</span>
</div><div class='line not-executable'><span class='num'>422</span>    public function getNode(string $id): ?array
</div><div class='line not-executable'><span class='num'>423</span>    {
</div><div class='line covered'><span class='num'>424</span>        $this-&gt;logger-&gt;debug(&quot;fetching node &#039;{$id}&#039;&quot;);
</div><div class='line not-executable'><span class='num'>425</span>
</div><div class='line not-executable'><span class='num'>426</span>        try {
</div><div class='line covered'><span class='num'>427</span>            $sql = &quot;SELECT * FROM nodes WHERE id = :id&quot;;
</div><div class='line covered'><span class='num'>428</span>            $params = [&#039;:id&#039; =&gt; $id];
</div><div class='line covered'><span class='num'>429</span>            $stmt = $this-&gt;pdo-&gt;prepare($sql);
</div><div class='line covered'><span class='num'>430</span>            $stmt-&gt;execute($params);
</div><div class='line covered'><span class='num'>431</span>            $row = $stmt-&gt;fetch();
</div><div class='line covered'><span class='num'>432</span>            if ($row) {
</div><div class='line covered'><span class='num'>433</span>                return $row;
</div><div class='line not-executable'><span class='num'>434</span>            }
</div><div class='line not-covered'><span class='num'>435</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>436</span>            $this-&gt;logger-&gt;error(&quot;exception with node id &#039;{$id}&#039;&quot;);
</div><div class='line not-covered'><span class='num'>437</span>            throw new DatabaseException(&quot;could not get node data with id &#039;{$id}&#039;&quot;, 0, $e, $sql, $params);
</div><div class='line not-executable'><span class='num'>438</span>        }
</div><div class='line not-covered'><span class='num'>439</span>        return null;
</div><div class='line not-covered'><span class='num'>440</span>    }
</div><div class='line not-executable'><span class='num'>441</span>
</div><div class='line not-executable'><span class='num'>442</span>    public function getNodes(): array
</div><div class='line not-executable'><span class='num'>443</span>    {
</div><div class='line not-executable'><span class='num'>444</span>        try {
</div><div class='line not-covered'><span class='num'>445</span>            $stmt = $this-&gt;pdo-&gt;query(&quot;SELECT * FROM nodes&quot;);
</div><div class='line not-covered'><span class='num'>446</span>            $rows = $stmt-&gt;fetchAll();
</div><div class='line not-covered'><span class='num'>447</span>            return $rows;
</div><div class='line not-covered'><span class='num'>448</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>449</span>            error_log(&quot;GraphDatabase fetch all nodes failed: &quot; . $e-&gt;getMessage());
</div><div class='line not-covered'><span class='num'>450</span>            return [];
</div><div class='line not-executable'><span class='num'>451</span>        }
</div><div class='line not-covered'><span class='num'>452</span>    }
</div><div class='line not-executable'><span class='num'>453</span>
</div><div class='line not-executable'><span class='num'>454</span>    public function insertNode(string $id, string $label, string $category, string $type, array $data = []): void
</div><div class='line not-executable'><span class='num'>455</span>    {
</div><div class='line not-executable'><span class='num'>456</span>        try {
</div><div class='line covered'><span class='num'>457</span>            $sql = &quot;
</div><div class='line not-executable'><span class='num'>458</span>                INSERT OR IGNORE INTO nodes 
</div><div class='line not-executable'><span class='num'>459</span>                (id, label, category, type, data) 
</div><div class='line not-executable'><span class='num'>460</span>                VALUES (:id, :label, :category, :type, :data)&quot;;
</div><div class='line covered'><span class='num'>461</span>            $stmt             = $this-&gt;pdo-&gt;prepare($sql);
</div><div class='line covered'><span class='num'>462</span>            $data[&#039;id&#039;]       = $id;
</div><div class='line covered'><span class='num'>463</span>            $data[&#039;label&#039;]    = $label;
</div><div class='line covered'><span class='num'>464</span>            $data[&#039;category&#039;] = $category;
</div><div class='line covered'><span class='num'>465</span>            $data[&#039;type&#039;]     = $type;
</div><div class='line covered'><span class='num'>466</span>            $stmt-&gt;execute([
</div><div class='line covered'><span class='num'>467</span>                &#039;:id&#039;       =&gt; $id,
</div><div class='line covered'><span class='num'>468</span>                &#039;:label&#039;    =&gt; $label,
</div><div class='line covered'><span class='num'>469</span>                &#039;:category&#039; =&gt; $category,
</div><div class='line covered'><span class='num'>470</span>                &#039;:type&#039;     =&gt; $type,
</div><div class='line covered'><span class='num'>471</span>                &#039;:data&#039;     =&gt; json_encode($data, JSON_UNESCAPED_UNICODE)
</div><div class='line not-executable'><span class='num'>472</span>            ]);
</div><div class='line not-covered'><span class='num'>473</span>        } catch (PDOException $e) {
</div><div class='line not-executable'><span class='num'>474</span>            // TODO
</div><div class='line not-executable'><span class='num'>475</span>        }
</div><div class='line covered'><span class='num'>476</span>    }
</div><div class='line not-executable'><span class='num'>477</span>
</div><div class='line not-executable'><span class='num'>478</span>    public function updateNode(string $id, string $label, string $category, string $type, array $data = []): void
</div><div class='line not-executable'><span class='num'>479</span>    {
</div><div class='line not-executable'><span class='num'>480</span>        try {
</div><div class='line not-covered'><span class='num'>481</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-executable'><span class='num'>482</span>                UPDATE nodes
</div><div class='line not-executable'><span class='num'>483</span>                SET    label = :label, 
</div><div class='line not-executable'><span class='num'>484</span>                       category = :category, 
</div><div class='line not-executable'><span class='num'>485</span>                       type = :type, 
</div><div class='line not-executable'><span class='num'>486</span>                       data = :data
</div><div class='line not-executable'><span class='num'>487</span>                WHERE  id = :id&quot;);
</div><div class='line not-covered'><span class='num'>488</span>            $data[&#039;id&#039;]       = $id;
</div><div class='line not-covered'><span class='num'>489</span>            $data[&#039;label&#039;]    = $label;
</div><div class='line not-covered'><span class='num'>490</span>            $data[&#039;category&#039;] = $category;
</div><div class='line not-covered'><span class='num'>491</span>            $data[&#039;type&#039;]     = $type;
</div><div class='line not-executable'><span class='num'>492</span>
</div><div class='line not-covered'><span class='num'>493</span>            $stmt-&gt;execute([
</div><div class='line not-covered'><span class='num'>494</span>                &#039;:id&#039;       =&gt; $id,
</div><div class='line not-covered'><span class='num'>495</span>                &#039;:label&#039;    =&gt; $label,
</div><div class='line not-covered'><span class='num'>496</span>                &#039;:category&#039; =&gt; $category,
</div><div class='line not-covered'><span class='num'>497</span>                &#039;:type&#039;     =&gt; $type,
</div><div class='line not-covered'><span class='num'>498</span>                &#039;:data&#039;     =&gt; json_encode($data, JSON_UNESCAPED_UNICODE)
</div><div class='line not-executable'><span class='num'>499</span>            ]);
</div><div class='line not-covered'><span class='num'>500</span>        } catch (PDOException $e) {
</div><div class='line not-executable'><span class='num'>501</span>            // TODO
</div><div class='line not-executable'><span class='num'>502</span>        }
</div><div class='line not-covered'><span class='num'>503</span>    }
</div><div class='line not-executable'><span class='num'>504</span>
</div><div class='line not-executable'><span class='num'>505</span>    public function deleteNode(string $id): void
</div><div class='line not-executable'><span class='num'>506</span>    {
</div><div class='line not-executable'><span class='num'>507</span>        try {
</div><div class='line not-covered'><span class='num'>508</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;DELETE FROM nodes WHERE id = :id&quot;);
</div><div class='line not-covered'><span class='num'>509</span>            $stmt-&gt;execute([&#039;:id&#039; =&gt; $id]);
</div><div class='line not-covered'><span class='num'>510</span>        } catch (PDOException $e) {
</div><div class='line not-executable'><span class='num'>511</span>            // TODO
</div><div class='line not-executable'><span class='num'>512</span>        }
</div><div class='line not-covered'><span class='num'>513</span>    }
</div><div class='line not-executable'><span class='num'>514</span>
</div><div class='line not-executable'><span class='num'>515</span>    public function getEdge(string $source, string $target): ?array
</div><div class='line not-executable'><span class='num'>516</span>    {
</div><div class='line not-executable'><span class='num'>517</span>        try {
</div><div class='line covered'><span class='num'>518</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-executable'><span class='num'>519</span>                SELECT * FROM edges
</div><div class='line not-executable'><span class='num'>520</span>                WHERE source = :source AND target = :target
</div><div class='line not-executable'><span class='num'>521</span>            &quot;);
</div><div class='line covered'><span class='num'>522</span>            $stmt-&gt;execute([
</div><div class='line covered'><span class='num'>523</span>                &#039;:source&#039; =&gt; $source,
</div><div class='line covered'><span class='num'>524</span>                &#039;:target&#039; =&gt; $target
</div><div class='line not-executable'><span class='num'>525</span>            ]);
</div><div class='line covered'><span class='num'>526</span>            $row = $stmt-&gt;fetch();
</div><div class='line covered'><span class='num'>527</span>            if ($row) {
</div><div class='line covered'><span class='num'>528</span>                return $row;
</div><div class='line not-executable'><span class='num'>529</span>            }
</div><div class='line not-covered'><span class='num'>530</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>531</span>            error_log(&quot;GraphDatabase edge exists check failed: &quot; . $e-&gt;getMessage());
</div><div class='line not-executable'><span class='num'>532</span>        }
</div><div class='line covered'><span class='num'>533</span>        return null;
</div><div class='line not-covered'><span class='num'>534</span>    }
</div><div class='line not-executable'><span class='num'>535</span>
</div><div class='line not-executable'><span class='num'>536</span>    public function getEdgeById(string $id): ?array
</div><div class='line not-executable'><span class='num'>537</span>    {
</div><div class='line not-executable'><span class='num'>538</span>        try {
</div><div class='line not-covered'><span class='num'>539</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-executable'><span class='num'>540</span>                SELECT * FROM edges
</div><div class='line not-executable'><span class='num'>541</span>                WHERE id = :id
</div><div class='line not-executable'><span class='num'>542</span>            &quot;);
</div><div class='line not-covered'><span class='num'>543</span>            $stmt-&gt;execute([
</div><div class='line not-covered'><span class='num'>544</span>                &#039;:id&#039; =&gt; $id,
</div><div class='line not-executable'><span class='num'>545</span>            ]);
</div><div class='line not-covered'><span class='num'>546</span>            $row = $stmt-&gt;fetch();
</div><div class='line not-covered'><span class='num'>547</span>            if ($row) {
</div><div class='line not-covered'><span class='num'>548</span>                return $row;
</div><div class='line not-executable'><span class='num'>549</span>            }
</div><div class='line not-covered'><span class='num'>550</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>551</span>            error_log(&quot;GraphDatabase edge exists check failed: &quot; . $e-&gt;getMessage());
</div><div class='line not-executable'><span class='num'>552</span>        }
</div><div class='line not-covered'><span class='num'>553</span>        return null;
</div><div class='line not-covered'><span class='num'>554</span>    }
</div><div class='line not-executable'><span class='num'>555</span>
</div><div class='line not-executable'><span class='num'>556</span>    public function getEdges(): array
</div><div class='line not-executable'><span class='num'>557</span>    {
</div><div class='line not-executable'><span class='num'>558</span>        try {
</div><div class='line not-covered'><span class='num'>559</span>            $stmt  = $this-&gt;pdo-&gt;query(&quot;SELECT * FROM edges&quot;);
</div><div class='line not-covered'><span class='num'>560</span>            $rows  = $stmt-&gt;fetchAll();
</div><div class='line not-covered'><span class='num'>561</span>            return $rows;
</div><div class='line not-covered'><span class='num'>562</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>563</span>            error_log(&quot;GraphDatabase fetch all edges failed: &quot; . $e-&gt;getMessage());
</div><div class='line not-covered'><span class='num'>564</span>            return [];
</div><div class='line not-executable'><span class='num'>565</span>        }
</div><div class='line not-covered'><span class='num'>566</span>    }
</div><div class='line not-executable'><span class='num'>567</span>
</div><div class='line not-executable'><span class='num'>568</span>    public function insertEdge(string $id, string $source, string $target, array $data = []): void
</div><div class='line not-executable'><span class='num'>569</span>    {
</div><div class='line not-executable'><span class='num'>570</span>        // verify if the inverse edge exists
</div><div class='line covered'><span class='num'>571</span>        $r = $this-&gt;getEdge($target, $source);
</div><div class='line not-executable'><span class='num'>572</span>        
</div><div class='line not-executable'><span class='num'>573</span>        try {
</div><div class='line covered'><span class='num'>574</span>            $sql = &quot;
</div><div class='line not-executable'><span class='num'>575</span>                INSERT OR IGNORE INTO edges
</div><div class='line not-executable'><span class='num'>576</span>                (id, source, target, data)
</div><div class='line not-executable'><span class='num'>577</span>                VALUES (:id, :source, :target, :data)&quot;;
</div><div class='line covered'><span class='num'>578</span>            $stmt           = $this-&gt;pdo-&gt;prepare($sql);
</div><div class='line covered'><span class='num'>579</span>            $data[&#039;id&#039;]     = $id;
</div><div class='line covered'><span class='num'>580</span>            $data[&#039;source&#039;] = $source;
</div><div class='line covered'><span class='num'>581</span>            $data[&#039;target&#039;] = $target;
</div><div class='line covered'><span class='num'>582</span>            $stmt-&gt;execute([
</div><div class='line covered'><span class='num'>583</span>                &#039;:id&#039;     =&gt; $id,
</div><div class='line covered'><span class='num'>584</span>                &#039;:source&#039; =&gt; $source,
</div><div class='line covered'><span class='num'>585</span>                &#039;:target&#039; =&gt; $target,
</div><div class='line covered'><span class='num'>586</span>                &#039;:data&#039;   =&gt; json_encode($data, JSON_UNESCAPED_UNICODE)
</div><div class='line not-executable'><span class='num'>587</span>            ]);
</div><div class='line covered'><span class='num'>588</span>        } catch (PDOException $e) {
</div><div class='line not-executable'><span class='num'>589</span>            // TODO
</div><div class='line not-executable'><span class='num'>590</span>        }
</div><div class='line covered'><span class='num'>591</span>    }
</div><div class='line not-executable'><span class='num'>592</span>
</div><div class='line not-executable'><span class='num'>593</span>    public function updateEdge(string $id, string $source, string $target, array $data = []): void
</div><div class='line not-executable'><span class='num'>594</span>    {
</div><div class='line not-executable'><span class='num'>595</span>        try {
</div><div class='line not-covered'><span class='num'>596</span>            $data[&#039;id&#039;]     = $id;
</div><div class='line not-covered'><span class='num'>597</span>            $data[&#039;source&#039;] = $source;
</div><div class='line not-covered'><span class='num'>598</span>            $data[&#039;target&#039;] = $target;
</div><div class='line not-executable'><span class='num'>599</span>
</div><div class='line not-covered'><span class='num'>600</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-executable'><span class='num'>601</span>                UPDATE edges
</div><div class='line not-executable'><span class='num'>602</span>                SET data = :data
</div><div class='line not-executable'><span class='num'>603</span>                WHERE id = :id&quot;);
</div><div class='line not-covered'><span class='num'>604</span>            $stmt-&gt;execute([
</div><div class='line not-covered'><span class='num'>605</span>                &#039;:id&#039;   =&gt; $id,
</div><div class='line not-covered'><span class='num'>606</span>                &#039;:data&#039; =&gt; json_encode($data, JSON_UNESCAPED_UNICODE)
</div><div class='line not-executable'><span class='num'>607</span>            ]);
</div><div class='line not-covered'><span class='num'>608</span>        } catch (PDOException $e) {
</div><div class='line not-executable'><span class='num'>609</span>            // TODO
</div><div class='line not-executable'><span class='num'>610</span>        }
</div><div class='line not-covered'><span class='num'>611</span>    }
</div><div class='line not-executable'><span class='num'>612</span>
</div><div class='line not-executable'><span class='num'>613</span>    public function deleteEdge(string $id): void
</div><div class='line not-executable'><span class='num'>614</span>    {
</div><div class='line not-executable'><span class='num'>615</span>        try {
</div><div class='line not-covered'><span class='num'>616</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;DELETE FROM edges WHERE id = :id&quot;);
</div><div class='line not-covered'><span class='num'>617</span>            $stmt-&gt;execute([&#039;:id&#039; =&gt; $id]);
</div><div class='line not-covered'><span class='num'>618</span>        } catch (PDOException $e) {
</div><div class='line not-executable'><span class='num'>619</span>            // TODO
</div><div class='line not-executable'><span class='num'>620</span>        }
</div><div class='line not-covered'><span class='num'>621</span>    }
</div><div class='line not-executable'><span class='num'>622</span>
</div><div class='line not-executable'><span class='num'>623</span>    public function getStatuses(): array
</div><div class='line not-executable'><span class='num'>624</span>    {
</div><div class='line not-covered'><span class='num'>625</span>        $stmt   = $this-&gt;pdo-&gt;query(&quot;
</div><div class='line not-executable'><span class='num'>626</span>            SELECT n.id,
</div><div class='line not-executable'><span class='num'>627</span>                   s.status
</div><div class='line not-executable'><span class='num'>628</span>            FROM   nodes n
</div><div class='line not-executable'><span class='num'>629</span>            LEFT JOIN status s ON n.id = s.node_id&quot;);
</div><div class='line not-covered'><span class='num'>630</span>        $status = $stmt-&gt;fetchAll();
</div><div class='line not-covered'><span class='num'>631</span>        return $status;
</div><div class='line not-covered'><span class='num'>632</span>    }
</div><div class='line not-executable'><span class='num'>633</span>
</div><div class='line not-executable'><span class='num'>634</span>    public function getNodeStatus(string $id): ?string
</div><div class='line not-executable'><span class='num'>635</span>    {
</div><div class='line not-covered'><span class='num'>636</span>        $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-executable'><span class='num'>637</span>            SELECT s.status
</div><div class='line not-executable'><span class='num'>638</span>            FROM nodes n
</div><div class='line not-executable'><span class='num'>639</span>            LEFT JOIN status s
</div><div class='line not-executable'><span class='num'>640</span>            ON n.id = s.node_id
</div><div class='line not-executable'><span class='num'>641</span>            WHERE n.id = ?&quot;);
</div><div class='line not-covered'><span class='num'>642</span>        $stmt-&gt;execute([$id]);
</div><div class='line not-covered'><span class='num'>643</span>        $status = $stmt-&gt;fetch();
</div><div class='line not-covered'><span class='num'>644</span>        return $status ? $status[&#039;status&#039;] : null;
</div><div class='line not-covered'><span class='num'>645</span>    }
</div><div class='line not-executable'><span class='num'>646</span>
</div><div class='line not-executable'><span class='num'>647</span>    public function setNodeStatus(string $id, string $status): void
</div><div class='line not-executable'><span class='num'>648</span>    {
</div><div class='line not-covered'><span class='num'>649</span>        $stmt = $this-&gt;pdo-&gt;prepare(&quot;REPLACE INTO status (node_id, status) VALUES (?, ?)&quot;);
</div><div class='line not-covered'><span class='num'>650</span>        $stmt-&gt;execute([$id, $status]);
</div><div class='line not-covered'><span class='num'>651</span>    }
</div><div class='line not-executable'><span class='num'>652</span>
</div><div class='line not-executable'><span class='num'>653</span>    public function getLogs($limit): array
</div><div class='line not-executable'><span class='num'>654</span>    {
</div><div class='line not-covered'><span class='num'>655</span>        $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-executable'><span class='num'>656</span>            SELECT *
</div><div class='line not-executable'><span class='num'>657</span>            FROM audit
</div><div class='line not-executable'><span class='num'>658</span>            ORDER BY created_at DESC
</div><div class='line not-executable'><span class='num'>659</span>            LIMIT :limit
</div><div class='line not-executable'><span class='num'>660</span>        &quot;);
</div><div class='line not-covered'><span class='num'>661</span>        $stmt-&gt;bindValue(&#039;:limit&#039;, (int)$limit, PDO::PARAM_INT);
</div><div class='line not-covered'><span class='num'>662</span>        $stmt-&gt;execute();
</div><div class='line not-covered'><span class='num'>663</span>        $rows = $stmt-&gt;fetchAll();
</div><div class='line not-covered'><span class='num'>664</span>        return $rows;
</div><div class='line not-covered'><span class='num'>665</span>    }
</div><div class='line not-executable'><span class='num'>666</span>
</div><div class='line not-executable'><span class='num'>667</span>    public function insertAuditLog(string $entity_type, string $entity_id, string $action, ?array $old_data = null, ?array $new_data = null, string $user_id, string $ip_address): bool
</div><div class='line not-executable'><span class='num'>668</span>    {
</div><div class='line not-executable'><span class='num'>669</span>        try {
</div><div class='line covered'><span class='num'>670</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-executable'><span class='num'>671</span>                INSERT INTO audit (entity_type, entity_id, action, old_data, new_data, user_id, ip_address)
</div><div class='line not-executable'><span class='num'>672</span>                VALUES (:entity_type, :entity_id, :action, :old_data, :new_data, :user_id, :ip_address)
</div><div class='line not-executable'><span class='num'>673</span>            &quot;);
</div><div class='line not-executable'><span class='num'>674</span>
</div><div class='line covered'><span class='num'>675</span>            $stmt-&gt;execute([
</div><div class='line covered'><span class='num'>676</span>                &#039;:entity_type&#039; =&gt; $entity_type,
</div><div class='line covered'><span class='num'>677</span>                &#039;:entity_id&#039;   =&gt; $entity_id,
</div><div class='line covered'><span class='num'>678</span>                &#039;:action&#039;      =&gt; $action,
</div><div class='line not-covered'><span class='num'>679</span>                &#039;:old_data&#039;    =&gt; $old_data !== null ? json_encode($old_data, JSON_UNESCAPED_UNICODE) : null,
</div><div class='line covered'><span class='num'>680</span>                &#039;:new_data&#039;    =&gt; $new_data !== null ? json_encode($new_data, JSON_UNESCAPED_UNICODE) : null,
</div><div class='line covered'><span class='num'>681</span>                &#039;:user_id&#039;     =&gt; $user_id,
</div><div class='line covered'><span class='num'>682</span>                &#039;:ip_address&#039;  =&gt; $ip_address
</div><div class='line not-executable'><span class='num'>683</span>            ]);
</div><div class='line covered'><span class='num'>684</span>            return true;
</div><div class='line not-covered'><span class='num'>685</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>686</span>            error_log(&quot;GraphDatabase audit log insert failed: &quot; . $e-&gt;getMessage());
</div><div class='line not-covered'><span class='num'>687</span>            return false;
</div><div class='line not-executable'><span class='num'>688</span>        }
</div><div class='line not-covered'><span class='num'>689</span>    }
</div><div class='line not-executable'><span class='num'>690</span>
</div><div class='line not-executable'><span class='num'>691</span>    private function initSchema(): void
</div><div class='line not-executable'><span class='num'>692</span>    {
</div><div class='line covered'><span class='num'>693</span>        $this-&gt;pdo-&gt;exec(&quot;
</div><div class='line not-executable'><span class='num'>694</span>            CREATE TABLE IF NOT EXISTS users (
</div><div class='line not-executable'><span class='num'>695</span>                id TEXT PRIMARY KEY,
</div><div class='line not-executable'><span class='num'>696</span>                user_group TEXT NOT NULL
</div><div class='line not-executable'><span class='num'>697</span>            )
</div><div class='line not-executable'><span class='num'>698</span>        &quot;);
</div><div class='line not-executable'><span class='num'>699</span>
</div><div class='line covered'><span class='num'>700</span>        $this-&gt;pdo-&gt;exec(&quot;INSERT INTO users VALUES(&#039;admin&#039;, &#039;admin&#039;)&quot;);
</div><div class='line not-executable'><span class='num'>701</span>
</div><div class='line covered'><span class='num'>702</span>        $this-&gt;pdo-&gt;exec(&quot;
</div><div class='line not-executable'><span class='num'>703</span>            CREATE TABLE IF NOT EXISTS nodes (
</div><div class='line not-executable'><span class='num'>704</span>                id TEXT PRIMARY KEY,
</div><div class='line not-executable'><span class='num'>705</span>                label TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>706</span>                category TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>707</span>                type TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>708</span>                data TEXT NOT NULL
</div><div class='line not-executable'><span class='num'>709</span>            )
</div><div class='line not-executable'><span class='num'>710</span>        &quot;);
</div><div class='line not-executable'><span class='num'>711</span>
</div><div class='line covered'><span class='num'>712</span>        $this-&gt;pdo-&gt;exec(&quot;
</div><div class='line not-executable'><span class='num'>713</span>            CREATE TABLE IF NOT EXISTS edges (
</div><div class='line not-executable'><span class='num'>714</span>                id TEXT PRIMARY KEY,
</div><div class='line not-executable'><span class='num'>715</span>                source TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>716</span>                target TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>717</span>                data TEXT,
</div><div class='line not-executable'><span class='num'>718</span>                FOREIGN KEY (source) REFERENCES nodes(id) ON DELETE CASCADE,
</div><div class='line not-executable'><span class='num'>719</span>                FOREIGN KEY (target) REFERENCES nodes(id) ON DELETE CASCADE
</div><div class='line not-executable'><span class='num'>720</span>            )
</div><div class='line not-executable'><span class='num'>721</span>        &quot;);
</div><div class='line not-executable'><span class='num'>722</span>
</div><div class='line covered'><span class='num'>723</span>        $this-&gt;pdo-&gt;exec(&quot;CREATE UNIQUE INDEX IF NOT EXISTS idx_edges_source_target ON edges (source, target)&quot;);
</div><div class='line not-executable'><span class='num'>724</span>
</div><div class='line covered'><span class='num'>725</span>        $this-&gt;pdo-&gt;exec(&quot;
</div><div class='line not-executable'><span class='num'>726</span>            CREATE TABLE IF NOT EXISTS status (
</div><div class='line not-executable'><span class='num'>727</span>                node_id TEXT PRIMARY KEY NOT NULL,
</div><div class='line not-executable'><span class='num'>728</span>                status TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>729</span>                created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
</div><div class='line not-executable'><span class='num'>730</span>                FOREIGN KEY (node_id) REFERENCES nodes(id) ON DELETE CASCADE
</div><div class='line not-executable'><span class='num'>731</span>            )
</div><div class='line not-executable'><span class='num'>732</span>        &quot;);
</div><div class='line not-executable'><span class='num'>733</span>
</div><div class='line covered'><span class='num'>734</span>        $this-&gt;pdo-&gt;exec(&quot;CREATE INDEX IF NOT EXISTS idx_node_status_node_id ON status (node_id)&quot;);
</div><div class='line not-executable'><span class='num'>735</span>
</div><div class='line covered'><span class='num'>736</span>        $this-&gt;pdo-&gt;exec(&quot;
</div><div class='line not-executable'><span class='num'>737</span>            CREATE TABLE IF NOT EXISTS audit (
</div><div class='line not-executable'><span class='num'>738</span>                id INTEGER PRIMARY KEY AUTOINCREMENT,
</div><div class='line not-executable'><span class='num'>739</span>                entity_type TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>740</span>                entity_id TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>741</span>                action TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>742</span>                old_data TEXT,
</div><div class='line not-executable'><span class='num'>743</span>                new_data TEXT,
</div><div class='line not-executable'><span class='num'>744</span>                user_id TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>745</span>                ip_address TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>746</span>                created_at DATETIME DEFAULT CURRENT_TIMESTAMP
</div><div class='line not-executable'><span class='num'>747</span>            )
</div><div class='line not-executable'><span class='num'>748</span>        &quot;);
</div><div class='line covered'><span class='num'>749</span>    }
</div><div class='line not-executable'><span class='num'>750</span>
</div><div class='line not-executable'><span class='num'>751</span>    public static function createConnection(string $dsn): PDO
</div><div class='line not-executable'><span class='num'>752</span>    {
</div><div class='line covered'><span class='num'>753</span>        $pdo = new PDO($dsn);
</div><div class='line covered'><span class='num'>754</span>        $pdo-&gt;setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
</div><div class='line covered'><span class='num'>755</span>        $pdo-&gt;setAttribute(PDO::ATTR_DEFAULT_FETCH_MODE, PDO::FETCH_ASSOC);
</div><div class='line covered'><span class='num'>756</span>        $pdo-&gt;exec(&#039;PRAGMA foreign_keys = ON&#039;);
</div><div class='line covered'><span class='num'>757</span>        return $pdo;
</div><div class='line not-covered'><span class='num'>758</span>    }
</div><div class='line not-executable'><span class='num'>759</span>}
</div><div class='line not-executable'><span class='num'>760</span>
</div><div class='line not-executable'><span class='num'>761</span>final class GraphServiceException extends RuntimeException
</div><div class='line not-executable'><span class='num'>762</span>{
</div><div class='line not-executable'><span class='num'>763</span>}
</div><div class='line not-executable'><span class='num'>764</span>
</div><div class='line not-executable'><span class='num'>765</span>interface GraphServiceInterface
</div><div class='line not-executable'><span class='num'>766</span>{
</div><div class='line not-executable'><span class='num'>767</span>    public function getUser(string $id): ?User;
</div><div class='line not-executable'><span class='num'>768</span>    public function insertUser(User $user): void;
</div><div class='line not-executable'><span class='num'>769</span>    public function updateUser(User $user): void;
</div><div class='line not-executable'><span class='num'>770</span>
</div><div class='line not-executable'><span class='num'>771</span>    public function getGraph(): Graph;
</div><div class='line not-executable'><span class='num'>772</span>
</div><div class='line not-executable'><span class='num'>773</span>    public function getNode(string $id): ?Node;
</div><div class='line not-executable'><span class='num'>774</span>    public function getNodes(): Nodes;
</div><div class='line not-executable'><span class='num'>775</span>    public function insertNode(Node $node): void;
</div><div class='line not-executable'><span class='num'>776</span>    public function updateNode(Node $node): void;
</div><div class='line not-executable'><span class='num'>777</span>    public function deleteNode(string $id): void;
</div><div class='line not-executable'><span class='num'>778</span>
</div><div class='line not-executable'><span class='num'>779</span>    public function getEdge(string $source, string $target): ?Edge;
</div><div class='line not-executable'><span class='num'>780</span>    public function getEdges(): Edges;
</div><div class='line not-executable'><span class='num'>781</span>    public function insertEdge(Edge $edge): void;
</div><div class='line not-executable'><span class='num'>782</span>    public function updateEdge(Edge $edge): void;
</div><div class='line not-executable'><span class='num'>783</span>    public function deleteEdge(string $id): void;
</div><div class='line not-executable'><span class='num'>784</span>
</div><div class='line not-executable'><span class='num'>785</span>    public function getStatuses(): NodeStatuses;
</div><div class='line not-executable'><span class='num'>786</span>    public function getNodeStatus(string $id): NodeStatus;
</div><div class='line not-executable'><span class='num'>787</span>    public function setNodeStatus(NodeStatus $status): void;
</div><div class='line not-executable'><span class='num'>788</span>
</div><div class='line not-executable'><span class='num'>789</span>    public function getLogs($limit): AuditLogs;
</div><div class='line not-executable'><span class='num'>790</span>}
</div><div class='line not-executable'><span class='num'>791</span>
</div><div class='line not-executable'><span class='num'>792</span>final class GraphService implements GraphServiceInterface
</div><div class='line not-executable'><span class='num'>793</span>{
</div><div class='line not-executable'><span class='num'>794</span>    private const SECURE_ACTIONS = [
</div><div class='line not-executable'><span class='num'>795</span>        &#039;GraphService::getGraph&#039;      =&gt; true,
</div><div class='line not-executable'><span class='num'>796</span>        &#039;GraphService::getNode&#039;       =&gt; true,
</div><div class='line not-executable'><span class='num'>797</span>        &#039;GraphService::getNodes&#039;      =&gt; true,
</div><div class='line not-executable'><span class='num'>798</span>        &#039;GraphService::getEdge&#039;       =&gt; true,
</div><div class='line not-executable'><span class='num'>799</span>        &#039;GraphService::getEdges&#039;      =&gt; true,
</div><div class='line not-executable'><span class='num'>800</span>        &#039;GraphService::getStatuses&#039;   =&gt; true,
</div><div class='line not-executable'><span class='num'>801</span>        &#039;GraphService::getNodeStatus&#039; =&gt; true,
</div><div class='line not-executable'><span class='num'>802</span>        &#039;GraphService::setNodeStatus&#039; =&gt; true,
</div><div class='line not-executable'><span class='num'>803</span>        &#039;GraphService::getLogs&#039;       =&gt; true,
</div><div class='line not-executable'><span class='num'>804</span>        &#039;GraphService::insertNode&#039;    =&gt; false,
</div><div class='line not-executable'><span class='num'>805</span>        &#039;GraphService::updateNode&#039;    =&gt; false,
</div><div class='line not-executable'><span class='num'>806</span>        &#039;GraphService::deleteNode&#039;    =&gt; false,
</div><div class='line not-executable'><span class='num'>807</span>        &#039;GraphService::insertEdge&#039;    =&gt; false,
</div><div class='line not-executable'><span class='num'>808</span>        &#039;GraphService::updateEdge&#039;    =&gt; false,
</div><div class='line not-executable'><span class='num'>809</span>        &#039;GraphService::deleteEdge&#039;    =&gt; false,
</div><div class='line not-executable'><span class='num'>810</span>
</div><div class='line not-executable'><span class='num'>811</span>        &#039;GraphService::insertAuditLog&#039; =&gt; false,
</div><div class='line not-executable'><span class='num'>812</span>    ];
</div><div class='line not-executable'><span class='num'>813</span>
</div><div class='line not-executable'><span class='num'>814</span>    private GraphDatabaseInterface $db;
</div><div class='line not-executable'><span class='num'>815</span>    private Logger $logger;
</div><div class='line not-executable'><span class='num'>816</span>
</div><div class='line not-executable'><span class='num'>817</span>    public function __construct(GraphDatabaseInterface $db, Logger $logger)
</div><div class='line not-executable'><span class='num'>818</span>    {
</div><div class='line covered'><span class='num'>819</span>        $this-&gt;db = $db;
</div><div class='line covered'><span class='num'>820</span>        $this-&gt;logger = $logger;
</div><div class='line covered'><span class='num'>821</span>    }
</div><div class='line not-executable'><span class='num'>822</span>
</div><div class='line not-executable'><span class='num'>823</span>    public function getUser(string $id): ?User
</div><div class='line not-executable'><span class='num'>824</span>    {
</div><div class='line not-covered'><span class='num'>825</span>        $data = $this-&gt;db-&gt;getUser($id);
</div><div class='line not-covered'><span class='num'>826</span>        if ($data) {
</div><div class='line not-covered'><span class='num'>827</span>            $user = new User($id, null, $data[&#039;user_group&#039;]);
</div><div class='line not-covered'><span class='num'>828</span>            return $user;
</div><div class='line not-executable'><span class='num'>829</span>        }
</div><div class='line not-covered'><span class='num'>830</span>        return null;
</div><div class='line not-covered'><span class='num'>831</span>    }
</div><div class='line not-executable'><span class='num'>832</span>
</div><div class='line not-executable'><span class='num'>833</span>    public function insertUser(User $user): void
</div><div class='line not-executable'><span class='num'>834</span>    {
</div><div class='line not-covered'><span class='num'>835</span>        $this-&gt;db-&gt;insertUser($user-&gt;id, $user-&gt;group-&gt;id);
</div><div class='line not-covered'><span class='num'>836</span>    }
</div><div class='line not-executable'><span class='num'>837</span>
</div><div class='line not-executable'><span class='num'>838</span>    public function updateUser(User $user): void
</div><div class='line not-executable'><span class='num'>839</span>    {
</div><div class='line not-covered'><span class='num'>840</span>        $this-&gt;db-&gt;updateUser($user-&gt;id, $user-&gt;group-&gt;id);
</div><div class='line not-covered'><span class='num'>841</span>    }
</div><div class='line not-executable'><span class='num'>842</span>
</div><div class='line not-executable'><span class='num'>843</span>    public function getGraph(): Graph
</div><div class='line not-executable'><span class='num'>844</span>    {
</div><div class='line not-covered'><span class='num'>845</span>        $nodes = $this-&gt;getNodes()-&gt;nodes;
</div><div class='line not-covered'><span class='num'>846</span>        $edges = $this-&gt;getEdges()-&gt;edges;
</div><div class='line not-covered'><span class='num'>847</span>        return new Graph($nodes, $edges);
</div><div class='line not-covered'><span class='num'>848</span>    }
</div><div class='line not-executable'><span class='num'>849</span>
</div><div class='line not-executable'><span class='num'>850</span>    public function getNode(string $id): ?Node
</div><div class='line not-executable'><span class='num'>851</span>    {
</div><div class='line covered'><span class='num'>852</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>853</span>            throw new RuntimeException(&quot;Permission denied to get node.&quot;);
</div><div class='line not-executable'><span class='num'>854</span>        }
</div><div class='line not-executable'><span class='num'>855</span>
</div><div class='line covered'><span class='num'>856</span>        $data = $this-&gt;db-&gt;getNode($id);
</div><div class='line covered'><span class='num'>857</span>        if ($data) {
</div><div class='line covered'><span class='num'>858</span>            return new Node(
</div><div class='line covered'><span class='num'>859</span>                $data[&#039;id&#039;],
</div><div class='line covered'><span class='num'>860</span>                $data[&#039;label&#039;],
</div><div class='line covered'><span class='num'>861</span>                $data[&#039;category&#039;],
</div><div class='line covered'><span class='num'>862</span>                $data[&#039;type&#039;],
</div><div class='line covered'><span class='num'>863</span>                json_decode($data[&#039;data&#039;], true)
</div><div class='line not-executable'><span class='num'>864</span>            );
</div><div class='line not-executable'><span class='num'>865</span>        }
</div><div class='line not-covered'><span class='num'>866</span>        return null;
</div><div class='line not-covered'><span class='num'>867</span>    }
</div><div class='line not-executable'><span class='num'>868</span>
</div><div class='line not-executable'><span class='num'>869</span>    public function getNodes(): Nodes
</div><div class='line not-executable'><span class='num'>870</span>    {
</div><div class='line not-covered'><span class='num'>871</span>        if(! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>872</span>            throw new RuntimeException(&quot;Permission denied to get nodes.&quot;);
</div><div class='line not-executable'><span class='num'>873</span>        }
</div><div class='line not-executable'><span class='num'>874</span>
</div><div class='line not-covered'><span class='num'>875</span>        $nodesData = $this-&gt;db-&gt;getNodes();
</div><div class='line not-covered'><span class='num'>876</span>        $nodes     = new Nodes();
</div><div class='line not-covered'><span class='num'>877</span>        foreach ($nodesData as $data) {
</div><div class='line not-covered'><span class='num'>878</span>            $node = new Node(
</div><div class='line not-covered'><span class='num'>879</span>                $data[&#039;id&#039;],
</div><div class='line not-covered'><span class='num'>880</span>                $data[&#039;label&#039;],
</div><div class='line not-covered'><span class='num'>881</span>                $data[&#039;category&#039;],
</div><div class='line not-covered'><span class='num'>882</span>                $data[&#039;type&#039;],
</div><div class='line not-covered'><span class='num'>883</span>                json_decode($data[&#039;data&#039;], true)
</div><div class='line not-executable'><span class='num'>884</span>            );
</div><div class='line not-covered'><span class='num'>885</span>            $nodes-&gt;addNode($node);
</div><div class='line not-executable'><span class='num'>886</span>        }
</div><div class='line not-covered'><span class='num'>887</span>        return $nodes;
</div><div class='line not-covered'><span class='num'>888</span>    }
</div><div class='line not-executable'><span class='num'>889</span>
</div><div class='line not-executable'><span class='num'>890</span>    public function insertNode(Node $node): void
</div><div class='line not-executable'><span class='num'>891</span>    {
</div><div class='line covered'><span class='num'>892</span>        $this-&gt;logger-&gt;debug(&#039;inserting node&#039;, $node-&gt;toArray());
</div><div class='line not-executable'><span class='num'>893</span>
</div><div class='line covered'><span class='num'>894</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>895</span>            $this-&gt;logger-&gt;info(&#039;permission denied&#039;, $node-&gt;toArray());
</div><div class='line not-covered'><span class='num'>896</span>            throw new GraphServiceException(&#039;permission denied&#039;);
</div><div class='line not-executable'><span class='num'>897</span>        }
</div><div class='line not-executable'><span class='num'>898</span>
</div><div class='line covered'><span class='num'>899</span>        $this-&gt;logger-&gt;info(&#039;permission allowed&#039;, $node-&gt;toArray());
</div><div class='line not-executable'><span class='num'>900</span>
</div><div class='line covered'><span class='num'>901</span>        $this-&gt;insertAuditLog(new AuditLog( &#039;node&#039;, $node-&gt;id, &#039;insert&#039;, null, $node-&gt;toArray()));
</div><div class='line not-executable'><span class='num'>902</span>
</div><div class='line covered'><span class='num'>903</span>        $this-&gt;db-&gt;insertNode(
</div><div class='line covered'><span class='num'>904</span>            $node-&gt;id,
</div><div class='line covered'><span class='num'>905</span>            $node-&gt;label,
</div><div class='line covered'><span class='num'>906</span>            $node-&gt;category,
</div><div class='line covered'><span class='num'>907</span>            $node-&gt;type,
</div><div class='line covered'><span class='num'>908</span>            $node-&gt;data
</div><div class='line not-executable'><span class='num'>909</span>        );
</div><div class='line covered'><span class='num'>910</span>    }
</div><div class='line not-executable'><span class='num'>911</span>
</div><div class='line not-executable'><span class='num'>912</span>    public function updateNode(Node $node): void
</div><div class='line not-executable'><span class='num'>913</span>    {
</div><div class='line not-covered'><span class='num'>914</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>915</span>            throw new RuntimeException(&quot;Permission denied to update node.&quot;);
</div><div class='line not-executable'><span class='num'>916</span>        }
</div><div class='line not-executable'><span class='num'>917</span>
</div><div class='line not-covered'><span class='num'>918</span>        $old = $this-&gt;getNode($node-&gt;id);
</div><div class='line not-covered'><span class='num'>919</span>        $this-&gt;insertAuditLog(new AuditLog( &#039;node&#039;, $node-&gt;id, &#039;update&#039;, $old-&gt;toArray(), $node-&gt;toArray()));
</div><div class='line not-executable'><span class='num'>920</span>
</div><div class='line not-covered'><span class='num'>921</span>        $this-&gt;db-&gt;updateNode(
</div><div class='line not-covered'><span class='num'>922</span>            $node-&gt;id,
</div><div class='line not-covered'><span class='num'>923</span>            $node-&gt;label,
</div><div class='line not-covered'><span class='num'>924</span>            $node-&gt;category,
</div><div class='line not-covered'><span class='num'>925</span>            $node-&gt;type,
</div><div class='line not-covered'><span class='num'>926</span>            $node-&gt;data
</div><div class='line not-executable'><span class='num'>927</span>        );
</div><div class='line not-covered'><span class='num'>928</span>    }
</div><div class='line not-executable'><span class='num'>929</span>
</div><div class='line not-executable'><span class='num'>930</span>    public function deleteNode(string $id): void
</div><div class='line not-executable'><span class='num'>931</span>    {
</div><div class='line not-covered'><span class='num'>932</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>933</span>            throw new RuntimeException(&quot;Permission denied to delete node.&quot;);
</div><div class='line not-executable'><span class='num'>934</span>        }
</div><div class='line not-executable'><span class='num'>935</span>
</div><div class='line not-covered'><span class='num'>936</span>        $old = $this-&gt;getNode($id);
</div><div class='line not-covered'><span class='num'>937</span>        $this-&gt;insertAuditLog(new AuditLog( &#039;node&#039;, $id, &#039;delete&#039;, $old-&gt;toArray(), null));
</div><div class='line not-covered'><span class='num'>938</span>        $this-&gt;db-&gt;deleteNode($id);
</div><div class='line not-covered'><span class='num'>939</span>    }
</div><div class='line not-executable'><span class='num'>940</span>
</div><div class='line not-executable'><span class='num'>941</span>    public function getEdge(string $source, string $target): ?Edge
</div><div class='line not-executable'><span class='num'>942</span>    {
</div><div class='line not-covered'><span class='num'>943</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>944</span>            throw new RuntimeException(&quot;Permission denied to get edge.&quot;);
</div><div class='line not-executable'><span class='num'>945</span>        }
</div><div class='line not-executable'><span class='num'>946</span>
</div><div class='line not-covered'><span class='num'>947</span>        $edgesData = $this-&gt;db-&gt;getEdges();
</div><div class='line not-covered'><span class='num'>948</span>        foreach ($edgesData as $data) {
</div><div class='line not-covered'><span class='num'>949</span>            if ($data[&#039;source&#039;] === $source &amp;&amp; $data[&#039;target&#039;] === $target) {
</div><div class='line not-covered'><span class='num'>950</span>                return new Edge(
</div><div class='line not-covered'><span class='num'>951</span>                    $data[&#039;id&#039;],
</div><div class='line not-covered'><span class='num'>952</span>                    $data[&#039;source&#039;],
</div><div class='line not-covered'><span class='num'>953</span>                    $data[&#039;target&#039;],
</div><div class='line not-covered'><span class='num'>954</span>                    json_decode($data[&#039;data&#039;], true)
</div><div class='line not-executable'><span class='num'>955</span>                );
</div><div class='line not-executable'><span class='num'>956</span>            }
</div><div class='line not-executable'><span class='num'>957</span>        }
</div><div class='line not-covered'><span class='num'>958</span>        return null;
</div><div class='line not-covered'><span class='num'>959</span>    }
</div><div class='line not-executable'><span class='num'>960</span>
</div><div class='line not-executable'><span class='num'>961</span>    public function getEdges(): Edges
</div><div class='line not-executable'><span class='num'>962</span>    {
</div><div class='line not-covered'><span class='num'>963</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>964</span>            throw new RuntimeException(&quot;Permission denied to get edges.&quot;);
</div><div class='line not-executable'><span class='num'>965</span>        }
</div><div class='line not-covered'><span class='num'>966</span>        $edgesData = $this-&gt;db-&gt;getEdges();
</div><div class='line not-covered'><span class='num'>967</span>        $edges     = new Edges();
</div><div class='line not-covered'><span class='num'>968</span>        foreach ($edgesData as $data) {
</div><div class='line not-covered'><span class='num'>969</span>            $edge = new Edge(
</div><div class='line not-covered'><span class='num'>970</span>                $data[&#039;id&#039;],
</div><div class='line not-covered'><span class='num'>971</span>                $data[&#039;source&#039;],
</div><div class='line not-covered'><span class='num'>972</span>                $data[&#039;target&#039;],
</div><div class='line not-covered'><span class='num'>973</span>                json_decode($data[&#039;data&#039;], true)
</div><div class='line not-executable'><span class='num'>974</span>            );
</div><div class='line not-covered'><span class='num'>975</span>            $edges-&gt;addEdge($edge);
</div><div class='line not-executable'><span class='num'>976</span>        }
</div><div class='line not-covered'><span class='num'>977</span>        return $edges;
</div><div class='line not-covered'><span class='num'>978</span>    }
</div><div class='line not-executable'><span class='num'>979</span>
</div><div class='line not-executable'><span class='num'>980</span>    public function insertEdge(Edge $edge): void
</div><div class='line not-executable'><span class='num'>981</span>    {
</div><div class='line covered'><span class='num'>982</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>983</span>            throw new RuntimeException(&quot;Permission denied to insert edge.&quot;);
</div><div class='line not-executable'><span class='num'>984</span>        }
</div><div class='line covered'><span class='num'>985</span>        $this-&gt;insertAuditLog(new AuditLog( &#039;edge&#039;, $edge-&gt;id, &#039;insert&#039;, null, $edge-&gt;toArray()));
</div><div class='line covered'><span class='num'>986</span>        $this-&gt;db-&gt;insertEdge(
</div><div class='line covered'><span class='num'>987</span>            $edge-&gt;id,
</div><div class='line covered'><span class='num'>988</span>            $edge-&gt;source,
</div><div class='line covered'><span class='num'>989</span>            $edge-&gt;target,
</div><div class='line covered'><span class='num'>990</span>            $edge-&gt;data
</div><div class='line not-executable'><span class='num'>991</span>        );
</div><div class='line covered'><span class='num'>992</span>    }
</div><div class='line not-executable'><span class='num'>993</span>
</div><div class='line not-executable'><span class='num'>994</span>    public function updateEdge(Edge $edge): void
</div><div class='line not-executable'><span class='num'>995</span>    {
</div><div class='line not-covered'><span class='num'>996</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>997</span>            throw new RuntimeException(&quot;Permission denied to update edge.&quot;);
</div><div class='line not-executable'><span class='num'>998</span>        }
</div><div class='line not-covered'><span class='num'>999</span>        $old = $this-&gt;getEdge($edge-&gt;source, $edge-&gt;target);
</div><div class='line not-covered'><span class='num'>1000</span>        $this-&gt;insertAuditLog(new AuditLog( &#039;edge&#039;, $edge-&gt;id, &#039;update&#039;, $old-&gt;toArray(), $edge-&gt;toArray()));
</div><div class='line not-executable'><span class='num'>1001</span>
</div><div class='line not-covered'><span class='num'>1002</span>        $this-&gt;db-&gt;updateEdge(
</div><div class='line not-covered'><span class='num'>1003</span>            $edge-&gt;id,
</div><div class='line not-covered'><span class='num'>1004</span>            $edge-&gt;source,
</div><div class='line not-covered'><span class='num'>1005</span>            $edge-&gt;target,
</div><div class='line not-covered'><span class='num'>1006</span>            $edge-&gt;data
</div><div class='line not-executable'><span class='num'>1007</span>        );
</div><div class='line not-covered'><span class='num'>1008</span>    }
</div><div class='line not-executable'><span class='num'>1009</span>
</div><div class='line not-executable'><span class='num'>1010</span>    public function deleteEdge(string $id): void
</div><div class='line not-executable'><span class='num'>1011</span>    {
</div><div class='line not-covered'><span class='num'>1012</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>1013</span>            throw new RuntimeException(&quot;Permission denied to delete edge.&quot;);
</div><div class='line not-executable'><span class='num'>1014</span>        }
</div><div class='line not-covered'><span class='num'>1015</span>        $this-&gt;db-&gt;deleteEdge($id);
</div><div class='line not-covered'><span class='num'>1016</span>    }
</div><div class='line not-executable'><span class='num'>1017</span>
</div><div class='line not-executable'><span class='num'>1018</span>    public function getStatuses(): NodeStatuses
</div><div class='line not-executable'><span class='num'>1019</span>    {
</div><div class='line not-covered'><span class='num'>1020</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>1021</span>            throw new RuntimeException(&quot;Permission denied to get statuses.&quot;);
</div><div class='line not-executable'><span class='num'>1022</span>        }
</div><div class='line not-executable'><span class='num'>1023</span>
</div><div class='line not-covered'><span class='num'>1024</span>        $statusesData = $this-&gt;db-&gt;getStatuses();
</div><div class='line not-covered'><span class='num'>1025</span>        $nodeStatuses = new NodeStatuses();
</div><div class='line not-covered'><span class='num'>1026</span>        foreach ($statusesData as $data) {
</div><div class='line not-covered'><span class='num'>1027</span>            $status = new NodeStatus(
</div><div class='line not-covered'><span class='num'>1028</span>                $data[&#039;id&#039;],
</div><div class='line not-covered'><span class='num'>1029</span>                $data[&#039;status&#039;] ?? &#039;unknown&#039;
</div><div class='line not-executable'><span class='num'>1030</span>            );
</div><div class='line not-covered'><span class='num'>1031</span>            $nodeStatuses-&gt;addStatus($status);
</div><div class='line not-executable'><span class='num'>1032</span>        }
</div><div class='line not-covered'><span class='num'>1033</span>        return $nodeStatuses;
</div><div class='line not-covered'><span class='num'>1034</span>    }
</div><div class='line not-executable'><span class='num'>1035</span>
</div><div class='line not-executable'><span class='num'>1036</span>    public function getNodeStatus(string $id): NodeStatus
</div><div class='line not-executable'><span class='num'>1037</span>    {
</div><div class='line not-covered'><span class='num'>1038</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>1039</span>            throw new RuntimeException(&quot;Permission denied to get node status.&quot;);
</div><div class='line not-executable'><span class='num'>1040</span>        }
</div><div class='line not-executable'><span class='num'>1041</span>
</div><div class='line not-covered'><span class='num'>1042</span>        $statusData = $this-&gt;db-&gt;getNodeStatus($id);
</div><div class='line not-covered'><span class='num'>1043</span>        return new NodeStatus(
</div><div class='line not-covered'><span class='num'>1044</span>            $id,
</div><div class='line not-covered'><span class='num'>1045</span>            $statusData ?? &#039;unknown&#039;
</div><div class='line not-executable'><span class='num'>1046</span>        );
</div><div class='line not-covered'><span class='num'>1047</span>    }
</div><div class='line not-executable'><span class='num'>1048</span>
</div><div class='line not-executable'><span class='num'>1049</span>    public function setNodeStatus(NodeStatus $status): void
</div><div class='line not-executable'><span class='num'>1050</span>    {
</div><div class='line not-covered'><span class='num'>1051</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>1052</span>            throw new RuntimeException(&quot;Permission denied to set node status.&quot;);
</div><div class='line not-executable'><span class='num'>1053</span>        }
</div><div class='line not-executable'><span class='num'>1054</span>
</div><div class='line not-covered'><span class='num'>1055</span>        $this-&gt;db-&gt;setNodeStatus($status-&gt;nodeId, $status-&gt;status);
</div><div class='line not-covered'><span class='num'>1056</span>    }
</div><div class='line not-executable'><span class='num'>1057</span>
</div><div class='line not-executable'><span class='num'>1058</span>    public function getLogs($limit): AuditLogs
</div><div class='line not-executable'><span class='num'>1059</span>    {
</div><div class='line not-covered'><span class='num'>1060</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>1061</span>            throw new RuntimeException(&quot;Permission denied to get audit logs.&quot;);
</div><div class='line not-executable'><span class='num'>1062</span>        }
</div><div class='line not-executable'><span class='num'>1063</span>
</div><div class='line not-covered'><span class='num'>1064</span>        $logs = new AuditLogs();
</div><div class='line not-covered'><span class='num'>1065</span>        $rows = $this-&gt;db-&gt;getLogs($limit);
</div><div class='line not-covered'><span class='num'>1066</span>        foreach ($rows as $row) {
</div><div class='line not-covered'><span class='num'>1067</span>            $old_data = $row[&#039;old_data&#039;] ? json_decode($row[&#039;old_data&#039;], true) : [];
</div><div class='line not-covered'><span class='num'>1068</span>            $new_data = $row[&#039;new_data&#039;] ?  json_decode($row[&#039;new_data&#039;], true) : [];
</div><div class='line not-covered'><span class='num'>1069</span>            $log = new AuditLog(
</div><div class='line not-covered'><span class='num'>1070</span>                $row[&#039;entity_type&#039;],
</div><div class='line not-covered'><span class='num'>1071</span>                $row[&#039;entity_id&#039;],
</div><div class='line not-covered'><span class='num'>1072</span>                $row[&#039;action&#039;],
</div><div class='line not-executable'><span class='num'>1073</span>                $old_data,
</div><div class='line not-executable'><span class='num'>1074</span>                $new_data,
</div><div class='line not-executable'><span class='num'>1075</span>            );
</div><div class='line not-covered'><span class='num'>1076</span>            $log-&gt;userId    = $row[&#039;user_id&#039;];
</div><div class='line not-covered'><span class='num'>1077</span>            $log-&gt;ipAddress = $row[&#039;ip_address&#039;];
</div><div class='line not-covered'><span class='num'>1078</span>            $log-&gt;createdAt = $row[&#039;created_at&#039;];
</div><div class='line not-executable'><span class='num'>1079</span>
</div><div class='line not-covered'><span class='num'>1080</span>            $logs-&gt;addLog($log);
</div><div class='line not-executable'><span class='num'>1081</span>        }
</div><div class='line not-covered'><span class='num'>1082</span>        return $logs;
</div><div class='line not-covered'><span class='num'>1083</span>    }
</div><div class='line not-executable'><span class='num'>1084</span>
</div><div class='line not-executable'><span class='num'>1085</span>    private function insertAuditLog(AuditLog $auditLog): void
</div><div class='line not-executable'><span class='num'>1086</span>    {
</div><div class='line covered'><span class='num'>1087</span>        $user_id   = GraphContext::$user-&gt;id;
</div><div class='line covered'><span class='num'>1088</span>        $ip_address = GraphContext::$user-&gt;ipAddress;
</div><div class='line not-executable'><span class='num'>1089</span>
</div><div class='line covered'><span class='num'>1090</span>        $this-&gt;db-&gt;insertAuditLog(
</div><div class='line covered'><span class='num'>1091</span>            $auditLog-&gt;entityType,
</div><div class='line covered'><span class='num'>1092</span>            $auditLog-&gt;entityId,
</div><div class='line covered'><span class='num'>1093</span>            $auditLog-&gt;action,
</div><div class='line covered'><span class='num'>1094</span>            $auditLog-&gt;oldData,
</div><div class='line covered'><span class='num'>1095</span>            $auditLog-&gt;newData,
</div><div class='line not-executable'><span class='num'>1096</span>            $user_id,
</div><div class='line not-executable'><span class='num'>1097</span>            $ip_address
</div><div class='line not-executable'><span class='num'>1098</span>        );
</div><div class='line covered'><span class='num'>1099</span>    }
</div><div class='line not-executable'><span class='num'>1100</span>
</div><div class='line not-executable'><span class='num'>1101</span>    private function isAllowed(string $action): bool
</div><div class='line not-executable'><span class='num'>1102</span>    {
</div><div class='line covered'><span class='num'>1103</span>        $group = GraphContext::$user-&gt;group;
</div><div class='line not-executable'><span class='num'>1104</span>
</div><div class='line not-executable'><span class='num'>1105</span>        // validate action
</div><div class='line not-executable'><span class='num'>1106</span>        // if action is one of the keys in the array self::SECURE_ACTIONS
</div><div class='line covered'><span class='num'>1107</span>        if (!array_key_exists($action, self::SECURE_ACTIONS)) {
</div><div class='line not-covered'><span class='num'>1108</span>            throw new RuntimeException(&quot;Action not defined in secure actions. Action: {$action}&quot;);
</div><div class='line not-executable'><span class='num'>1109</span>        }
</div><div class='line not-executable'><span class='num'>1110</span>
</div><div class='line not-executable'><span class='num'>1111</span>        // if is admin, allow all
</div><div class='line covered'><span class='num'>1112</span>        if ($group-&gt;id === &#039;admin&#039;) {
</div><div class='line not-covered'><span class='num'>1113</span>            return true;
</div><div class='line not-executable'><span class='num'>1114</span>        }
</div><div class='line not-executable'><span class='num'>1115</span>
</div><div class='line not-executable'><span class='num'>1116</span>        // if action is in the SAFE_ACTIONS, allow all
</div><div class='line covered'><span class='num'>1117</span>        if (self::SECURE_ACTIONS[$action]) {
</div><div class='line covered'><span class='num'>1118</span>            return true;
</div><div class='line not-executable'><span class='num'>1119</span>        }
</div><div class='line not-executable'><span class='num'>1120</span>        
</div><div class='line not-executable'><span class='num'>1121</span>        // if action is restricted, only allow contributor
</div><div class='line covered'><span class='num'>1122</span>        if (self::SECURE_ACTIONS[$action] == false &amp;&amp; $group-&gt;id == &#039;contributor&#039;)
</div><div class='line not-executable'><span class='num'>1123</span>        {
</div><div class='line covered'><span class='num'>1124</span>            return true;
</div><div class='line not-executable'><span class='num'>1125</span>        }
</div><div class='line not-executable'><span class='num'>1126</span>
</div><div class='line not-covered'><span class='num'>1127</span>        return false;
</div><div class='line not-covered'><span class='num'>1128</span>    }
</div><div class='line not-executable'><span class='num'>1129</span>}
</div><div class='line not-executable'><span class='num'>1130</span>
</div><div class='line not-executable'><span class='num'>1131</span>final class Request
</div><div class='line not-executable'><span class='num'>1132</span>{
</div><div class='line not-executable'><span class='num'>1133</span>    public array $data;
</div><div class='line not-executable'><span class='num'>1134</span>
</div><div class='line not-executable'><span class='num'>1135</span>    public function getParam($name): string
</div><div class='line not-executable'><span class='num'>1136</span>    {
</div><div class='line covered'><span class='num'>1137</span>        if(isset($_GET[$name])) {
</div><div class='line covered'><span class='num'>1138</span>            return $_GET[$name];
</div><div class='line not-executable'><span class='num'>1139</span>        }
</div><div class='line not-executable'><span class='num'>1140</span>
</div><div class='line not-covered'><span class='num'>1141</span>        throw new RuntimeException(&quot;param &#039;{$name}&#039; not found&quot;);
</div><div class='line not-covered'><span class='num'>1142</span>    }
</div><div class='line not-executable'><span class='num'>1143</span>
</div><div class='line not-executable'><span class='num'>1144</span>    public function getPath(): string
</div><div class='line not-executable'><span class='num'>1145</span>    {
</div><div class='line not-covered'><span class='num'>1146</span>        $scriptName = $_SERVER[&#039;SCRIPT_NAME&#039;];
</div><div class='line not-covered'><span class='num'>1147</span>        $requestUri = $_SERVER[&#039;REQUEST_URI&#039;];
</div><div class='line not-covered'><span class='num'>1148</span>        $requestUri = strtok($requestUri, &#039;?&#039;);
</div><div class='line not-covered'><span class='num'>1149</span>        $path = str_replace($scriptName, &#039;&#039;, $requestUri);
</div><div class='line not-covered'><span class='num'>1150</span>        return $path;
</div><div class='line not-covered'><span class='num'>1151</span>    }
</div><div class='line not-executable'><span class='num'>1152</span>}
</div><div class='line not-executable'><span class='num'>1153</span>
</div><div class='line not-executable'><span class='num'>1154</span>interface ResponseInterface
</div><div class='line not-executable'><span class='num'>1155</span>{
</div><div class='line not-executable'><span class='num'>1156</span>    public function send(): void;
</div><div class='line not-executable'><span class='num'>1157</span>}
</div><div class='line not-executable'><span class='num'>1158</span>
</div><div class='line not-executable'><span class='num'>1159</span>class Response implements ResponseInterface
</div><div class='line not-executable'><span class='num'>1160</span>{
</div><div class='line not-executable'><span class='num'>1161</span>    public int $code;
</div><div class='line not-executable'><span class='num'>1162</span>    public string $status;
</div><div class='line not-executable'><span class='num'>1163</span>    public string $message;
</div><div class='line not-executable'><span class='num'>1164</span>    public array $data;
</div><div class='line not-executable'><span class='num'>1165</span>
</div><div class='line not-executable'><span class='num'>1166</span>    public function __construct(int $code, string $status, string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1167</span>    {
</div><div class='line covered'><span class='num'>1168</span>        $this-&gt;code = $code;
</div><div class='line covered'><span class='num'>1169</span>        $this-&gt;status = $status;
</div><div class='line covered'><span class='num'>1170</span>        $this-&gt;message = $message;
</div><div class='line covered'><span class='num'>1171</span>        $this-&gt;data = $data;
</div><div class='line covered'><span class='num'>1172</span>    }
</div><div class='line not-executable'><span class='num'>1173</span>
</div><div class='line not-executable'><span class='num'>1174</span>    public function send(): void
</div><div class='line not-executable'><span class='num'>1175</span>    {
</div><div class='line not-covered'><span class='num'>1176</span>        header(&#039;Content-Type: application/json; charset=utf-8&#039;);
</div><div class='line not-covered'><span class='num'>1177</span>        http_response_code($this-&gt;code);
</div><div class='line not-covered'><span class='num'>1178</span>        $this-&gt;data = [&#039;code&#039; =&gt; $this-&gt;code, &#039;status&#039; =&gt; $this-&gt;status, &#039;message&#039; =&gt; $this-&gt;message, &#039;data&#039; =&gt; $this-&gt;data];
</div><div class='line not-covered'><span class='num'>1179</span>        echo json_encode($this-&gt;data, JSON_UNESCAPED_UNICODE |  JSON_UNESCAPED_SLASHES |  JSON_PRETTY_PRINT);
</div><div class='line not-covered'><span class='num'>1180</span>    }
</div><div class='line not-executable'><span class='num'>1181</span>}
</div><div class='line not-executable'><span class='num'>1182</span>
</div><div class='line not-executable'><span class='num'>1183</span>class OKResponse extends Response
</div><div class='line not-executable'><span class='num'>1184</span>{
</div><div class='line not-executable'><span class='num'>1185</span>    public function __construct(string $message, array $data)
</div><div class='line not-executable'><span class='num'>1186</span>    {
</div><div class='line covered'><span class='num'>1187</span>        return parent::__construct(200, &#039;success&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1188</span>    }
</div><div class='line not-executable'><span class='num'>1189</span>}
</div><div class='line not-executable'><span class='num'>1190</span>
</div><div class='line not-executable'><span class='num'>1191</span>class CreatedResponse extends Response
</div><div class='line not-executable'><span class='num'>1192</span>{
</div><div class='line not-executable'><span class='num'>1193</span>    public function __construct(string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1194</span>    {
</div><div class='line covered'><span class='num'>1195</span>        return parent::__construct(201, &#039;success&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1196</span>    }
</div><div class='line not-executable'><span class='num'>1197</span>}
</div><div class='line not-executable'><span class='num'>1198</span>
</div><div class='line not-executable'><span class='num'>1199</span>class BadRequestResponse extends Response
</div><div class='line not-executable'><span class='num'>1200</span>{
</div><div class='line not-executable'><span class='num'>1201</span>    public function __construct(string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1202</span>    {
</div><div class='line not-covered'><span class='num'>1203</span>        return parent::__construct(400, &#039;error&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1204</span>    }
</div><div class='line not-executable'><span class='num'>1205</span>}
</div><div class='line not-executable'><span class='num'>1206</span>
</div><div class='line not-executable'><span class='num'>1207</span>class UnauthorizedResponse extends Response
</div><div class='line not-executable'><span class='num'>1208</span>{
</div><div class='line not-executable'><span class='num'>1209</span>    public function __construct(string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1210</span>    {
</div><div class='line not-covered'><span class='num'>1211</span>        return parent::__construct(401, &#039;error&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1212</span>    }
</div><div class='line not-executable'><span class='num'>1213</span>}
</div><div class='line not-executable'><span class='num'>1214</span>
</div><div class='line not-executable'><span class='num'>1215</span>class ForbiddenResponse extends Response
</div><div class='line not-executable'><span class='num'>1216</span>{
</div><div class='line not-executable'><span class='num'>1217</span>    public function __construct(string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1218</span>    {
</div><div class='line not-covered'><span class='num'>1219</span>        return parent::__construct(403, &#039;error&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1220</span>    }
</div><div class='line not-executable'><span class='num'>1221</span>}
</div><div class='line not-executable'><span class='num'>1222</span>
</div><div class='line not-executable'><span class='num'>1223</span>class NotFoundResponse extends Response
</div><div class='line not-executable'><span class='num'>1224</span>{
</div><div class='line not-executable'><span class='num'>1225</span>    public function __construct(string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1226</span>    {
</div><div class='line not-covered'><span class='num'>1227</span>        return parent::__construct(404, &#039;error&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1228</span>    }
</div><div class='line not-executable'><span class='num'>1229</span>}
</div><div class='line not-executable'><span class='num'>1230</span>
</div><div class='line not-executable'><span class='num'>1231</span>class InternalServerErrorResponse extends Response
</div><div class='line not-executable'><span class='num'>1232</span>{
</div><div class='line not-executable'><span class='num'>1233</span>    public function __construct(string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1234</span>    {
</div><div class='line not-covered'><span class='num'>1235</span>        return parent::__construct(500, &#039;error&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1236</span>    }
</div><div class='line not-executable'><span class='num'>1237</span>}
</div><div class='line not-executable'><span class='num'>1238</span>
</div><div class='line not-executable'><span class='num'>1239</span>interface GraphControllerInterface
</div><div class='line not-executable'><span class='num'>1240</span>{
</div><div class='line not-executable'><span class='num'>1241</span>    public function getUser(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1242</span>    public function insertUser(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1243</span>    public function updateUser(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1244</span>
</div><div class='line not-executable'><span class='num'>1245</span>    public function getGraph(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1246</span>
</div><div class='line not-executable'><span class='num'>1247</span>    public function getNode(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1248</span>    public function getNodes(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1249</span>    public function insertNode(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1250</span>    public function updateNode(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1251</span>    public function deleteNode(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1252</span>
</div><div class='line not-executable'><span class='num'>1253</span>    public function getEdge(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1254</span>    public function getEdges(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1255</span>    public function insertEdge(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1256</span>    public function updateEdge(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1257</span>    public function deleteEdge(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1258</span>
</div><div class='line not-executable'><span class='num'>1259</span>    public function getStatuses(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1260</span>    public function getNodeStatus(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1261</span>    public function setNodeStatus(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1262</span>
</div><div class='line not-executable'><span class='num'>1263</span>    public function getLogs(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1264</span>}
</div><div class='line not-executable'><span class='num'>1265</span>
</div><div class='line not-executable'><span class='num'>1266</span>final class GraphControllerException extends RuntimeException
</div><div class='line not-executable'><span class='num'>1267</span>{
</div><div class='line not-executable'><span class='num'>1268</span>}
</div><div class='line not-executable'><span class='num'>1269</span>
</div><div class='line not-executable'><span class='num'>1270</span>final class GraphController implements GraphControllerInterface
</div><div class='line not-executable'><span class='num'>1271</span>{
</div><div class='line not-executable'><span class='num'>1272</span>    private GraphServiceInterface $service;
</div><div class='line not-executable'><span class='num'>1273</span>    private Logger $logger;
</div><div class='line not-executable'><span class='num'>1274</span>
</div><div class='line not-executable'><span class='num'>1275</span>    public function __construct(GraphServiceInterface $service, Logger $logger)
</div><div class='line not-executable'><span class='num'>1276</span>    {
</div><div class='line covered'><span class='num'>1277</span>        $this-&gt;service = $service;
</div><div class='line covered'><span class='num'>1278</span>        $this-&gt;logger = $logger;
</div><div class='line covered'><span class='num'>1279</span>    }
</div><div class='line not-executable'><span class='num'>1280</span>
</div><div class='line not-executable'><span class='num'>1281</span>    public function getUser(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1282</span>    {
</div><div class='line not-covered'><span class='num'>1283</span>        $data = $this-&gt;service-&gt;getUser($req-&gt;data[&#039;id&#039;]);
</div><div class='line not-covered'><span class='num'>1284</span>        $user = new User($data[&#039;id&#039;], null, new Group($data[&#039;user_group&#039;]));
</div><div class='line not-covered'><span class='num'>1285</span>        return new OKResponse(&#039;user found&#039;, $user-&gt;toArray());
</div><div class='line not-covered'><span class='num'>1286</span>    }
</div><div class='line not-executable'><span class='num'>1287</span>
</div><div class='line not-executable'><span class='num'>1288</span>    public function insertUser(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1289</span>    {
</div><div class='line not-covered'><span class='num'>1290</span>        $user = new User($req-&gt;data[&#039;id&#039;], null, $req-&gt;data[&#039;user_group&#039;]);
</div><div class='line not-covered'><span class='num'>1291</span>        $this-&gt;service-&gt;insertUser($user);
</div><div class='line not-covered'><span class='num'>1292</span>        return new OKResponse(&#039;user created&#039;, $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1293</span>    }
</div><div class='line not-executable'><span class='num'>1294</span>
</div><div class='line not-executable'><span class='num'>1295</span>    public function updateUser(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1296</span>    {
</div><div class='line not-covered'><span class='num'>1297</span>        $user = new User($req-&gt;data[&#039;id&#039;], null, $req-&gt;data[&#039;user_group&#039;]);
</div><div class='line not-covered'><span class='num'>1298</span>        $this-&gt;service-&gt;updateUser($user);
</div><div class='line not-covered'><span class='num'>1299</span>        return new CreatedResponse(&#039;user updated&#039;, $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1300</span>    }
</div><div class='line not-executable'><span class='num'>1301</span>
</div><div class='line not-executable'><span class='num'>1302</span>    public function getGraph(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1303</span>    {
</div><div class='line not-executable'><span class='num'>1304</span>        try {
</div><div class='line not-covered'><span class='num'>1305</span>            $data = $this-&gt;service-&gt;getGraph()-&gt;toArray();
</div><div class='line not-covered'><span class='num'>1306</span>            return new OKResponse(&#039;get graph&#039;, $data);
</div><div class='line not-covered'><span class='num'>1307</span>            return $resp;
</div><div class='line not-covered'><span class='num'>1308</span>        } catch (Exception $e) {
</div><div class='line not-covered'><span class='num'>1309</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1310</span>        }
</div><div class='line not-executable'><span class='num'>1311</span>
</div><div class='line not-covered'><span class='num'>1312</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1313</span>    }
</div><div class='line not-executable'><span class='num'>1314</span>
</div><div class='line not-executable'><span class='num'>1315</span>    public function getNode(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1316</span>    {
</div><div class='line not-executable'><span class='num'>1317</span>        try {
</div><div class='line covered'><span class='num'>1318</span>            $id = $req-&gt;getParam(&#039;id&#039;);
</div><div class='line covered'><span class='num'>1319</span>            $node = $this-&gt;service-&gt;getNode($id);
</div><div class='line covered'><span class='num'>1320</span>            $data = $node-&gt;toArray();
</div><div class='line covered'><span class='num'>1321</span>            return new OKResponse(&#039;node found&#039;, $data);
</div><div class='line not-covered'><span class='num'>1322</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1323</span>        {
</div><div class='line not-covered'><span class='num'>1324</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1325</span>        }
</div><div class='line not-executable'><span class='num'>1326</span>
</div><div class='line not-covered'><span class='num'>1327</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1328</span>    }
</div><div class='line not-executable'><span class='num'>1329</span>
</div><div class='line not-executable'><span class='num'>1330</span>    public function getNodes(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1331</span>    {
</div><div class='line not-executable'><span class='num'>1332</span>        try {
</div><div class='line not-covered'><span class='num'>1333</span>            $nodes = $this-&gt;service-&gt;getNodes();
</div><div class='line not-executable'><span class='num'>1334</span>            // TODO: corrigir
</div><div class='line not-covered'><span class='num'>1335</span>            return new OKResponse(&#039;nodes found&#039;, []);
</div><div class='line not-covered'><span class='num'>1336</span>            return $resp;
</div><div class='line not-covered'><span class='num'>1337</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1338</span>        {
</div><div class='line not-covered'><span class='num'>1339</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1340</span>        }
</div><div class='line not-executable'><span class='num'>1341</span>        
</div><div class='line not-covered'><span class='num'>1342</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1343</span>    }
</div><div class='line not-executable'><span class='num'>1344</span>
</div><div class='line not-executable'><span class='num'>1345</span>    public function insertNode(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1346</span>    {
</div><div class='line covered'><span class='num'>1347</span>        $this-&gt;logger-&gt;debug(&#039;inserting node&#039;, $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1348</span>        try {
</div><div class='line covered'><span class='num'>1349</span>            $node = new Node($req-&gt;data[&#039;id&#039;], $req-&gt;data[&#039;label&#039;], $req-&gt;data[&#039;category&#039;], $req-&gt;data[&#039;type&#039;], $req-&gt;data[&#039;data&#039;]);
</div><div class='line covered'><span class='num'>1350</span>            $this-&gt;service-&gt;insertNode($node);
</div><div class='line covered'><span class='num'>1351</span>            $this-&gt;logger-&gt;info(&#039;node inserted&#039;, $req-&gt;data);
</div><div class='line covered'><span class='num'>1352</span>            return new CreatedResponse(&#039;node inserted&#039;, $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1353</span>        } catch( GraphServiceException $e)
</div><div class='line not-executable'><span class='num'>1354</span>        {
</div><div class='line not-covered'><span class='num'>1355</span>            $this-&gt;logger-&gt;error(&#039;The service could not insert new node:&#039; . $e-&gt;getMessage());
</div><div class='line not-covered'><span class='num'>1356</span>            throw new GraphControllerException(&#039;The service could not insert new node:&#039; . $e-&gt;getMessage(), 0, $e);
</div><div class='line not-executable'><span class='num'>1357</span>        }
</div><div class='line not-covered'><span class='num'>1358</span>        return new InternalServerErrorResponse(&#039;unknow error inserting node&#039;, $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1359</span>    }
</div><div class='line not-executable'><span class='num'>1360</span>    
</div><div class='line not-executable'><span class='num'>1361</span>    public function updateNode(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1362</span>    {
</div><div class='line covered'><span class='num'>1363</span>        $this-&gt;logger-&gt;debug(&#039;updating node&#039;, $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1364</span>
</div><div class='line not-executable'><span class='num'>1365</span>        try {
</div><div class='line covered'><span class='num'>1366</span>            $edge = new Edge($req-&gt;data[&#039;id&#039;], $req-&gt;data[&#039;category&#039;], $req-&gt;data[&#039;type&#039;], $req-&gt;data[&#039;data&#039;]);
</div><div class='line covered'><span class='num'>1367</span>            $this-&gt;service-&gt;insertEdge($edge);
</div><div class='line covered'><span class='num'>1368</span>            $this-&gt;logger-&gt;info(&#039;edge inserted&#039;, $req-&gt;data);
</div><div class='line covered'><span class='num'>1369</span>            $resp = new CreatedResponse(&#039;edge created&#039;, $req-&gt;data);
</div><div class='line covered'><span class='num'>1370</span>            return $resp;
</div><div class='line not-covered'><span class='num'>1371</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1372</span>        {
</div><div class='line not-covered'><span class='num'>1373</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1374</span>        }
</div><div class='line not-executable'><span class='num'>1375</span>        
</div><div class='line not-covered'><span class='num'>1376</span>        return new InternalServerErrorResponse(&#039;unknow todo in updateNode&#039;, $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1377</span>    }
</div><div class='line not-executable'><span class='num'>1378</span>    
</div><div class='line not-executable'><span class='num'>1379</span>    public function deleteNode(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1380</span>    {
</div><div class='line not-executable'><span class='num'>1381</span>        try {
</div><div class='line not-covered'><span class='num'>1382</span>            $this-&gt;service-&gt;deleteEdge($req-&gt;data[&#039;id&#039;]);
</div><div class='line not-covered'><span class='num'>1383</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1384</span>        {
</div><div class='line not-covered'><span class='num'>1385</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1386</span>        }
</div><div class='line not-executable'><span class='num'>1387</span>        
</div><div class='line not-covered'><span class='num'>1388</span>        return new InternalServerErrorResponse(&#039;unknow todo in deleteNode&#039;, $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1389</span>    }
</div><div class='line not-executable'><span class='num'>1390</span>
</div><div class='line not-executable'><span class='num'>1391</span>    public function getEdge(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1392</span>    {
</div><div class='line not-executable'><span class='num'>1393</span>        try {
</div><div class='line not-covered'><span class='num'>1394</span>            $edge = $this-&gt;service-&gt;getEdge($req-&gt;data[&#039;source&#039;], $req-&gt;data[&#039;target&#039;]);
</div><div class='line not-covered'><span class='num'>1395</span>            $data = $edge-&gt;toArray();
</div><div class='line not-covered'><span class='num'>1396</span>            return new OKResponse(&#039;node found&#039;, $data);
</div><div class='line not-covered'><span class='num'>1397</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1398</span>        {
</div><div class='line not-covered'><span class='num'>1399</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1400</span>        }
</div><div class='line not-executable'><span class='num'>1401</span>        
</div><div class='line not-covered'><span class='num'>1402</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1403</span>    }
</div><div class='line not-executable'><span class='num'>1404</span>    
</div><div class='line not-executable'><span class='num'>1405</span>    public function getEdges(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1406</span>    {
</div><div class='line not-executable'><span class='num'>1407</span>        try {
</div><div class='line not-covered'><span class='num'>1408</span>            $edges = $this-&gt;service-&gt;getEdges();
</div><div class='line not-executable'><span class='num'>1409</span>            // TODO: corrigir
</div><div class='line not-covered'><span class='num'>1410</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1411</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1412</span>        {
</div><div class='line not-covered'><span class='num'>1413</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1414</span>        }
</div><div class='line not-executable'><span class='num'>1415</span>        
</div><div class='line not-covered'><span class='num'>1416</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1417</span>    }
</div><div class='line not-executable'><span class='num'>1418</span>    
</div><div class='line not-executable'><span class='num'>1419</span>    public function insertEdge(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1420</span>    {
</div><div class='line not-executable'><span class='num'>1421</span>        try {
</div><div class='line not-covered'><span class='num'>1422</span>            $edge = new Edge(null, $req-&gt;data[&#039;source&#039;], $req-&gt;data[&#039;target&#039;]);
</div><div class='line not-covered'><span class='num'>1423</span>            $this-&gt;service-&gt;insertEdge($edge);
</div><div class='line not-covered'><span class='num'>1424</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1425</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1426</span>        {
</div><div class='line not-covered'><span class='num'>1427</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1428</span>        }
</div><div class='line not-executable'><span class='num'>1429</span>        
</div><div class='line not-covered'><span class='num'>1430</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1431</span>    }
</div><div class='line not-executable'><span class='num'>1432</span>    
</div><div class='line not-executable'><span class='num'>1433</span>    public function updateEdge(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1434</span>    {
</div><div class='line not-executable'><span class='num'>1435</span>        try {
</div><div class='line not-covered'><span class='num'>1436</span>            $edge = new Edge($req-&gt;data[&#039;id&#039;], $req-&gt;data[&#039;source&#039;], $req-&gt;data[&#039;target&#039;], $req-&gt;data[&#039;data&#039;]);
</div><div class='line not-covered'><span class='num'>1437</span>            $this-&gt;service-&gt;updateEdge($edge);
</div><div class='line not-covered'><span class='num'>1438</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1439</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1440</span>        {
</div><div class='line not-covered'><span class='num'>1441</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1442</span>        }
</div><div class='line not-executable'><span class='num'>1443</span>        
</div><div class='line not-covered'><span class='num'>1444</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1445</span>    }
</div><div class='line not-executable'><span class='num'>1446</span>    
</div><div class='line not-executable'><span class='num'>1447</span>    public function deleteEdge(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1448</span>    {
</div><div class='line not-executable'><span class='num'>1449</span>        try {
</div><div class='line not-covered'><span class='num'>1450</span>            $id = $req-&gt;data[&#039;id&#039;];
</div><div class='line not-covered'><span class='num'>1451</span>            $this-&gt;service-&gt;deleteEdge($id);
</div><div class='line not-covered'><span class='num'>1452</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1453</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1454</span>        {
</div><div class='line not-covered'><span class='num'>1455</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1456</span>        }
</div><div class='line not-executable'><span class='num'>1457</span>        
</div><div class='line not-covered'><span class='num'>1458</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1459</span>    }
</div><div class='line not-executable'><span class='num'>1460</span>
</div><div class='line not-executable'><span class='num'>1461</span>    public function getStatuses(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1462</span>    {
</div><div class='line not-executable'><span class='num'>1463</span>        try {
</div><div class='line not-covered'><span class='num'>1464</span>            $statuses = $this-&gt;service-&gt;getStatuses();
</div><div class='line not-covered'><span class='num'>1465</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1466</span>            return $resp;
</div><div class='line not-covered'><span class='num'>1467</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1468</span>        {
</div><div class='line not-covered'><span class='num'>1469</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1470</span>        }
</div><div class='line not-executable'><span class='num'>1471</span>        
</div><div class='line not-covered'><span class='num'>1472</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1473</span>    }
</div><div class='line not-executable'><span class='num'>1474</span>    
</div><div class='line not-executable'><span class='num'>1475</span>    public function getNodeStatus(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1476</span>    {
</div><div class='line not-executable'><span class='num'>1477</span>        try {
</div><div class='line not-covered'><span class='num'>1478</span>            $status = $this-&gt;service-&gt;getNodeStatus($req-&gt;data[&#039;id&#039;]);
</div><div class='line not-covered'><span class='num'>1479</span>            $data = $status-&gt;toArray();
</div><div class='line not-covered'><span class='num'>1480</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1481</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1482</span>        {
</div><div class='line not-covered'><span class='num'>1483</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1484</span>        }
</div><div class='line not-executable'><span class='num'>1485</span>        
</div><div class='line not-covered'><span class='num'>1486</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1487</span>    }
</div><div class='line not-executable'><span class='num'>1488</span>    
</div><div class='line not-executable'><span class='num'>1489</span>    public function setNodeStatus(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1490</span>    {
</div><div class='line not-executable'><span class='num'>1491</span>        try {
</div><div class='line not-covered'><span class='num'>1492</span>            $status = new NodeStatus($req-&gt;data[&#039;node_id&#039;], $req-&gt;data[&#039;status&#039;]);
</div><div class='line not-covered'><span class='num'>1493</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1494</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1495</span>        {
</div><div class='line not-covered'><span class='num'>1496</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1497</span>        }
</div><div class='line not-executable'><span class='num'>1498</span>        
</div><div class='line not-covered'><span class='num'>1499</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1500</span>    }
</div><div class='line not-executable'><span class='num'>1501</span>
</div><div class='line not-executable'><span class='num'>1502</span>    public function getLogs(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1503</span>    {
</div><div class='line not-executable'><span class='num'>1504</span>        try {
</div><div class='line not-covered'><span class='num'>1505</span>            $logs = $this-&gt;service-&gt;getLogs($req-&gt;getParam(&#039;limit&#039;));
</div><div class='line not-covered'><span class='num'>1506</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1507</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1508</span>        {
</div><div class='line not-covered'><span class='num'>1509</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1510</span>        }
</div><div class='line not-executable'><span class='num'>1511</span>        
</div><div class='line not-covered'><span class='num'>1512</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1513</span>    }
</div><div class='line not-executable'><span class='num'>1514</span>}
</div><div class='line not-executable'><span class='num'>1515</span>
</div><div class='line not-executable'><span class='num'>1516</span>final class RequestRouter
</div><div class='line not-executable'><span class='num'>1517</span>{
</div><div class='line not-executable'><span class='num'>1518</span>    private $routes = [
</div><div class='line not-executable'><span class='num'>1519</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getGraph&#039;, &#039;class_method&#039; =&gt; &#039;getGraph&#039;],
</div><div class='line not-executable'><span class='num'>1520</span>        
</div><div class='line not-executable'><span class='num'>1521</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getNode&#039;, &#039;class_method&#039; =&gt; &#039;getNode&#039;],
</div><div class='line not-executable'><span class='num'>1522</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getNodes&#039;, &#039;class_method&#039; =&gt; &#039;getNodes&#039;],
</div><div class='line not-executable'><span class='num'>1523</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/insertNode&#039;, &#039;class_method&#039; =&gt; &#039;insertNode&#039;],
</div><div class='line not-executable'><span class='num'>1524</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/updateNode&#039;, &#039;class_method&#039; =&gt; &#039;updateNode&#039;],
</div><div class='line not-executable'><span class='num'>1525</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/deleteNode&#039;, &#039;class_method&#039; =&gt; &#039;deleteNode&#039;],
</div><div class='line not-executable'><span class='num'>1526</span>
</div><div class='line not-executable'><span class='num'>1527</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getEdge&#039;, &#039;class_method&#039; =&gt; &#039;getEdge&#039;],
</div><div class='line not-executable'><span class='num'>1528</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getEdges&#039;, &#039;class_method&#039; =&gt; &#039;getEdges&#039;],
</div><div class='line not-executable'><span class='num'>1529</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/insertEdge&#039;, &#039;class_method&#039; =&gt; &#039;insertEdge&#039;],
</div><div class='line not-executable'><span class='num'>1530</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/updateEdge&#039;, &#039;class_method&#039; =&gt; &#039;updateEdge&#039;],
</div><div class='line not-executable'><span class='num'>1531</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/deleteEdge&#039;, &#039;class_method&#039; =&gt; &#039;deleteEdge&#039;],
</div><div class='line not-executable'><span class='num'>1532</span>
</div><div class='line not-executable'><span class='num'>1533</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getStatuses&#039;, &#039;class_method&#039; =&gt; &#039;getStatuses&#039;],
</div><div class='line not-executable'><span class='num'>1534</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getNodeStatus&#039;, &#039;class_method&#039; =&gt; &#039;getNodeStatus&#039;],
</div><div class='line not-executable'><span class='num'>1535</span>
</div><div class='line not-executable'><span class='num'>1536</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getLogs&#039;, &#039;class_method&#039; =&gt; &#039;getLogs&#039;],
</div><div class='line not-executable'><span class='num'>1537</span>
</div><div class='line not-executable'><span class='num'>1538</span>        ];
</div><div class='line not-executable'><span class='num'>1539</span>
</div><div class='line not-executable'><span class='num'>1540</span>    public GraphController $controller;
</div><div class='line not-executable'><span class='num'>1541</span>    
</div><div class='line not-executable'><span class='num'>1542</span>    public function __construct(GraphController $controller)
</div><div class='line not-executable'><span class='num'>1543</span>    {
</div><div class='line not-covered'><span class='num'>1544</span>        $this-&gt;controller = $controller;
</div><div class='line not-covered'><span class='num'>1545</span>    }
</div><div class='line not-executable'><span class='num'>1546</span>
</div><div class='line not-executable'><span class='num'>1547</span>    public function handle(): void
</div><div class='line not-executable'><span class='num'>1548</span>    {
</div><div class='line not-covered'><span class='num'>1549</span>        $method = $_SERVER[&#039;REQUEST_METHOD&#039;];
</div><div class='line not-executable'><span class='num'>1550</span>
</div><div class='line not-covered'><span class='num'>1551</span>        $scriptName = $_SERVER[&#039;SCRIPT_NAME&#039;];
</div><div class='line not-covered'><span class='num'>1552</span>        $requestUri = $_SERVER[&#039;REQUEST_URI&#039;];
</div><div class='line not-covered'><span class='num'>1553</span>        $requestUri = strtok($requestUri, &#039;?&#039;);
</div><div class='line not-executable'><span class='num'>1554</span>        
</div><div class='line not-covered'><span class='num'>1555</span>        $path = str_replace($scriptName, &#039;&#039;, $requestUri);
</div><div class='line not-executable'><span class='num'>1556</span>        
</div><div class='line not-covered'><span class='num'>1557</span>        $req = new Request();
</div><div class='line not-executable'><span class='num'>1558</span>
</div><div class='line not-covered'><span class='num'>1559</span>        foreach($this-&gt;routes as $route)
</div><div class='line not-executable'><span class='num'>1560</span>        {
</div><div class='line not-covered'><span class='num'>1561</span>            if ($route[&#039;method&#039;] == $method &amp;&amp; $route[&#039;path&#039;] == $path)
</div><div class='line not-executable'><span class='num'>1562</span>            {
</div><div class='line not-covered'><span class='num'>1563</span>                $method = $route[&#039;class_method&#039;];
</div><div class='line not-covered'><span class='num'>1564</span>                $resp = $this-&gt;controller-&gt;$method($req);
</div><div class='line not-covered'><span class='num'>1565</span>                print_r($resp);
</div><div class='line not-covered'><span class='num'>1566</span>                exit();
</div><div class='line not-executable'><span class='num'>1567</span>            }
</div><div class='line not-executable'><span class='num'>1568</span>        }
</div><div class='line not-covered'><span class='num'>1569</span>    }
</div><div class='line not-executable'><span class='num'>1570</span>}
</div><div class='line not-executable'><span class='num'>1571</span>
</div><div class='line not-executable'><span class='num'>1572</span>
</div></body></html><html><head><meta charset='UTF-8'><style>
body { font-family: monospace; font-size: 12px; background: #222; color: #ddd; margin: 0; }
.covered { background: #1a4d1a; }
.not-covered { background: #4d1a1a; }
.not-executable { background: #2a2a2a; color: #666; }
.line { padding: 2px 10px; white-space: pre; border-left: 3px solid transparent; }
.covered { border-left-color: #0f0; }
.not-covered { border-left-color: #f00; }
.num { color: #666; width: 50px; display: inline-block; text-align: right; margin-right: 10px; }
h2 { background: #333; padding: 10px; margin: 20px 0 0 0; position: sticky; top: 0; }
</style></head><body><h2>/home/tarcisio/projects/graph/tests.php - 77.05% (47/61)</h2><div class='line not-executable'><span class='num'>1</span>&lt;?php
</div><div class='line not-executable'><span class='num'>2</span>
</div><div class='line not-executable'><span class='num'>3</span>declare(strict_types=1);
</div><div class='line not-executable'><span class='num'>4</span>
</div><div class='line not-executable'><span class='num'>5</span>require_once __DIR__ . &#039;/graph.php&#039;;
</div><div class='line not-executable'><span class='num'>6</span>
</div><div class='line not-executable'><span class='num'>7</span>ini_set(&#039;xdebug.mode&#039;, &#039;1&#039;);
</div><div class='line not-executable'><span class='num'>8</span>xdebug_start_code_coverage(XDEBUG_CC_UNUSED | XDEBUG_CC_DEAD_CODE);
</div><div class='line not-executable'><span class='num'>9</span>
</div><div class='line not-executable'><span class='num'>10</span>function array_diff_recursive($array1, $array2) {
</div><div class='line covered'><span class='num'>11</span>    $diff = [];
</div><div class='line not-executable'><span class='num'>12</span>    
</div><div class='line covered'><span class='num'>13</span>    foreach ($array1 as $key =&gt; $value) {
</div><div class='line covered'><span class='num'>14</span>        if (!array_key_exists($key, $array2)) {
</div><div class='line not-covered'><span class='num'>15</span>            $diff[$key] = $value;
</div><div class='line covered'><span class='num'>16</span>        } elseif (is_array($value)) {
</div><div class='line covered'><span class='num'>17</span>            if (!is_array($array2[$key])) {
</div><div class='line not-covered'><span class='num'>18</span>                $diff[$key] = $value;
</div><div class='line not-executable'><span class='num'>19</span>            } else {
</div><div class='line covered'><span class='num'>20</span>                $recursiveDiff = array_diff_recursive($value, $array2[$key]);
</div><div class='line covered'><span class='num'>21</span>                if (count($recursiveDiff)) {
</div><div class='line not-covered'><span class='num'>22</span>                    $diff[$key] = $recursiveDiff;
</div><div class='line not-executable'><span class='num'>23</span>                }
</div><div class='line not-executable'><span class='num'>24</span>            }
</div><div class='line covered'><span class='num'>25</span>        } elseif ($value !== $array2[$key]) {
</div><div class='line not-covered'><span class='num'>26</span>            $diff[$key] = $value;
</div><div class='line not-executable'><span class='num'>27</span>        }
</div><div class='line not-executable'><span class='num'>28</span>    }
</div><div class='line not-executable'><span class='num'>29</span>    
</div><div class='line covered'><span class='num'>30</span>    return $diff;
</div><div class='line not-covered'><span class='num'>31</span>}
</div><div class='line not-executable'><span class='num'>32</span>
</div><div class='line not-executable'><span class='num'>33</span>function get_test_graph_controller()
</div><div class='line not-executable'><span class='num'>34</span>{
</div><div class='line covered'><span class='num'>35</span>    GraphContext::$user = new User(&#039;test_user&#039;, &#039;127.0.0.1&#039;, new Group(&#039;contributor&#039;));
</div><div class='line covered'><span class='num'>36</span>    $pdo = GraphDatabase::createConnection(&#039;sqlite::memory:&#039;);
</div><div class='line covered'><span class='num'>37</span>    $databaseLogger = new Logger(&#039;database.log&#039;);
</div><div class='line not-executable'><span class='num'>38</span>
</div><div class='line covered'><span class='num'>39</span>    $graphDb = new GraphDatabase($pdo, $databaseLogger);
</div><div class='line not-executable'><span class='num'>40</span>
</div><div class='line covered'><span class='num'>41</span>    $serviceLogger = new Logger(&#039;service.log&#039;);
</div><div class='line covered'><span class='num'>42</span>    $graphService = new GraphService($graphDb, $serviceLogger);
</div><div class='line not-executable'><span class='num'>43</span>
</div><div class='line covered'><span class='num'>44</span>    $controllerLogger = new Logger(&#039;controller.log&#039;);
</div><div class='line covered'><span class='num'>45</span>    $graphController = new GraphController($graphService, $controllerLogger);
</div><div class='line not-executable'><span class='num'>46</span>    
</div><div class='line covered'><span class='num'>47</span>    return $graphController;
</div><div class='line not-covered'><span class='num'>48</span>}
</div><div class='line not-executable'><span class='num'>49</span>
</div><div class='line not-executable'><span class='num'>50</span>function test_node_good_path()
</div><div class='line not-executable'><span class='num'>51</span>{
</div><div class='line covered'><span class='num'>52</span>    $graphController = get_test_graph_controller();
</div><div class='line covered'><span class='num'>53</span>    $insertNodeReq = new Request();
</div><div class='line covered'><span class='num'>54</span>    $insertNodeReq-&gt;data = [&#039;id&#039; =&gt; &#039;node1&#039;, &#039;label&#039; =&gt; &#039;node1&#039;, &#039;category&#039; =&gt; &#039;business&#039;, &#039;type&#039; =&gt; &#039;server&#039;, &#039;data&#039; =&gt; [&#039;info&#039; =&gt; &#039;first node&#039;]];
</div><div class='line covered'><span class='num'>55</span>    $resp = $graphController-&gt;insertNode($insertNodeReq);
</div><div class='line not-executable'><span class='num'>56</span>    
</div><div class='line covered'><span class='num'>57</span>    $expected = [
</div><div class='line not-executable'><span class='num'>58</span>        &#039;id&#039;       =&gt; &#039;node1&#039;,
</div><div class='line not-executable'><span class='num'>59</span>        &#039;label&#039;    =&gt; &#039;node1&#039;,
</div><div class='line not-executable'><span class='num'>60</span>        &#039;category&#039; =&gt; &#039;business&#039;,
</div><div class='line not-executable'><span class='num'>61</span>        &#039;type&#039; =&gt; &#039;server&#039;,
</div><div class='line not-executable'><span class='num'>62</span>        &#039;data&#039; =&gt; [
</div><div class='line not-executable'><span class='num'>63</span>                &#039;info&#039; =&gt; &#039;first node&#039;
</div><div class='line not-executable'><span class='num'>64</span>        ]
</div><div class='line not-executable'><span class='num'>65</span>    ];
</div><div class='line not-executable'><span class='num'>66</span>
</div><div class='line covered'><span class='num'>67</span>    if($resp-&gt;code != 201) {
</div><div class='line not-covered'><span class='num'>68</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>69</span>    }
</div><div class='line not-executable'><span class='num'>70</span>
</div><div class='line covered'><span class='num'>71</span>    if($resp-&gt;status != &#039;success&#039;) {
</div><div class='line not-covered'><span class='num'>72</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>73</span>    }
</div><div class='line not-executable'><span class='num'>74</span>
</div><div class='line covered'><span class='num'>75</span>    if ($resp-&gt;message != &#039;node inserted&#039;) {
</div><div class='line not-covered'><span class='num'>76</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>77</span>    }
</div><div class='line not-executable'><span class='num'>78</span>
</div><div class='line covered'><span class='num'>79</span>    $diff = array_diff_recursive($resp-&gt;data, $expected);
</div><div class='line covered'><span class='num'>80</span>    if (! empty($diff)) {
</div><div class='line not-covered'><span class='num'>81</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>82</span>    }
</div><div class='line not-executable'><span class='num'>83</span>
</div><div class='line covered'><span class='num'>84</span>    $_GET[&#039;id&#039;] = &#039;node1&#039;;
</div><div class='line covered'><span class='num'>85</span>    $req = new Request();
</div><div class='line covered'><span class='num'>86</span>    $resp = $graphController-&gt;getNode($req);
</div><div class='line not-executable'><span class='num'>87</span>
</div><div class='line covered'><span class='num'>88</span>    if ($resp-&gt;code != 200) {
</div><div class='line not-covered'><span class='num'>89</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>90</span>    }
</div><div class='line not-executable'><span class='num'>91</span>
</div><div class='line covered'><span class='num'>92</span>    if($resp-&gt;status != &#039;success&#039;) {
</div><div class='line not-covered'><span class='num'>93</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>94</span>    }
</div><div class='line not-executable'><span class='num'>95</span>
</div><div class='line covered'><span class='num'>96</span>    if ($resp-&gt;message != &#039;node found&#039;) {
</div><div class='line not-covered'><span class='num'>97</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>98</span>    }
</div><div class='line not-executable'><span class='num'>99</span>
</div><div class='line covered'><span class='num'>100</span>    $expected = [
</div><div class='line not-executable'><span class='num'>101</span>        &#039;info&#039;     =&gt; &#039;first node&#039;,
</div><div class='line not-executable'><span class='num'>102</span>        &#039;id&#039;       =&gt; &#039;node1&#039;,
</div><div class='line not-executable'><span class='num'>103</span>        &#039;label&#039;    =&gt; &#039;node1&#039;,
</div><div class='line not-executable'><span class='num'>104</span>        &#039;category&#039; =&gt; &#039;business&#039;,
</div><div class='line not-executable'><span class='num'>105</span>        &#039;type&#039;     =&gt; &#039;server&#039;,
</div><div class='line not-executable'><span class='num'>106</span>    ];
</div><div class='line not-executable'><span class='num'>107</span>
</div><div class='line covered'><span class='num'>108</span>    $diff = array_diff_recursive($resp-&gt;data[&#039;data&#039;], $expected);
</div><div class='line covered'><span class='num'>109</span>    if (! empty($diff)) {
</div><div class='line not-covered'><span class='num'>110</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>111</span>    }
</div><div class='line not-executable'><span class='num'>112</span>    
</div><div class='line covered'><span class='num'>113</span>    $req = new Request();
</div><div class='line covered'><span class='num'>114</span>    $req-&gt;data = [
</div><div class='line not-executable'><span class='num'>115</span>        &#039;id&#039;       =&gt; &#039;node1&#039;,
</div><div class='line not-executable'><span class='num'>116</span>        &#039;label&#039;    =&gt; &#039;node1&#039;,
</div><div class='line not-executable'><span class='num'>117</span>        &#039;category&#039; =&gt; &#039;business&#039;,
</div><div class='line not-executable'><span class='num'>118</span>        &#039;type&#039; =&gt; &#039;server&#039;,
</div><div class='line not-executable'><span class='num'>119</span>        &#039;data&#039; =&gt; [
</div><div class='line not-executable'><span class='num'>120</span>                &#039;info&#039; =&gt; &#039;first node updated&#039;
</div><div class='line not-executable'><span class='num'>121</span>        ]
</div><div class='line not-executable'><span class='num'>122</span>    ];
</div><div class='line covered'><span class='num'>123</span>    $resp = $graphController-&gt;updateNode($req);
</div><div class='line covered'><span class='num'>124</span>    print_r($resp);
</div><div class='line covered'><span class='num'>125</span>}
</div><div class='line not-executable'><span class='num'>126</span>
</div><div class='line not-executable'><span class='num'>127</span>function tests() {
</div><div class='line covered'><span class='num'>128</span>    test_node_good_path();
</div><div class='line covered'><span class='num'>129</span>    echo &quot;fim&quot;;
</div><div class='line covered'><span class='num'>130</span>}
</div><div class='line not-executable'><span class='num'>131</span>
</div><div class='line covered'><span class='num'>132</span>tests();
</div><div class='line not-executable'><span class='num'>133</span>
</div><div class='line covered'><span class='num'>134</span>$coverage = xdebug_get_code_coverage();
</div><div class='line not-executable'><span class='num'>135</span>xdebug_stop_code_coverage();
</div><div class='line not-executable'><span class='num'>136</span>
</div><div class='line not-executable'><span class='num'>137</span>// Salvar em arquivo
</div><div class='line not-executable'><span class='num'>138</span>file_put_contents(&#039;coverage.json&#039;, json_encode($coverage, JSON_PRETTY_PRINT));
</div><div class='line not-executable'><span class='num'>139</span>
</div><div class='line not-executable'><span class='num'>140</span>echo &#039;fim&#039;;</div><h2>/home/tarcisio/projects/graph/graph.php - 30.66% (195/636)</h2><div class='line not-executable'><span class='num'>1</span>&lt;?php
</div><div class='line not-executable'><span class='num'>2</span>
</div><div class='line not-executable'><span class='num'>3</span>declare(strict_types=1);
</div><div class='line not-executable'><span class='num'>4</span>
</div><div class='line not-executable'><span class='num'>5</span>final class User
</div><div class='line not-executable'><span class='num'>6</span>{
</div><div class='line not-executable'><span class='num'>7</span>    public string $id;
</div><div class='line not-executable'><span class='num'>8</span>    public ?string $ipAddress;
</div><div class='line not-executable'><span class='num'>9</span>    public Group $group;
</div><div class='line not-executable'><span class='num'>10</span>
</div><div class='line not-executable'><span class='num'>11</span>    public function __construct(string $id, ?string $ipAddress, Group $group)
</div><div class='line not-executable'><span class='num'>12</span>    {
</div><div class='line covered'><span class='num'>13</span>        $this-&gt;id = $id;
</div><div class='line covered'><span class='num'>14</span>        $this-&gt;ipAddress = $ipAddress;
</div><div class='line covered'><span class='num'>15</span>        $this-&gt;group = $group;
</div><div class='line covered'><span class='num'>16</span>    }
</div><div class='line not-executable'><span class='num'>17</span>
</div><div class='line not-executable'><span class='num'>18</span>    public function toArray(): array
</div><div class='line not-executable'><span class='num'>19</span>    {
</div><div class='line not-executable'><span class='num'>20</span>        return [
</div><div class='line not-covered'><span class='num'>21</span>            &#039;id&#039; =&gt; $this-&gt;id,
</div><div class='line not-executable'><span class='num'>22</span>            &#039;group&#039; =&gt; [
</div><div class='line not-covered'><span class='num'>23</span>                &#039;id&#039; =&gt; $this-&gt;group-&gt;id,
</div><div class='line not-executable'><span class='num'>24</span>            ],
</div><div class='line not-executable'><span class='num'>25</span>        ];
</div><div class='line not-covered'><span class='num'>26</span>    }
</div><div class='line not-executable'><span class='num'>27</span>}
</div><div class='line not-executable'><span class='num'>28</span>
</div><div class='line not-executable'><span class='num'>29</span>final class Group
</div><div class='line not-executable'><span class='num'>30</span>{
</div><div class='line not-executable'><span class='num'>31</span>    private const ALLOWED_GROUPS = [&#039;anonymous&#039;, &#039;consumer&#039;, &#039;contributor&#039;, &#039;admin&#039;];
</div><div class='line not-executable'><span class='num'>32</span>    
</div><div class='line not-executable'><span class='num'>33</span>    public string $id;
</div><div class='line not-executable'><span class='num'>34</span>    
</div><div class='line not-executable'><span class='num'>35</span>    public function __construct(string $id)
</div><div class='line not-executable'><span class='num'>36</span>    {
</div><div class='line covered'><span class='num'>37</span>        if (!in_array($id, self::ALLOWED_GROUPS, true)) {
</div><div class='line not-covered'><span class='num'>38</span>            throw new InvalidArgumentException(&quot;Invalid user group: {$id}&quot;);
</div><div class='line not-executable'><span class='num'>39</span>        }
</div><div class='line covered'><span class='num'>40</span>        $this-&gt;id  = $id;
</div><div class='line covered'><span class='num'>41</span>    }
</div><div class='line not-executable'><span class='num'>42</span>}
</div><div class='line not-executable'><span class='num'>43</span>
</div><div class='line not-executable'><span class='num'>44</span>final class Graph
</div><div class='line not-executable'><span class='num'>45</span>{
</div><div class='line not-executable'><span class='num'>46</span>    public array $nodes = [];
</div><div class='line not-executable'><span class='num'>47</span>    public array $edges = [];
</div><div class='line not-executable'><span class='num'>48</span>    public array $data  = [];
</div><div class='line not-executable'><span class='num'>49</span>    public array $layout = [];
</div><div class='line not-executable'><span class='num'>50</span>    public array $styles = [];
</div><div class='line not-executable'><span class='num'>51</span>
</div><div class='line not-executable'><span class='num'>52</span>    public function __construct(array $nodes, array $edges)
</div><div class='line not-executable'><span class='num'>53</span>    {
</div><div class='line not-covered'><span class='num'>54</span>        $this-&gt;nodes = $nodes;
</div><div class='line not-covered'><span class='num'>55</span>        $this-&gt;edges = $edges;
</div><div class='line not-covered'><span class='num'>56</span>    }
</div><div class='line not-executable'><span class='num'>57</span>
</div><div class='line not-executable'><span class='num'>58</span>    public function toArray(): array
</div><div class='line not-executable'><span class='num'>59</span>    {
</div><div class='line not-executable'><span class='num'>60</span>        return [
</div><div class='line not-covered'><span class='num'>61</span>            &#039;nodes&#039; =&gt; $this-&gt;nodes,
</div><div class='line not-covered'><span class='num'>62</span>            &#039;edges&#039; =&gt; $this-&gt;edges,
</div><div class='line not-covered'><span class='num'>63</span>            &#039;data&#039; =&gt; $this-&gt;data,
</div><div class='line not-covered'><span class='num'>64</span>            &#039;layout&#039; =&gt; $this-&gt;layout,
</div><div class='line not-covered'><span class='num'>65</span>            &#039;styles&#039; =&gt; $this-&gt;styles,
</div><div class='line not-executable'><span class='num'>66</span>        ];
</div><div class='line not-covered'><span class='num'>67</span>    }
</div><div class='line not-executable'><span class='num'>68</span>}
</div><div class='line not-executable'><span class='num'>69</span>
</div><div class='line not-executable'><span class='num'>70</span>final class Node
</div><div class='line not-executable'><span class='num'>71</span>{
</div><div class='line not-executable'><span class='num'>72</span>    private const ALLOWED_CATEGORIES  = [&#039;business&#039;, &#039;application&#039;, &#039;infrastructure&#039;];
</div><div class='line not-executable'><span class='num'>73</span>    private const ALLOWED_TYPES       = [&#039;server&#039;, &#039;database&#039;, &#039;application&#039;, &#039;network&#039;];
</div><div class='line not-executable'><span class='num'>74</span>    private const ID_VALIDATION_REGEX = &#039;/^[a-zA-Z0-9\-_]+$/&#039;;
</div><div class='line not-executable'><span class='num'>75</span>    private const LABEL_MAX_LENGTH    = 20;
</div><div class='line not-executable'><span class='num'>76</span>    
</div><div class='line not-executable'><span class='num'>77</span>    public string $id;
</div><div class='line not-executable'><span class='num'>78</span>    public string $label;
</div><div class='line not-executable'><span class='num'>79</span>    public string $category;
</div><div class='line not-executable'><span class='num'>80</span>    public string $type;
</div><div class='line not-executable'><span class='num'>81</span>
</div><div class='line not-executable'><span class='num'>82</span>    public array $data = [];
</div><div class='line not-executable'><span class='num'>83</span>
</div><div class='line not-executable'><span class='num'>84</span>    public function __construct(string $id, string $label, string $category, string $type, array $data)
</div><div class='line not-executable'><span class='num'>85</span>    {
</div><div class='line covered'><span class='num'>86</span>        $this-&gt;validate($id, $label, $category, $type);
</div><div class='line covered'><span class='num'>87</span>        $this-&gt;id       = $id;
</div><div class='line covered'><span class='num'>88</span>        $this-&gt;label    = $label;
</div><div class='line covered'><span class='num'>89</span>        $this-&gt;category = $category;
</div><div class='line covered'><span class='num'>90</span>        $this-&gt;type     = $type;
</div><div class='line covered'><span class='num'>91</span>        $this-&gt;data     = $data;
</div><div class='line covered'><span class='num'>92</span>    }
</div><div class='line not-executable'><span class='num'>93</span>
</div><div class='line not-executable'><span class='num'>94</span>    private function validate(string $id, string $label, string $category, string $type): void
</div><div class='line not-executable'><span class='num'>95</span>    {
</div><div class='line covered'><span class='num'>96</span>        if (!preg_match(self::ID_VALIDATION_REGEX, $id)) {
</div><div class='line not-covered'><span class='num'>97</span>            throw new InvalidArgumentException(&quot;Invalid node ID: {$id}&quot;);
</div><div class='line not-executable'><span class='num'>98</span>        }
</div><div class='line not-executable'><span class='num'>99</span>
</div><div class='line covered'><span class='num'>100</span>        if (strlen($label) &gt; self::LABEL_MAX_LENGTH) {
</div><div class='line not-covered'><span class='num'>101</span>            throw new InvalidArgumentException(&quot;Node label exceeds maximum length of &quot; . self::LABEL_MAX_LENGTH);
</div><div class='line not-executable'><span class='num'>102</span>        }
</div><div class='line not-executable'><span class='num'>103</span>
</div><div class='line covered'><span class='num'>104</span>        if (!in_array($category, self::ALLOWED_CATEGORIES, true)) {
</div><div class='line not-covered'><span class='num'>105</span>            throw new InvalidArgumentException(&quot;Invalid node category: {$category}&quot;);
</div><div class='line not-executable'><span class='num'>106</span>        }
</div><div class='line not-executable'><span class='num'>107</span>
</div><div class='line covered'><span class='num'>108</span>        if (!in_array($type, self::ALLOWED_TYPES, true)) {
</div><div class='line not-covered'><span class='num'>109</span>            throw new InvalidArgumentException(&quot;Invalid node type: {$type}&quot;);
</div><div class='line not-executable'><span class='num'>110</span>        }
</div><div class='line covered'><span class='num'>111</span>    }
</div><div class='line not-executable'><span class='num'>112</span>
</div><div class='line not-executable'><span class='num'>113</span>    public function toArray(): array
</div><div class='line not-executable'><span class='num'>114</span>    {
</div><div class='line not-executable'><span class='num'>115</span>        return [
</div><div class='line covered'><span class='num'>116</span>            &#039;id&#039;       =&gt; $this-&gt;id,
</div><div class='line covered'><span class='num'>117</span>            &#039;label&#039;    =&gt; $this-&gt;label,
</div><div class='line covered'><span class='num'>118</span>            &#039;category&#039; =&gt; $this-&gt;category,
</div><div class='line covered'><span class='num'>119</span>            &#039;type&#039;     =&gt; $this-&gt;type,
</div><div class='line covered'><span class='num'>120</span>            &#039;data&#039;     =&gt; $this-&gt;data
</div><div class='line not-executable'><span class='num'>121</span>        ];
</div><div class='line not-covered'><span class='num'>122</span>    }
</div><div class='line not-executable'><span class='num'>123</span>}
</div><div class='line not-executable'><span class='num'>124</span>
</div><div class='line not-executable'><span class='num'>125</span>final class NodeStatus
</div><div class='line not-executable'><span class='num'>126</span>{
</div><div class='line not-executable'><span class='num'>127</span>    private const ALLOWED_NODE_STATUSES = [&#039;unknown&#039;, &#039;healthy&#039;, &#039;unhealthy&#039;, &#039;maintenance&#039;];
</div><div class='line not-executable'><span class='num'>128</span>
</div><div class='line not-executable'><span class='num'>129</span>    public string $nodeId;
</div><div class='line not-executable'><span class='num'>130</span>    public string $status;
</div><div class='line not-executable'><span class='num'>131</span>
</div><div class='line not-executable'><span class='num'>132</span>    public function __construct(string $nodeId, string $status)
</div><div class='line not-executable'><span class='num'>133</span>    {
</div><div class='line not-covered'><span class='num'>134</span>        if (!in_array($status, self::ALLOWED_NODE_STATUSES, true)) {
</div><div class='line not-covered'><span class='num'>135</span>            throw new InvalidArgumentException(&quot;Invalid node status: {$status}&quot;);
</div><div class='line not-executable'><span class='num'>136</span>        }
</div><div class='line not-covered'><span class='num'>137</span>        $this-&gt;nodeId = $nodeId;
</div><div class='line not-covered'><span class='num'>138</span>        $this-&gt;status = $status;
</div><div class='line not-covered'><span class='num'>139</span>    }
</div><div class='line not-executable'><span class='num'>140</span>
</div><div class='line not-executable'><span class='num'>141</span>    public function toArray(): array
</div><div class='line not-executable'><span class='num'>142</span>    {
</div><div class='line not-executable'><span class='num'>143</span>        return [
</div><div class='line not-covered'><span class='num'>144</span>            &#039;node_id&#039; =&gt; $this-&gt;nodeId,
</div><div class='line not-covered'><span class='num'>145</span>            &#039;status&#039;  =&gt; $this-&gt;status,
</div><div class='line not-executable'><span class='num'>146</span>        ];
</div><div class='line not-covered'><span class='num'>147</span>    }
</div><div class='line not-executable'><span class='num'>148</span>}
</div><div class='line not-executable'><span class='num'>149</span>
</div><div class='line not-executable'><span class='num'>150</span>final class NodeStatuses
</div><div class='line not-executable'><span class='num'>151</span>{
</div><div class='line not-executable'><span class='num'>152</span>    public array $statuses = [];
</div><div class='line not-executable'><span class='num'>153</span>
</div><div class='line not-executable'><span class='num'>154</span>    public function addStatus(NodeStatus $status): void
</div><div class='line not-executable'><span class='num'>155</span>    {
</div><div class='line not-covered'><span class='num'>156</span>        $this-&gt;statuses[] = $status;
</div><div class='line not-covered'><span class='num'>157</span>    }
</div><div class='line not-executable'><span class='num'>158</span>}
</div><div class='line not-executable'><span class='num'>159</span>
</div><div class='line not-executable'><span class='num'>160</span>final class Nodes
</div><div class='line not-executable'><span class='num'>161</span>{
</div><div class='line not-executable'><span class='num'>162</span>    public array $nodes = [];
</div><div class='line not-executable'><span class='num'>163</span>
</div><div class='line not-executable'><span class='num'>164</span>    public function addNode(Node $node): void
</div><div class='line not-executable'><span class='num'>165</span>    {
</div><div class='line not-covered'><span class='num'>166</span>        $this-&gt;nodes[] = $node;
</div><div class='line not-covered'><span class='num'>167</span>    }
</div><div class='line not-executable'><span class='num'>168</span>}
</div><div class='line not-executable'><span class='num'>169</span>
</div><div class='line not-executable'><span class='num'>170</span>final class Edge
</div><div class='line not-executable'><span class='num'>171</span>{
</div><div class='line not-executable'><span class='num'>172</span>    public ?string $id;
</div><div class='line not-executable'><span class='num'>173</span>    public string $source;
</div><div class='line not-executable'><span class='num'>174</span>    public string $target;
</div><div class='line not-executable'><span class='num'>175</span>    public array $data;
</div><div class='line not-executable'><span class='num'>176</span>
</div><div class='line not-executable'><span class='num'>177</span>    public function __construct(?string $id = null, string $source, string $target, array $data = [])
</div><div class='line not-executable'><span class='num'>178</span>    {
</div><div class='line covered'><span class='num'>179</span>        $this-&gt;id     = $id;
</div><div class='line covered'><span class='num'>180</span>        $this-&gt;source = $source;
</div><div class='line covered'><span class='num'>181</span>        $this-&gt;target = $target;
</div><div class='line covered'><span class='num'>182</span>        $this-&gt;data   = $data;
</div><div class='line covered'><span class='num'>183</span>    }
</div><div class='line not-executable'><span class='num'>184</span>
</div><div class='line not-executable'><span class='num'>185</span>    public function toArray(): array
</div><div class='line not-executable'><span class='num'>186</span>    {
</div><div class='line not-executable'><span class='num'>187</span>        return [
</div><div class='line covered'><span class='num'>188</span>            &#039;id&#039;     =&gt; $this-&gt;id,
</div><div class='line covered'><span class='num'>189</span>            &#039;source&#039; =&gt; $this-&gt;source,
</div><div class='line covered'><span class='num'>190</span>            &#039;target&#039; =&gt; $this-&gt;target,
</div><div class='line covered'><span class='num'>191</span>            &#039;data&#039;   =&gt; $this-&gt;data
</div><div class='line not-executable'><span class='num'>192</span>        ];
</div><div class='line not-covered'><span class='num'>193</span>    }
</div><div class='line not-executable'><span class='num'>194</span>}
</div><div class='line not-executable'><span class='num'>195</span>
</div><div class='line not-executable'><span class='num'>196</span>final class Edges
</div><div class='line not-executable'><span class='num'>197</span>{
</div><div class='line not-executable'><span class='num'>198</span>    public array $edges = [];
</div><div class='line not-executable'><span class='num'>199</span>    public function addEdge(Edge $edge): void
</div><div class='line not-executable'><span class='num'>200</span>    {
</div><div class='line not-covered'><span class='num'>201</span>        $this-&gt;edges[] = $edge;
</div><div class='line not-covered'><span class='num'>202</span>    }
</div><div class='line not-executable'><span class='num'>203</span>}
</div><div class='line not-executable'><span class='num'>204</span>
</div><div class='line not-executable'><span class='num'>205</span>final class AuditLog
</div><div class='line not-executable'><span class='num'>206</span>{
</div><div class='line not-executable'><span class='num'>207</span>    public string $entityType;
</div><div class='line not-executable'><span class='num'>208</span>    public string $entityId;
</div><div class='line not-executable'><span class='num'>209</span>    public string $action;
</div><div class='line not-executable'><span class='num'>210</span>    public ?array $oldData;
</div><div class='line not-executable'><span class='num'>211</span>    public ?array $newData;
</div><div class='line not-executable'><span class='num'>212</span>    public string $userId;
</div><div class='line not-executable'><span class='num'>213</span>    public string $ipAddress;
</div><div class='line not-executable'><span class='num'>214</span>    public string $createdAt;
</div><div class='line not-executable'><span class='num'>215</span>
</div><div class='line not-executable'><span class='num'>216</span>    public function __construct(string $entityType, string $entityId, string $action, ?array $oldData = null, ?array $newData = null)
</div><div class='line not-executable'><span class='num'>217</span>    {
</div><div class='line covered'><span class='num'>218</span>        $this-&gt;entityType = $entityType;
</div><div class='line covered'><span class='num'>219</span>        $this-&gt;entityId   = $entityId;
</div><div class='line covered'><span class='num'>220</span>        $this-&gt;action     = $action;
</div><div class='line covered'><span class='num'>221</span>        $this-&gt;oldData    = $oldData;
</div><div class='line covered'><span class='num'>222</span>        $this-&gt;newData    = $newData;
</div><div class='line covered'><span class='num'>223</span>    }
</div><div class='line not-executable'><span class='num'>224</span>}
</div><div class='line not-executable'><span class='num'>225</span>
</div><div class='line not-executable'><span class='num'>226</span>final class AuditLogs
</div><div class='line not-executable'><span class='num'>227</span>{
</div><div class='line not-executable'><span class='num'>228</span>    public array $logs = [];
</div><div class='line not-executable'><span class='num'>229</span>    public function addLog(AuditLog $log): void
</div><div class='line not-executable'><span class='num'>230</span>    {
</div><div class='line not-covered'><span class='num'>231</span>        $this-&gt;logs[] = $log;
</div><div class='line not-covered'><span class='num'>232</span>    }
</div><div class='line not-executable'><span class='num'>233</span>}
</div><div class='line not-executable'><span class='num'>234</span>
</div><div class='line not-executable'><span class='num'>235</span>final class GraphContext
</div><div class='line not-executable'><span class='num'>236</span>{
</div><div class='line not-executable'><span class='num'>237</span>    public static User $user;
</div><div class='line not-executable'><span class='num'>238</span>}
</div><div class='line not-executable'><span class='num'>239</span>
</div><div class='line not-executable'><span class='num'>240</span>interface LoggerInterface
</div><div class='line not-executable'><span class='num'>241</span>{
</div><div class='line not-executable'><span class='num'>242</span>    public function info(string $message, array $data = []): void;
</div><div class='line not-executable'><span class='num'>243</span>    public function debug(string $message, array $data = []): void;
</div><div class='line not-executable'><span class='num'>244</span>    public function error(string $message, array $data = []): void;
</div><div class='line not-executable'><span class='num'>245</span>}
</div><div class='line not-executable'><span class='num'>246</span>
</div><div class='line not-executable'><span class='num'>247</span>final class Logger implements LoggerInterface
</div><div class='line not-executable'><span class='num'>248</span>{
</div><div class='line not-executable'><span class='num'>249</span>    private string $fileName;
</div><div class='line not-executable'><span class='num'>250</span>    private $fd;
</div><div class='line not-executable'><span class='num'>251</span>
</div><div class='line not-executable'><span class='num'>252</span>    public function __construct($file_name)
</div><div class='line not-executable'><span class='num'>253</span>    {
</div><div class='line covered'><span class='num'>254</span>        $this-&gt;fileName = $file_name;
</div><div class='line covered'><span class='num'>255</span>        $this-&gt;fd = fopen($this-&gt;fileName, &#039;a&#039;);
</div><div class='line covered'><span class='num'>256</span>    }
</div><div class='line not-executable'><span class='num'>257</span>
</div><div class='line not-executable'><span class='num'>258</span>    public function info(string $message, array $data = []): void
</div><div class='line not-executable'><span class='num'>259</span>    {
</div><div class='line covered'><span class='num'>260</span>        $this-&gt;log(&#039;INFO&#039;, $message, $data);
</div><div class='line covered'><span class='num'>261</span>    }
</div><div class='line not-executable'><span class='num'>262</span>
</div><div class='line not-executable'><span class='num'>263</span>    public function debug(string $message, array $data = []): void
</div><div class='line not-executable'><span class='num'>264</span>    {
</div><div class='line covered'><span class='num'>265</span>        $this-&gt;log(&#039;DEBUG&#039;, $message, $data);
</div><div class='line covered'><span class='num'>266</span>    }
</div><div class='line not-executable'><span class='num'>267</span>
</div><div class='line not-executable'><span class='num'>268</span>    public function error(string $message, array $data = []): void
</div><div class='line not-executable'><span class='num'>269</span>    {
</div><div class='line not-covered'><span class='num'>270</span>        $this-&gt;log(&#039;ERROR&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>271</span>    }
</div><div class='line not-executable'><span class='num'>272</span>
</div><div class='line not-executable'><span class='num'>273</span>    private function log(string $type, $message, $data = [])
</div><div class='line not-executable'><span class='num'>274</span>    {
</div><div class='line covered'><span class='num'>275</span>        $trace = debug_backtrace(DEBUG_BACKTRACE_PROVIDE_OBJECT, 3);
</div><div class='line covered'><span class='num'>276</span>        $method = &quot;{$trace[2][&#039;class&#039;]}::{$trace[2][&#039;function&#039;]}&quot;;
</div><div class='line covered'><span class='num'>277</span>        $data = json_encode($data);
</div><div class='line covered'><span class='num'>278</span>        $message = &quot;[{$type}] {$method}: $message ($data)\n&quot;;
</div><div class='line covered'><span class='num'>279</span>        fwrite($this-&gt;fd, $message);
</div><div class='line covered'><span class='num'>280</span>    }
</div><div class='line not-executable'><span class='num'>281</span>}
</div><div class='line not-executable'><span class='num'>282</span>
</div><div class='line not-executable'><span class='num'>283</span>interface GraphDatabaseInterface
</div><div class='line not-executable'><span class='num'>284</span>{
</div><div class='line not-executable'><span class='num'>285</span>    public function getUser(string $id): ?array;
</div><div class='line not-executable'><span class='num'>286</span>    public function insertUser(string $id, string $group): void;
</div><div class='line not-executable'><span class='num'>287</span>    public function updateUser(string $id, string $group): void;
</div><div class='line not-executable'><span class='num'>288</span>
</div><div class='line not-executable'><span class='num'>289</span>    public function getNode(string $id): ?array;
</div><div class='line not-executable'><span class='num'>290</span>    public function getNodes(): array;
</div><div class='line not-executable'><span class='num'>291</span>    public function insertNode(string $id, string $label, string $category, string $type, array $data = []): void;
</div><div class='line not-executable'><span class='num'>292</span>    public function updateNode(string $id, string $label, string $category, string $type, array $data = []): void;
</div><div class='line not-executable'><span class='num'>293</span>    public function deleteNode(string $id): void;
</div><div class='line not-executable'><span class='num'>294</span>
</div><div class='line not-executable'><span class='num'>295</span>    public function getEdge(string $source, string $target): ?array;
</div><div class='line not-executable'><span class='num'>296</span>    public function getEdgeById(string $id): ?array;
</div><div class='line not-executable'><span class='num'>297</span>    public function getEdges(): array;
</div><div class='line not-executable'><span class='num'>298</span>    public function insertEdge(string $id, string $source, string $target, array $data = []): void;
</div><div class='line not-executable'><span class='num'>299</span>    public function updateEdge(string $id, string $source, string $target, array $data = []): void;
</div><div class='line not-executable'><span class='num'>300</span>    public function deleteEdge(string $id): void;
</div><div class='line not-executable'><span class='num'>301</span>
</div><div class='line not-executable'><span class='num'>302</span>    public function getStatuses(): array;
</div><div class='line not-executable'><span class='num'>303</span>    public function getNodeStatus(string $id): ?string;
</div><div class='line not-executable'><span class='num'>304</span>    public function setNodeStatus(string $id, string $status): void;
</div><div class='line not-executable'><span class='num'>305</span>
</div><div class='line not-executable'><span class='num'>306</span>    public function getLogs($limit): array;
</div><div class='line not-executable'><span class='num'>307</span>    public function insertAuditLog(
</div><div class='line not-executable'><span class='num'>308</span>        string $entity_type, 
</div><div class='line not-executable'><span class='num'>309</span>        string $entity_id, 
</div><div class='line not-executable'><span class='num'>310</span>        string $action, 
</div><div class='line not-executable'><span class='num'>311</span>        ?array $old_data = null, 
</div><div class='line not-executable'><span class='num'>312</span>        ?array $new_data = null,
</div><div class='line not-executable'><span class='num'>313</span>        string $user_id,
</div><div class='line not-executable'><span class='num'>314</span>        string $ip_address): bool;
</div><div class='line not-executable'><span class='num'>315</span>}
</div><div class='line not-executable'><span class='num'>316</span>
</div><div class='line not-executable'><span class='num'>317</span>final class DatabaseException extends RuntimeException
</div><div class='line not-executable'><span class='num'>318</span>{
</div><div class='line not-executable'><span class='num'>319</span>    private ?string $query;
</div><div class='line not-executable'><span class='num'>320</span>    private ?array $params;
</div><div class='line not-executable'><span class='num'>321</span>
</div><div class='line not-executable'><span class='num'>322</span>    
</div><div class='line not-executable'><span class='num'>323</span>    public function __construct(string $message = &quot;&quot;,  int $code = 0, ?Throwable $previous = null, ?string $query = null, ?array $params) {
</div><div class='line not-covered'><span class='num'>324</span>        parent::__construct($message, $code, $previous);
</div><div class='line not-covered'><span class='num'>325</span>        $this-&gt;query = $query;
</div><div class='line not-covered'><span class='num'>326</span>        $this-&gt;params = $params;
</div><div class='line not-covered'><span class='num'>327</span>    }
</div><div class='line not-executable'><span class='num'>328</span>}
</div><div class='line not-executable'><span class='num'>329</span>
</div><div class='line not-executable'><span class='num'>330</span>final class GraphDatabase implements GraphDatabaseInterface
</div><div class='line not-executable'><span class='num'>331</span>{
</div><div class='line not-executable'><span class='num'>332</span>    private PDO $pdo;
</div><div class='line not-executable'><span class='num'>333</span>    private Logger $logger;
</div><div class='line not-executable'><span class='num'>334</span>
</div><div class='line not-executable'><span class='num'>335</span>    public function __construct(PDO $pdo, Logger $logger)
</div><div class='line not-executable'><span class='num'>336</span>    {
</div><div class='line covered'><span class='num'>337</span>        $this-&gt;pdo = $pdo;
</div><div class='line covered'><span class='num'>338</span>        $this-&gt;logger = $logger;
</div><div class='line covered'><span class='num'>339</span>        $this-&gt;initSchema();
</div><div class='line covered'><span class='num'>340</span>    }
</div><div class='line not-executable'><span class='num'>341</span>
</div><div class='line not-executable'><span class='num'>342</span>    public function getUser(string $id): ?array
</div><div class='line not-executable'><span class='num'>343</span>    {
</div><div class='line not-covered'><span class='num'>344</span>        $this-&gt;logger-&gt;debug(&quot;getting user id: &#039;{$id}&#039;&quot;);
</div><div class='line not-executable'><span class='num'>345</span>        try {
</div><div class='line not-covered'><span class='num'>346</span>            $sql = &quot;SELECT * FROM users WHERE id = :id&quot;;
</div><div class='line not-covered'><span class='num'>347</span>            $params = [&#039;:id&#039; =&gt; $id];
</div><div class='line not-covered'><span class='num'>348</span>            $stmt = $this-&gt;pdo-&gt;prepare($sql);
</div><div class='line not-covered'><span class='num'>349</span>            $stmt-&gt;execute($params);
</div><div class='line not-covered'><span class='num'>350</span>            $row = $stmt-&gt;fetch();
</div><div class='line not-executable'><span class='num'>351</span>
</div><div class='line not-covered'><span class='num'>352</span>            if ($row) {
</div><div class='line not-covered'><span class='num'>353</span>                return $row;
</div><div class='line not-executable'><span class='num'>354</span>            }
</div><div class='line not-covered'><span class='num'>355</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>356</span>            $e = new DatabaseException(
</div><div class='line not-covered'><span class='num'>357</span>                &quot;GraphDatabase Exception while trying to get user data. ID: {$id}&quot;,
</div><div class='line not-covered'><span class='num'>358</span>                0,
</div><div class='line not-executable'><span class='num'>359</span>                $e,
</div><div class='line not-executable'><span class='num'>360</span>                $sql,
</div><div class='line not-executable'><span class='num'>361</span>                $params
</div><div class='line not-executable'><span class='num'>362</span>            );
</div><div class='line not-executable'><span class='num'>363</span>        }
</div><div class='line not-covered'><span class='num'>364</span>        return null;
</div><div class='line not-covered'><span class='num'>365</span>    }
</div><div class='line not-executable'><span class='num'>366</span>
</div><div class='line not-executable'><span class='num'>367</span>    public function insertUser(string $id, string $group): void
</div><div class='line not-executable'><span class='num'>368</span>    {
</div><div class='line not-executable'><span class='num'>369</span>        try {
</div><div class='line not-covered'><span class='num'>370</span>            $sql = &quot;
</div><div class='line not-executable'><span class='num'>371</span>                INSERT OR IGNORE INTO users 
</div><div class='line not-executable'><span class='num'>372</span>                (id, user_group)
</div><div class='line not-executable'><span class='num'>373</span>                VALUES (:id, :group)&quot;;
</div><div class='line not-executable'><span class='num'>374</span>            
</div><div class='line not-covered'><span class='num'>375</span>            $params = [
</div><div class='line not-covered'><span class='num'>376</span>                &#039;:id&#039;       =&gt; $id,
</div><div class='line not-covered'><span class='num'>377</span>                &#039;:group&#039;    =&gt; $group
</div><div class='line not-executable'><span class='num'>378</span>            ];
</div><div class='line not-executable'><span class='num'>379</span>
</div><div class='line not-covered'><span class='num'>380</span>            $stmt = $this-&gt;pdo-&gt;prepare($sql);
</div><div class='line not-covered'><span class='num'>381</span>            $stmt-&gt;execute($params);
</div><div class='line not-covered'><span class='num'>382</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>383</span>            $e = new DatabaseException(
</div><div class='line not-covered'><span class='num'>384</span>                &quot;GraphDatabase Exception while trying to insert new user. ID: {$id}&quot;,
</div><div class='line not-covered'><span class='num'>385</span>                0,
</div><div class='line not-executable'><span class='num'>386</span>                $e,
</div><div class='line not-executable'><span class='num'>387</span>                $sql,
</div><div class='line not-executable'><span class='num'>388</span>                $params
</div><div class='line not-executable'><span class='num'>389</span>            );
</div><div class='line not-executable'><span class='num'>390</span>        }
</div><div class='line not-covered'><span class='num'>391</span>    }
</div><div class='line not-executable'><span class='num'>392</span>
</div><div class='line not-executable'><span class='num'>393</span>    public function updateUser(string $id, string $group): void
</div><div class='line not-executable'><span class='num'>394</span>    {
</div><div class='line not-executable'><span class='num'>395</span>        try {
</div><div class='line not-covered'><span class='num'>396</span>            $sql = &quot;
</div><div class='line not-executable'><span class='num'>397</span>                UPDATE users
</div><div class='line not-executable'><span class='num'>398</span>                SET    user_group = :group
</div><div class='line not-executable'><span class='num'>399</span>                WHERE  id = :id
</div><div class='line not-executable'><span class='num'>400</span>            &quot;;
</div><div class='line not-executable'><span class='num'>401</span>
</div><div class='line not-covered'><span class='num'>402</span>            $params = [
</div><div class='line not-covered'><span class='num'>403</span>                &#039;:id&#039;       =&gt; $id,
</div><div class='line not-covered'><span class='num'>404</span>                &#039;:group&#039;    =&gt; $group
</div><div class='line not-executable'><span class='num'>405</span>            ];
</div><div class='line not-executable'><span class='num'>406</span>
</div><div class='line not-covered'><span class='num'>407</span>            $stmt = $this-&gt;pdo-&gt;prepare($sql);
</div><div class='line not-executable'><span class='num'>408</span>            
</div><div class='line not-covered'><span class='num'>409</span>            $stmt-&gt;execute($params);
</div><div class='line not-executable'><span class='num'>410</span>
</div><div class='line not-covered'><span class='num'>411</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>412</span>            $e = new DatabaseException(
</div><div class='line not-covered'><span class='num'>413</span>                &quot;GraphDatabase Exception while trying to update user. ID: {$id}&quot;,
</div><div class='line not-covered'><span class='num'>414</span>                0,
</div><div class='line not-executable'><span class='num'>415</span>                $e,
</div><div class='line not-executable'><span class='num'>416</span>                $sql,
</div><div class='line not-executable'><span class='num'>417</span>                $params
</div><div class='line not-executable'><span class='num'>418</span>            );
</div><div class='line not-executable'><span class='num'>419</span>        }
</div><div class='line not-covered'><span class='num'>420</span>    }
</div><div class='line not-executable'><span class='num'>421</span>
</div><div class='line not-executable'><span class='num'>422</span>    public function getNode(string $id): ?array
</div><div class='line not-executable'><span class='num'>423</span>    {
</div><div class='line covered'><span class='num'>424</span>        $this-&gt;logger-&gt;debug(&quot;fetching node &#039;{$id}&#039;&quot;);
</div><div class='line not-executable'><span class='num'>425</span>
</div><div class='line not-executable'><span class='num'>426</span>        try {
</div><div class='line covered'><span class='num'>427</span>            $sql = &quot;SELECT * FROM nodes WHERE id = :id&quot;;
</div><div class='line covered'><span class='num'>428</span>            $params = [&#039;:id&#039; =&gt; $id];
</div><div class='line covered'><span class='num'>429</span>            $stmt = $this-&gt;pdo-&gt;prepare($sql);
</div><div class='line covered'><span class='num'>430</span>            $stmt-&gt;execute($params);
</div><div class='line covered'><span class='num'>431</span>            $row = $stmt-&gt;fetch();
</div><div class='line covered'><span class='num'>432</span>            if ($row) {
</div><div class='line covered'><span class='num'>433</span>                return $row;
</div><div class='line not-executable'><span class='num'>434</span>            }
</div><div class='line not-covered'><span class='num'>435</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>436</span>            $this-&gt;logger-&gt;error(&quot;exception with node id &#039;{$id}&#039;&quot;);
</div><div class='line not-covered'><span class='num'>437</span>            throw new DatabaseException(&quot;could not get node data with id &#039;{$id}&#039;&quot;, 0, $e, $sql, $params);
</div><div class='line not-executable'><span class='num'>438</span>        }
</div><div class='line not-covered'><span class='num'>439</span>        return null;
</div><div class='line not-covered'><span class='num'>440</span>    }
</div><div class='line not-executable'><span class='num'>441</span>
</div><div class='line not-executable'><span class='num'>442</span>    public function getNodes(): array
</div><div class='line not-executable'><span class='num'>443</span>    {
</div><div class='line not-executable'><span class='num'>444</span>        try {
</div><div class='line not-covered'><span class='num'>445</span>            $stmt = $this-&gt;pdo-&gt;query(&quot;SELECT * FROM nodes&quot;);
</div><div class='line not-covered'><span class='num'>446</span>            $rows = $stmt-&gt;fetchAll();
</div><div class='line not-covered'><span class='num'>447</span>            return $rows;
</div><div class='line not-covered'><span class='num'>448</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>449</span>            error_log(&quot;GraphDatabase fetch all nodes failed: &quot; . $e-&gt;getMessage());
</div><div class='line not-covered'><span class='num'>450</span>            return [];
</div><div class='line not-executable'><span class='num'>451</span>        }
</div><div class='line not-covered'><span class='num'>452</span>    }
</div><div class='line not-executable'><span class='num'>453</span>
</div><div class='line not-executable'><span class='num'>454</span>    public function insertNode(string $id, string $label, string $category, string $type, array $data = []): void
</div><div class='line not-executable'><span class='num'>455</span>    {
</div><div class='line not-executable'><span class='num'>456</span>        try {
</div><div class='line covered'><span class='num'>457</span>            $sql = &quot;
</div><div class='line not-executable'><span class='num'>458</span>                INSERT OR IGNORE INTO nodes 
</div><div class='line not-executable'><span class='num'>459</span>                (id, label, category, type, data) 
</div><div class='line not-executable'><span class='num'>460</span>                VALUES (:id, :label, :category, :type, :data)&quot;;
</div><div class='line covered'><span class='num'>461</span>            $stmt             = $this-&gt;pdo-&gt;prepare($sql);
</div><div class='line covered'><span class='num'>462</span>            $data[&#039;id&#039;]       = $id;
</div><div class='line covered'><span class='num'>463</span>            $data[&#039;label&#039;]    = $label;
</div><div class='line covered'><span class='num'>464</span>            $data[&#039;category&#039;] = $category;
</div><div class='line covered'><span class='num'>465</span>            $data[&#039;type&#039;]     = $type;
</div><div class='line covered'><span class='num'>466</span>            $stmt-&gt;execute([
</div><div class='line covered'><span class='num'>467</span>                &#039;:id&#039;       =&gt; $id,
</div><div class='line covered'><span class='num'>468</span>                &#039;:label&#039;    =&gt; $label,
</div><div class='line covered'><span class='num'>469</span>                &#039;:category&#039; =&gt; $category,
</div><div class='line covered'><span class='num'>470</span>                &#039;:type&#039;     =&gt; $type,
</div><div class='line covered'><span class='num'>471</span>                &#039;:data&#039;     =&gt; json_encode($data, JSON_UNESCAPED_UNICODE)
</div><div class='line not-executable'><span class='num'>472</span>            ]);
</div><div class='line not-covered'><span class='num'>473</span>        } catch (PDOException $e) {
</div><div class='line not-executable'><span class='num'>474</span>            // TODO
</div><div class='line not-executable'><span class='num'>475</span>        }
</div><div class='line covered'><span class='num'>476</span>    }
</div><div class='line not-executable'><span class='num'>477</span>
</div><div class='line not-executable'><span class='num'>478</span>    public function updateNode(string $id, string $label, string $category, string $type, array $data = []): void
</div><div class='line not-executable'><span class='num'>479</span>    {
</div><div class='line not-executable'><span class='num'>480</span>        try {
</div><div class='line not-covered'><span class='num'>481</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-executable'><span class='num'>482</span>                UPDATE nodes
</div><div class='line not-executable'><span class='num'>483</span>                SET    label = :label, 
</div><div class='line not-executable'><span class='num'>484</span>                       category = :category, 
</div><div class='line not-executable'><span class='num'>485</span>                       type = :type, 
</div><div class='line not-executable'><span class='num'>486</span>                       data = :data
</div><div class='line not-executable'><span class='num'>487</span>                WHERE  id = :id&quot;);
</div><div class='line not-covered'><span class='num'>488</span>            $data[&#039;id&#039;]       = $id;
</div><div class='line not-covered'><span class='num'>489</span>            $data[&#039;label&#039;]    = $label;
</div><div class='line not-covered'><span class='num'>490</span>            $data[&#039;category&#039;] = $category;
</div><div class='line not-covered'><span class='num'>491</span>            $data[&#039;type&#039;]     = $type;
</div><div class='line not-executable'><span class='num'>492</span>
</div><div class='line not-covered'><span class='num'>493</span>            $stmt-&gt;execute([
</div><div class='line not-covered'><span class='num'>494</span>                &#039;:id&#039;       =&gt; $id,
</div><div class='line not-covered'><span class='num'>495</span>                &#039;:label&#039;    =&gt; $label,
</div><div class='line not-covered'><span class='num'>496</span>                &#039;:category&#039; =&gt; $category,
</div><div class='line not-covered'><span class='num'>497</span>                &#039;:type&#039;     =&gt; $type,
</div><div class='line not-covered'><span class='num'>498</span>                &#039;:data&#039;     =&gt; json_encode($data, JSON_UNESCAPED_UNICODE)
</div><div class='line not-executable'><span class='num'>499</span>            ]);
</div><div class='line not-covered'><span class='num'>500</span>        } catch (PDOException $e) {
</div><div class='line not-executable'><span class='num'>501</span>            // TODO
</div><div class='line not-executable'><span class='num'>502</span>        }
</div><div class='line not-covered'><span class='num'>503</span>    }
</div><div class='line not-executable'><span class='num'>504</span>
</div><div class='line not-executable'><span class='num'>505</span>    public function deleteNode(string $id): void
</div><div class='line not-executable'><span class='num'>506</span>    {
</div><div class='line not-executable'><span class='num'>507</span>        try {
</div><div class='line not-covered'><span class='num'>508</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;DELETE FROM nodes WHERE id = :id&quot;);
</div><div class='line not-covered'><span class='num'>509</span>            $stmt-&gt;execute([&#039;:id&#039; =&gt; $id]);
</div><div class='line not-covered'><span class='num'>510</span>        } catch (PDOException $e) {
</div><div class='line not-executable'><span class='num'>511</span>            // TODO
</div><div class='line not-executable'><span class='num'>512</span>        }
</div><div class='line not-covered'><span class='num'>513</span>    }
</div><div class='line not-executable'><span class='num'>514</span>
</div><div class='line not-executable'><span class='num'>515</span>    public function getEdge(string $source, string $target): ?array
</div><div class='line not-executable'><span class='num'>516</span>    {
</div><div class='line not-executable'><span class='num'>517</span>        try {
</div><div class='line covered'><span class='num'>518</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-executable'><span class='num'>519</span>                SELECT * FROM edges
</div><div class='line not-executable'><span class='num'>520</span>                WHERE source = :source AND target = :target
</div><div class='line not-executable'><span class='num'>521</span>            &quot;);
</div><div class='line covered'><span class='num'>522</span>            $stmt-&gt;execute([
</div><div class='line covered'><span class='num'>523</span>                &#039;:source&#039; =&gt; $source,
</div><div class='line covered'><span class='num'>524</span>                &#039;:target&#039; =&gt; $target
</div><div class='line not-executable'><span class='num'>525</span>            ]);
</div><div class='line covered'><span class='num'>526</span>            $row = $stmt-&gt;fetch();
</div><div class='line covered'><span class='num'>527</span>            if ($row) {
</div><div class='line covered'><span class='num'>528</span>                return $row;
</div><div class='line not-executable'><span class='num'>529</span>            }
</div><div class='line not-covered'><span class='num'>530</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>531</span>            error_log(&quot;GraphDatabase edge exists check failed: &quot; . $e-&gt;getMessage());
</div><div class='line not-executable'><span class='num'>532</span>        }
</div><div class='line covered'><span class='num'>533</span>        return null;
</div><div class='line not-covered'><span class='num'>534</span>    }
</div><div class='line not-executable'><span class='num'>535</span>
</div><div class='line not-executable'><span class='num'>536</span>    public function getEdgeById(string $id): ?array
</div><div class='line not-executable'><span class='num'>537</span>    {
</div><div class='line not-executable'><span class='num'>538</span>        try {
</div><div class='line not-covered'><span class='num'>539</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-executable'><span class='num'>540</span>                SELECT * FROM edges
</div><div class='line not-executable'><span class='num'>541</span>                WHERE id = :id
</div><div class='line not-executable'><span class='num'>542</span>            &quot;);
</div><div class='line not-covered'><span class='num'>543</span>            $stmt-&gt;execute([
</div><div class='line not-covered'><span class='num'>544</span>                &#039;:id&#039; =&gt; $id,
</div><div class='line not-executable'><span class='num'>545</span>            ]);
</div><div class='line not-covered'><span class='num'>546</span>            $row = $stmt-&gt;fetch();
</div><div class='line not-covered'><span class='num'>547</span>            if ($row) {
</div><div class='line not-covered'><span class='num'>548</span>                return $row;
</div><div class='line not-executable'><span class='num'>549</span>            }
</div><div class='line not-covered'><span class='num'>550</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>551</span>            error_log(&quot;GraphDatabase edge exists check failed: &quot; . $e-&gt;getMessage());
</div><div class='line not-executable'><span class='num'>552</span>        }
</div><div class='line not-covered'><span class='num'>553</span>        return null;
</div><div class='line not-covered'><span class='num'>554</span>    }
</div><div class='line not-executable'><span class='num'>555</span>
</div><div class='line not-executable'><span class='num'>556</span>    public function getEdges(): array
</div><div class='line not-executable'><span class='num'>557</span>    {
</div><div class='line not-executable'><span class='num'>558</span>        try {
</div><div class='line not-covered'><span class='num'>559</span>            $stmt  = $this-&gt;pdo-&gt;query(&quot;SELECT * FROM edges&quot;);
</div><div class='line not-covered'><span class='num'>560</span>            $rows  = $stmt-&gt;fetchAll();
</div><div class='line not-covered'><span class='num'>561</span>            return $rows;
</div><div class='line not-covered'><span class='num'>562</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>563</span>            error_log(&quot;GraphDatabase fetch all edges failed: &quot; . $e-&gt;getMessage());
</div><div class='line not-covered'><span class='num'>564</span>            return [];
</div><div class='line not-executable'><span class='num'>565</span>        }
</div><div class='line not-covered'><span class='num'>566</span>    }
</div><div class='line not-executable'><span class='num'>567</span>
</div><div class='line not-executable'><span class='num'>568</span>    public function insertEdge(string $id, string $source, string $target, array $data = []): void
</div><div class='line not-executable'><span class='num'>569</span>    {
</div><div class='line not-executable'><span class='num'>570</span>        // verify if the inverse edge exists
</div><div class='line covered'><span class='num'>571</span>        $r = $this-&gt;getEdge($target, $source);
</div><div class='line not-executable'><span class='num'>572</span>        
</div><div class='line not-executable'><span class='num'>573</span>        try {
</div><div class='line covered'><span class='num'>574</span>            $sql = &quot;
</div><div class='line not-executable'><span class='num'>575</span>                INSERT OR IGNORE INTO edges
</div><div class='line not-executable'><span class='num'>576</span>                (id, source, target, data)
</div><div class='line not-executable'><span class='num'>577</span>                VALUES (:id, :source, :target, :data)&quot;;
</div><div class='line covered'><span class='num'>578</span>            $stmt           = $this-&gt;pdo-&gt;prepare($sql);
</div><div class='line covered'><span class='num'>579</span>            $data[&#039;id&#039;]     = $id;
</div><div class='line covered'><span class='num'>580</span>            $data[&#039;source&#039;] = $source;
</div><div class='line covered'><span class='num'>581</span>            $data[&#039;target&#039;] = $target;
</div><div class='line covered'><span class='num'>582</span>            $stmt-&gt;execute([
</div><div class='line covered'><span class='num'>583</span>                &#039;:id&#039;     =&gt; $id,
</div><div class='line covered'><span class='num'>584</span>                &#039;:source&#039; =&gt; $source,
</div><div class='line covered'><span class='num'>585</span>                &#039;:target&#039; =&gt; $target,
</div><div class='line covered'><span class='num'>586</span>                &#039;:data&#039;   =&gt; json_encode($data, JSON_UNESCAPED_UNICODE)
</div><div class='line not-executable'><span class='num'>587</span>            ]);
</div><div class='line covered'><span class='num'>588</span>        } catch (PDOException $e) {
</div><div class='line not-executable'><span class='num'>589</span>            // TODO
</div><div class='line not-executable'><span class='num'>590</span>        }
</div><div class='line covered'><span class='num'>591</span>    }
</div><div class='line not-executable'><span class='num'>592</span>
</div><div class='line not-executable'><span class='num'>593</span>    public function updateEdge(string $id, string $source, string $target, array $data = []): void
</div><div class='line not-executable'><span class='num'>594</span>    {
</div><div class='line not-executable'><span class='num'>595</span>        try {
</div><div class='line not-covered'><span class='num'>596</span>            $data[&#039;id&#039;]     = $id;
</div><div class='line not-covered'><span class='num'>597</span>            $data[&#039;source&#039;] = $source;
</div><div class='line not-covered'><span class='num'>598</span>            $data[&#039;target&#039;] = $target;
</div><div class='line not-executable'><span class='num'>599</span>
</div><div class='line not-covered'><span class='num'>600</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-executable'><span class='num'>601</span>                UPDATE edges
</div><div class='line not-executable'><span class='num'>602</span>                SET data = :data
</div><div class='line not-executable'><span class='num'>603</span>                WHERE id = :id&quot;);
</div><div class='line not-covered'><span class='num'>604</span>            $stmt-&gt;execute([
</div><div class='line not-covered'><span class='num'>605</span>                &#039;:id&#039;   =&gt; $id,
</div><div class='line not-covered'><span class='num'>606</span>                &#039;:data&#039; =&gt; json_encode($data, JSON_UNESCAPED_UNICODE)
</div><div class='line not-executable'><span class='num'>607</span>            ]);
</div><div class='line not-covered'><span class='num'>608</span>        } catch (PDOException $e) {
</div><div class='line not-executable'><span class='num'>609</span>            // TODO
</div><div class='line not-executable'><span class='num'>610</span>        }
</div><div class='line not-covered'><span class='num'>611</span>    }
</div><div class='line not-executable'><span class='num'>612</span>
</div><div class='line not-executable'><span class='num'>613</span>    public function deleteEdge(string $id): void
</div><div class='line not-executable'><span class='num'>614</span>    {
</div><div class='line not-executable'><span class='num'>615</span>        try {
</div><div class='line not-covered'><span class='num'>616</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;DELETE FROM edges WHERE id = :id&quot;);
</div><div class='line not-covered'><span class='num'>617</span>            $stmt-&gt;execute([&#039;:id&#039; =&gt; $id]);
</div><div class='line not-covered'><span class='num'>618</span>        } catch (PDOException $e) {
</div><div class='line not-executable'><span class='num'>619</span>            // TODO
</div><div class='line not-executable'><span class='num'>620</span>        }
</div><div class='line not-covered'><span class='num'>621</span>    }
</div><div class='line not-executable'><span class='num'>622</span>
</div><div class='line not-executable'><span class='num'>623</span>    public function getStatuses(): array
</div><div class='line not-executable'><span class='num'>624</span>    {
</div><div class='line not-covered'><span class='num'>625</span>        $stmt   = $this-&gt;pdo-&gt;query(&quot;
</div><div class='line not-executable'><span class='num'>626</span>            SELECT n.id,
</div><div class='line not-executable'><span class='num'>627</span>                   s.status
</div><div class='line not-executable'><span class='num'>628</span>            FROM   nodes n
</div><div class='line not-executable'><span class='num'>629</span>            LEFT JOIN status s ON n.id = s.node_id&quot;);
</div><div class='line not-covered'><span class='num'>630</span>        $status = $stmt-&gt;fetchAll();
</div><div class='line not-covered'><span class='num'>631</span>        return $status;
</div><div class='line not-covered'><span class='num'>632</span>    }
</div><div class='line not-executable'><span class='num'>633</span>
</div><div class='line not-executable'><span class='num'>634</span>    public function getNodeStatus(string $id): ?string
</div><div class='line not-executable'><span class='num'>635</span>    {
</div><div class='line not-covered'><span class='num'>636</span>        $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-executable'><span class='num'>637</span>            SELECT s.status
</div><div class='line not-executable'><span class='num'>638</span>            FROM nodes n
</div><div class='line not-executable'><span class='num'>639</span>            LEFT JOIN status s
</div><div class='line not-executable'><span class='num'>640</span>            ON n.id = s.node_id
</div><div class='line not-executable'><span class='num'>641</span>            WHERE n.id = ?&quot;);
</div><div class='line not-covered'><span class='num'>642</span>        $stmt-&gt;execute([$id]);
</div><div class='line not-covered'><span class='num'>643</span>        $status = $stmt-&gt;fetch();
</div><div class='line not-covered'><span class='num'>644</span>        return $status ? $status[&#039;status&#039;] : null;
</div><div class='line not-covered'><span class='num'>645</span>    }
</div><div class='line not-executable'><span class='num'>646</span>
</div><div class='line not-executable'><span class='num'>647</span>    public function setNodeStatus(string $id, string $status): void
</div><div class='line not-executable'><span class='num'>648</span>    {
</div><div class='line not-covered'><span class='num'>649</span>        $stmt = $this-&gt;pdo-&gt;prepare(&quot;REPLACE INTO status (node_id, status) VALUES (?, ?)&quot;);
</div><div class='line not-covered'><span class='num'>650</span>        $stmt-&gt;execute([$id, $status]);
</div><div class='line not-covered'><span class='num'>651</span>    }
</div><div class='line not-executable'><span class='num'>652</span>
</div><div class='line not-executable'><span class='num'>653</span>    public function getLogs($limit): array
</div><div class='line not-executable'><span class='num'>654</span>    {
</div><div class='line not-covered'><span class='num'>655</span>        $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-executable'><span class='num'>656</span>            SELECT *
</div><div class='line not-executable'><span class='num'>657</span>            FROM audit
</div><div class='line not-executable'><span class='num'>658</span>            ORDER BY created_at DESC
</div><div class='line not-executable'><span class='num'>659</span>            LIMIT :limit
</div><div class='line not-executable'><span class='num'>660</span>        &quot;);
</div><div class='line not-covered'><span class='num'>661</span>        $stmt-&gt;bindValue(&#039;:limit&#039;, (int)$limit, PDO::PARAM_INT);
</div><div class='line not-covered'><span class='num'>662</span>        $stmt-&gt;execute();
</div><div class='line not-covered'><span class='num'>663</span>        $rows = $stmt-&gt;fetchAll();
</div><div class='line not-covered'><span class='num'>664</span>        return $rows;
</div><div class='line not-covered'><span class='num'>665</span>    }
</div><div class='line not-executable'><span class='num'>666</span>
</div><div class='line not-executable'><span class='num'>667</span>    public function insertAuditLog(string $entity_type, string $entity_id, string $action, ?array $old_data = null, ?array $new_data = null, string $user_id, string $ip_address): bool
</div><div class='line not-executable'><span class='num'>668</span>    {
</div><div class='line not-executable'><span class='num'>669</span>        try {
</div><div class='line covered'><span class='num'>670</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-executable'><span class='num'>671</span>                INSERT INTO audit (entity_type, entity_id, action, old_data, new_data, user_id, ip_address)
</div><div class='line not-executable'><span class='num'>672</span>                VALUES (:entity_type, :entity_id, :action, :old_data, :new_data, :user_id, :ip_address)
</div><div class='line not-executable'><span class='num'>673</span>            &quot;);
</div><div class='line not-executable'><span class='num'>674</span>
</div><div class='line covered'><span class='num'>675</span>            $stmt-&gt;execute([
</div><div class='line covered'><span class='num'>676</span>                &#039;:entity_type&#039; =&gt; $entity_type,
</div><div class='line covered'><span class='num'>677</span>                &#039;:entity_id&#039;   =&gt; $entity_id,
</div><div class='line covered'><span class='num'>678</span>                &#039;:action&#039;      =&gt; $action,
</div><div class='line not-covered'><span class='num'>679</span>                &#039;:old_data&#039;    =&gt; $old_data !== null ? json_encode($old_data, JSON_UNESCAPED_UNICODE) : null,
</div><div class='line covered'><span class='num'>680</span>                &#039;:new_data&#039;    =&gt; $new_data !== null ? json_encode($new_data, JSON_UNESCAPED_UNICODE) : null,
</div><div class='line covered'><span class='num'>681</span>                &#039;:user_id&#039;     =&gt; $user_id,
</div><div class='line covered'><span class='num'>682</span>                &#039;:ip_address&#039;  =&gt; $ip_address
</div><div class='line not-executable'><span class='num'>683</span>            ]);
</div><div class='line covered'><span class='num'>684</span>            return true;
</div><div class='line not-covered'><span class='num'>685</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>686</span>            error_log(&quot;GraphDatabase audit log insert failed: &quot; . $e-&gt;getMessage());
</div><div class='line not-covered'><span class='num'>687</span>            return false;
</div><div class='line not-executable'><span class='num'>688</span>        }
</div><div class='line not-covered'><span class='num'>689</span>    }
</div><div class='line not-executable'><span class='num'>690</span>
</div><div class='line not-executable'><span class='num'>691</span>    private function initSchema(): void
</div><div class='line not-executable'><span class='num'>692</span>    {
</div><div class='line covered'><span class='num'>693</span>        $this-&gt;pdo-&gt;exec(&quot;
</div><div class='line not-executable'><span class='num'>694</span>            CREATE TABLE IF NOT EXISTS users (
</div><div class='line not-executable'><span class='num'>695</span>                id TEXT PRIMARY KEY,
</div><div class='line not-executable'><span class='num'>696</span>                user_group TEXT NOT NULL
</div><div class='line not-executable'><span class='num'>697</span>            )
</div><div class='line not-executable'><span class='num'>698</span>        &quot;);
</div><div class='line not-executable'><span class='num'>699</span>
</div><div class='line covered'><span class='num'>700</span>        $this-&gt;pdo-&gt;exec(&quot;INSERT INTO users VALUES(&#039;admin&#039;, &#039;admin&#039;)&quot;);
</div><div class='line not-executable'><span class='num'>701</span>
</div><div class='line covered'><span class='num'>702</span>        $this-&gt;pdo-&gt;exec(&quot;
</div><div class='line not-executable'><span class='num'>703</span>            CREATE TABLE IF NOT EXISTS nodes (
</div><div class='line not-executable'><span class='num'>704</span>                id TEXT PRIMARY KEY,
</div><div class='line not-executable'><span class='num'>705</span>                label TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>706</span>                category TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>707</span>                type TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>708</span>                data TEXT NOT NULL
</div><div class='line not-executable'><span class='num'>709</span>            )
</div><div class='line not-executable'><span class='num'>710</span>        &quot;);
</div><div class='line not-executable'><span class='num'>711</span>
</div><div class='line covered'><span class='num'>712</span>        $this-&gt;pdo-&gt;exec(&quot;
</div><div class='line not-executable'><span class='num'>713</span>            CREATE TABLE IF NOT EXISTS edges (
</div><div class='line not-executable'><span class='num'>714</span>                id TEXT PRIMARY KEY,
</div><div class='line not-executable'><span class='num'>715</span>                source TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>716</span>                target TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>717</span>                data TEXT,
</div><div class='line not-executable'><span class='num'>718</span>                FOREIGN KEY (source) REFERENCES nodes(id) ON DELETE CASCADE,
</div><div class='line not-executable'><span class='num'>719</span>                FOREIGN KEY (target) REFERENCES nodes(id) ON DELETE CASCADE
</div><div class='line not-executable'><span class='num'>720</span>            )
</div><div class='line not-executable'><span class='num'>721</span>        &quot;);
</div><div class='line not-executable'><span class='num'>722</span>
</div><div class='line covered'><span class='num'>723</span>        $this-&gt;pdo-&gt;exec(&quot;CREATE UNIQUE INDEX IF NOT EXISTS idx_edges_source_target ON edges (source, target)&quot;);
</div><div class='line not-executable'><span class='num'>724</span>
</div><div class='line covered'><span class='num'>725</span>        $this-&gt;pdo-&gt;exec(&quot;
</div><div class='line not-executable'><span class='num'>726</span>            CREATE TABLE IF NOT EXISTS status (
</div><div class='line not-executable'><span class='num'>727</span>                node_id TEXT PRIMARY KEY NOT NULL,
</div><div class='line not-executable'><span class='num'>728</span>                status TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>729</span>                created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
</div><div class='line not-executable'><span class='num'>730</span>                FOREIGN KEY (node_id) REFERENCES nodes(id) ON DELETE CASCADE
</div><div class='line not-executable'><span class='num'>731</span>            )
</div><div class='line not-executable'><span class='num'>732</span>        &quot;);
</div><div class='line not-executable'><span class='num'>733</span>
</div><div class='line covered'><span class='num'>734</span>        $this-&gt;pdo-&gt;exec(&quot;CREATE INDEX IF NOT EXISTS idx_node_status_node_id ON status (node_id)&quot;);
</div><div class='line not-executable'><span class='num'>735</span>
</div><div class='line covered'><span class='num'>736</span>        $this-&gt;pdo-&gt;exec(&quot;
</div><div class='line not-executable'><span class='num'>737</span>            CREATE TABLE IF NOT EXISTS audit (
</div><div class='line not-executable'><span class='num'>738</span>                id INTEGER PRIMARY KEY AUTOINCREMENT,
</div><div class='line not-executable'><span class='num'>739</span>                entity_type TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>740</span>                entity_id TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>741</span>                action TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>742</span>                old_data TEXT,
</div><div class='line not-executable'><span class='num'>743</span>                new_data TEXT,
</div><div class='line not-executable'><span class='num'>744</span>                user_id TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>745</span>                ip_address TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>746</span>                created_at DATETIME DEFAULT CURRENT_TIMESTAMP
</div><div class='line not-executable'><span class='num'>747</span>            )
</div><div class='line not-executable'><span class='num'>748</span>        &quot;);
</div><div class='line covered'><span class='num'>749</span>    }
</div><div class='line not-executable'><span class='num'>750</span>
</div><div class='line not-executable'><span class='num'>751</span>    public static function createConnection(string $dsn): PDO
</div><div class='line not-executable'><span class='num'>752</span>    {
</div><div class='line covered'><span class='num'>753</span>        $pdo = new PDO($dsn);
</div><div class='line covered'><span class='num'>754</span>        $pdo-&gt;setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
</div><div class='line covered'><span class='num'>755</span>        $pdo-&gt;setAttribute(PDO::ATTR_DEFAULT_FETCH_MODE, PDO::FETCH_ASSOC);
</div><div class='line covered'><span class='num'>756</span>        $pdo-&gt;exec(&#039;PRAGMA foreign_keys = ON&#039;);
</div><div class='line covered'><span class='num'>757</span>        return $pdo;
</div><div class='line not-covered'><span class='num'>758</span>    }
</div><div class='line not-executable'><span class='num'>759</span>}
</div><div class='line not-executable'><span class='num'>760</span>
</div><div class='line not-executable'><span class='num'>761</span>final class GraphServiceException extends RuntimeException
</div><div class='line not-executable'><span class='num'>762</span>{
</div><div class='line not-executable'><span class='num'>763</span>}
</div><div class='line not-executable'><span class='num'>764</span>
</div><div class='line not-executable'><span class='num'>765</span>interface GraphServiceInterface
</div><div class='line not-executable'><span class='num'>766</span>{
</div><div class='line not-executable'><span class='num'>767</span>    public function getUser(string $id): ?User;
</div><div class='line not-executable'><span class='num'>768</span>    public function insertUser(User $user): void;
</div><div class='line not-executable'><span class='num'>769</span>    public function updateUser(User $user): void;
</div><div class='line not-executable'><span class='num'>770</span>
</div><div class='line not-executable'><span class='num'>771</span>    public function getGraph(): Graph;
</div><div class='line not-executable'><span class='num'>772</span>
</div><div class='line not-executable'><span class='num'>773</span>    public function getNode(string $id): ?Node;
</div><div class='line not-executable'><span class='num'>774</span>    public function getNodes(): Nodes;
</div><div class='line not-executable'><span class='num'>775</span>    public function insertNode(Node $node): void;
</div><div class='line not-executable'><span class='num'>776</span>    public function updateNode(Node $node): void;
</div><div class='line not-executable'><span class='num'>777</span>    public function deleteNode(string $id): void;
</div><div class='line not-executable'><span class='num'>778</span>
</div><div class='line not-executable'><span class='num'>779</span>    public function getEdge(string $source, string $target): ?Edge;
</div><div class='line not-executable'><span class='num'>780</span>    public function getEdges(): Edges;
</div><div class='line not-executable'><span class='num'>781</span>    public function insertEdge(Edge $edge): void;
</div><div class='line not-executable'><span class='num'>782</span>    public function updateEdge(Edge $edge): void;
</div><div class='line not-executable'><span class='num'>783</span>    public function deleteEdge(string $id): void;
</div><div class='line not-executable'><span class='num'>784</span>
</div><div class='line not-executable'><span class='num'>785</span>    public function getStatuses(): NodeStatuses;
</div><div class='line not-executable'><span class='num'>786</span>    public function getNodeStatus(string $id): NodeStatus;
</div><div class='line not-executable'><span class='num'>787</span>    public function setNodeStatus(NodeStatus $status): void;
</div><div class='line not-executable'><span class='num'>788</span>
</div><div class='line not-executable'><span class='num'>789</span>    public function getLogs($limit): AuditLogs;
</div><div class='line not-executable'><span class='num'>790</span>}
</div><div class='line not-executable'><span class='num'>791</span>
</div><div class='line not-executable'><span class='num'>792</span>final class GraphService implements GraphServiceInterface
</div><div class='line not-executable'><span class='num'>793</span>{
</div><div class='line not-executable'><span class='num'>794</span>    private const SECURE_ACTIONS = [
</div><div class='line not-executable'><span class='num'>795</span>        &#039;GraphService::getGraph&#039;      =&gt; true,
</div><div class='line not-executable'><span class='num'>796</span>        &#039;GraphService::getNode&#039;       =&gt; true,
</div><div class='line not-executable'><span class='num'>797</span>        &#039;GraphService::getNodes&#039;      =&gt; true,
</div><div class='line not-executable'><span class='num'>798</span>        &#039;GraphService::getEdge&#039;       =&gt; true,
</div><div class='line not-executable'><span class='num'>799</span>        &#039;GraphService::getEdges&#039;      =&gt; true,
</div><div class='line not-executable'><span class='num'>800</span>        &#039;GraphService::getStatuses&#039;   =&gt; true,
</div><div class='line not-executable'><span class='num'>801</span>        &#039;GraphService::getNodeStatus&#039; =&gt; true,
</div><div class='line not-executable'><span class='num'>802</span>        &#039;GraphService::setNodeStatus&#039; =&gt; true,
</div><div class='line not-executable'><span class='num'>803</span>        &#039;GraphService::getLogs&#039;       =&gt; true,
</div><div class='line not-executable'><span class='num'>804</span>        &#039;GraphService::insertNode&#039;    =&gt; false,
</div><div class='line not-executable'><span class='num'>805</span>        &#039;GraphService::updateNode&#039;    =&gt; false,
</div><div class='line not-executable'><span class='num'>806</span>        &#039;GraphService::deleteNode&#039;    =&gt; false,
</div><div class='line not-executable'><span class='num'>807</span>        &#039;GraphService::insertEdge&#039;    =&gt; false,
</div><div class='line not-executable'><span class='num'>808</span>        &#039;GraphService::updateEdge&#039;    =&gt; false,
</div><div class='line not-executable'><span class='num'>809</span>        &#039;GraphService::deleteEdge&#039;    =&gt; false,
</div><div class='line not-executable'><span class='num'>810</span>
</div><div class='line not-executable'><span class='num'>811</span>        &#039;GraphService::insertAuditLog&#039; =&gt; false,
</div><div class='line not-executable'><span class='num'>812</span>    ];
</div><div class='line not-executable'><span class='num'>813</span>
</div><div class='line not-executable'><span class='num'>814</span>    private GraphDatabaseInterface $db;
</div><div class='line not-executable'><span class='num'>815</span>    private Logger $logger;
</div><div class='line not-executable'><span class='num'>816</span>
</div><div class='line not-executable'><span class='num'>817</span>    public function __construct(GraphDatabaseInterface $db, Logger $logger)
</div><div class='line not-executable'><span class='num'>818</span>    {
</div><div class='line covered'><span class='num'>819</span>        $this-&gt;db = $db;
</div><div class='line covered'><span class='num'>820</span>        $this-&gt;logger = $logger;
</div><div class='line covered'><span class='num'>821</span>    }
</div><div class='line not-executable'><span class='num'>822</span>
</div><div class='line not-executable'><span class='num'>823</span>    public function getUser(string $id): ?User
</div><div class='line not-executable'><span class='num'>824</span>    {
</div><div class='line not-covered'><span class='num'>825</span>        $data = $this-&gt;db-&gt;getUser($id);
</div><div class='line not-covered'><span class='num'>826</span>        if ($data) {
</div><div class='line not-covered'><span class='num'>827</span>            $user = new User($id, null, $data[&#039;user_group&#039;]);
</div><div class='line not-covered'><span class='num'>828</span>            return $user;
</div><div class='line not-executable'><span class='num'>829</span>        }
</div><div class='line not-covered'><span class='num'>830</span>        return null;
</div><div class='line not-covered'><span class='num'>831</span>    }
</div><div class='line not-executable'><span class='num'>832</span>
</div><div class='line not-executable'><span class='num'>833</span>    public function insertUser(User $user): void
</div><div class='line not-executable'><span class='num'>834</span>    {
</div><div class='line not-covered'><span class='num'>835</span>        $this-&gt;db-&gt;insertUser($user-&gt;id, $user-&gt;group-&gt;id);
</div><div class='line not-covered'><span class='num'>836</span>    }
</div><div class='line not-executable'><span class='num'>837</span>
</div><div class='line not-executable'><span class='num'>838</span>    public function updateUser(User $user): void
</div><div class='line not-executable'><span class='num'>839</span>    {
</div><div class='line not-covered'><span class='num'>840</span>        $this-&gt;db-&gt;updateUser($user-&gt;id, $user-&gt;group-&gt;id);
</div><div class='line not-covered'><span class='num'>841</span>    }
</div><div class='line not-executable'><span class='num'>842</span>
</div><div class='line not-executable'><span class='num'>843</span>    public function getGraph(): Graph
</div><div class='line not-executable'><span class='num'>844</span>    {
</div><div class='line not-covered'><span class='num'>845</span>        $nodes = $this-&gt;getNodes()-&gt;nodes;
</div><div class='line not-covered'><span class='num'>846</span>        $edges = $this-&gt;getEdges()-&gt;edges;
</div><div class='line not-covered'><span class='num'>847</span>        return new Graph($nodes, $edges);
</div><div class='line not-covered'><span class='num'>848</span>    }
</div><div class='line not-executable'><span class='num'>849</span>
</div><div class='line not-executable'><span class='num'>850</span>    public function getNode(string $id): ?Node
</div><div class='line not-executable'><span class='num'>851</span>    {
</div><div class='line covered'><span class='num'>852</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>853</span>            throw new RuntimeException(&quot;Permission denied to get node.&quot;);
</div><div class='line not-executable'><span class='num'>854</span>        }
</div><div class='line not-executable'><span class='num'>855</span>
</div><div class='line covered'><span class='num'>856</span>        $data = $this-&gt;db-&gt;getNode($id);
</div><div class='line covered'><span class='num'>857</span>        if ($data) {
</div><div class='line covered'><span class='num'>858</span>            return new Node(
</div><div class='line covered'><span class='num'>859</span>                $data[&#039;id&#039;],
</div><div class='line covered'><span class='num'>860</span>                $data[&#039;label&#039;],
</div><div class='line covered'><span class='num'>861</span>                $data[&#039;category&#039;],
</div><div class='line covered'><span class='num'>862</span>                $data[&#039;type&#039;],
</div><div class='line covered'><span class='num'>863</span>                json_decode($data[&#039;data&#039;], true)
</div><div class='line not-executable'><span class='num'>864</span>            );
</div><div class='line not-executable'><span class='num'>865</span>        }
</div><div class='line not-covered'><span class='num'>866</span>        return null;
</div><div class='line not-covered'><span class='num'>867</span>    }
</div><div class='line not-executable'><span class='num'>868</span>
</div><div class='line not-executable'><span class='num'>869</span>    public function getNodes(): Nodes
</div><div class='line not-executable'><span class='num'>870</span>    {
</div><div class='line not-covered'><span class='num'>871</span>        if(! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>872</span>            throw new RuntimeException(&quot;Permission denied to get nodes.&quot;);
</div><div class='line not-executable'><span class='num'>873</span>        }
</div><div class='line not-executable'><span class='num'>874</span>
</div><div class='line not-covered'><span class='num'>875</span>        $nodesData = $this-&gt;db-&gt;getNodes();
</div><div class='line not-covered'><span class='num'>876</span>        $nodes     = new Nodes();
</div><div class='line not-covered'><span class='num'>877</span>        foreach ($nodesData as $data) {
</div><div class='line not-covered'><span class='num'>878</span>            $node = new Node(
</div><div class='line not-covered'><span class='num'>879</span>                $data[&#039;id&#039;],
</div><div class='line not-covered'><span class='num'>880</span>                $data[&#039;label&#039;],
</div><div class='line not-covered'><span class='num'>881</span>                $data[&#039;category&#039;],
</div><div class='line not-covered'><span class='num'>882</span>                $data[&#039;type&#039;],
</div><div class='line not-covered'><span class='num'>883</span>                json_decode($data[&#039;data&#039;], true)
</div><div class='line not-executable'><span class='num'>884</span>            );
</div><div class='line not-covered'><span class='num'>885</span>            $nodes-&gt;addNode($node);
</div><div class='line not-executable'><span class='num'>886</span>        }
</div><div class='line not-covered'><span class='num'>887</span>        return $nodes;
</div><div class='line not-covered'><span class='num'>888</span>    }
</div><div class='line not-executable'><span class='num'>889</span>
</div><div class='line not-executable'><span class='num'>890</span>    public function insertNode(Node $node): void
</div><div class='line not-executable'><span class='num'>891</span>    {
</div><div class='line covered'><span class='num'>892</span>        $this-&gt;logger-&gt;debug(&#039;inserting node&#039;, $node-&gt;toArray());
</div><div class='line not-executable'><span class='num'>893</span>
</div><div class='line covered'><span class='num'>894</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>895</span>            $this-&gt;logger-&gt;info(&#039;permission denied&#039;, $node-&gt;toArray());
</div><div class='line not-covered'><span class='num'>896</span>            throw new GraphServiceException(&#039;permission denied&#039;);
</div><div class='line not-executable'><span class='num'>897</span>        }
</div><div class='line not-executable'><span class='num'>898</span>
</div><div class='line covered'><span class='num'>899</span>        $this-&gt;logger-&gt;info(&#039;permission allowed&#039;, $node-&gt;toArray());
</div><div class='line not-executable'><span class='num'>900</span>
</div><div class='line covered'><span class='num'>901</span>        $this-&gt;insertAuditLog(new AuditLog( &#039;node&#039;, $node-&gt;id, &#039;insert&#039;, null, $node-&gt;toArray()));
</div><div class='line not-executable'><span class='num'>902</span>
</div><div class='line covered'><span class='num'>903</span>        $this-&gt;db-&gt;insertNode(
</div><div class='line covered'><span class='num'>904</span>            $node-&gt;id,
</div><div class='line covered'><span class='num'>905</span>            $node-&gt;label,
</div><div class='line covered'><span class='num'>906</span>            $node-&gt;category,
</div><div class='line covered'><span class='num'>907</span>            $node-&gt;type,
</div><div class='line covered'><span class='num'>908</span>            $node-&gt;data
</div><div class='line not-executable'><span class='num'>909</span>        );
</div><div class='line covered'><span class='num'>910</span>    }
</div><div class='line not-executable'><span class='num'>911</span>
</div><div class='line not-executable'><span class='num'>912</span>    public function updateNode(Node $node): void
</div><div class='line not-executable'><span class='num'>913</span>    {
</div><div class='line not-covered'><span class='num'>914</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>915</span>            throw new RuntimeException(&quot;Permission denied to update node.&quot;);
</div><div class='line not-executable'><span class='num'>916</span>        }
</div><div class='line not-executable'><span class='num'>917</span>
</div><div class='line not-covered'><span class='num'>918</span>        $old = $this-&gt;getNode($node-&gt;id);
</div><div class='line not-covered'><span class='num'>919</span>        $this-&gt;insertAuditLog(new AuditLog( &#039;node&#039;, $node-&gt;id, &#039;update&#039;, $old-&gt;toArray(), $node-&gt;toArray()));
</div><div class='line not-executable'><span class='num'>920</span>
</div><div class='line not-covered'><span class='num'>921</span>        $this-&gt;db-&gt;updateNode(
</div><div class='line not-covered'><span class='num'>922</span>            $node-&gt;id,
</div><div class='line not-covered'><span class='num'>923</span>            $node-&gt;label,
</div><div class='line not-covered'><span class='num'>924</span>            $node-&gt;category,
</div><div class='line not-covered'><span class='num'>925</span>            $node-&gt;type,
</div><div class='line not-covered'><span class='num'>926</span>            $node-&gt;data
</div><div class='line not-executable'><span class='num'>927</span>        );
</div><div class='line not-covered'><span class='num'>928</span>    }
</div><div class='line not-executable'><span class='num'>929</span>
</div><div class='line not-executable'><span class='num'>930</span>    public function deleteNode(string $id): void
</div><div class='line not-executable'><span class='num'>931</span>    {
</div><div class='line not-covered'><span class='num'>932</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>933</span>            throw new RuntimeException(&quot;Permission denied to delete node.&quot;);
</div><div class='line not-executable'><span class='num'>934</span>        }
</div><div class='line not-executable'><span class='num'>935</span>
</div><div class='line not-covered'><span class='num'>936</span>        $old = $this-&gt;getNode($id);
</div><div class='line not-covered'><span class='num'>937</span>        $this-&gt;insertAuditLog(new AuditLog( &#039;node&#039;, $id, &#039;delete&#039;, $old-&gt;toArray(), null));
</div><div class='line not-covered'><span class='num'>938</span>        $this-&gt;db-&gt;deleteNode($id);
</div><div class='line not-covered'><span class='num'>939</span>    }
</div><div class='line not-executable'><span class='num'>940</span>
</div><div class='line not-executable'><span class='num'>941</span>    public function getEdge(string $source, string $target): ?Edge
</div><div class='line not-executable'><span class='num'>942</span>    {
</div><div class='line not-covered'><span class='num'>943</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>944</span>            throw new RuntimeException(&quot;Permission denied to get edge.&quot;);
</div><div class='line not-executable'><span class='num'>945</span>        }
</div><div class='line not-executable'><span class='num'>946</span>
</div><div class='line not-covered'><span class='num'>947</span>        $edgesData = $this-&gt;db-&gt;getEdges();
</div><div class='line not-covered'><span class='num'>948</span>        foreach ($edgesData as $data) {
</div><div class='line not-covered'><span class='num'>949</span>            if ($data[&#039;source&#039;] === $source &amp;&amp; $data[&#039;target&#039;] === $target) {
</div><div class='line not-covered'><span class='num'>950</span>                return new Edge(
</div><div class='line not-covered'><span class='num'>951</span>                    $data[&#039;id&#039;],
</div><div class='line not-covered'><span class='num'>952</span>                    $data[&#039;source&#039;],
</div><div class='line not-covered'><span class='num'>953</span>                    $data[&#039;target&#039;],
</div><div class='line not-covered'><span class='num'>954</span>                    json_decode($data[&#039;data&#039;], true)
</div><div class='line not-executable'><span class='num'>955</span>                );
</div><div class='line not-executable'><span class='num'>956</span>            }
</div><div class='line not-executable'><span class='num'>957</span>        }
</div><div class='line not-covered'><span class='num'>958</span>        return null;
</div><div class='line not-covered'><span class='num'>959</span>    }
</div><div class='line not-executable'><span class='num'>960</span>
</div><div class='line not-executable'><span class='num'>961</span>    public function getEdges(): Edges
</div><div class='line not-executable'><span class='num'>962</span>    {
</div><div class='line not-covered'><span class='num'>963</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>964</span>            throw new RuntimeException(&quot;Permission denied to get edges.&quot;);
</div><div class='line not-executable'><span class='num'>965</span>        }
</div><div class='line not-covered'><span class='num'>966</span>        $edgesData = $this-&gt;db-&gt;getEdges();
</div><div class='line not-covered'><span class='num'>967</span>        $edges     = new Edges();
</div><div class='line not-covered'><span class='num'>968</span>        foreach ($edgesData as $data) {
</div><div class='line not-covered'><span class='num'>969</span>            $edge = new Edge(
</div><div class='line not-covered'><span class='num'>970</span>                $data[&#039;id&#039;],
</div><div class='line not-covered'><span class='num'>971</span>                $data[&#039;source&#039;],
</div><div class='line not-covered'><span class='num'>972</span>                $data[&#039;target&#039;],
</div><div class='line not-covered'><span class='num'>973</span>                json_decode($data[&#039;data&#039;], true)
</div><div class='line not-executable'><span class='num'>974</span>            );
</div><div class='line not-covered'><span class='num'>975</span>            $edges-&gt;addEdge($edge);
</div><div class='line not-executable'><span class='num'>976</span>        }
</div><div class='line not-covered'><span class='num'>977</span>        return $edges;
</div><div class='line not-covered'><span class='num'>978</span>    }
</div><div class='line not-executable'><span class='num'>979</span>
</div><div class='line not-executable'><span class='num'>980</span>    public function insertEdge(Edge $edge): void
</div><div class='line not-executable'><span class='num'>981</span>    {
</div><div class='line covered'><span class='num'>982</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>983</span>            throw new RuntimeException(&quot;Permission denied to insert edge.&quot;);
</div><div class='line not-executable'><span class='num'>984</span>        }
</div><div class='line covered'><span class='num'>985</span>        $this-&gt;insertAuditLog(new AuditLog( &#039;edge&#039;, $edge-&gt;id, &#039;insert&#039;, null, $edge-&gt;toArray()));
</div><div class='line covered'><span class='num'>986</span>        $this-&gt;db-&gt;insertEdge(
</div><div class='line covered'><span class='num'>987</span>            $edge-&gt;id,
</div><div class='line covered'><span class='num'>988</span>            $edge-&gt;source,
</div><div class='line covered'><span class='num'>989</span>            $edge-&gt;target,
</div><div class='line covered'><span class='num'>990</span>            $edge-&gt;data
</div><div class='line not-executable'><span class='num'>991</span>        );
</div><div class='line covered'><span class='num'>992</span>    }
</div><div class='line not-executable'><span class='num'>993</span>
</div><div class='line not-executable'><span class='num'>994</span>    public function updateEdge(Edge $edge): void
</div><div class='line not-executable'><span class='num'>995</span>    {
</div><div class='line not-covered'><span class='num'>996</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>997</span>            throw new RuntimeException(&quot;Permission denied to update edge.&quot;);
</div><div class='line not-executable'><span class='num'>998</span>        }
</div><div class='line not-covered'><span class='num'>999</span>        $old = $this-&gt;getEdge($edge-&gt;source, $edge-&gt;target);
</div><div class='line not-covered'><span class='num'>1000</span>        $this-&gt;insertAuditLog(new AuditLog( &#039;edge&#039;, $edge-&gt;id, &#039;update&#039;, $old-&gt;toArray(), $edge-&gt;toArray()));
</div><div class='line not-executable'><span class='num'>1001</span>
</div><div class='line not-covered'><span class='num'>1002</span>        $this-&gt;db-&gt;updateEdge(
</div><div class='line not-covered'><span class='num'>1003</span>            $edge-&gt;id,
</div><div class='line not-covered'><span class='num'>1004</span>            $edge-&gt;source,
</div><div class='line not-covered'><span class='num'>1005</span>            $edge-&gt;target,
</div><div class='line not-covered'><span class='num'>1006</span>            $edge-&gt;data
</div><div class='line not-executable'><span class='num'>1007</span>        );
</div><div class='line not-covered'><span class='num'>1008</span>    }
</div><div class='line not-executable'><span class='num'>1009</span>
</div><div class='line not-executable'><span class='num'>1010</span>    public function deleteEdge(string $id): void
</div><div class='line not-executable'><span class='num'>1011</span>    {
</div><div class='line not-covered'><span class='num'>1012</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>1013</span>            throw new RuntimeException(&quot;Permission denied to delete edge.&quot;);
</div><div class='line not-executable'><span class='num'>1014</span>        }
</div><div class='line not-covered'><span class='num'>1015</span>        $this-&gt;db-&gt;deleteEdge($id);
</div><div class='line not-covered'><span class='num'>1016</span>    }
</div><div class='line not-executable'><span class='num'>1017</span>
</div><div class='line not-executable'><span class='num'>1018</span>    public function getStatuses(): NodeStatuses
</div><div class='line not-executable'><span class='num'>1019</span>    {
</div><div class='line not-covered'><span class='num'>1020</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>1021</span>            throw new RuntimeException(&quot;Permission denied to get statuses.&quot;);
</div><div class='line not-executable'><span class='num'>1022</span>        }
</div><div class='line not-executable'><span class='num'>1023</span>
</div><div class='line not-covered'><span class='num'>1024</span>        $statusesData = $this-&gt;db-&gt;getStatuses();
</div><div class='line not-covered'><span class='num'>1025</span>        $nodeStatuses = new NodeStatuses();
</div><div class='line not-covered'><span class='num'>1026</span>        foreach ($statusesData as $data) {
</div><div class='line not-covered'><span class='num'>1027</span>            $status = new NodeStatus(
</div><div class='line not-covered'><span class='num'>1028</span>                $data[&#039;id&#039;],
</div><div class='line not-covered'><span class='num'>1029</span>                $data[&#039;status&#039;] ?? &#039;unknown&#039;
</div><div class='line not-executable'><span class='num'>1030</span>            );
</div><div class='line not-covered'><span class='num'>1031</span>            $nodeStatuses-&gt;addStatus($status);
</div><div class='line not-executable'><span class='num'>1032</span>        }
</div><div class='line not-covered'><span class='num'>1033</span>        return $nodeStatuses;
</div><div class='line not-covered'><span class='num'>1034</span>    }
</div><div class='line not-executable'><span class='num'>1035</span>
</div><div class='line not-executable'><span class='num'>1036</span>    public function getNodeStatus(string $id): NodeStatus
</div><div class='line not-executable'><span class='num'>1037</span>    {
</div><div class='line not-covered'><span class='num'>1038</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>1039</span>            throw new RuntimeException(&quot;Permission denied to get node status.&quot;);
</div><div class='line not-executable'><span class='num'>1040</span>        }
</div><div class='line not-executable'><span class='num'>1041</span>
</div><div class='line not-covered'><span class='num'>1042</span>        $statusData = $this-&gt;db-&gt;getNodeStatus($id);
</div><div class='line not-covered'><span class='num'>1043</span>        return new NodeStatus(
</div><div class='line not-covered'><span class='num'>1044</span>            $id,
</div><div class='line not-covered'><span class='num'>1045</span>            $statusData ?? &#039;unknown&#039;
</div><div class='line not-executable'><span class='num'>1046</span>        );
</div><div class='line not-covered'><span class='num'>1047</span>    }
</div><div class='line not-executable'><span class='num'>1048</span>
</div><div class='line not-executable'><span class='num'>1049</span>    public function setNodeStatus(NodeStatus $status): void
</div><div class='line not-executable'><span class='num'>1050</span>    {
</div><div class='line not-covered'><span class='num'>1051</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>1052</span>            throw new RuntimeException(&quot;Permission denied to set node status.&quot;);
</div><div class='line not-executable'><span class='num'>1053</span>        }
</div><div class='line not-executable'><span class='num'>1054</span>
</div><div class='line not-covered'><span class='num'>1055</span>        $this-&gt;db-&gt;setNodeStatus($status-&gt;nodeId, $status-&gt;status);
</div><div class='line not-covered'><span class='num'>1056</span>    }
</div><div class='line not-executable'><span class='num'>1057</span>
</div><div class='line not-executable'><span class='num'>1058</span>    public function getLogs($limit): AuditLogs
</div><div class='line not-executable'><span class='num'>1059</span>    {
</div><div class='line not-covered'><span class='num'>1060</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>1061</span>            throw new RuntimeException(&quot;Permission denied to get audit logs.&quot;);
</div><div class='line not-executable'><span class='num'>1062</span>        }
</div><div class='line not-executable'><span class='num'>1063</span>
</div><div class='line not-covered'><span class='num'>1064</span>        $logs = new AuditLogs();
</div><div class='line not-covered'><span class='num'>1065</span>        $rows = $this-&gt;db-&gt;getLogs($limit);
</div><div class='line not-covered'><span class='num'>1066</span>        foreach ($rows as $row) {
</div><div class='line not-covered'><span class='num'>1067</span>            $old_data = $row[&#039;old_data&#039;] ? json_decode($row[&#039;old_data&#039;], true) : [];
</div><div class='line not-covered'><span class='num'>1068</span>            $new_data = $row[&#039;new_data&#039;] ?  json_decode($row[&#039;new_data&#039;], true) : [];
</div><div class='line not-covered'><span class='num'>1069</span>            $log = new AuditLog(
</div><div class='line not-covered'><span class='num'>1070</span>                $row[&#039;entity_type&#039;],
</div><div class='line not-covered'><span class='num'>1071</span>                $row[&#039;entity_id&#039;],
</div><div class='line not-covered'><span class='num'>1072</span>                $row[&#039;action&#039;],
</div><div class='line not-executable'><span class='num'>1073</span>                $old_data,
</div><div class='line not-executable'><span class='num'>1074</span>                $new_data,
</div><div class='line not-executable'><span class='num'>1075</span>            );
</div><div class='line not-covered'><span class='num'>1076</span>            $log-&gt;userId    = $row[&#039;user_id&#039;];
</div><div class='line not-covered'><span class='num'>1077</span>            $log-&gt;ipAddress = $row[&#039;ip_address&#039;];
</div><div class='line not-covered'><span class='num'>1078</span>            $log-&gt;createdAt = $row[&#039;created_at&#039;];
</div><div class='line not-executable'><span class='num'>1079</span>
</div><div class='line not-covered'><span class='num'>1080</span>            $logs-&gt;addLog($log);
</div><div class='line not-executable'><span class='num'>1081</span>        }
</div><div class='line not-covered'><span class='num'>1082</span>        return $logs;
</div><div class='line not-covered'><span class='num'>1083</span>    }
</div><div class='line not-executable'><span class='num'>1084</span>
</div><div class='line not-executable'><span class='num'>1085</span>    private function insertAuditLog(AuditLog $auditLog): void
</div><div class='line not-executable'><span class='num'>1086</span>    {
</div><div class='line covered'><span class='num'>1087</span>        $user_id   = GraphContext::$user-&gt;id;
</div><div class='line covered'><span class='num'>1088</span>        $ip_address = GraphContext::$user-&gt;ipAddress;
</div><div class='line not-executable'><span class='num'>1089</span>
</div><div class='line covered'><span class='num'>1090</span>        $this-&gt;db-&gt;insertAuditLog(
</div><div class='line covered'><span class='num'>1091</span>            $auditLog-&gt;entityType,
</div><div class='line covered'><span class='num'>1092</span>            $auditLog-&gt;entityId,
</div><div class='line covered'><span class='num'>1093</span>            $auditLog-&gt;action,
</div><div class='line covered'><span class='num'>1094</span>            $auditLog-&gt;oldData,
</div><div class='line covered'><span class='num'>1095</span>            $auditLog-&gt;newData,
</div><div class='line not-executable'><span class='num'>1096</span>            $user_id,
</div><div class='line not-executable'><span class='num'>1097</span>            $ip_address
</div><div class='line not-executable'><span class='num'>1098</span>        );
</div><div class='line covered'><span class='num'>1099</span>    }
</div><div class='line not-executable'><span class='num'>1100</span>
</div><div class='line not-executable'><span class='num'>1101</span>    private function isAllowed(string $action): bool
</div><div class='line not-executable'><span class='num'>1102</span>    {
</div><div class='line covered'><span class='num'>1103</span>        $group = GraphContext::$user-&gt;group;
</div><div class='line not-executable'><span class='num'>1104</span>
</div><div class='line not-executable'><span class='num'>1105</span>        // validate action
</div><div class='line not-executable'><span class='num'>1106</span>        // if action is one of the keys in the array self::SECURE_ACTIONS
</div><div class='line covered'><span class='num'>1107</span>        if (!array_key_exists($action, self::SECURE_ACTIONS)) {
</div><div class='line not-covered'><span class='num'>1108</span>            throw new RuntimeException(&quot;Action not defined in secure actions. Action: {$action}&quot;);
</div><div class='line not-executable'><span class='num'>1109</span>        }
</div><div class='line not-executable'><span class='num'>1110</span>
</div><div class='line not-executable'><span class='num'>1111</span>        // if is admin, allow all
</div><div class='line covered'><span class='num'>1112</span>        if ($group-&gt;id === &#039;admin&#039;) {
</div><div class='line not-covered'><span class='num'>1113</span>            return true;
</div><div class='line not-executable'><span class='num'>1114</span>        }
</div><div class='line not-executable'><span class='num'>1115</span>
</div><div class='line not-executable'><span class='num'>1116</span>        // if action is in the SAFE_ACTIONS, allow all
</div><div class='line covered'><span class='num'>1117</span>        if (self::SECURE_ACTIONS[$action]) {
</div><div class='line covered'><span class='num'>1118</span>            return true;
</div><div class='line not-executable'><span class='num'>1119</span>        }
</div><div class='line not-executable'><span class='num'>1120</span>        
</div><div class='line not-executable'><span class='num'>1121</span>        // if action is restricted, only allow contributor
</div><div class='line covered'><span class='num'>1122</span>        if (self::SECURE_ACTIONS[$action] == false &amp;&amp; $group-&gt;id == &#039;contributor&#039;)
</div><div class='line not-executable'><span class='num'>1123</span>        {
</div><div class='line covered'><span class='num'>1124</span>            return true;
</div><div class='line not-executable'><span class='num'>1125</span>        }
</div><div class='line not-executable'><span class='num'>1126</span>
</div><div class='line not-covered'><span class='num'>1127</span>        return false;
</div><div class='line not-covered'><span class='num'>1128</span>    }
</div><div class='line not-executable'><span class='num'>1129</span>}
</div><div class='line not-executable'><span class='num'>1130</span>
</div><div class='line not-executable'><span class='num'>1131</span>final class Request
</div><div class='line not-executable'><span class='num'>1132</span>{
</div><div class='line not-executable'><span class='num'>1133</span>    public array $data;
</div><div class='line not-executable'><span class='num'>1134</span>
</div><div class='line not-executable'><span class='num'>1135</span>    public function getParam($name): string
</div><div class='line not-executable'><span class='num'>1136</span>    {
</div><div class='line covered'><span class='num'>1137</span>        if(isset($_GET[$name])) {
</div><div class='line covered'><span class='num'>1138</span>            return $_GET[$name];
</div><div class='line not-executable'><span class='num'>1139</span>        }
</div><div class='line not-executable'><span class='num'>1140</span>
</div><div class='line not-covered'><span class='num'>1141</span>        throw new RuntimeException(&quot;param &#039;{$name}&#039; not found&quot;);
</div><div class='line not-covered'><span class='num'>1142</span>    }
</div><div class='line not-executable'><span class='num'>1143</span>
</div><div class='line not-executable'><span class='num'>1144</span>    public function getPath(): string
</div><div class='line not-executable'><span class='num'>1145</span>    {
</div><div class='line not-covered'><span class='num'>1146</span>        $scriptName = $_SERVER[&#039;SCRIPT_NAME&#039;];
</div><div class='line not-covered'><span class='num'>1147</span>        $requestUri = $_SERVER[&#039;REQUEST_URI&#039;];
</div><div class='line not-covered'><span class='num'>1148</span>        $requestUri = strtok($requestUri, &#039;?&#039;);
</div><div class='line not-covered'><span class='num'>1149</span>        $path = str_replace($scriptName, &#039;&#039;, $requestUri);
</div><div class='line not-covered'><span class='num'>1150</span>        return $path;
</div><div class='line not-covered'><span class='num'>1151</span>    }
</div><div class='line not-executable'><span class='num'>1152</span>}
</div><div class='line not-executable'><span class='num'>1153</span>
</div><div class='line not-executable'><span class='num'>1154</span>interface ResponseInterface
</div><div class='line not-executable'><span class='num'>1155</span>{
</div><div class='line not-executable'><span class='num'>1156</span>    public function send(): void;
</div><div class='line not-executable'><span class='num'>1157</span>}
</div><div class='line not-executable'><span class='num'>1158</span>
</div><div class='line not-executable'><span class='num'>1159</span>class Response implements ResponseInterface
</div><div class='line not-executable'><span class='num'>1160</span>{
</div><div class='line not-executable'><span class='num'>1161</span>    public int $code;
</div><div class='line not-executable'><span class='num'>1162</span>    public string $status;
</div><div class='line not-executable'><span class='num'>1163</span>    public string $message;
</div><div class='line not-executable'><span class='num'>1164</span>    public array $data;
</div><div class='line not-executable'><span class='num'>1165</span>
</div><div class='line not-executable'><span class='num'>1166</span>    public function __construct(int $code, string $status, string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1167</span>    {
</div><div class='line covered'><span class='num'>1168</span>        $this-&gt;code = $code;
</div><div class='line covered'><span class='num'>1169</span>        $this-&gt;status = $status;
</div><div class='line covered'><span class='num'>1170</span>        $this-&gt;message = $message;
</div><div class='line covered'><span class='num'>1171</span>        $this-&gt;data = $data;
</div><div class='line covered'><span class='num'>1172</span>    }
</div><div class='line not-executable'><span class='num'>1173</span>
</div><div class='line not-executable'><span class='num'>1174</span>    public function send(): void
</div><div class='line not-executable'><span class='num'>1175</span>    {
</div><div class='line not-covered'><span class='num'>1176</span>        header(&#039;Content-Type: application/json; charset=utf-8&#039;);
</div><div class='line not-covered'><span class='num'>1177</span>        http_response_code($this-&gt;code);
</div><div class='line not-covered'><span class='num'>1178</span>        $this-&gt;data = [&#039;code&#039; =&gt; $this-&gt;code, &#039;status&#039; =&gt; $this-&gt;status, &#039;message&#039; =&gt; $this-&gt;message, &#039;data&#039; =&gt; $this-&gt;data];
</div><div class='line not-covered'><span class='num'>1179</span>        echo json_encode($this-&gt;data, JSON_UNESCAPED_UNICODE |  JSON_UNESCAPED_SLASHES |  JSON_PRETTY_PRINT);
</div><div class='line not-covered'><span class='num'>1180</span>    }
</div><div class='line not-executable'><span class='num'>1181</span>}
</div><div class='line not-executable'><span class='num'>1182</span>
</div><div class='line not-executable'><span class='num'>1183</span>class OKResponse extends Response
</div><div class='line not-executable'><span class='num'>1184</span>{
</div><div class='line not-executable'><span class='num'>1185</span>    public function __construct(string $message, array $data)
</div><div class='line not-executable'><span class='num'>1186</span>    {
</div><div class='line covered'><span class='num'>1187</span>        return parent::__construct(200, &#039;success&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1188</span>    }
</div><div class='line not-executable'><span class='num'>1189</span>}
</div><div class='line not-executable'><span class='num'>1190</span>
</div><div class='line not-executable'><span class='num'>1191</span>class CreatedResponse extends Response
</div><div class='line not-executable'><span class='num'>1192</span>{
</div><div class='line not-executable'><span class='num'>1193</span>    public function __construct(string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1194</span>    {
</div><div class='line covered'><span class='num'>1195</span>        return parent::__construct(201, &#039;success&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1196</span>    }
</div><div class='line not-executable'><span class='num'>1197</span>}
</div><div class='line not-executable'><span class='num'>1198</span>
</div><div class='line not-executable'><span class='num'>1199</span>class BadRequestResponse extends Response
</div><div class='line not-executable'><span class='num'>1200</span>{
</div><div class='line not-executable'><span class='num'>1201</span>    public function __construct(string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1202</span>    {
</div><div class='line not-covered'><span class='num'>1203</span>        return parent::__construct(400, &#039;error&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1204</span>    }
</div><div class='line not-executable'><span class='num'>1205</span>}
</div><div class='line not-executable'><span class='num'>1206</span>
</div><div class='line not-executable'><span class='num'>1207</span>class UnauthorizedResponse extends Response
</div><div class='line not-executable'><span class='num'>1208</span>{
</div><div class='line not-executable'><span class='num'>1209</span>    public function __construct(string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1210</span>    {
</div><div class='line not-covered'><span class='num'>1211</span>        return parent::__construct(401, &#039;error&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1212</span>    }
</div><div class='line not-executable'><span class='num'>1213</span>}
</div><div class='line not-executable'><span class='num'>1214</span>
</div><div class='line not-executable'><span class='num'>1215</span>class ForbiddenResponse extends Response
</div><div class='line not-executable'><span class='num'>1216</span>{
</div><div class='line not-executable'><span class='num'>1217</span>    public function __construct(string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1218</span>    {
</div><div class='line not-covered'><span class='num'>1219</span>        return parent::__construct(403, &#039;error&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1220</span>    }
</div><div class='line not-executable'><span class='num'>1221</span>}
</div><div class='line not-executable'><span class='num'>1222</span>
</div><div class='line not-executable'><span class='num'>1223</span>class NotFoundResponse extends Response
</div><div class='line not-executable'><span class='num'>1224</span>{
</div><div class='line not-executable'><span class='num'>1225</span>    public function __construct(string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1226</span>    {
</div><div class='line not-covered'><span class='num'>1227</span>        return parent::__construct(404, &#039;error&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1228</span>    }
</div><div class='line not-executable'><span class='num'>1229</span>}
</div><div class='line not-executable'><span class='num'>1230</span>
</div><div class='line not-executable'><span class='num'>1231</span>class InternalServerErrorResponse extends Response
</div><div class='line not-executable'><span class='num'>1232</span>{
</div><div class='line not-executable'><span class='num'>1233</span>    public function __construct(string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1234</span>    {
</div><div class='line not-covered'><span class='num'>1235</span>        return parent::__construct(500, &#039;error&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1236</span>    }
</div><div class='line not-executable'><span class='num'>1237</span>}
</div><div class='line not-executable'><span class='num'>1238</span>
</div><div class='line not-executable'><span class='num'>1239</span>interface GraphControllerInterface
</div><div class='line not-executable'><span class='num'>1240</span>{
</div><div class='line not-executable'><span class='num'>1241</span>    public function getUser(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1242</span>    public function insertUser(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1243</span>    public function updateUser(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1244</span>
</div><div class='line not-executable'><span class='num'>1245</span>    public function getGraph(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1246</span>
</div><div class='line not-executable'><span class='num'>1247</span>    public function getNode(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1248</span>    public function getNodes(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1249</span>    public function insertNode(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1250</span>    public function updateNode(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1251</span>    public function deleteNode(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1252</span>
</div><div class='line not-executable'><span class='num'>1253</span>    public function getEdge(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1254</span>    public function getEdges(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1255</span>    public function insertEdge(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1256</span>    public function updateEdge(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1257</span>    public function deleteEdge(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1258</span>
</div><div class='line not-executable'><span class='num'>1259</span>    public function getStatuses(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1260</span>    public function getNodeStatus(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1261</span>    public function setNodeStatus(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1262</span>
</div><div class='line not-executable'><span class='num'>1263</span>    public function getLogs(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1264</span>}
</div><div class='line not-executable'><span class='num'>1265</span>
</div><div class='line not-executable'><span class='num'>1266</span>final class GraphControllerException extends RuntimeException
</div><div class='line not-executable'><span class='num'>1267</span>{
</div><div class='line not-executable'><span class='num'>1268</span>}
</div><div class='line not-executable'><span class='num'>1269</span>
</div><div class='line not-executable'><span class='num'>1270</span>final class GraphController implements GraphControllerInterface
</div><div class='line not-executable'><span class='num'>1271</span>{
</div><div class='line not-executable'><span class='num'>1272</span>    private GraphServiceInterface $service;
</div><div class='line not-executable'><span class='num'>1273</span>    private Logger $logger;
</div><div class='line not-executable'><span class='num'>1274</span>
</div><div class='line not-executable'><span class='num'>1275</span>    public function __construct(GraphServiceInterface $service, Logger $logger)
</div><div class='line not-executable'><span class='num'>1276</span>    {
</div><div class='line covered'><span class='num'>1277</span>        $this-&gt;service = $service;
</div><div class='line covered'><span class='num'>1278</span>        $this-&gt;logger = $logger;
</div><div class='line covered'><span class='num'>1279</span>    }
</div><div class='line not-executable'><span class='num'>1280</span>
</div><div class='line not-executable'><span class='num'>1281</span>    public function getUser(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1282</span>    {
</div><div class='line not-covered'><span class='num'>1283</span>        $data = $this-&gt;service-&gt;getUser($req-&gt;data[&#039;id&#039;]);
</div><div class='line not-covered'><span class='num'>1284</span>        $user = new User($data[&#039;id&#039;], null, new Group($data[&#039;user_group&#039;]));
</div><div class='line not-covered'><span class='num'>1285</span>        return new OKResponse(&#039;user found&#039;, $user-&gt;toArray());
</div><div class='line not-covered'><span class='num'>1286</span>    }
</div><div class='line not-executable'><span class='num'>1287</span>
</div><div class='line not-executable'><span class='num'>1288</span>    public function insertUser(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1289</span>    {
</div><div class='line not-covered'><span class='num'>1290</span>        $user = new User($req-&gt;data[&#039;id&#039;], null, $req-&gt;data[&#039;user_group&#039;]);
</div><div class='line not-covered'><span class='num'>1291</span>        $this-&gt;service-&gt;insertUser($user);
</div><div class='line not-covered'><span class='num'>1292</span>        return new OKResponse(&#039;user created&#039;, $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1293</span>    }
</div><div class='line not-executable'><span class='num'>1294</span>
</div><div class='line not-executable'><span class='num'>1295</span>    public function updateUser(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1296</span>    {
</div><div class='line not-covered'><span class='num'>1297</span>        $user = new User($req-&gt;data[&#039;id&#039;], null, $req-&gt;data[&#039;user_group&#039;]);
</div><div class='line not-covered'><span class='num'>1298</span>        $this-&gt;service-&gt;updateUser($user);
</div><div class='line not-covered'><span class='num'>1299</span>        return new CreatedResponse(&#039;user updated&#039;, $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1300</span>    }
</div><div class='line not-executable'><span class='num'>1301</span>
</div><div class='line not-executable'><span class='num'>1302</span>    public function getGraph(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1303</span>    {
</div><div class='line not-executable'><span class='num'>1304</span>        try {
</div><div class='line not-covered'><span class='num'>1305</span>            $data = $this-&gt;service-&gt;getGraph()-&gt;toArray();
</div><div class='line not-covered'><span class='num'>1306</span>            return new OKResponse(&#039;get graph&#039;, $data);
</div><div class='line not-covered'><span class='num'>1307</span>            return $resp;
</div><div class='line not-covered'><span class='num'>1308</span>        } catch (Exception $e) {
</div><div class='line not-covered'><span class='num'>1309</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1310</span>        }
</div><div class='line not-executable'><span class='num'>1311</span>
</div><div class='line not-covered'><span class='num'>1312</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1313</span>    }
</div><div class='line not-executable'><span class='num'>1314</span>
</div><div class='line not-executable'><span class='num'>1315</span>    public function getNode(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1316</span>    {
</div><div class='line not-executable'><span class='num'>1317</span>        try {
</div><div class='line covered'><span class='num'>1318</span>            $id = $req-&gt;getParam(&#039;id&#039;);
</div><div class='line covered'><span class='num'>1319</span>            $node = $this-&gt;service-&gt;getNode($id);
</div><div class='line covered'><span class='num'>1320</span>            $data = $node-&gt;toArray();
</div><div class='line covered'><span class='num'>1321</span>            return new OKResponse(&#039;node found&#039;, $data);
</div><div class='line not-covered'><span class='num'>1322</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1323</span>        {
</div><div class='line not-covered'><span class='num'>1324</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1325</span>        }
</div><div class='line not-executable'><span class='num'>1326</span>
</div><div class='line not-covered'><span class='num'>1327</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1328</span>    }
</div><div class='line not-executable'><span class='num'>1329</span>
</div><div class='line not-executable'><span class='num'>1330</span>    public function getNodes(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1331</span>    {
</div><div class='line not-executable'><span class='num'>1332</span>        try {
</div><div class='line not-covered'><span class='num'>1333</span>            $nodes = $this-&gt;service-&gt;getNodes();
</div><div class='line not-executable'><span class='num'>1334</span>            // TODO: corrigir
</div><div class='line not-covered'><span class='num'>1335</span>            return new OKResponse(&#039;nodes found&#039;, []);
</div><div class='line not-covered'><span class='num'>1336</span>            return $resp;
</div><div class='line not-covered'><span class='num'>1337</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1338</span>        {
</div><div class='line not-covered'><span class='num'>1339</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1340</span>        }
</div><div class='line not-executable'><span class='num'>1341</span>        
</div><div class='line not-covered'><span class='num'>1342</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1343</span>    }
</div><div class='line not-executable'><span class='num'>1344</span>
</div><div class='line not-executable'><span class='num'>1345</span>    public function insertNode(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1346</span>    {
</div><div class='line covered'><span class='num'>1347</span>        $this-&gt;logger-&gt;debug(&#039;inserting node&#039;, $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1348</span>        try {
</div><div class='line covered'><span class='num'>1349</span>            $node = new Node($req-&gt;data[&#039;id&#039;], $req-&gt;data[&#039;label&#039;], $req-&gt;data[&#039;category&#039;], $req-&gt;data[&#039;type&#039;], $req-&gt;data[&#039;data&#039;]);
</div><div class='line covered'><span class='num'>1350</span>            $this-&gt;service-&gt;insertNode($node);
</div><div class='line covered'><span class='num'>1351</span>            $this-&gt;logger-&gt;info(&#039;node inserted&#039;, $req-&gt;data);
</div><div class='line covered'><span class='num'>1352</span>            return new CreatedResponse(&#039;node inserted&#039;, $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1353</span>        } catch( GraphServiceException $e)
</div><div class='line not-executable'><span class='num'>1354</span>        {
</div><div class='line not-covered'><span class='num'>1355</span>            $this-&gt;logger-&gt;error(&#039;The service could not insert new node:&#039; . $e-&gt;getMessage());
</div><div class='line not-covered'><span class='num'>1356</span>            throw new GraphControllerException(&#039;The service could not insert new node:&#039; . $e-&gt;getMessage(), 0, $e);
</div><div class='line not-executable'><span class='num'>1357</span>        }
</div><div class='line not-covered'><span class='num'>1358</span>        return new InternalServerErrorResponse(&#039;unknow error inserting node&#039;, $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1359</span>    }
</div><div class='line not-executable'><span class='num'>1360</span>    
</div><div class='line not-executable'><span class='num'>1361</span>    public function updateNode(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1362</span>    {
</div><div class='line covered'><span class='num'>1363</span>        $this-&gt;logger-&gt;debug(&#039;updating node&#039;, $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1364</span>
</div><div class='line not-executable'><span class='num'>1365</span>        try {
</div><div class='line covered'><span class='num'>1366</span>            $edge = new Edge($req-&gt;data[&#039;id&#039;], $req-&gt;data[&#039;category&#039;], $req-&gt;data[&#039;type&#039;], $req-&gt;data[&#039;data&#039;]);
</div><div class='line covered'><span class='num'>1367</span>            $this-&gt;service-&gt;insertEdge($edge);
</div><div class='line covered'><span class='num'>1368</span>            $this-&gt;logger-&gt;info(&#039;edge inserted&#039;, $req-&gt;data);
</div><div class='line covered'><span class='num'>1369</span>            $resp = new CreatedResponse(&#039;edge created&#039;, $req-&gt;data);
</div><div class='line covered'><span class='num'>1370</span>            return $resp;
</div><div class='line not-covered'><span class='num'>1371</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1372</span>        {
</div><div class='line not-covered'><span class='num'>1373</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1374</span>        }
</div><div class='line not-executable'><span class='num'>1375</span>        
</div><div class='line not-covered'><span class='num'>1376</span>        return new InternalServerErrorResponse(&#039;unknow todo in updateNode&#039;, $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1377</span>    }
</div><div class='line not-executable'><span class='num'>1378</span>    
</div><div class='line not-executable'><span class='num'>1379</span>    public function deleteNode(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1380</span>    {
</div><div class='line not-executable'><span class='num'>1381</span>        try {
</div><div class='line not-covered'><span class='num'>1382</span>            $this-&gt;service-&gt;deleteEdge($req-&gt;data[&#039;id&#039;]);
</div><div class='line not-covered'><span class='num'>1383</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1384</span>        {
</div><div class='line not-covered'><span class='num'>1385</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1386</span>        }
</div><div class='line not-executable'><span class='num'>1387</span>        
</div><div class='line not-covered'><span class='num'>1388</span>        return new InternalServerErrorResponse(&#039;unknow todo in deleteNode&#039;, $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1389</span>    }
</div><div class='line not-executable'><span class='num'>1390</span>
</div><div class='line not-executable'><span class='num'>1391</span>    public function getEdge(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1392</span>    {
</div><div class='line not-executable'><span class='num'>1393</span>        try {
</div><div class='line not-covered'><span class='num'>1394</span>            $edge = $this-&gt;service-&gt;getEdge($req-&gt;data[&#039;source&#039;], $req-&gt;data[&#039;target&#039;]);
</div><div class='line not-covered'><span class='num'>1395</span>            $data = $edge-&gt;toArray();
</div><div class='line not-covered'><span class='num'>1396</span>            return new OKResponse(&#039;node found&#039;, $data);
</div><div class='line not-covered'><span class='num'>1397</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1398</span>        {
</div><div class='line not-covered'><span class='num'>1399</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1400</span>        }
</div><div class='line not-executable'><span class='num'>1401</span>        
</div><div class='line not-covered'><span class='num'>1402</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1403</span>    }
</div><div class='line not-executable'><span class='num'>1404</span>    
</div><div class='line not-executable'><span class='num'>1405</span>    public function getEdges(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1406</span>    {
</div><div class='line not-executable'><span class='num'>1407</span>        try {
</div><div class='line not-covered'><span class='num'>1408</span>            $edges = $this-&gt;service-&gt;getEdges();
</div><div class='line not-executable'><span class='num'>1409</span>            // TODO: corrigir
</div><div class='line not-covered'><span class='num'>1410</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1411</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1412</span>        {
</div><div class='line not-covered'><span class='num'>1413</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1414</span>        }
</div><div class='line not-executable'><span class='num'>1415</span>        
</div><div class='line not-covered'><span class='num'>1416</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1417</span>    }
</div><div class='line not-executable'><span class='num'>1418</span>    
</div><div class='line not-executable'><span class='num'>1419</span>    public function insertEdge(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1420</span>    {
</div><div class='line not-executable'><span class='num'>1421</span>        try {
</div><div class='line not-covered'><span class='num'>1422</span>            $edge = new Edge(null, $req-&gt;data[&#039;source&#039;], $req-&gt;data[&#039;target&#039;]);
</div><div class='line not-covered'><span class='num'>1423</span>            $this-&gt;service-&gt;insertEdge($edge);
</div><div class='line not-covered'><span class='num'>1424</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1425</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1426</span>        {
</div><div class='line not-covered'><span class='num'>1427</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1428</span>        }
</div><div class='line not-executable'><span class='num'>1429</span>        
</div><div class='line not-covered'><span class='num'>1430</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1431</span>    }
</div><div class='line not-executable'><span class='num'>1432</span>    
</div><div class='line not-executable'><span class='num'>1433</span>    public function updateEdge(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1434</span>    {
</div><div class='line not-executable'><span class='num'>1435</span>        try {
</div><div class='line not-covered'><span class='num'>1436</span>            $edge = new Edge($req-&gt;data[&#039;id&#039;], $req-&gt;data[&#039;source&#039;], $req-&gt;data[&#039;target&#039;], $req-&gt;data[&#039;data&#039;]);
</div><div class='line not-covered'><span class='num'>1437</span>            $this-&gt;service-&gt;updateEdge($edge);
</div><div class='line not-covered'><span class='num'>1438</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1439</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1440</span>        {
</div><div class='line not-covered'><span class='num'>1441</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1442</span>        }
</div><div class='line not-executable'><span class='num'>1443</span>        
</div><div class='line not-covered'><span class='num'>1444</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1445</span>    }
</div><div class='line not-executable'><span class='num'>1446</span>    
</div><div class='line not-executable'><span class='num'>1447</span>    public function deleteEdge(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1448</span>    {
</div><div class='line not-executable'><span class='num'>1449</span>        try {
</div><div class='line not-covered'><span class='num'>1450</span>            $id = $req-&gt;data[&#039;id&#039;];
</div><div class='line not-covered'><span class='num'>1451</span>            $this-&gt;service-&gt;deleteEdge($id);
</div><div class='line not-covered'><span class='num'>1452</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1453</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1454</span>        {
</div><div class='line not-covered'><span class='num'>1455</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1456</span>        }
</div><div class='line not-executable'><span class='num'>1457</span>        
</div><div class='line not-covered'><span class='num'>1458</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1459</span>    }
</div><div class='line not-executable'><span class='num'>1460</span>
</div><div class='line not-executable'><span class='num'>1461</span>    public function getStatuses(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1462</span>    {
</div><div class='line not-executable'><span class='num'>1463</span>        try {
</div><div class='line not-covered'><span class='num'>1464</span>            $statuses = $this-&gt;service-&gt;getStatuses();
</div><div class='line not-covered'><span class='num'>1465</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1466</span>            return $resp;
</div><div class='line not-covered'><span class='num'>1467</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1468</span>        {
</div><div class='line not-covered'><span class='num'>1469</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1470</span>        }
</div><div class='line not-executable'><span class='num'>1471</span>        
</div><div class='line not-covered'><span class='num'>1472</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1473</span>    }
</div><div class='line not-executable'><span class='num'>1474</span>    
</div><div class='line not-executable'><span class='num'>1475</span>    public function getNodeStatus(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1476</span>    {
</div><div class='line not-executable'><span class='num'>1477</span>        try {
</div><div class='line not-covered'><span class='num'>1478</span>            $status = $this-&gt;service-&gt;getNodeStatus($req-&gt;data[&#039;id&#039;]);
</div><div class='line not-covered'><span class='num'>1479</span>            $data = $status-&gt;toArray();
</div><div class='line not-covered'><span class='num'>1480</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1481</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1482</span>        {
</div><div class='line not-covered'><span class='num'>1483</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1484</span>        }
</div><div class='line not-executable'><span class='num'>1485</span>        
</div><div class='line not-covered'><span class='num'>1486</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1487</span>    }
</div><div class='line not-executable'><span class='num'>1488</span>    
</div><div class='line not-executable'><span class='num'>1489</span>    public function setNodeStatus(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1490</span>    {
</div><div class='line not-executable'><span class='num'>1491</span>        try {
</div><div class='line not-covered'><span class='num'>1492</span>            $status = new NodeStatus($req-&gt;data[&#039;node_id&#039;], $req-&gt;data[&#039;status&#039;]);
</div><div class='line not-covered'><span class='num'>1493</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1494</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1495</span>        {
</div><div class='line not-covered'><span class='num'>1496</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1497</span>        }
</div><div class='line not-executable'><span class='num'>1498</span>        
</div><div class='line not-covered'><span class='num'>1499</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1500</span>    }
</div><div class='line not-executable'><span class='num'>1501</span>
</div><div class='line not-executable'><span class='num'>1502</span>    public function getLogs(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1503</span>    {
</div><div class='line not-executable'><span class='num'>1504</span>        try {
</div><div class='line not-covered'><span class='num'>1505</span>            $logs = $this-&gt;service-&gt;getLogs($req-&gt;getParam(&#039;limit&#039;));
</div><div class='line not-covered'><span class='num'>1506</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1507</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1508</span>        {
</div><div class='line not-covered'><span class='num'>1509</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1510</span>        }
</div><div class='line not-executable'><span class='num'>1511</span>        
</div><div class='line not-covered'><span class='num'>1512</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1513</span>    }
</div><div class='line not-executable'><span class='num'>1514</span>}
</div><div class='line not-executable'><span class='num'>1515</span>
</div><div class='line not-executable'><span class='num'>1516</span>final class RequestRouter
</div><div class='line not-executable'><span class='num'>1517</span>{
</div><div class='line not-executable'><span class='num'>1518</span>    private $routes = [
</div><div class='line not-executable'><span class='num'>1519</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getGraph&#039;, &#039;class_method&#039; =&gt; &#039;getGraph&#039;],
</div><div class='line not-executable'><span class='num'>1520</span>        
</div><div class='line not-executable'><span class='num'>1521</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getNode&#039;, &#039;class_method&#039; =&gt; &#039;getNode&#039;],
</div><div class='line not-executable'><span class='num'>1522</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getNodes&#039;, &#039;class_method&#039; =&gt; &#039;getNodes&#039;],
</div><div class='line not-executable'><span class='num'>1523</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/insertNode&#039;, &#039;class_method&#039; =&gt; &#039;insertNode&#039;],
</div><div class='line not-executable'><span class='num'>1524</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/updateNode&#039;, &#039;class_method&#039; =&gt; &#039;updateNode&#039;],
</div><div class='line not-executable'><span class='num'>1525</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/deleteNode&#039;, &#039;class_method&#039; =&gt; &#039;deleteNode&#039;],
</div><div class='line not-executable'><span class='num'>1526</span>
</div><div class='line not-executable'><span class='num'>1527</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getEdge&#039;, &#039;class_method&#039; =&gt; &#039;getEdge&#039;],
</div><div class='line not-executable'><span class='num'>1528</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getEdges&#039;, &#039;class_method&#039; =&gt; &#039;getEdges&#039;],
</div><div class='line not-executable'><span class='num'>1529</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/insertEdge&#039;, &#039;class_method&#039; =&gt; &#039;insertEdge&#039;],
</div><div class='line not-executable'><span class='num'>1530</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/updateEdge&#039;, &#039;class_method&#039; =&gt; &#039;updateEdge&#039;],
</div><div class='line not-executable'><span class='num'>1531</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/deleteEdge&#039;, &#039;class_method&#039; =&gt; &#039;deleteEdge&#039;],
</div><div class='line not-executable'><span class='num'>1532</span>
</div><div class='line not-executable'><span class='num'>1533</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getStatuses&#039;, &#039;class_method&#039; =&gt; &#039;getStatuses&#039;],
</div><div class='line not-executable'><span class='num'>1534</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getNodeStatus&#039;, &#039;class_method&#039; =&gt; &#039;getNodeStatus&#039;],
</div><div class='line not-executable'><span class='num'>1535</span>
</div><div class='line not-executable'><span class='num'>1536</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getLogs&#039;, &#039;class_method&#039; =&gt; &#039;getLogs&#039;],
</div><div class='line not-executable'><span class='num'>1537</span>
</div><div class='line not-executable'><span class='num'>1538</span>        ];
</div><div class='line not-executable'><span class='num'>1539</span>
</div><div class='line not-executable'><span class='num'>1540</span>    public GraphController $controller;
</div><div class='line not-executable'><span class='num'>1541</span>    
</div><div class='line not-executable'><span class='num'>1542</span>    public function __construct(GraphController $controller)
</div><div class='line not-executable'><span class='num'>1543</span>    {
</div><div class='line not-covered'><span class='num'>1544</span>        $this-&gt;controller = $controller;
</div><div class='line not-covered'><span class='num'>1545</span>    }
</div><div class='line not-executable'><span class='num'>1546</span>
</div><div class='line not-executable'><span class='num'>1547</span>    public function handle(): void
</div><div class='line not-executable'><span class='num'>1548</span>    {
</div><div class='line not-covered'><span class='num'>1549</span>        $method = $_SERVER[&#039;REQUEST_METHOD&#039;];
</div><div class='line not-executable'><span class='num'>1550</span>
</div><div class='line not-covered'><span class='num'>1551</span>        $scriptName = $_SERVER[&#039;SCRIPT_NAME&#039;];
</div><div class='line not-covered'><span class='num'>1552</span>        $requestUri = $_SERVER[&#039;REQUEST_URI&#039;];
</div><div class='line not-covered'><span class='num'>1553</span>        $requestUri = strtok($requestUri, &#039;?&#039;);
</div><div class='line not-executable'><span class='num'>1554</span>        
</div><div class='line not-covered'><span class='num'>1555</span>        $path = str_replace($scriptName, &#039;&#039;, $requestUri);
</div><div class='line not-executable'><span class='num'>1556</span>        
</div><div class='line not-covered'><span class='num'>1557</span>        $req = new Request();
</div><div class='line not-executable'><span class='num'>1558</span>
</div><div class='line not-covered'><span class='num'>1559</span>        foreach($this-&gt;routes as $route)
</div><div class='line not-executable'><span class='num'>1560</span>        {
</div><div class='line not-covered'><span class='num'>1561</span>            if ($route[&#039;method&#039;] == $method &amp;&amp; $route[&#039;path&#039;] == $path)
</div><div class='line not-executable'><span class='num'>1562</span>            {
</div><div class='line not-covered'><span class='num'>1563</span>                $method = $route[&#039;class_method&#039;];
</div><div class='line not-covered'><span class='num'>1564</span>                $resp = $this-&gt;controller-&gt;$method($req);
</div><div class='line not-covered'><span class='num'>1565</span>                print_r($resp);
</div><div class='line not-covered'><span class='num'>1566</span>                exit();
</div><div class='line not-executable'><span class='num'>1567</span>            }
</div><div class='line not-executable'><span class='num'>1568</span>        }
</div><div class='line not-covered'><span class='num'>1569</span>    }
</div><div class='line not-executable'><span class='num'>1570</span>}
</div><div class='line not-executable'><span class='num'>1571</span>
</div><div class='line not-executable'><span class='num'>1572</span>
</div></body></html><html><head><meta charset='UTF-8'><style>
body { font-family: monospace; font-size: 12px; background: #222; color: #ddd; margin: 0; }
.covered { background: #1a4d1a; }
.not-covered { background: #4d1a1a; }
.not-executable { background: #2a2a2a; color: #666; }
.line { padding: 2px 10px; white-space: pre; border-left: 3px solid transparent; }
.covered { border-left-color: #0f0; }
.not-covered { border-left-color: #f00; }
.num { color: #666; width: 50px; display: inline-block; text-align: right; margin-right: 10px; }
h2 { background: #333; padding: 10px; margin: 20px 0 0 0; position: sticky; top: 0; }
</style></head><body><h2>/home/tarcisio/projects/graph/tests.php - 77.05% (47/61)</h2><div class='line not-executable'><span class='num'>1</span>&lt;?php
</div><div class='line not-executable'><span class='num'>2</span>
</div><div class='line not-executable'><span class='num'>3</span>declare(strict_types=1);
</div><div class='line not-executable'><span class='num'>4</span>
</div><div class='line not-executable'><span class='num'>5</span>require_once __DIR__ . &#039;/graph.php&#039;;
</div><div class='line not-executable'><span class='num'>6</span>
</div><div class='line not-executable'><span class='num'>7</span>ini_set(&#039;xdebug.mode&#039;, &#039;1&#039;);
</div><div class='line not-executable'><span class='num'>8</span>xdebug_start_code_coverage(XDEBUG_CC_UNUSED | XDEBUG_CC_DEAD_CODE);
</div><div class='line not-executable'><span class='num'>9</span>
</div><div class='line not-executable'><span class='num'>10</span>function array_diff_recursive($array1, $array2) {
</div><div class='line covered'><span class='num'>11</span>    $diff = [];
</div><div class='line not-executable'><span class='num'>12</span>    
</div><div class='line covered'><span class='num'>13</span>    foreach ($array1 as $key =&gt; $value) {
</div><div class='line covered'><span class='num'>14</span>        if (!array_key_exists($key, $array2)) {
</div><div class='line not-covered'><span class='num'>15</span>            $diff[$key] = $value;
</div><div class='line covered'><span class='num'>16</span>        } elseif (is_array($value)) {
</div><div class='line covered'><span class='num'>17</span>            if (!is_array($array2[$key])) {
</div><div class='line not-covered'><span class='num'>18</span>                $diff[$key] = $value;
</div><div class='line not-executable'><span class='num'>19</span>            } else {
</div><div class='line covered'><span class='num'>20</span>                $recursiveDiff = array_diff_recursive($value, $array2[$key]);
</div><div class='line covered'><span class='num'>21</span>                if (count($recursiveDiff)) {
</div><div class='line not-covered'><span class='num'>22</span>                    $diff[$key] = $recursiveDiff;
</div><div class='line not-executable'><span class='num'>23</span>                }
</div><div class='line not-executable'><span class='num'>24</span>            }
</div><div class='line covered'><span class='num'>25</span>        } elseif ($value !== $array2[$key]) {
</div><div class='line not-covered'><span class='num'>26</span>            $diff[$key] = $value;
</div><div class='line not-executable'><span class='num'>27</span>        }
</div><div class='line not-executable'><span class='num'>28</span>    }
</div><div class='line not-executable'><span class='num'>29</span>    
</div><div class='line covered'><span class='num'>30</span>    return $diff;
</div><div class='line not-covered'><span class='num'>31</span>}
</div><div class='line not-executable'><span class='num'>32</span>
</div><div class='line not-executable'><span class='num'>33</span>function get_test_graph_controller()
</div><div class='line not-executable'><span class='num'>34</span>{
</div><div class='line covered'><span class='num'>35</span>    GraphContext::$user = new User(&#039;test_user&#039;, &#039;127.0.0.1&#039;, new Group(&#039;contributor&#039;));
</div><div class='line covered'><span class='num'>36</span>    $pdo = GraphDatabase::createConnection(&#039;sqlite::memory:&#039;);
</div><div class='line covered'><span class='num'>37</span>    $databaseLogger = new Logger(&#039;database.log&#039;);
</div><div class='line not-executable'><span class='num'>38</span>
</div><div class='line covered'><span class='num'>39</span>    $graphDb = new GraphDatabase($pdo, $databaseLogger);
</div><div class='line not-executable'><span class='num'>40</span>
</div><div class='line covered'><span class='num'>41</span>    $serviceLogger = new Logger(&#039;service.log&#039;);
</div><div class='line covered'><span class='num'>42</span>    $graphService = new GraphService($graphDb, $serviceLogger);
</div><div class='line not-executable'><span class='num'>43</span>
</div><div class='line covered'><span class='num'>44</span>    $controllerLogger = new Logger(&#039;controller.log&#039;);
</div><div class='line covered'><span class='num'>45</span>    $graphController = new GraphController($graphService, $controllerLogger);
</div><div class='line not-executable'><span class='num'>46</span>    
</div><div class='line covered'><span class='num'>47</span>    return $graphController;
</div><div class='line not-covered'><span class='num'>48</span>}
</div><div class='line not-executable'><span class='num'>49</span>
</div><div class='line not-executable'><span class='num'>50</span>function test_node_good_path()
</div><div class='line not-executable'><span class='num'>51</span>{
</div><div class='line covered'><span class='num'>52</span>    $graphController = get_test_graph_controller();
</div><div class='line covered'><span class='num'>53</span>    $insertNodeReq = new Request();
</div><div class='line covered'><span class='num'>54</span>    $insertNodeReq-&gt;data = [&#039;id&#039; =&gt; &#039;node1&#039;, &#039;label&#039; =&gt; &#039;node1&#039;, &#039;category&#039; =&gt; &#039;business&#039;, &#039;type&#039; =&gt; &#039;server&#039;, &#039;data&#039; =&gt; [&#039;info&#039; =&gt; &#039;first node&#039;]];
</div><div class='line covered'><span class='num'>55</span>    $resp = $graphController-&gt;insertNode($insertNodeReq);
</div><div class='line not-executable'><span class='num'>56</span>    
</div><div class='line covered'><span class='num'>57</span>    $expected = [
</div><div class='line not-executable'><span class='num'>58</span>        &#039;id&#039;       =&gt; &#039;node1&#039;,
</div><div class='line not-executable'><span class='num'>59</span>        &#039;label&#039;    =&gt; &#039;node1&#039;,
</div><div class='line not-executable'><span class='num'>60</span>        &#039;category&#039; =&gt; &#039;business&#039;,
</div><div class='line not-executable'><span class='num'>61</span>        &#039;type&#039; =&gt; &#039;server&#039;,
</div><div class='line not-executable'><span class='num'>62</span>        &#039;data&#039; =&gt; [
</div><div class='line not-executable'><span class='num'>63</span>                &#039;info&#039; =&gt; &#039;first node&#039;
</div><div class='line not-executable'><span class='num'>64</span>        ]
</div><div class='line not-executable'><span class='num'>65</span>    ];
</div><div class='line not-executable'><span class='num'>66</span>
</div><div class='line covered'><span class='num'>67</span>    if($resp-&gt;code != 201) {
</div><div class='line not-covered'><span class='num'>68</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>69</span>    }
</div><div class='line not-executable'><span class='num'>70</span>
</div><div class='line covered'><span class='num'>71</span>    if($resp-&gt;status != &#039;success&#039;) {
</div><div class='line not-covered'><span class='num'>72</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>73</span>    }
</div><div class='line not-executable'><span class='num'>74</span>
</div><div class='line covered'><span class='num'>75</span>    if ($resp-&gt;message != &#039;node inserted&#039;) {
</div><div class='line not-covered'><span class='num'>76</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>77</span>    }
</div><div class='line not-executable'><span class='num'>78</span>
</div><div class='line covered'><span class='num'>79</span>    $diff = array_diff_recursive($resp-&gt;data, $expected);
</div><div class='line covered'><span class='num'>80</span>    if (! empty($diff)) {
</div><div class='line not-covered'><span class='num'>81</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>82</span>    }
</div><div class='line not-executable'><span class='num'>83</span>
</div><div class='line covered'><span class='num'>84</span>    $_GET[&#039;id&#039;] = &#039;node1&#039;;
</div><div class='line covered'><span class='num'>85</span>    $req = new Request();
</div><div class='line covered'><span class='num'>86</span>    $resp = $graphController-&gt;getNode($req);
</div><div class='line not-executable'><span class='num'>87</span>
</div><div class='line covered'><span class='num'>88</span>    if ($resp-&gt;code != 200) {
</div><div class='line not-covered'><span class='num'>89</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>90</span>    }
</div><div class='line not-executable'><span class='num'>91</span>
</div><div class='line covered'><span class='num'>92</span>    if($resp-&gt;status != &#039;success&#039;) {
</div><div class='line not-covered'><span class='num'>93</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>94</span>    }
</div><div class='line not-executable'><span class='num'>95</span>
</div><div class='line covered'><span class='num'>96</span>    if ($resp-&gt;message != &#039;node found&#039;) {
</div><div class='line not-covered'><span class='num'>97</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>98</span>    }
</div><div class='line not-executable'><span class='num'>99</span>
</div><div class='line covered'><span class='num'>100</span>    $expected = [
</div><div class='line not-executable'><span class='num'>101</span>        &#039;info&#039;     =&gt; &#039;first node&#039;,
</div><div class='line not-executable'><span class='num'>102</span>        &#039;id&#039;       =&gt; &#039;node1&#039;,
</div><div class='line not-executable'><span class='num'>103</span>        &#039;label&#039;    =&gt; &#039;node1&#039;,
</div><div class='line not-executable'><span class='num'>104</span>        &#039;category&#039; =&gt; &#039;business&#039;,
</div><div class='line not-executable'><span class='num'>105</span>        &#039;type&#039;     =&gt; &#039;server&#039;,
</div><div class='line not-executable'><span class='num'>106</span>    ];
</div><div class='line not-executable'><span class='num'>107</span>
</div><div class='line covered'><span class='num'>108</span>    $diff = array_diff_recursive($resp-&gt;data[&#039;data&#039;], $expected);
</div><div class='line covered'><span class='num'>109</span>    if (! empty($diff)) {
</div><div class='line not-covered'><span class='num'>110</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line not-executable'><span class='num'>111</span>    }
</div><div class='line not-executable'><span class='num'>112</span>    
</div><div class='line covered'><span class='num'>113</span>    $req = new Request();
</div><div class='line covered'><span class='num'>114</span>    $req-&gt;data = [
</div><div class='line not-executable'><span class='num'>115</span>        &#039;id&#039;       =&gt; &#039;node1&#039;,
</div><div class='line not-executable'><span class='num'>116</span>        &#039;label&#039;    =&gt; &#039;node1&#039;,
</div><div class='line not-executable'><span class='num'>117</span>        &#039;category&#039; =&gt; &#039;business&#039;,
</div><div class='line not-executable'><span class='num'>118</span>        &#039;type&#039; =&gt; &#039;server&#039;,
</div><div class='line not-executable'><span class='num'>119</span>        &#039;data&#039; =&gt; [
</div><div class='line not-executable'><span class='num'>120</span>                &#039;info&#039; =&gt; &#039;first node updated&#039;
</div><div class='line not-executable'><span class='num'>121</span>        ]
</div><div class='line not-executable'><span class='num'>122</span>    ];
</div><div class='line covered'><span class='num'>123</span>    $resp = $graphController-&gt;updateNode($req);
</div><div class='line covered'><span class='num'>124</span>    print_r($resp);
</div><div class='line covered'><span class='num'>125</span>}
</div><div class='line not-executable'><span class='num'>126</span>
</div><div class='line not-executable'><span class='num'>127</span>function tests() {
</div><div class='line covered'><span class='num'>128</span>    test_node_good_path();
</div><div class='line covered'><span class='num'>129</span>    echo &quot;fim&quot;;
</div><div class='line covered'><span class='num'>130</span>}
</div><div class='line not-executable'><span class='num'>131</span>
</div><div class='line covered'><span class='num'>132</span>tests();
</div><div class='line not-executable'><span class='num'>133</span>
</div><div class='line covered'><span class='num'>134</span>$coverage = xdebug_get_code_coverage();
</div><div class='line not-executable'><span class='num'>135</span>xdebug_stop_code_coverage();
</div><div class='line not-executable'><span class='num'>136</span>
</div><div class='line not-executable'><span class='num'>137</span>// Salvar em arquivo
</div><div class='line not-executable'><span class='num'>138</span>file_put_contents(&#039;coverage.json&#039;, json_encode($coverage, JSON_PRETTY_PRINT));
</div><div class='line not-executable'><span class='num'>139</span>
</div><div class='line not-executable'><span class='num'>140</span>echo &#039;fim&#039;;</div><h2>/home/tarcisio/projects/graph/graph.php - 30.66% (195/636)</h2><div class='line not-executable'><span class='num'>1</span>&lt;?php
</div><div class='line not-executable'><span class='num'>2</span>
</div><div class='line not-executable'><span class='num'>3</span>declare(strict_types=1);
</div><div class='line not-executable'><span class='num'>4</span>
</div><div class='line not-executable'><span class='num'>5</span>final class User
</div><div class='line not-executable'><span class='num'>6</span>{
</div><div class='line not-executable'><span class='num'>7</span>    public string $id;
</div><div class='line not-executable'><span class='num'>8</span>    public ?string $ipAddress;
</div><div class='line not-executable'><span class='num'>9</span>    public Group $group;
</div><div class='line not-executable'><span class='num'>10</span>
</div><div class='line not-executable'><span class='num'>11</span>    public function __construct(string $id, ?string $ipAddress, Group $group)
</div><div class='line not-executable'><span class='num'>12</span>    {
</div><div class='line covered'><span class='num'>13</span>        $this-&gt;id = $id;
</div><div class='line covered'><span class='num'>14</span>        $this-&gt;ipAddress = $ipAddress;
</div><div class='line covered'><span class='num'>15</span>        $this-&gt;group = $group;
</div><div class='line covered'><span class='num'>16</span>    }
</div><div class='line not-executable'><span class='num'>17</span>
</div><div class='line not-executable'><span class='num'>18</span>    public function toArray(): array
</div><div class='line not-executable'><span class='num'>19</span>    {
</div><div class='line not-executable'><span class='num'>20</span>        return [
</div><div class='line not-covered'><span class='num'>21</span>            &#039;id&#039; =&gt; $this-&gt;id,
</div><div class='line not-executable'><span class='num'>22</span>            &#039;group&#039; =&gt; [
</div><div class='line not-covered'><span class='num'>23</span>                &#039;id&#039; =&gt; $this-&gt;group-&gt;id,
</div><div class='line not-executable'><span class='num'>24</span>            ],
</div><div class='line not-executable'><span class='num'>25</span>        ];
</div><div class='line not-covered'><span class='num'>26</span>    }
</div><div class='line not-executable'><span class='num'>27</span>}
</div><div class='line not-executable'><span class='num'>28</span>
</div><div class='line not-executable'><span class='num'>29</span>final class Group
</div><div class='line not-executable'><span class='num'>30</span>{
</div><div class='line not-executable'><span class='num'>31</span>    private const ALLOWED_GROUPS = [&#039;anonymous&#039;, &#039;consumer&#039;, &#039;contributor&#039;, &#039;admin&#039;];
</div><div class='line not-executable'><span class='num'>32</span>    
</div><div class='line not-executable'><span class='num'>33</span>    public string $id;
</div><div class='line not-executable'><span class='num'>34</span>    
</div><div class='line not-executable'><span class='num'>35</span>    public function __construct(string $id)
</div><div class='line not-executable'><span class='num'>36</span>    {
</div><div class='line covered'><span class='num'>37</span>        if (!in_array($id, self::ALLOWED_GROUPS, true)) {
</div><div class='line not-covered'><span class='num'>38</span>            throw new InvalidArgumentException(&quot;Invalid user group: {$id}&quot;);
</div><div class='line not-executable'><span class='num'>39</span>        }
</div><div class='line covered'><span class='num'>40</span>        $this-&gt;id  = $id;
</div><div class='line covered'><span class='num'>41</span>    }
</div><div class='line not-executable'><span class='num'>42</span>}
</div><div class='line not-executable'><span class='num'>43</span>
</div><div class='line not-executable'><span class='num'>44</span>final class Graph
</div><div class='line not-executable'><span class='num'>45</span>{
</div><div class='line not-executable'><span class='num'>46</span>    public array $nodes = [];
</div><div class='line not-executable'><span class='num'>47</span>    public array $edges = [];
</div><div class='line not-executable'><span class='num'>48</span>    public array $data  = [];
</div><div class='line not-executable'><span class='num'>49</span>    public array $layout = [];
</div><div class='line not-executable'><span class='num'>50</span>    public array $styles = [];
</div><div class='line not-executable'><span class='num'>51</span>
</div><div class='line not-executable'><span class='num'>52</span>    public function __construct(array $nodes, array $edges)
</div><div class='line not-executable'><span class='num'>53</span>    {
</div><div class='line not-covered'><span class='num'>54</span>        $this-&gt;nodes = $nodes;
</div><div class='line not-covered'><span class='num'>55</span>        $this-&gt;edges = $edges;
</div><div class='line not-covered'><span class='num'>56</span>    }
</div><div class='line not-executable'><span class='num'>57</span>
</div><div class='line not-executable'><span class='num'>58</span>    public function toArray(): array
</div><div class='line not-executable'><span class='num'>59</span>    {
</div><div class='line not-executable'><span class='num'>60</span>        return [
</div><div class='line not-covered'><span class='num'>61</span>            &#039;nodes&#039; =&gt; $this-&gt;nodes,
</div><div class='line not-covered'><span class='num'>62</span>            &#039;edges&#039; =&gt; $this-&gt;edges,
</div><div class='line not-covered'><span class='num'>63</span>            &#039;data&#039; =&gt; $this-&gt;data,
</div><div class='line not-covered'><span class='num'>64</span>            &#039;layout&#039; =&gt; $this-&gt;layout,
</div><div class='line not-covered'><span class='num'>65</span>            &#039;styles&#039; =&gt; $this-&gt;styles,
</div><div class='line not-executable'><span class='num'>66</span>        ];
</div><div class='line not-covered'><span class='num'>67</span>    }
</div><div class='line not-executable'><span class='num'>68</span>}
</div><div class='line not-executable'><span class='num'>69</span>
</div><div class='line not-executable'><span class='num'>70</span>final class Node
</div><div class='line not-executable'><span class='num'>71</span>{
</div><div class='line not-executable'><span class='num'>72</span>    private const ALLOWED_CATEGORIES  = [&#039;business&#039;, &#039;application&#039;, &#039;infrastructure&#039;];
</div><div class='line not-executable'><span class='num'>73</span>    private const ALLOWED_TYPES       = [&#039;server&#039;, &#039;database&#039;, &#039;application&#039;, &#039;network&#039;];
</div><div class='line not-executable'><span class='num'>74</span>    private const ID_VALIDATION_REGEX = &#039;/^[a-zA-Z0-9\-_]+$/&#039;;
</div><div class='line not-executable'><span class='num'>75</span>    private const LABEL_MAX_LENGTH    = 20;
</div><div class='line not-executable'><span class='num'>76</span>    
</div><div class='line not-executable'><span class='num'>77</span>    public string $id;
</div><div class='line not-executable'><span class='num'>78</span>    public string $label;
</div><div class='line not-executable'><span class='num'>79</span>    public string $category;
</div><div class='line not-executable'><span class='num'>80</span>    public string $type;
</div><div class='line not-executable'><span class='num'>81</span>
</div><div class='line not-executable'><span class='num'>82</span>    public array $data = [];
</div><div class='line not-executable'><span class='num'>83</span>
</div><div class='line not-executable'><span class='num'>84</span>    public function __construct(string $id, string $label, string $category, string $type, array $data)
</div><div class='line not-executable'><span class='num'>85</span>    {
</div><div class='line covered'><span class='num'>86</span>        $this-&gt;validate($id, $label, $category, $type);
</div><div class='line covered'><span class='num'>87</span>        $this-&gt;id       = $id;
</div><div class='line covered'><span class='num'>88</span>        $this-&gt;label    = $label;
</div><div class='line covered'><span class='num'>89</span>        $this-&gt;category = $category;
</div><div class='line covered'><span class='num'>90</span>        $this-&gt;type     = $type;
</div><div class='line covered'><span class='num'>91</span>        $this-&gt;data     = $data;
</div><div class='line covered'><span class='num'>92</span>    }
</div><div class='line not-executable'><span class='num'>93</span>
</div><div class='line not-executable'><span class='num'>94</span>    private function validate(string $id, string $label, string $category, string $type): void
</div><div class='line not-executable'><span class='num'>95</span>    {
</div><div class='line covered'><span class='num'>96</span>        if (!preg_match(self::ID_VALIDATION_REGEX, $id)) {
</div><div class='line not-covered'><span class='num'>97</span>            throw new InvalidArgumentException(&quot;Invalid node ID: {$id}&quot;);
</div><div class='line not-executable'><span class='num'>98</span>        }
</div><div class='line not-executable'><span class='num'>99</span>
</div><div class='line covered'><span class='num'>100</span>        if (strlen($label) &gt; self::LABEL_MAX_LENGTH) {
</div><div class='line not-covered'><span class='num'>101</span>            throw new InvalidArgumentException(&quot;Node label exceeds maximum length of &quot; . self::LABEL_MAX_LENGTH);
</div><div class='line not-executable'><span class='num'>102</span>        }
</div><div class='line not-executable'><span class='num'>103</span>
</div><div class='line covered'><span class='num'>104</span>        if (!in_array($category, self::ALLOWED_CATEGORIES, true)) {
</div><div class='line not-covered'><span class='num'>105</span>            throw new InvalidArgumentException(&quot;Invalid node category: {$category}&quot;);
</div><div class='line not-executable'><span class='num'>106</span>        }
</div><div class='line not-executable'><span class='num'>107</span>
</div><div class='line covered'><span class='num'>108</span>        if (!in_array($type, self::ALLOWED_TYPES, true)) {
</div><div class='line not-covered'><span class='num'>109</span>            throw new InvalidArgumentException(&quot;Invalid node type: {$type}&quot;);
</div><div class='line not-executable'><span class='num'>110</span>        }
</div><div class='line covered'><span class='num'>111</span>    }
</div><div class='line not-executable'><span class='num'>112</span>
</div><div class='line not-executable'><span class='num'>113</span>    public function toArray(): array
</div><div class='line not-executable'><span class='num'>114</span>    {
</div><div class='line not-executable'><span class='num'>115</span>        return [
</div><div class='line covered'><span class='num'>116</span>            &#039;id&#039;       =&gt; $this-&gt;id,
</div><div class='line covered'><span class='num'>117</span>            &#039;label&#039;    =&gt; $this-&gt;label,
</div><div class='line covered'><span class='num'>118</span>            &#039;category&#039; =&gt; $this-&gt;category,
</div><div class='line covered'><span class='num'>119</span>            &#039;type&#039;     =&gt; $this-&gt;type,
</div><div class='line covered'><span class='num'>120</span>            &#039;data&#039;     =&gt; $this-&gt;data
</div><div class='line not-executable'><span class='num'>121</span>        ];
</div><div class='line not-covered'><span class='num'>122</span>    }
</div><div class='line not-executable'><span class='num'>123</span>}
</div><div class='line not-executable'><span class='num'>124</span>
</div><div class='line not-executable'><span class='num'>125</span>final class NodeStatus
</div><div class='line not-executable'><span class='num'>126</span>{
</div><div class='line not-executable'><span class='num'>127</span>    private const ALLOWED_NODE_STATUSES = [&#039;unknown&#039;, &#039;healthy&#039;, &#039;unhealthy&#039;, &#039;maintenance&#039;];
</div><div class='line not-executable'><span class='num'>128</span>
</div><div class='line not-executable'><span class='num'>129</span>    public string $nodeId;
</div><div class='line not-executable'><span class='num'>130</span>    public string $status;
</div><div class='line not-executable'><span class='num'>131</span>
</div><div class='line not-executable'><span class='num'>132</span>    public function __construct(string $nodeId, string $status)
</div><div class='line not-executable'><span class='num'>133</span>    {
</div><div class='line not-covered'><span class='num'>134</span>        if (!in_array($status, self::ALLOWED_NODE_STATUSES, true)) {
</div><div class='line not-covered'><span class='num'>135</span>            throw new InvalidArgumentException(&quot;Invalid node status: {$status}&quot;);
</div><div class='line not-executable'><span class='num'>136</span>        }
</div><div class='line not-covered'><span class='num'>137</span>        $this-&gt;nodeId = $nodeId;
</div><div class='line not-covered'><span class='num'>138</span>        $this-&gt;status = $status;
</div><div class='line not-covered'><span class='num'>139</span>    }
</div><div class='line not-executable'><span class='num'>140</span>
</div><div class='line not-executable'><span class='num'>141</span>    public function toArray(): array
</div><div class='line not-executable'><span class='num'>142</span>    {
</div><div class='line not-executable'><span class='num'>143</span>        return [
</div><div class='line not-covered'><span class='num'>144</span>            &#039;node_id&#039; =&gt; $this-&gt;nodeId,
</div><div class='line not-covered'><span class='num'>145</span>            &#039;status&#039;  =&gt; $this-&gt;status,
</div><div class='line not-executable'><span class='num'>146</span>        ];
</div><div class='line not-covered'><span class='num'>147</span>    }
</div><div class='line not-executable'><span class='num'>148</span>}
</div><div class='line not-executable'><span class='num'>149</span>
</div><div class='line not-executable'><span class='num'>150</span>final class NodeStatuses
</div><div class='line not-executable'><span class='num'>151</span>{
</div><div class='line not-executable'><span class='num'>152</span>    public array $statuses = [];
</div><div class='line not-executable'><span class='num'>153</span>
</div><div class='line not-executable'><span class='num'>154</span>    public function addStatus(NodeStatus $status): void
</div><div class='line not-executable'><span class='num'>155</span>    {
</div><div class='line not-covered'><span class='num'>156</span>        $this-&gt;statuses[] = $status;
</div><div class='line not-covered'><span class='num'>157</span>    }
</div><div class='line not-executable'><span class='num'>158</span>}
</div><div class='line not-executable'><span class='num'>159</span>
</div><div class='line not-executable'><span class='num'>160</span>final class Nodes
</div><div class='line not-executable'><span class='num'>161</span>{
</div><div class='line not-executable'><span class='num'>162</span>    public array $nodes = [];
</div><div class='line not-executable'><span class='num'>163</span>
</div><div class='line not-executable'><span class='num'>164</span>    public function addNode(Node $node): void
</div><div class='line not-executable'><span class='num'>165</span>    {
</div><div class='line not-covered'><span class='num'>166</span>        $this-&gt;nodes[] = $node;
</div><div class='line not-covered'><span class='num'>167</span>    }
</div><div class='line not-executable'><span class='num'>168</span>}
</div><div class='line not-executable'><span class='num'>169</span>
</div><div class='line not-executable'><span class='num'>170</span>final class Edge
</div><div class='line not-executable'><span class='num'>171</span>{
</div><div class='line not-executable'><span class='num'>172</span>    public ?string $id;
</div><div class='line not-executable'><span class='num'>173</span>    public string $source;
</div><div class='line not-executable'><span class='num'>174</span>    public string $target;
</div><div class='line not-executable'><span class='num'>175</span>    public array $data;
</div><div class='line not-executable'><span class='num'>176</span>
</div><div class='line not-executable'><span class='num'>177</span>    public function __construct(?string $id = null, string $source, string $target, array $data = [])
</div><div class='line not-executable'><span class='num'>178</span>    {
</div><div class='line covered'><span class='num'>179</span>        $this-&gt;id     = $id;
</div><div class='line covered'><span class='num'>180</span>        $this-&gt;source = $source;
</div><div class='line covered'><span class='num'>181</span>        $this-&gt;target = $target;
</div><div class='line covered'><span class='num'>182</span>        $this-&gt;data   = $data;
</div><div class='line covered'><span class='num'>183</span>    }
</div><div class='line not-executable'><span class='num'>184</span>
</div><div class='line not-executable'><span class='num'>185</span>    public function toArray(): array
</div><div class='line not-executable'><span class='num'>186</span>    {
</div><div class='line not-executable'><span class='num'>187</span>        return [
</div><div class='line covered'><span class='num'>188</span>            &#039;id&#039;     =&gt; $this-&gt;id,
</div><div class='line covered'><span class='num'>189</span>            &#039;source&#039; =&gt; $this-&gt;source,
</div><div class='line covered'><span class='num'>190</span>            &#039;target&#039; =&gt; $this-&gt;target,
</div><div class='line covered'><span class='num'>191</span>            &#039;data&#039;   =&gt; $this-&gt;data
</div><div class='line not-executable'><span class='num'>192</span>        ];
</div><div class='line not-covered'><span class='num'>193</span>    }
</div><div class='line not-executable'><span class='num'>194</span>}
</div><div class='line not-executable'><span class='num'>195</span>
</div><div class='line not-executable'><span class='num'>196</span>final class Edges
</div><div class='line not-executable'><span class='num'>197</span>{
</div><div class='line not-executable'><span class='num'>198</span>    public array $edges = [];
</div><div class='line not-executable'><span class='num'>199</span>    public function addEdge(Edge $edge): void
</div><div class='line not-executable'><span class='num'>200</span>    {
</div><div class='line not-covered'><span class='num'>201</span>        $this-&gt;edges[] = $edge;
</div><div class='line not-covered'><span class='num'>202</span>    }
</div><div class='line not-executable'><span class='num'>203</span>}
</div><div class='line not-executable'><span class='num'>204</span>
</div><div class='line not-executable'><span class='num'>205</span>final class AuditLog
</div><div class='line not-executable'><span class='num'>206</span>{
</div><div class='line not-executable'><span class='num'>207</span>    public string $entityType;
</div><div class='line not-executable'><span class='num'>208</span>    public string $entityId;
</div><div class='line not-executable'><span class='num'>209</span>    public string $action;
</div><div class='line not-executable'><span class='num'>210</span>    public ?array $oldData;
</div><div class='line not-executable'><span class='num'>211</span>    public ?array $newData;
</div><div class='line not-executable'><span class='num'>212</span>    public string $userId;
</div><div class='line not-executable'><span class='num'>213</span>    public string $ipAddress;
</div><div class='line not-executable'><span class='num'>214</span>    public string $createdAt;
</div><div class='line not-executable'><span class='num'>215</span>
</div><div class='line not-executable'><span class='num'>216</span>    public function __construct(string $entityType, string $entityId, string $action, ?array $oldData = null, ?array $newData = null)
</div><div class='line not-executable'><span class='num'>217</span>    {
</div><div class='line covered'><span class='num'>218</span>        $this-&gt;entityType = $entityType;
</div><div class='line covered'><span class='num'>219</span>        $this-&gt;entityId   = $entityId;
</div><div class='line covered'><span class='num'>220</span>        $this-&gt;action     = $action;
</div><div class='line covered'><span class='num'>221</span>        $this-&gt;oldData    = $oldData;
</div><div class='line covered'><span class='num'>222</span>        $this-&gt;newData    = $newData;
</div><div class='line covered'><span class='num'>223</span>    }
</div><div class='line not-executable'><span class='num'>224</span>}
</div><div class='line not-executable'><span class='num'>225</span>
</div><div class='line not-executable'><span class='num'>226</span>final class AuditLogs
</div><div class='line not-executable'><span class='num'>227</span>{
</div><div class='line not-executable'><span class='num'>228</span>    public array $logs = [];
</div><div class='line not-executable'><span class='num'>229</span>    public function addLog(AuditLog $log): void
</div><div class='line not-executable'><span class='num'>230</span>    {
</div><div class='line not-covered'><span class='num'>231</span>        $this-&gt;logs[] = $log;
</div><div class='line not-covered'><span class='num'>232</span>    }
</div><div class='line not-executable'><span class='num'>233</span>}
</div><div class='line not-executable'><span class='num'>234</span>
</div><div class='line not-executable'><span class='num'>235</span>final class GraphContext
</div><div class='line not-executable'><span class='num'>236</span>{
</div><div class='line not-executable'><span class='num'>237</span>    public static User $user;
</div><div class='line not-executable'><span class='num'>238</span>}
</div><div class='line not-executable'><span class='num'>239</span>
</div><div class='line not-executable'><span class='num'>240</span>interface LoggerInterface
</div><div class='line not-executable'><span class='num'>241</span>{
</div><div class='line not-executable'><span class='num'>242</span>    public function info(string $message, array $data = []): void;
</div><div class='line not-executable'><span class='num'>243</span>    public function debug(string $message, array $data = []): void;
</div><div class='line not-executable'><span class='num'>244</span>    public function error(string $message, array $data = []): void;
</div><div class='line not-executable'><span class='num'>245</span>}
</div><div class='line not-executable'><span class='num'>246</span>
</div><div class='line not-executable'><span class='num'>247</span>final class Logger implements LoggerInterface
</div><div class='line not-executable'><span class='num'>248</span>{
</div><div class='line not-executable'><span class='num'>249</span>    private string $fileName;
</div><div class='line not-executable'><span class='num'>250</span>    private $fd;
</div><div class='line not-executable'><span class='num'>251</span>
</div><div class='line not-executable'><span class='num'>252</span>    public function __construct($file_name)
</div><div class='line not-executable'><span class='num'>253</span>    {
</div><div class='line covered'><span class='num'>254</span>        $this-&gt;fileName = $file_name;
</div><div class='line covered'><span class='num'>255</span>        $this-&gt;fd = fopen($this-&gt;fileName, &#039;a&#039;);
</div><div class='line covered'><span class='num'>256</span>    }
</div><div class='line not-executable'><span class='num'>257</span>
</div><div class='line not-executable'><span class='num'>258</span>    public function info(string $message, array $data = []): void
</div><div class='line not-executable'><span class='num'>259</span>    {
</div><div class='line covered'><span class='num'>260</span>        $this-&gt;log(&#039;INFO&#039;, $message, $data);
</div><div class='line covered'><span class='num'>261</span>    }
</div><div class='line not-executable'><span class='num'>262</span>
</div><div class='line not-executable'><span class='num'>263</span>    public function debug(string $message, array $data = []): void
</div><div class='line not-executable'><span class='num'>264</span>    {
</div><div class='line covered'><span class='num'>265</span>        $this-&gt;log(&#039;DEBUG&#039;, $message, $data);
</div><div class='line covered'><span class='num'>266</span>    }
</div><div class='line not-executable'><span class='num'>267</span>
</div><div class='line not-executable'><span class='num'>268</span>    public function error(string $message, array $data = []): void
</div><div class='line not-executable'><span class='num'>269</span>    {
</div><div class='line not-covered'><span class='num'>270</span>        $this-&gt;log(&#039;ERROR&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>271</span>    }
</div><div class='line not-executable'><span class='num'>272</span>
</div><div class='line not-executable'><span class='num'>273</span>    private function log(string $type, $message, $data = [])
</div><div class='line not-executable'><span class='num'>274</span>    {
</div><div class='line covered'><span class='num'>275</span>        $trace = debug_backtrace(DEBUG_BACKTRACE_PROVIDE_OBJECT, 3);
</div><div class='line covered'><span class='num'>276</span>        $method = &quot;{$trace[2][&#039;class&#039;]}::{$trace[2][&#039;function&#039;]}&quot;;
</div><div class='line covered'><span class='num'>277</span>        $data = json_encode($data);
</div><div class='line covered'><span class='num'>278</span>        $message = &quot;[{$type}] {$method}: $message ($data)\n&quot;;
</div><div class='line covered'><span class='num'>279</span>        fwrite($this-&gt;fd, $message);
</div><div class='line covered'><span class='num'>280</span>    }
</div><div class='line not-executable'><span class='num'>281</span>}
</div><div class='line not-executable'><span class='num'>282</span>
</div><div class='line not-executable'><span class='num'>283</span>interface GraphDatabaseInterface
</div><div class='line not-executable'><span class='num'>284</span>{
</div><div class='line not-executable'><span class='num'>285</span>    public function getUser(string $id): ?array;
</div><div class='line not-executable'><span class='num'>286</span>    public function insertUser(string $id, string $group): void;
</div><div class='line not-executable'><span class='num'>287</span>    public function updateUser(string $id, string $group): void;
</div><div class='line not-executable'><span class='num'>288</span>
</div><div class='line not-executable'><span class='num'>289</span>    public function getNode(string $id): ?array;
</div><div class='line not-executable'><span class='num'>290</span>    public function getNodes(): array;
</div><div class='line not-executable'><span class='num'>291</span>    public function insertNode(string $id, string $label, string $category, string $type, array $data = []): void;
</div><div class='line not-executable'><span class='num'>292</span>    public function updateNode(string $id, string $label, string $category, string $type, array $data = []): void;
</div><div class='line not-executable'><span class='num'>293</span>    public function deleteNode(string $id): void;
</div><div class='line not-executable'><span class='num'>294</span>
</div><div class='line not-executable'><span class='num'>295</span>    public function getEdge(string $source, string $target): ?array;
</div><div class='line not-executable'><span class='num'>296</span>    public function getEdgeById(string $id): ?array;
</div><div class='line not-executable'><span class='num'>297</span>    public function getEdges(): array;
</div><div class='line not-executable'><span class='num'>298</span>    public function insertEdge(string $id, string $source, string $target, array $data = []): void;
</div><div class='line not-executable'><span class='num'>299</span>    public function updateEdge(string $id, string $source, string $target, array $data = []): void;
</div><div class='line not-executable'><span class='num'>300</span>    public function deleteEdge(string $id): void;
</div><div class='line not-executable'><span class='num'>301</span>
</div><div class='line not-executable'><span class='num'>302</span>    public function getStatuses(): array;
</div><div class='line not-executable'><span class='num'>303</span>    public function getNodeStatus(string $id): ?string;
</div><div class='line not-executable'><span class='num'>304</span>    public function setNodeStatus(string $id, string $status): void;
</div><div class='line not-executable'><span class='num'>305</span>
</div><div class='line not-executable'><span class='num'>306</span>    public function getLogs($limit): array;
</div><div class='line not-executable'><span class='num'>307</span>    public function insertAuditLog(
</div><div class='line not-executable'><span class='num'>308</span>        string $entity_type, 
</div><div class='line not-executable'><span class='num'>309</span>        string $entity_id, 
</div><div class='line not-executable'><span class='num'>310</span>        string $action, 
</div><div class='line not-executable'><span class='num'>311</span>        ?array $old_data = null, 
</div><div class='line not-executable'><span class='num'>312</span>        ?array $new_data = null,
</div><div class='line not-executable'><span class='num'>313</span>        string $user_id,
</div><div class='line not-executable'><span class='num'>314</span>        string $ip_address): bool;
</div><div class='line not-executable'><span class='num'>315</span>}
</div><div class='line not-executable'><span class='num'>316</span>
</div><div class='line not-executable'><span class='num'>317</span>final class DatabaseException extends RuntimeException
</div><div class='line not-executable'><span class='num'>318</span>{
</div><div class='line not-executable'><span class='num'>319</span>    private ?string $query;
</div><div class='line not-executable'><span class='num'>320</span>    private ?array $params;
</div><div class='line not-executable'><span class='num'>321</span>
</div><div class='line not-executable'><span class='num'>322</span>    
</div><div class='line not-executable'><span class='num'>323</span>    public function __construct(string $message = &quot;&quot;,  int $code = 0, ?Throwable $previous = null, ?string $query = null, ?array $params) {
</div><div class='line not-covered'><span class='num'>324</span>        parent::__construct($message, $code, $previous);
</div><div class='line not-covered'><span class='num'>325</span>        $this-&gt;query = $query;
</div><div class='line not-covered'><span class='num'>326</span>        $this-&gt;params = $params;
</div><div class='line not-covered'><span class='num'>327</span>    }
</div><div class='line not-executable'><span class='num'>328</span>}
</div><div class='line not-executable'><span class='num'>329</span>
</div><div class='line not-executable'><span class='num'>330</span>final class GraphDatabase implements GraphDatabaseInterface
</div><div class='line not-executable'><span class='num'>331</span>{
</div><div class='line not-executable'><span class='num'>332</span>    private PDO $pdo;
</div><div class='line not-executable'><span class='num'>333</span>    private Logger $logger;
</div><div class='line not-executable'><span class='num'>334</span>
</div><div class='line not-executable'><span class='num'>335</span>    public function __construct(PDO $pdo, Logger $logger)
</div><div class='line not-executable'><span class='num'>336</span>    {
</div><div class='line covered'><span class='num'>337</span>        $this-&gt;pdo = $pdo;
</div><div class='line covered'><span class='num'>338</span>        $this-&gt;logger = $logger;
</div><div class='line covered'><span class='num'>339</span>        $this-&gt;initSchema();
</div><div class='line covered'><span class='num'>340</span>    }
</div><div class='line not-executable'><span class='num'>341</span>
</div><div class='line not-executable'><span class='num'>342</span>    public function getUser(string $id): ?array
</div><div class='line not-executable'><span class='num'>343</span>    {
</div><div class='line not-covered'><span class='num'>344</span>        $this-&gt;logger-&gt;debug(&quot;getting user id: &#039;{$id}&#039;&quot;);
</div><div class='line not-executable'><span class='num'>345</span>        try {
</div><div class='line not-covered'><span class='num'>346</span>            $sql = &quot;SELECT * FROM users WHERE id = :id&quot;;
</div><div class='line not-covered'><span class='num'>347</span>            $params = [&#039;:id&#039; =&gt; $id];
</div><div class='line not-covered'><span class='num'>348</span>            $stmt = $this-&gt;pdo-&gt;prepare($sql);
</div><div class='line not-covered'><span class='num'>349</span>            $stmt-&gt;execute($params);
</div><div class='line not-covered'><span class='num'>350</span>            $row = $stmt-&gt;fetch();
</div><div class='line not-executable'><span class='num'>351</span>
</div><div class='line not-covered'><span class='num'>352</span>            if ($row) {
</div><div class='line not-covered'><span class='num'>353</span>                return $row;
</div><div class='line not-executable'><span class='num'>354</span>            }
</div><div class='line not-covered'><span class='num'>355</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>356</span>            $e = new DatabaseException(
</div><div class='line not-covered'><span class='num'>357</span>                &quot;GraphDatabase Exception while trying to get user data. ID: {$id}&quot;,
</div><div class='line not-covered'><span class='num'>358</span>                0,
</div><div class='line not-executable'><span class='num'>359</span>                $e,
</div><div class='line not-executable'><span class='num'>360</span>                $sql,
</div><div class='line not-executable'><span class='num'>361</span>                $params
</div><div class='line not-executable'><span class='num'>362</span>            );
</div><div class='line not-executable'><span class='num'>363</span>        }
</div><div class='line not-covered'><span class='num'>364</span>        return null;
</div><div class='line not-covered'><span class='num'>365</span>    }
</div><div class='line not-executable'><span class='num'>366</span>
</div><div class='line not-executable'><span class='num'>367</span>    public function insertUser(string $id, string $group): void
</div><div class='line not-executable'><span class='num'>368</span>    {
</div><div class='line not-executable'><span class='num'>369</span>        try {
</div><div class='line not-covered'><span class='num'>370</span>            $sql = &quot;
</div><div class='line not-executable'><span class='num'>371</span>                INSERT OR IGNORE INTO users 
</div><div class='line not-executable'><span class='num'>372</span>                (id, user_group)
</div><div class='line not-executable'><span class='num'>373</span>                VALUES (:id, :group)&quot;;
</div><div class='line not-executable'><span class='num'>374</span>            
</div><div class='line not-covered'><span class='num'>375</span>            $params = [
</div><div class='line not-covered'><span class='num'>376</span>                &#039;:id&#039;       =&gt; $id,
</div><div class='line not-covered'><span class='num'>377</span>                &#039;:group&#039;    =&gt; $group
</div><div class='line not-executable'><span class='num'>378</span>            ];
</div><div class='line not-executable'><span class='num'>379</span>
</div><div class='line not-covered'><span class='num'>380</span>            $stmt = $this-&gt;pdo-&gt;prepare($sql);
</div><div class='line not-covered'><span class='num'>381</span>            $stmt-&gt;execute($params);
</div><div class='line not-covered'><span class='num'>382</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>383</span>            $e = new DatabaseException(
</div><div class='line not-covered'><span class='num'>384</span>                &quot;GraphDatabase Exception while trying to insert new user. ID: {$id}&quot;,
</div><div class='line not-covered'><span class='num'>385</span>                0,
</div><div class='line not-executable'><span class='num'>386</span>                $e,
</div><div class='line not-executable'><span class='num'>387</span>                $sql,
</div><div class='line not-executable'><span class='num'>388</span>                $params
</div><div class='line not-executable'><span class='num'>389</span>            );
</div><div class='line not-executable'><span class='num'>390</span>        }
</div><div class='line not-covered'><span class='num'>391</span>    }
</div><div class='line not-executable'><span class='num'>392</span>
</div><div class='line not-executable'><span class='num'>393</span>    public function updateUser(string $id, string $group): void
</div><div class='line not-executable'><span class='num'>394</span>    {
</div><div class='line not-executable'><span class='num'>395</span>        try {
</div><div class='line not-covered'><span class='num'>396</span>            $sql = &quot;
</div><div class='line not-executable'><span class='num'>397</span>                UPDATE users
</div><div class='line not-executable'><span class='num'>398</span>                SET    user_group = :group
</div><div class='line not-executable'><span class='num'>399</span>                WHERE  id = :id
</div><div class='line not-executable'><span class='num'>400</span>            &quot;;
</div><div class='line not-executable'><span class='num'>401</span>
</div><div class='line not-covered'><span class='num'>402</span>            $params = [
</div><div class='line not-covered'><span class='num'>403</span>                &#039;:id&#039;       =&gt; $id,
</div><div class='line not-covered'><span class='num'>404</span>                &#039;:group&#039;    =&gt; $group
</div><div class='line not-executable'><span class='num'>405</span>            ];
</div><div class='line not-executable'><span class='num'>406</span>
</div><div class='line not-covered'><span class='num'>407</span>            $stmt = $this-&gt;pdo-&gt;prepare($sql);
</div><div class='line not-executable'><span class='num'>408</span>            
</div><div class='line not-covered'><span class='num'>409</span>            $stmt-&gt;execute($params);
</div><div class='line not-executable'><span class='num'>410</span>
</div><div class='line not-covered'><span class='num'>411</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>412</span>            $e = new DatabaseException(
</div><div class='line not-covered'><span class='num'>413</span>                &quot;GraphDatabase Exception while trying to update user. ID: {$id}&quot;,
</div><div class='line not-covered'><span class='num'>414</span>                0,
</div><div class='line not-executable'><span class='num'>415</span>                $e,
</div><div class='line not-executable'><span class='num'>416</span>                $sql,
</div><div class='line not-executable'><span class='num'>417</span>                $params
</div><div class='line not-executable'><span class='num'>418</span>            );
</div><div class='line not-executable'><span class='num'>419</span>        }
</div><div class='line not-covered'><span class='num'>420</span>    }
</div><div class='line not-executable'><span class='num'>421</span>
</div><div class='line not-executable'><span class='num'>422</span>    public function getNode(string $id): ?array
</div><div class='line not-executable'><span class='num'>423</span>    {
</div><div class='line covered'><span class='num'>424</span>        $this-&gt;logger-&gt;debug(&quot;fetching node &#039;{$id}&#039;&quot;);
</div><div class='line not-executable'><span class='num'>425</span>
</div><div class='line not-executable'><span class='num'>426</span>        try {
</div><div class='line covered'><span class='num'>427</span>            $sql = &quot;SELECT * FROM nodes WHERE id = :id&quot;;
</div><div class='line covered'><span class='num'>428</span>            $params = [&#039;:id&#039; =&gt; $id];
</div><div class='line covered'><span class='num'>429</span>            $stmt = $this-&gt;pdo-&gt;prepare($sql);
</div><div class='line covered'><span class='num'>430</span>            $stmt-&gt;execute($params);
</div><div class='line covered'><span class='num'>431</span>            $row = $stmt-&gt;fetch();
</div><div class='line covered'><span class='num'>432</span>            if ($row) {
</div><div class='line covered'><span class='num'>433</span>                return $row;
</div><div class='line not-executable'><span class='num'>434</span>            }
</div><div class='line not-covered'><span class='num'>435</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>436</span>            $this-&gt;logger-&gt;error(&quot;exception with node id &#039;{$id}&#039;&quot;);
</div><div class='line not-covered'><span class='num'>437</span>            throw new DatabaseException(&quot;could not get node data with id &#039;{$id}&#039;&quot;, 0, $e, $sql, $params);
</div><div class='line not-executable'><span class='num'>438</span>        }
</div><div class='line not-covered'><span class='num'>439</span>        return null;
</div><div class='line not-covered'><span class='num'>440</span>    }
</div><div class='line not-executable'><span class='num'>441</span>
</div><div class='line not-executable'><span class='num'>442</span>    public function getNodes(): array
</div><div class='line not-executable'><span class='num'>443</span>    {
</div><div class='line not-executable'><span class='num'>444</span>        try {
</div><div class='line not-covered'><span class='num'>445</span>            $stmt = $this-&gt;pdo-&gt;query(&quot;SELECT * FROM nodes&quot;);
</div><div class='line not-covered'><span class='num'>446</span>            $rows = $stmt-&gt;fetchAll();
</div><div class='line not-covered'><span class='num'>447</span>            return $rows;
</div><div class='line not-covered'><span class='num'>448</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>449</span>            error_log(&quot;GraphDatabase fetch all nodes failed: &quot; . $e-&gt;getMessage());
</div><div class='line not-covered'><span class='num'>450</span>            return [];
</div><div class='line not-executable'><span class='num'>451</span>        }
</div><div class='line not-covered'><span class='num'>452</span>    }
</div><div class='line not-executable'><span class='num'>453</span>
</div><div class='line not-executable'><span class='num'>454</span>    public function insertNode(string $id, string $label, string $category, string $type, array $data = []): void
</div><div class='line not-executable'><span class='num'>455</span>    {
</div><div class='line not-executable'><span class='num'>456</span>        try {
</div><div class='line covered'><span class='num'>457</span>            $sql = &quot;
</div><div class='line not-executable'><span class='num'>458</span>                INSERT OR IGNORE INTO nodes 
</div><div class='line not-executable'><span class='num'>459</span>                (id, label, category, type, data) 
</div><div class='line not-executable'><span class='num'>460</span>                VALUES (:id, :label, :category, :type, :data)&quot;;
</div><div class='line covered'><span class='num'>461</span>            $stmt             = $this-&gt;pdo-&gt;prepare($sql);
</div><div class='line covered'><span class='num'>462</span>            $data[&#039;id&#039;]       = $id;
</div><div class='line covered'><span class='num'>463</span>            $data[&#039;label&#039;]    = $label;
</div><div class='line covered'><span class='num'>464</span>            $data[&#039;category&#039;] = $category;
</div><div class='line covered'><span class='num'>465</span>            $data[&#039;type&#039;]     = $type;
</div><div class='line covered'><span class='num'>466</span>            $stmt-&gt;execute([
</div><div class='line covered'><span class='num'>467</span>                &#039;:id&#039;       =&gt; $id,
</div><div class='line covered'><span class='num'>468</span>                &#039;:label&#039;    =&gt; $label,
</div><div class='line covered'><span class='num'>469</span>                &#039;:category&#039; =&gt; $category,
</div><div class='line covered'><span class='num'>470</span>                &#039;:type&#039;     =&gt; $type,
</div><div class='line covered'><span class='num'>471</span>                &#039;:data&#039;     =&gt; json_encode($data, JSON_UNESCAPED_UNICODE)
</div><div class='line not-executable'><span class='num'>472</span>            ]);
</div><div class='line not-covered'><span class='num'>473</span>        } catch (PDOException $e) {
</div><div class='line not-executable'><span class='num'>474</span>            // TODO
</div><div class='line not-executable'><span class='num'>475</span>        }
</div><div class='line covered'><span class='num'>476</span>    }
</div><div class='line not-executable'><span class='num'>477</span>
</div><div class='line not-executable'><span class='num'>478</span>    public function updateNode(string $id, string $label, string $category, string $type, array $data = []): void
</div><div class='line not-executable'><span class='num'>479</span>    {
</div><div class='line not-executable'><span class='num'>480</span>        try {
</div><div class='line not-covered'><span class='num'>481</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-executable'><span class='num'>482</span>                UPDATE nodes
</div><div class='line not-executable'><span class='num'>483</span>                SET    label = :label, 
</div><div class='line not-executable'><span class='num'>484</span>                       category = :category, 
</div><div class='line not-executable'><span class='num'>485</span>                       type = :type, 
</div><div class='line not-executable'><span class='num'>486</span>                       data = :data
</div><div class='line not-executable'><span class='num'>487</span>                WHERE  id = :id&quot;);
</div><div class='line not-covered'><span class='num'>488</span>            $data[&#039;id&#039;]       = $id;
</div><div class='line not-covered'><span class='num'>489</span>            $data[&#039;label&#039;]    = $label;
</div><div class='line not-covered'><span class='num'>490</span>            $data[&#039;category&#039;] = $category;
</div><div class='line not-covered'><span class='num'>491</span>            $data[&#039;type&#039;]     = $type;
</div><div class='line not-executable'><span class='num'>492</span>
</div><div class='line not-covered'><span class='num'>493</span>            $stmt-&gt;execute([
</div><div class='line not-covered'><span class='num'>494</span>                &#039;:id&#039;       =&gt; $id,
</div><div class='line not-covered'><span class='num'>495</span>                &#039;:label&#039;    =&gt; $label,
</div><div class='line not-covered'><span class='num'>496</span>                &#039;:category&#039; =&gt; $category,
</div><div class='line not-covered'><span class='num'>497</span>                &#039;:type&#039;     =&gt; $type,
</div><div class='line not-covered'><span class='num'>498</span>                &#039;:data&#039;     =&gt; json_encode($data, JSON_UNESCAPED_UNICODE)
</div><div class='line not-executable'><span class='num'>499</span>            ]);
</div><div class='line not-covered'><span class='num'>500</span>        } catch (PDOException $e) {
</div><div class='line not-executable'><span class='num'>501</span>            // TODO
</div><div class='line not-executable'><span class='num'>502</span>        }
</div><div class='line not-covered'><span class='num'>503</span>    }
</div><div class='line not-executable'><span class='num'>504</span>
</div><div class='line not-executable'><span class='num'>505</span>    public function deleteNode(string $id): void
</div><div class='line not-executable'><span class='num'>506</span>    {
</div><div class='line not-executable'><span class='num'>507</span>        try {
</div><div class='line not-covered'><span class='num'>508</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;DELETE FROM nodes WHERE id = :id&quot;);
</div><div class='line not-covered'><span class='num'>509</span>            $stmt-&gt;execute([&#039;:id&#039; =&gt; $id]);
</div><div class='line not-covered'><span class='num'>510</span>        } catch (PDOException $e) {
</div><div class='line not-executable'><span class='num'>511</span>            // TODO
</div><div class='line not-executable'><span class='num'>512</span>        }
</div><div class='line not-covered'><span class='num'>513</span>    }
</div><div class='line not-executable'><span class='num'>514</span>
</div><div class='line not-executable'><span class='num'>515</span>    public function getEdge(string $source, string $target): ?array
</div><div class='line not-executable'><span class='num'>516</span>    {
</div><div class='line not-executable'><span class='num'>517</span>        try {
</div><div class='line covered'><span class='num'>518</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-executable'><span class='num'>519</span>                SELECT * FROM edges
</div><div class='line not-executable'><span class='num'>520</span>                WHERE source = :source AND target = :target
</div><div class='line not-executable'><span class='num'>521</span>            &quot;);
</div><div class='line covered'><span class='num'>522</span>            $stmt-&gt;execute([
</div><div class='line covered'><span class='num'>523</span>                &#039;:source&#039; =&gt; $source,
</div><div class='line covered'><span class='num'>524</span>                &#039;:target&#039; =&gt; $target
</div><div class='line not-executable'><span class='num'>525</span>            ]);
</div><div class='line covered'><span class='num'>526</span>            $row = $stmt-&gt;fetch();
</div><div class='line covered'><span class='num'>527</span>            if ($row) {
</div><div class='line covered'><span class='num'>528</span>                return $row;
</div><div class='line not-executable'><span class='num'>529</span>            }
</div><div class='line not-covered'><span class='num'>530</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>531</span>            error_log(&quot;GraphDatabase edge exists check failed: &quot; . $e-&gt;getMessage());
</div><div class='line not-executable'><span class='num'>532</span>        }
</div><div class='line covered'><span class='num'>533</span>        return null;
</div><div class='line not-covered'><span class='num'>534</span>    }
</div><div class='line not-executable'><span class='num'>535</span>
</div><div class='line not-executable'><span class='num'>536</span>    public function getEdgeById(string $id): ?array
</div><div class='line not-executable'><span class='num'>537</span>    {
</div><div class='line not-executable'><span class='num'>538</span>        try {
</div><div class='line not-covered'><span class='num'>539</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-executable'><span class='num'>540</span>                SELECT * FROM edges
</div><div class='line not-executable'><span class='num'>541</span>                WHERE id = :id
</div><div class='line not-executable'><span class='num'>542</span>            &quot;);
</div><div class='line not-covered'><span class='num'>543</span>            $stmt-&gt;execute([
</div><div class='line not-covered'><span class='num'>544</span>                &#039;:id&#039; =&gt; $id,
</div><div class='line not-executable'><span class='num'>545</span>            ]);
</div><div class='line not-covered'><span class='num'>546</span>            $row = $stmt-&gt;fetch();
</div><div class='line not-covered'><span class='num'>547</span>            if ($row) {
</div><div class='line not-covered'><span class='num'>548</span>                return $row;
</div><div class='line not-executable'><span class='num'>549</span>            }
</div><div class='line not-covered'><span class='num'>550</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>551</span>            error_log(&quot;GraphDatabase edge exists check failed: &quot; . $e-&gt;getMessage());
</div><div class='line not-executable'><span class='num'>552</span>        }
</div><div class='line not-covered'><span class='num'>553</span>        return null;
</div><div class='line not-covered'><span class='num'>554</span>    }
</div><div class='line not-executable'><span class='num'>555</span>
</div><div class='line not-executable'><span class='num'>556</span>    public function getEdges(): array
</div><div class='line not-executable'><span class='num'>557</span>    {
</div><div class='line not-executable'><span class='num'>558</span>        try {
</div><div class='line not-covered'><span class='num'>559</span>            $stmt  = $this-&gt;pdo-&gt;query(&quot;SELECT * FROM edges&quot;);
</div><div class='line not-covered'><span class='num'>560</span>            $rows  = $stmt-&gt;fetchAll();
</div><div class='line not-covered'><span class='num'>561</span>            return $rows;
</div><div class='line not-covered'><span class='num'>562</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>563</span>            error_log(&quot;GraphDatabase fetch all edges failed: &quot; . $e-&gt;getMessage());
</div><div class='line not-covered'><span class='num'>564</span>            return [];
</div><div class='line not-executable'><span class='num'>565</span>        }
</div><div class='line not-covered'><span class='num'>566</span>    }
</div><div class='line not-executable'><span class='num'>567</span>
</div><div class='line not-executable'><span class='num'>568</span>    public function insertEdge(string $id, string $source, string $target, array $data = []): void
</div><div class='line not-executable'><span class='num'>569</span>    {
</div><div class='line not-executable'><span class='num'>570</span>        // verify if the inverse edge exists
</div><div class='line covered'><span class='num'>571</span>        $r = $this-&gt;getEdge($target, $source);
</div><div class='line not-executable'><span class='num'>572</span>        
</div><div class='line not-executable'><span class='num'>573</span>        try {
</div><div class='line covered'><span class='num'>574</span>            $sql = &quot;
</div><div class='line not-executable'><span class='num'>575</span>                INSERT OR IGNORE INTO edges
</div><div class='line not-executable'><span class='num'>576</span>                (id, source, target, data)
</div><div class='line not-executable'><span class='num'>577</span>                VALUES (:id, :source, :target, :data)&quot;;
</div><div class='line covered'><span class='num'>578</span>            $stmt           = $this-&gt;pdo-&gt;prepare($sql);
</div><div class='line covered'><span class='num'>579</span>            $data[&#039;id&#039;]     = $id;
</div><div class='line covered'><span class='num'>580</span>            $data[&#039;source&#039;] = $source;
</div><div class='line covered'><span class='num'>581</span>            $data[&#039;target&#039;] = $target;
</div><div class='line covered'><span class='num'>582</span>            $stmt-&gt;execute([
</div><div class='line covered'><span class='num'>583</span>                &#039;:id&#039;     =&gt; $id,
</div><div class='line covered'><span class='num'>584</span>                &#039;:source&#039; =&gt; $source,
</div><div class='line covered'><span class='num'>585</span>                &#039;:target&#039; =&gt; $target,
</div><div class='line covered'><span class='num'>586</span>                &#039;:data&#039;   =&gt; json_encode($data, JSON_UNESCAPED_UNICODE)
</div><div class='line not-executable'><span class='num'>587</span>            ]);
</div><div class='line covered'><span class='num'>588</span>        } catch (PDOException $e) {
</div><div class='line not-executable'><span class='num'>589</span>            // TODO
</div><div class='line not-executable'><span class='num'>590</span>        }
</div><div class='line covered'><span class='num'>591</span>    }
</div><div class='line not-executable'><span class='num'>592</span>
</div><div class='line not-executable'><span class='num'>593</span>    public function updateEdge(string $id, string $source, string $target, array $data = []): void
</div><div class='line not-executable'><span class='num'>594</span>    {
</div><div class='line not-executable'><span class='num'>595</span>        try {
</div><div class='line not-covered'><span class='num'>596</span>            $data[&#039;id&#039;]     = $id;
</div><div class='line not-covered'><span class='num'>597</span>            $data[&#039;source&#039;] = $source;
</div><div class='line not-covered'><span class='num'>598</span>            $data[&#039;target&#039;] = $target;
</div><div class='line not-executable'><span class='num'>599</span>
</div><div class='line not-covered'><span class='num'>600</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-executable'><span class='num'>601</span>                UPDATE edges
</div><div class='line not-executable'><span class='num'>602</span>                SET data = :data
</div><div class='line not-executable'><span class='num'>603</span>                WHERE id = :id&quot;);
</div><div class='line not-covered'><span class='num'>604</span>            $stmt-&gt;execute([
</div><div class='line not-covered'><span class='num'>605</span>                &#039;:id&#039;   =&gt; $id,
</div><div class='line not-covered'><span class='num'>606</span>                &#039;:data&#039; =&gt; json_encode($data, JSON_UNESCAPED_UNICODE)
</div><div class='line not-executable'><span class='num'>607</span>            ]);
</div><div class='line not-covered'><span class='num'>608</span>        } catch (PDOException $e) {
</div><div class='line not-executable'><span class='num'>609</span>            // TODO
</div><div class='line not-executable'><span class='num'>610</span>        }
</div><div class='line not-covered'><span class='num'>611</span>    }
</div><div class='line not-executable'><span class='num'>612</span>
</div><div class='line not-executable'><span class='num'>613</span>    public function deleteEdge(string $id): void
</div><div class='line not-executable'><span class='num'>614</span>    {
</div><div class='line not-executable'><span class='num'>615</span>        try {
</div><div class='line not-covered'><span class='num'>616</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;DELETE FROM edges WHERE id = :id&quot;);
</div><div class='line not-covered'><span class='num'>617</span>            $stmt-&gt;execute([&#039;:id&#039; =&gt; $id]);
</div><div class='line not-covered'><span class='num'>618</span>        } catch (PDOException $e) {
</div><div class='line not-executable'><span class='num'>619</span>            // TODO
</div><div class='line not-executable'><span class='num'>620</span>        }
</div><div class='line not-covered'><span class='num'>621</span>    }
</div><div class='line not-executable'><span class='num'>622</span>
</div><div class='line not-executable'><span class='num'>623</span>    public function getStatuses(): array
</div><div class='line not-executable'><span class='num'>624</span>    {
</div><div class='line not-covered'><span class='num'>625</span>        $stmt   = $this-&gt;pdo-&gt;query(&quot;
</div><div class='line not-executable'><span class='num'>626</span>            SELECT n.id,
</div><div class='line not-executable'><span class='num'>627</span>                   s.status
</div><div class='line not-executable'><span class='num'>628</span>            FROM   nodes n
</div><div class='line not-executable'><span class='num'>629</span>            LEFT JOIN status s ON n.id = s.node_id&quot;);
</div><div class='line not-covered'><span class='num'>630</span>        $status = $stmt-&gt;fetchAll();
</div><div class='line not-covered'><span class='num'>631</span>        return $status;
</div><div class='line not-covered'><span class='num'>632</span>    }
</div><div class='line not-executable'><span class='num'>633</span>
</div><div class='line not-executable'><span class='num'>634</span>    public function getNodeStatus(string $id): ?string
</div><div class='line not-executable'><span class='num'>635</span>    {
</div><div class='line not-covered'><span class='num'>636</span>        $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-executable'><span class='num'>637</span>            SELECT s.status
</div><div class='line not-executable'><span class='num'>638</span>            FROM nodes n
</div><div class='line not-executable'><span class='num'>639</span>            LEFT JOIN status s
</div><div class='line not-executable'><span class='num'>640</span>            ON n.id = s.node_id
</div><div class='line not-executable'><span class='num'>641</span>            WHERE n.id = ?&quot;);
</div><div class='line not-covered'><span class='num'>642</span>        $stmt-&gt;execute([$id]);
</div><div class='line not-covered'><span class='num'>643</span>        $status = $stmt-&gt;fetch();
</div><div class='line not-covered'><span class='num'>644</span>        return $status ? $status[&#039;status&#039;] : null;
</div><div class='line not-covered'><span class='num'>645</span>    }
</div><div class='line not-executable'><span class='num'>646</span>
</div><div class='line not-executable'><span class='num'>647</span>    public function setNodeStatus(string $id, string $status): void
</div><div class='line not-executable'><span class='num'>648</span>    {
</div><div class='line not-covered'><span class='num'>649</span>        $stmt = $this-&gt;pdo-&gt;prepare(&quot;REPLACE INTO status (node_id, status) VALUES (?, ?)&quot;);
</div><div class='line not-covered'><span class='num'>650</span>        $stmt-&gt;execute([$id, $status]);
</div><div class='line not-covered'><span class='num'>651</span>    }
</div><div class='line not-executable'><span class='num'>652</span>
</div><div class='line not-executable'><span class='num'>653</span>    public function getLogs($limit): array
</div><div class='line not-executable'><span class='num'>654</span>    {
</div><div class='line not-covered'><span class='num'>655</span>        $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-executable'><span class='num'>656</span>            SELECT *
</div><div class='line not-executable'><span class='num'>657</span>            FROM audit
</div><div class='line not-executable'><span class='num'>658</span>            ORDER BY created_at DESC
</div><div class='line not-executable'><span class='num'>659</span>            LIMIT :limit
</div><div class='line not-executable'><span class='num'>660</span>        &quot;);
</div><div class='line not-covered'><span class='num'>661</span>        $stmt-&gt;bindValue(&#039;:limit&#039;, (int)$limit, PDO::PARAM_INT);
</div><div class='line not-covered'><span class='num'>662</span>        $stmt-&gt;execute();
</div><div class='line not-covered'><span class='num'>663</span>        $rows = $stmt-&gt;fetchAll();
</div><div class='line not-covered'><span class='num'>664</span>        return $rows;
</div><div class='line not-covered'><span class='num'>665</span>    }
</div><div class='line not-executable'><span class='num'>666</span>
</div><div class='line not-executable'><span class='num'>667</span>    public function insertAuditLog(string $entity_type, string $entity_id, string $action, ?array $old_data = null, ?array $new_data = null, string $user_id, string $ip_address): bool
</div><div class='line not-executable'><span class='num'>668</span>    {
</div><div class='line not-executable'><span class='num'>669</span>        try {
</div><div class='line covered'><span class='num'>670</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-executable'><span class='num'>671</span>                INSERT INTO audit (entity_type, entity_id, action, old_data, new_data, user_id, ip_address)
</div><div class='line not-executable'><span class='num'>672</span>                VALUES (:entity_type, :entity_id, :action, :old_data, :new_data, :user_id, :ip_address)
</div><div class='line not-executable'><span class='num'>673</span>            &quot;);
</div><div class='line not-executable'><span class='num'>674</span>
</div><div class='line covered'><span class='num'>675</span>            $stmt-&gt;execute([
</div><div class='line covered'><span class='num'>676</span>                &#039;:entity_type&#039; =&gt; $entity_type,
</div><div class='line covered'><span class='num'>677</span>                &#039;:entity_id&#039;   =&gt; $entity_id,
</div><div class='line covered'><span class='num'>678</span>                &#039;:action&#039;      =&gt; $action,
</div><div class='line not-covered'><span class='num'>679</span>                &#039;:old_data&#039;    =&gt; $old_data !== null ? json_encode($old_data, JSON_UNESCAPED_UNICODE) : null,
</div><div class='line covered'><span class='num'>680</span>                &#039;:new_data&#039;    =&gt; $new_data !== null ? json_encode($new_data, JSON_UNESCAPED_UNICODE) : null,
</div><div class='line covered'><span class='num'>681</span>                &#039;:user_id&#039;     =&gt; $user_id,
</div><div class='line covered'><span class='num'>682</span>                &#039;:ip_address&#039;  =&gt; $ip_address
</div><div class='line not-executable'><span class='num'>683</span>            ]);
</div><div class='line covered'><span class='num'>684</span>            return true;
</div><div class='line not-covered'><span class='num'>685</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>686</span>            error_log(&quot;GraphDatabase audit log insert failed: &quot; . $e-&gt;getMessage());
</div><div class='line not-covered'><span class='num'>687</span>            return false;
</div><div class='line not-executable'><span class='num'>688</span>        }
</div><div class='line not-covered'><span class='num'>689</span>    }
</div><div class='line not-executable'><span class='num'>690</span>
</div><div class='line not-executable'><span class='num'>691</span>    private function initSchema(): void
</div><div class='line not-executable'><span class='num'>692</span>    {
</div><div class='line covered'><span class='num'>693</span>        $this-&gt;pdo-&gt;exec(&quot;
</div><div class='line not-executable'><span class='num'>694</span>            CREATE TABLE IF NOT EXISTS users (
</div><div class='line not-executable'><span class='num'>695</span>                id TEXT PRIMARY KEY,
</div><div class='line not-executable'><span class='num'>696</span>                user_group TEXT NOT NULL
</div><div class='line not-executable'><span class='num'>697</span>            )
</div><div class='line not-executable'><span class='num'>698</span>        &quot;);
</div><div class='line not-executable'><span class='num'>699</span>
</div><div class='line covered'><span class='num'>700</span>        $this-&gt;pdo-&gt;exec(&quot;INSERT INTO users VALUES(&#039;admin&#039;, &#039;admin&#039;)&quot;);
</div><div class='line not-executable'><span class='num'>701</span>
</div><div class='line covered'><span class='num'>702</span>        $this-&gt;pdo-&gt;exec(&quot;
</div><div class='line not-executable'><span class='num'>703</span>            CREATE TABLE IF NOT EXISTS nodes (
</div><div class='line not-executable'><span class='num'>704</span>                id TEXT PRIMARY KEY,
</div><div class='line not-executable'><span class='num'>705</span>                label TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>706</span>                category TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>707</span>                type TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>708</span>                data TEXT NOT NULL
</div><div class='line not-executable'><span class='num'>709</span>            )
</div><div class='line not-executable'><span class='num'>710</span>        &quot;);
</div><div class='line not-executable'><span class='num'>711</span>
</div><div class='line covered'><span class='num'>712</span>        $this-&gt;pdo-&gt;exec(&quot;
</div><div class='line not-executable'><span class='num'>713</span>            CREATE TABLE IF NOT EXISTS edges (
</div><div class='line not-executable'><span class='num'>714</span>                id TEXT PRIMARY KEY,
</div><div class='line not-executable'><span class='num'>715</span>                source TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>716</span>                target TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>717</span>                data TEXT,
</div><div class='line not-executable'><span class='num'>718</span>                FOREIGN KEY (source) REFERENCES nodes(id) ON DELETE CASCADE,
</div><div class='line not-executable'><span class='num'>719</span>                FOREIGN KEY (target) REFERENCES nodes(id) ON DELETE CASCADE
</div><div class='line not-executable'><span class='num'>720</span>            )
</div><div class='line not-executable'><span class='num'>721</span>        &quot;);
</div><div class='line not-executable'><span class='num'>722</span>
</div><div class='line covered'><span class='num'>723</span>        $this-&gt;pdo-&gt;exec(&quot;CREATE UNIQUE INDEX IF NOT EXISTS idx_edges_source_target ON edges (source, target)&quot;);
</div><div class='line not-executable'><span class='num'>724</span>
</div><div class='line covered'><span class='num'>725</span>        $this-&gt;pdo-&gt;exec(&quot;
</div><div class='line not-executable'><span class='num'>726</span>            CREATE TABLE IF NOT EXISTS status (
</div><div class='line not-executable'><span class='num'>727</span>                node_id TEXT PRIMARY KEY NOT NULL,
</div><div class='line not-executable'><span class='num'>728</span>                status TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>729</span>                created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
</div><div class='line not-executable'><span class='num'>730</span>                FOREIGN KEY (node_id) REFERENCES nodes(id) ON DELETE CASCADE
</div><div class='line not-executable'><span class='num'>731</span>            )
</div><div class='line not-executable'><span class='num'>732</span>        &quot;);
</div><div class='line not-executable'><span class='num'>733</span>
</div><div class='line covered'><span class='num'>734</span>        $this-&gt;pdo-&gt;exec(&quot;CREATE INDEX IF NOT EXISTS idx_node_status_node_id ON status (node_id)&quot;);
</div><div class='line not-executable'><span class='num'>735</span>
</div><div class='line covered'><span class='num'>736</span>        $this-&gt;pdo-&gt;exec(&quot;
</div><div class='line not-executable'><span class='num'>737</span>            CREATE TABLE IF NOT EXISTS audit (
</div><div class='line not-executable'><span class='num'>738</span>                id INTEGER PRIMARY KEY AUTOINCREMENT,
</div><div class='line not-executable'><span class='num'>739</span>                entity_type TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>740</span>                entity_id TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>741</span>                action TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>742</span>                old_data TEXT,
</div><div class='line not-executable'><span class='num'>743</span>                new_data TEXT,
</div><div class='line not-executable'><span class='num'>744</span>                user_id TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>745</span>                ip_address TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>746</span>                created_at DATETIME DEFAULT CURRENT_TIMESTAMP
</div><div class='line not-executable'><span class='num'>747</span>            )
</div><div class='line not-executable'><span class='num'>748</span>        &quot;);
</div><div class='line covered'><span class='num'>749</span>    }
</div><div class='line not-executable'><span class='num'>750</span>
</div><div class='line not-executable'><span class='num'>751</span>    public static function createConnection(string $dsn): PDO
</div><div class='line not-executable'><span class='num'>752</span>    {
</div><div class='line covered'><span class='num'>753</span>        $pdo = new PDO($dsn);
</div><div class='line covered'><span class='num'>754</span>        $pdo-&gt;setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
</div><div class='line covered'><span class='num'>755</span>        $pdo-&gt;setAttribute(PDO::ATTR_DEFAULT_FETCH_MODE, PDO::FETCH_ASSOC);
</div><div class='line covered'><span class='num'>756</span>        $pdo-&gt;exec(&#039;PRAGMA foreign_keys = ON&#039;);
</div><div class='line covered'><span class='num'>757</span>        return $pdo;
</div><div class='line not-covered'><span class='num'>758</span>    }
</div><div class='line not-executable'><span class='num'>759</span>}
</div><div class='line not-executable'><span class='num'>760</span>
</div><div class='line not-executable'><span class='num'>761</span>final class GraphServiceException extends RuntimeException
</div><div class='line not-executable'><span class='num'>762</span>{
</div><div class='line not-executable'><span class='num'>763</span>}
</div><div class='line not-executable'><span class='num'>764</span>
</div><div class='line not-executable'><span class='num'>765</span>interface GraphServiceInterface
</div><div class='line not-executable'><span class='num'>766</span>{
</div><div class='line not-executable'><span class='num'>767</span>    public function getUser(string $id): ?User;
</div><div class='line not-executable'><span class='num'>768</span>    public function insertUser(User $user): void;
</div><div class='line not-executable'><span class='num'>769</span>    public function updateUser(User $user): void;
</div><div class='line not-executable'><span class='num'>770</span>
</div><div class='line not-executable'><span class='num'>771</span>    public function getGraph(): Graph;
</div><div class='line not-executable'><span class='num'>772</span>
</div><div class='line not-executable'><span class='num'>773</span>    public function getNode(string $id): ?Node;
</div><div class='line not-executable'><span class='num'>774</span>    public function getNodes(): Nodes;
</div><div class='line not-executable'><span class='num'>775</span>    public function insertNode(Node $node): void;
</div><div class='line not-executable'><span class='num'>776</span>    public function updateNode(Node $node): void;
</div><div class='line not-executable'><span class='num'>777</span>    public function deleteNode(string $id): void;
</div><div class='line not-executable'><span class='num'>778</span>
</div><div class='line not-executable'><span class='num'>779</span>    public function getEdge(string $source, string $target): ?Edge;
</div><div class='line not-executable'><span class='num'>780</span>    public function getEdges(): Edges;
</div><div class='line not-executable'><span class='num'>781</span>    public function insertEdge(Edge $edge): void;
</div><div class='line not-executable'><span class='num'>782</span>    public function updateEdge(Edge $edge): void;
</div><div class='line not-executable'><span class='num'>783</span>    public function deleteEdge(string $id): void;
</div><div class='line not-executable'><span class='num'>784</span>
</div><div class='line not-executable'><span class='num'>785</span>    public function getStatuses(): NodeStatuses;
</div><div class='line not-executable'><span class='num'>786</span>    public function getNodeStatus(string $id): NodeStatus;
</div><div class='line not-executable'><span class='num'>787</span>    public function setNodeStatus(NodeStatus $status): void;
</div><div class='line not-executable'><span class='num'>788</span>
</div><div class='line not-executable'><span class='num'>789</span>    public function getLogs($limit): AuditLogs;
</div><div class='line not-executable'><span class='num'>790</span>}
</div><div class='line not-executable'><span class='num'>791</span>
</div><div class='line not-executable'><span class='num'>792</span>final class GraphService implements GraphServiceInterface
</div><div class='line not-executable'><span class='num'>793</span>{
</div><div class='line not-executable'><span class='num'>794</span>    private const SECURE_ACTIONS = [
</div><div class='line not-executable'><span class='num'>795</span>        &#039;GraphService::getGraph&#039;      =&gt; true,
</div><div class='line not-executable'><span class='num'>796</span>        &#039;GraphService::getNode&#039;       =&gt; true,
</div><div class='line not-executable'><span class='num'>797</span>        &#039;GraphService::getNodes&#039;      =&gt; true,
</div><div class='line not-executable'><span class='num'>798</span>        &#039;GraphService::getEdge&#039;       =&gt; true,
</div><div class='line not-executable'><span class='num'>799</span>        &#039;GraphService::getEdges&#039;      =&gt; true,
</div><div class='line not-executable'><span class='num'>800</span>        &#039;GraphService::getStatuses&#039;   =&gt; true,
</div><div class='line not-executable'><span class='num'>801</span>        &#039;GraphService::getNodeStatus&#039; =&gt; true,
</div><div class='line not-executable'><span class='num'>802</span>        &#039;GraphService::setNodeStatus&#039; =&gt; true,
</div><div class='line not-executable'><span class='num'>803</span>        &#039;GraphService::getLogs&#039;       =&gt; true,
</div><div class='line not-executable'><span class='num'>804</span>        &#039;GraphService::insertNode&#039;    =&gt; false,
</div><div class='line not-executable'><span class='num'>805</span>        &#039;GraphService::updateNode&#039;    =&gt; false,
</div><div class='line not-executable'><span class='num'>806</span>        &#039;GraphService::deleteNode&#039;    =&gt; false,
</div><div class='line not-executable'><span class='num'>807</span>        &#039;GraphService::insertEdge&#039;    =&gt; false,
</div><div class='line not-executable'><span class='num'>808</span>        &#039;GraphService::updateEdge&#039;    =&gt; false,
</div><div class='line not-executable'><span class='num'>809</span>        &#039;GraphService::deleteEdge&#039;    =&gt; false,
</div><div class='line not-executable'><span class='num'>810</span>
</div><div class='line not-executable'><span class='num'>811</span>        &#039;GraphService::insertAuditLog&#039; =&gt; false,
</div><div class='line not-executable'><span class='num'>812</span>    ];
</div><div class='line not-executable'><span class='num'>813</span>
</div><div class='line not-executable'><span class='num'>814</span>    private GraphDatabaseInterface $db;
</div><div class='line not-executable'><span class='num'>815</span>    private Logger $logger;
</div><div class='line not-executable'><span class='num'>816</span>
</div><div class='line not-executable'><span class='num'>817</span>    public function __construct(GraphDatabaseInterface $db, Logger $logger)
</div><div class='line not-executable'><span class='num'>818</span>    {
</div><div class='line covered'><span class='num'>819</span>        $this-&gt;db = $db;
</div><div class='line covered'><span class='num'>820</span>        $this-&gt;logger = $logger;
</div><div class='line covered'><span class='num'>821</span>    }
</div><div class='line not-executable'><span class='num'>822</span>
</div><div class='line not-executable'><span class='num'>823</span>    public function getUser(string $id): ?User
</div><div class='line not-executable'><span class='num'>824</span>    {
</div><div class='line not-covered'><span class='num'>825</span>        $data = $this-&gt;db-&gt;getUser($id);
</div><div class='line not-covered'><span class='num'>826</span>        if ($data) {
</div><div class='line not-covered'><span class='num'>827</span>            $user = new User($id, null, $data[&#039;user_group&#039;]);
</div><div class='line not-covered'><span class='num'>828</span>            return $user;
</div><div class='line not-executable'><span class='num'>829</span>        }
</div><div class='line not-covered'><span class='num'>830</span>        return null;
</div><div class='line not-covered'><span class='num'>831</span>    }
</div><div class='line not-executable'><span class='num'>832</span>
</div><div class='line not-executable'><span class='num'>833</span>    public function insertUser(User $user): void
</div><div class='line not-executable'><span class='num'>834</span>    {
</div><div class='line not-covered'><span class='num'>835</span>        $this-&gt;db-&gt;insertUser($user-&gt;id, $user-&gt;group-&gt;id);
</div><div class='line not-covered'><span class='num'>836</span>    }
</div><div class='line not-executable'><span class='num'>837</span>
</div><div class='line not-executable'><span class='num'>838</span>    public function updateUser(User $user): void
</div><div class='line not-executable'><span class='num'>839</span>    {
</div><div class='line not-covered'><span class='num'>840</span>        $this-&gt;db-&gt;updateUser($user-&gt;id, $user-&gt;group-&gt;id);
</div><div class='line not-covered'><span class='num'>841</span>    }
</div><div class='line not-executable'><span class='num'>842</span>
</div><div class='line not-executable'><span class='num'>843</span>    public function getGraph(): Graph
</div><div class='line not-executable'><span class='num'>844</span>    {
</div><div class='line not-covered'><span class='num'>845</span>        $nodes = $this-&gt;getNodes()-&gt;nodes;
</div><div class='line not-covered'><span class='num'>846</span>        $edges = $this-&gt;getEdges()-&gt;edges;
</div><div class='line not-covered'><span class='num'>847</span>        return new Graph($nodes, $edges);
</div><div class='line not-covered'><span class='num'>848</span>    }
</div><div class='line not-executable'><span class='num'>849</span>
</div><div class='line not-executable'><span class='num'>850</span>    public function getNode(string $id): ?Node
</div><div class='line not-executable'><span class='num'>851</span>    {
</div><div class='line covered'><span class='num'>852</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>853</span>            throw new RuntimeException(&quot;Permission denied to get node.&quot;);
</div><div class='line not-executable'><span class='num'>854</span>        }
</div><div class='line not-executable'><span class='num'>855</span>
</div><div class='line covered'><span class='num'>856</span>        $data = $this-&gt;db-&gt;getNode($id);
</div><div class='line covered'><span class='num'>857</span>        if ($data) {
</div><div class='line covered'><span class='num'>858</span>            return new Node(
</div><div class='line covered'><span class='num'>859</span>                $data[&#039;id&#039;],
</div><div class='line covered'><span class='num'>860</span>                $data[&#039;label&#039;],
</div><div class='line covered'><span class='num'>861</span>                $data[&#039;category&#039;],
</div><div class='line covered'><span class='num'>862</span>                $data[&#039;type&#039;],
</div><div class='line covered'><span class='num'>863</span>                json_decode($data[&#039;data&#039;], true)
</div><div class='line not-executable'><span class='num'>864</span>            );
</div><div class='line not-executable'><span class='num'>865</span>        }
</div><div class='line not-covered'><span class='num'>866</span>        return null;
</div><div class='line not-covered'><span class='num'>867</span>    }
</div><div class='line not-executable'><span class='num'>868</span>
</div><div class='line not-executable'><span class='num'>869</span>    public function getNodes(): Nodes
</div><div class='line not-executable'><span class='num'>870</span>    {
</div><div class='line not-covered'><span class='num'>871</span>        if(! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>872</span>            throw new RuntimeException(&quot;Permission denied to get nodes.&quot;);
</div><div class='line not-executable'><span class='num'>873</span>        }
</div><div class='line not-executable'><span class='num'>874</span>
</div><div class='line not-covered'><span class='num'>875</span>        $nodesData = $this-&gt;db-&gt;getNodes();
</div><div class='line not-covered'><span class='num'>876</span>        $nodes     = new Nodes();
</div><div class='line not-covered'><span class='num'>877</span>        foreach ($nodesData as $data) {
</div><div class='line not-covered'><span class='num'>878</span>            $node = new Node(
</div><div class='line not-covered'><span class='num'>879</span>                $data[&#039;id&#039;],
</div><div class='line not-covered'><span class='num'>880</span>                $data[&#039;label&#039;],
</div><div class='line not-covered'><span class='num'>881</span>                $data[&#039;category&#039;],
</div><div class='line not-covered'><span class='num'>882</span>                $data[&#039;type&#039;],
</div><div class='line not-covered'><span class='num'>883</span>                json_decode($data[&#039;data&#039;], true)
</div><div class='line not-executable'><span class='num'>884</span>            );
</div><div class='line not-covered'><span class='num'>885</span>            $nodes-&gt;addNode($node);
</div><div class='line not-executable'><span class='num'>886</span>        }
</div><div class='line not-covered'><span class='num'>887</span>        return $nodes;
</div><div class='line not-covered'><span class='num'>888</span>    }
</div><div class='line not-executable'><span class='num'>889</span>
</div><div class='line not-executable'><span class='num'>890</span>    public function insertNode(Node $node): void
</div><div class='line not-executable'><span class='num'>891</span>    {
</div><div class='line covered'><span class='num'>892</span>        $this-&gt;logger-&gt;debug(&#039;inserting node&#039;, $node-&gt;toArray());
</div><div class='line not-executable'><span class='num'>893</span>
</div><div class='line covered'><span class='num'>894</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>895</span>            $this-&gt;logger-&gt;info(&#039;permission denied&#039;, $node-&gt;toArray());
</div><div class='line not-covered'><span class='num'>896</span>            throw new GraphServiceException(&#039;permission denied&#039;);
</div><div class='line not-executable'><span class='num'>897</span>        }
</div><div class='line not-executable'><span class='num'>898</span>
</div><div class='line covered'><span class='num'>899</span>        $this-&gt;logger-&gt;info(&#039;permission allowed&#039;, $node-&gt;toArray());
</div><div class='line not-executable'><span class='num'>900</span>
</div><div class='line covered'><span class='num'>901</span>        $this-&gt;insertAuditLog(new AuditLog( &#039;node&#039;, $node-&gt;id, &#039;insert&#039;, null, $node-&gt;toArray()));
</div><div class='line not-executable'><span class='num'>902</span>
</div><div class='line covered'><span class='num'>903</span>        $this-&gt;db-&gt;insertNode(
</div><div class='line covered'><span class='num'>904</span>            $node-&gt;id,
</div><div class='line covered'><span class='num'>905</span>            $node-&gt;label,
</div><div class='line covered'><span class='num'>906</span>            $node-&gt;category,
</div><div class='line covered'><span class='num'>907</span>            $node-&gt;type,
</div><div class='line covered'><span class='num'>908</span>            $node-&gt;data
</div><div class='line not-executable'><span class='num'>909</span>        );
</div><div class='line covered'><span class='num'>910</span>    }
</div><div class='line not-executable'><span class='num'>911</span>
</div><div class='line not-executable'><span class='num'>912</span>    public function updateNode(Node $node): void
</div><div class='line not-executable'><span class='num'>913</span>    {
</div><div class='line not-covered'><span class='num'>914</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>915</span>            throw new RuntimeException(&quot;Permission denied to update node.&quot;);
</div><div class='line not-executable'><span class='num'>916</span>        }
</div><div class='line not-executable'><span class='num'>917</span>
</div><div class='line not-covered'><span class='num'>918</span>        $old = $this-&gt;getNode($node-&gt;id);
</div><div class='line not-covered'><span class='num'>919</span>        $this-&gt;insertAuditLog(new AuditLog( &#039;node&#039;, $node-&gt;id, &#039;update&#039;, $old-&gt;toArray(), $node-&gt;toArray()));
</div><div class='line not-executable'><span class='num'>920</span>
</div><div class='line not-covered'><span class='num'>921</span>        $this-&gt;db-&gt;updateNode(
</div><div class='line not-covered'><span class='num'>922</span>            $node-&gt;id,
</div><div class='line not-covered'><span class='num'>923</span>            $node-&gt;label,
</div><div class='line not-covered'><span class='num'>924</span>            $node-&gt;category,
</div><div class='line not-covered'><span class='num'>925</span>            $node-&gt;type,
</div><div class='line not-covered'><span class='num'>926</span>            $node-&gt;data
</div><div class='line not-executable'><span class='num'>927</span>        );
</div><div class='line not-covered'><span class='num'>928</span>    }
</div><div class='line not-executable'><span class='num'>929</span>
</div><div class='line not-executable'><span class='num'>930</span>    public function deleteNode(string $id): void
</div><div class='line not-executable'><span class='num'>931</span>    {
</div><div class='line not-covered'><span class='num'>932</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>933</span>            throw new RuntimeException(&quot;Permission denied to delete node.&quot;);
</div><div class='line not-executable'><span class='num'>934</span>        }
</div><div class='line not-executable'><span class='num'>935</span>
</div><div class='line not-covered'><span class='num'>936</span>        $old = $this-&gt;getNode($id);
</div><div class='line not-covered'><span class='num'>937</span>        $this-&gt;insertAuditLog(new AuditLog( &#039;node&#039;, $id, &#039;delete&#039;, $old-&gt;toArray(), null));
</div><div class='line not-covered'><span class='num'>938</span>        $this-&gt;db-&gt;deleteNode($id);
</div><div class='line not-covered'><span class='num'>939</span>    }
</div><div class='line not-executable'><span class='num'>940</span>
</div><div class='line not-executable'><span class='num'>941</span>    public function getEdge(string $source, string $target): ?Edge
</div><div class='line not-executable'><span class='num'>942</span>    {
</div><div class='line not-covered'><span class='num'>943</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>944</span>            throw new RuntimeException(&quot;Permission denied to get edge.&quot;);
</div><div class='line not-executable'><span class='num'>945</span>        }
</div><div class='line not-executable'><span class='num'>946</span>
</div><div class='line not-covered'><span class='num'>947</span>        $edgesData = $this-&gt;db-&gt;getEdges();
</div><div class='line not-covered'><span class='num'>948</span>        foreach ($edgesData as $data) {
</div><div class='line not-covered'><span class='num'>949</span>            if ($data[&#039;source&#039;] === $source &amp;&amp; $data[&#039;target&#039;] === $target) {
</div><div class='line not-covered'><span class='num'>950</span>                return new Edge(
</div><div class='line not-covered'><span class='num'>951</span>                    $data[&#039;id&#039;],
</div><div class='line not-covered'><span class='num'>952</span>                    $data[&#039;source&#039;],
</div><div class='line not-covered'><span class='num'>953</span>                    $data[&#039;target&#039;],
</div><div class='line not-covered'><span class='num'>954</span>                    json_decode($data[&#039;data&#039;], true)
</div><div class='line not-executable'><span class='num'>955</span>                );
</div><div class='line not-executable'><span class='num'>956</span>            }
</div><div class='line not-executable'><span class='num'>957</span>        }
</div><div class='line not-covered'><span class='num'>958</span>        return null;
</div><div class='line not-covered'><span class='num'>959</span>    }
</div><div class='line not-executable'><span class='num'>960</span>
</div><div class='line not-executable'><span class='num'>961</span>    public function getEdges(): Edges
</div><div class='line not-executable'><span class='num'>962</span>    {
</div><div class='line not-covered'><span class='num'>963</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>964</span>            throw new RuntimeException(&quot;Permission denied to get edges.&quot;);
</div><div class='line not-executable'><span class='num'>965</span>        }
</div><div class='line not-covered'><span class='num'>966</span>        $edgesData = $this-&gt;db-&gt;getEdges();
</div><div class='line not-covered'><span class='num'>967</span>        $edges     = new Edges();
</div><div class='line not-covered'><span class='num'>968</span>        foreach ($edgesData as $data) {
</div><div class='line not-covered'><span class='num'>969</span>            $edge = new Edge(
</div><div class='line not-covered'><span class='num'>970</span>                $data[&#039;id&#039;],
</div><div class='line not-covered'><span class='num'>971</span>                $data[&#039;source&#039;],
</div><div class='line not-covered'><span class='num'>972</span>                $data[&#039;target&#039;],
</div><div class='line not-covered'><span class='num'>973</span>                json_decode($data[&#039;data&#039;], true)
</div><div class='line not-executable'><span class='num'>974</span>            );
</div><div class='line not-covered'><span class='num'>975</span>            $edges-&gt;addEdge($edge);
</div><div class='line not-executable'><span class='num'>976</span>        }
</div><div class='line not-covered'><span class='num'>977</span>        return $edges;
</div><div class='line not-covered'><span class='num'>978</span>    }
</div><div class='line not-executable'><span class='num'>979</span>
</div><div class='line not-executable'><span class='num'>980</span>    public function insertEdge(Edge $edge): void
</div><div class='line not-executable'><span class='num'>981</span>    {
</div><div class='line covered'><span class='num'>982</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>983</span>            throw new RuntimeException(&quot;Permission denied to insert edge.&quot;);
</div><div class='line not-executable'><span class='num'>984</span>        }
</div><div class='line covered'><span class='num'>985</span>        $this-&gt;insertAuditLog(new AuditLog( &#039;edge&#039;, $edge-&gt;id, &#039;insert&#039;, null, $edge-&gt;toArray()));
</div><div class='line covered'><span class='num'>986</span>        $this-&gt;db-&gt;insertEdge(
</div><div class='line covered'><span class='num'>987</span>            $edge-&gt;id,
</div><div class='line covered'><span class='num'>988</span>            $edge-&gt;source,
</div><div class='line covered'><span class='num'>989</span>            $edge-&gt;target,
</div><div class='line covered'><span class='num'>990</span>            $edge-&gt;data
</div><div class='line not-executable'><span class='num'>991</span>        );
</div><div class='line covered'><span class='num'>992</span>    }
</div><div class='line not-executable'><span class='num'>993</span>
</div><div class='line not-executable'><span class='num'>994</span>    public function updateEdge(Edge $edge): void
</div><div class='line not-executable'><span class='num'>995</span>    {
</div><div class='line not-covered'><span class='num'>996</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>997</span>            throw new RuntimeException(&quot;Permission denied to update edge.&quot;);
</div><div class='line not-executable'><span class='num'>998</span>        }
</div><div class='line not-covered'><span class='num'>999</span>        $old = $this-&gt;getEdge($edge-&gt;source, $edge-&gt;target);
</div><div class='line not-covered'><span class='num'>1000</span>        $this-&gt;insertAuditLog(new AuditLog( &#039;edge&#039;, $edge-&gt;id, &#039;update&#039;, $old-&gt;toArray(), $edge-&gt;toArray()));
</div><div class='line not-executable'><span class='num'>1001</span>
</div><div class='line not-covered'><span class='num'>1002</span>        $this-&gt;db-&gt;updateEdge(
</div><div class='line not-covered'><span class='num'>1003</span>            $edge-&gt;id,
</div><div class='line not-covered'><span class='num'>1004</span>            $edge-&gt;source,
</div><div class='line not-covered'><span class='num'>1005</span>            $edge-&gt;target,
</div><div class='line not-covered'><span class='num'>1006</span>            $edge-&gt;data
</div><div class='line not-executable'><span class='num'>1007</span>        );
</div><div class='line not-covered'><span class='num'>1008</span>    }
</div><div class='line not-executable'><span class='num'>1009</span>
</div><div class='line not-executable'><span class='num'>1010</span>    public function deleteEdge(string $id): void
</div><div class='line not-executable'><span class='num'>1011</span>    {
</div><div class='line not-covered'><span class='num'>1012</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>1013</span>            throw new RuntimeException(&quot;Permission denied to delete edge.&quot;);
</div><div class='line not-executable'><span class='num'>1014</span>        }
</div><div class='line not-covered'><span class='num'>1015</span>        $this-&gt;db-&gt;deleteEdge($id);
</div><div class='line not-covered'><span class='num'>1016</span>    }
</div><div class='line not-executable'><span class='num'>1017</span>
</div><div class='line not-executable'><span class='num'>1018</span>    public function getStatuses(): NodeStatuses
</div><div class='line not-executable'><span class='num'>1019</span>    {
</div><div class='line not-covered'><span class='num'>1020</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>1021</span>            throw new RuntimeException(&quot;Permission denied to get statuses.&quot;);
</div><div class='line not-executable'><span class='num'>1022</span>        }
</div><div class='line not-executable'><span class='num'>1023</span>
</div><div class='line not-covered'><span class='num'>1024</span>        $statusesData = $this-&gt;db-&gt;getStatuses();
</div><div class='line not-covered'><span class='num'>1025</span>        $nodeStatuses = new NodeStatuses();
</div><div class='line not-covered'><span class='num'>1026</span>        foreach ($statusesData as $data) {
</div><div class='line not-covered'><span class='num'>1027</span>            $status = new NodeStatus(
</div><div class='line not-covered'><span class='num'>1028</span>                $data[&#039;id&#039;],
</div><div class='line not-covered'><span class='num'>1029</span>                $data[&#039;status&#039;] ?? &#039;unknown&#039;
</div><div class='line not-executable'><span class='num'>1030</span>            );
</div><div class='line not-covered'><span class='num'>1031</span>            $nodeStatuses-&gt;addStatus($status);
</div><div class='line not-executable'><span class='num'>1032</span>        }
</div><div class='line not-covered'><span class='num'>1033</span>        return $nodeStatuses;
</div><div class='line not-covered'><span class='num'>1034</span>    }
</div><div class='line not-executable'><span class='num'>1035</span>
</div><div class='line not-executable'><span class='num'>1036</span>    public function getNodeStatus(string $id): NodeStatus
</div><div class='line not-executable'><span class='num'>1037</span>    {
</div><div class='line not-covered'><span class='num'>1038</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>1039</span>            throw new RuntimeException(&quot;Permission denied to get node status.&quot;);
</div><div class='line not-executable'><span class='num'>1040</span>        }
</div><div class='line not-executable'><span class='num'>1041</span>
</div><div class='line not-covered'><span class='num'>1042</span>        $statusData = $this-&gt;db-&gt;getNodeStatus($id);
</div><div class='line not-covered'><span class='num'>1043</span>        return new NodeStatus(
</div><div class='line not-covered'><span class='num'>1044</span>            $id,
</div><div class='line not-covered'><span class='num'>1045</span>            $statusData ?? &#039;unknown&#039;
</div><div class='line not-executable'><span class='num'>1046</span>        );
</div><div class='line not-covered'><span class='num'>1047</span>    }
</div><div class='line not-executable'><span class='num'>1048</span>
</div><div class='line not-executable'><span class='num'>1049</span>    public function setNodeStatus(NodeStatus $status): void
</div><div class='line not-executable'><span class='num'>1050</span>    {
</div><div class='line not-covered'><span class='num'>1051</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>1052</span>            throw new RuntimeException(&quot;Permission denied to set node status.&quot;);
</div><div class='line not-executable'><span class='num'>1053</span>        }
</div><div class='line not-executable'><span class='num'>1054</span>
</div><div class='line not-covered'><span class='num'>1055</span>        $this-&gt;db-&gt;setNodeStatus($status-&gt;nodeId, $status-&gt;status);
</div><div class='line not-covered'><span class='num'>1056</span>    }
</div><div class='line not-executable'><span class='num'>1057</span>
</div><div class='line not-executable'><span class='num'>1058</span>    public function getLogs($limit): AuditLogs
</div><div class='line not-executable'><span class='num'>1059</span>    {
</div><div class='line not-covered'><span class='num'>1060</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>1061</span>            throw new RuntimeException(&quot;Permission denied to get audit logs.&quot;);
</div><div class='line not-executable'><span class='num'>1062</span>        }
</div><div class='line not-executable'><span class='num'>1063</span>
</div><div class='line not-covered'><span class='num'>1064</span>        $logs = new AuditLogs();
</div><div class='line not-covered'><span class='num'>1065</span>        $rows = $this-&gt;db-&gt;getLogs($limit);
</div><div class='line not-covered'><span class='num'>1066</span>        foreach ($rows as $row) {
</div><div class='line not-covered'><span class='num'>1067</span>            $old_data = $row[&#039;old_data&#039;] ? json_decode($row[&#039;old_data&#039;], true) : [];
</div><div class='line not-covered'><span class='num'>1068</span>            $new_data = $row[&#039;new_data&#039;] ?  json_decode($row[&#039;new_data&#039;], true) : [];
</div><div class='line not-covered'><span class='num'>1069</span>            $log = new AuditLog(
</div><div class='line not-covered'><span class='num'>1070</span>                $row[&#039;entity_type&#039;],
</div><div class='line not-covered'><span class='num'>1071</span>                $row[&#039;entity_id&#039;],
</div><div class='line not-covered'><span class='num'>1072</span>                $row[&#039;action&#039;],
</div><div class='line not-executable'><span class='num'>1073</span>                $old_data,
</div><div class='line not-executable'><span class='num'>1074</span>                $new_data,
</div><div class='line not-executable'><span class='num'>1075</span>            );
</div><div class='line not-covered'><span class='num'>1076</span>            $log-&gt;userId    = $row[&#039;user_id&#039;];
</div><div class='line not-covered'><span class='num'>1077</span>            $log-&gt;ipAddress = $row[&#039;ip_address&#039;];
</div><div class='line not-covered'><span class='num'>1078</span>            $log-&gt;createdAt = $row[&#039;created_at&#039;];
</div><div class='line not-executable'><span class='num'>1079</span>
</div><div class='line not-covered'><span class='num'>1080</span>            $logs-&gt;addLog($log);
</div><div class='line not-executable'><span class='num'>1081</span>        }
</div><div class='line not-covered'><span class='num'>1082</span>        return $logs;
</div><div class='line not-covered'><span class='num'>1083</span>    }
</div><div class='line not-executable'><span class='num'>1084</span>
</div><div class='line not-executable'><span class='num'>1085</span>    private function insertAuditLog(AuditLog $auditLog): void
</div><div class='line not-executable'><span class='num'>1086</span>    {
</div><div class='line covered'><span class='num'>1087</span>        $user_id   = GraphContext::$user-&gt;id;
</div><div class='line covered'><span class='num'>1088</span>        $ip_address = GraphContext::$user-&gt;ipAddress;
</div><div class='line not-executable'><span class='num'>1089</span>
</div><div class='line covered'><span class='num'>1090</span>        $this-&gt;db-&gt;insertAuditLog(
</div><div class='line covered'><span class='num'>1091</span>            $auditLog-&gt;entityType,
</div><div class='line covered'><span class='num'>1092</span>            $auditLog-&gt;entityId,
</div><div class='line covered'><span class='num'>1093</span>            $auditLog-&gt;action,
</div><div class='line covered'><span class='num'>1094</span>            $auditLog-&gt;oldData,
</div><div class='line covered'><span class='num'>1095</span>            $auditLog-&gt;newData,
</div><div class='line not-executable'><span class='num'>1096</span>            $user_id,
</div><div class='line not-executable'><span class='num'>1097</span>            $ip_address
</div><div class='line not-executable'><span class='num'>1098</span>        );
</div><div class='line covered'><span class='num'>1099</span>    }
</div><div class='line not-executable'><span class='num'>1100</span>
</div><div class='line not-executable'><span class='num'>1101</span>    private function isAllowed(string $action): bool
</div><div class='line not-executable'><span class='num'>1102</span>    {
</div><div class='line covered'><span class='num'>1103</span>        $group = GraphContext::$user-&gt;group;
</div><div class='line not-executable'><span class='num'>1104</span>
</div><div class='line not-executable'><span class='num'>1105</span>        // validate action
</div><div class='line not-executable'><span class='num'>1106</span>        // if action is one of the keys in the array self::SECURE_ACTIONS
</div><div class='line covered'><span class='num'>1107</span>        if (!array_key_exists($action, self::SECURE_ACTIONS)) {
</div><div class='line not-covered'><span class='num'>1108</span>            throw new RuntimeException(&quot;Action not defined in secure actions. Action: {$action}&quot;);
</div><div class='line not-executable'><span class='num'>1109</span>        }
</div><div class='line not-executable'><span class='num'>1110</span>
</div><div class='line not-executable'><span class='num'>1111</span>        // if is admin, allow all
</div><div class='line covered'><span class='num'>1112</span>        if ($group-&gt;id === &#039;admin&#039;) {
</div><div class='line not-covered'><span class='num'>1113</span>            return true;
</div><div class='line not-executable'><span class='num'>1114</span>        }
</div><div class='line not-executable'><span class='num'>1115</span>
</div><div class='line not-executable'><span class='num'>1116</span>        // if action is in the SAFE_ACTIONS, allow all
</div><div class='line covered'><span class='num'>1117</span>        if (self::SECURE_ACTIONS[$action]) {
</div><div class='line covered'><span class='num'>1118</span>            return true;
</div><div class='line not-executable'><span class='num'>1119</span>        }
</div><div class='line not-executable'><span class='num'>1120</span>        
</div><div class='line not-executable'><span class='num'>1121</span>        // if action is restricted, only allow contributor
</div><div class='line covered'><span class='num'>1122</span>        if (self::SECURE_ACTIONS[$action] == false &amp;&amp; $group-&gt;id == &#039;contributor&#039;)
</div><div class='line not-executable'><span class='num'>1123</span>        {
</div><div class='line covered'><span class='num'>1124</span>            return true;
</div><div class='line not-executable'><span class='num'>1125</span>        }
</div><div class='line not-executable'><span class='num'>1126</span>
</div><div class='line not-covered'><span class='num'>1127</span>        return false;
</div><div class='line not-covered'><span class='num'>1128</span>    }
</div><div class='line not-executable'><span class='num'>1129</span>}
</div><div class='line not-executable'><span class='num'>1130</span>
</div><div class='line not-executable'><span class='num'>1131</span>final class Request
</div><div class='line not-executable'><span class='num'>1132</span>{
</div><div class='line not-executable'><span class='num'>1133</span>    public array $data;
</div><div class='line not-executable'><span class='num'>1134</span>
</div><div class='line not-executable'><span class='num'>1135</span>    public function getParam($name): string
</div><div class='line not-executable'><span class='num'>1136</span>    {
</div><div class='line covered'><span class='num'>1137</span>        if(isset($_GET[$name])) {
</div><div class='line covered'><span class='num'>1138</span>            return $_GET[$name];
</div><div class='line not-executable'><span class='num'>1139</span>        }
</div><div class='line not-executable'><span class='num'>1140</span>
</div><div class='line not-covered'><span class='num'>1141</span>        throw new RuntimeException(&quot;param &#039;{$name}&#039; not found&quot;);
</div><div class='line not-covered'><span class='num'>1142</span>    }
</div><div class='line not-executable'><span class='num'>1143</span>
</div><div class='line not-executable'><span class='num'>1144</span>    public function getPath(): string
</div><div class='line not-executable'><span class='num'>1145</span>    {
</div><div class='line not-covered'><span class='num'>1146</span>        $scriptName = $_SERVER[&#039;SCRIPT_NAME&#039;];
</div><div class='line not-covered'><span class='num'>1147</span>        $requestUri = $_SERVER[&#039;REQUEST_URI&#039;];
</div><div class='line not-covered'><span class='num'>1148</span>        $requestUri = strtok($requestUri, &#039;?&#039;);
</div><div class='line not-covered'><span class='num'>1149</span>        $path = str_replace($scriptName, &#039;&#039;, $requestUri);
</div><div class='line not-covered'><span class='num'>1150</span>        return $path;
</div><div class='line not-covered'><span class='num'>1151</span>    }
</div><div class='line not-executable'><span class='num'>1152</span>}
</div><div class='line not-executable'><span class='num'>1153</span>
</div><div class='line not-executable'><span class='num'>1154</span>interface ResponseInterface
</div><div class='line not-executable'><span class='num'>1155</span>{
</div><div class='line not-executable'><span class='num'>1156</span>    public function send(): void;
</div><div class='line not-executable'><span class='num'>1157</span>}
</div><div class='line not-executable'><span class='num'>1158</span>
</div><div class='line not-executable'><span class='num'>1159</span>class Response implements ResponseInterface
</div><div class='line not-executable'><span class='num'>1160</span>{
</div><div class='line not-executable'><span class='num'>1161</span>    public int $code;
</div><div class='line not-executable'><span class='num'>1162</span>    public string $status;
</div><div class='line not-executable'><span class='num'>1163</span>    public string $message;
</div><div class='line not-executable'><span class='num'>1164</span>    public array $data;
</div><div class='line not-executable'><span class='num'>1165</span>
</div><div class='line not-executable'><span class='num'>1166</span>    public function __construct(int $code, string $status, string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1167</span>    {
</div><div class='line covered'><span class='num'>1168</span>        $this-&gt;code = $code;
</div><div class='line covered'><span class='num'>1169</span>        $this-&gt;status = $status;
</div><div class='line covered'><span class='num'>1170</span>        $this-&gt;message = $message;
</div><div class='line covered'><span class='num'>1171</span>        $this-&gt;data = $data;
</div><div class='line covered'><span class='num'>1172</span>    }
</div><div class='line not-executable'><span class='num'>1173</span>
</div><div class='line not-executable'><span class='num'>1174</span>    public function send(): void
</div><div class='line not-executable'><span class='num'>1175</span>    {
</div><div class='line not-covered'><span class='num'>1176</span>        header(&#039;Content-Type: application/json; charset=utf-8&#039;);
</div><div class='line not-covered'><span class='num'>1177</span>        http_response_code($this-&gt;code);
</div><div class='line not-covered'><span class='num'>1178</span>        $this-&gt;data = [&#039;code&#039; =&gt; $this-&gt;code, &#039;status&#039; =&gt; $this-&gt;status, &#039;message&#039; =&gt; $this-&gt;message, &#039;data&#039; =&gt; $this-&gt;data];
</div><div class='line not-covered'><span class='num'>1179</span>        echo json_encode($this-&gt;data, JSON_UNESCAPED_UNICODE |  JSON_UNESCAPED_SLASHES |  JSON_PRETTY_PRINT);
</div><div class='line not-covered'><span class='num'>1180</span>    }
</div><div class='line not-executable'><span class='num'>1181</span>}
</div><div class='line not-executable'><span class='num'>1182</span>
</div><div class='line not-executable'><span class='num'>1183</span>class OKResponse extends Response
</div><div class='line not-executable'><span class='num'>1184</span>{
</div><div class='line not-executable'><span class='num'>1185</span>    public function __construct(string $message, array $data)
</div><div class='line not-executable'><span class='num'>1186</span>    {
</div><div class='line covered'><span class='num'>1187</span>        return parent::__construct(200, &#039;success&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1188</span>    }
</div><div class='line not-executable'><span class='num'>1189</span>}
</div><div class='line not-executable'><span class='num'>1190</span>
</div><div class='line not-executable'><span class='num'>1191</span>class CreatedResponse extends Response
</div><div class='line not-executable'><span class='num'>1192</span>{
</div><div class='line not-executable'><span class='num'>1193</span>    public function __construct(string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1194</span>    {
</div><div class='line covered'><span class='num'>1195</span>        return parent::__construct(201, &#039;success&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1196</span>    }
</div><div class='line not-executable'><span class='num'>1197</span>}
</div><div class='line not-executable'><span class='num'>1198</span>
</div><div class='line not-executable'><span class='num'>1199</span>class BadRequestResponse extends Response
</div><div class='line not-executable'><span class='num'>1200</span>{
</div><div class='line not-executable'><span class='num'>1201</span>    public function __construct(string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1202</span>    {
</div><div class='line not-covered'><span class='num'>1203</span>        return parent::__construct(400, &#039;error&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1204</span>    }
</div><div class='line not-executable'><span class='num'>1205</span>}
</div><div class='line not-executable'><span class='num'>1206</span>
</div><div class='line not-executable'><span class='num'>1207</span>class UnauthorizedResponse extends Response
</div><div class='line not-executable'><span class='num'>1208</span>{
</div><div class='line not-executable'><span class='num'>1209</span>    public function __construct(string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1210</span>    {
</div><div class='line not-covered'><span class='num'>1211</span>        return parent::__construct(401, &#039;error&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1212</span>    }
</div><div class='line not-executable'><span class='num'>1213</span>}
</div><div class='line not-executable'><span class='num'>1214</span>
</div><div class='line not-executable'><span class='num'>1215</span>class ForbiddenResponse extends Response
</div><div class='line not-executable'><span class='num'>1216</span>{
</div><div class='line not-executable'><span class='num'>1217</span>    public function __construct(string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1218</span>    {
</div><div class='line not-covered'><span class='num'>1219</span>        return parent::__construct(403, &#039;error&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1220</span>    }
</div><div class='line not-executable'><span class='num'>1221</span>}
</div><div class='line not-executable'><span class='num'>1222</span>
</div><div class='line not-executable'><span class='num'>1223</span>class NotFoundResponse extends Response
</div><div class='line not-executable'><span class='num'>1224</span>{
</div><div class='line not-executable'><span class='num'>1225</span>    public function __construct(string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1226</span>    {
</div><div class='line not-covered'><span class='num'>1227</span>        return parent::__construct(404, &#039;error&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1228</span>    }
</div><div class='line not-executable'><span class='num'>1229</span>}
</div><div class='line not-executable'><span class='num'>1230</span>
</div><div class='line not-executable'><span class='num'>1231</span>class InternalServerErrorResponse extends Response
</div><div class='line not-executable'><span class='num'>1232</span>{
</div><div class='line not-executable'><span class='num'>1233</span>    public function __construct(string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1234</span>    {
</div><div class='line not-covered'><span class='num'>1235</span>        return parent::__construct(500, &#039;error&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1236</span>    }
</div><div class='line not-executable'><span class='num'>1237</span>}
</div><div class='line not-executable'><span class='num'>1238</span>
</div><div class='line not-executable'><span class='num'>1239</span>interface GraphControllerInterface
</div><div class='line not-executable'><span class='num'>1240</span>{
</div><div class='line not-executable'><span class='num'>1241</span>    public function getUser(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1242</span>    public function insertUser(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1243</span>    public function updateUser(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1244</span>
</div><div class='line not-executable'><span class='num'>1245</span>    public function getGraph(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1246</span>
</div><div class='line not-executable'><span class='num'>1247</span>    public function getNode(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1248</span>    public function getNodes(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1249</span>    public function insertNode(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1250</span>    public function updateNode(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1251</span>    public function deleteNode(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1252</span>
</div><div class='line not-executable'><span class='num'>1253</span>    public function getEdge(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1254</span>    public function getEdges(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1255</span>    public function insertEdge(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1256</span>    public function updateEdge(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1257</span>    public function deleteEdge(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1258</span>
</div><div class='line not-executable'><span class='num'>1259</span>    public function getStatuses(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1260</span>    public function getNodeStatus(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1261</span>    public function setNodeStatus(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1262</span>
</div><div class='line not-executable'><span class='num'>1263</span>    public function getLogs(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1264</span>}
</div><div class='line not-executable'><span class='num'>1265</span>
</div><div class='line not-executable'><span class='num'>1266</span>final class GraphControllerException extends RuntimeException
</div><div class='line not-executable'><span class='num'>1267</span>{
</div><div class='line not-executable'><span class='num'>1268</span>}
</div><div class='line not-executable'><span class='num'>1269</span>
</div><div class='line not-executable'><span class='num'>1270</span>final class GraphController implements GraphControllerInterface
</div><div class='line not-executable'><span class='num'>1271</span>{
</div><div class='line not-executable'><span class='num'>1272</span>    private GraphServiceInterface $service;
</div><div class='line not-executable'><span class='num'>1273</span>    private Logger $logger;
</div><div class='line not-executable'><span class='num'>1274</span>
</div><div class='line not-executable'><span class='num'>1275</span>    public function __construct(GraphServiceInterface $service, Logger $logger)
</div><div class='line not-executable'><span class='num'>1276</span>    {
</div><div class='line covered'><span class='num'>1277</span>        $this-&gt;service = $service;
</div><div class='line covered'><span class='num'>1278</span>        $this-&gt;logger = $logger;
</div><div class='line covered'><span class='num'>1279</span>    }
</div><div class='line not-executable'><span class='num'>1280</span>
</div><div class='line not-executable'><span class='num'>1281</span>    public function getUser(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1282</span>    {
</div><div class='line not-covered'><span class='num'>1283</span>        $data = $this-&gt;service-&gt;getUser($req-&gt;data[&#039;id&#039;]);
</div><div class='line not-covered'><span class='num'>1284</span>        $user = new User($data[&#039;id&#039;], null, new Group($data[&#039;user_group&#039;]));
</div><div class='line not-covered'><span class='num'>1285</span>        return new OKResponse(&#039;user found&#039;, $user-&gt;toArray());
</div><div class='line not-covered'><span class='num'>1286</span>    }
</div><div class='line not-executable'><span class='num'>1287</span>
</div><div class='line not-executable'><span class='num'>1288</span>    public function insertUser(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1289</span>    {
</div><div class='line not-covered'><span class='num'>1290</span>        $user = new User($req-&gt;data[&#039;id&#039;], null, $req-&gt;data[&#039;user_group&#039;]);
</div><div class='line not-covered'><span class='num'>1291</span>        $this-&gt;service-&gt;insertUser($user);
</div><div class='line not-covered'><span class='num'>1292</span>        return new OKResponse(&#039;user created&#039;, $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1293</span>    }
</div><div class='line not-executable'><span class='num'>1294</span>
</div><div class='line not-executable'><span class='num'>1295</span>    public function updateUser(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1296</span>    {
</div><div class='line not-covered'><span class='num'>1297</span>        $user = new User($req-&gt;data[&#039;id&#039;], null, $req-&gt;data[&#039;user_group&#039;]);
</div><div class='line not-covered'><span class='num'>1298</span>        $this-&gt;service-&gt;updateUser($user);
</div><div class='line not-covered'><span class='num'>1299</span>        return new CreatedResponse(&#039;user updated&#039;, $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1300</span>    }
</div><div class='line not-executable'><span class='num'>1301</span>
</div><div class='line not-executable'><span class='num'>1302</span>    public function getGraph(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1303</span>    {
</div><div class='line not-executable'><span class='num'>1304</span>        try {
</div><div class='line not-covered'><span class='num'>1305</span>            $data = $this-&gt;service-&gt;getGraph()-&gt;toArray();
</div><div class='line not-covered'><span class='num'>1306</span>            return new OKResponse(&#039;get graph&#039;, $data);
</div><div class='line not-covered'><span class='num'>1307</span>            return $resp;
</div><div class='line not-covered'><span class='num'>1308</span>        } catch (Exception $e) {
</div><div class='line not-covered'><span class='num'>1309</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1310</span>        }
</div><div class='line not-executable'><span class='num'>1311</span>
</div><div class='line not-covered'><span class='num'>1312</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1313</span>    }
</div><div class='line not-executable'><span class='num'>1314</span>
</div><div class='line not-executable'><span class='num'>1315</span>    public function getNode(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1316</span>    {
</div><div class='line not-executable'><span class='num'>1317</span>        try {
</div><div class='line covered'><span class='num'>1318</span>            $id = $req-&gt;getParam(&#039;id&#039;);
</div><div class='line covered'><span class='num'>1319</span>            $node = $this-&gt;service-&gt;getNode($id);
</div><div class='line covered'><span class='num'>1320</span>            $data = $node-&gt;toArray();
</div><div class='line covered'><span class='num'>1321</span>            return new OKResponse(&#039;node found&#039;, $data);
</div><div class='line not-covered'><span class='num'>1322</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1323</span>        {
</div><div class='line not-covered'><span class='num'>1324</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1325</span>        }
</div><div class='line not-executable'><span class='num'>1326</span>
</div><div class='line not-covered'><span class='num'>1327</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1328</span>    }
</div><div class='line not-executable'><span class='num'>1329</span>
</div><div class='line not-executable'><span class='num'>1330</span>    public function getNodes(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1331</span>    {
</div><div class='line not-executable'><span class='num'>1332</span>        try {
</div><div class='line not-covered'><span class='num'>1333</span>            $nodes = $this-&gt;service-&gt;getNodes();
</div><div class='line not-executable'><span class='num'>1334</span>            // TODO: corrigir
</div><div class='line not-covered'><span class='num'>1335</span>            return new OKResponse(&#039;nodes found&#039;, []);
</div><div class='line not-covered'><span class='num'>1336</span>            return $resp;
</div><div class='line not-covered'><span class='num'>1337</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1338</span>        {
</div><div class='line not-covered'><span class='num'>1339</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1340</span>        }
</div><div class='line not-executable'><span class='num'>1341</span>        
</div><div class='line not-covered'><span class='num'>1342</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1343</span>    }
</div><div class='line not-executable'><span class='num'>1344</span>
</div><div class='line not-executable'><span class='num'>1345</span>    public function insertNode(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1346</span>    {
</div><div class='line covered'><span class='num'>1347</span>        $this-&gt;logger-&gt;debug(&#039;inserting node&#039;, $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1348</span>        try {
</div><div class='line covered'><span class='num'>1349</span>            $node = new Node($req-&gt;data[&#039;id&#039;], $req-&gt;data[&#039;label&#039;], $req-&gt;data[&#039;category&#039;], $req-&gt;data[&#039;type&#039;], $req-&gt;data[&#039;data&#039;]);
</div><div class='line covered'><span class='num'>1350</span>            $this-&gt;service-&gt;insertNode($node);
</div><div class='line covered'><span class='num'>1351</span>            $this-&gt;logger-&gt;info(&#039;node inserted&#039;, $req-&gt;data);
</div><div class='line covered'><span class='num'>1352</span>            return new CreatedResponse(&#039;node inserted&#039;, $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1353</span>        } catch( GraphServiceException $e)
</div><div class='line not-executable'><span class='num'>1354</span>        {
</div><div class='line not-covered'><span class='num'>1355</span>            $this-&gt;logger-&gt;error(&#039;The service could not insert new node:&#039; . $e-&gt;getMessage());
</div><div class='line not-covered'><span class='num'>1356</span>            throw new GraphControllerException(&#039;The service could not insert new node:&#039; . $e-&gt;getMessage(), 0, $e);
</div><div class='line not-executable'><span class='num'>1357</span>        }
</div><div class='line not-covered'><span class='num'>1358</span>        return new InternalServerErrorResponse(&#039;unknow error inserting node&#039;, $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1359</span>    }
</div><div class='line not-executable'><span class='num'>1360</span>    
</div><div class='line not-executable'><span class='num'>1361</span>    public function updateNode(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1362</span>    {
</div><div class='line covered'><span class='num'>1363</span>        $this-&gt;logger-&gt;debug(&#039;updating node&#039;, $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1364</span>
</div><div class='line not-executable'><span class='num'>1365</span>        try {
</div><div class='line covered'><span class='num'>1366</span>            $edge = new Edge($req-&gt;data[&#039;id&#039;], $req-&gt;data[&#039;category&#039;], $req-&gt;data[&#039;type&#039;], $req-&gt;data[&#039;data&#039;]);
</div><div class='line covered'><span class='num'>1367</span>            $this-&gt;service-&gt;insertEdge($edge);
</div><div class='line covered'><span class='num'>1368</span>            $this-&gt;logger-&gt;info(&#039;edge inserted&#039;, $req-&gt;data);
</div><div class='line covered'><span class='num'>1369</span>            $resp = new CreatedResponse(&#039;edge created&#039;, $req-&gt;data);
</div><div class='line covered'><span class='num'>1370</span>            return $resp;
</div><div class='line not-covered'><span class='num'>1371</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1372</span>        {
</div><div class='line not-covered'><span class='num'>1373</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1374</span>        }
</div><div class='line not-executable'><span class='num'>1375</span>        
</div><div class='line not-covered'><span class='num'>1376</span>        return new InternalServerErrorResponse(&#039;unknow todo in updateNode&#039;, $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1377</span>    }
</div><div class='line not-executable'><span class='num'>1378</span>    
</div><div class='line not-executable'><span class='num'>1379</span>    public function deleteNode(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1380</span>    {
</div><div class='line not-executable'><span class='num'>1381</span>        try {
</div><div class='line not-covered'><span class='num'>1382</span>            $this-&gt;service-&gt;deleteEdge($req-&gt;data[&#039;id&#039;]);
</div><div class='line not-covered'><span class='num'>1383</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1384</span>        {
</div><div class='line not-covered'><span class='num'>1385</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1386</span>        }
</div><div class='line not-executable'><span class='num'>1387</span>        
</div><div class='line not-covered'><span class='num'>1388</span>        return new InternalServerErrorResponse(&#039;unknow todo in deleteNode&#039;, $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1389</span>    }
</div><div class='line not-executable'><span class='num'>1390</span>
</div><div class='line not-executable'><span class='num'>1391</span>    public function getEdge(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1392</span>    {
</div><div class='line not-executable'><span class='num'>1393</span>        try {
</div><div class='line not-covered'><span class='num'>1394</span>            $edge = $this-&gt;service-&gt;getEdge($req-&gt;data[&#039;source&#039;], $req-&gt;data[&#039;target&#039;]);
</div><div class='line not-covered'><span class='num'>1395</span>            $data = $edge-&gt;toArray();
</div><div class='line not-covered'><span class='num'>1396</span>            return new OKResponse(&#039;node found&#039;, $data);
</div><div class='line not-covered'><span class='num'>1397</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1398</span>        {
</div><div class='line not-covered'><span class='num'>1399</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1400</span>        }
</div><div class='line not-executable'><span class='num'>1401</span>        
</div><div class='line not-covered'><span class='num'>1402</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1403</span>    }
</div><div class='line not-executable'><span class='num'>1404</span>    
</div><div class='line not-executable'><span class='num'>1405</span>    public function getEdges(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1406</span>    {
</div><div class='line not-executable'><span class='num'>1407</span>        try {
</div><div class='line not-covered'><span class='num'>1408</span>            $edges = $this-&gt;service-&gt;getEdges();
</div><div class='line not-executable'><span class='num'>1409</span>            // TODO: corrigir
</div><div class='line not-covered'><span class='num'>1410</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1411</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1412</span>        {
</div><div class='line not-covered'><span class='num'>1413</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1414</span>        }
</div><div class='line not-executable'><span class='num'>1415</span>        
</div><div class='line not-covered'><span class='num'>1416</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1417</span>    }
</div><div class='line not-executable'><span class='num'>1418</span>    
</div><div class='line not-executable'><span class='num'>1419</span>    public function insertEdge(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1420</span>    {
</div><div class='line not-executable'><span class='num'>1421</span>        try {
</div><div class='line not-covered'><span class='num'>1422</span>            $edge = new Edge(null, $req-&gt;data[&#039;source&#039;], $req-&gt;data[&#039;target&#039;]);
</div><div class='line not-covered'><span class='num'>1423</span>            $this-&gt;service-&gt;insertEdge($edge);
</div><div class='line not-covered'><span class='num'>1424</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1425</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1426</span>        {
</div><div class='line not-covered'><span class='num'>1427</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1428</span>        }
</div><div class='line not-executable'><span class='num'>1429</span>        
</div><div class='line not-covered'><span class='num'>1430</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1431</span>    }
</div><div class='line not-executable'><span class='num'>1432</span>    
</div><div class='line not-executable'><span class='num'>1433</span>    public function updateEdge(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1434</span>    {
</div><div class='line not-executable'><span class='num'>1435</span>        try {
</div><div class='line not-covered'><span class='num'>1436</span>            $edge = new Edge($req-&gt;data[&#039;id&#039;], $req-&gt;data[&#039;source&#039;], $req-&gt;data[&#039;target&#039;], $req-&gt;data[&#039;data&#039;]);
</div><div class='line not-covered'><span class='num'>1437</span>            $this-&gt;service-&gt;updateEdge($edge);
</div><div class='line not-covered'><span class='num'>1438</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1439</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1440</span>        {
</div><div class='line not-covered'><span class='num'>1441</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1442</span>        }
</div><div class='line not-executable'><span class='num'>1443</span>        
</div><div class='line not-covered'><span class='num'>1444</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1445</span>    }
</div><div class='line not-executable'><span class='num'>1446</span>    
</div><div class='line not-executable'><span class='num'>1447</span>    public function deleteEdge(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1448</span>    {
</div><div class='line not-executable'><span class='num'>1449</span>        try {
</div><div class='line not-covered'><span class='num'>1450</span>            $id = $req-&gt;data[&#039;id&#039;];
</div><div class='line not-covered'><span class='num'>1451</span>            $this-&gt;service-&gt;deleteEdge($id);
</div><div class='line not-covered'><span class='num'>1452</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1453</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1454</span>        {
</div><div class='line not-covered'><span class='num'>1455</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1456</span>        }
</div><div class='line not-executable'><span class='num'>1457</span>        
</div><div class='line not-covered'><span class='num'>1458</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1459</span>    }
</div><div class='line not-executable'><span class='num'>1460</span>
</div><div class='line not-executable'><span class='num'>1461</span>    public function getStatuses(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1462</span>    {
</div><div class='line not-executable'><span class='num'>1463</span>        try {
</div><div class='line not-covered'><span class='num'>1464</span>            $statuses = $this-&gt;service-&gt;getStatuses();
</div><div class='line not-covered'><span class='num'>1465</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1466</span>            return $resp;
</div><div class='line not-covered'><span class='num'>1467</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1468</span>        {
</div><div class='line not-covered'><span class='num'>1469</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1470</span>        }
</div><div class='line not-executable'><span class='num'>1471</span>        
</div><div class='line not-covered'><span class='num'>1472</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1473</span>    }
</div><div class='line not-executable'><span class='num'>1474</span>    
</div><div class='line not-executable'><span class='num'>1475</span>    public function getNodeStatus(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1476</span>    {
</div><div class='line not-executable'><span class='num'>1477</span>        try {
</div><div class='line not-covered'><span class='num'>1478</span>            $status = $this-&gt;service-&gt;getNodeStatus($req-&gt;data[&#039;id&#039;]);
</div><div class='line not-covered'><span class='num'>1479</span>            $data = $status-&gt;toArray();
</div><div class='line not-covered'><span class='num'>1480</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1481</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1482</span>        {
</div><div class='line not-covered'><span class='num'>1483</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1484</span>        }
</div><div class='line not-executable'><span class='num'>1485</span>        
</div><div class='line not-covered'><span class='num'>1486</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1487</span>    }
</div><div class='line not-executable'><span class='num'>1488</span>    
</div><div class='line not-executable'><span class='num'>1489</span>    public function setNodeStatus(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1490</span>    {
</div><div class='line not-executable'><span class='num'>1491</span>        try {
</div><div class='line not-covered'><span class='num'>1492</span>            $status = new NodeStatus($req-&gt;data[&#039;node_id&#039;], $req-&gt;data[&#039;status&#039;]);
</div><div class='line not-covered'><span class='num'>1493</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1494</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1495</span>        {
</div><div class='line not-covered'><span class='num'>1496</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1497</span>        }
</div><div class='line not-executable'><span class='num'>1498</span>        
</div><div class='line not-covered'><span class='num'>1499</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1500</span>    }
</div><div class='line not-executable'><span class='num'>1501</span>
</div><div class='line not-executable'><span class='num'>1502</span>    public function getLogs(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1503</span>    {
</div><div class='line not-executable'><span class='num'>1504</span>        try {
</div><div class='line not-covered'><span class='num'>1505</span>            $logs = $this-&gt;service-&gt;getLogs($req-&gt;getParam(&#039;limit&#039;));
</div><div class='line not-covered'><span class='num'>1506</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1507</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1508</span>        {
</div><div class='line not-covered'><span class='num'>1509</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1510</span>        }
</div><div class='line not-executable'><span class='num'>1511</span>        
</div><div class='line not-covered'><span class='num'>1512</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1513</span>    }
</div><div class='line not-executable'><span class='num'>1514</span>}
</div><div class='line not-executable'><span class='num'>1515</span>
</div><div class='line not-executable'><span class='num'>1516</span>final class RequestRouter
</div><div class='line not-executable'><span class='num'>1517</span>{
</div><div class='line not-executable'><span class='num'>1518</span>    private $routes = [
</div><div class='line not-executable'><span class='num'>1519</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getGraph&#039;, &#039;class_method&#039; =&gt; &#039;getGraph&#039;],
</div><div class='line not-executable'><span class='num'>1520</span>        
</div><div class='line not-executable'><span class='num'>1521</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getNode&#039;, &#039;class_method&#039; =&gt; &#039;getNode&#039;],
</div><div class='line not-executable'><span class='num'>1522</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getNodes&#039;, &#039;class_method&#039; =&gt; &#039;getNodes&#039;],
</div><div class='line not-executable'><span class='num'>1523</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/insertNode&#039;, &#039;class_method&#039; =&gt; &#039;insertNode&#039;],
</div><div class='line not-executable'><span class='num'>1524</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/updateNode&#039;, &#039;class_method&#039; =&gt; &#039;updateNode&#039;],
</div><div class='line not-executable'><span class='num'>1525</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/deleteNode&#039;, &#039;class_method&#039; =&gt; &#039;deleteNode&#039;],
</div><div class='line not-executable'><span class='num'>1526</span>
</div><div class='line not-executable'><span class='num'>1527</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getEdge&#039;, &#039;class_method&#039; =&gt; &#039;getEdge&#039;],
</div><div class='line not-executable'><span class='num'>1528</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getEdges&#039;, &#039;class_method&#039; =&gt; &#039;getEdges&#039;],
</div><div class='line not-executable'><span class='num'>1529</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/insertEdge&#039;, &#039;class_method&#039; =&gt; &#039;insertEdge&#039;],
</div><div class='line not-executable'><span class='num'>1530</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/updateEdge&#039;, &#039;class_method&#039; =&gt; &#039;updateEdge&#039;],
</div><div class='line not-executable'><span class='num'>1531</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/deleteEdge&#039;, &#039;class_method&#039; =&gt; &#039;deleteEdge&#039;],
</div><div class='line not-executable'><span class='num'>1532</span>
</div><div class='line not-executable'><span class='num'>1533</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getStatuses&#039;, &#039;class_method&#039; =&gt; &#039;getStatuses&#039;],
</div><div class='line not-executable'><span class='num'>1534</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getNodeStatus&#039;, &#039;class_method&#039; =&gt; &#039;getNodeStatus&#039;],
</div><div class='line not-executable'><span class='num'>1535</span>
</div><div class='line not-executable'><span class='num'>1536</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getLogs&#039;, &#039;class_method&#039; =&gt; &#039;getLogs&#039;],
</div><div class='line not-executable'><span class='num'>1537</span>
</div><div class='line not-executable'><span class='num'>1538</span>        ];
</div><div class='line not-executable'><span class='num'>1539</span>
</div><div class='line not-executable'><span class='num'>1540</span>    public GraphController $controller;
</div><div class='line not-executable'><span class='num'>1541</span>    
</div><div class='line not-executable'><span class='num'>1542</span>    public function __construct(GraphController $controller)
</div><div class='line not-executable'><span class='num'>1543</span>    {
</div><div class='line not-covered'><span class='num'>1544</span>        $this-&gt;controller = $controller;
</div><div class='line not-covered'><span class='num'>1545</span>    }
</div><div class='line not-executable'><span class='num'>1546</span>
</div><div class='line not-executable'><span class='num'>1547</span>    public function handle(): void
</div><div class='line not-executable'><span class='num'>1548</span>    {
</div><div class='line not-covered'><span class='num'>1549</span>        $method = $_SERVER[&#039;REQUEST_METHOD&#039;];
</div><div class='line not-executable'><span class='num'>1550</span>
</div><div class='line not-covered'><span class='num'>1551</span>        $scriptName = $_SERVER[&#039;SCRIPT_NAME&#039;];
</div><div class='line not-covered'><span class='num'>1552</span>        $requestUri = $_SERVER[&#039;REQUEST_URI&#039;];
</div><div class='line not-covered'><span class='num'>1553</span>        $requestUri = strtok($requestUri, &#039;?&#039;);
</div><div class='line not-executable'><span class='num'>1554</span>        
</div><div class='line not-covered'><span class='num'>1555</span>        $path = str_replace($scriptName, &#039;&#039;, $requestUri);
</div><div class='line not-executable'><span class='num'>1556</span>        
</div><div class='line not-covered'><span class='num'>1557</span>        $req = new Request();
</div><div class='line not-executable'><span class='num'>1558</span>
</div><div class='line not-covered'><span class='num'>1559</span>        foreach($this-&gt;routes as $route)
</div><div class='line not-executable'><span class='num'>1560</span>        {
</div><div class='line not-covered'><span class='num'>1561</span>            if ($route[&#039;method&#039;] == $method &amp;&amp; $route[&#039;path&#039;] == $path)
</div><div class='line not-executable'><span class='num'>1562</span>            {
</div><div class='line not-covered'><span class='num'>1563</span>                $method = $route[&#039;class_method&#039;];
</div><div class='line not-covered'><span class='num'>1564</span>                $resp = $this-&gt;controller-&gt;$method($req);
</div><div class='line not-covered'><span class='num'>1565</span>                print_r($resp);
</div><div class='line not-covered'><span class='num'>1566</span>                exit();
</div><div class='line not-executable'><span class='num'>1567</span>            }
</div><div class='line not-executable'><span class='num'>1568</span>        }
</div><div class='line not-covered'><span class='num'>1569</span>    }
</div><div class='line not-executable'><span class='num'>1570</span>}
</div><div class='line not-executable'><span class='num'>1571</span>
</div><div class='line not-executable'><span class='num'>1572</span>
</div></body></html><html><head><meta charset='UTF-8'><style>
body { font-family: monospace; font-size: 12px; background: #222; color: #ddd; margin: 0; }
.covered { background: #1a4d1a; }
.not-covered { background: #4d1a1a; }
.not-executable { background: #2a2a2a; color: #666; }
.line { padding: 2px 10px; white-space: pre; border-left: 3px solid transparent; }
.covered { border-left-color: #0f0; }
.not-covered { border-left-color: #f00; }
.num { color: #666; width: 50px; display: inline-block; text-align: right; margin-right: 10px; }
h2 { background: #333; padding: 10px; margin: 20px 0 0 0; position: sticky; top: 0; }
</style></head><body><h2>/home/tarcisio/projects/graph/tests.php - 77.05% (47/61)</h2><div class='line not-executable'><span class='num'>1</span>&lt;?php
</div><div class='line not-executable'><span class='num'>2</span>
</div><div class='line not-executable'><span class='num'>3</span>declare(strict_types=1);
</div><div class='line not-executable'><span class='num'>4</span>
</div><div class='line not-executable'><span class='num'>5</span>require_once __DIR__ . &#039;/graph.php&#039;;
</div><div class='line not-executable'><span class='num'>6</span>
</div><div class='line not-executable'><span class='num'>7</span>ini_set(&#039;xdebug.mode&#039;, &#039;1&#039;);
</div><div class='line not-executable'><span class='num'>8</span>xdebug_start_code_coverage(XDEBUG_CC_UNUSED | XDEBUG_CC_DEAD_CODE);
</div><div class='line not-executable'><span class='num'>9</span>
</div><div class='line not-executable'><span class='num'>10</span>function array_diff_recursive($array1, $array2) {
</div><div class='line covered'><span class='num'>11</span>    $diff = [];
</div><div class='line not-executable'><span class='num'>12</span>    
</div><div class='line covered'><span class='num'>13</span>    foreach ($array1 as $key =&gt; $value) {
</div><div class='line covered'><span class='num'>14</span>        if (!array_key_exists($key, $array2)) {
</div><div class='line not-covered'><span class='num'>15</span>            $diff[$key] = $value;
</div><div class='line covered'><span class='num'>16</span>        } elseif (is_array($value)) {
</div><div class='line covered'><span class='num'>17</span>            if (!is_array($array2[$key])) {
</div><div class='line not-covered'><span class='num'>18</span>                $diff[$key] = $value;
</div><div class='line not-executable'><span class='num'>19</span>            } else {
</div><div class='line covered'><span class='num'>20</span>                $recursiveDiff = array_diff_recursive($value, $array2[$key]);
</div><div class='line covered'><span class='num'>21</span>                if (count($recursiveDiff)) {
</div><div class='line not-covered'><span class='num'>22</span>                    $diff[$key] = $recursiveDiff;
</div><div class='line not-executable'><span class='num'>23</span>                }
</div><div class='line not-executable'><span class='num'>24</span>            }
</div><div class='line covered'><span class='num'>25</span>        } elseif ($value !== $array2[$key]) {
</div><div class='line not-covered'><span class='num'>26</span>            $diff[$key] = $value;
</div><div class='line not-executable'><span class='num'>27</span>        }
</div><div class='line not-executable'><span class='num'>28</span>    }
</div><div class='line not-executable'><span class='num'>29</span>    
</div><div class='line covered'><span class='num'>30</span>    return $diff;
</div><div class='line not-covered'><span class='num'>31</span>}
</div><div class='line not-executable'><span class='num'>32</span>
</div><div class='line not-executable'><span class='num'>33</span>function get_test_graph_controller()
</div><div class='line not-executable'><span class='num'>34</span>{
</div><div class='line covered'><span class='num'>35</span>    GraphContext::$user = new User(&#039;test_user&#039;, &#039;127.0.0.1&#039;, new Group(&#039;contributor&#039;));
</div><div class='line covered'><span class='num'>36</span>    $pdo = GraphDatabase::createConnection(&#039;sqlite::memory:&#039;);
</div><div class='line covered'><span class='num'>37</span>    $databaseLogger = new Logger(&#039;database.log&#039;);
</div><div class='line not-executable'><span class='num'>38</span>
</div><div class='line covered'><span class='num'>39</span>    $graphDb = new GraphDatabase($pdo, $databaseLogger);
</div><div class='line not-executable'><span class='num'>40</span>
</div><div class='line covered'><span class='num'>41</span>    $serviceLogger = new Logger(&#039;service.log&#039;);
</div><div class='line covered'><span class='num'>42</span>    $graphService = new GraphService($graphDb, $serviceLogger);
</div><div class='line not-executable'><span class='num'>43</span>
</div><div class='line covered'><span class='num'>44</span>    $controllerLogger = new Logger(&#039;controller.log&#039;);
</div><div class='line covered'><span class='num'>45</span>    $graphController = new GraphController($graphService, $controllerLogger);
</div><div class='line not-executable'><span class='num'>46</span>    
</div><div class='line covered'><span class='num'>47</span>    return $graphController;
</div><div class='line not-covered'><span class='num'>48</span>}
</div><div class='line not-executable'><span class='num'>49</span>
</div><div class='line not-executable'><span class='num'>50</span>function test_node_good_path()
</div><div class='line not-executable'><span class='num'>51</span>{
</div><div class='line covered'><span class='num'>52</span>    $graphController = get_test_graph_controller();
</div><div class='line covered'><span class='num'>53</span>    $insertNodeReq = new Request();
</div><div class='line covered'><span class='num'>54</span>    $insertNodeReq-&gt;data = [&#039;id&#039; =&gt; &#039;node1&#039;, &#039;label&#039; =&gt; &#039;node1&#039;, &#039;category&#039; =&gt; &#039;business&#039;, &#039;type&#039; =&gt; &#039;server&#039;, &#039;data&#039; =&gt; [&#039;info&#039; =&gt; &#039;first node&#039;]];
</div><div class='line covered'><span class='num'>55</span>    $resp = $graphController-&gt;insertNode($insertNodeReq);
</div><div class='line not-executable'><span class='num'>56</span>    
</div><div class='line covered'><span class='num'>57</span>    $expected = [
</div><div class='line not-executable'><span class='num'>58</span>        &#039;id&#039;       =&gt; &#039;node1&#039;,
</div><div class='line not-executable'><span class='num'>59</span>        &#039;label&#039;    =&gt; &#039;node1&#039;,
</div><div class='line not-executable'><span class='num'>60</span>        &#039;category&#039; =&gt; &#039;business&#039;,
</div><div class='line not-executable'><span class='num'>61</span>        &#039;type&#039; =&gt; &#039;server&#039;,
</div><div class='line not-executable'><span class='num'>62</span>        &#039;data&#039; =&gt; &#039;{}&#039;
</div><div class='line not-executable'><span class='num'>63</span>    ];
</div><div class='line not-executable'><span class='num'>64</span>
</div><div class='line not-executable'><span class='num'>65</span>    if($resp-&gt;code != 201) {
</div><div class='line not-executable'><span class='num'>66</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line covered'><span class='num'>67</span>    }
</div><div class='line not-covered'><span class='num'>68</span>
</div><div class='line not-executable'><span class='num'>69</span>    if($resp-&gt;status != &#039;success&#039;) {
</div><div class='line not-executable'><span class='num'>70</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line covered'><span class='num'>71</span>    }
</div><div class='line not-covered'><span class='num'>72</span>
</div><div class='line not-executable'><span class='num'>73</span>    if ($resp-&gt;message != &#039;node inserted&#039;) {
</div><div class='line not-executable'><span class='num'>74</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line covered'><span class='num'>75</span>    }
</div><div class='line not-covered'><span class='num'>76</span>
</div><div class='line not-executable'><span class='num'>77</span>    $diff = array_diff_recursive($resp-&gt;data, $expected);
</div><div class='line not-executable'><span class='num'>78</span>    if (! empty($diff)) {
</div><div class='line covered'><span class='num'>79</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line covered'><span class='num'>80</span>    }
</div><div class='line not-covered'><span class='num'>81</span>
</div><div class='line not-executable'><span class='num'>82</span>    $_GET[&#039;id&#039;] = &#039;node1&#039;;
</div><div class='line not-executable'><span class='num'>83</span>    $req = new Request();
</div><div class='line covered'><span class='num'>84</span>    $resp = $graphController-&gt;getNode($req);
</div><div class='line covered'><span class='num'>85</span>
</div><div class='line covered'><span class='num'>86</span>    if ($resp-&gt;code != 200) {
</div><div class='line not-executable'><span class='num'>87</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line covered'><span class='num'>88</span>    }
</div><div class='line not-covered'><span class='num'>89</span>
</div><div class='line not-executable'><span class='num'>90</span>    if($resp-&gt;status != &#039;success&#039;) {
</div><div class='line not-executable'><span class='num'>91</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line covered'><span class='num'>92</span>    }
</div><div class='line not-covered'><span class='num'>93</span>
</div><div class='line not-executable'><span class='num'>94</span>    if ($resp-&gt;message != &#039;node found&#039;) {
</div><div class='line not-executable'><span class='num'>95</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line covered'><span class='num'>96</span>    }
</div><div class='line not-covered'><span class='num'>97</span>
</div><div class='line not-executable'><span class='num'>98</span>    $expected = [
</div><div class='line not-executable'><span class='num'>99</span>        &#039;info&#039;     =&gt; &#039;first node&#039;,
</div><div class='line covered'><span class='num'>100</span>        &#039;id&#039;       =&gt; &#039;node1&#039;,
</div><div class='line not-executable'><span class='num'>101</span>        &#039;label&#039;    =&gt; &#039;node1&#039;,
</div><div class='line not-executable'><span class='num'>102</span>        &#039;category&#039; =&gt; &#039;business&#039;,
</div><div class='line not-executable'><span class='num'>103</span>        &#039;type&#039;     =&gt; &#039;server&#039;,
</div><div class='line not-executable'><span class='num'>104</span>    ];
</div><div class='line not-executable'><span class='num'>105</span>
</div><div class='line not-executable'><span class='num'>106</span>    $diff = array_diff_recursive($resp-&gt;data[&#039;data&#039;], $expected);
</div><div class='line not-executable'><span class='num'>107</span>    if (! empty($diff)) {
</div><div class='line covered'><span class='num'>108</span>        throw new Exception(&#039;test_node_good_path&#039;);
</div><div class='line covered'><span class='num'>109</span>    }
</div><div class='line not-covered'><span class='num'>110</span>    
</div><div class='line not-executable'><span class='num'>111</span>    $req = new Request();
</div><div class='line not-executable'><span class='num'>112</span>    $req-&gt;data = [
</div><div class='line covered'><span class='num'>113</span>        &#039;id&#039;       =&gt; &#039;node1&#039;,
</div><div class='line covered'><span class='num'>114</span>        &#039;label&#039;    =&gt; &#039;node1&#039;,
</div><div class='line not-executable'><span class='num'>115</span>        &#039;category&#039; =&gt; &#039;business&#039;,
</div><div class='line not-executable'><span class='num'>116</span>        &#039;type&#039; =&gt; &#039;server&#039;,
</div><div class='line not-executable'><span class='num'>117</span>        &#039;data&#039; =&gt; &#039;{}&#039;
</div><div class='line not-executable'><span class='num'>118</span>    ];
</div><div class='line not-executable'><span class='num'>119</span>    $resp = $graphController-&gt;updateNode($req);
</div><div class='line not-executable'><span class='num'>120</span>    print_r($resp);
</div><div class='line not-executable'><span class='num'>121</span>}
</div><div class='line not-executable'><span class='num'>122</span>
</div><div class='line covered'><span class='num'>123</span>function tests() {
</div><div class='line covered'><span class='num'>124</span>    test_node_good_path();
</div><div class='line covered'><span class='num'>125</span>    echo &quot;fim&quot;;
</div><div class='line not-executable'><span class='num'>126</span>}
</div><div class='line not-executable'><span class='num'>127</span>
</div><div class='line covered'><span class='num'>128</span>tests();
</div><div class='line covered'><span class='num'>129</span>
</div><div class='line covered'><span class='num'>130</span>$coverage = xdebug_get_code_coverage();
</div><div class='line not-executable'><span class='num'>131</span>xdebug_stop_code_coverage();
</div><div class='line covered'><span class='num'>132</span>
</div><div class='line not-executable'><span class='num'>133</span>// Salvar em arquivo
</div><div class='line covered'><span class='num'>134</span>file_put_contents(&#039;coverage.json&#039;, json_encode($coverage, JSON_PRETTY_PRINT));
</div><div class='line not-executable'><span class='num'>135</span>
</div><div class='line not-executable'><span class='num'>136</span>echo &#039;fim&#039;;</div><h2>/home/tarcisio/projects/graph/graph.php - 30.66% (195/636)</h2><div class='line not-executable'><span class='num'>1</span>&lt;?php
</div><div class='line not-executable'><span class='num'>2</span>
</div><div class='line not-executable'><span class='num'>3</span>declare(strict_types=1);
</div><div class='line not-executable'><span class='num'>4</span>
</div><div class='line not-executable'><span class='num'>5</span>final class User
</div><div class='line not-executable'><span class='num'>6</span>{
</div><div class='line not-executable'><span class='num'>7</span>    public string $id;
</div><div class='line not-executable'><span class='num'>8</span>    public ?string $ipAddress;
</div><div class='line not-executable'><span class='num'>9</span>    public Group $group;
</div><div class='line not-executable'><span class='num'>10</span>
</div><div class='line not-executable'><span class='num'>11</span>    public function __construct(string $id, ?string $ipAddress, Group $group)
</div><div class='line not-executable'><span class='num'>12</span>    {
</div><div class='line covered'><span class='num'>13</span>        $this-&gt;id = $id;
</div><div class='line covered'><span class='num'>14</span>        $this-&gt;ipAddress = $ipAddress;
</div><div class='line covered'><span class='num'>15</span>        $this-&gt;group = $group;
</div><div class='line covered'><span class='num'>16</span>    }
</div><div class='line not-executable'><span class='num'>17</span>
</div><div class='line not-executable'><span class='num'>18</span>    public function toArray(): array
</div><div class='line not-executable'><span class='num'>19</span>    {
</div><div class='line not-executable'><span class='num'>20</span>        return [
</div><div class='line not-covered'><span class='num'>21</span>            &#039;id&#039; =&gt; $this-&gt;id,
</div><div class='line not-executable'><span class='num'>22</span>            &#039;group&#039; =&gt; [
</div><div class='line not-covered'><span class='num'>23</span>                &#039;id&#039; =&gt; $this-&gt;group-&gt;id,
</div><div class='line not-executable'><span class='num'>24</span>            ],
</div><div class='line not-executable'><span class='num'>25</span>        ];
</div><div class='line not-covered'><span class='num'>26</span>    }
</div><div class='line not-executable'><span class='num'>27</span>}
</div><div class='line not-executable'><span class='num'>28</span>
</div><div class='line not-executable'><span class='num'>29</span>final class Group
</div><div class='line not-executable'><span class='num'>30</span>{
</div><div class='line not-executable'><span class='num'>31</span>    private const ALLOWED_GROUPS = [&#039;anonymous&#039;, &#039;consumer&#039;, &#039;contributor&#039;, &#039;admin&#039;];
</div><div class='line not-executable'><span class='num'>32</span>    
</div><div class='line not-executable'><span class='num'>33</span>    public string $id;
</div><div class='line not-executable'><span class='num'>34</span>    
</div><div class='line not-executable'><span class='num'>35</span>    public function __construct(string $id)
</div><div class='line not-executable'><span class='num'>36</span>    {
</div><div class='line covered'><span class='num'>37</span>        if (!in_array($id, self::ALLOWED_GROUPS, true)) {
</div><div class='line not-covered'><span class='num'>38</span>            throw new InvalidArgumentException(&quot;Invalid user group: {$id}&quot;);
</div><div class='line not-executable'><span class='num'>39</span>        }
</div><div class='line covered'><span class='num'>40</span>        $this-&gt;id  = $id;
</div><div class='line covered'><span class='num'>41</span>    }
</div><div class='line not-executable'><span class='num'>42</span>}
</div><div class='line not-executable'><span class='num'>43</span>
</div><div class='line not-executable'><span class='num'>44</span>final class Graph
</div><div class='line not-executable'><span class='num'>45</span>{
</div><div class='line not-executable'><span class='num'>46</span>    public array $nodes = [];
</div><div class='line not-executable'><span class='num'>47</span>    public array $edges = [];
</div><div class='line not-executable'><span class='num'>48</span>    public array $data  = [];
</div><div class='line not-executable'><span class='num'>49</span>    public array $layout = [];
</div><div class='line not-executable'><span class='num'>50</span>    public array $styles = [];
</div><div class='line not-executable'><span class='num'>51</span>
</div><div class='line not-executable'><span class='num'>52</span>    public function __construct(array $nodes, array $edges)
</div><div class='line not-executable'><span class='num'>53</span>    {
</div><div class='line not-covered'><span class='num'>54</span>        $this-&gt;nodes = $nodes;
</div><div class='line not-covered'><span class='num'>55</span>        $this-&gt;edges = $edges;
</div><div class='line not-covered'><span class='num'>56</span>    }
</div><div class='line not-executable'><span class='num'>57</span>
</div><div class='line not-executable'><span class='num'>58</span>    public function toArray(): array
</div><div class='line not-executable'><span class='num'>59</span>    {
</div><div class='line not-executable'><span class='num'>60</span>        return [
</div><div class='line not-covered'><span class='num'>61</span>            &#039;nodes&#039; =&gt; $this-&gt;nodes,
</div><div class='line not-covered'><span class='num'>62</span>            &#039;edges&#039; =&gt; $this-&gt;edges,
</div><div class='line not-covered'><span class='num'>63</span>            &#039;data&#039; =&gt; $this-&gt;data,
</div><div class='line not-covered'><span class='num'>64</span>            &#039;layout&#039; =&gt; $this-&gt;layout,
</div><div class='line not-covered'><span class='num'>65</span>            &#039;styles&#039; =&gt; $this-&gt;styles,
</div><div class='line not-executable'><span class='num'>66</span>        ];
</div><div class='line not-covered'><span class='num'>67</span>    }
</div><div class='line not-executable'><span class='num'>68</span>}
</div><div class='line not-executable'><span class='num'>69</span>
</div><div class='line not-executable'><span class='num'>70</span>final class Node
</div><div class='line not-executable'><span class='num'>71</span>{
</div><div class='line not-executable'><span class='num'>72</span>    private const ALLOWED_CATEGORIES  = [&#039;business&#039;, &#039;application&#039;, &#039;infrastructure&#039;];
</div><div class='line not-executable'><span class='num'>73</span>    private const ALLOWED_TYPES       = [&#039;server&#039;, &#039;database&#039;, &#039;application&#039;, &#039;network&#039;];
</div><div class='line not-executable'><span class='num'>74</span>    private const ID_VALIDATION_REGEX = &#039;/^[a-zA-Z0-9\-_]+$/&#039;;
</div><div class='line not-executable'><span class='num'>75</span>    private const LABEL_MAX_LENGTH    = 20;
</div><div class='line not-executable'><span class='num'>76</span>    
</div><div class='line not-executable'><span class='num'>77</span>    public string $id;
</div><div class='line not-executable'><span class='num'>78</span>    public string $label;
</div><div class='line not-executable'><span class='num'>79</span>    public string $category;
</div><div class='line not-executable'><span class='num'>80</span>    public string $type;
</div><div class='line not-executable'><span class='num'>81</span>
</div><div class='line not-executable'><span class='num'>82</span>    public array $data = [];
</div><div class='line not-executable'><span class='num'>83</span>
</div><div class='line not-executable'><span class='num'>84</span>    public function __construct(string $id, string $label, string $category, string $type, array $data)
</div><div class='line not-executable'><span class='num'>85</span>    {
</div><div class='line covered'><span class='num'>86</span>        $this-&gt;validate($id, $label, $category, $type);
</div><div class='line covered'><span class='num'>87</span>        $this-&gt;id       = $id;
</div><div class='line covered'><span class='num'>88</span>        $this-&gt;label    = $label;
</div><div class='line covered'><span class='num'>89</span>        $this-&gt;category = $category;
</div><div class='line covered'><span class='num'>90</span>        $this-&gt;type     = $type;
</div><div class='line covered'><span class='num'>91</span>        $this-&gt;data     = $data;
</div><div class='line covered'><span class='num'>92</span>    }
</div><div class='line not-executable'><span class='num'>93</span>
</div><div class='line not-executable'><span class='num'>94</span>    private function validate(string $id, string $label, string $category, string $type): void
</div><div class='line not-executable'><span class='num'>95</span>    {
</div><div class='line covered'><span class='num'>96</span>        if (!preg_match(self::ID_VALIDATION_REGEX, $id)) {
</div><div class='line not-covered'><span class='num'>97</span>            throw new InvalidArgumentException(&quot;Invalid node ID: {$id}&quot;);
</div><div class='line not-executable'><span class='num'>98</span>        }
</div><div class='line not-executable'><span class='num'>99</span>
</div><div class='line covered'><span class='num'>100</span>        if (strlen($label) &gt; self::LABEL_MAX_LENGTH) {
</div><div class='line not-covered'><span class='num'>101</span>            throw new InvalidArgumentException(&quot;Node label exceeds maximum length of &quot; . self::LABEL_MAX_LENGTH);
</div><div class='line not-executable'><span class='num'>102</span>        }
</div><div class='line not-executable'><span class='num'>103</span>
</div><div class='line covered'><span class='num'>104</span>        if (!in_array($category, self::ALLOWED_CATEGORIES, true)) {
</div><div class='line not-covered'><span class='num'>105</span>            throw new InvalidArgumentException(&quot;Invalid node category: {$category}&quot;);
</div><div class='line not-executable'><span class='num'>106</span>        }
</div><div class='line not-executable'><span class='num'>107</span>
</div><div class='line covered'><span class='num'>108</span>        if (!in_array($type, self::ALLOWED_TYPES, true)) {
</div><div class='line not-covered'><span class='num'>109</span>            throw new InvalidArgumentException(&quot;Invalid node type: {$type}&quot;);
</div><div class='line not-executable'><span class='num'>110</span>        }
</div><div class='line covered'><span class='num'>111</span>    }
</div><div class='line not-executable'><span class='num'>112</span>
</div><div class='line not-executable'><span class='num'>113</span>    public function toArray(): array
</div><div class='line not-executable'><span class='num'>114</span>    {
</div><div class='line not-executable'><span class='num'>115</span>        return [
</div><div class='line covered'><span class='num'>116</span>            &#039;id&#039;       =&gt; $this-&gt;id,
</div><div class='line covered'><span class='num'>117</span>            &#039;label&#039;    =&gt; $this-&gt;label,
</div><div class='line covered'><span class='num'>118</span>            &#039;category&#039; =&gt; $this-&gt;category,
</div><div class='line covered'><span class='num'>119</span>            &#039;type&#039;     =&gt; $this-&gt;type,
</div><div class='line covered'><span class='num'>120</span>            &#039;data&#039;     =&gt; $this-&gt;data
</div><div class='line not-executable'><span class='num'>121</span>        ];
</div><div class='line not-covered'><span class='num'>122</span>    }
</div><div class='line not-executable'><span class='num'>123</span>}
</div><div class='line not-executable'><span class='num'>124</span>
</div><div class='line not-executable'><span class='num'>125</span>final class NodeStatus
</div><div class='line not-executable'><span class='num'>126</span>{
</div><div class='line not-executable'><span class='num'>127</span>    private const ALLOWED_NODE_STATUSES = [&#039;unknown&#039;, &#039;healthy&#039;, &#039;unhealthy&#039;, &#039;maintenance&#039;];
</div><div class='line not-executable'><span class='num'>128</span>
</div><div class='line not-executable'><span class='num'>129</span>    public string $nodeId;
</div><div class='line not-executable'><span class='num'>130</span>    public string $status;
</div><div class='line not-executable'><span class='num'>131</span>
</div><div class='line not-executable'><span class='num'>132</span>    public function __construct(string $nodeId, string $status)
</div><div class='line not-executable'><span class='num'>133</span>    {
</div><div class='line not-covered'><span class='num'>134</span>        if (!in_array($status, self::ALLOWED_NODE_STATUSES, true)) {
</div><div class='line not-covered'><span class='num'>135</span>            throw new InvalidArgumentException(&quot;Invalid node status: {$status}&quot;);
</div><div class='line not-executable'><span class='num'>136</span>        }
</div><div class='line not-covered'><span class='num'>137</span>        $this-&gt;nodeId = $nodeId;
</div><div class='line not-covered'><span class='num'>138</span>        $this-&gt;status = $status;
</div><div class='line not-covered'><span class='num'>139</span>    }
</div><div class='line not-executable'><span class='num'>140</span>
</div><div class='line not-executable'><span class='num'>141</span>    public function toArray(): array
</div><div class='line not-executable'><span class='num'>142</span>    {
</div><div class='line not-executable'><span class='num'>143</span>        return [
</div><div class='line not-covered'><span class='num'>144</span>            &#039;node_id&#039; =&gt; $this-&gt;nodeId,
</div><div class='line not-covered'><span class='num'>145</span>            &#039;status&#039;  =&gt; $this-&gt;status,
</div><div class='line not-executable'><span class='num'>146</span>        ];
</div><div class='line not-covered'><span class='num'>147</span>    }
</div><div class='line not-executable'><span class='num'>148</span>}
</div><div class='line not-executable'><span class='num'>149</span>
</div><div class='line not-executable'><span class='num'>150</span>final class NodeStatuses
</div><div class='line not-executable'><span class='num'>151</span>{
</div><div class='line not-executable'><span class='num'>152</span>    public array $statuses = [];
</div><div class='line not-executable'><span class='num'>153</span>
</div><div class='line not-executable'><span class='num'>154</span>    public function addStatus(NodeStatus $status): void
</div><div class='line not-executable'><span class='num'>155</span>    {
</div><div class='line not-covered'><span class='num'>156</span>        $this-&gt;statuses[] = $status;
</div><div class='line not-covered'><span class='num'>157</span>    }
</div><div class='line not-executable'><span class='num'>158</span>}
</div><div class='line not-executable'><span class='num'>159</span>
</div><div class='line not-executable'><span class='num'>160</span>final class Nodes
</div><div class='line not-executable'><span class='num'>161</span>{
</div><div class='line not-executable'><span class='num'>162</span>    public array $nodes = [];
</div><div class='line not-executable'><span class='num'>163</span>
</div><div class='line not-executable'><span class='num'>164</span>    public function addNode(Node $node): void
</div><div class='line not-executable'><span class='num'>165</span>    {
</div><div class='line not-covered'><span class='num'>166</span>        $this-&gt;nodes[] = $node;
</div><div class='line not-covered'><span class='num'>167</span>    }
</div><div class='line not-executable'><span class='num'>168</span>}
</div><div class='line not-executable'><span class='num'>169</span>
</div><div class='line not-executable'><span class='num'>170</span>final class Edge
</div><div class='line not-executable'><span class='num'>171</span>{
</div><div class='line not-executable'><span class='num'>172</span>    public ?string $id;
</div><div class='line not-executable'><span class='num'>173</span>    public string $source;
</div><div class='line not-executable'><span class='num'>174</span>    public string $target;
</div><div class='line not-executable'><span class='num'>175</span>    public array $data;
</div><div class='line not-executable'><span class='num'>176</span>
</div><div class='line not-executable'><span class='num'>177</span>    public function __construct(?string $id = null, string $source, string $target, array $data = [])
</div><div class='line not-executable'><span class='num'>178</span>    {
</div><div class='line covered'><span class='num'>179</span>        $this-&gt;id     = $id;
</div><div class='line covered'><span class='num'>180</span>        $this-&gt;source = $source;
</div><div class='line covered'><span class='num'>181</span>        $this-&gt;target = $target;
</div><div class='line covered'><span class='num'>182</span>        $this-&gt;data   = $data;
</div><div class='line covered'><span class='num'>183</span>    }
</div><div class='line not-executable'><span class='num'>184</span>
</div><div class='line not-executable'><span class='num'>185</span>    public function toArray(): array
</div><div class='line not-executable'><span class='num'>186</span>    {
</div><div class='line not-executable'><span class='num'>187</span>        return [
</div><div class='line covered'><span class='num'>188</span>            &#039;id&#039;     =&gt; $this-&gt;id,
</div><div class='line covered'><span class='num'>189</span>            &#039;source&#039; =&gt; $this-&gt;source,
</div><div class='line covered'><span class='num'>190</span>            &#039;target&#039; =&gt; $this-&gt;target,
</div><div class='line covered'><span class='num'>191</span>            &#039;data&#039;   =&gt; $this-&gt;data
</div><div class='line not-executable'><span class='num'>192</span>        ];
</div><div class='line not-covered'><span class='num'>193</span>    }
</div><div class='line not-executable'><span class='num'>194</span>}
</div><div class='line not-executable'><span class='num'>195</span>
</div><div class='line not-executable'><span class='num'>196</span>final class Edges
</div><div class='line not-executable'><span class='num'>197</span>{
</div><div class='line not-executable'><span class='num'>198</span>    public array $edges = [];
</div><div class='line not-executable'><span class='num'>199</span>    public function addEdge(Edge $edge): void
</div><div class='line not-executable'><span class='num'>200</span>    {
</div><div class='line not-covered'><span class='num'>201</span>        $this-&gt;edges[] = $edge;
</div><div class='line not-covered'><span class='num'>202</span>    }
</div><div class='line not-executable'><span class='num'>203</span>}
</div><div class='line not-executable'><span class='num'>204</span>
</div><div class='line not-executable'><span class='num'>205</span>final class AuditLog
</div><div class='line not-executable'><span class='num'>206</span>{
</div><div class='line not-executable'><span class='num'>207</span>    public string $entityType;
</div><div class='line not-executable'><span class='num'>208</span>    public string $entityId;
</div><div class='line not-executable'><span class='num'>209</span>    public string $action;
</div><div class='line not-executable'><span class='num'>210</span>    public ?array $oldData;
</div><div class='line not-executable'><span class='num'>211</span>    public ?array $newData;
</div><div class='line not-executable'><span class='num'>212</span>    public string $userId;
</div><div class='line not-executable'><span class='num'>213</span>    public string $ipAddress;
</div><div class='line not-executable'><span class='num'>214</span>    public string $createdAt;
</div><div class='line not-executable'><span class='num'>215</span>
</div><div class='line not-executable'><span class='num'>216</span>    public function __construct(string $entityType, string $entityId, string $action, ?array $oldData = null, ?array $newData = null)
</div><div class='line not-executable'><span class='num'>217</span>    {
</div><div class='line covered'><span class='num'>218</span>        $this-&gt;entityType = $entityType;
</div><div class='line covered'><span class='num'>219</span>        $this-&gt;entityId   = $entityId;
</div><div class='line covered'><span class='num'>220</span>        $this-&gt;action     = $action;
</div><div class='line covered'><span class='num'>221</span>        $this-&gt;oldData    = $oldData;
</div><div class='line covered'><span class='num'>222</span>        $this-&gt;newData    = $newData;
</div><div class='line covered'><span class='num'>223</span>    }
</div><div class='line not-executable'><span class='num'>224</span>}
</div><div class='line not-executable'><span class='num'>225</span>
</div><div class='line not-executable'><span class='num'>226</span>final class AuditLogs
</div><div class='line not-executable'><span class='num'>227</span>{
</div><div class='line not-executable'><span class='num'>228</span>    public array $logs = [];
</div><div class='line not-executable'><span class='num'>229</span>    public function addLog(AuditLog $log): void
</div><div class='line not-executable'><span class='num'>230</span>    {
</div><div class='line not-covered'><span class='num'>231</span>        $this-&gt;logs[] = $log;
</div><div class='line not-covered'><span class='num'>232</span>    }
</div><div class='line not-executable'><span class='num'>233</span>}
</div><div class='line not-executable'><span class='num'>234</span>
</div><div class='line not-executable'><span class='num'>235</span>final class GraphContext
</div><div class='line not-executable'><span class='num'>236</span>{
</div><div class='line not-executable'><span class='num'>237</span>    public static User $user;
</div><div class='line not-executable'><span class='num'>238</span>}
</div><div class='line not-executable'><span class='num'>239</span>
</div><div class='line not-executable'><span class='num'>240</span>interface LoggerInterface
</div><div class='line not-executable'><span class='num'>241</span>{
</div><div class='line not-executable'><span class='num'>242</span>    public function info(string $message, array $data = []): void;
</div><div class='line not-executable'><span class='num'>243</span>    public function debug(string $message, array $data = []): void;
</div><div class='line not-executable'><span class='num'>244</span>    public function error(string $message, array $data = []): void;
</div><div class='line not-executable'><span class='num'>245</span>}
</div><div class='line not-executable'><span class='num'>246</span>
</div><div class='line not-executable'><span class='num'>247</span>final class Logger implements LoggerInterface
</div><div class='line not-executable'><span class='num'>248</span>{
</div><div class='line not-executable'><span class='num'>249</span>    private string $fileName;
</div><div class='line not-executable'><span class='num'>250</span>    private $fd;
</div><div class='line not-executable'><span class='num'>251</span>
</div><div class='line not-executable'><span class='num'>252</span>    public function __construct($file_name)
</div><div class='line not-executable'><span class='num'>253</span>    {
</div><div class='line covered'><span class='num'>254</span>        $this-&gt;fileName = $file_name;
</div><div class='line covered'><span class='num'>255</span>        $this-&gt;fd = fopen($this-&gt;fileName, &#039;a&#039;);
</div><div class='line covered'><span class='num'>256</span>    }
</div><div class='line not-executable'><span class='num'>257</span>
</div><div class='line not-executable'><span class='num'>258</span>    public function info(string $message, array $data = []): void
</div><div class='line not-executable'><span class='num'>259</span>    {
</div><div class='line covered'><span class='num'>260</span>        $this-&gt;log(&#039;INFO&#039;, $message, $data);
</div><div class='line covered'><span class='num'>261</span>    }
</div><div class='line not-executable'><span class='num'>262</span>
</div><div class='line not-executable'><span class='num'>263</span>    public function debug(string $message, array $data = []): void
</div><div class='line not-executable'><span class='num'>264</span>    {
</div><div class='line covered'><span class='num'>265</span>        $this-&gt;log(&#039;DEBUG&#039;, $message, $data);
</div><div class='line covered'><span class='num'>266</span>    }
</div><div class='line not-executable'><span class='num'>267</span>
</div><div class='line not-executable'><span class='num'>268</span>    public function error(string $message, array $data = []): void
</div><div class='line not-executable'><span class='num'>269</span>    {
</div><div class='line not-covered'><span class='num'>270</span>        $this-&gt;log(&#039;ERROR&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>271</span>    }
</div><div class='line not-executable'><span class='num'>272</span>
</div><div class='line not-executable'><span class='num'>273</span>    private function log(string $type, $message, $data = [])
</div><div class='line not-executable'><span class='num'>274</span>    {
</div><div class='line covered'><span class='num'>275</span>        $trace = debug_backtrace(DEBUG_BACKTRACE_PROVIDE_OBJECT, 3);
</div><div class='line covered'><span class='num'>276</span>        $method = &quot;{$trace[2][&#039;class&#039;]}::{$trace[2][&#039;function&#039;]}&quot;;
</div><div class='line covered'><span class='num'>277</span>        $data = json_encode($data);
</div><div class='line covered'><span class='num'>278</span>        $message = &quot;[{$type}] {$method}: $message ($data)\n&quot;;
</div><div class='line covered'><span class='num'>279</span>        fwrite($this-&gt;fd, $message);
</div><div class='line covered'><span class='num'>280</span>    }
</div><div class='line not-executable'><span class='num'>281</span>}
</div><div class='line not-executable'><span class='num'>282</span>
</div><div class='line not-executable'><span class='num'>283</span>interface GraphDatabaseInterface
</div><div class='line not-executable'><span class='num'>284</span>{
</div><div class='line not-executable'><span class='num'>285</span>    public function getUser(string $id): ?array;
</div><div class='line not-executable'><span class='num'>286</span>    public function insertUser(string $id, string $group): void;
</div><div class='line not-executable'><span class='num'>287</span>    public function updateUser(string $id, string $group): void;
</div><div class='line not-executable'><span class='num'>288</span>
</div><div class='line not-executable'><span class='num'>289</span>    public function getNode(string $id): ?array;
</div><div class='line not-executable'><span class='num'>290</span>    public function getNodes(): array;
</div><div class='line not-executable'><span class='num'>291</span>    public function insertNode(string $id, string $label, string $category, string $type, array $data = []): void;
</div><div class='line not-executable'><span class='num'>292</span>    public function updateNode(string $id, string $label, string $category, string $type, array $data = []): void;
</div><div class='line not-executable'><span class='num'>293</span>    public function deleteNode(string $id): void;
</div><div class='line not-executable'><span class='num'>294</span>
</div><div class='line not-executable'><span class='num'>295</span>    public function getEdge(string $source, string $target): ?array;
</div><div class='line not-executable'><span class='num'>296</span>    public function getEdgeById(string $id): ?array;
</div><div class='line not-executable'><span class='num'>297</span>    public function getEdges(): array;
</div><div class='line not-executable'><span class='num'>298</span>    public function insertEdge(string $id, string $source, string $target, array $data = []): void;
</div><div class='line not-executable'><span class='num'>299</span>    public function updateEdge(string $id, string $source, string $target, array $data = []): void;
</div><div class='line not-executable'><span class='num'>300</span>    public function deleteEdge(string $id): void;
</div><div class='line not-executable'><span class='num'>301</span>
</div><div class='line not-executable'><span class='num'>302</span>    public function getStatuses(): array;
</div><div class='line not-executable'><span class='num'>303</span>    public function getNodeStatus(string $id): ?string;
</div><div class='line not-executable'><span class='num'>304</span>    public function setNodeStatus(string $id, string $status): void;
</div><div class='line not-executable'><span class='num'>305</span>
</div><div class='line not-executable'><span class='num'>306</span>    public function getLogs($limit): array;
</div><div class='line not-executable'><span class='num'>307</span>    public function insertAuditLog(
</div><div class='line not-executable'><span class='num'>308</span>        string $entity_type, 
</div><div class='line not-executable'><span class='num'>309</span>        string $entity_id, 
</div><div class='line not-executable'><span class='num'>310</span>        string $action, 
</div><div class='line not-executable'><span class='num'>311</span>        ?array $old_data = null, 
</div><div class='line not-executable'><span class='num'>312</span>        ?array $new_data = null,
</div><div class='line not-executable'><span class='num'>313</span>        string $user_id,
</div><div class='line not-executable'><span class='num'>314</span>        string $ip_address): bool;
</div><div class='line not-executable'><span class='num'>315</span>}
</div><div class='line not-executable'><span class='num'>316</span>
</div><div class='line not-executable'><span class='num'>317</span>final class DatabaseException extends RuntimeException
</div><div class='line not-executable'><span class='num'>318</span>{
</div><div class='line not-executable'><span class='num'>319</span>    private ?string $query;
</div><div class='line not-executable'><span class='num'>320</span>    private ?array $params;
</div><div class='line not-executable'><span class='num'>321</span>
</div><div class='line not-executable'><span class='num'>322</span>    
</div><div class='line not-executable'><span class='num'>323</span>    public function __construct(string $message = &quot;&quot;,  int $code = 0, ?Throwable $previous = null, ?string $query = null, ?array $params) {
</div><div class='line not-covered'><span class='num'>324</span>        parent::__construct($message, $code, $previous);
</div><div class='line not-covered'><span class='num'>325</span>        $this-&gt;query = $query;
</div><div class='line not-covered'><span class='num'>326</span>        $this-&gt;params = $params;
</div><div class='line not-covered'><span class='num'>327</span>    }
</div><div class='line not-executable'><span class='num'>328</span>}
</div><div class='line not-executable'><span class='num'>329</span>
</div><div class='line not-executable'><span class='num'>330</span>final class GraphDatabase implements GraphDatabaseInterface
</div><div class='line not-executable'><span class='num'>331</span>{
</div><div class='line not-executable'><span class='num'>332</span>    private PDO $pdo;
</div><div class='line not-executable'><span class='num'>333</span>    private Logger $logger;
</div><div class='line not-executable'><span class='num'>334</span>
</div><div class='line not-executable'><span class='num'>335</span>    public function __construct(PDO $pdo, Logger $logger)
</div><div class='line not-executable'><span class='num'>336</span>    {
</div><div class='line covered'><span class='num'>337</span>        $this-&gt;pdo = $pdo;
</div><div class='line covered'><span class='num'>338</span>        $this-&gt;logger = $logger;
</div><div class='line covered'><span class='num'>339</span>        $this-&gt;initSchema();
</div><div class='line covered'><span class='num'>340</span>    }
</div><div class='line not-executable'><span class='num'>341</span>
</div><div class='line not-executable'><span class='num'>342</span>    public function getUser(string $id): ?array
</div><div class='line not-executable'><span class='num'>343</span>    {
</div><div class='line not-covered'><span class='num'>344</span>        $this-&gt;logger-&gt;debug(&quot;getting user id: &#039;{$id}&#039;&quot;);
</div><div class='line not-executable'><span class='num'>345</span>        try {
</div><div class='line not-covered'><span class='num'>346</span>            $sql = &quot;SELECT * FROM users WHERE id = :id&quot;;
</div><div class='line not-covered'><span class='num'>347</span>            $params = [&#039;:id&#039; =&gt; $id];
</div><div class='line not-covered'><span class='num'>348</span>            $stmt = $this-&gt;pdo-&gt;prepare($sql);
</div><div class='line not-covered'><span class='num'>349</span>            $stmt-&gt;execute($params);
</div><div class='line not-covered'><span class='num'>350</span>            $row = $stmt-&gt;fetch();
</div><div class='line not-executable'><span class='num'>351</span>
</div><div class='line not-covered'><span class='num'>352</span>            if ($row) {
</div><div class='line not-covered'><span class='num'>353</span>                return $row;
</div><div class='line not-executable'><span class='num'>354</span>            }
</div><div class='line not-covered'><span class='num'>355</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>356</span>            $e = new DatabaseException(
</div><div class='line not-covered'><span class='num'>357</span>                &quot;GraphDatabase Exception while trying to get user data. ID: {$id}&quot;,
</div><div class='line not-covered'><span class='num'>358</span>                0,
</div><div class='line not-executable'><span class='num'>359</span>                $e,
</div><div class='line not-executable'><span class='num'>360</span>                $sql,
</div><div class='line not-executable'><span class='num'>361</span>                $params
</div><div class='line not-executable'><span class='num'>362</span>            );
</div><div class='line not-executable'><span class='num'>363</span>        }
</div><div class='line not-covered'><span class='num'>364</span>        return null;
</div><div class='line not-covered'><span class='num'>365</span>    }
</div><div class='line not-executable'><span class='num'>366</span>
</div><div class='line not-executable'><span class='num'>367</span>    public function insertUser(string $id, string $group): void
</div><div class='line not-executable'><span class='num'>368</span>    {
</div><div class='line not-executable'><span class='num'>369</span>        try {
</div><div class='line not-covered'><span class='num'>370</span>            $sql = &quot;
</div><div class='line not-executable'><span class='num'>371</span>                INSERT OR IGNORE INTO users 
</div><div class='line not-executable'><span class='num'>372</span>                (id, user_group)
</div><div class='line not-executable'><span class='num'>373</span>                VALUES (:id, :group)&quot;;
</div><div class='line not-executable'><span class='num'>374</span>            
</div><div class='line not-covered'><span class='num'>375</span>            $params = [
</div><div class='line not-covered'><span class='num'>376</span>                &#039;:id&#039;       =&gt; $id,
</div><div class='line not-covered'><span class='num'>377</span>                &#039;:group&#039;    =&gt; $group
</div><div class='line not-executable'><span class='num'>378</span>            ];
</div><div class='line not-executable'><span class='num'>379</span>
</div><div class='line not-covered'><span class='num'>380</span>            $stmt = $this-&gt;pdo-&gt;prepare($sql);
</div><div class='line not-covered'><span class='num'>381</span>            $stmt-&gt;execute($params);
</div><div class='line not-covered'><span class='num'>382</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>383</span>            $e = new DatabaseException(
</div><div class='line not-covered'><span class='num'>384</span>                &quot;GraphDatabase Exception while trying to insert new user. ID: {$id}&quot;,
</div><div class='line not-covered'><span class='num'>385</span>                0,
</div><div class='line not-executable'><span class='num'>386</span>                $e,
</div><div class='line not-executable'><span class='num'>387</span>                $sql,
</div><div class='line not-executable'><span class='num'>388</span>                $params
</div><div class='line not-executable'><span class='num'>389</span>            );
</div><div class='line not-executable'><span class='num'>390</span>        }
</div><div class='line not-covered'><span class='num'>391</span>    }
</div><div class='line not-executable'><span class='num'>392</span>
</div><div class='line not-executable'><span class='num'>393</span>    public function updateUser(string $id, string $group): void
</div><div class='line not-executable'><span class='num'>394</span>    {
</div><div class='line not-executable'><span class='num'>395</span>        try {
</div><div class='line not-covered'><span class='num'>396</span>            $sql = &quot;
</div><div class='line not-executable'><span class='num'>397</span>                UPDATE users
</div><div class='line not-executable'><span class='num'>398</span>                SET    user_group = :group
</div><div class='line not-executable'><span class='num'>399</span>                WHERE  id = :id
</div><div class='line not-executable'><span class='num'>400</span>            &quot;;
</div><div class='line not-executable'><span class='num'>401</span>
</div><div class='line not-covered'><span class='num'>402</span>            $params = [
</div><div class='line not-covered'><span class='num'>403</span>                &#039;:id&#039;       =&gt; $id,
</div><div class='line not-covered'><span class='num'>404</span>                &#039;:group&#039;    =&gt; $group
</div><div class='line not-executable'><span class='num'>405</span>            ];
</div><div class='line not-executable'><span class='num'>406</span>
</div><div class='line not-covered'><span class='num'>407</span>            $stmt = $this-&gt;pdo-&gt;prepare($sql);
</div><div class='line not-executable'><span class='num'>408</span>            
</div><div class='line not-covered'><span class='num'>409</span>            $stmt-&gt;execute($params);
</div><div class='line not-executable'><span class='num'>410</span>
</div><div class='line not-covered'><span class='num'>411</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>412</span>            $e = new DatabaseException(
</div><div class='line not-covered'><span class='num'>413</span>                &quot;GraphDatabase Exception while trying to update user. ID: {$id}&quot;,
</div><div class='line not-covered'><span class='num'>414</span>                0,
</div><div class='line not-executable'><span class='num'>415</span>                $e,
</div><div class='line not-executable'><span class='num'>416</span>                $sql,
</div><div class='line not-executable'><span class='num'>417</span>                $params
</div><div class='line not-executable'><span class='num'>418</span>            );
</div><div class='line not-executable'><span class='num'>419</span>        }
</div><div class='line not-covered'><span class='num'>420</span>    }
</div><div class='line not-executable'><span class='num'>421</span>
</div><div class='line not-executable'><span class='num'>422</span>    public function getNode(string $id): ?array
</div><div class='line not-executable'><span class='num'>423</span>    {
</div><div class='line covered'><span class='num'>424</span>        $this-&gt;logger-&gt;debug(&quot;fetching node &#039;{$id}&#039;&quot;);
</div><div class='line not-executable'><span class='num'>425</span>
</div><div class='line not-executable'><span class='num'>426</span>        try {
</div><div class='line covered'><span class='num'>427</span>            $sql = &quot;SELECT * FROM nodes WHERE id = :id&quot;;
</div><div class='line covered'><span class='num'>428</span>            $params = [&#039;:id&#039; =&gt; $id];
</div><div class='line covered'><span class='num'>429</span>            $stmt = $this-&gt;pdo-&gt;prepare($sql);
</div><div class='line covered'><span class='num'>430</span>            $stmt-&gt;execute($params);
</div><div class='line covered'><span class='num'>431</span>            $row = $stmt-&gt;fetch();
</div><div class='line covered'><span class='num'>432</span>            if ($row) {
</div><div class='line covered'><span class='num'>433</span>                return $row;
</div><div class='line not-executable'><span class='num'>434</span>            }
</div><div class='line not-covered'><span class='num'>435</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>436</span>            $this-&gt;logger-&gt;error(&quot;exception with node id &#039;{$id}&#039;&quot;);
</div><div class='line not-covered'><span class='num'>437</span>            throw new DatabaseException(&quot;could not get node data with id &#039;{$id}&#039;&quot;, 0, $e, $sql, $params);
</div><div class='line not-executable'><span class='num'>438</span>        }
</div><div class='line not-covered'><span class='num'>439</span>        return null;
</div><div class='line not-covered'><span class='num'>440</span>    }
</div><div class='line not-executable'><span class='num'>441</span>
</div><div class='line not-executable'><span class='num'>442</span>    public function getNodes(): array
</div><div class='line not-executable'><span class='num'>443</span>    {
</div><div class='line not-executable'><span class='num'>444</span>        try {
</div><div class='line not-covered'><span class='num'>445</span>            $stmt = $this-&gt;pdo-&gt;query(&quot;SELECT * FROM nodes&quot;);
</div><div class='line not-covered'><span class='num'>446</span>            $rows = $stmt-&gt;fetchAll();
</div><div class='line not-covered'><span class='num'>447</span>            return $rows;
</div><div class='line not-covered'><span class='num'>448</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>449</span>            error_log(&quot;GraphDatabase fetch all nodes failed: &quot; . $e-&gt;getMessage());
</div><div class='line not-covered'><span class='num'>450</span>            return [];
</div><div class='line not-executable'><span class='num'>451</span>        }
</div><div class='line not-covered'><span class='num'>452</span>    }
</div><div class='line not-executable'><span class='num'>453</span>
</div><div class='line not-executable'><span class='num'>454</span>    public function insertNode(string $id, string $label, string $category, string $type, array $data = []): void
</div><div class='line not-executable'><span class='num'>455</span>    {
</div><div class='line not-executable'><span class='num'>456</span>        try {
</div><div class='line covered'><span class='num'>457</span>            $sql = &quot;
</div><div class='line not-executable'><span class='num'>458</span>                INSERT OR IGNORE INTO nodes 
</div><div class='line not-executable'><span class='num'>459</span>                (id, label, category, type, data) 
</div><div class='line not-executable'><span class='num'>460</span>                VALUES (:id, :label, :category, :type, :data)&quot;;
</div><div class='line covered'><span class='num'>461</span>            $stmt             = $this-&gt;pdo-&gt;prepare($sql);
</div><div class='line covered'><span class='num'>462</span>            $data[&#039;id&#039;]       = $id;
</div><div class='line covered'><span class='num'>463</span>            $data[&#039;label&#039;]    = $label;
</div><div class='line covered'><span class='num'>464</span>            $data[&#039;category&#039;] = $category;
</div><div class='line covered'><span class='num'>465</span>            $data[&#039;type&#039;]     = $type;
</div><div class='line covered'><span class='num'>466</span>            $stmt-&gt;execute([
</div><div class='line covered'><span class='num'>467</span>                &#039;:id&#039;       =&gt; $id,
</div><div class='line covered'><span class='num'>468</span>                &#039;:label&#039;    =&gt; $label,
</div><div class='line covered'><span class='num'>469</span>                &#039;:category&#039; =&gt; $category,
</div><div class='line covered'><span class='num'>470</span>                &#039;:type&#039;     =&gt; $type,
</div><div class='line covered'><span class='num'>471</span>                &#039;:data&#039;     =&gt; json_encode($data, JSON_UNESCAPED_UNICODE)
</div><div class='line not-executable'><span class='num'>472</span>            ]);
</div><div class='line not-covered'><span class='num'>473</span>        } catch (PDOException $e) {
</div><div class='line not-executable'><span class='num'>474</span>            // TODO
</div><div class='line not-executable'><span class='num'>475</span>        }
</div><div class='line covered'><span class='num'>476</span>    }
</div><div class='line not-executable'><span class='num'>477</span>
</div><div class='line not-executable'><span class='num'>478</span>    public function updateNode(string $id, string $label, string $category, string $type, array $data = []): void
</div><div class='line not-executable'><span class='num'>479</span>    {
</div><div class='line not-executable'><span class='num'>480</span>        try {
</div><div class='line not-covered'><span class='num'>481</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-executable'><span class='num'>482</span>                UPDATE nodes
</div><div class='line not-executable'><span class='num'>483</span>                SET    label = :label, 
</div><div class='line not-executable'><span class='num'>484</span>                       category = :category, 
</div><div class='line not-executable'><span class='num'>485</span>                       type = :type, 
</div><div class='line not-executable'><span class='num'>486</span>                       data = :data
</div><div class='line not-executable'><span class='num'>487</span>                WHERE  id = :id&quot;);
</div><div class='line not-covered'><span class='num'>488</span>            $data[&#039;id&#039;]       = $id;
</div><div class='line not-covered'><span class='num'>489</span>            $data[&#039;label&#039;]    = $label;
</div><div class='line not-covered'><span class='num'>490</span>            $data[&#039;category&#039;] = $category;
</div><div class='line not-covered'><span class='num'>491</span>            $data[&#039;type&#039;]     = $type;
</div><div class='line not-executable'><span class='num'>492</span>
</div><div class='line not-covered'><span class='num'>493</span>            $stmt-&gt;execute([
</div><div class='line not-covered'><span class='num'>494</span>                &#039;:id&#039;       =&gt; $id,
</div><div class='line not-covered'><span class='num'>495</span>                &#039;:label&#039;    =&gt; $label,
</div><div class='line not-covered'><span class='num'>496</span>                &#039;:category&#039; =&gt; $category,
</div><div class='line not-covered'><span class='num'>497</span>                &#039;:type&#039;     =&gt; $type,
</div><div class='line not-covered'><span class='num'>498</span>                &#039;:data&#039;     =&gt; json_encode($data, JSON_UNESCAPED_UNICODE)
</div><div class='line not-executable'><span class='num'>499</span>            ]);
</div><div class='line not-covered'><span class='num'>500</span>        } catch (PDOException $e) {
</div><div class='line not-executable'><span class='num'>501</span>            // TODO
</div><div class='line not-executable'><span class='num'>502</span>        }
</div><div class='line not-covered'><span class='num'>503</span>    }
</div><div class='line not-executable'><span class='num'>504</span>
</div><div class='line not-executable'><span class='num'>505</span>    public function deleteNode(string $id): void
</div><div class='line not-executable'><span class='num'>506</span>    {
</div><div class='line not-executable'><span class='num'>507</span>        try {
</div><div class='line not-covered'><span class='num'>508</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;DELETE FROM nodes WHERE id = :id&quot;);
</div><div class='line not-covered'><span class='num'>509</span>            $stmt-&gt;execute([&#039;:id&#039; =&gt; $id]);
</div><div class='line not-covered'><span class='num'>510</span>        } catch (PDOException $e) {
</div><div class='line not-executable'><span class='num'>511</span>            // TODO
</div><div class='line not-executable'><span class='num'>512</span>        }
</div><div class='line not-covered'><span class='num'>513</span>    }
</div><div class='line not-executable'><span class='num'>514</span>
</div><div class='line not-executable'><span class='num'>515</span>    public function getEdge(string $source, string $target): ?array
</div><div class='line not-executable'><span class='num'>516</span>    {
</div><div class='line not-executable'><span class='num'>517</span>        try {
</div><div class='line covered'><span class='num'>518</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-executable'><span class='num'>519</span>                SELECT * FROM edges
</div><div class='line not-executable'><span class='num'>520</span>                WHERE source = :source AND target = :target
</div><div class='line not-executable'><span class='num'>521</span>            &quot;);
</div><div class='line covered'><span class='num'>522</span>            $stmt-&gt;execute([
</div><div class='line covered'><span class='num'>523</span>                &#039;:source&#039; =&gt; $source,
</div><div class='line covered'><span class='num'>524</span>                &#039;:target&#039; =&gt; $target
</div><div class='line not-executable'><span class='num'>525</span>            ]);
</div><div class='line covered'><span class='num'>526</span>            $row = $stmt-&gt;fetch();
</div><div class='line covered'><span class='num'>527</span>            if ($row) {
</div><div class='line covered'><span class='num'>528</span>                return $row;
</div><div class='line not-executable'><span class='num'>529</span>            }
</div><div class='line not-covered'><span class='num'>530</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>531</span>            error_log(&quot;GraphDatabase edge exists check failed: &quot; . $e-&gt;getMessage());
</div><div class='line not-executable'><span class='num'>532</span>        }
</div><div class='line covered'><span class='num'>533</span>        return null;
</div><div class='line not-covered'><span class='num'>534</span>    }
</div><div class='line not-executable'><span class='num'>535</span>
</div><div class='line not-executable'><span class='num'>536</span>    public function getEdgeById(string $id): ?array
</div><div class='line not-executable'><span class='num'>537</span>    {
</div><div class='line not-executable'><span class='num'>538</span>        try {
</div><div class='line not-covered'><span class='num'>539</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-executable'><span class='num'>540</span>                SELECT * FROM edges
</div><div class='line not-executable'><span class='num'>541</span>                WHERE id = :id
</div><div class='line not-executable'><span class='num'>542</span>            &quot;);
</div><div class='line not-covered'><span class='num'>543</span>            $stmt-&gt;execute([
</div><div class='line not-covered'><span class='num'>544</span>                &#039;:id&#039; =&gt; $id,
</div><div class='line not-executable'><span class='num'>545</span>            ]);
</div><div class='line not-covered'><span class='num'>546</span>            $row = $stmt-&gt;fetch();
</div><div class='line not-covered'><span class='num'>547</span>            if ($row) {
</div><div class='line not-covered'><span class='num'>548</span>                return $row;
</div><div class='line not-executable'><span class='num'>549</span>            }
</div><div class='line not-covered'><span class='num'>550</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>551</span>            error_log(&quot;GraphDatabase edge exists check failed: &quot; . $e-&gt;getMessage());
</div><div class='line not-executable'><span class='num'>552</span>        }
</div><div class='line not-covered'><span class='num'>553</span>        return null;
</div><div class='line not-covered'><span class='num'>554</span>    }
</div><div class='line not-executable'><span class='num'>555</span>
</div><div class='line not-executable'><span class='num'>556</span>    public function getEdges(): array
</div><div class='line not-executable'><span class='num'>557</span>    {
</div><div class='line not-executable'><span class='num'>558</span>        try {
</div><div class='line not-covered'><span class='num'>559</span>            $stmt  = $this-&gt;pdo-&gt;query(&quot;SELECT * FROM edges&quot;);
</div><div class='line not-covered'><span class='num'>560</span>            $rows  = $stmt-&gt;fetchAll();
</div><div class='line not-covered'><span class='num'>561</span>            return $rows;
</div><div class='line not-covered'><span class='num'>562</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>563</span>            error_log(&quot;GraphDatabase fetch all edges failed: &quot; . $e-&gt;getMessage());
</div><div class='line not-covered'><span class='num'>564</span>            return [];
</div><div class='line not-executable'><span class='num'>565</span>        }
</div><div class='line not-covered'><span class='num'>566</span>    }
</div><div class='line not-executable'><span class='num'>567</span>
</div><div class='line not-executable'><span class='num'>568</span>    public function insertEdge(string $id, string $source, string $target, array $data = []): void
</div><div class='line not-executable'><span class='num'>569</span>    {
</div><div class='line not-executable'><span class='num'>570</span>        // verify if the inverse edge exists
</div><div class='line covered'><span class='num'>571</span>        $r = $this-&gt;getEdge($target, $source);
</div><div class='line not-executable'><span class='num'>572</span>        
</div><div class='line not-executable'><span class='num'>573</span>        try {
</div><div class='line covered'><span class='num'>574</span>            $sql = &quot;
</div><div class='line not-executable'><span class='num'>575</span>                INSERT OR IGNORE INTO edges
</div><div class='line not-executable'><span class='num'>576</span>                (id, source, target, data)
</div><div class='line not-executable'><span class='num'>577</span>                VALUES (:id, :source, :target, :data)&quot;;
</div><div class='line covered'><span class='num'>578</span>            $stmt           = $this-&gt;pdo-&gt;prepare($sql);
</div><div class='line covered'><span class='num'>579</span>            $data[&#039;id&#039;]     = $id;
</div><div class='line covered'><span class='num'>580</span>            $data[&#039;source&#039;] = $source;
</div><div class='line covered'><span class='num'>581</span>            $data[&#039;target&#039;] = $target;
</div><div class='line covered'><span class='num'>582</span>            $stmt-&gt;execute([
</div><div class='line covered'><span class='num'>583</span>                &#039;:id&#039;     =&gt; $id,
</div><div class='line covered'><span class='num'>584</span>                &#039;:source&#039; =&gt; $source,
</div><div class='line covered'><span class='num'>585</span>                &#039;:target&#039; =&gt; $target,
</div><div class='line covered'><span class='num'>586</span>                &#039;:data&#039;   =&gt; json_encode($data, JSON_UNESCAPED_UNICODE)
</div><div class='line not-executable'><span class='num'>587</span>            ]);
</div><div class='line covered'><span class='num'>588</span>        } catch (PDOException $e) {
</div><div class='line not-executable'><span class='num'>589</span>            // TODO
</div><div class='line not-executable'><span class='num'>590</span>        }
</div><div class='line covered'><span class='num'>591</span>    }
</div><div class='line not-executable'><span class='num'>592</span>
</div><div class='line not-executable'><span class='num'>593</span>    public function updateEdge(string $id, string $source, string $target, array $data = []): void
</div><div class='line not-executable'><span class='num'>594</span>    {
</div><div class='line not-executable'><span class='num'>595</span>        try {
</div><div class='line not-covered'><span class='num'>596</span>            $data[&#039;id&#039;]     = $id;
</div><div class='line not-covered'><span class='num'>597</span>            $data[&#039;source&#039;] = $source;
</div><div class='line not-covered'><span class='num'>598</span>            $data[&#039;target&#039;] = $target;
</div><div class='line not-executable'><span class='num'>599</span>
</div><div class='line not-covered'><span class='num'>600</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-executable'><span class='num'>601</span>                UPDATE edges
</div><div class='line not-executable'><span class='num'>602</span>                SET data = :data
</div><div class='line not-executable'><span class='num'>603</span>                WHERE id = :id&quot;);
</div><div class='line not-covered'><span class='num'>604</span>            $stmt-&gt;execute([
</div><div class='line not-covered'><span class='num'>605</span>                &#039;:id&#039;   =&gt; $id,
</div><div class='line not-covered'><span class='num'>606</span>                &#039;:data&#039; =&gt; json_encode($data, JSON_UNESCAPED_UNICODE)
</div><div class='line not-executable'><span class='num'>607</span>            ]);
</div><div class='line not-covered'><span class='num'>608</span>        } catch (PDOException $e) {
</div><div class='line not-executable'><span class='num'>609</span>            // TODO
</div><div class='line not-executable'><span class='num'>610</span>        }
</div><div class='line not-covered'><span class='num'>611</span>    }
</div><div class='line not-executable'><span class='num'>612</span>
</div><div class='line not-executable'><span class='num'>613</span>    public function deleteEdge(string $id): void
</div><div class='line not-executable'><span class='num'>614</span>    {
</div><div class='line not-executable'><span class='num'>615</span>        try {
</div><div class='line not-covered'><span class='num'>616</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;DELETE FROM edges WHERE id = :id&quot;);
</div><div class='line not-covered'><span class='num'>617</span>            $stmt-&gt;execute([&#039;:id&#039; =&gt; $id]);
</div><div class='line not-covered'><span class='num'>618</span>        } catch (PDOException $e) {
</div><div class='line not-executable'><span class='num'>619</span>            // TODO
</div><div class='line not-executable'><span class='num'>620</span>        }
</div><div class='line not-covered'><span class='num'>621</span>    }
</div><div class='line not-executable'><span class='num'>622</span>
</div><div class='line not-executable'><span class='num'>623</span>    public function getStatuses(): array
</div><div class='line not-executable'><span class='num'>624</span>    {
</div><div class='line not-covered'><span class='num'>625</span>        $stmt   = $this-&gt;pdo-&gt;query(&quot;
</div><div class='line not-executable'><span class='num'>626</span>            SELECT n.id,
</div><div class='line not-executable'><span class='num'>627</span>                   s.status
</div><div class='line not-executable'><span class='num'>628</span>            FROM   nodes n
</div><div class='line not-executable'><span class='num'>629</span>            LEFT JOIN status s ON n.id = s.node_id&quot;);
</div><div class='line not-covered'><span class='num'>630</span>        $status = $stmt-&gt;fetchAll();
</div><div class='line not-covered'><span class='num'>631</span>        return $status;
</div><div class='line not-covered'><span class='num'>632</span>    }
</div><div class='line not-executable'><span class='num'>633</span>
</div><div class='line not-executable'><span class='num'>634</span>    public function getNodeStatus(string $id): ?string
</div><div class='line not-executable'><span class='num'>635</span>    {
</div><div class='line not-covered'><span class='num'>636</span>        $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-executable'><span class='num'>637</span>            SELECT s.status
</div><div class='line not-executable'><span class='num'>638</span>            FROM nodes n
</div><div class='line not-executable'><span class='num'>639</span>            LEFT JOIN status s
</div><div class='line not-executable'><span class='num'>640</span>            ON n.id = s.node_id
</div><div class='line not-executable'><span class='num'>641</span>            WHERE n.id = ?&quot;);
</div><div class='line not-covered'><span class='num'>642</span>        $stmt-&gt;execute([$id]);
</div><div class='line not-covered'><span class='num'>643</span>        $status = $stmt-&gt;fetch();
</div><div class='line not-covered'><span class='num'>644</span>        return $status ? $status[&#039;status&#039;] : null;
</div><div class='line not-covered'><span class='num'>645</span>    }
</div><div class='line not-executable'><span class='num'>646</span>
</div><div class='line not-executable'><span class='num'>647</span>    public function setNodeStatus(string $id, string $status): void
</div><div class='line not-executable'><span class='num'>648</span>    {
</div><div class='line not-covered'><span class='num'>649</span>        $stmt = $this-&gt;pdo-&gt;prepare(&quot;REPLACE INTO status (node_id, status) VALUES (?, ?)&quot;);
</div><div class='line not-covered'><span class='num'>650</span>        $stmt-&gt;execute([$id, $status]);
</div><div class='line not-covered'><span class='num'>651</span>    }
</div><div class='line not-executable'><span class='num'>652</span>
</div><div class='line not-executable'><span class='num'>653</span>    public function getLogs($limit): array
</div><div class='line not-executable'><span class='num'>654</span>    {
</div><div class='line not-covered'><span class='num'>655</span>        $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-executable'><span class='num'>656</span>            SELECT *
</div><div class='line not-executable'><span class='num'>657</span>            FROM audit
</div><div class='line not-executable'><span class='num'>658</span>            ORDER BY created_at DESC
</div><div class='line not-executable'><span class='num'>659</span>            LIMIT :limit
</div><div class='line not-executable'><span class='num'>660</span>        &quot;);
</div><div class='line not-covered'><span class='num'>661</span>        $stmt-&gt;bindValue(&#039;:limit&#039;, (int)$limit, PDO::PARAM_INT);
</div><div class='line not-covered'><span class='num'>662</span>        $stmt-&gt;execute();
</div><div class='line not-covered'><span class='num'>663</span>        $rows = $stmt-&gt;fetchAll();
</div><div class='line not-covered'><span class='num'>664</span>        return $rows;
</div><div class='line not-covered'><span class='num'>665</span>    }
</div><div class='line not-executable'><span class='num'>666</span>
</div><div class='line not-executable'><span class='num'>667</span>    public function insertAuditLog(string $entity_type, string $entity_id, string $action, ?array $old_data = null, ?array $new_data = null, string $user_id, string $ip_address): bool
</div><div class='line not-executable'><span class='num'>668</span>    {
</div><div class='line not-executable'><span class='num'>669</span>        try {
</div><div class='line covered'><span class='num'>670</span>            $stmt = $this-&gt;pdo-&gt;prepare(&quot;
</div><div class='line not-executable'><span class='num'>671</span>                INSERT INTO audit (entity_type, entity_id, action, old_data, new_data, user_id, ip_address)
</div><div class='line not-executable'><span class='num'>672</span>                VALUES (:entity_type, :entity_id, :action, :old_data, :new_data, :user_id, :ip_address)
</div><div class='line not-executable'><span class='num'>673</span>            &quot;);
</div><div class='line not-executable'><span class='num'>674</span>
</div><div class='line covered'><span class='num'>675</span>            $stmt-&gt;execute([
</div><div class='line covered'><span class='num'>676</span>                &#039;:entity_type&#039; =&gt; $entity_type,
</div><div class='line covered'><span class='num'>677</span>                &#039;:entity_id&#039;   =&gt; $entity_id,
</div><div class='line covered'><span class='num'>678</span>                &#039;:action&#039;      =&gt; $action,
</div><div class='line not-covered'><span class='num'>679</span>                &#039;:old_data&#039;    =&gt; $old_data !== null ? json_encode($old_data, JSON_UNESCAPED_UNICODE) : null,
</div><div class='line covered'><span class='num'>680</span>                &#039;:new_data&#039;    =&gt; $new_data !== null ? json_encode($new_data, JSON_UNESCAPED_UNICODE) : null,
</div><div class='line covered'><span class='num'>681</span>                &#039;:user_id&#039;     =&gt; $user_id,
</div><div class='line covered'><span class='num'>682</span>                &#039;:ip_address&#039;  =&gt; $ip_address
</div><div class='line not-executable'><span class='num'>683</span>            ]);
</div><div class='line covered'><span class='num'>684</span>            return true;
</div><div class='line not-covered'><span class='num'>685</span>        } catch (PDOException $e) {
</div><div class='line not-covered'><span class='num'>686</span>            error_log(&quot;GraphDatabase audit log insert failed: &quot; . $e-&gt;getMessage());
</div><div class='line not-covered'><span class='num'>687</span>            return false;
</div><div class='line not-executable'><span class='num'>688</span>        }
</div><div class='line not-covered'><span class='num'>689</span>    }
</div><div class='line not-executable'><span class='num'>690</span>
</div><div class='line not-executable'><span class='num'>691</span>    private function initSchema(): void
</div><div class='line not-executable'><span class='num'>692</span>    {
</div><div class='line covered'><span class='num'>693</span>        $this-&gt;pdo-&gt;exec(&quot;
</div><div class='line not-executable'><span class='num'>694</span>            CREATE TABLE IF NOT EXISTS users (
</div><div class='line not-executable'><span class='num'>695</span>                id TEXT PRIMARY KEY,
</div><div class='line not-executable'><span class='num'>696</span>                user_group TEXT NOT NULL
</div><div class='line not-executable'><span class='num'>697</span>            )
</div><div class='line not-executable'><span class='num'>698</span>        &quot;);
</div><div class='line not-executable'><span class='num'>699</span>
</div><div class='line covered'><span class='num'>700</span>        $this-&gt;pdo-&gt;exec(&quot;INSERT INTO users VALUES(&#039;admin&#039;, &#039;admin&#039;)&quot;);
</div><div class='line not-executable'><span class='num'>701</span>
</div><div class='line covered'><span class='num'>702</span>        $this-&gt;pdo-&gt;exec(&quot;
</div><div class='line not-executable'><span class='num'>703</span>            CREATE TABLE IF NOT EXISTS nodes (
</div><div class='line not-executable'><span class='num'>704</span>                id TEXT PRIMARY KEY,
</div><div class='line not-executable'><span class='num'>705</span>                label TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>706</span>                category TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>707</span>                type TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>708</span>                data TEXT NOT NULL
</div><div class='line not-executable'><span class='num'>709</span>            )
</div><div class='line not-executable'><span class='num'>710</span>        &quot;);
</div><div class='line not-executable'><span class='num'>711</span>
</div><div class='line covered'><span class='num'>712</span>        $this-&gt;pdo-&gt;exec(&quot;
</div><div class='line not-executable'><span class='num'>713</span>            CREATE TABLE IF NOT EXISTS edges (
</div><div class='line not-executable'><span class='num'>714</span>                id TEXT PRIMARY KEY,
</div><div class='line not-executable'><span class='num'>715</span>                source TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>716</span>                target TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>717</span>                data TEXT,
</div><div class='line not-executable'><span class='num'>718</span>                FOREIGN KEY (source) REFERENCES nodes(id) ON DELETE CASCADE,
</div><div class='line not-executable'><span class='num'>719</span>                FOREIGN KEY (target) REFERENCES nodes(id) ON DELETE CASCADE
</div><div class='line not-executable'><span class='num'>720</span>            )
</div><div class='line not-executable'><span class='num'>721</span>        &quot;);
</div><div class='line not-executable'><span class='num'>722</span>
</div><div class='line covered'><span class='num'>723</span>        $this-&gt;pdo-&gt;exec(&quot;CREATE UNIQUE INDEX IF NOT EXISTS idx_edges_source_target ON edges (source, target)&quot;);
</div><div class='line not-executable'><span class='num'>724</span>
</div><div class='line covered'><span class='num'>725</span>        $this-&gt;pdo-&gt;exec(&quot;
</div><div class='line not-executable'><span class='num'>726</span>            CREATE TABLE IF NOT EXISTS status (
</div><div class='line not-executable'><span class='num'>727</span>                node_id TEXT PRIMARY KEY NOT NULL,
</div><div class='line not-executable'><span class='num'>728</span>                status TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>729</span>                created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
</div><div class='line not-executable'><span class='num'>730</span>                FOREIGN KEY (node_id) REFERENCES nodes(id) ON DELETE CASCADE
</div><div class='line not-executable'><span class='num'>731</span>            )
</div><div class='line not-executable'><span class='num'>732</span>        &quot;);
</div><div class='line not-executable'><span class='num'>733</span>
</div><div class='line covered'><span class='num'>734</span>        $this-&gt;pdo-&gt;exec(&quot;CREATE INDEX IF NOT EXISTS idx_node_status_node_id ON status (node_id)&quot;);
</div><div class='line not-executable'><span class='num'>735</span>
</div><div class='line covered'><span class='num'>736</span>        $this-&gt;pdo-&gt;exec(&quot;
</div><div class='line not-executable'><span class='num'>737</span>            CREATE TABLE IF NOT EXISTS audit (
</div><div class='line not-executable'><span class='num'>738</span>                id INTEGER PRIMARY KEY AUTOINCREMENT,
</div><div class='line not-executable'><span class='num'>739</span>                entity_type TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>740</span>                entity_id TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>741</span>                action TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>742</span>                old_data TEXT,
</div><div class='line not-executable'><span class='num'>743</span>                new_data TEXT,
</div><div class='line not-executable'><span class='num'>744</span>                user_id TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>745</span>                ip_address TEXT NOT NULL,
</div><div class='line not-executable'><span class='num'>746</span>                created_at DATETIME DEFAULT CURRENT_TIMESTAMP
</div><div class='line not-executable'><span class='num'>747</span>            )
</div><div class='line not-executable'><span class='num'>748</span>        &quot;);
</div><div class='line covered'><span class='num'>749</span>    }
</div><div class='line not-executable'><span class='num'>750</span>
</div><div class='line not-executable'><span class='num'>751</span>    public static function createConnection(string $dsn): PDO
</div><div class='line not-executable'><span class='num'>752</span>    {
</div><div class='line covered'><span class='num'>753</span>        $pdo = new PDO($dsn);
</div><div class='line covered'><span class='num'>754</span>        $pdo-&gt;setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
</div><div class='line covered'><span class='num'>755</span>        $pdo-&gt;setAttribute(PDO::ATTR_DEFAULT_FETCH_MODE, PDO::FETCH_ASSOC);
</div><div class='line covered'><span class='num'>756</span>        $pdo-&gt;exec(&#039;PRAGMA foreign_keys = ON&#039;);
</div><div class='line covered'><span class='num'>757</span>        return $pdo;
</div><div class='line not-covered'><span class='num'>758</span>    }
</div><div class='line not-executable'><span class='num'>759</span>}
</div><div class='line not-executable'><span class='num'>760</span>
</div><div class='line not-executable'><span class='num'>761</span>final class GraphServiceException extends RuntimeException
</div><div class='line not-executable'><span class='num'>762</span>{
</div><div class='line not-executable'><span class='num'>763</span>}
</div><div class='line not-executable'><span class='num'>764</span>
</div><div class='line not-executable'><span class='num'>765</span>interface GraphServiceInterface
</div><div class='line not-executable'><span class='num'>766</span>{
</div><div class='line not-executable'><span class='num'>767</span>    public function getUser(string $id): ?User;
</div><div class='line not-executable'><span class='num'>768</span>    public function insertUser(User $user): void;
</div><div class='line not-executable'><span class='num'>769</span>    public function updateUser(User $user): void;
</div><div class='line not-executable'><span class='num'>770</span>
</div><div class='line not-executable'><span class='num'>771</span>    public function getGraph(): Graph;
</div><div class='line not-executable'><span class='num'>772</span>
</div><div class='line not-executable'><span class='num'>773</span>    public function getNode(string $id): ?Node;
</div><div class='line not-executable'><span class='num'>774</span>    public function getNodes(): Nodes;
</div><div class='line not-executable'><span class='num'>775</span>    public function insertNode(Node $node): void;
</div><div class='line not-executable'><span class='num'>776</span>    public function updateNode(Node $node): void;
</div><div class='line not-executable'><span class='num'>777</span>    public function deleteNode(string $id): void;
</div><div class='line not-executable'><span class='num'>778</span>
</div><div class='line not-executable'><span class='num'>779</span>    public function getEdge(string $source, string $target): ?Edge;
</div><div class='line not-executable'><span class='num'>780</span>    public function getEdges(): Edges;
</div><div class='line not-executable'><span class='num'>781</span>    public function insertEdge(Edge $edge): void;
</div><div class='line not-executable'><span class='num'>782</span>    public function updateEdge(Edge $edge): void;
</div><div class='line not-executable'><span class='num'>783</span>    public function deleteEdge(string $id): void;
</div><div class='line not-executable'><span class='num'>784</span>
</div><div class='line not-executable'><span class='num'>785</span>    public function getStatuses(): NodeStatuses;
</div><div class='line not-executable'><span class='num'>786</span>    public function getNodeStatus(string $id): NodeStatus;
</div><div class='line not-executable'><span class='num'>787</span>    public function setNodeStatus(NodeStatus $status): void;
</div><div class='line not-executable'><span class='num'>788</span>
</div><div class='line not-executable'><span class='num'>789</span>    public function getLogs($limit): AuditLogs;
</div><div class='line not-executable'><span class='num'>790</span>}
</div><div class='line not-executable'><span class='num'>791</span>
</div><div class='line not-executable'><span class='num'>792</span>final class GraphService implements GraphServiceInterface
</div><div class='line not-executable'><span class='num'>793</span>{
</div><div class='line not-executable'><span class='num'>794</span>    private const SECURE_ACTIONS = [
</div><div class='line not-executable'><span class='num'>795</span>        &#039;GraphService::getGraph&#039;      =&gt; true,
</div><div class='line not-executable'><span class='num'>796</span>        &#039;GraphService::getNode&#039;       =&gt; true,
</div><div class='line not-executable'><span class='num'>797</span>        &#039;GraphService::getNodes&#039;      =&gt; true,
</div><div class='line not-executable'><span class='num'>798</span>        &#039;GraphService::getEdge&#039;       =&gt; true,
</div><div class='line not-executable'><span class='num'>799</span>        &#039;GraphService::getEdges&#039;      =&gt; true,
</div><div class='line not-executable'><span class='num'>800</span>        &#039;GraphService::getStatuses&#039;   =&gt; true,
</div><div class='line not-executable'><span class='num'>801</span>        &#039;GraphService::getNodeStatus&#039; =&gt; true,
</div><div class='line not-executable'><span class='num'>802</span>        &#039;GraphService::setNodeStatus&#039; =&gt; true,
</div><div class='line not-executable'><span class='num'>803</span>        &#039;GraphService::getLogs&#039;       =&gt; true,
</div><div class='line not-executable'><span class='num'>804</span>        &#039;GraphService::insertNode&#039;    =&gt; false,
</div><div class='line not-executable'><span class='num'>805</span>        &#039;GraphService::updateNode&#039;    =&gt; false,
</div><div class='line not-executable'><span class='num'>806</span>        &#039;GraphService::deleteNode&#039;    =&gt; false,
</div><div class='line not-executable'><span class='num'>807</span>        &#039;GraphService::insertEdge&#039;    =&gt; false,
</div><div class='line not-executable'><span class='num'>808</span>        &#039;GraphService::updateEdge&#039;    =&gt; false,
</div><div class='line not-executable'><span class='num'>809</span>        &#039;GraphService::deleteEdge&#039;    =&gt; false,
</div><div class='line not-executable'><span class='num'>810</span>
</div><div class='line not-executable'><span class='num'>811</span>        &#039;GraphService::insertAuditLog&#039; =&gt; false,
</div><div class='line not-executable'><span class='num'>812</span>    ];
</div><div class='line not-executable'><span class='num'>813</span>
</div><div class='line not-executable'><span class='num'>814</span>    private GraphDatabaseInterface $db;
</div><div class='line not-executable'><span class='num'>815</span>    private Logger $logger;
</div><div class='line not-executable'><span class='num'>816</span>
</div><div class='line not-executable'><span class='num'>817</span>    public function __construct(GraphDatabaseInterface $db, Logger $logger)
</div><div class='line not-executable'><span class='num'>818</span>    {
</div><div class='line covered'><span class='num'>819</span>        $this-&gt;db = $db;
</div><div class='line covered'><span class='num'>820</span>        $this-&gt;logger = $logger;
</div><div class='line covered'><span class='num'>821</span>    }
</div><div class='line not-executable'><span class='num'>822</span>
</div><div class='line not-executable'><span class='num'>823</span>    public function getUser(string $id): ?User
</div><div class='line not-executable'><span class='num'>824</span>    {
</div><div class='line not-covered'><span class='num'>825</span>        $data = $this-&gt;db-&gt;getUser($id);
</div><div class='line not-covered'><span class='num'>826</span>        if ($data) {
</div><div class='line not-covered'><span class='num'>827</span>            $user = new User($id, null, $data[&#039;user_group&#039;]);
</div><div class='line not-covered'><span class='num'>828</span>            return $user;
</div><div class='line not-executable'><span class='num'>829</span>        }
</div><div class='line not-covered'><span class='num'>830</span>        return null;
</div><div class='line not-covered'><span class='num'>831</span>    }
</div><div class='line not-executable'><span class='num'>832</span>
</div><div class='line not-executable'><span class='num'>833</span>    public function insertUser(User $user): void
</div><div class='line not-executable'><span class='num'>834</span>    {
</div><div class='line not-covered'><span class='num'>835</span>        $this-&gt;db-&gt;insertUser($user-&gt;id, $user-&gt;group-&gt;id);
</div><div class='line not-covered'><span class='num'>836</span>    }
</div><div class='line not-executable'><span class='num'>837</span>
</div><div class='line not-executable'><span class='num'>838</span>    public function updateUser(User $user): void
</div><div class='line not-executable'><span class='num'>839</span>    {
</div><div class='line not-covered'><span class='num'>840</span>        $this-&gt;db-&gt;updateUser($user-&gt;id, $user-&gt;group-&gt;id);
</div><div class='line not-covered'><span class='num'>841</span>    }
</div><div class='line not-executable'><span class='num'>842</span>
</div><div class='line not-executable'><span class='num'>843</span>    public function getGraph(): Graph
</div><div class='line not-executable'><span class='num'>844</span>    {
</div><div class='line not-covered'><span class='num'>845</span>        $nodes = $this-&gt;getNodes()-&gt;nodes;
</div><div class='line not-covered'><span class='num'>846</span>        $edges = $this-&gt;getEdges()-&gt;edges;
</div><div class='line not-covered'><span class='num'>847</span>        return new Graph($nodes, $edges);
</div><div class='line not-covered'><span class='num'>848</span>    }
</div><div class='line not-executable'><span class='num'>849</span>
</div><div class='line not-executable'><span class='num'>850</span>    public function getNode(string $id): ?Node
</div><div class='line not-executable'><span class='num'>851</span>    {
</div><div class='line covered'><span class='num'>852</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>853</span>            throw new RuntimeException(&quot;Permission denied to get node.&quot;);
</div><div class='line not-executable'><span class='num'>854</span>        }
</div><div class='line not-executable'><span class='num'>855</span>
</div><div class='line covered'><span class='num'>856</span>        $data = $this-&gt;db-&gt;getNode($id);
</div><div class='line covered'><span class='num'>857</span>        if ($data) {
</div><div class='line covered'><span class='num'>858</span>            return new Node(
</div><div class='line covered'><span class='num'>859</span>                $data[&#039;id&#039;],
</div><div class='line covered'><span class='num'>860</span>                $data[&#039;label&#039;],
</div><div class='line covered'><span class='num'>861</span>                $data[&#039;category&#039;],
</div><div class='line covered'><span class='num'>862</span>                $data[&#039;type&#039;],
</div><div class='line covered'><span class='num'>863</span>                json_decode($data[&#039;data&#039;], true)
</div><div class='line not-executable'><span class='num'>864</span>            );
</div><div class='line not-executable'><span class='num'>865</span>        }
</div><div class='line not-covered'><span class='num'>866</span>        return null;
</div><div class='line not-covered'><span class='num'>867</span>    }
</div><div class='line not-executable'><span class='num'>868</span>
</div><div class='line not-executable'><span class='num'>869</span>    public function getNodes(): Nodes
</div><div class='line not-executable'><span class='num'>870</span>    {
</div><div class='line not-covered'><span class='num'>871</span>        if(! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>872</span>            throw new RuntimeException(&quot;Permission denied to get nodes.&quot;);
</div><div class='line not-executable'><span class='num'>873</span>        }
</div><div class='line not-executable'><span class='num'>874</span>
</div><div class='line not-covered'><span class='num'>875</span>        $nodesData = $this-&gt;db-&gt;getNodes();
</div><div class='line not-covered'><span class='num'>876</span>        $nodes     = new Nodes();
</div><div class='line not-covered'><span class='num'>877</span>        foreach ($nodesData as $data) {
</div><div class='line not-covered'><span class='num'>878</span>            $node = new Node(
</div><div class='line not-covered'><span class='num'>879</span>                $data[&#039;id&#039;],
</div><div class='line not-covered'><span class='num'>880</span>                $data[&#039;label&#039;],
</div><div class='line not-covered'><span class='num'>881</span>                $data[&#039;category&#039;],
</div><div class='line not-covered'><span class='num'>882</span>                $data[&#039;type&#039;],
</div><div class='line not-covered'><span class='num'>883</span>                json_decode($data[&#039;data&#039;], true)
</div><div class='line not-executable'><span class='num'>884</span>            );
</div><div class='line not-covered'><span class='num'>885</span>            $nodes-&gt;addNode($node);
</div><div class='line not-executable'><span class='num'>886</span>        }
</div><div class='line not-covered'><span class='num'>887</span>        return $nodes;
</div><div class='line not-covered'><span class='num'>888</span>    }
</div><div class='line not-executable'><span class='num'>889</span>
</div><div class='line not-executable'><span class='num'>890</span>    public function insertNode(Node $node): void
</div><div class='line not-executable'><span class='num'>891</span>    {
</div><div class='line covered'><span class='num'>892</span>        $this-&gt;logger-&gt;debug(&#039;inserting node&#039;, $node-&gt;toArray());
</div><div class='line not-executable'><span class='num'>893</span>
</div><div class='line covered'><span class='num'>894</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>895</span>            $this-&gt;logger-&gt;info(&#039;permission denied&#039;, $node-&gt;toArray());
</div><div class='line not-covered'><span class='num'>896</span>            throw new GraphServiceException(&#039;permission denied&#039;);
</div><div class='line not-executable'><span class='num'>897</span>        }
</div><div class='line not-executable'><span class='num'>898</span>
</div><div class='line covered'><span class='num'>899</span>        $this-&gt;logger-&gt;info(&#039;permission allowed&#039;, $node-&gt;toArray());
</div><div class='line not-executable'><span class='num'>900</span>
</div><div class='line covered'><span class='num'>901</span>        $this-&gt;insertAuditLog(new AuditLog( &#039;node&#039;, $node-&gt;id, &#039;insert&#039;, null, $node-&gt;toArray()));
</div><div class='line not-executable'><span class='num'>902</span>
</div><div class='line covered'><span class='num'>903</span>        $this-&gt;db-&gt;insertNode(
</div><div class='line covered'><span class='num'>904</span>            $node-&gt;id,
</div><div class='line covered'><span class='num'>905</span>            $node-&gt;label,
</div><div class='line covered'><span class='num'>906</span>            $node-&gt;category,
</div><div class='line covered'><span class='num'>907</span>            $node-&gt;type,
</div><div class='line covered'><span class='num'>908</span>            $node-&gt;data
</div><div class='line not-executable'><span class='num'>909</span>        );
</div><div class='line covered'><span class='num'>910</span>    }
</div><div class='line not-executable'><span class='num'>911</span>
</div><div class='line not-executable'><span class='num'>912</span>    public function updateNode(Node $node): void
</div><div class='line not-executable'><span class='num'>913</span>    {
</div><div class='line not-covered'><span class='num'>914</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>915</span>            throw new RuntimeException(&quot;Permission denied to update node.&quot;);
</div><div class='line not-executable'><span class='num'>916</span>        }
</div><div class='line not-executable'><span class='num'>917</span>
</div><div class='line not-covered'><span class='num'>918</span>        $old = $this-&gt;getNode($node-&gt;id);
</div><div class='line not-covered'><span class='num'>919</span>        $this-&gt;insertAuditLog(new AuditLog( &#039;node&#039;, $node-&gt;id, &#039;update&#039;, $old-&gt;toArray(), $node-&gt;toArray()));
</div><div class='line not-executable'><span class='num'>920</span>
</div><div class='line not-covered'><span class='num'>921</span>        $this-&gt;db-&gt;updateNode(
</div><div class='line not-covered'><span class='num'>922</span>            $node-&gt;id,
</div><div class='line not-covered'><span class='num'>923</span>            $node-&gt;label,
</div><div class='line not-covered'><span class='num'>924</span>            $node-&gt;category,
</div><div class='line not-covered'><span class='num'>925</span>            $node-&gt;type,
</div><div class='line not-covered'><span class='num'>926</span>            $node-&gt;data
</div><div class='line not-executable'><span class='num'>927</span>        );
</div><div class='line not-covered'><span class='num'>928</span>    }
</div><div class='line not-executable'><span class='num'>929</span>
</div><div class='line not-executable'><span class='num'>930</span>    public function deleteNode(string $id): void
</div><div class='line not-executable'><span class='num'>931</span>    {
</div><div class='line not-covered'><span class='num'>932</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>933</span>            throw new RuntimeException(&quot;Permission denied to delete node.&quot;);
</div><div class='line not-executable'><span class='num'>934</span>        }
</div><div class='line not-executable'><span class='num'>935</span>
</div><div class='line not-covered'><span class='num'>936</span>        $old = $this-&gt;getNode($id);
</div><div class='line not-covered'><span class='num'>937</span>        $this-&gt;insertAuditLog(new AuditLog( &#039;node&#039;, $id, &#039;delete&#039;, $old-&gt;toArray(), null));
</div><div class='line not-covered'><span class='num'>938</span>        $this-&gt;db-&gt;deleteNode($id);
</div><div class='line not-covered'><span class='num'>939</span>    }
</div><div class='line not-executable'><span class='num'>940</span>
</div><div class='line not-executable'><span class='num'>941</span>    public function getEdge(string $source, string $target): ?Edge
</div><div class='line not-executable'><span class='num'>942</span>    {
</div><div class='line not-covered'><span class='num'>943</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>944</span>            throw new RuntimeException(&quot;Permission denied to get edge.&quot;);
</div><div class='line not-executable'><span class='num'>945</span>        }
</div><div class='line not-executable'><span class='num'>946</span>
</div><div class='line not-covered'><span class='num'>947</span>        $edgesData = $this-&gt;db-&gt;getEdges();
</div><div class='line not-covered'><span class='num'>948</span>        foreach ($edgesData as $data) {
</div><div class='line not-covered'><span class='num'>949</span>            if ($data[&#039;source&#039;] === $source &amp;&amp; $data[&#039;target&#039;] === $target) {
</div><div class='line not-covered'><span class='num'>950</span>                return new Edge(
</div><div class='line not-covered'><span class='num'>951</span>                    $data[&#039;id&#039;],
</div><div class='line not-covered'><span class='num'>952</span>                    $data[&#039;source&#039;],
</div><div class='line not-covered'><span class='num'>953</span>                    $data[&#039;target&#039;],
</div><div class='line not-covered'><span class='num'>954</span>                    json_decode($data[&#039;data&#039;], true)
</div><div class='line not-executable'><span class='num'>955</span>                );
</div><div class='line not-executable'><span class='num'>956</span>            }
</div><div class='line not-executable'><span class='num'>957</span>        }
</div><div class='line not-covered'><span class='num'>958</span>        return null;
</div><div class='line not-covered'><span class='num'>959</span>    }
</div><div class='line not-executable'><span class='num'>960</span>
</div><div class='line not-executable'><span class='num'>961</span>    public function getEdges(): Edges
</div><div class='line not-executable'><span class='num'>962</span>    {
</div><div class='line not-covered'><span class='num'>963</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>964</span>            throw new RuntimeException(&quot;Permission denied to get edges.&quot;);
</div><div class='line not-executable'><span class='num'>965</span>        }
</div><div class='line not-covered'><span class='num'>966</span>        $edgesData = $this-&gt;db-&gt;getEdges();
</div><div class='line not-covered'><span class='num'>967</span>        $edges     = new Edges();
</div><div class='line not-covered'><span class='num'>968</span>        foreach ($edgesData as $data) {
</div><div class='line not-covered'><span class='num'>969</span>            $edge = new Edge(
</div><div class='line not-covered'><span class='num'>970</span>                $data[&#039;id&#039;],
</div><div class='line not-covered'><span class='num'>971</span>                $data[&#039;source&#039;],
</div><div class='line not-covered'><span class='num'>972</span>                $data[&#039;target&#039;],
</div><div class='line not-covered'><span class='num'>973</span>                json_decode($data[&#039;data&#039;], true)
</div><div class='line not-executable'><span class='num'>974</span>            );
</div><div class='line not-covered'><span class='num'>975</span>            $edges-&gt;addEdge($edge);
</div><div class='line not-executable'><span class='num'>976</span>        }
</div><div class='line not-covered'><span class='num'>977</span>        return $edges;
</div><div class='line not-covered'><span class='num'>978</span>    }
</div><div class='line not-executable'><span class='num'>979</span>
</div><div class='line not-executable'><span class='num'>980</span>    public function insertEdge(Edge $edge): void
</div><div class='line not-executable'><span class='num'>981</span>    {
</div><div class='line covered'><span class='num'>982</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>983</span>            throw new RuntimeException(&quot;Permission denied to insert edge.&quot;);
</div><div class='line not-executable'><span class='num'>984</span>        }
</div><div class='line covered'><span class='num'>985</span>        $this-&gt;insertAuditLog(new AuditLog( &#039;edge&#039;, $edge-&gt;id, &#039;insert&#039;, null, $edge-&gt;toArray()));
</div><div class='line covered'><span class='num'>986</span>        $this-&gt;db-&gt;insertEdge(
</div><div class='line covered'><span class='num'>987</span>            $edge-&gt;id,
</div><div class='line covered'><span class='num'>988</span>            $edge-&gt;source,
</div><div class='line covered'><span class='num'>989</span>            $edge-&gt;target,
</div><div class='line covered'><span class='num'>990</span>            $edge-&gt;data
</div><div class='line not-executable'><span class='num'>991</span>        );
</div><div class='line covered'><span class='num'>992</span>    }
</div><div class='line not-executable'><span class='num'>993</span>
</div><div class='line not-executable'><span class='num'>994</span>    public function updateEdge(Edge $edge): void
</div><div class='line not-executable'><span class='num'>995</span>    {
</div><div class='line not-covered'><span class='num'>996</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>997</span>            throw new RuntimeException(&quot;Permission denied to update edge.&quot;);
</div><div class='line not-executable'><span class='num'>998</span>        }
</div><div class='line not-covered'><span class='num'>999</span>        $old = $this-&gt;getEdge($edge-&gt;source, $edge-&gt;target);
</div><div class='line not-covered'><span class='num'>1000</span>        $this-&gt;insertAuditLog(new AuditLog( &#039;edge&#039;, $edge-&gt;id, &#039;update&#039;, $old-&gt;toArray(), $edge-&gt;toArray()));
</div><div class='line not-executable'><span class='num'>1001</span>
</div><div class='line not-covered'><span class='num'>1002</span>        $this-&gt;db-&gt;updateEdge(
</div><div class='line not-covered'><span class='num'>1003</span>            $edge-&gt;id,
</div><div class='line not-covered'><span class='num'>1004</span>            $edge-&gt;source,
</div><div class='line not-covered'><span class='num'>1005</span>            $edge-&gt;target,
</div><div class='line not-covered'><span class='num'>1006</span>            $edge-&gt;data
</div><div class='line not-executable'><span class='num'>1007</span>        );
</div><div class='line not-covered'><span class='num'>1008</span>    }
</div><div class='line not-executable'><span class='num'>1009</span>
</div><div class='line not-executable'><span class='num'>1010</span>    public function deleteEdge(string $id): void
</div><div class='line not-executable'><span class='num'>1011</span>    {
</div><div class='line not-covered'><span class='num'>1012</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>1013</span>            throw new RuntimeException(&quot;Permission denied to delete edge.&quot;);
</div><div class='line not-executable'><span class='num'>1014</span>        }
</div><div class='line not-covered'><span class='num'>1015</span>        $this-&gt;db-&gt;deleteEdge($id);
</div><div class='line not-covered'><span class='num'>1016</span>    }
</div><div class='line not-executable'><span class='num'>1017</span>
</div><div class='line not-executable'><span class='num'>1018</span>    public function getStatuses(): NodeStatuses
</div><div class='line not-executable'><span class='num'>1019</span>    {
</div><div class='line not-covered'><span class='num'>1020</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>1021</span>            throw new RuntimeException(&quot;Permission denied to get statuses.&quot;);
</div><div class='line not-executable'><span class='num'>1022</span>        }
</div><div class='line not-executable'><span class='num'>1023</span>
</div><div class='line not-covered'><span class='num'>1024</span>        $statusesData = $this-&gt;db-&gt;getStatuses();
</div><div class='line not-covered'><span class='num'>1025</span>        $nodeStatuses = new NodeStatuses();
</div><div class='line not-covered'><span class='num'>1026</span>        foreach ($statusesData as $data) {
</div><div class='line not-covered'><span class='num'>1027</span>            $status = new NodeStatus(
</div><div class='line not-covered'><span class='num'>1028</span>                $data[&#039;id&#039;],
</div><div class='line not-covered'><span class='num'>1029</span>                $data[&#039;status&#039;] ?? &#039;unknown&#039;
</div><div class='line not-executable'><span class='num'>1030</span>            );
</div><div class='line not-covered'><span class='num'>1031</span>            $nodeStatuses-&gt;addStatus($status);
</div><div class='line not-executable'><span class='num'>1032</span>        }
</div><div class='line not-covered'><span class='num'>1033</span>        return $nodeStatuses;
</div><div class='line not-covered'><span class='num'>1034</span>    }
</div><div class='line not-executable'><span class='num'>1035</span>
</div><div class='line not-executable'><span class='num'>1036</span>    public function getNodeStatus(string $id): NodeStatus
</div><div class='line not-executable'><span class='num'>1037</span>    {
</div><div class='line not-covered'><span class='num'>1038</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>1039</span>            throw new RuntimeException(&quot;Permission denied to get node status.&quot;);
</div><div class='line not-executable'><span class='num'>1040</span>        }
</div><div class='line not-executable'><span class='num'>1041</span>
</div><div class='line not-covered'><span class='num'>1042</span>        $statusData = $this-&gt;db-&gt;getNodeStatus($id);
</div><div class='line not-covered'><span class='num'>1043</span>        return new NodeStatus(
</div><div class='line not-covered'><span class='num'>1044</span>            $id,
</div><div class='line not-covered'><span class='num'>1045</span>            $statusData ?? &#039;unknown&#039;
</div><div class='line not-executable'><span class='num'>1046</span>        );
</div><div class='line not-covered'><span class='num'>1047</span>    }
</div><div class='line not-executable'><span class='num'>1048</span>
</div><div class='line not-executable'><span class='num'>1049</span>    public function setNodeStatus(NodeStatus $status): void
</div><div class='line not-executable'><span class='num'>1050</span>    {
</div><div class='line not-covered'><span class='num'>1051</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>1052</span>            throw new RuntimeException(&quot;Permission denied to set node status.&quot;);
</div><div class='line not-executable'><span class='num'>1053</span>        }
</div><div class='line not-executable'><span class='num'>1054</span>
</div><div class='line not-covered'><span class='num'>1055</span>        $this-&gt;db-&gt;setNodeStatus($status-&gt;nodeId, $status-&gt;status);
</div><div class='line not-covered'><span class='num'>1056</span>    }
</div><div class='line not-executable'><span class='num'>1057</span>
</div><div class='line not-executable'><span class='num'>1058</span>    public function getLogs($limit): AuditLogs
</div><div class='line not-executable'><span class='num'>1059</span>    {
</div><div class='line not-covered'><span class='num'>1060</span>        if (! $this-&gt;isAllowed(__METHOD__)) {
</div><div class='line not-covered'><span class='num'>1061</span>            throw new RuntimeException(&quot;Permission denied to get audit logs.&quot;);
</div><div class='line not-executable'><span class='num'>1062</span>        }
</div><div class='line not-executable'><span class='num'>1063</span>
</div><div class='line not-covered'><span class='num'>1064</span>        $logs = new AuditLogs();
</div><div class='line not-covered'><span class='num'>1065</span>        $rows = $this-&gt;db-&gt;getLogs($limit);
</div><div class='line not-covered'><span class='num'>1066</span>        foreach ($rows as $row) {
</div><div class='line not-covered'><span class='num'>1067</span>            $old_data = $row[&#039;old_data&#039;] ? json_decode($row[&#039;old_data&#039;], true) : [];
</div><div class='line not-covered'><span class='num'>1068</span>            $new_data = $row[&#039;new_data&#039;] ?  json_decode($row[&#039;new_data&#039;], true) : [];
</div><div class='line not-covered'><span class='num'>1069</span>            $log = new AuditLog(
</div><div class='line not-covered'><span class='num'>1070</span>                $row[&#039;entity_type&#039;],
</div><div class='line not-covered'><span class='num'>1071</span>                $row[&#039;entity_id&#039;],
</div><div class='line not-covered'><span class='num'>1072</span>                $row[&#039;action&#039;],
</div><div class='line not-executable'><span class='num'>1073</span>                $old_data,
</div><div class='line not-executable'><span class='num'>1074</span>                $new_data,
</div><div class='line not-executable'><span class='num'>1075</span>            );
</div><div class='line not-covered'><span class='num'>1076</span>            $log-&gt;userId    = $row[&#039;user_id&#039;];
</div><div class='line not-covered'><span class='num'>1077</span>            $log-&gt;ipAddress = $row[&#039;ip_address&#039;];
</div><div class='line not-covered'><span class='num'>1078</span>            $log-&gt;createdAt = $row[&#039;created_at&#039;];
</div><div class='line not-executable'><span class='num'>1079</span>
</div><div class='line not-covered'><span class='num'>1080</span>            $logs-&gt;addLog($log);
</div><div class='line not-executable'><span class='num'>1081</span>        }
</div><div class='line not-covered'><span class='num'>1082</span>        return $logs;
</div><div class='line not-covered'><span class='num'>1083</span>    }
</div><div class='line not-executable'><span class='num'>1084</span>
</div><div class='line not-executable'><span class='num'>1085</span>    private function insertAuditLog(AuditLog $auditLog): void
</div><div class='line not-executable'><span class='num'>1086</span>    {
</div><div class='line covered'><span class='num'>1087</span>        $user_id   = GraphContext::$user-&gt;id;
</div><div class='line covered'><span class='num'>1088</span>        $ip_address = GraphContext::$user-&gt;ipAddress;
</div><div class='line not-executable'><span class='num'>1089</span>
</div><div class='line covered'><span class='num'>1090</span>        $this-&gt;db-&gt;insertAuditLog(
</div><div class='line covered'><span class='num'>1091</span>            $auditLog-&gt;entityType,
</div><div class='line covered'><span class='num'>1092</span>            $auditLog-&gt;entityId,
</div><div class='line covered'><span class='num'>1093</span>            $auditLog-&gt;action,
</div><div class='line covered'><span class='num'>1094</span>            $auditLog-&gt;oldData,
</div><div class='line covered'><span class='num'>1095</span>            $auditLog-&gt;newData,
</div><div class='line not-executable'><span class='num'>1096</span>            $user_id,
</div><div class='line not-executable'><span class='num'>1097</span>            $ip_address
</div><div class='line not-executable'><span class='num'>1098</span>        );
</div><div class='line covered'><span class='num'>1099</span>    }
</div><div class='line not-executable'><span class='num'>1100</span>
</div><div class='line not-executable'><span class='num'>1101</span>    private function isAllowed(string $action): bool
</div><div class='line not-executable'><span class='num'>1102</span>    {
</div><div class='line covered'><span class='num'>1103</span>        $group = GraphContext::$user-&gt;group;
</div><div class='line not-executable'><span class='num'>1104</span>
</div><div class='line not-executable'><span class='num'>1105</span>        // validate action
</div><div class='line not-executable'><span class='num'>1106</span>        // if action is one of the keys in the array self::SECURE_ACTIONS
</div><div class='line covered'><span class='num'>1107</span>        if (!array_key_exists($action, self::SECURE_ACTIONS)) {
</div><div class='line not-covered'><span class='num'>1108</span>            throw new RuntimeException(&quot;Action not defined in secure actions. Action: {$action}&quot;);
</div><div class='line not-executable'><span class='num'>1109</span>        }
</div><div class='line not-executable'><span class='num'>1110</span>
</div><div class='line not-executable'><span class='num'>1111</span>        // if is admin, allow all
</div><div class='line covered'><span class='num'>1112</span>        if ($group-&gt;id === &#039;admin&#039;) {
</div><div class='line not-covered'><span class='num'>1113</span>            return true;
</div><div class='line not-executable'><span class='num'>1114</span>        }
</div><div class='line not-executable'><span class='num'>1115</span>
</div><div class='line not-executable'><span class='num'>1116</span>        // if action is in the SAFE_ACTIONS, allow all
</div><div class='line covered'><span class='num'>1117</span>        if (self::SECURE_ACTIONS[$action]) {
</div><div class='line covered'><span class='num'>1118</span>            return true;
</div><div class='line not-executable'><span class='num'>1119</span>        }
</div><div class='line not-executable'><span class='num'>1120</span>        
</div><div class='line not-executable'><span class='num'>1121</span>        // if action is restricted, only allow contributor
</div><div class='line covered'><span class='num'>1122</span>        if (self::SECURE_ACTIONS[$action] == false &amp;&amp; $group-&gt;id == &#039;contributor&#039;)
</div><div class='line not-executable'><span class='num'>1123</span>        {
</div><div class='line covered'><span class='num'>1124</span>            return true;
</div><div class='line not-executable'><span class='num'>1125</span>        }
</div><div class='line not-executable'><span class='num'>1126</span>
</div><div class='line not-covered'><span class='num'>1127</span>        return false;
</div><div class='line not-covered'><span class='num'>1128</span>    }
</div><div class='line not-executable'><span class='num'>1129</span>}
</div><div class='line not-executable'><span class='num'>1130</span>
</div><div class='line not-executable'><span class='num'>1131</span>final class Request
</div><div class='line not-executable'><span class='num'>1132</span>{
</div><div class='line not-executable'><span class='num'>1133</span>    public array $data;
</div><div class='line not-executable'><span class='num'>1134</span>
</div><div class='line not-executable'><span class='num'>1135</span>    public function getParam($name): string
</div><div class='line not-executable'><span class='num'>1136</span>    {
</div><div class='line covered'><span class='num'>1137</span>        if(isset($_GET[$name])) {
</div><div class='line covered'><span class='num'>1138</span>            return $_GET[$name];
</div><div class='line not-executable'><span class='num'>1139</span>        }
</div><div class='line not-executable'><span class='num'>1140</span>
</div><div class='line not-covered'><span class='num'>1141</span>        throw new RuntimeException(&quot;param &#039;{$name}&#039; not found&quot;);
</div><div class='line not-covered'><span class='num'>1142</span>    }
</div><div class='line not-executable'><span class='num'>1143</span>
</div><div class='line not-executable'><span class='num'>1144</span>    public function getPath(): string
</div><div class='line not-executable'><span class='num'>1145</span>    {
</div><div class='line not-covered'><span class='num'>1146</span>        $scriptName = $_SERVER[&#039;SCRIPT_NAME&#039;];
</div><div class='line not-covered'><span class='num'>1147</span>        $requestUri = $_SERVER[&#039;REQUEST_URI&#039;];
</div><div class='line not-covered'><span class='num'>1148</span>        $requestUri = strtok($requestUri, &#039;?&#039;);
</div><div class='line not-covered'><span class='num'>1149</span>        $path = str_replace($scriptName, &#039;&#039;, $requestUri);
</div><div class='line not-covered'><span class='num'>1150</span>        return $path;
</div><div class='line not-covered'><span class='num'>1151</span>    }
</div><div class='line not-executable'><span class='num'>1152</span>}
</div><div class='line not-executable'><span class='num'>1153</span>
</div><div class='line not-executable'><span class='num'>1154</span>interface ResponseInterface
</div><div class='line not-executable'><span class='num'>1155</span>{
</div><div class='line not-executable'><span class='num'>1156</span>    public function send(): void;
</div><div class='line not-executable'><span class='num'>1157</span>}
</div><div class='line not-executable'><span class='num'>1158</span>
</div><div class='line not-executable'><span class='num'>1159</span>class Response implements ResponseInterface
</div><div class='line not-executable'><span class='num'>1160</span>{
</div><div class='line not-executable'><span class='num'>1161</span>    public int $code;
</div><div class='line not-executable'><span class='num'>1162</span>    public string $status;
</div><div class='line not-executable'><span class='num'>1163</span>    public string $message;
</div><div class='line not-executable'><span class='num'>1164</span>    public array $data;
</div><div class='line not-executable'><span class='num'>1165</span>
</div><div class='line not-executable'><span class='num'>1166</span>    public function __construct(int $code, string $status, string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1167</span>    {
</div><div class='line covered'><span class='num'>1168</span>        $this-&gt;code = $code;
</div><div class='line covered'><span class='num'>1169</span>        $this-&gt;status = $status;
</div><div class='line covered'><span class='num'>1170</span>        $this-&gt;message = $message;
</div><div class='line covered'><span class='num'>1171</span>        $this-&gt;data = $data;
</div><div class='line covered'><span class='num'>1172</span>    }
</div><div class='line not-executable'><span class='num'>1173</span>
</div><div class='line not-executable'><span class='num'>1174</span>    public function send(): void
</div><div class='line not-executable'><span class='num'>1175</span>    {
</div><div class='line not-covered'><span class='num'>1176</span>        header(&#039;Content-Type: application/json; charset=utf-8&#039;);
</div><div class='line not-covered'><span class='num'>1177</span>        http_response_code($this-&gt;code);
</div><div class='line not-covered'><span class='num'>1178</span>        $this-&gt;data = [&#039;code&#039; =&gt; $this-&gt;code, &#039;status&#039; =&gt; $this-&gt;status, &#039;message&#039; =&gt; $this-&gt;message, &#039;data&#039; =&gt; $this-&gt;data];
</div><div class='line not-covered'><span class='num'>1179</span>        echo json_encode($this-&gt;data, JSON_UNESCAPED_UNICODE |  JSON_UNESCAPED_SLASHES |  JSON_PRETTY_PRINT);
</div><div class='line not-covered'><span class='num'>1180</span>    }
</div><div class='line not-executable'><span class='num'>1181</span>}
</div><div class='line not-executable'><span class='num'>1182</span>
</div><div class='line not-executable'><span class='num'>1183</span>class OKResponse extends Response
</div><div class='line not-executable'><span class='num'>1184</span>{
</div><div class='line not-executable'><span class='num'>1185</span>    public function __construct(string $message, array $data)
</div><div class='line not-executable'><span class='num'>1186</span>    {
</div><div class='line covered'><span class='num'>1187</span>        return parent::__construct(200, &#039;success&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1188</span>    }
</div><div class='line not-executable'><span class='num'>1189</span>}
</div><div class='line not-executable'><span class='num'>1190</span>
</div><div class='line not-executable'><span class='num'>1191</span>class CreatedResponse extends Response
</div><div class='line not-executable'><span class='num'>1192</span>{
</div><div class='line not-executable'><span class='num'>1193</span>    public function __construct(string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1194</span>    {
</div><div class='line covered'><span class='num'>1195</span>        return parent::__construct(201, &#039;success&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1196</span>    }
</div><div class='line not-executable'><span class='num'>1197</span>}
</div><div class='line not-executable'><span class='num'>1198</span>
</div><div class='line not-executable'><span class='num'>1199</span>class BadRequestResponse extends Response
</div><div class='line not-executable'><span class='num'>1200</span>{
</div><div class='line not-executable'><span class='num'>1201</span>    public function __construct(string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1202</span>    {
</div><div class='line not-covered'><span class='num'>1203</span>        return parent::__construct(400, &#039;error&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1204</span>    }
</div><div class='line not-executable'><span class='num'>1205</span>}
</div><div class='line not-executable'><span class='num'>1206</span>
</div><div class='line not-executable'><span class='num'>1207</span>class UnauthorizedResponse extends Response
</div><div class='line not-executable'><span class='num'>1208</span>{
</div><div class='line not-executable'><span class='num'>1209</span>    public function __construct(string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1210</span>    {
</div><div class='line not-covered'><span class='num'>1211</span>        return parent::__construct(401, &#039;error&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1212</span>    }
</div><div class='line not-executable'><span class='num'>1213</span>}
</div><div class='line not-executable'><span class='num'>1214</span>
</div><div class='line not-executable'><span class='num'>1215</span>class ForbiddenResponse extends Response
</div><div class='line not-executable'><span class='num'>1216</span>{
</div><div class='line not-executable'><span class='num'>1217</span>    public function __construct(string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1218</span>    {
</div><div class='line not-covered'><span class='num'>1219</span>        return parent::__construct(403, &#039;error&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1220</span>    }
</div><div class='line not-executable'><span class='num'>1221</span>}
</div><div class='line not-executable'><span class='num'>1222</span>
</div><div class='line not-executable'><span class='num'>1223</span>class NotFoundResponse extends Response
</div><div class='line not-executable'><span class='num'>1224</span>{
</div><div class='line not-executable'><span class='num'>1225</span>    public function __construct(string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1226</span>    {
</div><div class='line not-covered'><span class='num'>1227</span>        return parent::__construct(404, &#039;error&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1228</span>    }
</div><div class='line not-executable'><span class='num'>1229</span>}
</div><div class='line not-executable'><span class='num'>1230</span>
</div><div class='line not-executable'><span class='num'>1231</span>class InternalServerErrorResponse extends Response
</div><div class='line not-executable'><span class='num'>1232</span>{
</div><div class='line not-executable'><span class='num'>1233</span>    public function __construct(string $message = &#039;&#039;, array $data)
</div><div class='line not-executable'><span class='num'>1234</span>    {
</div><div class='line not-covered'><span class='num'>1235</span>        return parent::__construct(500, &#039;error&#039;, $message, $data);
</div><div class='line not-covered'><span class='num'>1236</span>    }
</div><div class='line not-executable'><span class='num'>1237</span>}
</div><div class='line not-executable'><span class='num'>1238</span>
</div><div class='line not-executable'><span class='num'>1239</span>interface GraphControllerInterface
</div><div class='line not-executable'><span class='num'>1240</span>{
</div><div class='line not-executable'><span class='num'>1241</span>    public function getUser(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1242</span>    public function insertUser(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1243</span>    public function updateUser(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1244</span>
</div><div class='line not-executable'><span class='num'>1245</span>    public function getGraph(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1246</span>
</div><div class='line not-executable'><span class='num'>1247</span>    public function getNode(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1248</span>    public function getNodes(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1249</span>    public function insertNode(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1250</span>    public function updateNode(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1251</span>    public function deleteNode(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1252</span>
</div><div class='line not-executable'><span class='num'>1253</span>    public function getEdge(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1254</span>    public function getEdges(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1255</span>    public function insertEdge(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1256</span>    public function updateEdge(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1257</span>    public function deleteEdge(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1258</span>
</div><div class='line not-executable'><span class='num'>1259</span>    public function getStatuses(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1260</span>    public function getNodeStatus(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1261</span>    public function setNodeStatus(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1262</span>
</div><div class='line not-executable'><span class='num'>1263</span>    public function getLogs(Request $req): ResponseInterface;
</div><div class='line not-executable'><span class='num'>1264</span>}
</div><div class='line not-executable'><span class='num'>1265</span>
</div><div class='line not-executable'><span class='num'>1266</span>final class GraphControllerException extends RuntimeException
</div><div class='line not-executable'><span class='num'>1267</span>{
</div><div class='line not-executable'><span class='num'>1268</span>}
</div><div class='line not-executable'><span class='num'>1269</span>
</div><div class='line not-executable'><span class='num'>1270</span>final class GraphController implements GraphControllerInterface
</div><div class='line not-executable'><span class='num'>1271</span>{
</div><div class='line not-executable'><span class='num'>1272</span>    private GraphServiceInterface $service;
</div><div class='line not-executable'><span class='num'>1273</span>    private Logger $logger;
</div><div class='line not-executable'><span class='num'>1274</span>
</div><div class='line not-executable'><span class='num'>1275</span>    public function __construct(GraphServiceInterface $service, Logger $logger)
</div><div class='line not-executable'><span class='num'>1276</span>    {
</div><div class='line covered'><span class='num'>1277</span>        $this-&gt;service = $service;
</div><div class='line covered'><span class='num'>1278</span>        $this-&gt;logger = $logger;
</div><div class='line covered'><span class='num'>1279</span>    }
</div><div class='line not-executable'><span class='num'>1280</span>
</div><div class='line not-executable'><span class='num'>1281</span>    public function getUser(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1282</span>    {
</div><div class='line not-covered'><span class='num'>1283</span>        $data = $this-&gt;service-&gt;getUser($req-&gt;data[&#039;id&#039;]);
</div><div class='line not-covered'><span class='num'>1284</span>        $user = new User($data[&#039;id&#039;], null, new Group($data[&#039;user_group&#039;]));
</div><div class='line not-covered'><span class='num'>1285</span>        return new OKResponse(&#039;user found&#039;, $user-&gt;toArray());
</div><div class='line not-covered'><span class='num'>1286</span>    }
</div><div class='line not-executable'><span class='num'>1287</span>
</div><div class='line not-executable'><span class='num'>1288</span>    public function insertUser(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1289</span>    {
</div><div class='line not-covered'><span class='num'>1290</span>        $user = new User($req-&gt;data[&#039;id&#039;], null, $req-&gt;data[&#039;user_group&#039;]);
</div><div class='line not-covered'><span class='num'>1291</span>        $this-&gt;service-&gt;insertUser($user);
</div><div class='line not-covered'><span class='num'>1292</span>        return new OKResponse(&#039;user created&#039;, $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1293</span>    }
</div><div class='line not-executable'><span class='num'>1294</span>
</div><div class='line not-executable'><span class='num'>1295</span>    public function updateUser(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1296</span>    {
</div><div class='line not-covered'><span class='num'>1297</span>        $user = new User($req-&gt;data[&#039;id&#039;], null, $req-&gt;data[&#039;user_group&#039;]);
</div><div class='line not-covered'><span class='num'>1298</span>        $this-&gt;service-&gt;updateUser($user);
</div><div class='line not-covered'><span class='num'>1299</span>        return new CreatedResponse(&#039;user updated&#039;, $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1300</span>    }
</div><div class='line not-executable'><span class='num'>1301</span>
</div><div class='line not-executable'><span class='num'>1302</span>    public function getGraph(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1303</span>    {
</div><div class='line not-executable'><span class='num'>1304</span>        try {
</div><div class='line not-covered'><span class='num'>1305</span>            $data = $this-&gt;service-&gt;getGraph()-&gt;toArray();
</div><div class='line not-covered'><span class='num'>1306</span>            return new OKResponse(&#039;get graph&#039;, $data);
</div><div class='line not-covered'><span class='num'>1307</span>            return $resp;
</div><div class='line not-covered'><span class='num'>1308</span>        } catch (Exception $e) {
</div><div class='line not-covered'><span class='num'>1309</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1310</span>        }
</div><div class='line not-executable'><span class='num'>1311</span>
</div><div class='line not-covered'><span class='num'>1312</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1313</span>    }
</div><div class='line not-executable'><span class='num'>1314</span>
</div><div class='line not-executable'><span class='num'>1315</span>    public function getNode(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1316</span>    {
</div><div class='line not-executable'><span class='num'>1317</span>        try {
</div><div class='line covered'><span class='num'>1318</span>            $id = $req-&gt;getParam(&#039;id&#039;);
</div><div class='line covered'><span class='num'>1319</span>            $node = $this-&gt;service-&gt;getNode($id);
</div><div class='line covered'><span class='num'>1320</span>            $data = $node-&gt;toArray();
</div><div class='line covered'><span class='num'>1321</span>            return new OKResponse(&#039;node found&#039;, $data);
</div><div class='line not-covered'><span class='num'>1322</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1323</span>        {
</div><div class='line not-covered'><span class='num'>1324</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1325</span>        }
</div><div class='line not-executable'><span class='num'>1326</span>
</div><div class='line not-covered'><span class='num'>1327</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1328</span>    }
</div><div class='line not-executable'><span class='num'>1329</span>
</div><div class='line not-executable'><span class='num'>1330</span>    public function getNodes(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1331</span>    {
</div><div class='line not-executable'><span class='num'>1332</span>        try {
</div><div class='line not-covered'><span class='num'>1333</span>            $nodes = $this-&gt;service-&gt;getNodes();
</div><div class='line not-executable'><span class='num'>1334</span>            // TODO: corrigir
</div><div class='line not-covered'><span class='num'>1335</span>            return new OKResponse(&#039;nodes found&#039;, []);
</div><div class='line not-covered'><span class='num'>1336</span>            return $resp;
</div><div class='line not-covered'><span class='num'>1337</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1338</span>        {
</div><div class='line not-covered'><span class='num'>1339</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1340</span>        }
</div><div class='line not-executable'><span class='num'>1341</span>        
</div><div class='line not-covered'><span class='num'>1342</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1343</span>    }
</div><div class='line not-executable'><span class='num'>1344</span>
</div><div class='line not-executable'><span class='num'>1345</span>    public function insertNode(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1346</span>    {
</div><div class='line covered'><span class='num'>1347</span>        $this-&gt;logger-&gt;debug(&#039;inserting node&#039;, $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1348</span>        try {
</div><div class='line covered'><span class='num'>1349</span>            $node = new Node($req-&gt;data[&#039;id&#039;], $req-&gt;data[&#039;label&#039;], $req-&gt;data[&#039;category&#039;], $req-&gt;data[&#039;type&#039;], $req-&gt;data[&#039;data&#039;]);
</div><div class='line covered'><span class='num'>1350</span>            $this-&gt;service-&gt;insertNode($node);
</div><div class='line covered'><span class='num'>1351</span>            $this-&gt;logger-&gt;info(&#039;node inserted&#039;, $req-&gt;data);
</div><div class='line covered'><span class='num'>1352</span>            return new CreatedResponse(&#039;node inserted&#039;, $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1353</span>        } catch( GraphServiceException $e)
</div><div class='line not-executable'><span class='num'>1354</span>        {
</div><div class='line not-covered'><span class='num'>1355</span>            $this-&gt;logger-&gt;error(&#039;The service could not insert new node:&#039; . $e-&gt;getMessage());
</div><div class='line not-covered'><span class='num'>1356</span>            throw new GraphControllerException(&#039;The service could not insert new node:&#039; . $e-&gt;getMessage(), 0, $e);
</div><div class='line not-executable'><span class='num'>1357</span>        }
</div><div class='line not-covered'><span class='num'>1358</span>        return new InternalServerErrorResponse(&#039;unknow error inserting node&#039;, $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1359</span>    }
</div><div class='line not-executable'><span class='num'>1360</span>    
</div><div class='line not-executable'><span class='num'>1361</span>    public function updateNode(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1362</span>    {
</div><div class='line covered'><span class='num'>1363</span>        $this-&gt;logger-&gt;debug(&#039;updating node&#039;, $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1364</span>
</div><div class='line not-executable'><span class='num'>1365</span>        try {
</div><div class='line covered'><span class='num'>1366</span>            $edge = new Edge($req-&gt;data[&#039;id&#039;], $req-&gt;data[&#039;category&#039;], $req-&gt;data[&#039;type&#039;], $req-&gt;data[&#039;data&#039;]);
</div><div class='line covered'><span class='num'>1367</span>            $this-&gt;service-&gt;insertEdge($edge);
</div><div class='line covered'><span class='num'>1368</span>            $this-&gt;logger-&gt;info(&#039;edge inserted&#039;, $req-&gt;data);
</div><div class='line covered'><span class='num'>1369</span>            $resp = new CreatedResponse(&#039;edge created&#039;, $req-&gt;data);
</div><div class='line covered'><span class='num'>1370</span>            return $resp;
</div><div class='line not-covered'><span class='num'>1371</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1372</span>        {
</div><div class='line not-covered'><span class='num'>1373</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1374</span>        }
</div><div class='line not-executable'><span class='num'>1375</span>        
</div><div class='line not-covered'><span class='num'>1376</span>        return new InternalServerErrorResponse(&#039;unknow todo in updateNode&#039;, $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1377</span>    }
</div><div class='line not-executable'><span class='num'>1378</span>    
</div><div class='line not-executable'><span class='num'>1379</span>    public function deleteNode(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1380</span>    {
</div><div class='line not-executable'><span class='num'>1381</span>        try {
</div><div class='line not-covered'><span class='num'>1382</span>            $this-&gt;service-&gt;deleteEdge($req-&gt;data[&#039;id&#039;]);
</div><div class='line not-covered'><span class='num'>1383</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1384</span>        {
</div><div class='line not-covered'><span class='num'>1385</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1386</span>        }
</div><div class='line not-executable'><span class='num'>1387</span>        
</div><div class='line not-covered'><span class='num'>1388</span>        return new InternalServerErrorResponse(&#039;unknow todo in deleteNode&#039;, $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1389</span>    }
</div><div class='line not-executable'><span class='num'>1390</span>
</div><div class='line not-executable'><span class='num'>1391</span>    public function getEdge(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1392</span>    {
</div><div class='line not-executable'><span class='num'>1393</span>        try {
</div><div class='line not-covered'><span class='num'>1394</span>            $edge = $this-&gt;service-&gt;getEdge($req-&gt;data[&#039;source&#039;], $req-&gt;data[&#039;target&#039;]);
</div><div class='line not-covered'><span class='num'>1395</span>            $data = $edge-&gt;toArray();
</div><div class='line not-covered'><span class='num'>1396</span>            return new OKResponse(&#039;node found&#039;, $data);
</div><div class='line not-covered'><span class='num'>1397</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1398</span>        {
</div><div class='line not-covered'><span class='num'>1399</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1400</span>        }
</div><div class='line not-executable'><span class='num'>1401</span>        
</div><div class='line not-covered'><span class='num'>1402</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1403</span>    }
</div><div class='line not-executable'><span class='num'>1404</span>    
</div><div class='line not-executable'><span class='num'>1405</span>    public function getEdges(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1406</span>    {
</div><div class='line not-executable'><span class='num'>1407</span>        try {
</div><div class='line not-covered'><span class='num'>1408</span>            $edges = $this-&gt;service-&gt;getEdges();
</div><div class='line not-executable'><span class='num'>1409</span>            // TODO: corrigir
</div><div class='line not-covered'><span class='num'>1410</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1411</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1412</span>        {
</div><div class='line not-covered'><span class='num'>1413</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1414</span>        }
</div><div class='line not-executable'><span class='num'>1415</span>        
</div><div class='line not-covered'><span class='num'>1416</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1417</span>    }
</div><div class='line not-executable'><span class='num'>1418</span>    
</div><div class='line not-executable'><span class='num'>1419</span>    public function insertEdge(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1420</span>    {
</div><div class='line not-executable'><span class='num'>1421</span>        try {
</div><div class='line not-covered'><span class='num'>1422</span>            $edge = new Edge(null, $req-&gt;data[&#039;source&#039;], $req-&gt;data[&#039;target&#039;]);
</div><div class='line not-covered'><span class='num'>1423</span>            $this-&gt;service-&gt;insertEdge($edge);
</div><div class='line not-covered'><span class='num'>1424</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1425</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1426</span>        {
</div><div class='line not-covered'><span class='num'>1427</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1428</span>        }
</div><div class='line not-executable'><span class='num'>1429</span>        
</div><div class='line not-covered'><span class='num'>1430</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1431</span>    }
</div><div class='line not-executable'><span class='num'>1432</span>    
</div><div class='line not-executable'><span class='num'>1433</span>    public function updateEdge(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1434</span>    {
</div><div class='line not-executable'><span class='num'>1435</span>        try {
</div><div class='line not-covered'><span class='num'>1436</span>            $edge = new Edge($req-&gt;data[&#039;id&#039;], $req-&gt;data[&#039;source&#039;], $req-&gt;data[&#039;target&#039;], $req-&gt;data[&#039;data&#039;]);
</div><div class='line not-covered'><span class='num'>1437</span>            $this-&gt;service-&gt;updateEdge($edge);
</div><div class='line not-covered'><span class='num'>1438</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1439</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1440</span>        {
</div><div class='line not-covered'><span class='num'>1441</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1442</span>        }
</div><div class='line not-executable'><span class='num'>1443</span>        
</div><div class='line not-covered'><span class='num'>1444</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1445</span>    }
</div><div class='line not-executable'><span class='num'>1446</span>    
</div><div class='line not-executable'><span class='num'>1447</span>    public function deleteEdge(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1448</span>    {
</div><div class='line not-executable'><span class='num'>1449</span>        try {
</div><div class='line not-covered'><span class='num'>1450</span>            $id = $req-&gt;data[&#039;id&#039;];
</div><div class='line not-covered'><span class='num'>1451</span>            $this-&gt;service-&gt;deleteEdge($id);
</div><div class='line not-covered'><span class='num'>1452</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1453</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1454</span>        {
</div><div class='line not-covered'><span class='num'>1455</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1456</span>        }
</div><div class='line not-executable'><span class='num'>1457</span>        
</div><div class='line not-covered'><span class='num'>1458</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1459</span>    }
</div><div class='line not-executable'><span class='num'>1460</span>
</div><div class='line not-executable'><span class='num'>1461</span>    public function getStatuses(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1462</span>    {
</div><div class='line not-executable'><span class='num'>1463</span>        try {
</div><div class='line not-covered'><span class='num'>1464</span>            $statuses = $this-&gt;service-&gt;getStatuses();
</div><div class='line not-covered'><span class='num'>1465</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1466</span>            return $resp;
</div><div class='line not-covered'><span class='num'>1467</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1468</span>        {
</div><div class='line not-covered'><span class='num'>1469</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1470</span>        }
</div><div class='line not-executable'><span class='num'>1471</span>        
</div><div class='line not-covered'><span class='num'>1472</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1473</span>    }
</div><div class='line not-executable'><span class='num'>1474</span>    
</div><div class='line not-executable'><span class='num'>1475</span>    public function getNodeStatus(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1476</span>    {
</div><div class='line not-executable'><span class='num'>1477</span>        try {
</div><div class='line not-covered'><span class='num'>1478</span>            $status = $this-&gt;service-&gt;getNodeStatus($req-&gt;data[&#039;id&#039;]);
</div><div class='line not-covered'><span class='num'>1479</span>            $data = $status-&gt;toArray();
</div><div class='line not-covered'><span class='num'>1480</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1481</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1482</span>        {
</div><div class='line not-covered'><span class='num'>1483</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1484</span>        }
</div><div class='line not-executable'><span class='num'>1485</span>        
</div><div class='line not-covered'><span class='num'>1486</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1487</span>    }
</div><div class='line not-executable'><span class='num'>1488</span>    
</div><div class='line not-executable'><span class='num'>1489</span>    public function setNodeStatus(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1490</span>    {
</div><div class='line not-executable'><span class='num'>1491</span>        try {
</div><div class='line not-covered'><span class='num'>1492</span>            $status = new NodeStatus($req-&gt;data[&#039;node_id&#039;], $req-&gt;data[&#039;status&#039;]);
</div><div class='line not-covered'><span class='num'>1493</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1494</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1495</span>        {
</div><div class='line not-covered'><span class='num'>1496</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1497</span>        }
</div><div class='line not-executable'><span class='num'>1498</span>        
</div><div class='line not-covered'><span class='num'>1499</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1500</span>    }
</div><div class='line not-executable'><span class='num'>1501</span>
</div><div class='line not-executable'><span class='num'>1502</span>    public function getLogs(Request $req): ResponseInterface
</div><div class='line not-executable'><span class='num'>1503</span>    {
</div><div class='line not-executable'><span class='num'>1504</span>        try {
</div><div class='line not-covered'><span class='num'>1505</span>            $logs = $this-&gt;service-&gt;getLogs($req-&gt;getParam(&#039;limit&#039;));
</div><div class='line not-covered'><span class='num'>1506</span>            return new OKResponse(&#039;node found&#039;, []);
</div><div class='line not-covered'><span class='num'>1507</span>        } catch( Exception $e)
</div><div class='line not-executable'><span class='num'>1508</span>        {
</div><div class='line not-covered'><span class='num'>1509</span>            return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-executable'><span class='num'>1510</span>        }
</div><div class='line not-executable'><span class='num'>1511</span>        
</div><div class='line not-covered'><span class='num'>1512</span>        return new InternalServerErrorResponse($e-&gt;getMessage(), $req-&gt;data);
</div><div class='line not-covered'><span class='num'>1513</span>    }
</div><div class='line not-executable'><span class='num'>1514</span>}
</div><div class='line not-executable'><span class='num'>1515</span>
</div><div class='line not-executable'><span class='num'>1516</span>final class RequestRouter
</div><div class='line not-executable'><span class='num'>1517</span>{
</div><div class='line not-executable'><span class='num'>1518</span>    private $routes = [
</div><div class='line not-executable'><span class='num'>1519</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getGraph&#039;, &#039;class_method&#039; =&gt; &#039;getGraph&#039;],
</div><div class='line not-executable'><span class='num'>1520</span>        
</div><div class='line not-executable'><span class='num'>1521</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getNode&#039;, &#039;class_method&#039; =&gt; &#039;getNode&#039;],
</div><div class='line not-executable'><span class='num'>1522</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getNodes&#039;, &#039;class_method&#039; =&gt; &#039;getNodes&#039;],
</div><div class='line not-executable'><span class='num'>1523</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/insertNode&#039;, &#039;class_method&#039; =&gt; &#039;insertNode&#039;],
</div><div class='line not-executable'><span class='num'>1524</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/updateNode&#039;, &#039;class_method&#039; =&gt; &#039;updateNode&#039;],
</div><div class='line not-executable'><span class='num'>1525</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/deleteNode&#039;, &#039;class_method&#039; =&gt; &#039;deleteNode&#039;],
</div><div class='line not-executable'><span class='num'>1526</span>
</div><div class='line not-executable'><span class='num'>1527</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getEdge&#039;, &#039;class_method&#039; =&gt; &#039;getEdge&#039;],
</div><div class='line not-executable'><span class='num'>1528</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getEdges&#039;, &#039;class_method&#039; =&gt; &#039;getEdges&#039;],
</div><div class='line not-executable'><span class='num'>1529</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/insertEdge&#039;, &#039;class_method&#039; =&gt; &#039;insertEdge&#039;],
</div><div class='line not-executable'><span class='num'>1530</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/updateEdge&#039;, &#039;class_method&#039; =&gt; &#039;updateEdge&#039;],
</div><div class='line not-executable'><span class='num'>1531</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/deleteEdge&#039;, &#039;class_method&#039; =&gt; &#039;deleteEdge&#039;],
</div><div class='line not-executable'><span class='num'>1532</span>
</div><div class='line not-executable'><span class='num'>1533</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getStatuses&#039;, &#039;class_method&#039; =&gt; &#039;getStatuses&#039;],
</div><div class='line not-executable'><span class='num'>1534</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getNodeStatus&#039;, &#039;class_method&#039; =&gt; &#039;getNodeStatus&#039;],
</div><div class='line not-executable'><span class='num'>1535</span>
</div><div class='line not-executable'><span class='num'>1536</span>        [&#039;method&#039; =&gt; &#039;GET&#039;, &#039;path&#039; =&gt; &#039;/getLogs&#039;, &#039;class_method&#039; =&gt; &#039;getLogs&#039;],
</div><div class='line not-executable'><span class='num'>1537</span>
</div><div class='line not-executable'><span class='num'>1538</span>        ];
</div><div class='line not-executable'><span class='num'>1539</span>
</div><div class='line not-executable'><span class='num'>1540</span>    public GraphController $controller;
</div><div class='line not-executable'><span class='num'>1541</span>    
</div><div class='line not-executable'><span class='num'>1542</span>    public function __construct(GraphController $controller)
</div><div class='line not-executable'><span class='num'>1543</span>    {
</div><div class='line not-covered'><span class='num'>1544</span>        $this-&gt;controller = $controller;
</div><div class='line not-covered'><span class='num'>1545</span>    }
</div><div class='line not-executable'><span class='num'>1546</span>
</div><div class='line not-executable'><span class='num'>1547</span>    public function handle(): void
</div><div class='line not-executable'><span class='num'>1548</span>    {
</div><div class='line not-covered'><span class='num'>1549</span>        $method = $_SERVER[&#039;REQUEST_METHOD&#039;];
</div><div class='line not-executable'><span class='num'>1550</span>
</div><div class='line not-covered'><span class='num'>1551</span>        $scriptName = $_SERVER[&#039;SCRIPT_NAME&#039;];
</div><div class='line not-covered'><span class='num'>1552</span>        $requestUri = $_SERVER[&#039;REQUEST_URI&#039;];
</div><div class='line not-covered'><span class='num'>1553</span>        $requestUri = strtok($requestUri, &#039;?&#039;);
</div><div class='line not-executable'><span class='num'>1554</span>        
</div><div class='line not-covered'><span class='num'>1555</span>        $path = str_replace($scriptName, &#039;&#039;, $requestUri);
</div><div class='line not-executable'><span class='num'>1556</span>        
</div><div class='line not-covered'><span class='num'>1557</span>        $req = new Request();
</div><div class='line not-executable'><span class='num'>1558</span>
</div><div class='line not-covered'><span class='num'>1559</span>        foreach($this-&gt;routes as $route)
</div><div class='line not-executable'><span class='num'>1560</span>        {
</div><div class='line not-covered'><span class='num'>1561</span>            if ($route[&#039;method&#039;] == $method &amp;&amp; $route[&#039;path&#039;] == $path)
</div><div class='line not-executable'><span class='num'>1562</span>            {
</div><div class='line not-covered'><span class='num'>1563</span>                $method = $route[&#039;class_method&#039;];
</div><div class='line not-covered'><span class='num'>1564</span>                $resp = $this-&gt;controller-&gt;$method($req);
</div><div class='line not-covered'><span class='num'>1565</span>                print_r($resp);
</div><div class='line not-covered'><span class='num'>1566</span>                exit();
</div><div class='line not-executable'><span class='num'>1567</span>            }
</div><div class='line not-executable'><span class='num'>1568</span>        }
</div><div class='line not-covered'><span class='num'>1569</span>    }
</div><div class='line not-executable'><span class='num'>1570</span>}
</div><div class='line not-executable'><span class='num'>1571</span>
</div><div class='line not-executable'><span class='num'>1572</span>
</div></body></html>